/**
 * æ¬¢è¿é¡µé¢ - é¦–æ¬¡å¯åŠ¨æ—¶é€‰æ‹©UIé£æ ¼
 */
import { common } from '@kit.AbilityKit'
import { UIStyle } from '../models/PhotoRecord'
import { PreferenceService } from '../services/PreferenceService'
import { hilog } from '@kit.PerformanceAnalysisKit'

@Entry
@Component
struct WelcomePage {
  @State selectedStyle: UIStyle = UIStyle.CARD
  private preferenceService: PreferenceService | null = null

  aboutToAppear(): void {
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext
    this.preferenceService = new PreferenceService(context)
  }

  // ç¡®è®¤é€‰æ‹©å¹¶è¿›å…¥ä¸»é¡µ
  async confirmSelection(): Promise<void> {
    try {
      if (this.preferenceService) {
        await this.preferenceService.setUIStyle(this.selectedStyle)
        await this.preferenceService.markFirstLaunchDone()
      }
      this.getUIContext().getRouter().replaceUrl({ url: 'pages/Index' })
    } catch (error) {
      hilog.error(0x0021, 'UI', 'ä¿å­˜è®¾ç½®å¤±è´¥:' + error)
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text('ğŸ“·')
          .fontSize(60)
          .margin({ bottom: 16 })
        
        Text('EXIFå…‰å½±å¤‡å¿˜å½•')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Text('é€‰æ‹©ä½ å–œæ¬¢çš„ç•Œé¢é£æ ¼')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 8 })
      }
      .margin({ top: 80, bottom: 40 })

      // é£æ ¼é€‰æ‹©åŒºåŸŸ
      Row() {
        // é£æ ¼A: å¡ç‰‡åˆ—è¡¨å¼
        Column() {
          this.StylePreview(UIStyle.CARD)
        }
        .width('45%')
        .onClick(() => {
          this.selectedStyle = UIStyle.CARD
        })

        Blank().width(16)

        // é£æ ¼B: å‚æ•°çªå‡ºå¼
        Column() {
          this.StylePreview(UIStyle.PARAM)
        }
        .width('45%')
        .onClick(() => {
          this.selectedStyle = UIStyle.PARAM
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ left: 20, right: 20 })

      Blank()

      // å¼€å§‹ä½¿ç”¨æŒ‰é’®
      Button('å¼€å§‹ä½¿ç”¨')
        .width('80%')
        .height(50)
        .fontSize(18)
        .fontColor(Color.White)
        .backgroundColor('#007AFF')
        .borderRadius(25)
        .margin({ bottom: 60 })
        .onClick(() => {
          this.confirmSelection()
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  StylePreview(style: UIStyle) {
    Column() {
      // é¢„è§ˆå¡ç‰‡
      Column() {
        if (style === UIStyle.CARD) {
          // å¡ç‰‡å¼é¢„è§ˆ
          Row() {
            Column()
              .width(50)
              .height(50)
              .backgroundColor('#E0E0E0')
              .borderRadius(8)
            
            Column() {
              Text('2024/12/14')
                .fontSize(12)
                .fontColor('#999999')
              Text('f/2.8 Â· 1/125s Â· ISO400')
                .fontSize(11)
                .fontColor('#333333')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 10 })
          }
          .width('100%')
          .padding(10)
          
          Text('ğŸ“ å¤•é˜³äººåƒ...')
            .fontSize(11)
            .fontColor('#666666')
            .width('100%')
            .padding({ left: 10, bottom: 10 })
        } else {
          // å‚æ•°å¼é¢„è§ˆ
          Text('f/2.8')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ top: 15 })
          
          Divider()
            .width('80%')
            .margin({ top: 8, bottom: 8 })
          
          Row() {
            Text('1/125s')
              .fontSize(11)
            Text('ISO400')
              .fontSize(11)
              .margin({ left: 12 })
            Text('50mm')
              .fontSize(11)
              .margin({ left: 12 })
          }
          .margin({ bottom: 15 })
        }
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })

      // é£æ ¼åç§°
      Text(style === UIStyle.CARD ? 'å¡ç‰‡åˆ—è¡¨å¼' : 'å‚æ•°çªå‡ºå¼')
        .fontSize(14)
        .fontColor('#333333')
        .margin({ top: 12 })
      
      Text(style === UIStyle.CARD ? 'é€‚åˆæµè§ˆä¸ºä¸»' : 'é€‚åˆå­¦ä¹ å‚æ•°')
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 4 })

      // é€‰ä¸­æŒ‡ç¤ºå™¨
      if (this.selectedStyle === style) {
        Row() {
          Text('âœ“')
            .fontSize(14)
            .fontColor(Color.White)
        }
        .width(24)
        .height(24)
        .backgroundColor('#007AFF')
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        .margin({ top: 12 })
      } else {
        Row()
          .width(24)
          .height(24)
          .border({ width: 2, color: '#CCCCCC' })
          .borderRadius(12)
          .margin({ top: 12 })
      }
    }
  }
}
