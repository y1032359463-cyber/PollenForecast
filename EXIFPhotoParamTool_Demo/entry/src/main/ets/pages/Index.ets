/**
 * ä¸»é¡µé¢ - å…‰å½±å¤‡å¿˜å½•
 * 
 * 2025-12-25 é‡æ„ï¼šç®€æ´å¡ç‰‡å¼é¦–é¡µ
 * - ç¬”è®°æ ‡é¢˜ + æ ¸å¿ƒå‚æ•°ä¸€è¡Œ
 * - å·¦æ»‘åˆ é™¤ï¼ˆswipeActionï¼‰
 * - ç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µç¼–è¾‘
 */
import { common } from '@kit.AbilityKit'
import { UIStyle, PhotoRecord, ExifData } from '../models/PhotoRecord'
import { PhotoRecordDataSource } from '../models/LazyDataSource'
import { PreferenceService } from '../services/PreferenceService'
import { PhotoPickerService } from '../services/PhotoPickerService'
import { ExifParserService } from '../services/ExifParserService'
import { DataStorageService } from '../services/DataStorageService'
import { promptAction } from '@kit.ArkUI'
import { hilog } from '@kit.PerformanceAnalysisKit'

@Entry
@Component
struct Index {
  @State isLoading: boolean = true
  @State currentStyle: UIStyle = UIStyle.CARD
  @State records: PhotoRecord[] = []
  
  private dataSource: PhotoRecordDataSource = new PhotoRecordDataSource()
  private context: common.UIAbilityContext | null = null
  private preferenceService: PreferenceService | null = null
  private photoPickerService: PhotoPickerService | null = null
  private exifParserService: ExifParserService | null = null
  private storageService: DataStorageService | null = null
  
  private backgroundTasks: Map<string, boolean> = new Map()
  private isComponentAlive: boolean = true

  async aboutToAppear(): Promise<void> {
    this.context = this.getUIContext().getHostContext() as common.UIAbilityContext
    this.preferenceService = new PreferenceService(this.context)
    this.photoPickerService = new PhotoPickerService(this.context)
    this.exifParserService = new ExifParserService()
    this.storageService = new DataStorageService(this.context)
    
    const initSuccess = await this.storageService.initialize()
    if (!initSuccess) {
      promptAction.showToast({
        message: 'å­˜å‚¨æœåŠ¡å¼‚å¸¸ï¼Œæ•°æ®å°†ä¿å­˜åœ¨å†…å­˜ä¸­',
        duration: 3000
      })
    }
    
    await this.storageService.migrateFromPreferences()
    this.isComponentAlive = true
    await this.reloadSettings()
    await this.checkFirstLaunch()
  }

  aboutToDisappear(): void {
    this.isComponentAlive = false
    this.backgroundTasks.clear()
  }

  async onPageShow(): Promise<void> {
    // ä»è¯¦æƒ…é¡µè¿”å›æ—¶åˆ·æ–°æ•°æ®ï¼ˆç¬”è®°å¯èƒ½å·²æ›´æ–°ï¼‰
    if (this.storageService && !this.isLoading) {
      const updatedRecords = await this.storageService.getAllRecords()
      this.records = updatedRecords
      this.dataSource.setData(updatedRecords)
      hilog.info(0x0021, 'UI', '[Index] onPageShow åˆ·æ–°æ•°æ®ï¼Œå…±' + this.records.length + 'æ¡')
    }
    if (this.preferenceService) {
      await this.reloadSettings()
    }
  }

  async reloadSettings(): Promise<void> {
    if (this.preferenceService) {
      const newStyle = await this.preferenceService.getUIStyle()
      if (newStyle !== this.currentStyle) {
        this.currentStyle = newStyle
      }
    }
  }

  async checkFirstLaunch(): Promise<void> {
    try {
      if (this.preferenceService) {
        await this.preferenceService.init()
        const isFirst = await this.preferenceService.isFirstLaunch()
        
        if (isFirst) {
          this.getUIContext().getRouter().replaceUrl({ url: 'pages/WelcomePage' })
          return
        }
        
        this.currentStyle = await this.preferenceService.getUIStyle()
        
        if (this.storageService) {
          this.records = await this.storageService.getAllRecords()
          this.dataSource.setData(this.records)
        }
        
        this.isLoading = false
      }
    } catch (error) {
      hilog.error(0x0021, 'UI', 'æ£€æŸ¥é¦–æ¬¡å¯åŠ¨å¤±è´¥:' + error)
      this.isLoading = false
    }
  }

  goToSettings(): void {
    try {
      this.getUIContext().getRouter().pushUrl({ url: 'pages/SettingsPage' })
    } catch (error) {
      hilog.error(0x0021, 'UI', 'è·³è½¬è®¾ç½®é¡µå¤±è´¥:' + error)
    }
  }

  async addPhoto(): Promise<void> {
    let sandboxPath: string | undefined = undefined
    
    try {
      if (!this.photoPickerService) return
      const photoUri = await this.photoPickerService.selectPhoto()
      if (!photoUri) return

      try {
        sandboxPath = await this.photoPickerService.getSandboxPath(photoUri)
      } catch (e) {
        hilog.warn(0x0021, 'Picker', '[Index] è·å–æ²™ç®±è·¯å¾„å¤±è´¥:' + e)
      }

      if (!this.exifParserService) return
      const isRawFile = this.exifParserService.isRawFormat(photoUri)
      
      let basicData: ExifData
      if (isRawFile) {
        basicData = await this.exifParserService.parseExifAdvanced(photoUri, sandboxPath)
      } else {
        basicData = await this.exifParserService.parseExifQuick(photoUri)
      }

      let thumbnailPath = ''
      try {
        const pathForThumbnail = sandboxPath || photoUri
        thumbnailPath = await this.photoPickerService.generateThumbnail(pathForThumbnail)
      } catch (e) {
        hilog.warn(0x0021, 'Picker', '[Index] ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:' + e)
      }

      const hasExifData = basicData.cameraModel !== '' || basicData.iso > 0
      
      if (!hasExifData) {
        const uiContext = this.getUIContext()
        uiContext.getPromptAction().showDialog({
          title: 'æç¤º',
          message: 'è¯¥ç…§ç‰‡æ— EXIFå‚æ•°æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­æ·»åŠ ï¼Ÿ',
          buttons: [
            { text: 'å–æ¶ˆ', color: '#999999' },
            { text: 'ç»§ç»­æ·»åŠ ', color: '#007DFF' }
          ]
        }).then((result: promptAction.ShowDialogSuccessResponse) => {
          if (result.index === 1) {
            this.createRecordWithNote(basicData, thumbnailPath, photoUri, sandboxPath)
          }
          if (sandboxPath && this.photoPickerService) {
            this.photoPickerService.cleanupTempFile(sandboxPath)
          }
        })
        return
      }

      this.createRecordWithNote(basicData, thumbnailPath, photoUri, sandboxPath)
      
    } catch (error) {
      hilog.error(0x0021, 'UI', 'æ·»åŠ ç…§ç‰‡å¤±è´¥:' + error)
      if (sandboxPath && this.photoPickerService) {
        this.photoPickerService.cleanupTempFile(sandboxPath)
      }
      this.getUIContext().getPromptAction().showToast({
        message: 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    }
  }

  // ä¸‰ä¸“å®¶å…±è¯†æ–¹æ¡ˆBï¼šåˆ›å»ºè®°å½•åç«‹å³è·³è½¬è¯¦æƒ…é¡µç¼–è¾‘ç¬”è®°
  private async createRecordWithNote(
    exifData: ExifData, 
    thumbnailPath: string,
    photoUri?: string,
    sandboxPath?: string
  ): Promise<void> {
    const newRecord = await this.createRecordAndReturn(exifData, thumbnailPath, '', '')
    
    // åå°ç»§ç»­è§£æRAWæ ¼å¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (photoUri && this.exifParserService?.isRawFormat(photoUri)) {
      this.loadAdvancedDataInBackground(photoUri, sandboxPath, newRecord.id)
    } else if (sandboxPath && this.photoPickerService) {
      this.photoPickerService.cleanupTempFile(sandboxPath)
    }
    
    // ã€æ–¹æ¡ˆBæ ¸å¿ƒã€‘ç«‹å³è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œè®©ç”¨æˆ·ç¼–è¾‘ç¬”è®°
    hilog.info(0x0021, 'UI', '[Index] è·³è½¬è¯¦æƒ…é¡µç¼–è¾‘ç¬”è®°')
    this.getUIContext().getRouter().pushUrl({
      url: 'pages/PhotoDetailPage',
      params: { 
        record: newRecord, 
        isNew: true  // æ ‡è®°ä¸ºæ–°å»ºï¼Œè¯¦æƒ…é¡µè‡ªåŠ¨è¿›å…¥ç¼–è¾‘æ¨¡å¼
      }
    })
  }
  
  // åˆ›å»ºè®°å½•å¹¶è¿”å›å®Œæ•´å¯¹è±¡ï¼ˆç”¨äºè·³è½¬è¯¦æƒ…é¡µï¼‰
  private async createRecordAndReturn(
    exifData: ExifData, 
    thumbnailPath?: string,
    noteTitle?: string,
    note?: string
  ): Promise<PhotoRecord> {
    const now = Date.now()
    const recordId = this.generateUUID()
    const newRecord: PhotoRecord = {
      id: recordId,
      createTime: now,
      updateTime: now,
      exifData: exifData,
      noteTitle: noteTitle || '',
      note: note || '',
      thumbnailPath: thumbnailPath || ''
    }

    this.records.unshift(newRecord)
    this.dataSource.insertData(0, newRecord)

    if (this.storageService) {
      await this.storageService.saveRecord(newRecord)
    }

    return newRecord
  }

  private async loadAdvancedDataInBackground(
    uri: string, 
    sandboxPath: string | undefined, 
    recordId: string
  ): Promise<void> {
    this.backgroundTasks.set(recordId, true)
    
    try {
      if (!this.exifParserService) return
      
      if (this.exifParserService.isRawFormat(uri)) {
        this.backgroundTasks.delete(recordId)
        return
      }
      
      if (!this.isComponentAlive) return

      const advancedData = await this.exifParserService.parseExifAdvanced(uri, sandboxPath)
      
      if (!this.isComponentAlive || !this.backgroundTasks.has(recordId)) return

      const index = this.records.findIndex(r => r.id === recordId)
      if (index === -1) return

      const basicData = this.records[index].exifData
      const mergedData = this.exifParserService.mergeExifData(basicData, advancedData)
      
      const originalRecord = this.records[index]
      const updatedRecord: PhotoRecord = {
        id: originalRecord.id,
        createTime: originalRecord.createTime,
        updateTime: Date.now(),
        exifData: mergedData,
        noteTitle: originalRecord.noteTitle,
        note: originalRecord.note,
        thumbnailPath: originalRecord.thumbnailPath,
        thumbnail: originalRecord.thumbnail,
        isDeleting: originalRecord.isDeleting
      }
      
      const temp = [...this.records]
      temp[index] = updatedRecord
      this.records = temp
      this.dataSource.updateData(index, updatedRecord)

      if (this.storageService) {
        await this.storageService.saveRecord(updatedRecord)
      }

    } catch (error) {
      hilog.error(0x0021, 'EXIF', '[Index-Phase2] åå°è§£æå¤±è´¥:' + error)
    } finally {
      this.backgroundTasks.delete(recordId)
      if (sandboxPath && this.photoPickerService) {
        this.photoPickerService.cleanupTempFile(sandboxPath)
      }
    }
  }

  private async createRecord(
    exifData: ExifData, 
    thumbnailPath?: string,
    noteTitle?: string,
    note?: string
  ): Promise<string> {
    try {
      const now = Date.now()
      const recordId = this.generateUUID()
      const newRecord: PhotoRecord = {
        id: recordId,
        createTime: now,
        updateTime: now,
        exifData: exifData,
        noteTitle: noteTitle || '',
        note: note || '',
        thumbnailPath: thumbnailPath || ''
      }

      this.records.unshift(newRecord)
      this.dataSource.insertData(0, newRecord)

      if (this.storageService) {
        await this.storageService.saveRecord(newRecord)
      }

      this.getUIContext().getPromptAction().showToast({
        message: `å·²æ·»åŠ `,
        duration: 1500
      })

      return recordId
    } catch (error) {
      hilog.error(0x0021, 'UI', 'åˆ›å»ºè®°å½•å¤±è´¥:' + error)
      throw new Error('åˆ›å»ºè®°å½•å¤±è´¥: ' + String(error))
    }
  }

  private generateUUID(): string {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c: string) => {
      const r = Math.random() * 16 | 0
      const v = c === 'x' ? r : (r & 0x3 | 0x8)
      return v.toString(16)
    })
  }

  build() {
    Column() {
      if (this.isLoading) {
        Column() {
          LoadingProgress().width(50).height(50)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('å…‰å½±å¤‡å¿˜å½•')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
          
          Blank()
          
          Image($r('app.media.startIcon'))
            .width(28)
            .height(28)
            .onClick(() => this.goToSettings())
        }
        .width('100%')
        .height(56)
        .padding({ left: 20, right: 20 })

        // å†…å®¹åŒºåŸŸ
        if (this.records.length === 0) {
          this.EmptyState()
        } else {
          this.RecordList()
        }

        // åº•éƒ¨æ·»åŠ æŒ‰é’®
        Button() {
          Row() {
            Text('+')
              .fontSize(24)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Medium)
            Text(' æ–°å»ºç¬”è®°')
              .fontSize(16)
              .fontColor(Color.White)
          }
        }
        .width('88%')
        .height(52)
        .backgroundColor('#2563EB')
        .borderRadius(26)
        .shadow({ radius: 12, color: '#402563EB', offsetY: 4 })
        .margin({ bottom: 28, top: 12 })
        .onClick(() => this.addPhoto())
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8FAFC')
  }

  // ç©ºçŠ¶æ€
  @Builder
  EmptyState() {
    Column() {
      Text('ğŸ“·')
        .fontSize(64)
        .margin({ bottom: 16 })
      
      Text('è¿˜æ²¡æœ‰å¤ç›˜ç¬”è®°')
        .fontSize(18)
        .fontColor('#64748B')
        .margin({ bottom: 8 })
      
      Text('é€‰æ‹©ç…§ç‰‡ï¼Œè®°å½•æ‹æ‘„å¿ƒå¾—')
        .fontSize(14)
        .fontColor('#94A3B8')
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // è®°å½•åˆ—è¡¨
  @Builder
  RecordList() {
    List() {
      ForEach(this.records, (record: PhotoRecord) => {
        ListItem() {
          this.NoteCard(record)
        }
        .padding({ left: 16, right: 16, top: 6, bottom: 6 })
        .swipeAction({ end: this.DeleteButton(record) })
      }, (record: PhotoRecord) => record.id + '_' + record.updateTime.toString())
    }
    .width('100%')
    .layoutWeight(1)
    .cachedCount(5)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  // ç¬”è®°å¡ç‰‡ï¼ˆèƒŒæ™¯å›¾ + å‰æ™¯å†…å®¹ï¼‰
  @Builder
  NoteCard(record: PhotoRecord) {
    Stack() {
      // èƒŒæ™¯å±‚ï¼šç¼©ç•¥å›¾
      if (record.thumbnailPath && record.thumbnailPath.length > 0) {
        Image('file://' + record.thumbnailPath)
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
          .interpolation(ImageInterpolation.High)
          .borderRadius(16)
      } else {
        // æ— å›¾æ—¶çš„æ¸å˜èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .borderRadius(16)
          .linearGradient({
            angle: 135,
            colors: [['#667EEA', 0], ['#764BA2', 1]]
          })
      }

      // é®ç½©å±‚ï¼šåº•éƒ¨æ¸å˜ï¼ˆæ›´æŸ”å’Œï¼‰
      Column()
        .width('100%')
        .height('100%')
        .borderRadius(16)
        .linearGradient({
          angle: 180,
          colors: [
            ['#00000000', 0],
            ['#00000010', 0.4],
            ['#00000060', 0.7],
            ['#000000C0', 1]
          ]
        })

      // å³ä¸Šè§’ï¼šæ—¥æœŸæ ‡ç­¾
      Text(this.formatDate(record.createTime))
        .fontSize(10)
        .fontColor('#FFFFFFEE')
        .backgroundColor('#00000060')
        .padding({ left: 8, right: 8, top: 3, bottom: 3 })
        .borderRadius(6)
        .position({ right: 12, top: 12 })

      // åº•éƒ¨å†…å®¹åŒºåŸŸ
      Column() {
        // ç¬”è®°æ ‡é¢˜ï¼ˆæœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰
        if (record.noteTitle && record.noteTitle.length > 0) {
          Text(record.noteTitle)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textShadow({ radius: 4, color: '#80000000', offsetY: 1 })

          // ç¬”è®°æ‘˜è¦ï¼ˆæœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰
          if (record.note && record.note.length > 0) {
            Text(record.note)
              .fontSize(12)
              .fontColor('#FFFFFFCC')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')
              .margin({ top: 4 })
              .lineHeight(16)
          }
        }

        // åº•éƒ¨ä¿¡æ¯æ ï¼šæœºå‹
        if (record.exifData.cameraModel) {
          Text(record.exifData.cameraModel)
            .fontSize(10)
            .fontColor('#FFFFFF99')
            .maxLines(1)
            .margin({ top: record.noteTitle ? 8 : 0 })
        }
      }
      .width('100%')
      .padding({ left: 14, right: 14, bottom: 14 })
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.End)
      .height('100%')
    }
    .width('100%')
    .height(180)
    .borderRadius(16)
    .clip(true)
    .shadow({ radius: 8, color: '#20000000', offsetY: 4 })
    .onClick(() => this.goToDetail(record))
  }

  // åˆ é™¤æŒ‰é’®ï¼ˆå·¦æ»‘æ˜¾ç¤ºï¼‰
  @Builder
  DeleteButton(record: PhotoRecord) {
    Row() {
      Button() {
        Text('åˆ é™¤')
          .fontSize(14)
          .fontColor(Color.White)
      }
      .width(72)
      .height('100%')
      .backgroundColor('#EF4444')
      .onClick(() => this.confirmDeleteRecord(record))
    }
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ç¡®è®¤åˆ é™¤
  confirmDeleteRecord(record: PhotoRecord): void {
    promptAction.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'åˆ é™¤åæ— æ³•æ¢å¤',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#64748B' },
        { text: 'åˆ é™¤', color: '#EF4444' }
      ]
    }).then((result: promptAction.ShowDialogSuccessResponse) => {
      if (result.index === 1) {
        this.deleteRecord(record)
      }
    })
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  private formatDate(timestamp: number): string {
    const date = new Date(timestamp)
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    return `${month}-${day}`
  }

  // åˆ é™¤è®°å½•
  async deleteRecord(record: PhotoRecord): Promise<void> {
    try {
      const index = this.records.findIndex(r => r.id === record.id)
      if (index >= 0) {
        const temp = [...this.records]
        temp.splice(index, 1)
        this.records = temp
        this.dataSource.deleteData(index)
      }
      
      if (this.storageService) {
        await this.storageService.deleteRecord(record.id)
      }
      
      promptAction.showToast({ message: 'å·²åˆ é™¤', duration: 1500 })
    } catch (error) {
      hilog.error(0x0021, 'Storage', '[Index] åˆ é™¤å¤±è´¥: ' + error)
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥', duration: 1500 })
    }
  }

  // è·³è½¬è¯¦æƒ…é¡µ
  goToDetail(record: PhotoRecord): void {
    try {
      this.getUIContext().getRouter().pushUrl({
        url: 'pages/PhotoDetailPage',
        params: { record: record }
      })
    } catch (error) {
      hilog.error(0x0021, 'UI', 'è·³è½¬è¯¦æƒ…é¡µå¤±è´¥:' + error)
    }
  }
}
