/**
 * ç…§ç‰‡è¯¦æƒ…é¡µ - æ˜¾ç¤ºå®Œæ•´EXIFå‚æ•°
 */
import { PhotoRecord } from '../models/PhotoRecord'
import { Router, promptAction } from '@kit.ArkUI'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { DataStorageService } from '../services/DataStorageService'
import { common } from '@kit.AbilityKit'

interface RouteParams {
  record: PhotoRecord
  isNew?: boolean  // æ˜¯å¦æ–°å»ºç¬”è®°
}

// å‚æ•°é¡¹æ¥å£
interface ParamItem {
  label: string
  value: string
}

@Entry
@Component
struct PhotoDetailPage {
  @State record: PhotoRecord | null = null
  @State noteTitle: string = ''  // ç¬”è®°æ ‡é¢˜
  @State noteText: string = ''   // ç¬”è®°å†…å®¹
  @State isSaving: boolean = false  // ä¿å­˜çŠ¶æ€
  @State isNewNote: boolean = false  // æ˜¯å¦æ–°å»ºæ¨¡å¼
  @State showHint: boolean = false  // æ˜¾ç¤ºæç¤º
  private storageService: DataStorageService | null = null

  async aboutToAppear(): Promise<void> {
    const routerInstance: Router = this.getUIContext().getRouter()
    const params = routerInstance.getParams() as RouteParams
    if (params && params.record) {
      this.record = params.record
      this.noteTitle = this.record.noteTitle || ''
      this.noteText = this.record.note || ''
      this.isNewNote = params.isNew || false
      
      // æ–°å»ºæ¨¡å¼ï¼šæ˜¾ç¤ºæç¤ºå¼•å¯¼ç”¨æˆ·å†™ç¬”è®°
      if (this.isNewNote) {
        this.showHint = true
        hilog.info(0x0021, 'UI', '[Detail] æ–°å»ºç¬”è®°æ¨¡å¼')
      }
      
      hilog.info(0x0021, 'UI', '[Detail] åŠ è½½è®°å½•:' + this.record.id)
    }
    
    // åˆå§‹åŒ–å­˜å‚¨æœåŠ¡
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext
    this.storageService = new DataStorageService(context)
    await this.storageService.initialize()
  }

  // è·³è½¬åˆ°å®Œæ•´EXIFæ•°æ®é¡µ
  private goToAllExifData(): void {
    if (!this.record) return
    this.getUIContext().getRouter().pushUrl({
      url: 'pages/AllExifDataPage',
      params: { record: this.record }
    }).catch((err: Error) => {
      hilog.error(0x0021, 'UI', '[Detail] è·³è½¬å¤±è´¥:' + err)
    })
  }

  // å¤„ç†è¿”å›æŒ‰é’®
  private handleBack(): void {
    if (this.isNewNote && !this.noteTitle && !this.noteText) {
      // æ–°å»ºä¸”æœªå¡«å†™ä»»ä½•å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦æ”¾å¼ƒ
      promptAction.showDialog({
        title: 'æ”¾å¼ƒç¬”è®°',
        message: 'è¿˜æ²¡å†™ç¬”è®°å†…å®¹ï¼Œç¡®å®šæ”¾å¼ƒå—ï¼Ÿ',
        buttons: [
          { text: 'ç»§ç»­ç¼–è¾‘', color: '#007AFF' },
          { text: 'æ”¾å¼ƒ', color: '#FF3B30' }
        ]
      }).then((result: promptAction.ShowDialogSuccessResponse) => {
        if (result.index === 1) {
          // æ”¾å¼ƒï¼Œåˆ é™¤ç©ºè®°å½•
          this.deleteEmptyRecord()
        }
      })
    } else {
      this.getUIContext().getRouter().back()
    }
  }
  
  // åˆ é™¤ç©ºè®°å½•ï¼ˆç”¨äºå–æ¶ˆæ–°å»ºï¼‰
  private async deleteEmptyRecord(): Promise<void> {
    if (!this.record || !this.storageService) {
      this.getUIContext().getRouter().back()
      return
    }
    
    try {
      await this.storageService.deleteRecord(this.record.id)
      hilog.info(0x0021, 'UI', '[Detail] å·²åˆ é™¤ç©ºè®°å½•')
    } catch (error) {
      hilog.error(0x0021, 'UI', '[Detail] åˆ é™¤è®°å½•å¤±è´¥:' + error)
    }
    
    this.getUIContext().getRouter().back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#333333')
          .onClick(() => this.handleBack())
        
        Text(this.isNewNote ? 'æ–°å»ºç¬”è®°' : 'å‚æ•°è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ left: 16 })
        
        Blank()
        
        // æ–°å»ºæ¨¡å¼æ˜¾ç¤ºä¿å­˜æŒ‰é’®
        if (this.isNewNote) {
          Text(this.isSaving ? 'ä¿å­˜ä¸­...' : 'å®Œæˆ')
            .fontSize(16)
            .fontColor(this.isSaving ? '#999999' : '#007AFF')
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              if (!this.isSaving) {
                this.saveNote()
              }
            })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)

      // æ–°å»ºæ¨¡å¼å¼•å¯¼æç¤º
      if (this.showHint && this.isNewNote) {
        Row() {
          Text('ğŸ’¡')
            .fontSize(18)
          Text('å†™ä¸‹è¿™å¼ ç…§ç‰‡çš„æ‹æ‘„å¿ƒå¾—å§ï½')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 8 })
          Blank()
          Text('Ã—')
            .fontSize(18)
            .fontColor('#999999')
            .onClick(() => { this.showHint = false })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 10, bottom: 10 })
        .backgroundColor('#FFF4E5')
      }

      if (this.record) {
        // å‚æ•°åˆ—è¡¨
        Scroll() {
          Column() {
            // ç¬”è®°ç¼–è¾‘å¡ç‰‡å§‹ç»ˆåœ¨é¡¶éƒ¨ï¼ˆç»Ÿä¸€ä½“éªŒï¼‰
            this.NoteEditCard()
            
            // æ ¸å¿ƒå‚æ•°å¡ç‰‡
            this.ParamCard('ğŸ“¸ æ‹æ‘„å‚æ•°', this.getShootingParams())

            // ç›¸æœºä¿¡æ¯å¡ç‰‡
            this.ParamCard('ğŸ“· è®¾å¤‡ä¿¡æ¯', this.getDeviceParams())

            // æ›å…‰æ§åˆ¶å¡ç‰‡
            this.ParamCard('ğŸ”† æ›å…‰æ§åˆ¶', this.getExposureParams())

            // å›¾åƒå±æ€§å¡ç‰‡
            this.ParamCard('ğŸ–¼ï¸ å›¾åƒå±æ€§', this.getImageParams())

            // æ—¶é—´ä½ç½®å¡ç‰‡
            this.ParamCard('ğŸ“… æ—¶é—´ä½ç½®', this.getLocationParams())

            // æŸ¥çœ‹å®Œæ•´EXIFæŒ‰é’®
            Button('æŸ¥çœ‹å®Œæ•´EXIFæ•°æ® â†’')
              .width('100%')
              .height(48)
              .fontSize(15)
              .fontColor('#007AFF')
              .backgroundColor('#F0F7FF')
              .borderRadius(12)
              .margin({ top: 16, bottom: 16 })
              .onClick(() => {
                this.goToAllExifData()
              })
          }
          .padding(16)
        }
        .width('100%')
        .layoutWeight(1)
      } else {
        // ç©ºçŠ¶æ€
        Column() {
          Text('âŒ')
            .fontSize(48)
          Text('æ— æ³•åŠ è½½ç…§ç‰‡è¯¦æƒ…')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // è·å–æ‹æ‘„å‚æ•°
  private getShootingParams(): ParamItem[] {
    if (!this.record) return []
    const params: ParamItem[] = []
    if (this.record.exifData.aperture) {
      params.push({ label: 'å…‰åœˆ', value: this.record.exifData.aperture } as ParamItem)
    }
    if (this.record.exifData.shutterSpeed) {
      params.push({ label: 'å¿«é—¨', value: this.record.exifData.shutterSpeed } as ParamItem)
    }
    if (this.record.exifData.iso > 0) {
      params.push({ label: 'ISO', value: `ISO ${this.record.exifData.iso}` } as ParamItem)
    }
    if (this.record.exifData.focalLength) {
      params.push({ label: 'ç„¦è·', value: this.record.exifData.focalLength } as ParamItem)
    }
    if (this.record.exifData.focalLengthIn35mm) {
      params.push({ label: 'ç­‰æ•ˆç„¦è·', value: this.record.exifData.focalLengthIn35mm } as ParamItem)
    }
    if (this.record.exifData.maxAperture) {
      params.push({ label: 'æœ€å¤§å…‰åœˆ', value: this.record.exifData.maxAperture } as ParamItem)
    }
    return params
  }

  // è·å–è®¾å¤‡å‚æ•°
  private getDeviceParams(): ParamItem[] {
    if (!this.record) return []
    const params: ParamItem[] = []
    if (this.record.exifData.cameraMake) {
      params.push({ label: 'ç›¸æœºå“ç‰Œ', value: this.record.exifData.cameraMake } as ParamItem)
    }
    if (this.record.exifData.cameraModel) {
      params.push({ label: 'ç›¸æœºå‹å·', value: this.record.exifData.cameraModel } as ParamItem)
    }
    if (this.record.exifData.lensModel) {
      params.push({ label: 'é•œå¤´å‹å·', value: this.record.exifData.lensModel } as ParamItem)
    }
    if (this.record.exifData.lensMake) {
      params.push({ label: 'é•œå¤´å“ç‰Œ', value: this.record.exifData.lensMake } as ParamItem)
    }
    if (this.record.exifData.software) {
      params.push({ label: 'è½¯ä»¶', value: this.record.exifData.software } as ParamItem)
    }
    return params
  }

  // è·å–ä½ç½®å‚æ•°
  private getLocationParams(): ParamItem[] {
    if (!this.record) return []
    const params: ParamItem[] = []
    if (this.record.exifData.dateTime) {
      params.push({ label: 'æ‹æ‘„æ—¶é—´', value: this.record.exifData.dateTime } as ParamItem)
    }
    if (this.record.exifData.gpsLatitude) {
      params.push({ label: 'GPSçº¬åº¦', value: `${this.record.exifData.gpsLatitude.toFixed(6)}` } as ParamItem)
    }
    if (this.record.exifData.gpsLongitude) {
      params.push({ label: 'GPSç»åº¦', value: `${this.record.exifData.gpsLongitude.toFixed(6)}` } as ParamItem)
    }
    if (this.record.exifData.gpsAltitude) {
      params.push({ label: 'GPSæµ·æ‹”', value: `${this.record.exifData.gpsAltitude.toFixed(1)}m` } as ParamItem)
    }
    return params
  }

  // è·å–æ›å…‰å‚æ•°
  private getExposureParams(): ParamItem[] {
    if (!this.record) return []
    const params: ParamItem[] = []
    if (this.record.exifData.exposureMode) {
      params.push({ label: 'æ›å…‰æ¨¡å¼', value: this.record.exifData.exposureMode } as ParamItem)
    }
    if (this.record.exifData.exposureProgram) {
      params.push({ label: 'æ›å…‰ç¨‹åº', value: this.record.exifData.exposureProgram } as ParamItem)
    }
    if (this.record.exifData.exposureCompensation) {
      params.push({ label: 'æ›å…‰è¡¥å¿', value: this.record.exifData.exposureCompensation } as ParamItem)
    }
    if (this.record.exifData.meteringMode) {
      params.push({ label: 'æµ‹å…‰æ¨¡å¼', value: this.record.exifData.meteringMode } as ParamItem)
    }
    if (this.record.exifData.whiteBalance) {
      params.push({ label: 'ç™½å¹³è¡¡', value: this.record.exifData.whiteBalance } as ParamItem)
    }
    if (this.record.exifData.flash) {
      params.push({ label: 'é—ªå…‰ç¯', value: this.record.exifData.flash } as ParamItem)
    }
    if (this.record.exifData.brightness) {
      params.push({ label: 'äº®åº¦', value: this.record.exifData.brightness } as ParamItem)
    }
    return params
  }

  // è·å–å›¾åƒå±æ€§
  private getImageParams(): ParamItem[] {
    if (!this.record) return []
    const params: ParamItem[] = []
    if (this.record.exifData.imageWidth && this.record.exifData.imageHeight) {
      params.push({ label: 'å°ºå¯¸', value: `${this.record.exifData.imageWidth} Ã— ${this.record.exifData.imageHeight}` } as ParamItem)
    }
    if (this.record.exifData.orientation) {
      params.push({ label: 'æ–¹å‘', value: this.record.exifData.orientation } as ParamItem)
    }
    if (this.record.exifData.colorSpace) {
      params.push({ label: 'è‰²å½©ç©ºé—´', value: this.record.exifData.colorSpace } as ParamItem)
    }
    if (this.record.exifData.contrast) {
      params.push({ label: 'å¯¹æ¯”åº¦', value: this.record.exifData.contrast } as ParamItem)
    }
    if (this.record.exifData.saturation) {
      params.push({ label: 'é¥±å’Œåº¦', value: this.record.exifData.saturation } as ParamItem)
    }
    if (this.record.exifData.sharpness) {
      params.push({ label: 'é”åº¦', value: this.record.exifData.sharpness } as ParamItem)
    }
    if (this.record.exifData.sceneType) {
      params.push({ label: 'åœºæ™¯ç±»å‹', value: this.record.exifData.sceneType } as ParamItem)
    }
    if (this.record.exifData.exifVersion) {
      params.push({ label: 'EXIFç‰ˆæœ¬', value: this.record.exifData.exifVersion } as ParamItem)
    }
    return params
  }

  @Builder
  ParamCard(title: string, params: ParamItem[]) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .margin({ bottom: 12 })

      if (params.length > 0) {
        ForEach(params, (item: ParamItem) => {
          Row() {
            Text(item.label)
              .fontSize(14)
              .fontColor('#666666')
              .width(100)
            
            Text(item.value)
              .fontSize(14)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
          }
          .width('100%')
          .padding({ top: 8, bottom: 8 })
        })
      } else {
        Text('æš‚æ— æ•°æ®')
          .fontSize(13)
          .fontColor('#999999')
          .fontStyle(FontStyle.Italic)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ top: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  // ç¬”è®°ç¼–è¾‘å¡ç‰‡
  @Builder
  NoteEditCard() {
    Column() {
      Row() {
        Text('ğŸ“ æ‹æ‘„ç¬”è®°')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Text(`${this.noteText.length}/500`)
          .fontSize(12)
          .fontColor(this.noteText.length > 500 ? '#FF3B30' : '#999999')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ç¬”è®°æ ‡é¢˜
      TextInput({ placeholder: 'ç¬”è®°æ ‡é¢˜ï¼ˆå¦‚ï¼šé€†å…‰äººåƒå¿ƒå¾—ï¼‰', text: this.noteTitle })
        .width('100%')
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
        .maxLength(50)
        .onChange((value: string) => {
          this.noteTitle = value
        })
      
      // ç¬”è®°æ­£æ–‡
      TextArea({ placeholder: 'è¯¦ç»†è®°å½•æ‹æ‘„å‚æ•°ã€å…‰çº¿æ¡ä»¶ã€åæœŸæ€è·¯...', text: this.noteText })
        .width('100%')
        .height(this.isNewNote ? 180 : 120)
        .fontSize(14)
        .fontColor('#333333')
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
        .margin({ top: 12 })
        .maxLength(500)
        .onChange((value: string) => {
          this.noteText = value
        })

      // éæ–°å»ºæ¨¡å¼æ‰æ˜¾ç¤ºä¿å­˜æŒ‰é’®
      if (!this.isNewNote) {
        Button(this.isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ç¬”è®°')
          .width('100%')
          .height(44)
          .fontSize(15)
          .fontColor(Color.White)
          .backgroundColor(this.isSaving ? '#CCCCCC' : '#007AFF')
          .borderRadius(8)
          .margin({ top: 12 })
          .enabled(!this.isSaving)
          .onClick(() => {
            this.saveNote()
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ top: this.isNewNote ? 0 : 12 })
    .alignItems(HorizontalAlign.Start)
  }

  // ä¿å­˜ç¬”è®°
  private async saveNote(): Promise<void> {
    if (!this.record) return
    
    // å­—æ•°é™åˆ¶æ£€æŸ¥
    if (this.noteText.length > 500) {
      promptAction.showToast({
        message: 'ç¬”è®°ä¸èƒ½è¶…è¿‡500å­—',
        duration: 2000
      })
      return
    }
    
    try {
      this.isSaving = true
      
      // æ›´æ–°è®°å½•ï¼ˆæ ‡é¢˜+æ­£æ–‡ï¼‰
      this.record.noteTitle = this.noteTitle
      this.record.note = this.noteText
      this.record.updateTime = Date.now()
      
      // ä¿å­˜åˆ°å­˜å‚¨
      if (this.storageService) {
        await this.storageService.saveRecord(this.record)
        hilog.info(0x0021, 'UI', '[Detail] ç¬”è®°å·²ä¿å­˜: ' + this.noteTitle)
        
        promptAction.showToast({
          message: this.isNewNote ? 'ç¬”è®°å·²åˆ›å»º' : 'ç¬”è®°ä¿å­˜æˆåŠŸ',
          duration: 1500
        })
        
        // æ–°å»ºæ¨¡å¼ä¿å­˜åè¿”å›é¦–é¡µ
        if (this.isNewNote) {
          this.isNewNote = false  // æ ‡è®°ä¸ºå·²ä¿å­˜
          this.getUIContext().getRouter().back()
        }
      } else {
        throw new Error('å­˜å‚¨æœåŠ¡æœªåˆå§‹åŒ–')
      }
    } catch (error) {
      hilog.error(0x0021, 'UI', '[Detail] ä¿å­˜ç¬”è®°å¤±è´¥: ' + error)
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    } finally {
      this.isSaving = false
    }
  }
}
