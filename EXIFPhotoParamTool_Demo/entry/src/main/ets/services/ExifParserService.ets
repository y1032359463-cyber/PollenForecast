/**
 * EXIFè§£ææœåŠ¡
 * é‡‡ç”¨æ¸è¿›å¼åŠ è½½ç­–ç•¥ï¼šImage Kitå¿«é€Ÿæ˜¾ç¤º â†’ Native C++åå°è¡¥å……
 */
import { image } from '@kit.ImageKit'
import { fileIo } from '@kit.CoreFileKit'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { ExifData, createEmptyExifData } from '../models/PhotoRecord'
// Phase 2ä¼˜åŒ–ï¼šæ ‡å‡†å‘½åå¯¼å…¥ï¼ˆCodeGenieæ¨èï¼‰
import { parseExifFromPath, parseExifFromBuffer, NativeExifResult } from 'exifparser'
// Bæ–¹æ¡ˆæ‹†åˆ†ï¼šæ ¼å¼åŒ–å‡½æ•°ç‹¬ç«‹æ¨¡å—
import {
  formatAperture,
  formatShutterSpeed,
  formatFocalLength,
  formatDateTime,
  parseGpsCoordinate,
  formatExposureMode,
  formatExposureProgram,
  formatMeteringMode,
  formatFlash,
  formatGainControl,
  formatSubjectDistRange,
  formatSceneCaptureType,
  formatOrientation
} from './ExifFieldFormatters'

// RAWè§£ææ¨¡å¼ï¼ˆä¿ç•™ç±»å‹å®šä¹‰ä»¥å…¼å®¹æ—§ä»£ç ï¼‰
export type RawParseMode = 'embedded_jpeg' | 'libraw'

export class ExifParserService {
  /**
   * æ£€æµ‹æ˜¯å¦ä¸ºRAWæ ¼å¼æ–‡ä»¶
   * æ”¯æŒä¸»æµç›¸æœºå‚å•†çš„RAWæ ¼å¼
   */
  isRawFormat(uri: string): boolean {
    const lowerUri = uri.toLowerCase()
    return lowerUri.endsWith('.dng') ||   // Adobe DNG (é€šç”¨æ ‡å‡†)
           lowerUri.endsWith('.cr2') ||   // Canon (æ—§æ¬¾)
           lowerUri.endsWith('.cr3') ||   // Canon (æ–°æ¬¾)
           lowerUri.endsWith('.nef') ||   // Nikon
           lowerUri.endsWith('.arw') ||   // Sony
           lowerUri.endsWith('.raf') ||   // Fujifilm
           lowerUri.endsWith('.orf') ||   // Olympus / OM System
           lowerUri.endsWith('.rw2') ||   // Panasonic
           lowerUri.endsWith('.pef') ||   // Pentax
           lowerUri.endsWith('.srw') ||   // Samsung
           lowerUri.endsWith('.3fr') ||   // Hasselblad
           lowerUri.endsWith('.iiq') ||   // Phase One
           lowerUri.endsWith('.rwl') ||   // Leica
           lowerUri.endsWith('.dcs') ||   // Kodak
           lowerUri.endsWith('.kdc') ||   // Kodak
           lowerUri.endsWith('.erf') ||   // Epson
           lowerUri.endsWith('.mef') ||   // Mamiya
           lowerUri.endsWith('.mos') ||   // Leaf
           lowerUri.endsWith('.nrw')      // Nikon (Coolpix)
  }

  /**
   * æ¸è¿›å¼åŠ è½½ - Phase 1: å¿«é€Ÿè§£æåŸºç¡€å­—æ®µï¼ˆ~100msï¼‰
   * ä½¿ç”¨Image Kit PropertyKeyè·å–14ä¸ªæ ¸å¿ƒå‚æ•°
   * æ³¨æ„ï¼šå¿…é¡»ä½¿ç”¨fdæ–¹å¼ï¼ŒcreateImageSource(uri)ä¸æ”¯æŒfile://media/æ ¼å¼
   * @param photoUri FilePickerè¿”å›çš„ç…§ç‰‡URI
   * @returns åŸºç¡€ExifDataï¼ˆé€‚åˆç«‹å³æ˜¾ç¤ºï¼‰
   */
  async parseExifQuick(photoUri: string): Promise<ExifData> {
    let file: fileIo.File | null = null
    let imageSource: image.ImageSource | null = null
    
    try {
      // å¿…é¡»ç”¨fdæ–¹å¼ï¼šcreateImageSource(uri)ä¸æ”¯æŒFilePickerè¿”å›çš„file://media/æ ¼å¼
      file = fileIo.openSync(photoUri, fileIo.OpenMode.READ_ONLY)
      imageSource = image.createImageSource(file.fd)
      
      // ä»…æå–æ ¸å¿ƒå­—æ®µï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
      return await this.extractExifData(imageSource)
    } catch (e) {
      hilog.error(0x0021, 'EXIF', '[EXIF-Quick] å¿«é€Ÿè§£æå¤±è´¥:' + e)
      return this.createEmptyWithCurrentTime()
    } finally {
      if (imageSource) {
        try { imageSource.release() } catch (e) { /* ignore */ }
      }
      if (file) {
        try { fileIo.closeSync(file) } catch (e) { /* ignore */ }
      }
    }
  }

  /**
   * æ¸è¿›å¼åŠ è½½ - Phase 2: åå°è§£æé«˜çº§å­—æ®µï¼ˆ~2.5sï¼‰
   * RAWæ ¼å¼ä½¿ç”¨åŒé€šé“åˆå¹¶ç­–ç•¥ï¼šNative + Image Kit
   * @param photoUri FilePickerè¿”å›çš„ç…§ç‰‡URI
   * @param sandboxPath æ²™ç®±è·¯å¾„ï¼ˆNative C++éœ€è¦ï¼‰
   * @returns å®Œæ•´ExifDataï¼ˆåŒ…å«RAWä¸“å±å­—æ®µ + é€šç”¨å­—æ®µï¼‰
   */
  async parseExifAdvanced(photoUri: string, sandboxPath?: string): Promise<ExifData> {
    // RAWæ ¼å¼ï¼šåŒé€šé“åˆå¹¶ç­–ç•¥ï¼ˆä¿®å¤35â†’70+å­—æ®µé—®é¢˜ï¼‰
    if (this.isRawFormat(photoUri)) {
      hilog.info(0x0021, 'EXIF', '[EXIF-Advanced] æ£€æµ‹åˆ°RAWæ ¼å¼ï¼Œå¯ç”¨åŒé€šé“è§£æ...')
      
      // é€šé“1: Native C++è§£æRAWä¸“å±å­—æ®µï¼ˆ35+å­—æ®µï¼‰
      const nativeData = await this.parseRawByNative(photoUri, sandboxPath)
      
      // é€šé“2: Image Kitè§£æé€šç”¨å­—æ®µï¼ˆ14+å­—æ®µï¼‰
      let imageKitData: ExifData
      try {
        imageKitData = await this.parseExifQuick(photoUri)
        hilog.info(0x0021, 'EXIF', '[EXIF-Advanced] Image Kité€šé“æˆåŠŸ')
      } catch (e) {
        hilog.warn(0x0021, 'EXIF', '[EXIF-Advanced] Image Kité€šé“å¤±è´¥ï¼Œä»…ä½¿ç”¨Nativeæ•°æ®')
        return nativeData
      }
      
      // åŒé€šé“æ•°æ®åˆå¹¶ï¼ˆNativeä¼˜å…ˆï¼ŒImage Kitè¡¥å……ï¼‰
      const merged = this.mergeExifData(imageKitData, nativeData)
      hilog.info(0x0021, 'EXIF', '[EXIF-Advanced] åŒé€šé“åˆå¹¶å®Œæˆ')
      return merged
    }
    
    // æ™®é€šæ ¼å¼ï¼šä»ä½¿ç”¨å¿«é€Ÿè§£æï¼ˆæ— éœ€é«˜çº§å­—æ®µï¼‰
    return await this.parseExifQuick(photoUri)
  }

  /**
   * ã€å·²åºŸå¼ƒã€‘æ··åˆè§£æç­–ç•¥ï¼ˆä¿ç•™å‘åå…¼å®¹ï¼‰
   * æ–°ä»£ç è¯·ä½¿ç”¨ parseExifQuick + parseExifAdvanced
   */
  async parseExif(photoUri: string, sandboxPath?: string): Promise<ExifData> {
    // æ£€æµ‹RAWæ ¼å¼ï¼Œä½¿ç”¨Nativeè§£æ
    if (this.isRawFormat(photoUri)) {
      hilog.info(0x0021, 'EXIF', '[EXIF] æ£€æµ‹åˆ°RAWæ ¼å¼æ–‡ä»¶ï¼Œä½¿ç”¨Nativeè§£æ...')
      return await this.parseRawByNative(photoUri, sandboxPath)
    }

    // æ™®é€šæ ¼å¼ï¼šç­–ç•¥1 - fdæ–¹å¼ï¼ˆé€Ÿåº¦å¿«ï¼‰
    try {
      hilog.info(0x0021, 'EXIF', '[EXIF] å°è¯•fdæ–¹å¼è§£æ...')
      const result = await this.parseExifByFd(photoUri)
      // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ°æ ¸å¿ƒå­—æ®µ
      if (result.iso > 0 || result.aperture !== '' || result.cameraModel !== '') {
        hilog.info(0x0021, 'EXIF', '[EXIF] fdæ–¹å¼è§£ææˆåŠŸ')
        return result
      }
      hilog.info(0x0021, 'EXIF', '[EXIF] fdæ–¹å¼æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œå°è¯•æ²™ç®±æ–¹å¼...')
    } catch (e) {
      hilog.warn(0x0021, 'EXIF', '[EXIF] fdæ–¹å¼è§£æå¤±è´¥:' + e)
    }

    // ç­–ç•¥2ï¼šé™çº§åˆ°æ²™ç®±è·¯å¾„æ–¹å¼
    if (sandboxPath) {
      try {
        hilog.info(0x0021, 'EXIF', '[EXIF] å°è¯•æ²™ç®±è·¯å¾„è§£æ...')
        const result = await this.parseExifBySandbox(sandboxPath)
        hilog.info(0x0021, 'EXIF', '[EXIF] æ²™ç®±æ–¹å¼è§£ææˆåŠŸ')
        return result
      } catch (e) {
        hilog.error(0x0021, 'EXIF', '[EXIF] æ²™ç®±æ–¹å¼è§£æå¤±è´¥:' + e)
      }
    }

    // éƒ½å¤±è´¥åˆ™è¿”å›ç©ºæ•°æ®
    hilog.warn(0x0021, 'EXIF', '[EXIF] æ‰€æœ‰è§£ææ–¹å¼å‡å¤±è´¥ï¼Œè¿”å›ç©ºæ•°æ®')
    return this.createEmptyWithCurrentTime()
  }

  /**
   * åˆå¹¶åŸºç¡€æ•°æ®å’Œé«˜çº§æ•°æ®ï¼ˆCodeGenieæ¨èæ¨¡å¼ï¼‰
   * Native C++æ•°æ®ä¼˜å…ˆï¼Œä½†éœ€éªŒè¯æœ‰æ•ˆæ€§
   * ArkTSé™åˆ¶ï¼šä¸æ”¯æŒObject.assign/spreadï¼Œéœ€æ‰‹åŠ¨å¤åˆ¶æ‰€æœ‰å­—æ®µ
   */
  mergeExifData(basic: ExifData, advanced: ExifData): ExifData {
    // å…ˆå¤åˆ¶basicçš„æ‰€æœ‰éç©ºå­—æ®µåˆ°merged
    const merged = this.copyExifData(basic)
    
    // === Nativeå­—æ®µä¼˜å…ˆè¦†ç›–ï¼ˆå®Œæ•´35å­—æ®µï¼‰ ===
    
    // åŸºç¡€æ‹æ‘„å‚æ•°ï¼ˆP0æ ¸å¿ƒï¼‰
    if (advanced.aperture && advanced.aperture !== '') merged.aperture = advanced.aperture
    if (advanced.shutterSpeed && advanced.shutterSpeed !== '') merged.shutterSpeed = advanced.shutterSpeed
    if (advanced.iso > 0) merged.iso = advanced.iso
    if (advanced.focalLength && advanced.focalLength !== '') merged.focalLength = advanced.focalLength
    if (advanced.focalLengthIn35mm && advanced.focalLengthIn35mm !== '') merged.focalLengthIn35mm = advanced.focalLengthIn35mm
    
    // ç›¸æœºä¿¡æ¯
    if (advanced.cameraMake && advanced.cameraMake !== '') merged.cameraMake = advanced.cameraMake
    if (advanced.cameraModel && advanced.cameraModel !== '') merged.cameraModel = advanced.cameraModel
    if (advanced.software && advanced.software !== '') merged.software = advanced.software
    if (advanced.bodySerialNumber && advanced.bodySerialNumber !== '') merged.bodySerialNumber = advanced.bodySerialNumber
    
    // é•œå¤´ä¿¡æ¯
    if (advanced.lensModel && advanced.lensModel !== '') merged.lensModel = advanced.lensModel
    if (advanced.lensMake && advanced.lensMake !== '') merged.lensMake = advanced.lensMake
    if (advanced.lensSerialNumber && advanced.lensSerialNumber !== '') merged.lensSerialNumber = advanced.lensSerialNumber
    if (advanced.maxAperture && advanced.maxAperture !== '') merged.maxAperture = advanced.maxAperture
    
    // æ—¶é—´ä¿¡æ¯
    if (advanced.dateTime && advanced.dateTime !== '') merged.dateTime = advanced.dateTime
    if (advanced.dateTimeDigitized && advanced.dateTimeDigitized !== '') merged.dateTimeDigitized = advanced.dateTimeDigitized
    if (advanced.subSecTimeOriginal && advanced.subSecTimeOriginal !== '') merged.subSecTimeOriginal = advanced.subSecTimeOriginal
    if (advanced.subSecTimeDigitized && advanced.subSecTimeDigitized !== '') merged.subSecTimeDigitized = advanced.subSecTimeDigitized
    
    // åˆ†è¾¨ç‡å‚æ•°
    if (advanced.resolutionUnit && advanced.resolutionUnit !== '') merged.resolutionUnit = advanced.resolutionUnit
    if (advanced.focalPlaneXResolution && advanced.focalPlaneXResolution > 0) merged.focalPlaneXResolution = advanced.focalPlaneXResolution
    if (advanced.focalPlaneYResolution && advanced.focalPlaneYResolution > 0) merged.focalPlaneYResolution = advanced.focalPlaneYResolution
    if (advanced.focalPlaneResolutionUnit && advanced.focalPlaneResolutionUnit !== '') merged.focalPlaneResolutionUnit = advanced.focalPlaneResolutionUnit
    
    // å›¾åƒå±æ€§
    if (advanced.imageWidth && advanced.imageWidth > 0) merged.imageWidth = advanced.imageWidth
    if (advanced.imageHeight && advanced.imageHeight > 0) merged.imageHeight = advanced.imageHeight
    if (advanced.orientation && advanced.orientation !== '') merged.orientation = advanced.orientation
    if (advanced.compression && advanced.compression !== '') merged.compression = advanced.compression
    if (advanced.photometricInterpretation && advanced.photometricInterpretation !== '') merged.photometricInterpretation = advanced.photometricInterpretation
    if (advanced.bitsPerSample && advanced.bitsPerSample !== '') merged.bitsPerSample = advanced.bitsPerSample
    if (advanced.samplesPerPixel && advanced.samplesPerPixel !== '') merged.samplesPerPixel = advanced.samplesPerPixel
    
    // æ›å…‰æ§åˆ¶
    if (advanced.exposureProgram && advanced.exposureProgram !== '') merged.exposureProgram = advanced.exposureProgram
    if (advanced.meteringMode && advanced.meteringMode !== '') merged.meteringMode = advanced.meteringMode
    if (advanced.exposureMode && advanced.exposureMode !== '') merged.exposureMode = advanced.exposureMode
    
    // ç™½å¹³è¡¡ä¸é—ªå…‰ç¯
    if (advanced.flash && advanced.flash !== '') merged.flash = advanced.flash
    if (advanced.whiteBalance && advanced.whiteBalance !== '') merged.whiteBalance = advanced.whiteBalance
    
    // å›¾åƒè°ƒæ•´
    if (advanced.contrast && advanced.contrast !== '') merged.contrast = advanced.contrast
    if (advanced.saturation && advanced.saturation !== '') merged.saturation = advanced.saturation
    if (advanced.sharpness && advanced.sharpness !== '') merged.sharpness = advanced.sharpness
    
    // å…ƒæ•°æ®
    if (advanced.exifVersion && advanced.exifVersion !== '') merged.exifVersion = advanced.exifVersion
    if (advanced.sensingMethod && advanced.sensingMethod !== '') merged.sensingMethod = advanced.sensingMethod
    
    // GPSæ‰©å±•å­—æ®µï¼ˆImage Kitå¯èƒ½æä¾›ï¼‰
    if (advanced.gpsLatitude !== undefined) merged.gpsLatitude = advanced.gpsLatitude
    if (advanced.gpsLongitude !== undefined) merged.gpsLongitude = advanced.gpsLongitude
    if (advanced.gpsAltitude !== undefined) merged.gpsAltitude = advanced.gpsAltitude
    if (advanced.gpsLatitudeRef) merged.gpsLatitudeRef = advanced.gpsLatitudeRef
    if (advanced.gpsLongitudeRef) merged.gpsLongitudeRef = advanced.gpsLongitudeRef
    
    // === DNG 1.4/1.6ä¸“æœ‰å­—æ®µï¼ˆP0 - 12ä¸ªï¼‰===
    if (advanced.dngVersion) merged.dngVersion = advanced.dngVersion
    if (advanced.dngBackwardVersion) merged.dngBackwardVersion = advanced.dngBackwardVersion
    if (advanced.uniqueCameraModel) merged.uniqueCameraModel = advanced.uniqueCameraModel
    if (advanced.cameraSerialNumberDNG) merged.cameraSerialNumberDNG = advanced.cameraSerialNumberDNG
    if (advanced.dngLensInfo) merged.dngLensInfo = advanced.dngLensInfo
    if (advanced.originalRawFilename) merged.originalRawFilename = advanced.originalRawFilename
    if (advanced.baselineExposure !== undefined) merged.baselineExposure = advanced.baselineExposure
    if (advanced.baselineNoise !== undefined) merged.baselineNoise = advanced.baselineNoise
    if (advanced.baselineSharpness !== undefined) merged.baselineSharpness = advanced.baselineSharpness
    if (advanced.linearResponseLimit !== undefined) merged.linearResponseLimit = advanced.linearResponseLimit
    if (advanced.shadowScale !== undefined) merged.shadowScale = advanced.shadowScale
    if (advanced.previewColorSpace) merged.previewColorSpace = advanced.previewColorSpace
    
    return merged
  }

  /**
   * æ·±æ‹·è´ExifDataå¯¹è±¡ï¼ˆArkTSå…¼å®¹æ–¹å¼ï¼‰
   * é¿å…ä½¿ç”¨Object.assign/spreadç­‰å—é™API
   */
  private copyExifData(source: ExifData): ExifData {
    const target = createEmptyExifData()
    
    // åŸºç¡€å‚æ•°
    target.aperture = source.aperture
    target.shutterSpeed = source.shutterSpeed
    target.iso = source.iso
    target.focalLength = source.focalLength
    
    // ç›¸æœºä¿¡æ¯
    target.cameraMake = source.cameraMake
    target.cameraModel = source.cameraModel
    target.lensModel = source.lensModel
    if (source.lensMake) target.lensMake = source.lensMake
    if (source.lensSerialNumber) target.lensSerialNumber = source.lensSerialNumber
    if (source.bodySerialNumber) target.bodySerialNumber = source.bodySerialNumber
    
    // æ—¶é—´ä¿¡æ¯
    target.dateTime = source.dateTime
    if (source.dateTimeOriginal) target.dateTimeOriginal = source.dateTimeOriginal
    if (source.dateTimeDigitized) target.dateTimeDigitized = source.dateTimeDigitized
    if (source.subSecTime) target.subSecTime = source.subSecTime
    if (source.subSecTimeOriginal) target.subSecTimeOriginal = source.subSecTimeOriginal
    if (source.subSecTimeDigitized) target.subSecTimeDigitized = source.subSecTimeDigitized
    
    // GPSä¿¡æ¯
    if (source.gpsLatitude !== undefined) target.gpsLatitude = source.gpsLatitude
    if (source.gpsLongitude !== undefined) target.gpsLongitude = source.gpsLongitude
    if (source.gpsAltitude !== undefined) target.gpsAltitude = source.gpsAltitude
    if (source.gpsLatitudeRef) target.gpsLatitudeRef = source.gpsLatitudeRef
    if (source.gpsLongitudeRef) target.gpsLongitudeRef = source.gpsLongitudeRef
    if (source.gpsAltitudeRef) target.gpsAltitudeRef = source.gpsAltitudeRef
    if (source.gpsTimeStamp) target.gpsTimeStamp = source.gpsTimeStamp
    if (source.gpsDateStamp) target.gpsDateStamp = source.gpsDateStamp
    if (source.gpsProcessingMethod) target.gpsProcessingMethod = source.gpsProcessingMethod
    if (source.gpsSpeed) target.gpsSpeed = source.gpsSpeed
    if (source.gpsImgDirection) target.gpsImgDirection = source.gpsImgDirection
    
    // æ›å…‰æ§åˆ¶
    if (source.exposureCompensation) target.exposureCompensation = source.exposureCompensation
    if (source.exposureMode) target.exposureMode = source.exposureMode
    if (source.exposureProgram) target.exposureProgram = source.exposureProgram
    if (source.exposureTime) target.exposureTime = source.exposureTime
    if (source.exposureIndex) target.exposureIndex = source.exposureIndex
    if (source.meteringMode) target.meteringMode = source.meteringMode
    if (source.whiteBalance) target.whiteBalance = source.whiteBalance
    if (source.flash) target.flash = source.flash
    if (source.flashEnergy) target.flashEnergy = source.flashEnergy
    
    // é•œå¤´è¯¦æƒ…
    if (source.maxAperture) target.maxAperture = source.maxAperture
    if (source.focalLengthIn35mm) target.focalLengthIn35mm = source.focalLengthIn35mm
    if (source.focalPlaneXResolution) target.focalPlaneXResolution = source.focalPlaneXResolution
    if (source.focalPlaneYResolution) target.focalPlaneYResolution = source.focalPlaneYResolution
    if (source.focalPlaneResolutionUnit) target.focalPlaneResolutionUnit = source.focalPlaneResolutionUnit
    if (source.subjectDistance) target.subjectDistance = source.subjectDistance
    
    // å›¾åƒå±æ€§
    if (source.imageWidth) target.imageWidth = source.imageWidth
    if (source.imageHeight) target.imageHeight = source.imageHeight
    if (source.imageLength) target.imageLength = source.imageLength
    if (source.orientation) target.orientation = source.orientation
    if (source.colorSpace) target.colorSpace = source.colorSpace
    if (source.componentsConfiguration) target.componentsConfiguration = source.componentsConfiguration
    if (source.compression) target.compression = source.compression
    if (source.photometricInterpretation) target.photometricInterpretation = source.photometricInterpretation
    if (source.pixelXDimension) target.pixelXDimension = source.pixelXDimension
    if (source.pixelYDimension) target.pixelYDimension = source.pixelYDimension
    if (source.bitsPerSample) target.bitsPerSample = source.bitsPerSample
    if (source.samplesPerPixel) target.samplesPerPixel = source.samplesPerPixel
    
    // å›¾åƒå¤„ç†
    if (source.contrast) target.contrast = source.contrast
    if (source.saturation) target.saturation = source.saturation
    if (source.sharpness) target.sharpness = source.sharpness
    if (source.brightness) target.brightness = source.brightness
    if (source.lightSource) target.lightSource = source.lightSource
    if (source.gainControl) target.gainControl = source.gainControl
    if (source.digitalZoomRatio) target.digitalZoomRatio = source.digitalZoomRatio
    if (source.sceneCaptureType) target.sceneCaptureType = source.sceneCaptureType
    if (source.sceneType) target.sceneType = source.sceneType
    if (source.subjectDistanceRange) target.subjectDistanceRange = source.subjectDistanceRange
    if (source.customRendered) target.customRendered = source.customRendered
    if (source.sensingMethod) target.sensingMethod = source.sensingMethod
    
    // å…ƒæ•°æ®
    if (source.software) target.software = source.software
    if (source.exifVersion) target.exifVersion = source.exifVersion
    if (source.flashpixVersion) target.flashpixVersion = source.flashpixVersion
    if (source.imageDescription) target.imageDescription = source.imageDescription
    if (source.artist) target.artist = source.artist
    if (source.copyright) target.copyright = source.copyright
    if (source.userComment) target.userComment = source.userComment
    if (source.relatedSoundFile) target.relatedSoundFile = source.relatedSoundFile
    
    // ç¼©ç•¥å›¾
    if (source.thumbnailImageWidth) target.thumbnailImageWidth = source.thumbnailImageWidth
    if (source.thumbnailImageHeight) target.thumbnailImageHeight = source.thumbnailImageHeight
    
    // å…¶ä»–
    if (source.yCbCrPositioning) target.yCbCrPositioning = source.yCbCrPositioning
    if (source.xResolution) target.xResolution = source.xResolution
    if (source.yResolution) target.yResolution = source.yResolution
    if (source.resolutionUnit) target.resolutionUnit = source.resolutionUnit
    if (source.subjectArea) target.subjectArea = source.subjectArea
    if (source.spectalSensitivity) target.spectalSensitivity = source.spectalSensitivity
    if (source.fileSource) target.fileSource = source.fileSource
    if (source.cFAPattern) target.cFAPattern = source.cFAPattern
    if (source.whitePoint) target.whitePoint = source.whitePoint
    if (source.primaryChromaticities) target.primaryChromaticities = source.primaryChromaticities
    if (source.yCbCrCoefficients) target.yCbCrCoefficients = source.yCbCrCoefficients
    if (source.referenceBlackWhite) target.referenceBlackWhite = source.referenceBlackWhite
    if (source.transferFunction) target.transferFunction = source.transferFunction
    
    // === DNGä¸“æœ‰å­—æ®µï¼ˆ12ä¸ªï¼‰===
    if (source.dngVersion) target.dngVersion = source.dngVersion
    if (source.dngBackwardVersion) target.dngBackwardVersion = source.dngBackwardVersion
    if (source.uniqueCameraModel) target.uniqueCameraModel = source.uniqueCameraModel
    if (source.cameraSerialNumberDNG) target.cameraSerialNumberDNG = source.cameraSerialNumberDNG
    if (source.dngLensInfo) target.dngLensInfo = source.dngLensInfo
    if (source.originalRawFilename) target.originalRawFilename = source.originalRawFilename
    if (source.baselineExposure !== undefined) target.baselineExposure = source.baselineExposure
    if (source.baselineNoise !== undefined) target.baselineNoise = source.baselineNoise
    if (source.baselineSharpness !== undefined) target.baselineSharpness = source.baselineSharpness
    if (source.linearResponseLimit !== undefined) target.linearResponseLimit = source.linearResponseLimit
    if (source.shadowScale !== undefined) target.shadowScale = source.shadowScale
    if (source.previewColorSpace) target.previewColorSpace = source.previewColorSpace
    
    return target
  }

  /**
   * Native C++æ–¹å¼è§£æRAWï¼ˆä¸“ä¸šç‰ˆï¼‰
   * ä½¿ç”¨è‡ªç ”çš„EXIFè§£æå™¨ï¼Œç›´æ¥è§£æTIFF/DNGäºŒè¿›åˆ¶ç»“æ„
   * æ”¯æŒè¯»å–ExifIFDä¸­çš„æ ¸å¿ƒæ‹æ‘„å‚æ•°
   */
  private async parseRawByNative(photoUri: string, sandboxPath?: string): Promise<ExifData> {
    const exifData = createEmptyExifData()
    
    try {
      // === CodeGenieéªŒè¯æ­¥éª¤1ï¼šæ¨¡å—åŠ è½½çŠ¶æ€æ£€æµ‹ ===
      hilog.error(0x0021, 'EXIF', `[EXIF-Native-Check] parseExifFromPathç±»å‹: ${typeof parseExifFromPath}`)
      
      // æ¨¡å—é¢„æ£€æŸ¥ï¼ˆCodeGenieå»ºè®®ï¼‰
      if (!parseExifFromPath) {
        hilog.error(0x0021, 'EXIF', '[EXIF-Native] Nativeæ¨¡å—æ–¹æ³•æœªæ³¨å†Œï¼Œé™çº§åˆ°ArkTSæ–¹å¼')
        return await this.parseRawByThumbnail(photoUri, sandboxPath)
      }
      
      // ç¡®å®šè§£æè·¯å¾„ï¼ˆä¼˜å…ˆä½¿ç”¨æ²™ç®±è·¯å¾„ï¼‰
      const targetPath = sandboxPath || photoUri
      hilog.info(0x0021, 'EXIF', `[EXIF-Native] å¼€å§‹è§£æ: ${targetPath}`)
      
      // è°ƒç”¨Nativeè§£æï¼ˆç±»å‹è‡ªåŠ¨æ¨æ–­ï¼Œé¿å…ArkTSç»“æ„åŒ–ç±»å‹é”™è¯¯ï¼‰
      const nativeResult = parseExifFromPath(targetPath)
      
      if (!nativeResult.success) {
        hilog.error(0x0021, 'EXIF', `[EXIF-Native] è§£æå¤±è´¥: ${nativeResult.errorMessage}`)
        // é™çº§åˆ°ArkTSæ–¹å¼
        return await this.parseRawByThumbnail(photoUri, sandboxPath)
      }
      
      // è½¬æ¢Nativeç»“æœåˆ°ExifData
      exifData.aperture = nativeResult.aperture || ''
      exifData.shutterSpeed = nativeResult.shutterSpeed || ''
      exifData.iso = nativeResult.iso || 0
      exifData.focalLength = nativeResult.focalLength || ''
      exifData.focalLengthIn35mm = nativeResult.focalLength35mm > 0 ? `${nativeResult.focalLength35mm}mm` : ''
      
      exifData.cameraMake = nativeResult.cameraMake || ''
      exifData.cameraModel = nativeResult.cameraModel || ''
      exifData.lensModel = nativeResult.lensModel || ''
      exifData.lensMake = nativeResult.lensMake || ''
      exifData.lensSerialNumber = nativeResult.lensSerialNumber || ''
      
      exifData.dateTime = nativeResult.dateTimeOriginal || nativeResult.dateTime || ''
      exifData.software = nativeResult.software || ''
      
      exifData.imageWidth = nativeResult.imageWidth || nativeResult.pixelXDimension || 0
      exifData.imageHeight = nativeResult.imageHeight || nativeResult.pixelYDimension || 0
      exifData.orientation = formatOrientation(String(nativeResult.orientation || 1))
      
      exifData.exposureProgram = formatExposureProgram(String(nativeResult.exposureProgram || 0))
      exifData.meteringMode = formatMeteringMode(String(nativeResult.meteringMode || 0))
      exifData.flash = formatFlash(String(nativeResult.flash || 0))
      exifData.whiteBalance = nativeResult.whiteBalance === 0 ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'
      exifData.exposureMode = formatExposureMode(String(nativeResult.exposureMode || 0))
      
      if (nativeResult.exposureBias !== 0) {
        const bias = nativeResult.exposureBias
        exifData.exposureCompensation = `${bias >= 0 ? '+' : ''}${bias.toFixed(1)} EV`
      }
      
      if (nativeResult.maxAperture > 0) {
        exifData.maxAperture = `f/${nativeResult.maxAperture.toFixed(1)}`
      }
      
      exifData.colorSpace = nativeResult.colorSpace === 1 ? 'sRGB' : (nativeResult.colorSpace === 65535 ? 'Uncalibrated' : String(nativeResult.colorSpace))
      exifData.contrast = nativeResult.contrast === 0 ? 'æ ‡å‡†' : (nativeResult.contrast === 1 ? 'ä½' : 'é«˜')
      exifData.saturation = nativeResult.saturation === 0 ? 'æ ‡å‡†' : (nativeResult.saturation === 1 ? 'ä½' : 'é«˜')
      exifData.sharpness = nativeResult.sharpness === 0 ? 'æ ‡å‡†' : (nativeResult.sharpness === 1 ? 'æŸ”å’Œ' : 'é”åˆ©')
      
      // GPSä¿¡æ¯
      if (nativeResult.hasGPS) {
        let lat: number = nativeResult.gpsLatitude
        if (nativeResult.gpsLatitudeRef === 'S') lat = -lat
        exifData.gpsLatitude = lat
        exifData.gpsLatitudeRef = nativeResult.gpsLatitudeRef
        
        let lon: number = nativeResult.gpsLongitude
        if (nativeResult.gpsLongitudeRef === 'W') lon = -lon
        exifData.gpsLongitude = lon
        exifData.gpsLongitudeRef = nativeResult.gpsLongitudeRef
        
        exifData.gpsAltitude = nativeResult.gpsAltitude
        
        // GPSæ‰©å±•å­—æ®µ
        if (nativeResult.gpsTimeStamp) exifData.gpsTimeStamp = nativeResult.gpsTimeStamp
        if (nativeResult.gpsDateStamp) exifData.gpsDateStamp = nativeResult.gpsDateStamp
        if (nativeResult.gpsSpeed > 0) exifData.gpsSpeed = `${nativeResult.gpsSpeed.toFixed(1)} km/h`
        if (nativeResult.gpsImgDirection > 0) exifData.gpsImgDirection = `${nativeResult.gpsImgDirection.toFixed(1)}Â°`
      }
      
      // æ—¶é—´æ‰©å±•å­—æ®µ
      if (nativeResult.dateTimeDigitized) exifData.dateTimeDigitized = formatDateTime(nativeResult.dateTimeDigitized)
      if (nativeResult.subSecTime) exifData.subSecTime = nativeResult.subSecTime
      if (nativeResult.subSecTimeOriginal) exifData.subSecTimeOriginal = nativeResult.subSecTimeOriginal
      if (nativeResult.subSecTimeDigitized) exifData.subSecTimeDigitized = nativeResult.subSecTimeDigitized
      
      // é•œå¤´æ‰©å±•å­—æ®µ
      if (nativeResult.subjectDistance > 0) exifData.subjectDistance = `${nativeResult.subjectDistance.toFixed(2)}m`
      
      // åˆ†è¾¨ç‡å‚æ•°
      if (nativeResult.xResolution > 0) exifData.xResolution = nativeResult.xResolution
      if (nativeResult.yResolution > 0) exifData.yResolution = nativeResult.yResolution
      if (nativeResult.resolutionUnit > 0) {
        exifData.resolutionUnit = nativeResult.resolutionUnit === 2 ? 'è‹±å¯¸' : (nativeResult.resolutionUnit === 3 ? 'å˜ç±³' : String(nativeResult.resolutionUnit))
      }
      if (nativeResult.focalPlaneXResolution > 0) exifData.focalPlaneXResolution = nativeResult.focalPlaneXResolution
      if (nativeResult.focalPlaneYResolution > 0) exifData.focalPlaneYResolution = nativeResult.focalPlaneYResolution
      if (nativeResult.focalPlaneResolutionUnit > 0) exifData.focalPlaneResolutionUnit = String(nativeResult.focalPlaneResolutionUnit)
      
      // å›¾åƒå±æ€§æ‰©å±•
      if (nativeResult.compression > 0) exifData.compression = String(nativeResult.compression)
      if (nativeResult.photometricInterpretation > 0) exifData.photometricInterpretation = String(nativeResult.photometricInterpretation)
      if (nativeResult.imageDescription) exifData.imageDescription = nativeResult.imageDescription
      if (nativeResult.userComment) exifData.userComment = nativeResult.userComment
      if (nativeResult.bitsPerSample > 0) exifData.bitsPerSample = String(nativeResult.bitsPerSample)
      if (nativeResult.samplesPerPixel > 0) exifData.samplesPerPixel = String(nativeResult.samplesPerPixel)
      if (nativeResult.componentsConfiguration) exifData.componentsConfiguration = nativeResult.componentsConfiguration
      if (nativeResult.yCbCrPositioning > 0) exifData.yCbCrPositioning = String(nativeResult.yCbCrPositioning)
      
      // å…¶ä»–å…ƒæ•°æ®
      if (nativeResult.exifVersion) exifData.exifVersion = nativeResult.exifVersion
      if (nativeResult.flashpixVersion) exifData.flashpixVersion = nativeResult.flashpixVersion
      if (nativeResult.lightSource > 0) exifData.lightSource = String(nativeResult.lightSource)
      if (nativeResult.brightness !== 0) exifData.brightness = `${nativeResult.brightness.toFixed(2)} EV`
      if (nativeResult.sensingMethod > 0) exifData.sensingMethod = String(nativeResult.sensingMethod)
      if (nativeResult.relatedSoundFile) exifData.relatedSoundFile = nativeResult.relatedSoundFile
      
      // === æ–°å¢å­—æ®µæ˜ å°„ï¼ˆæ‰©å±•è‡³96å­—æ®µï¼‰===
      // æœºèº«åºåˆ—å·
      if (nativeResult.bodySerialNumber) exifData.bodySerialNumber = nativeResult.bodySerialNumber
      
      // å›¾åƒå¤„ç†æ‰©å±•
      if (nativeResult.gainControl > 0) exifData.gainControl = formatGainControl(nativeResult.gainControl)
      if (nativeResult.digitalZoomRatio > 0) exifData.digitalZoomRatio = `${nativeResult.digitalZoomRatio.toFixed(2)}x`
      if (nativeResult.sceneType > 0) exifData.sceneType = nativeResult.sceneType === 1 ? 'ç›´æ¥æ‹æ‘„' : String(nativeResult.sceneType)
      if (nativeResult.subjectDistanceRange > 0) exifData.subjectDistanceRange = formatSubjectDistRange(nativeResult.subjectDistanceRange)
      if (nativeResult.customRendered > 0) exifData.customRendered = nativeResult.customRendered === 0 ? 'æ­£å¸¸' : 'è‡ªå®šä¹‰'
      if (nativeResult.sceneCaptureType > 0) exifData.sceneCaptureType = formatSceneCaptureType(nativeResult.sceneCaptureType)
      if (nativeResult.exposureIndex > 0) exifData.exposureIndex = `${nativeResult.exposureIndex.toFixed(2)}`
      if (nativeResult.cFAPattern) exifData.cFAPattern = nativeResult.cFAPattern
      
      // é—ªå…‰ç¯æ‰©å±•
      if (nativeResult.flashEnergy > 0) exifData.flashEnergy = `${nativeResult.flashEnergy.toFixed(1)} BCPS`
      
      // æ–‡ä»¶/è®¾å¤‡æ‰©å±•
      if (nativeResult.fileSource > 0) exifData.fileSource = nativeResult.fileSource === 3 ? 'DSC' : String(nativeResult.fileSource)
      
      // ä¸»ä½“ä¿¡æ¯
      if (nativeResult.subjectLocation) exifData.subjectLocation = nativeResult.subjectLocation
      if (nativeResult.subjectArea) exifData.subjectArea = nativeResult.subjectArea
      
      // è‰²å½©ç§‘å­¦æ‰©å±•
      if (nativeResult.whitePoint) exifData.whitePoint = nativeResult.whitePoint
      if (nativeResult.primaryChromaticities) exifData.primaryChromaticities = nativeResult.primaryChromaticities
      if (nativeResult.yCbCrCoefficients) exifData.yCbCrCoefficients = nativeResult.yCbCrCoefficients
      if (nativeResult.referenceBlackWhite) exifData.referenceBlackWhite = nativeResult.referenceBlackWhite
      if (nativeResult.transferFunction) exifData.transferFunction = nativeResult.transferFunction
      
      // å…‰è°±æ‰©å±•
      if (nativeResult.spectralSensitivity) exifData.spectalSensitivity = nativeResult.spectralSensitivity
      if (nativeResult.oecf) exifData.oecf = nativeResult.oecf
      
      // åˆ¶é€ å•†ç§æœ‰
      if (nativeResult.makerNote) exifData.makerNote = nativeResult.makerNote
      
      // ä½œè€…ç‰ˆæƒ
      if (nativeResult.artist) exifData.artist = nativeResult.artist
      if (nativeResult.copyright) exifData.copyright = nativeResult.copyright
      
      // === Phase 2æ‰©å±•ï¼šDNG 1.4/1.6ä¸“æœ‰å­—æ®µï¼ˆP0 - 12ä¸ªï¼‰===
      if (nativeResult.dngVersion) exifData.dngVersion = nativeResult.dngVersion
      if (nativeResult.dngBackwardVersion) exifData.dngBackwardVersion = nativeResult.dngBackwardVersion
      if (nativeResult.uniqueCameraModel) exifData.uniqueCameraModel = nativeResult.uniqueCameraModel
      if (nativeResult.cameraSerialNumberDNG) exifData.cameraSerialNumberDNG = nativeResult.cameraSerialNumberDNG
      if (nativeResult.dngLensInfo) exifData.dngLensInfo = nativeResult.dngLensInfo
      if (nativeResult.originalRawFilename) exifData.originalRawFilename = nativeResult.originalRawFilename
      if (nativeResult.baselineExposure !== 0) exifData.baselineExposure = nativeResult.baselineExposure
      if (nativeResult.baselineNoise !== 0) exifData.baselineNoise = nativeResult.baselineNoise
      if (nativeResult.baselineSharpness !== 0) exifData.baselineSharpness = nativeResult.baselineSharpness
      if (nativeResult.linearResponseLimit !== 0) exifData.linearResponseLimit = nativeResult.linearResponseLimit
      if (nativeResult.shadowScale !== 0) exifData.shadowScale = nativeResult.shadowScale
      if (nativeResult.previewColorSpace) exifData.previewColorSpace = nativeResult.previewColorSpace
      
      // === è¯¦ç»†å­—æ®µç»Ÿè®¡æ—¥å¿— ===
      let fieldCount = 0
      let populatedFields: string[] = []
      
      // åŸºç¡€æ‹æ‘„å‚æ•°
      if (nativeResult.aperture) { fieldCount++; populatedFields.push('aperture') }
      if (nativeResult.shutterSpeed) { fieldCount++; populatedFields.push('shutterSpeed') }
      if (nativeResult.iso > 0) { fieldCount++; populatedFields.push('iso') }
      if (nativeResult.focalLength) { fieldCount++; populatedFields.push('focalLength') }
      if (nativeResult.focalLength35mm > 0) { fieldCount++; populatedFields.push('focalLength35mm') }
      
      // ç›¸æœºä¿¡æ¯
      if (nativeResult.cameraMake) { fieldCount++; populatedFields.push('cameraMake') }
      if (nativeResult.cameraModel) { fieldCount++; populatedFields.push('cameraModel') }
      if (nativeResult.software) { fieldCount++; populatedFields.push('software') }
      
      // é•œå¤´ä¿¡æ¯
      if (nativeResult.lensModel) { fieldCount++; populatedFields.push('lensModel') }
      if (nativeResult.lensMake) { fieldCount++; populatedFields.push('lensMake') }
      if (nativeResult.lensSerialNumber) { fieldCount++; populatedFields.push('lensSerialNumber') }
      if (nativeResult.subjectDistance > 0) { fieldCount++; populatedFields.push('subjectDistance') }
      
      // æ—¶é—´ä¿¡æ¯
      if (nativeResult.dateTime || nativeResult.dateTimeOriginal) { fieldCount++; populatedFields.push('dateTime') }
      if (nativeResult.dateTimeDigitized) { fieldCount++; populatedFields.push('dateTimeDigitized') }
      if (nativeResult.subSecTime) { fieldCount++; populatedFields.push('subSecTime') }
      if (nativeResult.subSecTimeOriginal) { fieldCount++; populatedFields.push('subSecTimeOriginal') }
      if (nativeResult.subSecTimeDigitized) { fieldCount++; populatedFields.push('subSecTimeDigitized') }
      
      // GPSä¿¡æ¯
      if (nativeResult.hasGPS) {
        fieldCount += 3
        populatedFields.push('gpsLatitude', 'gpsLongitude', 'gpsAltitude')
        if (nativeResult.gpsTimeStamp) { fieldCount++; populatedFields.push('gpsTimeStamp') }
        if (nativeResult.gpsDateStamp) { fieldCount++; populatedFields.push('gpsDateStamp') }
        if (nativeResult.gpsSpeed > 0) { fieldCount++; populatedFields.push('gpsSpeed') }
        if (nativeResult.gpsImgDirection > 0) { fieldCount++; populatedFields.push('gpsImgDirection') }
      }
      
      // åˆ†è¾¨ç‡å‚æ•°
      if (nativeResult.xResolution > 0) { fieldCount++; populatedFields.push('xResolution') }
      if (nativeResult.yResolution > 0) { fieldCount++; populatedFields.push('yResolution') }
      if (nativeResult.resolutionUnit > 0) { fieldCount++; populatedFields.push('resolutionUnit') }
      if (nativeResult.focalPlaneXResolution > 0) { fieldCount++; populatedFields.push('focalPlaneXResolution') }
      if (nativeResult.focalPlaneYResolution > 0) { fieldCount++; populatedFields.push('focalPlaneYResolution') }
      if (nativeResult.focalPlaneResolutionUnit > 0) { fieldCount++; populatedFields.push('focalPlaneResolutionUnit') }
      
      // å›¾åƒå±æ€§
      if (nativeResult.imageWidth > 0) { fieldCount++; populatedFields.push('imageWidth') }
      if (nativeResult.imageHeight > 0) { fieldCount++; populatedFields.push('imageHeight') }
      if (nativeResult.orientation > 0) { fieldCount++; populatedFields.push('orientation') }
      if (nativeResult.compression > 0) { fieldCount++; populatedFields.push('compression') }
      if (nativeResult.photometricInterpretation > 0) { fieldCount++; populatedFields.push('photometricInterpretation') }
      if (nativeResult.imageDescription) { fieldCount++; populatedFields.push('imageDescription') }
      if (nativeResult.bitsPerSample > 0) { fieldCount++; populatedFields.push('bitsPerSample') }
      if (nativeResult.samplesPerPixel > 0) { fieldCount++; populatedFields.push('samplesPerPixel') }
      if (nativeResult.componentsConfiguration) { fieldCount++; populatedFields.push('componentsConfiguration') }
      if (nativeResult.yCbCrPositioning > 0) { fieldCount++; populatedFields.push('yCbCrPositioning') }
      
      // æ›å…‰æ§åˆ¶
      if (nativeResult.exposureProgram > 0) { fieldCount++; populatedFields.push('exposureProgram') }
      if (nativeResult.meteringMode > 0) { fieldCount++; populatedFields.push('meteringMode') }
      if (nativeResult.exposureMode > 0) { fieldCount++; populatedFields.push('exposureMode') }
      if (nativeResult.exposureBias !== 0) { fieldCount++; populatedFields.push('exposureBias') }
      if (nativeResult.maxAperture > 0) { fieldCount++; populatedFields.push('maxAperture') }
      
      // å…¶ä»–å‚æ•°
      if (nativeResult.flash >= 0) { fieldCount++; populatedFields.push('flash') }
      if (nativeResult.whiteBalance >= 0) { fieldCount++; populatedFields.push('whiteBalance') }
      if (nativeResult.colorSpace > 0) { fieldCount++; populatedFields.push('colorSpace') }
      if (nativeResult.contrast >= 0) { fieldCount++; populatedFields.push('contrast') }
      if (nativeResult.saturation >= 0) { fieldCount++; populatedFields.push('saturation') }
      if (nativeResult.sharpness >= 0) { fieldCount++; populatedFields.push('sharpness') }
      
      // å…ƒæ•°æ®
      if (nativeResult.exifVersion) { fieldCount++; populatedFields.push('exifVersion') }
      if (nativeResult.flashpixVersion) { fieldCount++; populatedFields.push('flashpixVersion') }
      if (nativeResult.lightSource > 0) { fieldCount++; populatedFields.push('lightSource') }
      if (nativeResult.brightness !== 0) { fieldCount++; populatedFields.push('brightness') }
      if (nativeResult.sensingMethod > 0) { fieldCount++; populatedFields.push('sensingMethod') }
      if (nativeResult.userComment) { fieldCount++; populatedFields.push('userComment') }
      if (nativeResult.relatedSoundFile) { fieldCount++; populatedFields.push('relatedSoundFile') }
      
      // === æ–°å¢å­—æ®µç»Ÿè®¡ï¼ˆ21ä¸ªæ‰©å±•å­—æ®µï¼‰===
      if (nativeResult.bodySerialNumber) { fieldCount++; populatedFields.push('bodySerialNumber') }
      if (nativeResult.gainControl > 0) { fieldCount++; populatedFields.push('gainControl') }
      if (nativeResult.digitalZoomRatio > 0) { fieldCount++; populatedFields.push('digitalZoomRatio') }
      if (nativeResult.sceneType > 0) { fieldCount++; populatedFields.push('sceneType') }
      if (nativeResult.subjectDistanceRange > 0) { fieldCount++; populatedFields.push('subjectDistanceRange') }
      if (nativeResult.customRendered > 0) { fieldCount++; populatedFields.push('customRendered') }
      if (nativeResult.sceneCaptureType > 0) { fieldCount++; populatedFields.push('sceneCaptureType') }
      if (nativeResult.flashEnergy > 0) { fieldCount++; populatedFields.push('flashEnergy') }
      if (nativeResult.fileSource > 0) { fieldCount++; populatedFields.push('fileSource') }
      if (nativeResult.subjectLocation) { fieldCount++; populatedFields.push('subjectLocation') }
      if (nativeResult.subjectArea) { fieldCount++; populatedFields.push('subjectArea') }
      if (nativeResult.whitePoint) { fieldCount++; populatedFields.push('whitePoint') }
      if (nativeResult.primaryChromaticities) { fieldCount++; populatedFields.push('primaryChromaticities') }
      if (nativeResult.yCbCrCoefficients) { fieldCount++; populatedFields.push('yCbCrCoefficients') }
      if (nativeResult.referenceBlackWhite) { fieldCount++; populatedFields.push('referenceBlackWhite') }
      if (nativeResult.transferFunction) { fieldCount++; populatedFields.push('transferFunction') }
      if (nativeResult.spectralSensitivity) { fieldCount++; populatedFields.push('spectralSensitivity') }
      if (nativeResult.oecf) { fieldCount++; populatedFields.push('oecf') }
      if (nativeResult.makerNote) { fieldCount++; populatedFields.push('makerNote') }
      if (nativeResult.artist) { fieldCount++; populatedFields.push('artist') }
      if (nativeResult.copyright) { fieldCount++; populatedFields.push('copyright') }
      
      // === Phase 2æ‰©å±•ï¼šP0 DNGå­—æ®µç»Ÿè®¡ï¼ˆ12ä¸ªï¼‰===
      if (nativeResult.dngVersion) { fieldCount++; populatedFields.push('dngVersion') }
      if (nativeResult.dngBackwardVersion) { fieldCount++; populatedFields.push('dngBackwardVersion') }
      if (nativeResult.uniqueCameraModel) { fieldCount++; populatedFields.push('uniqueCameraModel') }
      if (nativeResult.cameraSerialNumberDNG) { fieldCount++; populatedFields.push('cameraSerialNumberDNG') }
      if (nativeResult.dngLensInfo) { fieldCount++; populatedFields.push('dngLensInfo') }
      if (nativeResult.originalRawFilename) { fieldCount++; populatedFields.push('originalRawFilename') }
      if (nativeResult.baselineExposure !== 0) { fieldCount++; populatedFields.push('baselineExposure') }
      if (nativeResult.baselineNoise !== 0) { fieldCount++; populatedFields.push('baselineNoise') }
      if (nativeResult.baselineSharpness !== 0) { fieldCount++; populatedFields.push('baselineSharpness') }
      if (nativeResult.linearResponseLimit !== 0) { fieldCount++; populatedFields.push('linearResponseLimit') }
      if (nativeResult.shadowScale !== 0) { fieldCount++; populatedFields.push('shadowScale') }
      if (nativeResult.previewColorSpace) { fieldCount++; populatedFields.push('previewColorSpace') }
      
      hilog.error(0x0021, 'EXIF', `[EXIF-Native] âœ… è§£æå®Œæˆï¼š${fieldCount}ä¸ªå­—æ®µæœ‰æ•ˆ`)
      hilog.error(0x0021, 'EXIF', `[EXIF-Native] ğŸ“‹ æœ‰æ•ˆå­—æ®µæ¸…å•: ${populatedFields.join(', ')}`)
      hilog.error(0x0021, 'EXIF', `[EXIF-Native] æ ¸å¿ƒå‚æ•°: ISO=${exifData.iso}, å…‰åœˆ=${exifData.aperture}, ç„¦è·=${exifData.focalLength}`)
      
      return exifData
      
    } catch (e) {
      // å¢å¼ºé”™è¯¯æ•è·ï¼ˆCodeGenieå»ºè®®ï¼‰
      hilog.error(0x0021, 'EXIF', `[EXIF-Native] é”™è¯¯è¯¦æƒ…: ${JSON.stringify(e)}`)
      // é™çº§åˆ°ArkTSæ–¹å¼
      return await this.parseRawByThumbnail(photoUri, sandboxPath)
    }
  }

  /**
   * å†…åµŒJPEGç¼©ç•¥å›¾æ–¹å¼è§£æRAWï¼ˆå…è´¹ç‰ˆï¼‰
   * é€šè¿‡å¤šIFDå±‚çº§æŸ¥è¯¢è·å–DNGçš„EXIFæ•°æ®
   */
  private async parseRawByThumbnail(photoUri: string, sandboxPath?: string): Promise<ExifData> {
    let file: fileIo.File | null = null
    let imageSource: image.ImageSource | null = null
    
    try {
      const targetPath = sandboxPath || photoUri
      file = fileIo.openSync(targetPath, fileIo.OpenMode.READ_ONLY)
      
      // åˆ›å»ºImageSourceï¼ˆä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦ç›´æ¥åˆ›å»ºï¼‰
      imageSource = image.createImageSource(file.fd)
      
      hilog.error(0x0021, 'EXIF', `[DNG-åˆå§‹åŒ–] fd=${file.fd}`)
      
      // å°è¯•ä»RAWæ–‡ä»¶å¤šå±‚çº§æå–EXIF
      hilog.info(0x0021, 'EXIF', '[EXIF] å°è¯•ä»RAWæ–‡ä»¶æå–EXIFï¼ˆå¤šIFDæ¨¡å¼ï¼‰...')
      
      let result: ExifData
      try {
        result = await this.extractRawExifData(imageSource)
        hilog.error(0x0021, 'EXIF', '[EXIF] extractRawExifDataæ‰§è¡Œå®Œæˆ')
      } catch (e) {
        hilog.error(0x0021, 'EXIF', '[EXIF] extractRawExifDataå¼‚å¸¸:' + e)
        result = createEmptyExifData()
      }
      
      // å¦‚æœç›´æ¥è·å–å¤±è´¥ï¼Œå°è¯•è·å–å›¾ç‰‡ä¿¡æ¯è¡¥å……
      if (result.iso === 0 && result.aperture === '') {
        hilog.info(0x0021, 'EXIF', '[EXIF] ç›´æ¥è·å–å¤±è´¥ï¼Œå°è¯•ä»å›¾åƒä¿¡æ¯æå–...')
        try {
          const imageInfo = await imageSource.getImageInfo()
          hilog.info(0x0021, 'EXIF', `[EXIF] RAWå›¾åƒä¿¡æ¯: ${JSON.stringify(imageInfo)}`)
          // è¡¥å……å›¾åƒå°ºå¯¸
          if (imageInfo && imageInfo.size) {
            result.imageWidth = imageInfo.size.width
            result.imageHeight = imageInfo.size.height
          }
        } catch (e) {
          hilog.warn(0x0021, 'EXIF', '[EXIF] è·å–å›¾åƒä¿¡æ¯å¤±è´¥:' + e)
        }
      }
      
      return result
    } catch (e) {
      hilog.error(0x0021, 'EXIF', '[EXIF] RAWè§£æå¤±è´¥:' + e)
      return this.createEmptyWithCurrentTime()
    } finally {
      if (imageSource) {
        try { imageSource.release() } catch (e) { /* ignore */ }
      }
      if (file) {
        try { fileIo.closeSync(file) } catch (e) { /* ignore */ }
      }
    }
  }

  /**
   * RAWæ ¼å¼ä¸“ç”¨EXIFæå–ï¼ˆæ ‡å‡†å­—æ®µéå†æ–¹æ¡ˆï¼‰
   * æ³¨ï¼šç«å“å‰ç¼€æµ‹è¯•ä»£ç ï¼ˆExif.Photo.xxx, ExifIFD:xxx, EXIF:xxx, 0xXXXXï¼‰å·²åˆ é™¤
   *     åä¸º Image Kit ä»…æ”¯æŒæ ‡å‡† PropertyKey æ ¼å¼
   */
  private async extractRawExifData(imageSource: image.ImageSource): Promise<ExifData> {
    const exifData = createEmptyExifData()

    // é«˜é¢‘å­—æ®µä¼˜å…ˆå°è¯•ï¼ˆCodeGenieæ¨èï¼‰
    const PRIORITY_KEYS = [
      'Model', 'Make', 'DateTime', 'DateTimeOriginal', 
      'ExposureTime', 'FNumber', 'ISOSpeedRatings', 
      'FocalLength', 'LensModel'
    ]

    // DNGç§æœ‰å­—æ®µï¼ˆéœ€è¦tag:Adobe:å‰ç¼€ï¼‰
    const DNG_PRIVATE_KEYS = [
      'tag:Adobe:DNGVersion',
      'tag:Adobe:DNGBackwardVersion',
      'tag:Adobe:UniqueCameraModel'
    ]

    // å®Œæ•´æ ‡å‡†EXIFå­—æ®µï¼ˆ67ä¸ªï¼‰
    const STANDARD_KEYS = [
      'FNumber', 'ExposureTime', 'ISOSpeedRatings', 'FocalLength', 'ExposureCompensation',
      'ExposureBiasValue', 'ExposureMode', 'ExposureProgram', 'MeteringMode',
      'Make', 'Model', 'BodySerialNumber', 'Software', 'ExifVersion',
      'LensModel', 'LensMake', 'LensSerialNumber', 'MaxApertureValue', 'SubjectDistance',
      'DateTimeOriginal', 'DateTime', 'DateTimeDigitized', 'SubSecTime', 'SubSecTimeOriginal',
      'WhiteBalance', 'Flash', 'FlashEnergy', 'LightSource',
      'ColorSpace', 'Contrast', 'Saturation', 'Sharpness', 'BrightnessValue', 'GainControl',
      'GPSLatitude', 'GPSLongitude', 'GPSAltitude', 'GPSLatitudeRef', 'GPSLongitudeRef',
      'GPSAltitudeRef', 'GPSSpeed', 'GPSImgDirection', 'GPSTimeStamp',
      'ImageWidth', 'ImageHeight', 'ImageLength', 'Orientation', 'Compression',
      'XResolution', 'YResolution', 'ResolutionUnit', 
      'FocalPlaneXResolution', 'FocalPlaneYResolution', 'FocalPlaneResolutionUnit',
      'SubjectDistanceRange', 'SubjectArea', 'SensingMethod', 'FocalLengthIn35mmFilm',
      'SceneType', 'SceneCaptureType', 'DigitalZoomRatio', 'FileSource',
      'Artist', 'Copyright', 'ImageDescription', 'UserComment',
      'PhotometricInterpretation', 'YCbCrCoefficients', 'CFAPattern'
    ]

    let successCount = 0
    let failCount = 0

    // 1. å…ˆå°è¯•é«˜é¢‘å­—æ®µ
    for (const key of PRIORITY_KEYS) {
      try {
        const value = await imageSource.getImageProperty(key)
        if (value && value !== '' && value !== 'undefined') {
          this.mapFieldToExifData(key, value, exifData)
          successCount++
          hilog.info(0x0021, 'EXIF', `[EXIF] âœ“ ${key}=${value}`)
        } else {
          failCount++
        }
      } catch (e) {
        failCount++
      }
    }

    // 2. å°è¯•DNGç§æœ‰å­—æ®µ
    for (const key of DNG_PRIVATE_KEYS) {
      try {
        const value = await imageSource.getImageProperty(key)
        if (value && value !== '') {
          successCount++
          hilog.info(0x0021, 'EXIF', `[EXIF] [RAW-DNG] ${key}=${value}`)
        }
      } catch (e) { /* å¿½ç•¥ */ }
    }

    // 3. éå†å…¶ä½™æ ‡å‡†å­—æ®µï¼ˆè·³è¿‡å·²å°è¯•çš„ï¼‰
    for (const key of STANDARD_KEYS) {
      if (PRIORITY_KEYS.includes(key)) continue
      
      try {
        const value = await imageSource.getImageProperty(key)
        if (value && value !== '' && value !== 'undefined') {
          this.mapFieldToExifData(key, value, exifData)
          successCount++
          hilog.info(0x0021, 'EXIF', `[EXIF] âœ“ ${key}=${value}`)
        } else {
          failCount++
        }
      } catch (e) {
        failCount++
      }
    }

    hilog.error(0x0021, 'EXIF', `[EXIF] ğŸŸ¢ è§£æå®Œæˆï¼šæˆåŠŸ${successCount}ä¸ªï¼Œå¤±è´¥${failCount}ä¸ª ğŸŸ¢`)
    hilog.error(0x0021, 'EXIF', `[EXIF] ç»“æœï¼šISO=${exifData.iso}, å…‰åœˆ=${exifData.aperture}, æœºå‹=${exifData.cameraModel}`)
    
    return exifData
  }

  /**
   * å°†å­—æ®µæ˜ å°„åˆ°ExifDataï¼ˆæ ¹æ®åä¸ºæ”¯æŒçš„å®é™…å­—æ®µåï¼‰
   */
  private mapFieldToExifData(key: string, value: string, exifData: ExifData): void {
    switch(key) {
      // åŸºç¡€æ‹æ‘„å‚æ•°
      case 'FNumber':
      case 'ApertureValue':
        exifData.aperture = formatAperture(value)
        break
      case 'ExposureTime':
      case 'ShutterSpeedValue':
        exifData.shutterSpeed = formatShutterSpeed(value)
        break
      case 'ISOSpeedRatings':
      case 'PhotographicSensitivity':
        exifData.iso = parseInt(value) || 0
        break
      case 'FocalLength':
        exifData.focalLength = formatFocalLength(value)
        break
      case 'FocalLengthIn35mmFilm':
        exifData.focalLengthIn35mm = `${value}mm`
        break
        
      // è®¾å¤‡ä¿¡æ¯
      case 'Make':
        exifData.cameraMake = value
        break
      case 'Model':
        exifData.cameraModel = value
        break
      case 'LensModel':
        exifData.lensModel = value
        break
      case 'LensMake':
        exifData.lensMake = value
        break
        
      // æ—¶é—´ä¿¡æ¯
      case 'DateTimeOriginal':
        exifData.dateTime = formatDateTime(value)
        break
      case 'DateTime':
        if (!exifData.dateTime) exifData.dateTime = formatDateTime(value)
        break
        
      // æ›å…‰æ§åˆ¶
      case 'ExposureMode':
        exifData.exposureMode = formatExposureMode(value)
        break
      case 'ExposureProgram':
        exifData.exposureProgram = formatExposureProgram(value)
        break
      case 'MeteringMode':
        exifData.meteringMode = formatMeteringMode(value)
        break
      case 'WhiteBalance':
        exifData.whiteBalance = value === '0' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'
        break
      case 'Flash':
        exifData.flash = formatFlash(value)
        break
        
      // GPSä¿¡æ¯
      case 'GPSLatitude':
        exifData.gpsLatitude = parseGpsCoordinate(value)
        break
      case 'GPSLongitude':
        exifData.gpsLongitude = parseGpsCoordinate(value)
        break
      case 'GPSAltitude':
        exifData.gpsAltitude = parseFloat(value)
        break
        
      // å›¾åƒå±æ€§
      case 'ImageWidth':
      case 'PixelXDimension':
        exifData.imageWidth = parseInt(value)
        break
      case 'ImageHeight':
      case 'ImageLength':
      case 'PixelYDimension':
        exifData.imageHeight = parseInt(value)
        break
      case 'Orientation':
        exifData.orientation = formatOrientation(value)
        break
      case 'ColorSpace':
        exifData.colorSpace = value === '1' ? 'sRGB' : value
        break
        
      // å…¶ä»–å¸¸ç”¨å­—æ®µ
      case 'Software':
        exifData.software = value
        break
      case 'ExifVersion':
        exifData.exifVersion = value
        break
        
      default:
        // æœªçŸ¥å­—æ®µï¼Œä¸å¤„ç†
        break
    }
  }

  /**
   * fdæ–¹å¼è§£æï¼ˆç¨³å®šç‰ˆï¼‰
   * å¿…é¡»ä½¿ç”¨fdæ–¹å¼ï¼ŒcreateImageSource(uri)ä¸æ”¯æŒfile://media/æ ¼å¼
   */
  private async parseExifByFd(photoUri: string): Promise<ExifData> {
    let file: fileIo.File | null = null
    let imageSource: image.ImageSource | null = null
    
    try {
      file = fileIo.openSync(photoUri, fileIo.OpenMode.READ_ONLY)
      imageSource = image.createImageSource(file.fd)
      return await this.extractExifData(imageSource)
    } finally {
      if (imageSource) {
        try { imageSource.release() } catch (e) { /* ignore */ }
      }
      if (file) {
        try { fileIo.closeSync(file) } catch (e) { /* ignore */ }
      }
    }
  }

  /**
   * æ²™ç®±è·¯å¾„æ–¹å¼è§£æï¼ˆCodeGenieæ¨èï¼‰
   */
  private async parseExifBySandbox(sandboxPath: string): Promise<ExifData> {
    let file: fileIo.File | null = null
    let imageSource: image.ImageSource | null = null
    
    try {
      // ä½¿ç”¨æ²™ç®±å†…çš„ç»å¯¹è·¯å¾„åˆ›å»ºImageSource
      file = fileIo.openSync(sandboxPath, fileIo.OpenMode.READ_ONLY)
      imageSource = image.createImageSource(file.fd)
      return await this.extractExifData(imageSource)
    } finally {
      if (imageSource) {
        try { imageSource.release() } catch (e) { /* ignore */ }
      }
      if (file) {
        try { fileIo.closeSync(file) } catch (e) { /* ignore */ }
      }
    }
  }

  /**
   * åˆ›å»ºå¸¦å½“å‰æ—¶é—´çš„ç©ºExifData
   */
  private createEmptyWithCurrentTime(): ExifData {
    const exifData = createEmptyExifData()
    exifData.dateTime = new Date().toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
    return exifData
  }

  /**
   * ä»ImageSourceæå–EXIFæ•°æ®
   */
  private async extractExifData(imageSource: image.ImageSource): Promise<ExifData> {
    const exifData = createEmptyExifData()

    try {
      // å…‰åœˆ (FNumber)
      const aperture = await imageSource.getImageProperty(image.PropertyKey.F_NUMBER)
      hilog.info(0x0021, 'EXIF', `[EXIF] åŸå§‹å…‰åœˆå€¼: ${aperture}`)
      if (aperture) {
        exifData.aperture = formatAperture(aperture)
      }

      // å¿«é—¨é€Ÿåº¦ (ExposureTime)
      const shutterSpeed = await imageSource.getImageProperty(image.PropertyKey.EXPOSURE_TIME)
      hilog.info(0x0021, 'EXIF', `[EXIF] åŸå§‹å¿«é—¨å€¼: ${shutterSpeed}`)
      if (shutterSpeed) {
        exifData.shutterSpeed = formatShutterSpeed(shutterSpeed)
      }

      // ISO
      const iso = await imageSource.getImageProperty(image.PropertyKey.ISO_SPEED_RATINGS)
      hilog.info(0x0021, 'EXIF', `[EXIF] åŸå§‹ISOå€¼: ${iso}`)
      if (iso) {
        exifData.iso = parseInt(iso)
      }

      // ç„¦è· (FocalLength)
      const focalLength = await imageSource.getImageProperty(image.PropertyKey.FOCAL_LENGTH)
      hilog.info(0x0021, 'EXIF', `[EXIF] åŸå§‹ç„¦è·å€¼: ${focalLength}`)
      if (focalLength) {
        exifData.focalLength = formatFocalLength(focalLength)
      }

      // ç›¸æœºå“ç‰Œ
      try {
        const cameraMake = await imageSource.getImageProperty(image.PropertyKey.MAKE)
        hilog.info(0x0021, 'EXIF', `[EXIF] MAKE: ${cameraMake}`)
        if (cameraMake && cameraMake !== '') {
          exifData.cameraMake = cameraMake
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] MAKE è·å–å¤±è´¥') }

      // ç›¸æœºå‹å·
      try {
        const cameraModel = await imageSource.getImageProperty(image.PropertyKey.MODEL)
        hilog.info(0x0021, 'EXIF', `[EXIF] MODEL: ${cameraModel}`)
        if (cameraModel && cameraModel !== '') {
          exifData.cameraModel = cameraModel
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] MODEL è·å–å¤±è´¥') }

      // é•œå¤´å‹å·
      try {
        const lensModel = await imageSource.getImageProperty(image.PropertyKey.LENS_MODEL)
        hilog.info(0x0021, 'EXIF', `[EXIF] LENS_MODEL: ${lensModel}`)
        if (lensModel && lensModel !== '') {
          exifData.lensModel = lensModel
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] LENS_MODEL è·å–å¤±è´¥') }

      // æ‹æ‘„æ—¶é—´ï¼ˆå°è¯•å¤šä¸ªå­—æ®µï¼‰
      try {
        let dateTime = await imageSource.getImageProperty(image.PropertyKey.DATE_TIME_ORIGINAL)
        hilog.info(0x0021, 'EXIF', `[EXIF] DATE_TIME_ORIGINAL: ${dateTime}`)
        
        if (!dateTime || dateTime === '') {
          dateTime = await imageSource.getImageProperty(image.PropertyKey.DATE_TIME)
          hilog.info(0x0021, 'EXIF', `[EXIF] DATE_TIME: ${dateTime}`)
        }
        
        if (dateTime && dateTime !== '') {
          exifData.dateTime = formatDateTime(dateTime)
          hilog.info(0x0021, 'EXIF', `[EXIF] æœ€ç»ˆæ—¥æœŸ: ${exifData.dateTime}`)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] DateTime è·å–å¤±è´¥') }

      // GPSä¿¡æ¯
      try {
        const gpsLat = await imageSource.getImageProperty(image.PropertyKey.GPS_LATITUDE)
        const gpsLon = await imageSource.getImageProperty(image.PropertyKey.GPS_LONGITUDE)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS: ${gpsLat}, ${gpsLon}`)
        if (gpsLat && gpsLon && gpsLat !== '' && gpsLon !== '') {
          exifData.gpsLatitude = parseGpsCoordinate(gpsLat)
          exifData.gpsLongitude = parseGpsCoordinate(gpsLon)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS è·å–å¤±è´¥') }

      // === æ‰©å±•å­—æ®µï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰ ===
      hilog.info(0x0021, 'EXIF', '[EXIF] ===== å¼€å§‹æå–æ‰©å±•å­—æ®µ =====')
      
      // GPSæµ·æ‹”
      try {
        const gpsAlt = await imageSource.getImageProperty(image.PropertyKey.GPS_ALTITUDE)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_ALTITUDE: ${gpsAlt}`)
        if (gpsAlt && gpsAlt !== '') {
          exifData.gpsAltitude = parseFloat(gpsAlt)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_ALTITUDE è·å–å¤±è´¥') }

      // æ›å…‰è¡¥å¿
      try {
        const exposureBias = await imageSource.getImageProperty(image.PropertyKey.EXPOSURE_BIAS_VALUE)
        hilog.info(0x0021, 'EXIF', `[EXIF] EXPOSURE_BIAS_VALUE: ${exposureBias}`)
        if (exposureBias && exposureBias !== '') {
          const biasNum = parseFloat(exposureBias)
          exifData.exposureCompensation = `${biasNum >= 0 ? '+' : ''}${biasNum.toFixed(1)} EV`
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] EXPOSURE_BIAS_VALUE è·å–å¤±è´¥') }

      // æ›å…‰æ¨¡å¼
      try {
        const exposureMode = await imageSource.getImageProperty(image.PropertyKey.EXPOSURE_MODE)
        hilog.info(0x0021, 'EXIF', `[EXIF] EXPOSURE_MODE: ${exposureMode}`)
        if (exposureMode && exposureMode !== '') {
          exifData.exposureMode = formatExposureMode(exposureMode)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] EXPOSURE_MODE è·å–å¤±è´¥') }

      // æ›å…‰ç¨‹åº
      try {
        const exposureProgram = await imageSource.getImageProperty(image.PropertyKey.EXPOSURE_PROGRAM)
        hilog.info(0x0021, 'EXIF', `[EXIF] EXPOSURE_PROGRAM: ${exposureProgram}`)
        if (exposureProgram && exposureProgram !== '') {
          exifData.exposureProgram = formatExposureProgram(exposureProgram)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] EXPOSURE_PROGRAM è·å–å¤±è´¥') }

      // æµ‹å…‰æ¨¡å¼
      try {
        const meteringMode = await imageSource.getImageProperty(image.PropertyKey.METERING_MODE)
        hilog.info(0x0021, 'EXIF', `[EXIF] METERING_MODE: ${meteringMode}`)
        if (meteringMode && meteringMode !== '') {
          exifData.meteringMode = formatMeteringMode(meteringMode)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] METERING_MODE è·å–å¤±è´¥') }

      // ç™½å¹³è¡¡
      try {
        const whiteBalance = await imageSource.getImageProperty(image.PropertyKey.WHITE_BALANCE)
        hilog.info(0x0021, 'EXIF', `[EXIF] WHITE_BALANCE: ${whiteBalance}`)
        if (whiteBalance && whiteBalance !== '') {
          exifData.whiteBalance = whiteBalance === '0' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] WHITE_BALANCE è·å–å¤±è´¥') }

      // é—ªå…‰ç¯
      try {
        const flash = await imageSource.getImageProperty(image.PropertyKey.FLASH)
        hilog.info(0x0021, 'EXIF', `[EXIF] FLASH: ${flash}`)
        if (flash && flash !== '') {
          exifData.flash = formatFlash(flash)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] FLASH è·å–å¤±è´¥') }

      // é•œå¤´å“ç‰Œ
      try {
        const lensMake = await imageSource.getImageProperty(image.PropertyKey.LENS_MAKE)
        hilog.info(0x0021, 'EXIF', `[EXIF] LENS_MAKE: ${lensMake}`)
        if (lensMake && lensMake !== '') {
          exifData.lensMake = lensMake
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] LENS_MAKE è·å–å¤±è´¥') }

      // æœ€å¤§å…‰åœˆ
      try {
        const maxAperture = await imageSource.getImageProperty(image.PropertyKey.MAX_APERTURE_VALUE)
        hilog.info(0x0021, 'EXIF', `[EXIF] MAX_APERTURE_VALUE: ${maxAperture}`)
        if (maxAperture && maxAperture !== '') {
          exifData.maxAperture = formatAperture(maxAperture)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] MAX_APERTURE_VALUE è·å–å¤±è´¥') }

      // 35mmç­‰æ•ˆç„¦è·
      try {
        const focalLength35 = await imageSource.getImageProperty(image.PropertyKey.FOCAL_LENGTH_IN_35_MM_FILM)
        hilog.info(0x0021, 'EXIF', `[EXIF] FOCAL_LENGTH_IN_35_MM_FILM: ${focalLength35}`)
        if (focalLength35 && focalLength35 !== '') {
          exifData.focalLengthIn35mm = `${focalLength35}mm`
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] FOCAL_LENGTH_IN_35_MM_FILM è·å–å¤±è´¥') }

      // å›¾åƒå°ºå¯¸
      try {
        const imgInfo = await imageSource.getImageInfo()
        hilog.info(0x0021, 'EXIF', `[EXIF] ImageInfo: ${JSON.stringify(imgInfo)}`)
        if (imgInfo && imgInfo.size) {
          exifData.imageWidth = imgInfo.size.width
          exifData.imageHeight = imgInfo.size.height
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] ImageInfo è·å–å¤±è´¥') }

      // æ–¹å‘
      try {
        const orientation = await imageSource.getImageProperty(image.PropertyKey.ORIENTATION)
        hilog.info(0x0021, 'EXIF', `[EXIF] ORIENTATION: ${orientation}`)
        if (orientation && orientation !== '') {
          exifData.orientation = formatOrientation(orientation)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] ORIENTATION è·å–å¤±è´¥') }

      // è‰²å½©ç©ºé—´
      try {
        const colorSpace = await imageSource.getImageProperty(image.PropertyKey.COLOR_SPACE)
        hilog.info(0x0021, 'EXIF', `[EXIF] COLOR_SPACE: ${colorSpace}`)
        if (colorSpace && colorSpace !== '') {
          exifData.colorSpace = colorSpace === '1' ? 'sRGB' : (colorSpace === '65535' ? 'Uncalibrated' : colorSpace)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] COLOR_SPACE è·å–å¤±è´¥') }

      // å¯¹æ¯”åº¦
      try {
        const contrast = await imageSource.getImageProperty(image.PropertyKey.CONTRAST)
        hilog.info(0x0021, 'EXIF', `[EXIF] CONTRAST: ${contrast}`)
        if (contrast && contrast !== '') {
          exifData.contrast = contrast === '0' ? 'æ ‡å‡†' : (contrast === '1' ? 'ä½' : 'é«˜')
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] CONTRAST è·å–å¤±è´¥') }

      // é¥±å’Œåº¦
      try {
        const saturation = await imageSource.getImageProperty(image.PropertyKey.SATURATION)
        hilog.info(0x0021, 'EXIF', `[EXIF] SATURATION: ${saturation}`)
        if (saturation && saturation !== '') {
          exifData.saturation = saturation === '0' ? 'æ ‡å‡†' : (saturation === '1' ? 'ä½' : 'é«˜')
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SATURATION è·å–å¤±è´¥') }

      // é”åº¦
      try {
        const sharpness = await imageSource.getImageProperty(image.PropertyKey.SHARPNESS)
        hilog.info(0x0021, 'EXIF', `[EXIF] SHARPNESS: ${sharpness}`)
        if (sharpness && sharpness !== '') {
          exifData.sharpness = sharpness === '0' ? 'æ ‡å‡†' : (sharpness === '1' ? 'æŸ”å’Œ' : 'é”åˆ©')
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SHARPNESS è·å–å¤±è´¥') }

      // äº®åº¦
      try {
        const brightness = await imageSource.getImageProperty(image.PropertyKey.BRIGHTNESS_VALUE)
        hilog.info(0x0021, 'EXIF', `[EXIF] BRIGHTNESS_VALUE: ${brightness}`)
        if (brightness && brightness !== '') {
          exifData.brightness = `${parseFloat(brightness).toFixed(2)} EV`
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] BRIGHTNESS_VALUE è·å–å¤±è´¥') }

      // åœºæ™¯ç±»å‹
      try {
        const sceneType = await imageSource.getImageProperty(image.PropertyKey.SCENE_TYPE)
        hilog.info(0x0021, 'EXIF', `[EXIF] SCENE_TYPE: ${sceneType}`)
        if (sceneType && sceneType !== '') {
          exifData.sceneType = sceneType === '1' ? 'ç›´æ¥æ‹æ‘„' : sceneType
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SCENE_TYPE è·å–å¤±è´¥') }

      // è½¯ä»¶
      try {
        const software = await imageSource.getImageProperty(image.PropertyKey.SOFTWARE)
        hilog.info(0x0021, 'EXIF', `[EXIF] SOFTWARE: ${software}`)
        if (software && software !== '') {
          exifData.software = software
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SOFTWARE è·å–å¤±è´¥') }

      // EXIFç‰ˆæœ¬
      try {
        const exifVersion = await imageSource.getImageProperty(image.PropertyKey.EXIF_VERSION)
        hilog.info(0x0021, 'EXIF', `[EXIF] EXIF_VERSION: ${exifVersion}`)
        if (exifVersion && exifVersion !== '') {
          exifData.exifVersion = exifVersion
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] EXIF_VERSION è·å–å¤±è´¥') }

      // === å°è¯•æ›´å¤šåä¸ºå¯èƒ½æ”¯æŒçš„å­—æ®µ ===
      try {
        const artist = await imageSource.getImageProperty(image.PropertyKey.ARTIST)
        hilog.info(0x0021, 'EXIF', `[EXIF] ARTIST: ${artist}`)
        if (artist && artist !== '') exifData.artist = artist
      } catch (e) { /* ignore */ }
      
      try {
        const copyright = await imageSource.getImageProperty(image.PropertyKey.COPYRIGHT)
        hilog.info(0x0021, 'EXIF', `[EXIF] COPYRIGHT: ${copyright}`)
        if (copyright && copyright !== '') exifData.copyright = copyright
      } catch (e) { /* ignore */ }
      
      try {
        const imageDesc = await imageSource.getImageProperty(image.PropertyKey.IMAGE_DESCRIPTION)
        hilog.info(0x0021, 'EXIF', `[EXIF] IMAGE_DESCRIPTION: ${imageDesc}`)
        if (imageDesc && imageDesc !== '') exifData.imageDescription = imageDesc
      } catch (e) { /* ignore */ }

      // === è¡¥å……ç«å“èƒ½è¯»ä½†æœ¬é¡¹ç›®ç¼ºå¤±çš„å­—æ®µï¼ˆ39ä¸ªï¼‰===
      hilog.info(0x0021, 'EXIF', '[EXIF] ===== å¼€å§‹è¡¥å……ç¼ºå¤±å­—æ®µ =====')
      
      // SubSecTimeç³»åˆ—ï¼ˆ3ä¸ªï¼‰- äºšç§’æ—¶é—´ç²¾åº¦
      try {
        const subSecTime = await imageSource.getImageProperty(image.PropertyKey.SUBSEC_TIME)
        hilog.info(0x0021, 'EXIF', `[EXIF] SUBSEC_TIME: ${subSecTime}`)
        if (subSecTime && subSecTime !== '') exifData.subSecTime = subSecTime
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SUBSEC_TIME è·å–å¤±è´¥') }
      
      try {
        const subSecTimeOrig = await imageSource.getImageProperty(image.PropertyKey.SUBSEC_TIME_ORIGINAL)
        hilog.info(0x0021, 'EXIF', `[EXIF] SUBSEC_TIME_ORIGINAL: ${subSecTimeOrig}`)
        if (subSecTimeOrig && subSecTimeOrig !== '') exifData.subSecTimeOriginal = subSecTimeOrig
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SUBSEC_TIME_ORIGINAL è·å–å¤±è´¥') }
      
      try {
        const subSecTimeDigit = await imageSource.getImageProperty(image.PropertyKey.SUBSEC_TIME_DIGITIZED)
        hilog.info(0x0021, 'EXIF', `[EXIF] SUBSEC_TIME_DIGITIZED: ${subSecTimeDigit}`)
        if (subSecTimeDigit && subSecTimeDigit !== '') exifData.subSecTimeDigitized = subSecTimeDigit
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SUBSEC_TIME_DIGITIZED è·å–å¤±è´¥') }
      
      // å›¾åƒæŠ€æœ¯å‚æ•°
      try {
        const digitalZoom = await imageSource.getImageProperty(image.PropertyKey.DIGITAL_ZOOM_RATIO)
        hilog.info(0x0021, 'EXIF', `[EXIF] DIGITAL_ZOOM_RATIO: ${digitalZoom}`)
        if (digitalZoom && digitalZoom !== '') exifData.digitalZoomRatio = digitalZoom
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] DIGITAL_ZOOM_RATIO è·å–å¤±è´¥') }
      
      try {
        const gainControl = await imageSource.getImageProperty(image.PropertyKey.GAIN_CONTROL)
        hilog.info(0x0021, 'EXIF', `[EXIF] GAIN_CONTROL: ${gainControl}`)
        if (gainControl && gainControl !== '') exifData.gainControl = formatGainControl(parseInt(gainControl))
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GAIN_CONTROL è·å–å¤±è´¥') }
      
      try {
        const lightSource = await imageSource.getImageProperty(image.PropertyKey.LIGHT_SOURCE)
        hilog.info(0x0021, 'EXIF', `[EXIF] LIGHT_SOURCE: ${lightSource}`)
        if (lightSource && lightSource !== '') exifData.lightSource = lightSource
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] LIGHT_SOURCE è·å–å¤±è´¥') }
      
      try {
        const sceneCaptureType = await imageSource.getImageProperty(image.PropertyKey.SCENE_CAPTURE_TYPE)
        hilog.info(0x0021, 'EXIF', `[EXIF] SCENE_CAPTURE_TYPE: ${sceneCaptureType}`)
        if (sceneCaptureType && sceneCaptureType !== '') exifData.sceneCaptureType = formatSceneCaptureType(parseInt(sceneCaptureType))
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SCENE_CAPTURE_TYPE è·å–å¤±è´¥') }
      
      try {
        const sensingMethod = await imageSource.getImageProperty(image.PropertyKey.SENSING_METHOD)
        hilog.info(0x0021, 'EXIF', `[EXIF] SENSING_METHOD: ${sensingMethod}`)
        if (sensingMethod && sensingMethod !== '') exifData.sensingMethod = sensingMethod
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SENSING_METHOD è·å–å¤±è´¥') }
      
      try {
        const subjectDistanceRange = await imageSource.getImageProperty(image.PropertyKey.SUBJECT_DISTANCE_RANGE)
        hilog.info(0x0021, 'EXIF', `[EXIF] SUBJECT_DISTANCE_RANGE: ${subjectDistanceRange}`)
        if (subjectDistanceRange && subjectDistanceRange !== '') exifData.subjectDistanceRange = formatSubjectDistRange(parseInt(subjectDistanceRange))
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] SUBJECT_DISTANCE_RANGE è·å–å¤±è´¥') }
      
      try {
        const customRendered = await imageSource.getImageProperty(image.PropertyKey.CUSTOM_RENDERED)
        hilog.info(0x0021, 'EXIF', `[EXIF] CUSTOM_RENDERED: ${customRendered}`)
        if (customRendered && customRendered !== '') exifData.customRendered = parseInt(customRendered) === 0 ? 'æ­£å¸¸' : 'è‡ªå®šä¹‰'
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] CUSTOM_RENDERED è·å–å¤±è´¥') }
      
      // GPSæ‰©å±•å­—æ®µ
      try {
        const gpsAltRef = await imageSource.getImageProperty(image.PropertyKey.GPS_ALTITUDE_REF)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_ALTITUDE_REF: ${gpsAltRef}`)
        if (gpsAltRef && gpsAltRef !== '') exifData.gpsAltitudeRef = gpsAltRef
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_ALTITUDE_REF è·å–å¤±è´¥') }
      
      try {
        const gpsLatRef = await imageSource.getImageProperty(image.PropertyKey.GPS_LATITUDE_REF)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_LATITUDE_REF: ${gpsLatRef}`)
        if (gpsLatRef && gpsLatRef !== '') exifData.gpsLatitudeRef = gpsLatRef
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_LATITUDE_REF è·å–å¤±è´¥') }
      
      try {
        const gpsLonRef = await imageSource.getImageProperty(image.PropertyKey.GPS_LONGITUDE_REF)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_LONGITUDE_REF: ${gpsLonRef}`)
        if (gpsLonRef && gpsLonRef !== '') exifData.gpsLongitudeRef = gpsLonRef
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_LONGITUDE_REF è·å–å¤±è´¥') }
      
      try {
        const gpsTimeStamp = await imageSource.getImageProperty(image.PropertyKey.GPS_TIME_STAMP)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_TIME_STAMP: ${gpsTimeStamp}`)
        if (gpsTimeStamp && gpsTimeStamp !== '') exifData.gpsTimeStamp = gpsTimeStamp
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_TIME_STAMP è·å–å¤±è´¥') }
      
      try {
        const gpsDateStamp = await imageSource.getImageProperty(image.PropertyKey.GPS_DATE_STAMP)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_DATE_STAMP: ${gpsDateStamp}`)
        if (gpsDateStamp && gpsDateStamp !== '') exifData.gpsDateStamp = gpsDateStamp
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_DATE_STAMP è·å–å¤±è´¥') }
      
      try {
        const gpsProcessingMethod = await imageSource.getImageProperty(image.PropertyKey.GPS_PROCESSING_METHOD)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_PROCESSING_METHOD: ${gpsProcessingMethod}`)
        if (gpsProcessingMethod && gpsProcessingMethod !== '') exifData.gpsProcessingMethod = gpsProcessingMethod
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_PROCESSING_METHOD è·å–å¤±è´¥') }
      
      try {
        const gpsSpeed = await imageSource.getImageProperty(image.PropertyKey.GPS_SPEED)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_SPEED: ${gpsSpeed}`)
        if (gpsSpeed && gpsSpeed !== '') exifData.gpsSpeed = `${gpsSpeed} km/h`
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_SPEED è·å–å¤±è´¥') }
      
      try {
        const gpsImgDirection = await imageSource.getImageProperty(image.PropertyKey.GPS_IMG_DIRECTION)
        hilog.info(0x0021, 'EXIF', `[EXIF] GPS_IMG_DIRECTION: ${gpsImgDirection}`)
        if (gpsImgDirection && gpsImgDirection !== '') exifData.gpsImgDirection = `${gpsImgDirection}Â°`
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] GPS_IMG_DIRECTION è·å–å¤±è´¥') }
      
      // å…¶ä»–æ—¶é—´å­—æ®µ
      try {
        const dateTimeDigitized = await imageSource.getImageProperty(image.PropertyKey.DATE_TIME_DIGITIZED)
        hilog.info(0x0021, 'EXIF', `[EXIF] DATE_TIME_DIGITIZED: ${dateTimeDigitized}`)
        if (dateTimeDigitized && dateTimeDigitized !== '') exifData.dateTimeDigitized = formatDateTime(dateTimeDigitized)
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] DATE_TIME_DIGITIZED è·å–å¤±è´¥') }
      
      // åˆ†è¾¨ç‡ç›¸å…³
      try {
        const xResolution = await imageSource.getImageProperty(image.PropertyKey.X_RESOLUTION)
        hilog.info(0x0021, 'EXIF', `[EXIF] X_RESOLUTION: ${xResolution}`)
        if (xResolution && xResolution !== '') exifData.xResolution = parseFloat(xResolution)
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] X_RESOLUTION è·å–å¤±è´¥') }
      
      try {
        const yResolution = await imageSource.getImageProperty(image.PropertyKey.Y_RESOLUTION)
        hilog.info(0x0021, 'EXIF', `[EXIF] Y_RESOLUTION: ${yResolution}`)
        if (yResolution && yResolution !== '') exifData.yResolution = parseFloat(yResolution)
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] Y_RESOLUTION è·å–å¤±è´¥') }
      
      try {
        const resolutionUnit = await imageSource.getImageProperty(image.PropertyKey.RESOLUTION_UNIT)
        hilog.info(0x0021, 'EXIF', `[EXIF] RESOLUTION_UNIT: ${resolutionUnit}`)
        if (resolutionUnit && resolutionUnit !== '') {
          exifData.resolutionUnit = resolutionUnit === '2' ? 'è‹±å¯¸' : (resolutionUnit === '3' ? 'å˜ç±³' : resolutionUnit)
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] RESOLUTION_UNIT è·å–å¤±è´¥') }
      
      // å›¾åƒé•¿åº¦
      try {
        const imageLength = await imageSource.getImageProperty(image.PropertyKey.IMAGE_LENGTH)
        hilog.info(0x0021, 'EXIF', `[EXIF] IMAGE_LENGTH: ${imageLength}`)
        if (imageLength && imageLength !== '') {
          const length = parseInt(imageLength)
          if (!exifData.imageHeight || exifData.imageHeight === 0) {
            exifData.imageHeight = length
            exifData.imageLength = length
          }
        }
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] IMAGE_LENGTH è·å–å¤±è´¥') }
      
      // FlashPixç‰ˆæœ¬
      try {
        const flashpixVersion = await imageSource.getImageProperty(image.PropertyKey.FLASHPIX_VERSION)
        hilog.info(0x0021, 'EXIF', `[EXIF] FLASHPIX_VERSION: ${flashpixVersion}`)
        if (flashpixVersion && flashpixVersion !== '') exifData.flashpixVersion = flashpixVersion
      } catch (e) { hilog.warn(0x0021, 'EXIF', '[EXIF] FLASHPIX_VERSION è·å–å¤±è´¥') }

      hilog.info(0x0021, 'EXIF', '[EXIF] ===== è¡¥å……å­—æ®µæå–å®Œæˆ =====')
      hilog.info(0x0021, 'EXIF', '[EXIF] ===== æ‰©å±•å­—æ®µæå–å®Œæˆ =====')

    } catch (error) {
      hilog.error(0x0021, 'EXIF', 'æå–EXIFå­—æ®µå¤±è´¥:' + error)
    }

    hilog.info(0x0021, 'EXIF', `[EXIF] æœ€ç»ˆè§£æç»“æœ:` + JSON.stringify(exifData))
    return exifData
  }
}
