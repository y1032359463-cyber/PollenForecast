# 📚 知识库（主索引）

> **用途**: 已验证的解决方案和技术要点
> **适用范围**: HarmonyOS NEXT API 20 开发通用知识 + Flutter 跨平台开发
> **最后更新**: 2026-01-17（Flutter iOS/Android 跨平台项目创建）  
> **重组说明**: 已按技术栈分类到 `.claude/知识库/` 子文件夹

---

## 🚨 紧急救援（快速定位）

**遇到这些错误？快速跳转：**
- 🔴 `Module has no exported member` → [ArkTS语法](./知识库/ArkTS语法.md#arkts-模块类型导出规则)
- 🔴 `@State not updating UI` → [ArkTS语法](./知识库/ArkTS语法.md#builder-响应式更新)
- 🔴 `arkts-no-types-in-catch` → [ArkTS语法](./知识库/ArkTS语法.md#arkts-catch-子句类型注解规则)
- 🔴 `arkts-no-obj-literals-as-types` → [ArkTS语法](./知识库/ArkTS语法.md#arkts-对象字面量类型禁止规则) ✨ 新增
- 🔴 `arkts-no-untyped-obj-literals` → [ArkTS语法](./知识库/ArkTS语法.md#arkts-对象字面量类型禁止规则) ✨ 新增
- 🔴 `AppStorage is not exported` → [ArkTS语法](./知识库/ArkTS语法.md#4-appstorage-全局对象api-20)
- 🔴 `onBackPress does not meet UI component syntax` → [ArkTS语法](./知识库/ArkTS语法.md#5-页面返回手势处理onbackpress)
- 🔴 `No such file or directory`（媒体库URI） → [UI组件](./知识库/UI组件.md#媒体库uri与fileio-api使用规则)
- 🔴 `WRITE_IMAGEVIDEO permission denied` → [分享导出](./知识库/分享导出.md#write_imagevideo-受限权限说明)
- 🔴 **SaveButton API not found** → [避坑指南](./知识库/避坑指南.md#-savebutton-保存到相册api-20-避坑)
- 🔴 **Refresh indicator can't hide** → [避坑指南](./知识库/避坑指南.md#harmonyos-api-20-refresh-组件刷新指示器隐藏限制)
- 🔴 `reminderAgentManager not found` → [定时提醒](./知识库/定时提醒.md#代理提醒reminderagent实现方案) ✨ 新增
- 🔴 `cancelAllReminders is system-api` → [定时提醒](./知识库/定时提醒.md#常见错误与解决方案) ✨ 新增
- 🔴 `install failed due to older sdk version` → [API兼容性](./知识库/API兼容性.md#api-17-设备安装问题) ✨ 新增
- 🔴 `Sync failed: ohpm开发态配置版本未填写` → [避坑指南](./知识库/避坑指南.md#项目备份配置问题) ✨ 新增
- 🔴 `Invalid exports, no system plugins were found` → [避坑指南](./知识库/避坑指南.md#项目备份配置问题) ✨ 新增
- 🔴 **build-profile.json5 被简化** → [避坑指南](./知识库/避坑指南.md#构建配置文件被自动简化问题) ✨ 新增
- 🔴 **API服务器故障** → [第三方API集成](./知识库/第三方API集成.md#api-服务器冗余和降级策略)
- 🔴 **Crontab 任务不执行** → [避坑指南](./知识库/避坑指南.md#crontab-定时任务-nodejs-路径问题) ✨ 新增
- 🔴 **Node.js .env 变量为空** → [避坑指南](./知识库/避坑指南.md#nodejs-生产环境-env-加载失效) ✨ 新增
- 🔴 **Minshu API 404/502** → [第三方API集成](./知识库/第三方API集成.md#2-请求格式最佳实践) ✨ 新增
- 🔴 **JSON中文乱码** → [ArkTS语法](./知识库/ArkTS语法.md#json-utf-8-编码解码textdecoder)
- 🔴 **直辖市数据结构特殊处理** → [ArkTS语法](./知识库/ArkTS语法.md#直辖市json数据结构特殊处理) ✨ 新增
- 🔴 **List组件点击事件不触发** → [ArkTS语法](./知识库/ArkTS语法.md#list组件点击事件绑定规范) ✨ 新增
- 🔴 **Flutter 命令不被识别** → [跨平台开发](#flutter-windows-环境配置) ✨ 新增
- 🔴 **iOS 构建需要 Mac** → [跨平台开发](#flutter-ios-构建方案) ✨ 新增

---

## 📚 知识库分类导航

### 1. [ArkTS语法.md](./知识库/ArkTS语法.md)
**核心内容**：模块类型导出、@Builder响应式、ForEach Key、catch类型注解、对象字面量类型禁止、Base64编码、List组件事件绑定、城市名格式匹配

**适用场景**：
- 编译器类型错误
- UI 不响应状态更新
- 列表刷新问题
- List点击事件不生效
- 城市名/字符串匹配失败

### 2. [分享导出.md](./知识库/分享导出.md)
**核心内容**：ShareKit无权限分享、EXIF移除/导出、权限适配、参数筛选

**适用场景**：
- 分享图片到其他应用
- 保存图片到相册
- 导出EXIF数据
- 照片列表筛选

### 3. [避坑指南.md](./知识库/避坑指南.md)
**核心内容**：SaveButton失败案例、Refresh指示器限制、缓存问题、备份配置问题

**适用场景**：
- AI给出的方案无法编译
- 修改代码后仍报旧错误
- 系统组件行为不符合预期
- 项目备份后无法构建

### 4. [定时提醒.md](./知识库/定时提醒.md) ✨ 新增
**核心内容**：代理提醒（ReminderAgent）实现、权限申请、常见错误

**适用场景**：
- 后台定时发送通知
- 应用关闭后仍能触发提醒
- 每日/每周重复提醒

### 5. [UI组件.md](./知识库/UI组件.md) ✨ 新增
**核心内容**：状态栏/导航栏配置、媒体库URI访问规则、三级菜单异步加载修复、城市分组折叠

**适用场景**：
- 透明状态栏适配
- 深浅色模式切换
- 媒体库文件访问
- 异步数据加载时机问题
- 城市/省份分组折叠列表

### 6. [API兼容性.md](./知识库/API兼容性.md) ✨ 新增
**核心内容**：API版本差异、降级方案、版本检测工具

**适用场景**：
- API 17 降级适配
- 条件功能启用
- 版本兼容性处理

### 7. [第三方API集成.md](./知识库/第三方API集成.md)
**核心内容**：Minshu API 使用经验、请求格式、缓存策略、Node.js 代理服务端最佳实践、API服务器冗余和降级策略

**适用场景**：
- 集成第三方 API
- API Key 授权管理
- 代理服务器实现
- 多数据源降级策略
- 服务器冗余架构
- 高可用性设计

### 8. Flutter 跨平台开发 ✨ 新增
**核心内容**：Windows 环境开发、iOS 构建方案、API 复用、项目结构

**适用场景**：
- 无 Mac 环境下开发 iOS 应用
- 跨平台项目（iOS + Android）
- 复用现有服务器 API
- CI/CD 自动化构建

**关键要点**：
- **Flutter Windows 环境配置**
  - Flutter SDK 解压到 `C:\flutter\`
  - 添加到系统 PATH：`C:\flutter\bin`
  - 验证：`flutter doctor`
  - PowerShell 不支持 `&&`，需分步执行命令

- **Flutter iOS 构建方案**
  - 问题：iOS 构建必须在 macOS 环境
  - 解决方案：Codemagic CI/CD（免费额度 500 分钟/月）
  - 流程：Windows 开发 → GitHub 推送 → Codemagic 自动构建 → TestFlight/App Store
  - 无需拥有 Mac 硬件

- **项目结构复用**
  - API 配置：直接复用鸿蒙项目的服务器端点
  - 数据模型：参考 ArkTS 模型转换为 Dart 类
  - 业务逻辑：多服务器故障转移、数据适配器模式
  - 项目结构：models、services、screens、widgets、utils

- **技术栈**
  - Flutter 3.38.7 + Dart 3.10.7
  - 状态管理：Provider
  - 网络请求：Dio
  - 定位服务：Geolocator
  - 本地存储：SharedPreferences

- **开发流程**
  1. Windows 环境安装 Flutter SDK
  2. Cursor IDE 安装 Flutter/Dart 扩展
  3. 创建项目：`flutter create project_name --org com.eric`
  4. Web 版快速测试：`flutter run -d chrome`
  5. Android 版本地调试（需 Android Studio）
  6. iOS 版通过 Codemagic 构建

**项目位置**: `C:\HarmonyOS_App_Plans\pollen_forecast_flutter\`

### 9. 完整版知识库
**文件**: [知识库_完整版_20251226.md](./知识库_完整版_20251226.md)

**包含**：
- UI组件（安全区域、Tabs、动画、对话框、震动、主题切换、Refresh、CustomDialog等）
- Native集成（C++模块配置、IFD遍历、Image Kit错误码）
- EXIF处理（字段提取、渐进式加载、4层架构、SubIFD递归、DNG TAG）
- 数据存储（KVDB集成、ListItem滑动删除）
- 图片处理（缩略图生成、全屏预览、file://协议）
- 性能优化（P2架构模式、刷新机制、P1优先级）
- Map Kit、FilePicker、握姿检测等

---

## 🎯 使用指南

### 快速查找

**场景1：编译错误**
1. 复制错误信息关键词（如 `no exported member`）
2. 在[紧急救援](#紧急救援快速定位)中查找
3. 或在 [知识库_完整版](./知识库_完整版_20251226.md) 中全文搜索

**场景2：功能实现**
1. 确定技术栈（分享/EXIF/UI等）
2. 打开对应分类文件
3. 查看目录定位具体章节

**场景3：避坑查询**
1. 优先查看 [避坑指南](./知识库/避坑指南.md)
2. 查看是否有已验证失败的方案
3. 使用推荐的替代方案

### 文件结构

```
.claude/
├── 知识库.md（本文件 - 主索引）
├── 知识库_完整版_20251226.md（5353行完整版备份）
├── 知识库/
│   ├── README.md（分类说明）
│   ├── ArkTS语法.md（~300行）
│   ├── 分享导出.md（~400行）
│   ├── 避坑指南.md（~250行）
│   ├── 定时提醒.md（~200行）
│   ├── UI组件.md（~300行）
│   ├── API兼容性.md（~200行）
│   ├── 第三方API集成.md（~400行）
│   └── Flutter跨平台开发.md（待创建）✨ 新增
├── 知识库_中转站（待验证实践效果）.md
└── 当前问题.md
```

---

## 🔧 维护规则

1. **新增知识点**：
   - P0核心知识 → 追加到对应分类文件
   - P1扩展知识 → 追加到完整版
   - 待验证方案 → 先写入 `知识库_中转站.md`

2. **更新频率**：
   - 分类文件：每周整理一次
   - 完整版：仅追加，不删除

3. **版本管理**：
   - 重大重组时保留旧版（如 `知识库_完整版_YYYYMMDD.md`）
   - 分类文件在头部标注"最后更新"时间

---

## 📋 快速参考卡片

### 常用 Kit 导入

```typescript
// UI相关
import { promptAction } from '@kit.ArkUI'

// 文件操作
import { fileIo, fileUri } from '@kit.CoreFileKit'

// 图片处理
import { image } from '@kit.ImageKit'
import { photoAccessHelper } from '@kit.MediaLibraryKit'

// 分享
import { systemShare, uniformTypeDescriptor as utd } from '@kit.ShareKit'

// 通知相关
import { notificationManager } from '@kit.NotificationKit'

// ⚠️ 代理提醒（定时通知）- 注意导入位置！
import { reminderAgentManager } from '@kit.BackgroundTasksKit'  // ✅ 正确
// import { reminderAgentManager } from '@kit.NotificationKit'  // ❌ 错误！

// 工具
import { util } from '@kit.ArkTS'
import { hilog } from '@kit.PerformanceAnalysisKit'
```

### 权限级别

| 权限名 | 级别 | 可用性 |
|--------|------|--------|
| `READ_IMAGEVIDEO` | normal | ✅ 可申请 |
| `WRITE_IMAGEVIDEO` | system_basic | ❌ 普通应用不可用 |
| `LOCATION` | normal | ✅ 可申请（需用户授权） |

### 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| `arkts-no-types-in-catch` | catch 子句禁止类型注解 | 移除 `: Error` |
| `arkts-no-obj-literals-as-types` | 对象字面量不能作为类型声明 | 定义接口替代 |
| `arkts-no-untyped-obj-literals` | 对象字面量必须对应显式接口 | 显式创建对象 |
| `arkts-no-any-unknown` | 禁止使用 any/unknown | 添加明确类型 |
| `Module has no exported member` | 类型未导出 | `.d.ts` 中添加 `export` |

---

**详细内容**：见 [UI组件.md](./知识库/UI组件.md)

---

## 📖 扩展阅读

### 官方文档
- **API参考**: https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/
- **开发指南**: https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/
- **EXIF规范**: https://www.exif.org/Exif2-3.PDF

### 工具推荐
- **exiftool**: 命令行EXIF分析工具
- **HiLog Viewer**: DevEco Studio 内置日志查看器
- **hdc**: HarmonyOS Device Connector（类似adb）

---

## 🆕 最近更新

> **最后更新**: 2026-01-17（Flutter 跨平台开发方案）

### 新增分类文件
- ✅ [第三方API集成.md](./知识库/第三方API集成.md) - Minshu API 使用经验（2026-01-09 新增）✨
- ✅ [定时提醒.md](./知识库/定时提醒.md) - 代理提醒实现方案
- ✅ [UI组件.md](./知识库/UI组件.md) - 状态栏/导航栏配置、媒体库URI访问、无障碍设计
- ✅ [API兼容性.md](./知识库/API兼容性.md) - API版本差异与降级方案

### 知识库更新（2026-01-17）
- ✅ **跨平台开发方案** - Flutter iOS/Android 跨平台项目创建 ✨
  - Windows 环境下开发 Flutter（无需 Mac）
  - Codemagic CI/CD 免费构建 iOS 版本
  - 复用现有服务器 API（花粉数据、天气数据）
  - 项目结构：models、services、screens、widgets、utils
  - 技术栈：Flutter 3.38.7 + Dart 3.10.7 + Provider + Dio + Geolocator
  - **项目位置**: `C:\HarmonyOS_App_Plans\pollen_forecast_flutter\`
  - **关键经验**：
    - Flutter SDK 安装后需添加到系统 PATH（`C:\flutter\bin`）
    - PowerShell 不支持 `&&` 语法，需分步执行命令
    - `flutter doctor` 验证环境配置
    - Web 版可用于快速测试（`flutter run -d chrome`）
    - iOS 构建必须 macOS 环境，但可通过 Codemagic 免费 CI/CD 解决

### 知识库更新（2026-01-16）
- ✅ **UI组件.md** - 修正 Map Kit API 名称与类型适配
  - 属性名由 `nightMode` 变更为 `dayNightMode`
  - 类型由 `boolean` 变更为 `mapCommon.DayNightMode` 枚举
- ✅ **UI组件.md** - 新增无障碍对比度合规方案 (`levelToTextColor`)
  - 针对浅色模式自动加深状态颜色，确保文字对比度 ≥ 4.5:1
- ✅ **避坑指南.md** - 新增 Map Kit 类型陷阱与 @Builder 结构损坏避坑点

### 知识库更新（2026-01-15）
- ✅ **UI组件.md** - 新增 Map Kit 深色模式适配方案
  - 接入 Map Kit 内置 `nightMode` API
  - 实现监听系统主题变化动态切换 `setNightMode`
  - 移除冗余的 JSON 自定义样式文件逻辑
- ✅ **第三方API集成.md** - 新增和风天气花粉数据集成方案
  - 确认 Indices API 提供花粉指数
  - 规划服务器端 26 天历史数据保留策略
  - 制定 P0-P2 可视化优化演进路线图
- ✅ **第三方API集成.md** - 更新敏舒 API 集成细节
  - 修复路径参数格式：`/day/pollen/{date}/{adcode}`
  - 新增 Node.js 代理服务端最佳实践（零依赖 .env 加载、SQLite 持久化、7天保留策略）
- ✅ **避坑指南.md** - 增加服务端避坑点
  - Crontab 定时任务必须使用 Node.js 绝对路径
  - Node.js 原生不读取 .env 文件的问题说明

### 知识库更新（2026-01-14）
- ✅ **ArkTS语法.md** - 新增List组件点击事件绑定规范
  - ListItem组件拦截子组件事件问题
  - onClick正确绑定位置
  - Set vs 数组状态管理对比
  - 三专家共识方案

### 知识库更新（2026-01-10）
- ✅ **ArkTS语法.md** - 更新AppStorage使用规范
  - AppStorage 导入方式变更（`@kit.ArkUI`）
  - 方法名变化（`SetOrCreate`、`Get`）
  - 泛型使用要求

### 知识库更新（2026-01-09）
- ✅ **UI组件.md** - 添加无障碍设计对比度要求章节
  - AppGallery 对比度要求（≥ 4.1:1）
  - 深浅色模式动态颜色选择
  - Text 组件宽度限制替代方案
- ✅ **第三方API集成.md** - 新增分类文件
  - Minshu 花粉 API 使用经验
  - API Key 授权范围机制
  - 请求格式最佳实践（502错误处理）
  - 城市编码（adcode）使用
  - 缓存策略（15分钟）

### 知识库更新（2026-01-08）
- ✅ **API 17 设备安装问题** - 添加设备镜像版本更新方案
  - 错误：`install failed due to older sdk version in the device`
  - 正确方案：保持 targetSdkVersion 为 6.0.0(20)，更新设备镜像版本
  - 避免错误：不应降级SDK版本
  - 查询命令：`hdc shell param get const.ohos.apiversion`

### 待验证方案
- 🔄 **原子服务卡片API修复**（四专家共识，FormAbility未被调用）→ 见 `知识库_中转站.md`
- 🔄 **技术债务清理**（TaskPool并发控制、Native异常处理）→ 见 `知识库_中转站.md`
- 🔄 **MapKit 事件监听替代方案**（CodeGenie vs 华为智能助手方案有争议）→ 见 `知识库_中转站.md`

---

**详细内容**：见 [API兼容性.md](./知识库/API兼容性.md)

---

### 避坑更新
- ⚠️ **fileIo.statSync(uri) 对媒体库URI无效**（必须用fd）→ [UI组件](./知识库/UI组件.md#媒体库uri与fileio-api使用规则)
- ⚠️ **statusBarContentColor 不能移除**（移除后字体变灰）→ [UI组件](./知识库/UI组件.md#状态栏导航栏配置api-20)
- ⚠️ Sheet 中直接调用 ShareController 导致全局分享失效 → [分享导出](./知识库/分享导出.md)
- ⚠️ SaveButton API 不存在 → [避坑指南](./知识库/避坑指南.md)
- ⚠️ Refresh 指示器无法隐藏（系统限制）→ [避坑指南](./知识库/避坑指南.md)

---

**详细内容**：见项目文档（PollenForecast/.claude/CLAUDE.md）

---

**详细内容**：见 [定时提醒.md](./知识库/定时提醒.md)

---

**📌 提示**：本索引已精简为快速导航，详细内容请查看分类文件或完整版。
