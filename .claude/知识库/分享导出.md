# åˆ†äº«ã€å¯¼å‡ºä¸æƒé™å¤„ç†

> **åˆ†ç±»**: ShareKitã€EXIF å¯¼å‡ºã€æƒé™é€‚é…ï¼ˆAPI 20ï¼‰  
> **æœ€åæ›´æ–°**: 2025-12-30  
> **è¿”å›**: [â† ä¸»çŸ¥è¯†åº“](../çŸ¥è¯†åº“.md)

---

## ğŸ“‘ æœ¬åˆ†ç±»åŒ…å«

1. [ShareKit æ— æƒé™å›¾ç‰‡åˆ†äº«](#sharekit-æ— æƒé™å›¾ç‰‡åˆ†äº«api-20)
2. [ç§»é™¤ EXIF ä¿¡æ¯æ–¹æ¡ˆ](#ç§»é™¤-exif-ä¿¡æ¯æ–¹æ¡ˆapi-20)
3. [fileUri.getUriFromPath æ­£ç¡® URI æ ¼å¼](#fileurigeturifrompath-æ­£ç¡®-uri-æ ¼å¼api-20)
4. [WRITE_IMAGEVIDEO å—é™æƒé™è¯´æ˜](#write_imagevideo-å—é™æƒé™è¯´æ˜)
5. [å¯¼å‡º EXIF æ•°æ®æ–¹æ¡ˆ](#å¯¼å‡º-exif-æ•°æ®æ–¹æ¡ˆapi-20)
6. [å‚æ•°åˆ—è¡¨ç­›é€‰æ–¹æ¡ˆ](#å‚æ•°åˆ—è¡¨ç­›é€‰æ–¹æ¡ˆapi-20)
7. [åª’ä½“åº“URIè®¿é—®](#åª’ä½“åº“uriè®¿é—®api-20)

---

## ShareKit æ— æƒé™å›¾ç‰‡åˆ†äº«ï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **åœºæ™¯**: åˆ†äº«æ²™ç®±å›¾ç‰‡æ— éœ€ `WRITE_IMAGEVIDEO` æƒé™

### æ ¸å¿ƒæ–¹æ¡ˆ

ä½¿ç”¨ `@kit.ShareKit` çš„ `systemShare` APIï¼Œæ”¯æŒç›´æ¥åˆ†äº«æ²™ç®±æ–‡ä»¶ã€‚

### å®Œæ•´ä»£ç ç¤ºä¾‹

**å¯¼å…¥æ¨¡å—**ï¼š
```typescript
import { systemShare, uniformTypeDescriptor as utd } from '@kit.ShareKit'
import { fileUri } from '@kit.CoreFileKit'
import { fileIo } from '@kit.CoreFileKit'
```

**åˆ†äº«å›¾ç‰‡ï¼ˆä¿ç•™/ç§»é™¤ EXIF å¯é€‰ï¼‰**ï¼š
```typescript
async shareImage(imagePath: string, removeExif: boolean = false): Promise<boolean> {
  try {
    let finalPath = imagePath

    // å¦‚éœ€ç§»é™¤ EXIFï¼Œå…ˆå¤„ç†å›¾ç‰‡
    if (removeExif) {
      const cleanedBuffer = await exifCleanerService.removeExifToBuffer(imagePath)
      if (!cleanedBuffer) return false

      // å†™å…¥ä¸´æ—¶æ–‡ä»¶
      const tempPath = `${this.context.cacheDir}/share_temp.jpg`
      const tempFile = fileIo.openSync(tempPath, fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY)
      fileIo.writeSync(tempFile.fd, cleanedBuffer)
      fileIo.closeSync(tempFile)
      finalPath = tempPath
    }

    // æ„é€ åˆ†äº«æ•°æ®
    const shareUri = fileUri.getUriFromPath(finalPath)
    const shareData = new systemShare.SharedData({
      utd: utd.UniformDataType.JPEG,
      uri: shareUri,
      description: 'EXIFå…‰å½±å¤‡å¿˜å½• - ç…§ç‰‡åˆ†äº«'
    })

    // æ˜¾ç¤ºåˆ†äº«é¢æ¿
    const controller = new systemShare.ShareController(shareData)
    await controller.show(this.context, {
      previewMode: systemShare.SharePreviewMode.DETAIL
    })

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if (removeExif && fileIo.accessSync(finalPath)) {
      fileIo.unlinkSync(finalPath)
    }

    return true
  } catch (error) {
    console.error(`åˆ†äº«å¤±è´¥: ${error}`)
    return false
  }
}
```

### API å…³é”®ç‚¹

| å‚æ•° | è¯´æ˜ | ç±»å‹ |
|------|------|------|
| `utd` | æ•°æ®ç±»å‹ï¼ˆJPEG/PNG/TEXTç­‰ï¼‰ | `uniformTypeDescriptor.UniformDataType` |
| `uri` | æ–‡ä»¶ URIï¼ˆå¿…é¡»ç”¨ `fileUri.getUriFromPath()` è½¬æ¢ï¼‰ | `string` |
| `description` | åˆ†äº«æè¿°æ–‡æœ¬ | `string` |
| `previewMode` | é¢„è§ˆæ¨¡å¼ï¼ˆDETAIL/AUTOï¼‰ | `systemShare.SharePreviewMode` |

### æ³¨æ„äº‹é¡¹

1. âœ… **æ²™ç®±æ–‡ä»¶å¯ç›´æ¥åˆ†äº«**ï¼šä¸éœ€è¦ `WRITE_IMAGEVIDEO` æƒé™
2. âœ… **URI æ ¼å¼å¿…é¡»æ­£ç¡®**ï¼šä½¿ç”¨ `fileUri.getUriFromPath()` è€Œéæ‰‹åŠ¨æ‹¼æ¥
3. âš ï¸ **ä¸´æ—¶æ–‡ä»¶éœ€æ¸…ç†**ï¼šåˆ†äº«ååˆ é™¤ä¸´æ—¶ç”Ÿæˆçš„æ–‡ä»¶

---

## ç§»é™¤ EXIF ä¿¡æ¯æ–¹æ¡ˆï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **åœºæ™¯**: åˆ†äº«å‰ç§»é™¤æ•æ„Ÿåœ°ç†ä½ç½®ç­‰éšç§ä¿¡æ¯

### æ ¸å¿ƒåŸç†

é€šè¿‡ `ImagePacker` é‡æ–°ç¼–ç å›¾ç‰‡ï¼Œè‡ªåŠ¨å‰”é™¤ EXIF æ•°æ®ã€‚

### å®ç°ä»£ç 

```typescript
import { image } from '@kit.ImageKit'
import { fileIo } from '@kit.CoreFileKit'

async function removeExifToBuffer(
  sourcePath: string,
  quality: number = 95
): Promise<ArrayBuffer | null> {
  let srcFile: fileIo.File | null = null
  let imageSource: image.ImageSource | null = null
  let pixelMap: image.PixelMap | null = null
  let packer: image.ImagePacker | null = null

  try {
    // 1. è¯»å–åŸå›¾
    srcFile = fileIo.openSync(sourcePath, fileIo.OpenMode.READ_ONLY)
    imageSource = image.createImageSource(srcFile.fd)

    // 2. è§£ç ä¸º PixelMap
    pixelMap = await imageSource.createPixelMap({})

    // 3. é‡æ–°ç¼–ç ï¼ˆè‡ªåŠ¨ç§»é™¤ EXIFï¼‰
    packer = image.createImagePacker()
    const arrayBuffer = await packer.packing(pixelMap, {
      format: 'image/jpeg',
      quality: quality
    })

    return arrayBuffer

  } catch (error) {
    console.error(`ç§»é™¤EXIFå¤±è´¥: ${error}`)
    return null
  } finally {
    // 4. é‡Šæ”¾èµ„æºï¼ˆå…³é”®ï¼é¿å… FD æ³„æ¼ï¼‰
    if (packer) packer.release()
    if (pixelMap) pixelMap.release()
    if (imageSource) imageSource.release()
    if (srcFile) fileIo.closeSync(srcFile)
  }
}
```

### å…³é”®è¦ç‚¹

| æ­¥éª¤ | è¯´æ˜ | æ³¨æ„äº‹é¡¹ |
|------|------|---------|
| è§£ç  | `createPixelMap()` | ä¸ä¼ å‚åˆ™ä½¿ç”¨åŸå›¾å°ºå¯¸ |
| ç¼–ç  | `packer.packing()` | **è‡ªåŠ¨ç§»é™¤ EXIF** |
| è´¨é‡ | `quality: 95` | èŒƒå›´ 1-100ï¼Œå»ºè®® 90-95 |
| èµ„æºé‡Šæ”¾ | `finally` å— | **å¿…é¡»é‡Šæ”¾**ï¼Œå¦åˆ™ FD æ³„æ¼ |

---

## fileUri.getUriFromPath æ­£ç¡® URI æ ¼å¼ï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **é—®é¢˜**: æ‰‹åŠ¨æ‹¼æ¥ `file://` è·¯å¾„å¯¼è‡´åˆ†äº«/ä¿å­˜å¤±è´¥

### é”™è¯¯ç¤ºä¾‹

```typescript
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨æ‹¼æ¥
const uri = `file://${sandboxPath}`

// âŒ é”™è¯¯ï¼šè·¯å¾„åˆ†éš”ç¬¦æ··ç”¨
const uri = 'file://C:\\Users\\...'
```

### æ­£ç¡®ç”¨æ³•

```typescript
import { fileUri } from '@kit.CoreFileKit'

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ fileUri.getUriFromPath()
const sandboxPath = '/data/storage/el2/base/haps/entry/cache/temp.jpg'
const correctUri = fileUri.getUriFromPath(sandboxPath)
// è¾“å‡º: file:///data/storage/el2/base/haps/entry/cache/temp.jpg
```

### API è¯´æ˜

**å‡½æ•°ç­¾å**ï¼š
```typescript
fileUri.getUriFromPath(path: string): string
```

**å‚æ•°**ï¼š
- `path`: æ²™ç®±ç»å¯¹è·¯å¾„ï¼ˆå¦‚ `context.filesDir + '/photo.jpg'`ï¼‰

**è¿”å›å€¼**ï¼š
- ç¬¦åˆç³»ç»Ÿè§„èŒƒçš„ `file://` URI

### é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æ˜¯å¦éœ€è¦ | è¯´æ˜ |
|------|---------|------|
| ShareKit åˆ†äº« | âœ… å¿…é¡» | `SharedData.uri` å‚æ•° |
| photoAccessHelper ä¿å­˜ | âœ… å¿…é¡» | `showAssetsCreationDialog()` çš„ `srcFileUri` |
| Image ç»„ä»¶æ˜¾ç¤º | âš ï¸ å¯é€‰ | ç›´æ¥ç”¨ `file://` æˆ– `getUriFromPath()` å‡å¯ |

---

## WRITE_IMAGEVIDEO å—é™æƒé™è¯´æ˜

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **åœºæ™¯**: ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†ŒæŠ¥æƒé™é”™è¯¯

### æƒé™çº§åˆ«

| æƒé™å | çº§åˆ« | å¯ç”¨æ€§ |
|--------|------|--------|
| `ohos.permission.WRITE_IMAGEVIDEO` | **system_basic** | âŒ æ™®é€šåº”ç”¨ä¸å¯ç”¨ |
| `ohos.permission.READ_IMAGEVIDEO` | normal | âœ… å¯ç”³è¯· |

### é”™è¯¯ç¤ºä¾‹

```json
// module.json5
{
  "requestPermissions": [
    {
      "name": "ohos.permission.WRITE_IMAGEVIDEO"  // âŒ ç”³è¯·åæ— æ•ˆ
    }
  ]
}
```

**æŠ¥é”™ä¿¡æ¯**ï¼š
```
Permission denied: WRITE_IMAGEVIDEO is a system_basic permission
```

### æ›¿ä»£æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šphotoAccessHelper.showAssetsCreationDialog**ï¼ˆæ¨èï¼‰

```typescript
import { photoAccessHelper } from '@kit.MediaLibraryKit'
import { fileUri } from '@kit.CoreFileKit'

async function saveToGallery(imagePath: string): Promise<boolean> {
  try {
    const helper = photoAccessHelper.getPhotoAccessHelper(this.context)
    const fileName = 'EXIF_' + Date.now() + '.jpg'
    const srcUri = fileUri.getUriFromPath(imagePath)

    // ç”¨æˆ·äº¤äº’æˆæƒ
    const result = await helper.showAssetsCreationDialog([fileName], {
      title: 'ä¿å­˜å›¾ç‰‡',
      srcFileUris: [srcUri]
    })

    if (result && result.destUris.length > 0) {
      // å†™å…¥æ•°æ®åˆ°ç›®æ ‡ URI
      const destFile = fileIo.openSync(result.destUris[0], fileIo.OpenMode.READ_WRITE)
      const srcFile = fileIo.openSync(imagePath, fileIo.OpenMode.READ_ONLY)
      const buffer = new ArrayBuffer(srcFile.stat().size)
      fileIo.readSync(srcFile.fd, buffer)
      fileIo.writeSync(destFile.fd, buffer)
      fileIo.closeSync(srcFile)
      fileIo.closeSync(destFile)
      return true
    }
    return false
  } catch (error) {
    console.error(`ä¿å­˜å¤±è´¥: ${error}`)
    return false
  }
}
```

**æ–¹æ¡ˆ 2ï¼šSaveButton**ï¼ˆå·²éªŒè¯å¤±è´¥ï¼Œè§ [é¿å‘æŒ‡å—](./é¿å‘æŒ‡å—.md#savebutton-api-20)ï¼‰

---

## å¯¼å‡º EXIF æ•°æ®æ–¹æ¡ˆï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **åœºæ™¯**: å¯¼å‡º EXIF ä¸º JSON/TXT/CSV æ–‡ä»¶

### åŠŸèƒ½ç‰¹æ€§

- âœ… æ”¯æŒ 3 ç§æ ¼å¼ï¼šJSONï¼ˆç»“æ„åŒ–ï¼‰ã€TXTï¼ˆå¯è¯»ï¼‰ã€CSVï¼ˆExcelï¼‰
- âœ… æ–‡ä»¶åå®‰å…¨å¤„ç†ï¼ˆè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ + æ—¶é—´æˆ³ï¼‰
- âœ… å¯¼å‡ºåå¯ç›´æ¥åˆ†äº«ï¼ˆé›†æˆ ShareKitï¼‰

### æ ¸å¿ƒä»£ç 

```typescript
async function exportExifData(
  exifData: ExifData,
  photoName: string,
  format: 'json' | 'txt' | 'csv'
): Promise<string | null> {
  try {
    // 1. å‡†å¤‡å¯¼å‡ºç›®å½•
    const exportDir = `${context.filesDir}/exports`
    if (!fileIo.accessSync(exportDir)) {
      fileIo.mkdirSync(exportDir)
    }

    // 2. ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
    const safeName = photoName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)
    const fileName = `EXIF_${safeName}_${timestamp}.${format}`
    const filePath = `${exportDir}/${fileName}`

    // 3. ç”Ÿæˆæ–‡ä»¶å†…å®¹
    let content: string
    switch (format) {
      case 'json':
        content = JSON.stringify({
          photoName: photoName,
          timestamp: new Date().toISOString(),
          exifData: exifData
        }, null, 2)
        break
      case 'txt':
        content = generateExifTextReport(exifData, photoName)
        break
      case 'csv':
        content = formatAsCsv(exifData, photoName)
        break
    }

    // 4. å†™å…¥æ–‡ä»¶
    const file = fileIo.openSync(filePath, fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY)
    fileIo.writeSync(file.fd, content)
    fileIo.closeSync(file)

    return filePath
  } catch (error) {
    console.error(`å¯¼å‡ºå¤±è´¥: ${error}`)
    return null
  }
}
```

### æ–‡ä»¶åè§„èŒƒ

| ç»„æˆéƒ¨åˆ† | ç¤ºä¾‹ | è¯´æ˜ |
|---------|------|------|
| å‰ç¼€ | `EXIF_` | å›ºå®šæ ‡è¯† |
| ç›¸æœºå‹å· | `HUAWEI_Mate60Pro_` | ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸º `_` |
| æ—¶é—´æˆ³ | `2025-12-26T15-30-45` | ISO æ ¼å¼ï¼Œ`:` æ›¿æ¢ä¸º `-` |
| æ‰©å±•å | `.json` / `.txt` / `.csv` | æ ¹æ®æ ¼å¼ |

**ç¤ºä¾‹æ–‡ä»¶å**ï¼š
```
EXIF_HUAWEI_Mate60Pro__2025-12-26T15-30-45.json
EXIF_Nikon_D800E_2025-12-26T15-30-45.txt
```

---

## å‚æ•°åˆ—è¡¨ç­›é€‰æ–¹æ¡ˆï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-26  
> **åœºæ™¯**: ä¸»é¡µç…§ç‰‡åˆ—è¡¨æŒ‰æ—¥æœŸ/å…‰åœˆ/ISO ç­›é€‰

### ç­›é€‰ç»´åº¦

| ç­›é€‰ç±»å‹ | é€‰é¡¹ | é€»è¾‘ |
|---------|------|------|
| **æ—¥æœŸ** | ä»Šå¤©/æœ¬å‘¨/æœ¬æœˆ | åŸºäº `exifData.dateTime`ï¼ˆæ‹æ‘„æ—¶é—´ï¼‰ |
| **å…‰åœˆ** | å¤§å…‰åœˆ(â‰¤f/2.8) / å°å…‰åœˆ(â‰¥f/8) | è§£æ `exifData.aperture` |
| **ISO** | ä½ISO(â‰¤400) / é«˜ISO(â‰¥1600) | ç›´æ¥æ¯”è¾ƒ `exifData.iso` |

### å…³é”®å®ç°

**æ—¥æœŸç­›é€‰**ï¼ˆä¼˜å…ˆ EXIF æ‹æ‘„æ—¶é—´ï¼‰ï¼š
```typescript
function filterByDate(record: PhotoRecord, value: string): boolean {
  // ä¼˜å…ˆä½¿ç”¨ EXIF æ‹æ‘„æ—¶é—´
  let dateTimeStr = record.exifData.dateTime || record.exifData.dateTimeOriginal

  // é™çº§åˆ°è®°å½•åˆ›å»ºæ—¶é—´
  if (!dateTimeStr) {
    dateTimeStr = new Date(record.createTime).toISOString().slice(0, 19).replace('T', ' ')
  }

  // è§£æ EXIF æ—¶é—´æ ¼å¼ï¼ˆ2025:12:26 15:30:45 æˆ– 2025/12/26 15-30ï¼‰
  const dateStr = dateTimeStr.replace(/[:\-]/g, (match: string, offset: number) => {
    return offset < 10 ? '/' : match === '-' ? ':' : match
  })
  const photoDate = new Date(dateStr)

  const now = new Date()
  switch (value) {
    case 'today':
      return photoDate.toDateString() === now.toDateString()
    case 'week':
      return photoDate >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
    case 'month':
      return photoDate >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
    default:
      return true
  }
}
```

**å…‰åœˆç­›é€‰**ï¼š
```typescript
function filterByAperture(exif: ExifData, value: string): boolean {
  if (!exif.aperture) return false

  const match = exif.aperture.match(/f\/?([\d.]+)/)
  if (!match) return false

  const apertureValue = parseFloat(match[1])

  switch (value) {
    case 'wide': // å¤§å…‰åœˆ (f/2.8 åŠä»¥ä¸‹)
      return apertureValue <= 2.8
    case 'small': // å°å…‰åœˆ (f/8 åŠä»¥ä¸Š)
      return apertureValue >= 8
    default:
      return true
  }
}
```

### UI äº¤äº’

**ç­›é€‰æŒ‰é’®**ï¼š
```typescript
Row() {
  Text('ğŸ”')
  Text(this.currentFilter.label)
    .fontColor(this.currentFilter.type === 'all' ? '#666666' : '#2563EB')
}
.onClick(() => this.showFilterMenu = true)
.bindSheet($$this.showFilterMenu, this.FilterMenuSheet(), {
  height: SheetSize.FIT_CONTENT
})
```

**ç­›é€‰é€»è¾‘**ï¼š
```typescript
function applyFilter(): void {
  if (this.currentFilter.type === 'all') {
    this.filteredRecords = [...this.records]
    return
  }

  this.filteredRecords = this.records.filter(record => {
    switch (this.currentFilter.type) {
      case 'date':
        return this.filterByDate(record, this.currentFilter.value || '')
      case 'aperture':
        return this.filterByAperture(record.exifData, this.currentFilter.value || '')
      case 'iso':
        return this.filterByISO(record.exifData, this.currentFilter.value || '')
      default:
        return true
    }
  })
}
```

---

## Sheet ä¸­è°ƒç”¨ç³»ç»Ÿåˆ†äº«çš„æ­£ç¡®æ–¹å¼ï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-27ï¼ˆçœŸæœºé€šè¿‡ï¼‰  
> **åœºæ™¯**: bindSheet ä¸­ç‚¹å‡»æŒ‰é’®è§¦å‘ ShareController

### ğŸš¨ æ ¸å¿ƒé—®é¢˜

**âŒ é”™è¯¯**ï¼šåœ¨ Sheet çš„ Builder ä¸­ç›´æ¥è°ƒç”¨ `ShareController.show()` ä¼šå¯¼è‡´ï¼š
1. ä¸Šä¸‹æ–‡æ±¡æŸ“ â†’ å…¨å±€åˆ†äº«æœåŠ¡å¤±æ•ˆ
2. æµ®å±‚å±‚çº§å†²çª â†’ åˆ†äº«é¢æ¿è¢«é®æŒ¡
3. è·¨é¡µé¢å½±å“ â†’ å…¶ä»–é¡µé¢åˆ†äº«ä¹Ÿå¤±æ•ˆ

### âœ… æ­£ç¡®å®ç°ï¼ˆäº”ä¸“å®¶å…±è¯†ï¼‰

```typescript
// åœ¨ Sheet æŒ‰é’®çš„ onClick ä¸­
Button('åˆ†äº«').onClick(async () => {
  // 1. å…ˆå…³é—­ Sheetï¼ˆå¿…é¡»ï¼ï¼‰
  this.showExportSuccessDialog = false
  
  // 2. ç­‰å¾… Sheet åŠ¨ç”»å®Œæˆ
  await new Promise<void>(resolve => setTimeout(resolve, 100))
  
  // 3. ä½¿ç”¨é¡µé¢çº§ä¸Šä¸‹æ–‡è°ƒç”¨åˆ†äº«
  const shareData = new systemShare.SharedData({
    utd: utd.UniformDataType.PLAIN_TEXT,
    uri: fileUri.getUriFromPath(filePath),
    title: fileName,
    description: 'å¯¼å‡ºæ•°æ®'
  })
  const controller = new systemShare.ShareController(shareData)
  await controller.show(this.context, { 
    previewMode: systemShare.SharePreviewMode.DETAIL 
  })
})
```

### å…³é”®è§„åˆ™

| åœºæ™¯ | setTimeout | åŸå›  |
|------|:----------:|------|
| **æ‰“å¼€ Sheet** | âŒ ç¦æ­¢ | ç ´å ArkUI åŒæ­¥æ›´æ–° |
| **Sheet â†’ Sheet åˆ‡æ¢** | âŒ ç¦æ­¢ | åŒæ­¥åˆ‡æ¢ï¼Œç³»ç»Ÿå¤„ç†åŠ¨ç”» |
| **Sheet â†’ ç³»ç»ŸæœåŠ¡** | âœ… 100ms | ç­‰å¾… Sheet åŠ¨ç”»å®Œæˆ |

### å¤š Sheet ç»‘å®šæ–¹æ¡ˆï¼ˆæ¨èï¼‰

```typescript
build() {
  // ç”¨ Stack åŒ…è£…ï¼Œæ¯ä¸ª Sheet ç»‘å®šåˆ°ç‹¬ç«‹å®¹å™¨
  Stack() {
    Column() { /* ä¸»å†…å®¹ */ }
    
    // ç‹¬ç«‹å®¹å™¨ç»‘å®šå„ Sheet
    Column().bindSheet($$this.showFilterMenu, this.FilterSheet(), {...})
    Column().bindSheet($$this.showExportMenu, this.ExportSheet(), {...})
    Column().bindSheet($$this.showSuccessDialog, this.SuccessSheet(), {...})
  }
}
```

---

## åª’ä½“åº“URIè®¿é—®ï¼ˆAPI 20ï¼‰

> âœ… **å·²éªŒè¯**: 2025-12-30  
> **åœºæ™¯**: ä»åª’ä½“åº“URIï¼ˆ`file://media/Photo/...`ï¼‰è¯»å–å›¾ç‰‡å¹¶ç§»é™¤EXIF

### æ ¸å¿ƒç»“è®º

**éªŒè¯ç»“æœ**ï¼š
- âœ… `fileIo.openSync()` **å¯ä»¥æ­£å¸¸æ‰“å¼€**åª’ä½“åº“URI
- âœ… URI **æ— æ—¶æ•ˆæ€§é—®é¢˜**ï¼ˆ26åˆ†é’Ÿåä»å¯æ­£å¸¸è®¿é—®ï¼‰
- âœ… ç³»ç»Ÿé€šè¿‡ `DataShareExtAbility` è¿æ¥åª’ä½“åº“ï¼ˆç³»ç»Ÿçº§èƒ½åŠ›ï¼‰
- âœ… ä¹‹å‰çš„å¤±è´¥å¯èƒ½æ˜¯å¶å‘æ€§çš„ç³»ç»Ÿé—®é¢˜ï¼Œéä»£ç é—®é¢˜

### æ­£ç¡®å®ç°æ–¹å¼

**ç›´æ¥ä½¿ç”¨ fileIo.openSync()**ï¼š
```typescript
// entry/src/main/ets/services/ShareService.ets
private async downloadUriToTempFile(uri: string, quality: number = 95): Promise<string | null> {
  let srcFile: fileIo.File | null = null
  let imageSource: image.ImageSource | null = null
  
  try {
    // âœ… ç›´æ¥ä½¿ç”¨fileIo.openSyncæ‰“å¼€åª’ä½“åº“URI
    srcFile = fileIo.openSync(uri, fileIo.OpenMode.READ_ONLY)
    imageSource = image.createImageSource(srcFile.fd)
    
    // ... åç»­å¤„ç†
  } finally {
    if (imageSource) imageSource.release()
    if (srcFile) fileIo.closeSync(srcFile)
  }
}
```

### å…³é”®è¦ç‚¹

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **URIæ ¼å¼** | `file://media/Photo/124523/IMG_xxxx/IMG_xxxx.heic` |
| **è®¿é—®æ–¹å¼** | `fileIo.openSync(uri, fileIo.OpenMode.READ_ONLY)` |
| **ç³»ç»Ÿèƒ½åŠ›** | é€šè¿‡ `DataShareExtAbility` è¿æ¥åª’ä½“åº“ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰ |
| **æ—¶æ•ˆæ€§** | **æ— æ—¶æ•ˆé™åˆ¶**ï¼ˆå·²éªŒè¯26åˆ†é’Ÿåä»å¯è®¿é—®ï¼‰ |
| **æƒé™** | æ— éœ€ç”³è¯· `READ_IMAGEVIDEO` æƒé™ï¼ˆFilePickerå·²æˆæƒï¼‰ |

### éªŒè¯æ—¥å¿—ç¤ºä¾‹

```
[DownloadURI] URIå®Œæ•´å†…å®¹: file://media/Photo/124523/IMG_1766475544_123140/IMG_20251223_153724_1.heic
[DownloadURI] âœ… æˆåŠŸæ‰“å¼€URIï¼Œæ–‡ä»¶æè¿°ç¬¦: 53
[DownloadURI] æˆåŠŸä»åª’ä½“åº“URIåˆ›å»ºImageSource
[DownloadURI] å›¾ç‰‡å°ºå¯¸: 1856x4000
[DownloadURI] ä¸‹è½½æˆåŠŸ: /data/storage/el2/base/haps/entry/cache/share_temp/xxx_temp.jpg
```

### æ€§èƒ½è¡¨ç°

- æ‰“å¼€URIï¼šçº¦14ms
- åˆ›å»ºPixelMapï¼šçº¦33ms
- ç¼–ç å›¾ç‰‡ï¼šçº¦118ms
- **æ€»ä½“æµç¨‹**ï¼šçº¦250msï¼ˆå¯æ¥å—ï¼‰

### æ³¨æ„äº‹é¡¹

1. **ç³»ç»Ÿèƒ½åŠ›è¿æ¥**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨é€šè¿‡ `DataShareExtAbility` è¿æ¥åª’ä½“åº“ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
2. **èµ„æºé‡Šæ”¾**ï¼šå¿…é¡»é‡Šæ”¾ `ImageSource` å’Œ `File`ï¼Œé¿å…FDæ³„æ¼
3. **é”™è¯¯å¤„ç†**ï¼šå¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿèµ„æºä¸´æ—¶ä¸å¯ç”¨ï¼Œå¯ä»¥æ·»åŠ é‡è¯•æœºåˆ¶
4. **æ— éœ€photoAccessHelper**ï¼šç›´æ¥ä½¿ç”¨ `fileIo.openSync()` å³å¯ï¼Œæ— éœ€é¢å¤–çš„å·¥å…·ç±»

### ä¸ExifParserServiceå¯¹æ¯”

| é¡¹ç›® | ExifParserService | ShareService |
|------|------------------|--------------|
| **URIæ¥æº** | PhotoPickerç›´æ¥è¿”å› | PhotoRecord.originalUriï¼ˆå­˜å‚¨åè¯»å–ï¼‰ |
| **è°ƒç”¨æ—¶æœº** | ç«‹å³è°ƒç”¨ | å»¶è¿Ÿè°ƒç”¨ï¼ˆå¯èƒ½æ•°åˆ†é’Ÿ/å°æ—¶ï¼‰ |
| **è®¿é—®æ–¹å¼** | `fileIo.openSync(photoUri)` | `fileIo.openSync(uri)` |
| **éªŒè¯ç»“æœ** | âœ… æˆåŠŸ | âœ… æˆåŠŸï¼ˆå·²éªŒè¯ï¼‰ |

**ç»“è®º**ï¼šä¸¤è€…ä½¿ç”¨ç›¸åŒçš„è®¿é—®æ–¹å¼ï¼Œéƒ½å¯ä»¥æˆåŠŸæ‰“å¼€åª’ä½“åº“URIã€‚

---

## ğŸ”— ç›¸å…³ä¸»é¢˜

- **EXIFå¤„ç†** â†’ [EXIFå¤„ç†.md](./EXIFå¤„ç†.md)
- **é¿å‘æŒ‡å—** â†’ [é¿å‘æŒ‡å—.md](./é¿å‘æŒ‡å—.md)
- **å®Œæ•´çŸ¥è¯†åº“** â†’ [çŸ¥è¯†åº“_å®Œæ•´ç‰ˆ_20251226.md](../çŸ¥è¯†åº“_å®Œæ•´ç‰ˆ_20251226.md)

