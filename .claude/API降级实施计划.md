# API 降级实施计划（API 20 → API 17）

> **创建时间**: 2025-12-29  
> **状态**: ⏳ 待实施  
> **目标**: 适配大部分原生鸿蒙5.0设备

---

## 📊 专家观点汇总

### 共识点
1. ✅ **架构相同**：API 17 和 API 20 都是 HarmonyOS NEXT，底层架构相同
2. ✅ **核心Kit兼容**：AbilityKit、ArkUI、NetworkKit、LocationKit 完整支持
3. ✅ **必须移除**：MultimodalAwarenessKit 不支持，必须移除
4. ⚠️ **需要适配**：MapKit、FormKit 存在API差异

### 分歧点
- **网络请求**：华为智能助手未提及，CodeGenie 建议使用 `@system.http`（但 NetworkKit 仍可用）
- **工作量评估**：CodeGenie 给出详细评估（20-28人日），华为智能助手未给出

---

## 🎯 实施步骤

### Phase 1: 准备工作（1-2天）

#### 1.1 环境准备
- [ ] 创建 API 17 模拟器（6英寸1080P屏幕）
- [ ] 安装 DevEco Studio 对应版本（如需要）
- [ ] 备份当前代码（Git 分支：`api20-backup`）

#### 1.2 技术评估
- [ ] 确认 MapKit 在 API 17 中的具体差异
- [ ] 确认 FormKit 服务卡片模板语法差异
- [ ] 确认路由参数传递限制
- [ ] 确认 Ability 生命周期方法参数差异

### Phase 2: 配置文件修改（0.5天）

#### 2.1 修改 build-profile.json5
```json5
{
  "app": {
    "products": [{
      "targetSdkVersion": "5.0.0(17)",
      "compatibleSdkVersion": "5.0.0(17)"
    }]
  }
}
```

#### 2.2 修改 module.json5
- [ ] 移除 `ohos.permission.DETECT_GESTURE` 权限声明

### Phase 3: 代码修改（3-5天）

#### 3.1 移除智感握姿功能（1天）
- [ ] 移除 `MapView.ets` 中的智感握姿相关代码
- [ ] 移除 `GeneralSettingsPage.ets` 中的智感握姿开关
- [ ] 移除 `@kit.MultimodalAwarenessKit` 导入
- [ ] 移除 `motion.on('holdingHandChanged')` 相关代码

#### 3.2 适配 MapKit（1-2天）
- [ ] 修改地图事件回调格式（`event.latitude` vs `event.value.lat`）
- [ ] 添加坐标转换接口调用（如需要）
- [ ] 显式声明 `mapMode: MapMode.NORMAL`
- [ ] 测试地图标注交互事件

#### 3.3 适配 FormKit（0.5-1天）
- [ ] 检查服务卡片模板语法
- [ ] 修改卡片布局逻辑（如需要）
- [ ] 测试卡片动态刷新机制

#### 3.4 适配路由和Ability（0.5-1天）
- [ ] 检查路由参数传递（确保使用字符串）
- [ ] 检查 Ability 生命周期方法参数
- [ ] 测试 Ability 间数据传递

### Phase 4: 测试验证（4-6天）

#### 4.1 功能测试
- [ ] 花粉数据展示
- [ ] GPS定位
- [ ] 城市管理
- [ ] 地图展示和交互
- [ ] 服务卡片更新
- [ ] 通知推送
- [ ] 主题切换

#### 4.2 兼容性测试
- [ ] 使用 `hdc shell aa checkapi --target 17` 扫描
- [ ] 在 API 17 模拟器上全功能测试
- [ ] 性能基准测试

#### 4.3 回归测试
- [ ] 确保所有核心功能正常
- [ ] 确保UI显示正常
- [ ] 确保交互体验不受影响

---

## ⚠️ 风险评估与缓解措施

| 风险项 | 发生概率 | 影响程度 | 缓解措施 |
|--------|---------|---------|---------|
| 地图标注交互失效 | 中 | 高 | 增加API17专属事件适配层，提前测试 |
| 服务卡片布局错乱 | 高 | 中 | 使用响应式布局替代固定尺寸 |
| 路由传参类型校验失败 | 低 | 中 | 显式声明参数类型，代码审查 |
| 网络请求API差异 | 低 | 低 | NetworkKit在API17中仍可用，无需修改 |

---

## 📋 决策建议

### 建议实施条件
- ✅ API 17 设备覆盖率 > 85%
- ✅ 客户反馈强烈，影响用户安装
- ✅ 团队有足够时间（20-28人日）

### 建议暂缓条件
- ⚠️ API 17 设备覆盖率 < 50%
- ⚠️ 时间紧迫，无法完成全量测试
- ⚠️ 地图功能是核心功能，风险较高

### 备选方案：多版本构建
如果需保留 API 20 特性，可考虑多版本构建策略：
```json5
// build-profile.json5
targets: [
  { name: "v5", apiVersion: 17 },
  { name: "v6", apiVersion: 20 }
]
```

---

## 📝 待确认事项

1. ⏳ **设备覆盖率**：API 17 设备的具体覆盖率是多少？
2. ⏳ **客户反馈**：有多少客户反馈无法安装？
3. ⏳ **优先级**：API 降级是否比新功能开发优先级更高？
4. ⏳ **时间窗口**：是否有足够的时间窗口完成降级和测试？

---

**最后更新**: 2025-12-29  
**状态**: ⏳ 待决策和实施

