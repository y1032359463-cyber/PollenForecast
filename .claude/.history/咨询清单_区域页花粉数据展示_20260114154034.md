# 咨询清单：区域页花粉数据展示优化

> **创建时间**: 2026-01-14  
> **问题背景**: 区域页城市列表需要展示各城市真实的花粉等级，但当前实现存在性能瓶颈

---

## 📋 需要咨询的问题分类

### 1. 🔴 敏舒 API 提供方（必须咨询）

**咨询对象**: 敏舒（Minshu）API 技术支持  
**联系方式**: 电话 13911156751（文档中提供）  
**文档来源**: `PollenForecast/figma/日志.md`（2026-01-07 更新）

#### ✅ 已确认信息（来自文档）

**更新频率**（第699-703行）：
- ✅ 未来5日：**每日22点更新完成**
- ✅ 24小时：**每日23点更新完成**
- ✅ **结论**：数据可以缓存 **24小时**，大大减少请求量

**接口格式**：
- ✅ 所有接口都是**单个 adcode 查询**，格式：`/day/pollen/{recordDate}/{adcode}?apikey={apikey}`
- ✅ **没有批量查询接口**（文档中未提及）

**错误码**：
- ✅ 403：apikey错误

#### ❓ 待咨询问题

**Q1: 批量查询接口**（优先级：P0）
- ❓ 是否有批量查询接口？（文档中未提及，需要确认）
- ❓ 如果没有，是否有计划提供批量查询接口？
- ❓ 如果没有批量接口，建议的批量请求策略是什么？

**Q2: API 调用频率限制**（优先级：P0）
- ❓ 当前 API Key 的调用频率限制是多少？（QPS、每日限额）
- ❓ 如果批量请求 20+ 城市，是否会触发限流？
- ❓ 是否有白名单或企业版可以提升调用频率？
- ⚠️ **重要**：文档中未提及调用频率限制，需要咨询

**Q3: 缓存建议**（优先级：P1 - 已部分确认）
- ✅ 花粉数据更新频率：**每日22点/23点更新**（已确认）
- ❓ 官方是否建议客户端缓存？建议缓存时长？
- ❓ 是否有数据变更通知机制（Webhook/推送）？

**Q4: 数据覆盖范围**（优先级：P1）
- ❓ 当前 API 是否覆盖全国所有省市区县（3210 个区域）？
- ❓ 如果某个区域没有数据，API 返回什么？（空数据/null/错误码）

---

### 2. 🟡 华为/HarmonyOS 官方（建议咨询）

**咨询对象**: HarmonyOS 开发者社区 / 技术支持  
**渠道**: 
- [HarmonyOS 开发者社区](https://developer.huawei.com/consumer/cn/forum)
- DevEco Studio 技术支持
- HarmonyOS 官方技术文档

#### 问题清单

**Q1: 类似场景最佳实践**
- ❓ HarmonyOS 应用中，类似场景（城市列表展示天气/空气质量/花粉等数据）的推荐架构是什么？
- ❓ 是否有官方示例代码或最佳实践文档？

**Q2: 本地数据库缓存方案**
- ❓ 对于大量城市数据（3210 个区域），推荐使用哪种本地存储方案？
  - `@ohos.data.preferences`（Preferences）？
  - `@ohos.data.relationalStore`（关系型数据库）？
  - `@ohos.data.distributedKVStore`（分布式 KV）？
- ❓ 各方案的性能对比和适用场景？

**Q3: 网络请求优化**
- ❓ HarmonyOS 是否有内置的请求队列/批量请求机制？
- ❓ 如何优化大量并发 HTTP 请求的性能？
- ❓ 是否有请求去重/合并机制？

**Q4: 性能优化建议**
- ❓ 对于列表展示大量数据（3210 个城市），推荐使用什么组件？
  - `List` + `LazyForEach`？
  - `Grid` + 虚拟滚动？
- ❓ 如何优化列表滚动性能？

---

### 3. 🟢 可以自己解决（无需咨询）

#### 架构方案选择
- ✅ **方案 A**: 区域页用 Google API（按经纬度），首页用敏舒 API（按 adcode）
- ✅ **方案 B**: 代理服务器层面实现批量查询+缓存
- ✅ **方案 C**: 客户端本地缓存 + 定时更新

#### 技术实现
- ✅ 修改 `PollenService.getPollenForecast()` 支持传入城市名参数
- ✅ 修改 `RegionView.loadPollenDataForCities()` 传递正确的城市名
- ✅ 在代理服务器（`http://106.12.143.105:3000`）实现批量查询接口
- ✅ 客户端实现本地缓存（Preferences/KVDB）

---

## 🎯 咨询优先级

### P0 - 必须咨询（阻塞开发）
1. **敏舒 API 调用频率限制** - 影响是否可以实现批量请求（文档未提及）
2. **敏舒 API 批量查询接口** - 确认是否有批量接口（文档未提及，可能没有）

### P1 - 建议咨询（优化方案）
3. **敏舒 API 数据覆盖范围** - 确认是否覆盖全国3210个区域
4. **HarmonyOS 本地数据库方案** - 影响缓存实现
5. **HarmonyOS 类似场景最佳实践** - 参考官方建议

### P2 - 可选咨询（锦上添花）
6. **敏舒 API 缓存建议** - 已确认更新频率（24小时），可自己实现缓存
7. **HarmonyOS 性能优化建议** - 可以自己优化

---

## 📝 咨询模板

### 敏舒 API 咨询模板

```
主题：关于敏舒花粉 API 批量查询和调用频率限制的咨询

您好，

我们正在开发一款 HarmonyOS 花粉浓度播报应用，使用敏舒 API 获取花粉数据。

当前场景：
- 区域页需要展示 20+ 城市的花粉等级预览
- 每个城市需要调用一次 API（传入 adcode）
- 后续计划扩展到全国 3210 个省市区县

已确认信息（来自文档）：
- 数据更新频率：未来5日每日22点更新，24小时每日23点更新
- 接口格式：/day/pollen/{recordDate}/{adcode}?apikey={apikey}

咨询问题：
1. 是否有批量查询接口？一次请求可以传入多个 adcode？
   （文档中未提及批量接口，当前都是单个 adcode 查询）
2. API 调用频率限制是多少？（QPS、每日限额）
   （文档中未提及调用频率限制，批量请求 20+ 城市是否会触发限流？）
3. 数据覆盖范围：是否覆盖全国所有省市区县（3210 个区域）？
4. 如果某个区域没有数据，API 返回什么？（空数据/null/错误码）

API Key: AK-lYpA8KnbT0lzPNvfjIqCSLDMLPz1n3htrENs
授权范围: 花粉当天24h、花粉未来5天
截止日期: 2026-07-01

期待您的回复，谢谢！
```

### HarmonyOS 咨询模板

```
主题：HarmonyOS 应用中大量城市数据展示的最佳实践

您好，

我们正在开发一款花粉浓度播报应用，需要在列表页展示全国多个城市的花粉数据。

场景描述：
- 列表页展示 20-3210 个城市
- 每个城市需要显示花粉等级（小圆点颜色）
- 数据来源：HTTP API（需要批量请求）

咨询问题：
1. 类似场景（城市列表展示天气/空气质量等数据）的推荐架构是什么？
2. 对于大量城市数据，推荐使用哪种本地存储方案？（Preferences/关系型数据库/分布式KV）
3. 如何优化大量并发 HTTP 请求的性能？

期待您的建议，谢谢！
```

---

## ✅ 咨询后的行动计划

### 🎯 基于文档的初步方案（已确认更新频率）

**核心优势**：数据每天更新一次（22点/23点），可以缓存 **24小时**

**推荐方案**：
1. ✅ **代理服务器批量查询+缓存**（24小时 TTL）
   - 客户端请求：`GET /minshu/pollen/batch?adcodes=110000,310000,440100`
   - 代理服务器：并发查询敏舒 API，缓存结果 24小时
   - 优势：减少敏舒 API 调用量，提升响应速度

2. ✅ **客户端本地缓存**（24小时 TTL）
   - 使用 `Preferences` 或 `KVDB` 缓存各城市数据
   - 缓存键：`pollen_${adcode}_${recordDate}`
   - 优势：离线可用，减少网络请求

3. ✅ **请求策略优化**
   - 首次加载：批量请求（5个一批，控制并发）
   - 后续加载：优先使用缓存，缓存过期才请求
   - 定时更新：每天23点后刷新缓存

### 如果敏舒有批量查询接口
1. ✅ 修改代理服务器，调用敏舒批量接口
2. ✅ 修改客户端，调用批量接口
3. ✅ 实现本地缓存（24小时 TTL）

### 如果敏舒没有批量查询接口（当前推测）
1. ✅ 在代理服务器层面实现批量查询+缓存（24小时 TTL）
2. ✅ 客户端实现本地缓存（Preferences/KVDB，24小时 TTL）
3. ✅ 使用请求队列，控制并发数（5个一批）

### 如果 API 调用频率受限
1. ✅ 实现更激进的本地缓存策略（24小时 TTL）
2. ✅ 区分"预览场景"和"详情场景"（预览用缓存，详情实时请求）
3. ✅ 考虑混合数据源（区域页用 Google，首页用敏舒）

---

---

## 📊 文档分析总结

### ✅ 已确认（来自 API 文档）
- **更新频率**：每日22点/23点更新，可缓存24小时
- **接口格式**：单个 adcode 查询，无批量接口
- **错误码**：403 apikey错误

### ❓ 待确认（需要咨询）
- **调用频率限制**：QPS、每日限额（文档未提及）
- **批量查询接口**：是否有或计划提供（文档未提及）
- **数据覆盖范围**：是否覆盖全国3210个区域

### 💡 推荐方案（基于已确认信息）
1. **代理服务器批量查询+缓存**（24小时 TTL）
2. **客户端本地缓存**（24小时 TTL）
3. **请求队列控制并发**（5个一批）

---

**最后更新**: 2026-01-14  
**状态**: 📋 待咨询（已确认更新频率，可先实现缓存方案）
