# HarmonyOS NEXT API 20 开发与规则红线

> **用途**: 复制到 Cursor Settings → Rules and Commands → User Rules  
> **最后更新**: 2026-01-16  
> **核心目标**: 确保 ArkTS 严苛模式下的代码零报错、设置项 100% 持久化、文档知识不丢失。

---

## Ⅰ. 工程红线（Engineering Redlines）

### 1. 3-Strike 规则
- 同一技术问题尝试 3 次修复失败后：**必须停止** → 写入 `当前问题.md` → 告知用户寻求专家支持（CodeGenie）。

### 2. 禁止操作
- **禁止执行构建命令**（除非用户明确授权）。
- **禁止修改 backup/ 目录** 下的任何文件。
- **禁止删除已验证内容**：知识库（`知识库.md`）中已由用户确认有效的方案不得删除或覆盖。
- **保护核心实现**：严禁删除或重写已证明稳定的核心逻辑，如 `EntryAbility` 中的初始化链路及 `SettingsPreferences` 的读写机制。

### 3. 资源管理
- **必须手动释放**：`imageSource.release()`、`pixelMap.release()`、`packer.release()`、`fileIo.closeSync(fd)` 等操作严禁遗漏或被逻辑分支跳过。

### 4. 知识库管理
- 已验证方案 → 写入 `知识库.md`
- 待验证方案 → 写入 `知识库_中转站.md`
- 只追加不删除（除非明确过时）
- 用户确认"构建成功/登记吧"后才能更新

---

## Ⅱ. ArkTS 严苛模式语法（Strict Syntax）

### 1. 静态方法约束
- **禁止使用 this**：在静态方法（static）中访问静态成员，必须使用 `ClassName.staticMember`，严禁使用 `this.staticMember`。

### 2. 对象与数组操作
- **禁止展开运算符**：严禁使用 `{...obj}` 或 `[...arr]`。
- **对象更新**：必须显式创建新对象，手动列出字段：`const newObj: T = { a: old.a, b: old.b }`。
- **数组复制**：`const newArr: T[] = []; for (let i = 0; i < old.length; i++) { newArr.push(old[i]) }`

### 3. 类型安全
- **禁止 any / unknown**：必须显式声明类型或接口。
- **禁止对象字面量类型**：不能直接定义 `Promise<{a: string}>`，必须先定义 `interface Result {a: string}` 然后使用 `Promise<Result>`。
- **类型断言**：统一使用 `value as Type`，禁止使用 `<Type>value`。

### 4. UI 组件限制
- **ListItem 扁平化**：`ListItem` 内部严禁嵌套另一个 `ListItem`。
- **Refresh 限制**：`Refresh` 组件只能有一个子组件。
- **@Builder 参数**：`@Builder` 函数必须显式传递参数，例如 `@Builder MyTab(index: number)`，禁止无参 `@Builder MyTab()`。

### 5. 杂项规范
- **catch 子句**：严禁类型注解，必须写为 `catch (error)`，禁止 `catch (error: Error)`。
- **AppStorage**：作为全局对象，无需也不得 import。
- **变量初始化**：Class 属性必须在声明时或构造函数内初始化。
- **注释规范**：所有接口、类、公共方法必须使用 `/** ... */` 文档注释，禁止仅使用 `//` 或 `/* ... */`。
- **模块定义**：`declare module` 内的类型定义必须显式 `export interface`。

---

## Ⅲ. 设置持久化原则（Persistence Policy）

### 1. 存储选型
- **核心设置严禁使用 PersistentStorage**：因其同步性能和可靠性问题，所有核心配置（外观、通知等）必须使用 `Preferences` 存储。

### 2. 状态驱动同步
- **Preferences → UI**：读取配置后，必须更新对应的 `AppStorage` 变量以触发 UI 刷新。
- **应用逻辑**：对于外观模式，在 `EntryAbility` 初始化后必须立即显式调用 `applicationContext.setColorMode()` 应用配置。

### 3. 验证要求
- **冷启动验证**：涉及持久化的修改，必须手动模拟"杀进程重启"流程，验证配置在冷启动后是否依然生效。

---

## Ⅳ. API 20 废弃替代（API Evolution）

- **上下文获取**：`getContext(this)` → `this.getUIContext().getHostContext()`
- **UI 操作**：
  - `animateTo` → `this.getUIContext().animateTo()`
  - `promptAction.*` → `this.getUIContext().getPromptAction().*`
  - `router.*` → `this.getUIContext().getRouter().*`
- **媒体文件**：使用 `fileUri.getUriFromPath(path)` 获取 URI，禁止手动拼接字符串。
- **文件操作**：媒体库URI用 `fileIo.statSync(fd)` 不是 `statSync(uri)`
- **权限限制**：`WRITE_IMAGEVIDEO` 普通应用不可用，用 `showAssetsCreationDialog` 替代

---

## Ⅴ. 文档整理与保护（Documentation Strategy）

### 🚨 文档整理硬规则
1. **先转移**：将内容完整转移到对应目标文件。
2. **后确认**：通过读取目标文件，确认内容已成功写入且无损。
3. **再删除**：确认成功后方可删除原文件内容（保留原路径链接）。

**禁止操作**：
- ❌ 禁止未转移就删除
- ❌ 禁止转移未确认就删除
- ❌ 禁止一次性删除大量内容而不验证

### 文档健康度检测
读取指导文档时，如果发现文档行数过多，询问用户是否需要整理：
- `知识库.md` > 500行 → 建议整理
- `知识库_中转站.md` > 300行 → 建议整理
- `当前问题.md` > 100行 → 建议整理
- `CLAUDE.md` > 600行 → 建议整理

**询问方式**："检测到 [文件名] 已达到 [行数] 行，建议整理。是否现在整理？"

---

## Ⅵ. 已验证错误方案（避坑清单）

- SaveButton API 不存在
- Refresh 指示器无法隐藏
- Sheet 中直接调 ShareController 会失效（需先关 Sheet + 100ms 延迟）
- 只设置 isStatusBarLightIcon 会导致字体灰色（必须同时设 statusBarContentColor）
- 修改 Native/.d.ts 后报旧错误：删除 `entry\build` 再 Rebuild

---

## Ⅶ. 深度推理机制（基于 UPD-Workflow）

> **来源**: [LZMW/UPD-Workflow](https://github.com/LZMW/UPD-Workflow)  
> **用途**: 处理复杂问题时启用，简单问题跳过

### 触发条件
遇到以下情况时启用深度推理：
- 复杂需求分析（多方案决策）
- 架构设计选型
- 技术风险评估
- 创新/未知方案探索

### 三步执行流程

**1️⃣ 拆解 (Decompose)**
```
已知条件：[列出明确的信息]
未知条件：[列出需要确认的信息]
潜在需求：[列出隐含的需求]
核心问题：[一句话概括]
```

**2️⃣ 解构 (Deconstruct)** - 并行三路思维
```
【可行性分析】
- 技术可行性：[评估]
- 资源可行性：[评估]
- 时间可行性：[评估]

【≥3 种方案】
- 方案A：[描述] → 优点/缺点
- 方案B：[描述] → 优点/缺点
- 方案C：[描述] → 优点/缺点

【约束与边界】
- 必须满足：[硬性约束]
- 避免出现：[否定约束]
- 可以妥协：[软性约束]
```

**3️⃣ 重组 (Reorganize)**
```
【综合评估】按优先级排序方案
【推荐方案】选择最优解 + 理由
【风险预案】如果推荐方案失败的备选
【行动计划】具体实施步骤
```

### 简化版（快速决策）
对于中等复杂度问题，可使用简化版：
```
问题：[一句话]
方案：A/B/C [各一句话]
推荐：[选择] 因为 [理由]
```

### 与现有规则配合
- 深度推理产出的**已验证方案** → 知识库.md
- 深度推理产出的**待验证方案** → 知识库_中转站.md
- 深度推理 3 次未解决 → 3-Strike 规则 → 当前问题.md
