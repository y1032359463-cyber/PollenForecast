# 当前问题

> **状态**: 🔴 待专家回复
> **更新时间**: 2026-01-14

---

## 问题：华为云函数部署后测试报错 Cannot find module

### 1. 环境说明

| 项目 | 版本 |
|------|------|
| **平台** | 华为 AppGallery Connect |
| **服务** | 云函数 (Cloud Function) |
| **运行环境** | nodejs / latest |
| **函数入口** | index.main |
| **内存配置** | 2000 MB |

### 2. 🔴 改动前状态（必填）

**功能是否正常**：否（首次创建，未测试过）  
**原有实现**：  
- 在华为云函数控制台创建了函数 `fetchpollendata`
- 函数配置：超时时长 1800s，实例并发 10000
- 已配置定时触发器：cron `30 23 * * *`（每天23:30执行）

### 3. 🔴 我做了什么改动（必填）

**改动文件**：华为云函数在线编辑器  
**改动内容**：  
在云函数的"函数代码"页面，上传了以下文件：

1. **index.js**（主函数代码）：
```javascript
// 云函数：定时抓取花粉数据
const cloud = require('@agconnect/cloud-function');
const axios = require('axios');
const CITY_LIST = require('./cities.json');

exports.main = async (event, context) => {
  // ... 抓取逻辑
};
```

2. **cities.json**（3210个城市列表）：
```json
[
  {"adcode":"110000","name":"北京市"},
  ...
]
```

3. **package.json**（依赖配置）：
```json
{
  "name": "fetchpollendata",
  "version": "1.0.0",
  "dependencies": {
    "axios": "^1.6.0"
  }
}
```

**改动原因**：  
实现服务器端预抓取花粉数据功能，定时从敏舒API抓取3210个城市的花粉数据并存储到云数据库。

### 4. 🔴 改动后出现的问题（必填）

**现象描述**：  
- 上传完代码文件后，点击"测试函数"按钮
- 使用默认测试事件 `{"request": "Hello World!"}`
- 执行结果报错：`Cannot find module '/dcache/layer/func/index.js'`
- 函数无法启动执行

**是否必现**：是（每次测试都报错）

### 5. 错误信息/日志

```json
{
  "code": 180000,
  "message": "Call handler error: Cannot find module '/dcache/layer/func/index.js'\nRequire stack:\n- /home/wisefunction/runtime/functions/invoke_func.js\n- /home/wisefunction/runtime/functions/functions.js\n- /home/wisefunction/runtime/cluster/worker_listen.js\n- /home/wisefunction/runtime/wrapper.js"
}
```

### 6. 关键代码（完整展示实现逻辑）

**相关API**：华为云函数、@agconnect/cloud-function

**文件结构**（在云函数在线编辑器中）：
```
Root/
├── index.js          (主函数代码)
├── cities.json       (城市列表，3210个城市)
└── package.json      (依赖配置)
```

**函数入口配置**：
- 函数入口：`index.main`
- 运行环境：`nodejs / latest`
- 代码输入类型：在线编辑

**index.js 关键代码**：
```javascript
const cloud = require('@agconnect/cloud-function');
const axios = require('axios');
const CITY_LIST = require('./cities.json');

exports.main = async (event, context) => {
  console.log('[云函数] 开始预抓取花粉数据...');
  // ... 抓取逻辑
  return {
    code: 0,
    message: 'success'
  };
};
```

### 7. 核心疑问（问实现方式，不只问报错）

1. ❓ **我的文件结构是否正确？**
   - 三个文件（index.js, cities.json, package.json）都放在 Root 目录下是否正确？
   - 是否需要特定的目录结构？

2. ❓ **是否需要先点击"提交"按钮部署代码？**
   - 上传文件后是否必须点击"提交"按钮才能测试？
   - 还是上传后可以直接测试？

3. ❓ **函数入口配置是否正确？**
   - `index.main` 是否正确？
   - 是否需要其他配置？

4. ❓ **依赖安装问题**：
   - `axios` 依赖是否会自动安装？
   - 是否需要手动配置依赖层？

5. ❓ **正确的部署流程是什么？**
   - 创建函数 → 上传代码 → 提交部署 → 测试？
   - 还是其他流程？

---

## 专家回复

（待专家回复...）
