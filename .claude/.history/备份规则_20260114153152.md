# 备份规则文档

> **用途**: 定义项目备份的标准流程和规则  
> **最后更新**: 2026-01-14

---

## 📋 备份原则

### 核心原则
1. **先备份，再操作** - 重大操作前必须备份
2. **精简备份** - 只备份核心代码，避免内存浪费
3. **双重保障** - 本地备份 + GitHub备份
4. **总结时同步更新** - 会话结束总结时，同步更新 CLAUDE.md 和 知识库.md

### 备份方式
- **项目副本备份** - 复制整个项目文件夹，删除不必要文件（既是备份也是demo）
- **GitHub备份** - 通过 Git 提交和推送

---

## 🗂️ 本地备份规则（项目副本备份）

**用途**：既是备份也是demo，供工程师直接打开查看和调试

### 备份位置
`C:\HarmonyOS_App_Plans\.claude\backup\PollenForecast_v版本号_日期时间/`

### 备份命名格式
- 格式：`PollenForecast_v版本号_YYYYMMDD_HHMMSS`
- 示例：`PollenForecast_v1.0.2_20260110_143000`

### 操作步骤（⚠️ 必须严格遵守）

1. **复制整个项目文件夹**
   - 在文件管理器中，复制 `PollenForecast` 文件夹
   - 粘贴到 `C:\HarmonyOS_App_Plans\.claude\backup\` 目录
   - 重命名为 `PollenForecast_v版本号_日期时间`
   - 示例：`PollenForecast_v1.0.2_20260110_143000`
   - ✅ **确认：操作的是备份目录，不是源目录**

2. **删除不需要的目录（⚠️ 只在备份副本中删除）**
   - ✅ **确认：当前在备份目录中，不是源目录**
   - ✅ **确认：源目录没有被修改**
   在新文件夹中删除以下目录：
   - `entry/build/` - 构建产物（可重新生成）
   - `oh_modules/` - 依赖包（DevEco Studio会自动安装）
   - `figma/` - 设计文件
   - `server/` - 服务器代码
   - `软著材料/` - 申请材料
   - `.claude/` - 文档目录
   - 根目录下所有 `.md` 文件 - 文档文件

3. **检查原项目配置（重要！）**
   
   ⚠️ **备份前先确保原项目配置完整**：
   - 检查根目录 `oh-package.json5` 是否包含 `modelVersion` 字段
   - 检查根目录 `hvigorfile.ts` 是否使用 `appTasks`（不是 `hapTasks`）
   - 如果原项目配置不完整，先修复原项目，再备份
   - 这样备份副本就能直接使用，不需要额外修复

4. **完成**
   - 现在这个副本只包含源代码和配置文件
   - 工程师可以用 DevEco Studio 直接打开运行
   - 打开项目后，依赖会自动安装

### 🚨 安全操作规则（必须遵守）

- ❌ **绝对禁止在源目录进行任何删除操作**
- ✅ **所有删除操作必须在备份副本中进行**
- ✅ **操作前必须确认当前目录是备份目录，不是源目录**
- ✅ **操作前必须确认源目录没有被修改**
- ✅ **优先使用文件管理器手动操作，避免使用脚本**

### ✅ 保留的文件（必须）

- `AppScope/` - 应用配置和资源
- `entry/src/main/` - 源代码和资源
- `entry/src/ohosTest/` - 测试代码（可选）
- `entry/build-profile.json5` - 构建配置
- `entry/oh-package.json5` - 依赖配置
- `entry/hvigorfile.ts` - 构建脚本
- `entry/obfuscation-rules.txt` - 混淆规则
- `build-profile.json5` - 根构建配置
- `oh-package.json5` - 根依赖配置（⚠️ **必须包含 `modelVersion` 字段，与 hvigor-config.json5 版本一致**）
- `code-linter.json5` - 代码检查配置
- `hvigor/` - 构建工具配置
- `hvigorfile.ts` - 根构建脚本（⚠️ **必须使用 `appTasks`，不是 `hapTasks`**）
- `.gitignore` - Git忽略规则（⚠️ **必须存在，避免Git根映射错误**）

### ❌ 删除的文件（不需要）

- `entry/build/` - 构建产物
- `entry/src/mock/` - Mock数据（可选）
- `entry/src/test/` - 单元测试（可选）
- `oh_modules/` - 依赖包（会自动安装）
- `figma/` - 设计文件
- `server/` - 服务器代码
- `软著材料/` - 申请材料
- `.claude/` - 文档目录
- 所有 `.md` 文件 - 文档文件
- `local.properties` - 本地配置

### 注意事项

- 依赖包（`oh_modules`）不复制，DevEco Studio 打开项目后会自动安装
- 构建产物（`entry/build`）不复制，可以重新构建
- 文档文件不复制，工程师只需要代码
- 副本大小通常只有原项目的 10-20%

---

## ☁️ GitHub备份规则

### 备份方式
通过 Git 提交和推送：`git commit` + `git push`

### ✅ 备份内容（必须确保这些文件都在Git中）

#### 1. 所有源代码和配置（核心文件）
- `AppScope/` - 应用配置和资源
- `entry/src/main/` - 源代码和资源
- `entry/src/ohosTest/` - 测试代码
- `entry/build-profile.json5` - 构建配置
- `entry/oh-package.json5` - 依赖配置
- `entry/hvigorfile.ts` - 构建脚本
- `entry/obfuscation-rules.txt` - 混淆规则
- `build-profile.json5` - 根构建配置
- `oh-package.json5` - 根依赖配置
- `code-linter.json5` - 代码检查配置
- `hvigor/` - 构建工具配置
- `hvigorfile.ts` - 根构建脚本

#### 2. `.claude/` 目录（⚠️ 重要！必须备份）
```
.claude/
├── CLAUDE.md                    # 项目指导文档（Cursor自动加载）
├── 问题记录.md
├── 开发日志.md
├── API17兼容性实施建议.md
├── 地图深浅色模式适配工单咨询.md
├── 地图配置信息速查.md
├── 工单内容_512字版.md
├── 工单内容_可直接复制.txt
├── 指导文件优化方案.md
└── 知识库/（如果有）
```

**安全检查**：运行 `git ls-files .claude/` 确认所有文件都在Git中

#### 3. 项目文档（重要文档）
- `README.md`（如果有）
- `TRAE_CN_SETUP.md`（如果有）
- `ICP备案指南.md`（如果有）
- 其他重要的 `.md` 文档

#### 4. 配置文件
- `.gitignore` - Git忽略规则（必须提交）
- `.github/` - GitHub配置（如果有）
- `PollenForecast.code-workspace` - 工作区配置（如果有）

### ❌ 不提交到GitHub（由.gitignore控制）

- `build/` - 构建产物
- `oh_modules/` - 依赖包
- `node_modules/` - Node依赖
- `local.properties` - 本地配置（敏感信息）
- `.idea/` - IDE配置
- `figma/` - 设计文件
- `server/` - 服务器代码
- `软著材料/` - 申请材料

### 🔍 GitHub备份安全检查清单

**每次重要操作前必须检查**：

- [ ] `.claude/CLAUDE.md` 在Git中（`git ls-files .claude/CLAUDE.md`）
- [ ] `.claude/问题记录.md` 在Git中
- [ ] `.claude/开发日志.md` 在Git中
- [ ] 所有源代码文件在Git中（`git ls-files entry/src/main/`）
- [ ] 所有配置文件在Git中（`git ls-files build-profile.json5`）
- [ ] `.gitignore` 正确配置，不会排除重要文件
- [ ] 最近有提交记录（`git log --oneline -5`）

### ⚠️ GitHub备份安全说明

1. **Git不会自动删除文件**
   - Git是版本控制系统，不会误删文件
   - 即使本地文件被删除，Git历史中仍然存在
   - 可以通过 `git checkout` 恢复

2. **`.claude/` 目录必须提交**
   - 这些文档是项目的重要资产
   - 必须确保在Git中，不能只依赖本地备份

3. **定期提交和推送**
   - 重要修改后立即提交
   - 每天结束前推送一次
   - 确保远程仓库是最新的

---

## ⏰ 备份时机

### 必须备份的情况

1. **版本发布前**
   - 例如：v1.0.1 → v1.0.2

2. **重大代码修改前**
   - API升级（如 API 17 → API 20）
   - 架构调整
   - 核心功能重构

3. **问题修复前**
   - 修复重要bug前
   - 避免回退困难

4. **文档整理前**
   - 整理 `.claude/` 文档前
   - 迁移内容前

### 建议备份的情况

- 每日开发结束前（可选）
- 完成重要功能后
- 解决复杂问题后

---

## 📝 备份执行步骤

### 本地备份步骤

1. **复制整个项目文件夹**到 `C:\HarmonyOS_App_Plans\.claude\backup\` 目录
2. **重命名**为 `PollenForecast_v版本号_日期时间`
   - 格式：`PollenForecast_v版本号_YYYYMMDD_HHMMSS`
   - 示例：`PollenForecast_v1.0.2_20260110_143000`
3. **删除**不需要的目录（`build/`、`oh_modules/`、`figma/`、`server/`、`.claude/`、`.md`文件等）
4. **完成** - 既是备份也是demo，可直接打开运行

### GitHub备份步骤

1. **检查Git状态**
   ```bash
   git status
   ```

2. **添加文件**
   ```bash
   git add .
   # 或选择性添加
   git add AppScope/ entry/src/ .claude/ build-profile.json5 oh-package.json5
   ```

3. **提交**
   ```bash
   git commit -m "backup: 版本号_日期_备份说明"
   ```

4. **推送到GitHub**
   ```bash
   git push origin main
   ```

---

## 🔍 备份验证清单

### 本地备份验证

- [ ] `AppScope/app.json5` 存在
- [ ] `entry/src/main/ets/` 目录存在且包含所有 .ets 文件
- [ ] `entry/src/main/resources/` 资源文件完整
- [ ] `entry/build-profile.json5` 存在
- [ ] `entry/oh-package.json5` 存在
- [ ] `build-profile.json5` 存在
- [ ] `oh-package.json5` 存在
- [ ] 不包含 `build/`、`oh_modules/`、`node_modules/` 等目录

### GitHub备份验证

- [ ] `.claude/CLAUDE.md` 已提交
- [ ] 源代码文件已提交
- [ ] 配置文件已提交
- [ ] 提交信息清晰（包含版本号和日期）
- [ ] 已推送到远程仓库

---

## 📊 备份记录

### 备份历史记录格式

```
## 备份记录

### 2026-01-10 14:30:00 - v1.0.2
- **本地备份**: `.claude/backup/PollenForecast_v1.0.2_20260110_143000/`
- **GitHub备份**: commit `abc1234` - "backup: v1.0.2_20260110_代码备份"
- **备份原因**: 版本发布前备份
- **备份内容**: 核心代码 + 配置文件
```

---

## ⚠️ 注意事项

1. **本地备份不包含 `.claude/`**
   - `.claude/` 目录只通过 GitHub 备份
   - 避免本地重复备份造成内存浪费

2. **不备份构建产物**
   - `build/`、`oh_modules/` 等可通过命令重新生成
   - 备份这些会浪费大量空间

3. **敏感信息不备份**
   - `local.properties` 包含本地路径等敏感信息
   - 不应提交到 Git 或备份

4. **备份命名规范**
   - 使用统一的命名格式
   - 包含版本号和精确时间戳
   - 便于查找和恢复

5. **定期清理旧备份**
   - 本地保留最近 10 个版本备份
   - GitHub 保留完整历史（终极备份）
   - ⚠️ **删除本地旧备份前必须检查**：
     1. 运行 `git log --oneline -20` 确认 GitHub 有对应 commit
     2. 运行 `git status` 确认远程已推送
     3. 确认后才能删除本地旧备份

---

## 📄 文档清理规则

### 清理原则
- 删除过时文档前，确认文件是否在 Git 中（`git ls-files 文件名`）
- 如在 Git 中：可直接删除，必要时从历史恢复
- 如不在 Git 中：先复制到 backup/ 再删除

### 可清理的文档类型
- ❌ 已完成的任务计划（如 `XXX修复计划_v1.md`）
- ❌ 文件名与内容不符的文档
- ❌ 已有新版本替代的旧版本
- ❌ 功能已实现的临时计划文档

### 不可清理的文档
- ✅ 任务模板文件（`任务_*.md`）
- ✅ 知识库文件（`知识库*.md`、`知识库/`）
- ✅ 历史经验记录（`事故复盘_*.md`）
- ✅ 操作规范文件（`备份规则.md`）

### 会话结束总结时必做
1. 更新 `PollenForecast/.claude/CLAUDE.md`（项目进度、关键文件）
2. 更新 `.claude/知识库.md`（如有新增已验证知识）
3. 创建 AI 记忆（方便新会话继续）
4. 检查备份目录数量，超过10个时清理旧备份

6. **🚨 安全操作规则（必须遵守）**
   - ❌ **禁止在源目录进行任何删除操作**
   - ✅ **所有删除操作必须在备份副本中进行**
   - ✅ **操作前必须验证目标路径正确性**
   - ✅ **优先使用文档说明，避免使用脚本**
   - ✅ **先备份，再操作** - 这是铁律

---

## 🔄 恢复步骤

### 从本地备份恢复

1. 找到对应的备份目录
2. 复制备份文件到项目目录
3. 运行 `ohpm install` 恢复依赖
4. 运行构建命令验证

### 从GitHub恢复

1. 使用 `git log` 找到对应的提交
2. 使用 `git checkout <commit-hash>` 恢复
3. 或使用 `git revert` 回退

---


## 📌 快速参考

### 本地备份操作清单
1. 复制项目文件夹到 `.claude/backup/` 目录
2. 重命名为 `PollenForecast_v版本号_日期时间`
3. 删除 `build/`、`oh_modules/`、`figma/`、`server/`、`.claude/`、`.md` 文件
4. **修复配置**：
   - 检查 `oh-package.json5` 是否包含 `modelVersion: "6.0.0"`
   - 检查根目录 `hvigorfile.ts` 是否使用 `appTasks`（不是 `hapTasks`）
5. **添加 `.gitignore`**：避免Git根映射错误
6. 完成 - 既是备份也是demo

### GitHub备份特殊文件
```
.claude/CLAUDE.md          # Cursor自动加载
.claude/问题记录.md
.claude/知识库.md
.claude/知识库/
```

---

**最后更新**: 2026-01-10（统一为项目副本备份方式 + 增加安全检查规则 + 添加常见问题章节）  
**维护者**: AI Assistant  
**事故复盘**: 见 `事故复盘_20260110.md`  
**已知问题**: 备份副本需要修复 `oh-package.json5` 的 `modelVersion` 和添加 `.gitignore`（已在操作步骤中说明）
