# 开发日志

> **项目**: PollenForecast（花粉浓度播报）  
> **最后更新**: 2026-01-08  
> **返回**: [← CLAUDE.md](./CLAUDE.md)

---

## 📋 日志说明

本文件记录项目的详细开发历史，按时间倒序排列。当前状态和关键信息请查看 `CLAUDE.md`。

---

## 2026-01-08

### 地图深浅色模式适配工单准备 + API 17 兼容性问题分析

1. **🗺️ 地图深浅色模式适配工单准备**
   - 整理地图配置信息（Map Kit API Key: 1783644396122594176）
   - 整理环境信息（SDK版本、应用版本、配置位置）
   - 创建工单咨询文档（512字版本，符合工单系统限制）
   - 创建快速参考文档和可直接复制版本

2. **🔧 API 17 兼容性问题分析**
   - 问题：API 17设备安装HAP时提示"code:9568297 error: install failed due to older sdk version in the device"
   - 错误理解：最初错误地尝试降级SDK版本（5.0.0(17)）
   - 正确理解：设备镜像版本低于编译SDK版本，应更新设备镜像版本
   - 正确方案：
     - 保持 `targetSdkVersion` 为 `6.0.0(20)`（使用最新特性）
     - 代码层面已做API 17兼容性处理（ApiVersionUtils、MapView事件监听兼容）
     - 推荐更新设备镜像版本到最新
   - 查询设备镜像版本命令：`hdc shell param get const.ohos.apiversion`

3. **📚 文档更新**
   - 更新 `问题记录.md` 记录API 17兼容性问题分析
   - 更新 `CLAUDE.md` 当前状态

### 错别字修复 + ArkTS语法错误修复

1. **🐛 错别字修复**
   - `ReminderService.ets`: "稀后提醒" → "稍后提醒"（4处）

2. **🔧 ArkTS 语法错误修复**
   - `LocationService.ets`: 修复对象字面量类型错误
   - 添加 `AddressInfo` 接口替代 `{ city: string, address: string }`
   - 错误码: `arkts-no-obj-literals-as-types` / `arkts-no-untyped-obj-literals`

3. **📚 知识库更新**
   - 追加对象字面量类型禁止规则到 `知识库/ArkTS语法.md`

---

## 2026-01-07

### 定时提醒功能修复（第2轮）

1. **🔔 定时提醒通知配置完善**
   - 添加 `slotType: SOCIAL_COMMUNICATION` → 横幅+声音+震动
   - 添加 `actionButton` → 稍后提醒/关闭按钮
   - 添加 `wantAgent` → 点击通知打开应用
   - 添加 `notificationId` → 固定通知ID
   - 修复 `cancelAllReminders()` → 使用 `getValidReminders()` + 逐个取消

2. **🔐 权限动态申请**
   - `EntryAbility.ets` 新增 `requestReminderPermission()` 方法
   - 应用启动时自动申请 `PUBLISH_AGENT_REMINDER` 权限

3. **❌ 锁屏卡片**
   - 普通应用无法申请，不做此功能

### 定时提醒功能修复（第1轮）

1. **🎉 定时提醒功能修复**（AppGallery 审核问题解决）
   - 发现 `reminderAgentManager` 正确导入方式：`@kit.BackgroundTasksKit`
   - 创建 `ReminderService.ets` - 代理提醒服务
   - 权限：`ohos.permission.PUBLISH_AGENT_REMINDER`

---

## 2026-01-06

### 多服务器故障转移架构 + DynamoDB 缓存

**功能实现**: 多服务器故障转移架构，提高花粉数据获取稳定性

**背景**:
- 单服务器架构不稳定（阿里云 512MB 内存容易 OOM）
- 需要多服务器冗余，保证服务可用性
- 减少 Google API 调用次数（控制在免费额度内）

**实施内容**:
1. ✅ **DynamoDB 表创建**
   - 表名: `pollen_cache`
   - 分区键: `cache_key` (String)
   - TTL: `expire_time` (Number, 30分钟)
   - 区域: ap-northeast-1 (东京)

2. ✅ **Lambda 东京（主服务器）**
   - 功能: 每30分钟调用 Google API + 写入 DynamoDB
   - 缓存: 内存缓存 + DynamoDB（双重缓存）
   - URL: `https://g7d8o7pf5b.execute-api.ap-northeast-1.amazonaws.com/default/pollen-api`
   - 优先级: 1

3. ✅ **Lambda 新加坡（副服务器）**
   - 功能: DynamoDB 读取 + 兜底调用 Google API
   - URL: `https://8de0lncs7f.execute-api.ap-southeast-1.amazonaws.com/default/pollen-api-singapore`
   - 优先级: 2

4. ✅ **阿里云服务器（只读）**
   - 功能: 只读 DynamoDB，不调用 Google API
   - 内存占用: ~50MB（比原来减少 75%）
   - 技术栈: Node.js v18.20.8 + Express + AWS SDK + PM2
   - 优先级: 3

5. ✅ **客户端代码更新**
   - `PollenService.ets`: 调整服务器优先级
   - 故障转移逻辑: 主服务器失败 → 自动切换副服务器 → 只读服务器

6. ✅ **版本更新**
   - versionCode: 1000003 → 1000004
   - versionName: 1.0.2

**技术要点**:
- ✅ DynamoDB TTL 自动清理过期数据
- ✅ Lambda 内存缓存（容器复用）
- ✅ 主从服务器数据同步（通过 DynamoDB）
- ✅ 阿里云简化版（只读，节省内存）
- ✅ IAM 用户只读权限（最小权限原则）

**请求次数优化**:
- 主服务器: ~1440 次/月（30分钟缓存）
- 副服务器: 0 次/月（从 DynamoDB 读取）
- 只读服务器: 0 次/月（从 DynamoDB 读取）
- **总计**: ~1440 次/月（远低于 5000 免费额度）

**修改的文件**:
- `entry/src/main/ets/service/PollenService.ets` - 服务器优先级调整
- `AppScope/app.json5` - 版本号更新
- `server/lambda-tokyo-pollen-api.py` - **新增** Lambda 东京代码
- `server/lambda-singapore-pollen-api.py` - **新增** Lambda 新加坡代码
- `server/aliyun-pollen-api-simple-en.js` - **新增** 阿里云简化版代码

### 用户可选择的多数据源架构

**功能实现**: 用户可根据需求选择不同的花粉数据源

**背景**:
- 用户希望可以选择不同的数据源提供商
- 不同数据源有不同的覆盖范围和准确性
- 需要支持 Google Pollen API、中国气象局、和风天气等

**实施内容**:
1. ✅ **数据源模型创建**
   - `PollenDataSource.ets`: 数据源枚举和配置
   - 支持 AUTO、GOOGLE、CMA、QWEATHER 四种类型
   - 每个数据源包含名称、描述、覆盖范围等信息

2. ✅ **数据源适配器接口**
   - `PollenDataSourceAdapter.ets`: 定义适配器接口
   - `IPollenDataSourceAdapter`: 统一的数据源接口
   - 为后续实现各数据源适配器做准备

3. ✅ **PollenService 更新**
   - 支持根据用户选择调用对应数据源
   - AUTO 和 GOOGLE 使用现有的多服务器故障转移
   - CMA 和 QWEATHER 预留接口（待实现）

4. ✅ **AppStorage 初始化**
   - 在 `EntryAbility` 中添加 `pollenDataSource` 默认值 `'AUTO'`

5. ✅ **设置页面 UI**
   - `GeneralSettingsPage.ets`: 添加数据源选择器
   - 显示可用数据源列表（名称 + 描述）
   - 选中状态显示 ✓
   - 切换时震动反馈 + Toast 提示

**技术要点**:
- ✅ 用户选择式架构（非数据融合）
- ✅ 数据源配置化，易于扩展
- ✅ 适配器模式，统一接口
- ✅ AppStorage 持久化用户选择

**当前状态**:
| 数据源 | 状态 | 说明 |
|--------|------|------|
| 自动选择 | ✅ 可用 | 默认选项，使用 Google Pollen API |
| Google Pollen API | ✅ 可用 | 使用现有的多服务器故障转移 |
| 中国气象局 | ⏳ 待实现 | 已预留接口 |
| 和风天气 | ⏳ 待实现 | 已预留接口 |

**修改的文件**:
- `entry/src/main/ets/model/PollenDataSource.ets` - **新增** 数据源模型
- `entry/src/main/ets/service/PollenDataSourceAdapter.ets` - **新增** 适配器接口
- `entry/src/main/ets/service/PollenService.ets` - 支持用户选择的数据源
- `entry/src/main/ets/entryability/EntryAbility.ets` - 初始化数据源设置
- `entry/src/main/ets/pages/GeneralSettingsPage.ets` - 添加数据源选择器 UI

---

## 2026-01-05

### API 17 兼容性改造

**功能实现**: 支持 API 17 (HarmonyOS 5.0) 设备运行

**背景**:
- 客户反馈 API 版本过高导致无法安装
- 需要降级到 API 17 以适配更多原生鸿蒙设备

**实施内容**:
1. ✅ **创建 API 版本检测工具类**
   - 文件: `entry/src/main/ets/utils/ApiVersionUtils.ets`
   - 功能: `getApiVersion()`, `isAPI20()`, `supportsGripDetection()`, `supportsMapEventManager()`

2. ✅ **MapView.ets 事件监听兼容**
   - API 20+: 使用 `MapEventManager`
   - API 17-19: 尝试 `controller.on()` 事件监听（CodeGenie 方案）
   - 智感握姿: API 版本不支持时跳过初始化

3. ✅ **GeneralSettingsPage.ets UI 降级**
   - 智感握姿开关: API 17 设备显示灰色不可用
   - 添加"需升级"标签
   - 点击时显示升级提示 Toast

**技术要点**:
- ✅ `deviceInfo.sdkApiVersion` 获取 API 版本（已验证）
- ✅ 静态导入 + 条件判断包裹使用（无需动态 import）
- ✅ API 17 会自动忽略未识别权限（如 DETECT_GESTURE）
- ✅ Toggle 禁用状态下不触发 onChange，需用事件委托

**待验证**:
- ⏳ API 17 设备上 `controller.on()` 是否可用
- ⏳ `animateCamera()` 是否需要坐标转换
- ⏳ `snippet` 属性是否有效

**修改的文件**:
- `entry/src/main/ets/utils/ApiVersionUtils.ets` - **新增**
- `entry/src/main/ets/views/MapView.ets` - 事件监听兼容
- `entry/src/main/ets/pages/GeneralSettingsPage.ets` - 智感握姿 UI 降级

**Git 提交**: `d977351` - feat: Add API 17 compatibility - version detection and event listener fallback

---

## 2025-12-29

### 状态栏字体颜色修复 + UI 清晰度优化

**问题背景**:
1. 浅色模式下状态栏字体显示灰色，不够清晰（之前是纯黑）
2. 浅色模式页面整体显得"雾蒙蒙的"，对比度不足
3. 深色模式切换到浅色模式后，状态栏图标不立即更新

**根本原因**（CodeGenie 验证）:
- **优先级规则错误认知**: 之前专家错误建议移除 `statusBarContentColor`
- **正确优先级**: `statusBarContentColor` > `isStatusBarLightIcon`（CodeGenie 2025-12-29 确认）
- **移除后果**: 字体颜色依赖系统默认逻辑，可能显示为灰色
- **透明度问题**: 95% 不透明度会透出底层 `#F1F3F5` 页面背景，叠加后显得灰蒙

**解决方案**:
1. ✅ **恢复 statusBarContentColor 参数**
   - 浅色模式: `statusBarContentColor: '#000000'`（纯黑）
   - 深色模式: `statusBarContentColor: '#FFFFFF'`（纯白）
   - 必须同时设置 `isStatusBarLightIcon`

2. ✅ **修复主题切换异步问题**
   - `updateStatusBarForTheme()` 接受可选 `colorMode` 参数
   - 优先使用传入值，避免读取 `context.config.colorMode` 的旧值
   - `onConfigurationUpdate()` 提取 `newColorMode` 并传递

3. ✅ **导航栏透明度优化**
   - base/color.json: `navbar_background` 从 `#CCFFFFFF`（80%）改为 `#FFFFFFFF`（100%）
   - dark/color.json: `navbar_background` 从 `#DD000000`（87%）改为 `#FF000000`（100%）
   - 消除"雾蒙蒙"效果，提升清晰度

4. ✅ **Tabs 组件背景配置优化**
   - Index.ets: `barBackgroundColor` 改为 `$r('app.color.navbar_background')`
   - TabBuilder 背景改为 `Color.Transparent`，避免与主背景叠加

5. ✅ **MapView 主题适配**
   - Stack 添加 `.backgroundColor($r('app.color.page_background'))`
   - 确保地图页适应系统主题（深色模式不再白色）

6. ✅ **震动和智感握姿默认关闭**
   - GeneralSettingsPage.ets: `vibrationEnabled` 和 `gripDetectionEnabled` 改为 `false`
   - MapView.ets: 两个开关默认值改为 `false`
   - VibrationUtils.ets: 所有方法默认值改为 `false`
   - RegionView.ets: `vibrationEnabled` 改为 `false`

**修改的文件**:
- `EntryAbility.ets` - 恢复 statusBarContentColor + 参数传递优化
- `Index.ets` - Tabs 背景配置优化
- `MapView.ets` - 添加背景色 + 震动默认关闭
- `base/element/color.json` - navbar_background 改为 100% 不透明
- `dark/element/color.json` - navbar_background 改为 100% 不透明
- `GeneralSettingsPage.ets` - 震动和握姿默认关闭
- `VibrationUtils.ets` - 所有震动方法默认 false
- `RegionView.ets` - 震动默认关闭

**技术要点**:
- `statusBarContentColor` 在 API 20 仍然有效且优先级最高（纠正专家错误建议）
- 状态栏参数必须同时设置两个：`statusBarContentColor` + `isStatusBarLightIcon`
- 异步 API 调用需传递参数，避免读取过期的上下文状态
- 导航栏透明度影响视觉清晰度，100% 不透明更清晰

**用户体验提升**:
- ✅ 浅色模式状态栏字体纯黑，清晰易读
- ✅ 页面整体清晰度提升，无灰蒙感
- ✅ 主题切换立即生效，无延迟
- ✅ 震动和握姿功能默认关闭，避免打扰用户

**知识库更新**:
- 追加"状态栏/导航栏配置（API 20）"完整技术文档到全局知识库
- 记录 CodeGenie 验证的优先级规则和常见错误

---

## 2025-12-13

### 通知设置 - 播报时间选择器 ⏰

**功能实现**: 通知设置页面添加时间选择器

**背景**:
- 用户点击"播报时间"时显示 "时间选择功能开发中"
- 需要实现真实的时间选择功能

**实现方案**: 使用 HarmonyOS `TimePickerDialog` 组件

✅ **完成内容**:
1. 移除临时 Toast 提示 "时间选择功能开发中"
2. 添加 `showTimePickerDialog()` 方法
   - 解析当前时间（格式: "08:00"）
   - 调用 `TimePickerDialog.show()`
   - 用户选择时间后格式化为 HH:mm
   - 保存到 AppStorage 持久化
3. 添加用户反馈：
   - 中等震动反馈（选择完成后）
   - Toast 提示 "播报时间已设置为 XX:XX"
4. 日志输出方便调试

**技术要点**:
- `TimePickerDialog.show()` - 系统时间选择器
- `selected: new Date(2024, 0, 1, hour, minute)` - 只关心时分
- `value.hour.toString().padStart(2, '0')` - 补零格式化
- `AppStorage.setOrCreate('dailyReportTime', time)` - 持久化保存

**用户体验**:
- ✅ 点击"播报时间" → 弹出系统时间选择器
- ✅ 滚动选择小时和分钟
- ✅ 点击确认 → 震动 + Toast 提示
- ✅ 时间立即更新到界面（绿色显示）

**修改的文件**:
- `entry/src/main/ets/pages/NotificationSettingsPage.ets`
  - Line 23-60: 添加 showTimePickerDialog() 方法
  - Line 230: onClick 调用时间选择器

### 用户体验优化 - 加载状态可视化 ✨

**问题背景**:
1. 位置信息刷新给用户"很久"的感觉（实际 2-5 秒）
   - 只有静态文字 "定位中..."，无加载动画
   - GPS 定位期间界面静止，用户以为卡死了
2. 切换城市后没有互动反馈
   - 跳转首页后看不到新城市数据加载过程
   - 缺少 "正在加载 XXX市 数据" 提示

**解决方案**: 实施加载状态可视化（基于 CodeGenie 建议）

✅ **完成内容**:
1. 添加 `@State loadingCity: string = ''` 状态
2. 修改 `onCityChange()` 方法，设置 loadingCity 和 isLoading
3. UI 显示优先级逻辑：
   - **场景1** (isLocating): `LoadingProgress + "定位中..."`
   - **场景2** (loadingCity !== ''): `LoadingProgress + "正在加载 XXX市 数据..."`
   - **场景3** (正常): `城市名 + 下拉刷新小图标(isLoading)`
4. 数据加载完成后清空 loadingCity 状态

**技术实现**:
- LoadingProgress 组件尺寸：16x16（定位/加载），14x14（刷新）
- 颜色：`$r('app.color.icon_primary')`
- 文字颜色：`$r('app.color.text_secondary')`（加载中），`$r('app.color.text_primary')`（正常）

**用户体验提升**:
- ✅ 定位中有视觉反馈（转圈动画）
- ✅ 切换城市明确显示加载状态
- ✅ 下拉刷新不干扰城市名显示
- ✅ 无障碍支持完善

**修改的文件**:
- `entry/src/main/ets/views/PollenIndexView.ets`
  - Line 36: 添加 loadingCity 状态
  - Line 137-144: 修改 onCityChange()
  - Line 178: 数据加载成功后清空 loadingCity
  - Line 277: 加载失败后清空 loadingCity
  - Line 387-428: UI 显示逻辑优化

### 和风天气 API 代理部署成功 🌐

**背景问题**:
- WeatherService.ets 中 API Key 直接暴露在客户端代码（安全隐患）
- 原计划部署 Google Pollen API 代理到广州服务器，但服务器无法访问 Google

**解决方案**: 部署和风天气 API 代理到百度云广州服务器

✅ **完成步骤**:
1. 创建 `qweather-proxy.js` - 和风天气 API 代理服务
2. 安装 Node.js v20.19.6 + PM2 进程管理器
3. 安装依赖: express, axios, node-cache
4. 配置开机自启: systemctl enable pm2-root
5. 百度云控制台开放 3000 端口

✅ **API 测试结果** (2025-12-13 10:08):
| 接口 | 状态 | 示例数据 |
|------|------|----------|
| `/health` | ✅ | 服务器: 广州百度云 - 和风天气代理 |
| `/weather/now` | ✅ | 广州 19°C, 阴, 湿度86% |
| `/weather/7d` | ✅ | 7天预报数据完整 |
| `/astronomy/sun` | ✅ | 日出07:00, 日落17:44 |

**技术要点**:
- 使用和风天气个人版 API Host: `me7h2r64qx.re.qweatherapi.com`
- 15分钟缓存减少API调用
- PM2 守护进程 + 开机自启
- CORS 允许跨域请求

**下一步**:
- ✅ **已完成** (2025-12-13): 修改 WeatherService.ets，使用代理服务器
  - API Base URL: `https://me7h2r64qx.re.qweatherapi.com/v7` → `http://106.12.143.105:3000`
  - 移除客户端硬编码 API Key: `3e369ec38fd04c17bf786d8468e969ea`
  - 3天预报改为7天预报: `/weather/3d` → `/weather/7d`

**修改的文件**:
- 新增 `server/qweather-proxy.js` - 和风天气代理服务
- 修改 `entry/src/main/ets/service/WeatherService.ets` - 使用代理服务器

---

## 2025-12-12

### Map Kit 正确初始化 - MapsInitializer 🔑

**问题背景**:
- 尝试使用 `map.setApiKey()` 和 `mapOptions.apiKey` 均编译失败
- CodeGenie 指出需要使用 **`MapsInitializer`** 类进行初始化

**CodeGenie 关键指导**:
1. **必须使用 `MapsInitializer` 初始化 Map Kit**
2. **在 `EntryAbility.onCreate()` 中设置 API Key**
3. **权限请求应在 `onWindowStageCreate()` 而非 `onCreate()`**

**解决方案**:
✅ **在 EntryAbility 中正确初始化 Map Kit**:
```typescript
import { MapsInitializer } from '@kit.MapKit';

onCreate() {
  // 1. 初始化 MapsInitializer
  MapsInitializer.initialize(this.context);
  
  // 2. 设置明文 API Key
  MapsInitializer.setApiKey('17EA94E3728228DDAB62B445ECD97129A90D3C0EB5F86F66D961D3EC03A531B2');
}

onWindowStageCreate(windowStage: window.WindowStage) {
  // 3. 在窗口创建阶段请求权限（修正生命周期）
  this.requestLocationPermissions();
}
```

✅ **增强权限请求日志**:
- 添加详细日志输出验证权限请求是否执行
- 使用 emoji 标记成功/失败状态

**修改文件**:
- `entry/src/main/ets/entryability/EntryAbility.ets`

**技术要点**:
- **初始化顺序**: `MapsInitializer.initialize()` → `MapsInitializer.setApiKey()` → 使用 MapComponent
- **密钥优先级**: 显式调用 setApiKey() > AGC 配置文件 > metadata 声明
- **生命周期修正**: 权限请求在 `onWindowStageCreate` 执行，避免窗口未创建导致失败

### 设置页弹窗修复 - CustomDialog 方案 ✨

**问题背景**:
- 统一弹窗风格：将"关于"和"隐私政策"从系统对话框改为底部半屏弹窗（bindSheet）
- bindSheet 实现后"关于"和"隐私政策"弹窗瞬间崩溃（onWillAppear 后 1-2ms 就 onWillDisappear）
- 尝试了多种修复方案（删除高度冲突、调整 Scroll 结构、添加 layoutWeight 等）均失败

**解决方案**: 改用 **CustomDialog** 替代 bindSheet

**完成功能**:
1. ✅ **关于弹窗** - 使用 CustomDialog 居中显示
   - 应用图标、名称、版本信息
   - 应用介绍文字
   - 开发者和数据来源信息
   - 版权声明
   - 85% 宽度、圆角 16、居中对齐

2. ✅ **隐私政策弹窗** - 使用 CustomDialog 底部对齐
   - 标题和更新日期
   - 7 条隐私条款（可滚动）
   - 联系邮箱和版权信息
   - 90% 宽度、80% 高度、圆角 16
   - 内容区 60% 高度滚动、显示滚动条

3. ✅ **反馈建议弹窗** - 保留 bindSheet（正常工作）
   - 邮箱显示和复制功能

**技术要点**:
- CustomDialogController 延迟初始化，避免 `safeBottom` 初始化顺序问题
- CustomDialog 不传递实例变量作为参数
- `@CustomDialog` 装饰器 + `CustomDialogController` 控制显示/隐藏
- `alignment: DialogAlignment.Center/Bottom` 控制弹窗位置
- `customStyle: true` 启用自定义样式
- `autoCancel: true` 点击外部自动关闭

**bindSheet 失败原因分析** (未最终确认):
- 可能与 Scroll + layoutWeight + Builder 调用其他 Builder 的组合有关
- 日志显示 "radius is not correct type" 和 "Bottom offset invalid"
- 但这些错误在正常工作的反馈建议弹窗中也存在

**修改的文件**:
- `SettingsView.ets` - 删除 bindSheet 相关代码，添加 CustomDialog 组件
  - 删除 `@State showAboutSheet` 和 `showPrivacySheet`
  - 添加 `aboutDialogController` 和 `privacyDialogController`
  - 删除 `AboutSheetBuilder`、`AboutInfoRow`、`PrivacySheetBuilder`、`PrivacySection` Builder
  - 添加 `@CustomDialog AboutDialog` 和 `PrivacyDialog` 组件
  - 添加独立的 `PrivacySection` 组件

**收获**:
- ✅ CustomDialog 比 bindSheet 更简单、更可控、更容易调试
- ✅ 避免了 bindSheet 复杂的布局规则和限制
- ✅ 完全自定义样式和交互逻辑
- ⚠️ bindSheet 适合简单内容，复杂布局建议用 CustomDialog

---

## 2025-12-17

### 沉浸式状态栏适配

**完成功能**:
1. ✅ **导航栏颜色方案优化** - 浅色半透明背景（适配深色状态栏图标）
   - PollenIndexView.ets: 导航栏背景改为 `$r('app.color.navbar_background')`
   - 边框颜色改为 `$r('app.color.navbar_border')`
   - 浅色模式: `#CCFFFFFF` (80% 不透明度白色)
   - 深色模式: `#CC1A1A1A` (80% 不透明度深灰)

2. ✅ **状态栏图标颜色优化** - 根据背景色选择合适的图标颜色
   - EntryAbility.ets: 浅色模式状态栏内容颜色改为 `#1F1F1F` (深色)
   - 深色模式: 保持白色图标 `#FFFFFF`
   - 确保状态栏信息在浅色导航栏背景上可读

3. ✅ **全页面适配验证** - 所有页面都正确使用 safeTop/expandSafeArea
   - PollenIndexView: 使用固定顶部导航栏 + position 定位
   - RegionView/SettingsView: 使用 `Blank().height(this.safeTop)` 占位
   - MapView: 使用 `position({ y: this.safeTop + 12 })` 定位卡片

**修改的文件**:
- `EntryAbility.ets` - 浅色模式状态栏图标颜色改为深色（#1F1F1F）
- `PollenIndexView.ets` - 导航栏背景使用颜色资源（navbar_background/navbar_border）

**设计原则**:
- ✅ 沉浸式一体化设计：内容延伸到状态栏下方，背景统一
- ✅ 状态栏图标易读性：浅色背景使用深色图标，深色背景使用白色图标
- ✅ 避免左右色差：导航栏使用纯色半透明背景，不使用对比色分区

---

## 2025-12-11

### 花粉主题色系统 + 状态栏优化

**完成功能**:
1. ✅ **状态栏完全透明化** - 解决深浅色模式颜色割裂问题
   - EntryAbility: statusBarColor 改为 `#00000000`
   - 浅色模式导航栏: `#CCFFFFFF` (80%不透明度)
   - 深色模式导航栏: `#CC1A1A1A`

2. ✅ **花粉浓度主题色系统** - 全局颜色随花粉等级变化
   - AppStorage 创建 `pollenThemeColor` 全局状态
   - Tab栏选中态（图标+文字）绑定主题色
   - 花粉圆环颜色绑定主题色
   - 5天趋势柱状图绑定主题色
   - 全年趋势高峰期颜色绑定主题色
   - 天气图标颜色绑定主题色
   - 区域页箭头/置顶图标/收藏按钮绑定主题色

**颜色映射** (来自 levelToColor):
| 花粉等级 | 颜色 |
|---------|------|
| NONE | `#4CAF50` 绿色 |
| VERY_LOW | `#8BC34A` 浅绿 |
| LOW | `#CDDC39` 黄绿 |
| MODERATE | `#FFC107` 黄色 |
| HIGH | `#FF9800` 橙色 |
| VERY_HIGH | `#F44336` 红色 |

**修改的文件**:
- `EntryAbility.ets` - 状态栏透明化 + pollenThemeColor初始化
- `Index.ets` - Tab选中态绑定主题色
- `PollenIndexView.ets` - 圆环/趋势图/天气图标绑定主题色
- `RegionView.ets` - 箭头/按钮绑定主题色
- `base/element/color.json` - navbar_background改为#CCFFFFFF
- `dark/element/color.json` - navbar_background改为#CC1A1A1A

### 下拉刷新 + 布局重构

**完成功能**:
1. ✅ **首页下拉刷新** - Refresh组件
2. ✅ **区域页下拉刷新** - 快速刷新距离 + 静默GPS定位
3. ✅ **首页布局重构** - Stack改Column（解决刷新指示器被遮挡）
4. ✅ **刷新机制优化** - 天气先返回结束动画，花粉静默后台更新

**知识点已收录到知识库**:
- Refresh下拉刷新与导航栏布局最佳实践
- 刷新机制优化（快速响应+静默后台）

### 冬季体验优化

**完成功能**:
1. ✅ **Swiper三页数据展示** - 5天预报 + 本月统计 + 全年回顾
2. ✅ **防护指南智能切换** - 花粉季/非花粉季不同内容
3. ✅ **长按预览交互** - 220ms触发 + 震动反馈
4. ✅ **反馈建议底部弹窗** - SettingsView
5. ✅ **首屏无障碍适配** - accessibilityText

### 代码恢复与稳定

**问题经过**:
1. 尝试实施"冬季非花粉季用户体验优化"功能
2. 代码修改过程中结构被严重破坏，产生128个编译错误
3. 多次尝试修复失败，错误数降至82个但仍无法构建
4. 最终决定使用 Git 恢复到稳定版本

**恢复操作**:
```powershell
git checkout HEAD -- entry/src/main/ets/views/PollenIndexView.ets
git checkout HEAD -- entry/src/main/ets/views/RegionView.ets
git checkout HEAD -- entry/src/main/ets/views/SettingsView.ets
git checkout HEAD -- entry/src/main/ets/pages/Index.ets
git checkout HEAD -- entry/src/main/ets/pages/GeneralSettingsPage.ets
git checkout HEAD -- entry/src/main/resources/base/element/color.json
git checkout HEAD -- entry/src/main/resources/dark/element/color.json
```

**结果**: ✅ 构建成功，UI恢复正常

**经验教训**:
- ArkTS严格模式：不支持 `Record` 内联对象类型，需使用 `Map<string, Interface>`
- 接口定义必须在类外部独立声明
- 大幅代码修改前应先备份
- Git 是重要的安全网

---

## 2025-12-07

### 设置与区域功能优化

**完成功能**:
1. ✅ **AlertDialog API 迁移**: `AlertDialog.show()` → `promptAction.showDialog()`
2. ✅ **隐藏"给我们评分"按钮**: SettingsView.ets 中注释该功能
3. ✅ **收藏夹改为当前城市**: RegionView.ets 显示当前选择的城市
4. ✅ **删除长按收藏提示**: 移除"长按可收藏城市"文字
5. ✅ **城市列表滑动操作**: 实现左滑显示"收藏/取消收藏/置顶"按钮
6. ✅ **收藏城市特殊显示**: 置顶(📌金色)、收藏(⭐橙色)、普通(▶)
7. ✅ **收藏城市固定前排**: 列表排序：置顶 > 收藏 > 普通
8. ✅ **通用设置页面 UI**: 创建 GeneralSettingsPage.ets（震动开关 + 外观模式）
9. ✅ **震动功能实现**: 使用 `vibrator.startVibration` + 权限配置
10. ✅ **主题切换功能实现**: 使用 `ApplicationContext.updateConfiguration` + 资源文件适配 (`$r`)
11. ✅ **震动调试**: 添加 Toast 提示以确认代码执行

---

## 2025-12-05

### API集成

- **Cloudflare Worker**: 部署成功，但国内手机无法访问（超时）
- **数据模型**: 简化 PollenModels.ets，使用 if-else 替代 Record
- **服务层**: 简化 PollenService.ets
- **View集成**: 更新 PollenIndexView.ets 调用API

### UI基础

- **项目创建**: 在 DevEco Studio 中创建 PollenForecast 项目
- **环境配置**: SDK 6.0.0 (API 20), Stage 模型
- **4Tab页面**: 完成首页/区域/地图/设置基础UI和动画
- **安全距离**: 解决TabBar底部安全距离适配问题

---

## 2025-12-13

### 动态颜色系统优化

- **问题发现**: 主环和柱状图颜色不一致（值10时，主环黄绿色但柱图绿色）
- **根因分析**: 两套颜色逻辑冲突
  - 主环用 `levelToColor(PollenLevel.LOW)` → #CDDC39（黄绿）
  - 柱图用 `getColorByValue(10)` → #4CAF50（绿色）
- **解决方案**: 统一使用 `getColorByValue()` 数值颜色逻辑
  - 修改 `getLevelColor()` 从 `levelToColor(enum)` 改为 `getColorByValue(value)`
  - 修改 `AppStorage pollenThemeColor` 更新逻辑同步改用数值判断
  - 修改标签页文字和下划线从固定 `#4CAF50` 改为 `pollenThemeColor`
- **影响范围**: 7个UI组件（主环、等级文字、标签页×2、三个图表）
- **验证状态**: ✅ 所有颜色统一，值10→绿色、值150→深橙、值400→红色
- **备份文件**: `PollenForecast_颜色统一_20251213_044800`

---

## 2025-12-14

### 地图定位按钮修复 - CodeGenie 审核优化版

**问题描述**: 
- 右下角系统定位按钮首次安装点击无响应，重启后正常
- 日志分析：事件监听器注册时定位功能尚未启用

**根本原因（CodeGenie 确认）**:
1. **事件依赖关系**: `myLocationClick` 事件依赖 `setMyLocationEnabled(true)` 先调用
2. **配置顺序错误**: 先注册事件 → 后启用定位功能（200ms 延迟）
3. **生命周期时序**: 地图初始化与 `aboutToAppear` 之间存在异步间隙

**CodeGenie 建议的优化方案**:
1. ✅ 使用 `mapReady` 事件替代初始化回调（更精确的时机）
2. ✅ 增加 `isMapInitialized` 标志位避免重复操作
3. ✅ 增加重试机制处理首次安装特殊场景

**最终实现**:
```typescript
// 1. 防止重复初始化
private isMapInitialized: boolean = false
private isLocationControlsSetup: boolean = false

// 2. 监听 mapReady 事件
this.mapEventManager.on('mapReady', () => {
  this.setupLocationControls()
})

// 3. 封装定位控件配置（支持重试）
private setupLocationControls(): void {
  if (this.isLocationControlsSetup) return
  try {
    this.mapController.setMyLocationEnabled(true)
    this.mapController.setMyLocationStyle({ icon: transparent_pixel })
    this.mapController.setMyLocationControlsEnabled(true)
    // 在定位启用后注册点击事件
    this.mapEventManager.on('myLocationClick', async () => {...})
    this.isLocationControlsSetup = true
  } catch (e) {
    // 重试机制（最多3次，间隔500ms）
    setTimeout(() => this.setupLocationControls(), 500)
  }
}
```

**验证状态**: ⏳ 等待重新构建测试

---

## 2025-12-15

### 智感握姿自定义定位按钮

**背景**: 系统定位按钮修复方案过于复杂，采用完全自定义方案

**实现方案**:
1. **禁用系统控件**:
   ```typescript
   this.mapController.setMyLocationEnabled(false)
   this.mapController.setMyLocationControlsEnabled(false)
   this.mapController.setZoomControlsEnabled(false)
   ```

2. **自定义浮动按钮**:
   - 48x48 圆形按钮，绿色主题 (#4CAF50)
   - 加载状态显示 LoadingProgress
   - zIndex: 20 确保在地图上层

3. **智感握姿功能** (HarmonyOS API 20 新特性):
   - 权限: `ohos.permission.DETECT_GESTURE`
   - API: `motion.on('holdingHandChanged', callback)`
   - 握姿状态: `@State holdingHand: 'LEFT' | 'RIGHT' | null`
   - 按钮自适应位置:
     - 左手: `x: 16vp, y: 60%` (左侧垂直居中偏上)
     - 右手: `x: calc(100% - 64vp), y: 60%` (右侧垂直居中偏上)
     - 未检测: `x: 16vp, y: calc(100% - safeBottom - 128vp)` (右下角默认)
   - 1秒防抖逻辑，避免频繁触发
   - 首次检测显示 Toast 提示

4. **电量优化**:
   - 页面可见时启动监听: `onVisibleAreaChange(true)` → `setupGripDetection()`
   - 页面不可见时停止监听: `onVisibleAreaChange(false)` → `stopGripDetection()`
   - 防止后台持续检测浪费电量

**当前状态**: ⚠️ **待 CodeGenie 协助**
- **问题**: 按钮位置不响应握姿变化
- **现象**: 
  - ❌ 日志中没有握姿检测输出（`[MapView] 握手检测: LEFT/RIGHT`）
  - ❌ Toast 提示不显示
  - ❌ 按钮位置固定不变
- **疑问**:
  1. `position` 属性动态绑定 `@State` 是否生效？
  2. `motion.on('holdingHandChanged')` 注册是否成功？（日志无输出）
  3. 按钮安全距离如何设置？（当前 16vp 是否合适）
- **备份文件**: `MapView.backup_20251215_151505.ets`
- **问题文档**: `C:\HarmonyOS_App_Plans\.claude\当前问题.md`

### ReminderAgentKit 紧急修复

**触发原因**: 用户执行构建，发现 9 个 ERROR 导致编译失败

**核心问题**: `@kit.ReminderAgentKit` 在 **API 20 SDK** 中完全不存在
- 错误信息: `Cannot find module @kit.ReminderAgentKit`
- 影响功能: 定时通知（每日播报提醒）

**修复操作** (2025-12-15):
1. ✅ 移除 `ReminderAgentKit` 导入，改为 `BackgroundTasksKit`
2. ✅ 修复 EntryAbility 重复 `onForeground()` 方法定义
3. ✅ 重写 `scheduleDailyReminder()` - 暂时返回功能未实现提示
4. ✅ 重写 `cancelDailyReminder()` - 清理残留缓存
5. ✅ 重写 `checkAndRequestReminderPermission()` - 返回警告日志
6. ✅ 修复所有 `catch (err)` - 添加 `BusinessError` 类型标注 (7处)
7. ✅ 新增导入: `BusinessError` 和 `promptAction`

**ArkTS 严格模式修复**:
- ❌ 解构赋值: `const [a, b] = arr.split()` → ✅ 分步赋值
- ❌ any 类型: `catch (err)` → ✅ `catch (err: BusinessError)`

**替代方案研究** (等待 SDK 更新):
1. 使用 `WorkScheduler` 在后台定时检查
2. 使用 `BackgroundTasksKit` 配合 `Timer`
3. 在应用启动时检查是否到达提醒时间并发送通知

**当前状态**: ✅ 所有编译错误已修复，等待用户重新构建测试

**功能影响**:
- ✅ 通知总开关正常工作
- ✅ 花粉预警通知正常发送
- ⚠️ 定时提醒功能暂时不可用（保存设置但不实际触发）

---

**📌 提示**：详细开发日志按时间倒序记录，当前状态请查看 `CLAUDE.md`。

