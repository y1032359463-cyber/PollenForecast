# 问题记录与解决方案

> **最后更新**: 2026-01-06  
> **当前状态**: 定时提醒功能修复中（根据专家建议修正）

---

## 📋 当前问题

### 2026-01-06 AppGallery 审核反馈 - 定时提醒功能未生效 🔄 修复中

**审核反馈**:
> 设置-通知设置-每日播报-播报时间-选择播报时间：开设备提示权限后应用内设置提示时间后到时间无响应

**问题分析**:
1. **历史原因**: 2025-12-15 时 `ReminderAgentKit` 在 API 20 SDK 中不存在，定时提醒功能被临时禁用
2. **当前状态**: `scheduleDailyReminder()` 只保存配置，未实际设置定时任务
3. **根本原因**: 缺少 WorkScheduler 定时任务实现

**解决方案**:
1. ✅ **创建后台任务扩展能力** (`DailyReportTask.ets`)
   - 继承 `ServiceExtensionAbility`（WorkScheduler 要求）
   - 实现 `onRequest()` 方法执行每日播报
   - 获取花粉数据并发送通知

2. ✅ **实现 WorkScheduler 定时任务**
   - 在 `NotificationService.scheduleDailyReminder()` 中设置定时任务
   - 使用 `BackgroundTasksKit.startWorkWithDelay()` 设置延迟执行
   - 配置每24小时重复执行
   - 添加 fallback 机制（如果 API 不存在，尝试 `startWork`）

3. ✅ **应用启动时检查**
   - 在 `EntryAbility.onForeground()` 中检查是否到达播报时间
   - 如果当前时间在播报时间后5分钟内，且今天未发送，则发送通知

4. ✅ **配置完善**
   - 在 `module.json5` 中添加 `DailyReportTask` 扩展能力配置
   - 添加字符串资源 `daily_report_task_desc`
   - 确保 `PUBLISH_AGENT_REMINDER` 权限已声明

**已完成的修复**（2026-01-06）：
1. ✅ **修正 API 调用**
   - 移除 `startWorkWithDelay()`（API 20 不存在）
   - 改用 `startWork()`（三专家100%一致）
   - 先取消已存在任务，再注册新任务（避免重复）

2. ✅ **移除废弃权限**
   - 从 `module.json5` 中移除 `ohos.permission.PUBLISH_AGENT_REMINDER`
   - 三专家100%一致：该权限已失效

3. ✅ **优化 cancelDailyReminder**
   - 修正 `stopWork()` 调用（添加第三个参数 `true`）
   - 使用 `this.context.abilityInfo.bundleName` 动态获取包名

**修改的文件**:
- `entry/src/main/ets/utils/NotificationService.ets` - 修正 API 调用和取消逻辑
- `entry/src/main/module.json5` - 移除废弃权限
- `entry/src/main/ets/extensionability/DailyReportTask.ets` - **已创建** 后台任务扩展能力
- `entry/src/main/ets/entryability/EntryAbility.ets` - 添加应用启动时检查逻辑
- `entry/src/main/resources/base/element/string.json` - 添加字符串资源

**技术要点**（根据专家建议）:
- ✅ WorkScheduler 使用 `startWork()` 而非 `startWorkWithDelay()`
- ✅ `ServiceExtensionAbility` 类型（CodeGenie + 小米MIMO建议）
- ✅ 配置 `repeatCycleTime: 24 * 60 * 60 * 1000` 实现每日重复
- ✅ 应用启动时检查作为补充机制，确保不遗漏提醒

**待验证**（需真机测试）:
- ⏳ 验证 `startWork()` 是否能正确设置定时任务
- ⏳ 验证定时任务是否能在指定时间触发
- ⏳ 验证应用关闭后是否能触发（系统限制）
- ⏳ 如果失败，尝试 `WorkSchedulerExtensionAbility` 基类
- ⏳ 如果失败，尝试 `type: "backgroundTask"` 配置

**专家分歧点**（需验证）:
- ⚠️ ExtensionAbility 类型：`service` vs `backgroundTask`
- ⚠️ 后台任务基类：`ServiceExtensionAbility` vs `WorkSchedulerExtensionAbility`
- ⚠️ triggerTime 格式：对象 vs 时间戳

**参考文档**:
- **专家回答**：`C:\HarmonyOS_App_Plans\.claude\当前问题.md`
- **中转站**：`C:\HarmonyOS_App_Plans\.claude\知识库_中转站（待验证实践效果）.md`
- **修复计划**：`C:\HarmonyOS_App_Plans\.claude\定时提醒功能修复计划.md`

---

## 📋 历史问题

### 2025-12-29 API 版本兼容性问题（客户反馈）

**客户反馈**:
> 应用 API 版本要求过高，部分设备无法安装

**当前配置**:
- **targetSdkVersion**: `6.0.0(20)`
- **compatibleSdkVersion**: `6.0.0(20)`
- **最低要求**: API 20 (HarmonyOS 6.0.0)

**目标降级版本**:
- **目标**: API 17 (HarmonyOS 5.0.0)
- **原因**: 能适配大部分原生鸿蒙5.0的设备
- **版本差异**: API 17 → API 20 (HarmonyOS 5.0 → 6.0)

**用户需求**:
1. ✅ **全保留 API 20 功能**：API 20 设备完整体验，不牺牲任何功能
2. ✅ **API 17 降级体验**：功能显示但禁用，提示升级系统（而非隐藏）

**方案设计**:

**核心策略**：
- ✅ **运行时 API 版本检测**：使用 `featureAbility.getContext().constant.DEVICE_API_VERSION`（华为官方推荐）
- ✅ **条件功能启用**：API 20 设备使用 `holdingHandChanged`，API 17 设备使用 `operatingHandChanged`（替代方案）
- ✅ **静态导入 + 条件判断**：不需要动态导入，静态导入即可（华为官方方案）
- ✅ **用户体验优化**：显示升级提示，引导用户升级系统

**技术实现**：
1. **创建 API 版本检测工具** (`ApiVersionUtils.ets`)
   - `getCurrentApiVersion()` - 获取设备 API 版本
   - `isApi20Supported()` - 判断是否支持 API 20

2. **修改 MapView.ets**
   - 条件加载 `MultimodalAwarenessKit`（仅 API 20）
   - 智感握姿功能仅在 API 20 时启用
   - API 17 用户点击时显示升级提示

3. **修改 GeneralSettingsPage.ets**
   - 智感握姿设置项始终显示
   - API 17 时：禁用状态 + 灰色样式 + "需要 HarmonyOS 6.0+" 提示
   - API 20 时：正常启用

4. **配置文件修改**
   - `build-profile.json5`: 降级到 `5.0.0(17)`
   - `module.json5`: 保留 `DETECT_GESTURE` 权限（API 17 自动忽略）

**UI/UX 设计**：
- API 17 用户看到功能但禁用（灰色，60%透明度）
- 点击时显示升级提示对话框
- 保持 UI 一致性，不因 API 版本变化

**项目使用的关键 Kit**:
- `@kit.AbilityKit` - Ability 生命周期管理（API 17+ 应支持）
- `@kit.ArkUI` - UI 组件和路由（API 17+ 应支持）
- `@kit.MapKit` - 地图展示（需确认 API 17 是否支持）
- `@kit.FormKit` - 服务卡片（需确认 API 17 是否支持）
- `@kit.NetworkKit` - HTTP 网络请求（API 17+ 应支持）
- `@kit.LocationKit` - GPS 定位（API 17+ 应支持）
- `@kit.MultimodalAwarenessKit` - 智感握姿（API 20 特有，需条件编译）

**参考文档**:
- 详细方案：`PollenForecast/.claude/API版本兼容方案（全保留+降级体验）.md`
- 实施清单：`PollenForecast/.claude/API版本兼容实施清单.md`
- **可行性咨询**：`PollenForecast/.claude/API版本兼容方案可行性咨询.md` ⭐ **待专家确认**
- 专家回答：`C:\HarmonyOS_App_Plans\.claude\知识库_中转站（待验证实践效果）.md` - "HarmonyOS API 降级适配方案"
- 知识库：`C:\HarmonyOS_App_Plans\.claude\知识库.md` - "HarmonyOS API 版本兼容性重要认知"

**状态**: 📋 **方案已确认，待专家咨询确认可行性**

**✅ 华为官方方案（已获得）**：
1. ✅ **API 版本检测**：`featureAbility.getContext().constant.DEVICE_API_VERSION`（官方推荐）
2. ✅ **条件模块导入**：静态导入 + 条件判断包裹使用（不需要动态导入）
3. ✅ **API 17 替代方案**：使用 `operatingHandChanged` 替代 `holdingHandChanged`

**✅ CodeGenie + 华为智能助手回复（已确认）**：
1. ✅ **配置文件降级影响**：
   - 编译时：不会阻止静态导入，但会给出警告（非阻断性错误）
   - 运行时：未做版本判断会触发 `BusinessError`（错误码401），需 try-catch
2. ✅ **权限声明兼容性**：API 17 自动忽略未识别权限，不会导致安装失败
3. ✅ **UI 组件禁用交互**：Toggle 禁用状态下点击**不会触发** `onChange`，需使用事件委托方案
4. ✅ **MapKit 兼容性**：API 17 支持 MapKit（从 API 8 引入），但需注意坐标转换接口差异

**⚠️ 仍需确认的问题**：
- ⏳ **MapKit API 版本要求**：API 17 中 MapKit 的完整功能支持情况和具体限制
  - **详细功能清单**：`PollenForecast/.claude/MapKit功能清单与API17兼容性咨询.md` ⭐ **已创建**
  - **关键问题**：`MapEventManager`（API 20 新增）在 API 17 中的替代方案

**详细咨询问题**：见 `API版本兼容方案可行性咨询.md`（已更新华为官方方案）

---

## 📚 历史问题（已修复）

### 2025-12-24 AppGallery 审核反馈修复

**问题1：深色模式状态栏显示不清晰** ✅ 已修复
- **问题**: 深色模式下导航栏背景半透明，状态栏图标对比度不足
- **解决**: `navbar_background` 改为不透明 `#1A1A1A`
- **修改文件**: `entry/src/main/resources/dark/element/color.json`

**问题2：状态栏与内容遮挡** ✅ 已修复
- **问题**: 滚动内容穿透到导航栏/状态栏区域
- **解决**: 所有 Scroll/Refresh 添加 `.clip(true)`
- **修改文件**: `PollenIndexView.ets`, `SettingsView.ets`, `RegionView.ets`

### 2025-12-07 构建修复记录

**问题1：资源缺失** ✅ 已修复
- **问题**: `Unknown resource name 'block_background'`
- **解决**: 在 `color.json` 中添加定义

**问题2：API 20 废弃警告适配** ✅ 已修复
- **UIContext**: 静态方法改为实例方法
- **px2vp**: 改为手动计算
- **onScroll**: 改为 `onDidScroll`
- **getContext**: 改为 `getUIContext().getHostContext()`

---

**说明**: 历史问题的详细专家意见已移至知识库中转站，此处仅保留关键修复信息。
