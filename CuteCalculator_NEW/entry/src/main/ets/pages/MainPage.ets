/*
 * MainPage - å¯çˆ±è®¡ç®—å™¨ä¸»é¡µé¢
 * Main Calculator Page
 */

import { ResultDisplay } from '../components/ResultDisplay';
import { CharacterDecor, PixelCharacterState } from '../components/CharacterDecor';
import { CuteCalcKeyboard } from '../components/CuteCalcKeyboard';
import { SettingsSheet } from '../components/SettingsSheet';
import CalculateUtil from '../common/CalculateUtil';
import { CalcConstants } from '../common/Constant';
import { RetroPixelTheme } from '../common/RetroPixelTheme';
import { HapticUtils } from '../utils/HapticUtils';
import { HistoryUtils } from '../utils/HistoryUtils';
import PreferencesUtils from '../utils/PreferencesUtils';
import AudioManager from '../utils/AudioManager';
import { common } from '@kit.AbilityKit';
import { window } from '@kit.ArkUI';
import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct MainPage {
  @State expressions: string[] = [];        // è¡¨è¾¾å¼æ•°ç»„(åä¸ºæ ¼å¼)
  @State displayExpr: string = '0';         // æ˜¾ç¤ºçš„è¡¨è¾¾å¼
  @State result: string = '0';              // è®¡ç®—ç»“æœ
  @State characterState: PixelCharacterState = PixelCharacterState.IDLE;
  @State vibrateEnabled: boolean = true;    // æŒ¯åŠ¨å¼€å…³
  @State characterType: string = 'pixel';   // è§’è‰²ç±»å‹ï¼ˆä¿ç•™ä»¥å…¼å®¹è®¾ç½®é¡µé¢ï¼‰
  private characterRef: CharacterDecor | null = null;  // è§’è‰²ç»„ä»¶å¼•ç”¨
  
  // è®¾ç½®å¼¹çª—æ§åˆ¶å™¨
  settingsDialogController: CustomDialogController = new CustomDialogController({
    builder: SettingsSheet({
      vibrateEnabled: $vibrateEnabled,
      characterType: $characterType
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true,
    autoCancel: false,  // ç¦ç”¨ç‚¹å‡»é®ç½©å…³é—­ï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸‹æ»‘æ‰‹åŠ¿
    maskColor: 'rgba(0, 0, 0, 0.5)'
    // ä¸ä½¿ç”¨openAnimation,ç”±SettingsSheetå†…éƒ¨çš„slideOffsetYæ§åˆ¶æ»‘å…¥æ•ˆæœ
  })
  
  // åä¸ºå¹¿å‘Šé…ç½®ï¼ˆç¬¦åˆå®˜æ–¹è§„èŒƒï¼‰
  @State adHeight: number = 0;              // å¹¿å‘Šä½é«˜åº¦ (0=æ— å¹¿å‘Š, 73=å°æ¨ªå¹…57vp+è¾¹è·, 160=å¤§æ¨ªå¹…144vp+è¾¹è·)
  @State adLoaded: boolean = false;         // å¹¿å‘ŠåŠ è½½çŠ¶æ€
  private adRefreshTimer: number = -1;      // å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨

  // ç¨³å®šçš„ç‚¹å‡»å›è°ƒï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°å¯¼è‡´å­ç»„ä»¶é‡ç»˜
  private onBtnClick = (value: string): void => {
    this.handleButtonClick(value);
  }

  async aboutToAppear() {
    // åˆå§‹åŒ–Preferences
    await PreferencesUtils.init(this.getUIContext().getHostContext() as common.UIAbilityContext);
    this.vibrateEnabled = await PreferencesUtils.getVibrateEnabled();
    this.characterType = await PreferencesUtils.getCharacterType();

    // åˆå§‹åŒ–éŸ³æ•ˆç®¡ç†å™¨
    await AudioManager.getInstance().initialize();

    // åˆå§‹åŒ–åä¸ºå¹¿å‘Š
    this.initHuaweiAd();
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶å›è°ƒï¼ˆä»è®¾ç½®é¡µè¿”å›æ—¶ä¼šè§¦å‘ï¼‰
   * ä¼˜åŒ–ï¼šä½¿ç”¨éé˜»å¡æ–¹å¼åŠ è½½è§’è‰²ç±»å‹ï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
   */
  onPageShow() {
    // éé˜»å¡åŠ è½½ï¼šä¸ç­‰å¾…Promiseå®Œæˆï¼Œç«‹å³è¿”å›
    PreferencesUtils.getCharacterType().then((newCharacterType: string) => {
      if (newCharacterType !== this.characterType) {
        this.characterType = newCharacterType;
      }
    });
  }

  aboutToDisappear() {
    // æ¸…ç†å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨
    if (this.adRefreshTimer !== -1) {
      clearInterval(this.adRefreshTimer);
      this.adRefreshTimer = -1;
    }
    
    // é‡Šæ”¾éŸ³æ•ˆèµ„æº
    AudioManager.getInstance().release();
  }

  /**
   * åˆå§‹åŒ–åä¸ºå¹¿å‘Š
   * TODO: éœ€åœ¨ oh-package.json5 ä¸­æ·»åŠ  "@kit.AdsKit": "^1.0.0"
   * TODO: éœ€åœ¨ module.json5 ä¸­æ·»åŠ  OAID æƒé™
   */
  private initHuaweiAd() {
    // TODO: æ¥å…¥åä¸ºå¹¿å‘ŠSDK
    // å‚è€ƒä»£ç :
    // import { advertising } from '@kit.AdsKit';
    // import { deviceAttributes } from '@kit.DeviceAttributesKit';
    //
    // try {
    //   // 1. è·å–è®¾å¤‡OAIDï¼ˆæå‡å¹¿å‘Šå¡«å……ç‡ï¼‰
    //   const oaid = await deviceAttributes.getOAID();
    //
    //   // 2. é…ç½®å¹¿å‘Šå‚æ•°ï¼ˆå¿…é¡»ç¬¦åˆåä¸ºè§„èŒƒï¼‰
    //   const adParams = {
    //     adType: 8,                    // æ¨ªå¹…å¹¿å‘Šç±»å‹
    //     adId: 'testw6vs28auh3',       // æµ‹è¯•IDï¼ˆä¸Šçº¿å‰æ›¿æ¢æ­£å¼IDï¼‰
    //     adHeight: 144,                // 57 æˆ– 144 (vp)
    //     oaid: oaid,                   // è®¾å¤‡OAID
    //     refreshTime: 60000            // åˆ·æ–°é—´éš” 30000~120000ms
    //   };
    //
    //   // 3. åŠ è½½å¹¿å‘Š
    //   advertising.showBannerAd(adParams, (error, data) => {
    //     if (!error) {
    //       this.adLoaded = true;
    //       // æ ¹æ®å®é™…å¹¿å‘Šé«˜åº¦è®¾ç½®å®¹å™¨é«˜åº¦
    //       // å°æ¨ªå¹…: 57vp + 16vpè¾¹è· = 73vp
    //       // å¤§æ¨ªå¹…: 144vp + 16vpè¾¹è· = 160vp
    //       this.adHeight = adParams.adHeight === 57 ? 73 : 160;
    //     }
    //   });
    // } catch (error) {
    //   console.error('åä¸ºå¹¿å‘Šåˆå§‹åŒ–å¤±è´¥:', error);
    // }

    // ä¸´æ—¶æµ‹è¯•: æ¨¡æ‹Ÿå¹¿å‘ŠåŠ è½½ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
    setTimeout(() => {
      this.adLoaded = true;
      this.adHeight = 73;  // ä½¿ç”¨å°æ¨ªå¹…å°ºå¯¸ (57vp + 16vpè¾¹è·)
    }, 1000);
  }

  build() {
    Scroll() {
      Column() {
        // å›¾ç‰‡é¢„åŠ è½½å®¹å™¨ï¼ˆåƒç´ è§’è‰²4çŠ¶æ€é¢„åŠ è½½ï¼‰
        Stack() {
          Image(RetroPixelTheme.getCharacterPath('IDLE'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image(RetroPixelTheme.getCharacterPath('THINKING'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image(RetroPixelTheme.getCharacterPath('CELEBRATE'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image(RetroPixelTheme.getCharacterPath('ERROR'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
        }
        .width(0)
        .height(0)

        // çŠ¶æ€æ å®‰å…¨åŒºåŸŸå ä½
        Blank()
          .height(48)  // çŠ¶æ€æ é«˜åº¦çº¦48vp
      
      // ç¬¬1æ’: å¡é€šäº’åŠ¨
      Row() {
        // åƒç´ è§’è‰² (å·¦ä¾§)
        CharacterDecor()
        .layoutWeight(1)
        .height(160)

        // å†å²è®°å½•æŒ‰é’®
        Button() {
          Text('å†å²')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width(64)
        .height(40)
        .backgroundColor('#FF8C42')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.navigateToHistory();
        })

        // è®¾ç½®æŒ‰é’®
        Button() {
          Text('è®¾ç½®')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .width(64)
        .height(40)
        .backgroundColor('#FF8C42')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.navigateToSettings();
        })
      }
      .width('100%')
      .height(180)
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })  // æ¢å¤åŸpadding
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // ç¬¬2æ’: ç»“æœæ˜¾ç¤ºåŒºåŸŸ
      ResultDisplay({
        expression: this.displayExpr,
        result: this.result
      })

      // ç¬¬3æ’: å¯çˆ±é”®ç›˜ (è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ï¼ŒæŒ‰é”®å˜é«˜)
      CuteCalcKeyboard({
        onButtonClick: this.onBtnClick
      })
      .layoutWeight(1)  // è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ï¼ŒæŒ‰é”®è‡ªåŠ¨å˜é«˜

      // ä¸å¹¿å‘Šä½ä¿æŒå›ºå®š20vpé—´éš”
      Blank()
        .height(20)

      // åº•éƒ¨å¹¿å‘Šä½ï¼ˆå›ºå®šé«˜åº¦ï¼Œç¬¦åˆåä¸ºè§„èŒƒï¼‰
      this.buildAdContainer()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(RetroPixelTheme.COLOR_SHELL)  // Game Boyå¤–å£³è‰² #E8E8E8
    }
    .width('100%')
    .height('100%')
    .scrollable(ScrollDirection.Vertical)  // æ˜ç¡®å¯ç”¨å‚ç›´æ»šåŠ¨
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)  // è¾¹ç•Œå›å¼¹æ•ˆæœ
    .friction(0.9)  // å¢åŠ æ‘©æ“¦åŠ›ï¼Œä½¿å›å¼¹æ›´æ˜æ˜¾
    .align(Alignment.TopStart)
  }

  /**
   * æ„å»ºåä¸ºå¹¿å‘Šå®¹å™¨
   * ç¬¦åˆå®˜æ–¹è§„èŒƒ: ä»…æ”¯æŒ 360vpÃ—57vp æˆ– 360vpÃ—144vp
   * å›ºå®šé«˜åº¦: 57vp (å°æ¨ªå¹…) æˆ– 144vp (å¤§æ¨ªå¹…) + 20vpåº•éƒ¨å®‰å…¨åŒº
   */
  @Builder
  buildAdContainer() {
    Column() {
      if (this.adLoaded && this.adHeight > 0) {
        // åä¸ºæ¨ªå¹…å¹¿å‘Šå®¹å™¨ï¼ˆå›ºå®šé«˜åº¦ï¼‰
        Column() {
          // TODO: æ›¿æ¢ä¸ºå®é™…çš„åä¸ºå¹¿å‘Šç»„ä»¶
          // ç¤ºä¾‹: HuaweiBannerAd({ adId: 'testw6vs28auh3', height: 57 })
          
          // ä¸´æ—¶å ä½ï¼ˆå¼€å‘é˜¶æ®µï¼‰
          Column() {
            Text('ğŸ¯ åä¸ºæ¨ªå¹…å¹¿å‘Šä½')
              .fontSize(14)
              .fontColor(Color.Transparent)
              .fontWeight(FontWeight.Medium)
            Text(this.adHeight === 73 ? '360vp Ã— 57vp' : '360vp Ã— 144vp')
              .fontSize(12)
              .fontColor(Color.Transparent)
              .margin({ top: 4 })
            Text('adId: testw6vs28auh3')
              .fontSize(10)
              .fontColor(Color.Transparent)
              .margin({ top: 2 })
          }
          .width('100%')
          .height(this.adHeight === 73 ? 57 : 144)  // ä½¿ç”¨å›ºå®šé«˜åº¦ï¼ˆåä¸ºè§„èŒƒï¼‰
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255, 245, 230, 0.8)')  // å¥¶æ²¹è‰²åŠé€æ˜
          .borderRadius({ topLeft: 16, topRight: 16 })
          .border({
            width: { top: 1 },
            color: 'rgba(255, 140, 66, 0.2)'
          })
          .shadow({
            radius: 8,
            color: 'rgba(255, 140, 66, 0.08)',
            offsetX: 0,
            offsetY: -2
          })
        }
        .width('100%')
      } else {
        // æ— å¹¿å‘Šæ—¶æ˜¾ç¤º20vpçš„åº•éƒ¨å®‰å…¨åŒº
        Blank()
          .height(0)
      }
    }
    .width('100%')
    .height(this.adLoaded ? (this.adHeight === 73 ? 77 : 164) : 20)  // å¹¿å‘Šé«˜åº¦ + 20vpåº•éƒ¨å®‰å…¨åŒº
    .animation({
      duration: 200,
      curve: Curve.Sharp
    })
  }

  /**
   * å¤„ç†æŒ‰é’®ç‚¹å‡»
   */
  private handleButtonClick(value: string): void {
    // æ ¹æ®æŒ‰é’®ç±»å‹æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
    if (value === CalcConstants.CLEAR) {
      AudioManager.getInstance().play('CLEAR');
    } else if (value === CalcConstants.DELETE || value === CalcConstants.DEL || value === 'del') {
      AudioManager.getInstance().play('DELETE');
    } else if (value === CalcConstants.EQUAL) {
      // ç­‰å·éŸ³æ•ˆåœ¨handleEqualä¸­æ ¹æ®ç»“æœæ’­æ”¾
    } else {
      AudioManager.getInstance().play('BUTTON_PRESS');
    }

    // æŒ¯åŠ¨åé¦ˆ
    if (this.vibrateEnabled) {
      if (value === CalcConstants.EQUAL) {
        HapticUtils.equalVibrate();
      } else {
        HapticUtils.buttonVibrate();
      }
    }

    // æ ¹æ®æŒ‰é’®ç±»å‹å¤„ç†
    if (value === CalcConstants.CLEAR) {
      this.handleClear();
    } else if (value === CalcConstants.DELETE || value === CalcConstants.DEL || value === 'del') {
      this.handleDelete();
    } else if (value === CalcConstants.EQUAL) {
      this.handleEqual();
    } else {
      this.handleInput(value);
    }
  }

  /**
   * å¤„ç†æ¸…ç©º
   */
  private handleClear(): void {
    this.expressions = [];
    this.displayExpr = '';  // ä¸Šæ–¹è¡¨è¾¾å¼æ¡†æ¸…ç©º
    this.result = '0';      // ä¸‹æ–¹ç»“æœæ¡†æ˜¾ç¤º0
    this.characterState = PixelCharacterState.IDLE;
  }

  /**
   * å¤„ç†åˆ é™¤(åä¸ºå®˜æ–¹æ–¹å¼)
   */
  private handleDelete(): void {
    const len = this.expressions.length;
    if (len === 0) {
      return;
    }

    const lastValue = this.expressions[len - 1];
    
    // å¦‚æœæœ€åä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œç›´æ¥åˆ é™¤æ•´ä¸ªå…ƒç´ 
    if (this.isOperator(lastValue)) {
      this.expressions.pop();
    } else {
      // å¦‚æœæœ€åä¸€ä¸ªæ˜¯æ•°å­—
      if (lastValue.length === 1) {
        // åªæœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ é™¤æ•´ä¸ªå…ƒç´ 
        this.expressions.pop();
      } else {
        // å¤šä¸ªå­—ç¬¦ï¼Œåˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
        this.expressions[len - 1] = lastValue.slice(0, -1);
      }
    }
    
    this.updateDisplay();
    
    if (this.expressions.length === 0) {
      this.displayExpr = '';  // ä¸Šæ–¹è¡¨è¾¾å¼æ¡†æ¸…ç©º
      this.result = '0';      // ä¸‹æ–¹ç»“æœæ¡†æ˜¾ç¤º0
      this.characterState = PixelCharacterState.IDLE;
    }
  }

  /**
   * å¤„ç†è¾“å…¥(åä¸ºå®˜æ–¹æ–¹å¼: è¡¨è¾¾å¼æ•°ç»„ç›´æ¥å­˜å‚¨)
   */
  private handleInput(value: string): void {
    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è®¡ç®—ç»“æœï¼ˆexpressionsä¸ºç©ºä½†displayExprä¸ä¸ºç©ºï¼‰ï¼Œæ¸…ç©ºé‡æ–°å¼€å§‹
    if (this.expressions.length === 0 && this.displayExpr !== '' && !this.isOperator(value)) {
      this.displayExpr = '';  // æ¸…ç©ºä¸Šæ–¹è¡¨è¾¾å¼æ¡†
      this.result = '0';      // é‡ç½®ä¸‹æ–¹ç»“æœæ¡†
      this.characterState = PixelCharacterState.IDLE;
    }
    
    const len = this.expressions.length;
    
    // åˆ¤æ–­æ˜¯æ•°å­—/å°æ•°ç‚¹ è¿˜æ˜¯ è¿ç®—ç¬¦
    if (this.isOperator(value)) {
      // è¿ç®—ç¬¦: å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯è¿ç®—ç¬¦ï¼Œæ›¿æ¢ï¼›å¦åˆ™æ·»åŠ 
      if (len > 0) {
        const lastValue = this.expressions[len - 1];
        if (this.isOperator(lastValue)) {
          // æ›¿æ¢è¿ç®—ç¬¦
          this.expressions[len - 1] = value;
        } else {
          // æ·»åŠ è¿ç®—ç¬¦
          this.expressions.push(value);
        }
      }
    } else {
      // æ•°å­—æˆ–å°æ•°ç‚¹: å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯æ•°å­—ï¼Œè¿½åŠ ï¼›å¦åˆ™æ·»åŠ æ–°å…ƒç´ 
      if (len === 0) {
        // é¦–æ¬¡è¾“å…¥
        this.expressions.push(value);
      } else {
        const lastValue = this.expressions[len - 1];
        if (this.isOperator(lastValue)) {
          // ä¸Šä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œæ·»åŠ æ–°æ•°å­—
          this.expressions.push(value);
        } else {
          // ä¸Šä¸€ä¸ªæ˜¯æ•°å­—ï¼Œè¿½åŠ 
          if (value === '.' && lastValue.indexOf('.') !== -1) {
            // å·²æœ‰å°æ•°ç‚¹ï¼Œä¸å†æ·»åŠ 
            return;
          }
          // ç‰¹æ®Šå¤„ç†: å¦‚æœå½“å‰æ•°å­—æ˜¯"0"ï¼Œä¸”è¾“å…¥éå°æ•°ç‚¹çš„æ•°å­—ï¼Œæ›¿æ¢"0"
          if (lastValue === '0' && value !== '.') {
            this.expressions[len - 1] = value;
          } else {
            this.expressions[len - 1] = lastValue + value;
          }
        }
      }
    }
    
    // è¾“å…¥æ•°å­—æ—¶æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
    if (!this.isOperator(value)) {
      this.characterState = PixelCharacterState.THINKING;
    }
    this.updateDisplay();
  }

  /**
   * æ›´æ–°æ˜¾ç¤º(ä¿®æ”¹é€»è¾‘: è¾“å…¥æ—¶åœ¨resultæ¡†æ˜¾ç¤º)
   */
  private updateDisplay(): void {
    const currentExpr = this.expressions.join('');
    // è¾“å…¥é˜¶æ®µï¼šexpressionä¿æŒç©ºç™½ï¼Œresultæ˜¾ç¤ºå½“å‰è¾“å…¥
    this.displayExpr = '';
    this.result = currentExpr.length === 0 ? '0' : currentExpr;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºè¿ç®—ç¬¦
   */
  private isOperator(value: string): boolean {
    return CalcConstants.OPERATORS.indexOf(value) !== -1;
  }

  /**
   * å¯¼èˆªåˆ°å†å²è®°å½•é¡µé¢
   */
  private navigateToHistory(): void {
    router.pushUrl({ url: 'pages/HistoryPage' }, router.RouterMode.Single).catch((err: Error) => {
      promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥', duration: 2000 });
    });
  }

  /**
   * å¯¼èˆªåˆ°è®¾ç½®é¡µé¢ï¼ˆæ”¹ä¸ºæ‰“å¼€åº•éƒ¨å¼¹çª—ï¼‰
   */
  private navigateToSettings(): void {
    this.settingsDialogController.open();
  }

  /**
   * å¤„ç†ç­‰å·(ä½¿ç”¨åä¸ºCalculateUtil)
   */
  private handleEqual(): void {
    if (this.expressions.length === 0) {
      return;
    }

    // å…ˆä¿å­˜åŸå§‹è¡¨è¾¾å¼ç”¨äºæ˜¾ç¤º
    const originalExpr = this.expressions.join('');

    // å¦‚æœæœ€åä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œç§»é™¤å®ƒ
    const len = this.expressions.length;
    const lastValue = this.expressions[len - 1];
    if (this.isOperator(lastValue)) {
      this.expressions.pop();
    }

    if (this.expressions.length === 0) {
      return;
    }

    try {
      // ä½¿ç”¨åä¸ºçš„ CalculateUtil.parseExpression è®¡ç®—
      const calcResult = CalculateUtil.parseExpression(this.expressions);
      
      this.result = calcResult;
      
      if (this.result === 'Error' || this.result === 'NaN' || !this.result) {
        // è®¡ç®—é”™è¯¯
        AudioManager.getInstance().play('ERROR');
        this.characterState = PixelCharacterState.ERROR;
        this.result = 'Error';
        if (this.vibrateEnabled) {
          HapticUtils.errorVibrate();
        }
      } else {
        // è®¡ç®—æˆåŠŸ
        AudioManager.getInstance().play('CALCULATE_SUCCESS');
        this.characterState = PixelCharacterState.CELEBRATE;
        
        // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆä½¿ç”¨ä¹‹å‰ä¿å­˜çš„åŸå§‹è¡¨è¾¾å¼ï¼‰
        const fullExpression = originalExpr + ' = ' + this.result;
        HistoryUtils.updateHistoryResult(fullExpression);
        
        // ä¿®æ”¹æ˜¾ç¤ºé€»è¾‘ï¼šè¡¨è¾¾å¼ç§»åˆ°ä¸Šæ–¹expressionæ¡†ï¼Œç»“æœæ˜¾ç¤ºåœ¨resultæ¡†
        this.displayExpr = originalExpr;  // è¡¨è¾¾å¼æ˜¾ç¤ºåœ¨ä¸Šæ–¹
        // this.result å·²ç»æ˜¯è®¡ç®—ç»“æœï¼Œä¿æŒä¸å˜
        this.expressions = [];  // æ¸…ç©ºå†…éƒ¨æ•°ç»„
      }
    } catch (error) {
      this.result = 'Error';
      this.characterState = PixelCharacterState.ERROR;
      if (this.vibrateEnabled) {
        HapticUtils.errorVibrate();
      }
    }
  }
}
