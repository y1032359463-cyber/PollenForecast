/*
 * CharacterSelectPage - è§’è‰²é€‰æ‹©é¡µé¢
 * Character Selection Page
 */

import { ThemeColors } from '../common/ThemeConfig';
import PreferencesUtils from '../utils/PreferencesUtils';
import { promptAction, router } from '@kit.ArkUI';

interface CharacterInfo {
  id: string;
  name: string;
  normalImage: string;
  description: string;
}

@Entry
@Component
struct CharacterSelectPage {
  @State characterType: string = 'whitecat'; // é»˜è®¤ç™½çŒ«
  @State availableCharacters: CharacterInfo[] = [
    {
      id: 'whitecat',
      name: 'ç™½è‰²çŒ«å’ª',
      normalImage: 'whitecat_body', // å¯¹åº” resources/base/media/whitecat_body.png
      description: 'ç»å…¸æ¬¾ï¼ŒèŒèŒå“’'
    },
    {
      id: 'rabbit',
      name: 'çšæ´ç™½å…”',
      normalImage: 'rabbit_body', // å¯¹åº” resources/base/media/rabbit_body.png
      description: 'çº¯æ´ä¼˜é›…,æ¸©æŸ”å¯çˆ±'
    }
    // é¢„ç•™æ›´å¤šè§’è‰²
  ];

  async aboutToAppear() {
    // åŠ è½½å½“å‰é€‰æ‹©çš„è§’è‰²
    this.characterType = await PreferencesUtils.getCharacterType();
  }

  build() {
    Column({ space: 0 }) {
      // çŠ¶æ€æ å®‰å…¨åŒºåŸŸå ä½
      Blank()
        .height(48)  // çŠ¶æ€æ é«˜åº¦çº¦48vp
      
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›æŒ‰é’®
        Image($r('app.media.ic_back'))
          .width(24)
          .height(24)
          .fillColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => {
            router.back();
          })

        Text('é€‰æ‹©è§’è‰²')
          .fontSize(18)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒå±…ä¸­
        Row()
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(ThemeColors.BG_MAIN)

      // è§’è‰²åˆ—è¡¨
      Scroll() {
        Column({ space: 20 }) {
          ForEach(this.availableCharacters, (character: CharacterInfo) => {
            this.buildCharacterCard(character);
          })

          // é¢„ç•™æ›´å¤šè§’è‰²
          this.buildComingSoonCard();
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .width('100%')
      .scrollable(ScrollDirection.Vertical)  // æ˜ç¡®å¯ç”¨å‚ç›´æ»šåŠ¨
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)  // è¾¹ç•Œå›å¼¹æ•ˆæœ
      .friction(0.9)  // å¢åŠ æ‘©æ“¦åŠ›ï¼Œä½¿å›å¼¹æ›´æ˜æ˜¾
      .backgroundColor(ThemeColors.BG_MAIN)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_MAIN)
  }

  /**
   * è§’è‰²å¡ç‰‡
   */
  @Builder
  buildCharacterCard(character: CharacterInfo) {
    Column({ space: 16 }) {
      // è§’è‰²é¢„è§ˆå›¾
      Image($r(`app.media.${character.normalImage}`))
        .width(200)
        .height(200)
        .objectFit(ImageFit.Contain)
        .borderRadius(16)
        .backgroundColor('#FFF5E6')

      // è§’è‰²ä¿¡æ¯
      Column({ space: 8 }) {
        Text(character.name)
          .fontSize(18)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Bold)

        Text(character.description)
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }

      // é€‰æ‹©æŒ‰é’®
      Button(this.characterType === character.id ? 'âœ“ å·²é€‰æ‹©' : 'é€‰æ‹©æ­¤è§’è‰²')
        .width(160)
        .height(44)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(this.characterType === character.id ? ThemeColors.PRIMARY_ORANGE : '#F5F5F5')
        .fontColor(this.characterType === character.id ? '#FFFFFF' : ThemeColors.TEXT_PRIMARY)
        .borderRadius(22)
        .enabled(this.characterType !== character.id)
        .onClick(() => {
          this.selectCharacter(character.id, character.name);
        })
    }
    .width('100%')
    .padding(24)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(20)
    .border({
      width: this.characterType === character.id ? 3 : 0,
      color: ThemeColors.PRIMARY_ORANGE
    })
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.15)',
      offsetX: 0,
      offsetY: 4
    })
  }

  /**
   * æ•¬è¯·æœŸå¾…å¡ç‰‡
   */
  @Builder
  buildComingSoonCard() {
    Column({ space: 16 }) {
      // å ä½å›¾æ ‡
      Text('ğŸ”’')
        .fontSize(80)
        .opacity(0.3)

      Column({ space: 8 }) {
        Text('æ›´å¤šè§’è‰²')
          .fontSize(18)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .fontWeight(FontWeight.Bold)

        Text('æ•¬è¯·æœŸå¾…...')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
    }
    .width('100%')
    .padding(48)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(20)
    .opacity(0.6)
  }

  /**
   * é€‰æ‹©è§’è‰²
   */
  private selectCharacter(characterId: string, characterName: string): void {
    this.characterType = characterId;
    PreferencesUtils.setCharacterType(characterId);
    promptAction.showToast({
      message: `å·²é€‰æ‹© ${characterName}`,
      duration: 2000
    });

    // å»¶è¿Ÿè¿”å›ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©æ•ˆæœ
    setTimeout(() => {
      router.back();
    }, 500);
  }
}
