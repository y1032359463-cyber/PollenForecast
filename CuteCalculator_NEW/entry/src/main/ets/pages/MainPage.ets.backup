/*
 * MainPage - å¯çˆ±è®¡ç®—å™¨ä¸»é¡µé¢
 * Main Calculator Page
 */

import { ResultDisplay } from '../components/ResultDisplay';
import { CharacterDecor } from '../components/CharacterDecor';
import { CuteCalcKeyboard } from '../components/CuteCalcKeyboard';
import CalculateUtil from '../common/CalculateUtil';
import { CalcConstants, CharacterState } from '../common/Constant';
import { ThemeColors } from '../common/ThemeConfig';
import { HapticUtils } from '../utils/HapticUtils';
import PreferencesUtils from '../utils/PreferencesUtils';
import { common } from '@kit.AbilityKit';

@Entry
@Component
struct MainPage {
  @State expression: string = '';           // å½“å‰è¾“å…¥è¡¨è¾¾å¼
  @State result: string = '0';              // è®¡ç®—ç»“æœ
  @State characterState: CharacterState = CharacterState.NORMAL;
  @State vibrateEnabled: boolean = true;    // æŒ¯åŠ¨å¼€å…³
  @State buttonPressCounter: number = 0;    // æŒ‰é”®è®¡æ•°å™¨ï¼Œç”¨äºè§¦å‘è§’è‰²åŠ¨ç”»
  
  // åä¸ºå¹¿å‘Šé…ç½®ï¼ˆç¬¦åˆå®˜æ–¹è§„èŒƒï¼‰
  @State adHeight: number = 0;              // å¹¿å‘Šä½é«˜åº¦ (0=æ— å¹¿å‘Š, 73=å°æ¨ªå¹…57vp+è¾¹è·, 160=å¤§æ¨ªå¹…144vp+è¾¹è·)
  @State adLoaded: boolean = false;         // å¹¿å‘ŠåŠ è½½çŠ¶æ€
  private adRefreshTimer: number = -1;      // å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨

  async aboutToAppear(): Promise<void> {
    // åˆå§‹åŒ–Preferences
    await PreferencesUtils.init(getContext(this) as common.UIAbilityContext);
    this.vibrateEnabled = await PreferencesUtils.getVibrateEnabled();

    // åˆå§‹åŒ–åä¸ºå¹¿å‘Š
    this.initHuaweiAd();
  }

  aboutToDisappear() {
    // æ¸…ç†å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨
    if (this.adRefreshTimer !== -1) {
      clearInterval(this.adRefreshTimer);
      this.adRefreshTimer = -1;
    }
  }

  /**
   * åˆå§‹åŒ–åä¸ºå¹¿å‘Š
   * TODO: éœ€åœ¨ oh-package.json5 ä¸­æ·»åŠ  "@kit.AdsKit": "^1.0.0"
   * TODO: éœ€åœ¨ module.json5 ä¸­æ·»åŠ  OAID æƒé™
   */
  private initHuaweiAd() {
    // TODO: æ¥å…¥åä¸ºå¹¿å‘ŠSDK
    // å‚è€ƒä»£ç :
    // import { advertising } from '@kit.AdsKit';
    // import { deviceAttributes } from '@kit.DeviceAttributesKit';
    //
    // try {
    //   // 1. è·å–è®¾å¤‡OAIDï¼ˆæå‡å¹¿å‘Šå¡«å……ç‡ï¼‰
    //   const oaid = await deviceAttributes.getOAID();
    //
    //   // 2. é…ç½®å¹¿å‘Šå‚æ•°ï¼ˆå¿…é¡»ç¬¦åˆåä¸ºè§„èŒƒï¼‰
    //   const adParams = {
    //     adType: 8,                    // æ¨ªå¹…å¹¿å‘Šç±»å‹
    //     adId: 'testw6vs28auh3',       // æµ‹è¯•IDï¼ˆä¸Šçº¿å‰æ›¿æ¢æ­£å¼IDï¼‰
    //     adHeight: 144,                // 57 æˆ– 144 (vp)
    //     oaid: oaid,                   // è®¾å¤‡OAID
    //     refreshTime: 60000            // åˆ·æ–°é—´éš” 30000~120000ms
    //   };
    //
    //   // 3. åŠ è½½å¹¿å‘Š
    //   advertising.showBannerAd(adParams, (error, data) => {
    //     if (!error) {
    //       this.adLoaded = true;
    //       // æ ¹æ®å®é™…å¹¿å‘Šé«˜åº¦è®¾ç½®å®¹å™¨é«˜åº¦
    //       // å°æ¨ªå¹…: 57vp + 16vpè¾¹è· = 73vp
    //       // å¤§æ¨ªå¹…: 144vp + 16vpè¾¹è· = 160vp
    //       this.adHeight = adParams.adHeight === 57 ? 73 : 160;
    //     }
    //   });
    // } catch (error) {
    //   console.error('åä¸ºå¹¿å‘Šåˆå§‹åŒ–å¤±è´¥:', error);
    // }

    // ä¸´æ—¶æµ‹è¯•: æ¨¡æ‹Ÿå¹¿å‘ŠåŠ è½½ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
    setTimeout(() => {
      this.adLoaded = true;
      this.adHeight = 160;  // ä½¿ç”¨å¤§æ¨ªå¹…å°ºå¯¸ (144vp + 16vp)
    }, 1000);
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ ï¼ˆå›ºå®šï¼‰
      Row() {
        Text('å¯çˆ±è®¡ç®—å™¨')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)

        Blank()

        // å†å²è®°å½•æŒ‰é’®
        Image($r('app.media.ic_history'))
          .width(24)
          .height(24)
          .onClick(() => {
            // TODO: è·³è½¬åˆ°å†å²è®°å½•é¡µé¢
          })

        // è®¾ç½®æŒ‰é’®
        Image($r('app.media.ic_settings'))
          .width(24)
          .height(24)
          .margin({ left: 16 })
          .onClick(() => {
            // TODO: è·³è½¬åˆ°è®¾ç½®é¡µé¢
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })

      // ä¸»å†…å®¹åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰
      Scroll() {
        Column() {
          // å¡é€šè§’è‰²è£…é¥°
          CharacterDecor({
            currentState: this.characterState,
            buttonPressCounter: this.buttonPressCounter
          })

          // ç»“æœæ˜¾ç¤ºåŒºåŸŸ
          ResultDisplay({
            expression: this.expression,
            result: this.result
          })

          // å¯çˆ±é”®ç›˜
          CuteCalcKeyboard({
            onButtonClick: (value: string) => {
              this.handleButtonClick(value);
            }
          })
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)  // å æ®å‰©ä½™ç©ºé—´
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)  // éšè—æ»šåŠ¨æ¡

      // åº•éƒ¨å¹¿å‘Šä½ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼Œå¸¦å®‰å…¨åŒºï¼‰
      this.buildAdContainer()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_MAIN)
  }

  /**
   * æ„å»ºåä¸ºå¹¿å‘Šå®¹å™¨
   * ç¬¦åˆå®˜æ–¹è§„èŒƒ: ä»…æ”¯æŒ 360vpÃ—57vp æˆ– 360vpÃ—144vp
   */
  @Builder
  buildAdContainer() {
    Column() {
      if (this.adLoaded && this.adHeight > 0) {
        // åä¸ºæ¨ªå¹…å¹¿å‘Šå®¹å™¨
        Column() {
          // TODO: æ›¿æ¢ä¸ºå®é™…çš„åä¸ºå¹¿å‘Šç»„ä»¶
          // ç¤ºä¾‹: HuaweiBannerAd({ adId: 'testw6vs28auh3', height: 144 })
          
          // ä¸´æ—¶å ä½ï¼ˆå¼€å‘é˜¶æ®µï¼‰
          Column() {
            Text('ğŸ¯ åä¸ºæ¨ªå¹…å¹¿å‘Šä½')
              .fontSize(14)
              .fontColor('#8E8E93')
              .fontWeight(FontWeight.Medium)
            Text(this.adHeight === 73 ? '360vp Ã— 57vp' : '360vp Ã— 144vp')
              .fontSize(12)
              .fontColor('#C7C7CC')
              .margin({ top: 4 })
            Text('adId: testw6vs28auh3')
              .fontSize(10)
              .fontColor('#E5E5EA')
              .margin({ top: 2 })
          }
          .width('100%')
          .height(this.adHeight - 16)  // å‡å»ä¸Šä¸‹å†…è¾¹è· (8vp Ã— 2)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255, 245, 230, 0.8)')  // å¥¶æ²¹è‰²åŠé€æ˜
          .borderRadius({ topLeft: 16, topRight: 16 })
          .border({
            width: { top: 1 },
            color: 'rgba(255, 140, 66, 0.2)'
          })
          .shadow({
            radius: 8,
            color: 'rgba(255, 140, 66, 0.08)',
            offsetX: 0,
            offsetY: -2
          })
        }
        .width('100%')
        .padding({ top: 8, bottom: 8 })
      }
    }
    .width('100%')
    .padding({ bottom: 20 })  // åº•éƒ¨å®‰å…¨åŒºï¼Œé¿å…ä¸ç³»ç»Ÿå¯¼èˆªæ é‡å 
    .animation({
      duration: 300,
      curve: Curve.EaseInOut
    })
  }

  /**
   * å¤„ç†æŒ‰é’®ç‚¹å‡»
   */
  private handleButtonClick(value: string): void {
    // è§¦å‘è§’è‰²æ‰‹è‡‚åŠ¨ç”»ï¼ˆé€šè¿‡å¢åŠ è®¡æ•°å™¨ï¼‰
    this.buttonPressCounter++;

    // æŒ¯åŠ¨åé¦ˆ
    if (this.vibrateEnabled) {
      if (value === CalcConstants.EQUAL) {
        HapticUtils.equalVibrate();
      } else {
        HapticUtils.buttonVibrate();
      }
    }

    // æ ¹æ®æŒ‰é’®ç±»å‹å¤„ç†
    if (value === CalcConstants.CLEAR) {
      this.handleClear();
    } else if (value === CalcConstants.DELETE) {
      this.handleDelete();
    } else if (value === CalcConstants.EQUAL) {
      this.handleEqual();
    } else {
      this.handleInput(value);
    }
  }

  /**
   * å¤„ç†æ¸…ç©º
   */
  private handleClear(): void {
    this.expression = '';
    this.result = '0';
    this.characterState = CharacterState.NORMAL;
  }

  /**
   * å¤„ç†åˆ é™¤
   */
  private handleDelete(): void {
    if (this.expression.length > 0) {
      this.expression = this.expression.slice(0, -1);
      if (this.expression.length === 0) {
        this.result = '0';
        this.characterState = CharacterState.NORMAL;
      }
    }
  }

  /**
   * å¤„ç†è¾“å…¥
   */
  private handleInput(value: string): void {
    // æ›´æ–°è¡¨è¾¾å¼
    if (this.expression === '0' && value !== '.') {
      this.expression = value;
    } else {
      this.expression += value;
    }
    
    this.characterState = CharacterState.CALCULATING;

    // å®æ—¶æ˜¾ç¤ºè¾“å…¥
    this.result = this.expression;
  }

  /**
   * å¤„ç†ç­‰å·
   */
  private handleEqual(): void {
    if (this.expression.length === 0) {
      return;
    }

    try {
      // ä½¿ç”¨ç®€åŒ–çš„ CalculateUtil è®¡ç®—
      this.result = CalculateUtil.calculate(this.expression);
      
      if (this.result === 'Error') {
        this.characterState = CharacterState.ERROR;
        if (this.vibrateEnabled) {
          HapticUtils.errorVibrate();
        }
      } else {
        this.characterState = CharacterState.RESULT;
      }
    } catch (error) {
      this.result = 'Error';
      this.characterState = CharacterState.ERROR;
      if (this.vibrateEnabled) {
        HapticUtils.errorVibrate();
      }
    }
  }
}
