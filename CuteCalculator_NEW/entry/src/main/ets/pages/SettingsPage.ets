/*
 * SettingsPage - è®¾ç½®é¡µé¢
 * Settings Page
 */

import { ThemeColors, ThemeSizes } from '../common/ThemeConfig';
import PreferencesUtils from '../utils/PreferencesUtils';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct SettingsPage {
  @State vibrateEnabled: boolean = true;      // æŒ¯åŠ¨å¼€å…³
  @State characterType: string = 'cat';       // è§’è‰²ç±»åž‹

  async aboutToAppear() {
    // åŠ è½½è®¾ç½®
    this.vibrateEnabled = await PreferencesUtils.getVibrateEnabled();
    this.characterType = await PreferencesUtils.getCharacterType();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.ic_back'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back({ url: 'pages/MainPage' });
          })

        Text('è®¾ç½®')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })

      // è®¾ç½®åˆ—è¡¨
      Column() {
        // æŒ¯åŠ¨å¼€å…³
        Row() {
          Text('æŒ‰é”®æŒ¯åŠ¨')
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Blank()

          Toggle({ type: ToggleType.Switch, isOn: this.vibrateEnabled })
            .selectedColor(ThemeColors.PRIMARY_ORANGE)
            .onChange((isOn: boolean) => {
              this.vibrateEnabled = isOn;
              PreferencesUtils.setVibrateEnabled(isOn);
            })
        }
        .width('100%')
        .height(56)
        .padding({ left: 20, right: 20 })
        .backgroundColor(ThemeColors.BG_CARD)

        Divider()
          .strokeWidth(0.5)
          .color('#E5E5E5')

        // è§’è‰²é€‰æ‹©
        Row() {
          Text('è§’è‰²é€‰æ‹©')
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Blank()

          Text(this.getCharacterName())
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_SECONDARY)

          Image($r('app.media.ic_arrow_right'))
            .width(20)
            .height(20)
            .margin({ left: 8 })
        }
        .width('100%')
        .height(56)
        .padding({ left: 20, right: 20 })
        .backgroundColor(ThemeColors.BG_CARD)
        .onClick(() => {
          this.showCharacterPicker();
        })
      }
      .width('100%')
      .margin({ top: 16 })
      .borderRadius(12)

      // å…³äºŽåˆ†ç»„
      Column() {
        Row() {
          Text('å…³äºŽ')
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Blank()

          Text('v1.0.0')
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .width('100%')
        .height(56)
        .padding({ left: 20, right: 20 })
        .backgroundColor(ThemeColors.BG_CARD)
        .onClick(() => {
          this.showAboutDialog();
        })
      }
      .width('100%')
      .margin({ top: 16 })
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_MAIN)
  }

  /**
   * èŽ·å–è§’è‰²åç§°
   */
  private getCharacterName(): string {
    switch (this.characterType) {
      case 'cat':
        return 'å¯çˆ±çŒ«å’ª';
      default:
        return 'å¯çˆ±çŒ«å’ª';
    }
  }

  /**
   * æ˜¾ç¤ºè§’è‰²é€‰æ‹©å™¨
   */
  private showCharacterPicker(): void {
    promptAction.showDialog({
      title: 'é€‰æ‹©è§’è‰²',
      message: 'å½“å‰å¯ç”¨è§’è‰²ï¼š',
      buttons: [
        { text: 'å–æ¶ˆ', color: ThemeColors.TEXT_SECONDARY },
        { text: 'å¯çˆ±çŒ«å’ª ðŸ±', color: ThemeColors.PRIMARY_ORANGE }
      ]
    }).then((data: promptAction.ShowDialogSuccessResponse) => {
      if (data.index === 1) {
        this.characterType = 'cat';
        PreferencesUtils.setCharacterType('cat');
        promptAction.showToast({ message: 'å·²é€‰æ‹©å¯çˆ±çŒ«å’ª', duration: 2000 });
      }
    }).catch((err: Error) => {
      console.error('Dialog error:', err);
    });
  }

  /**
   * æ˜¾ç¤ºå…³äºŽå¯¹è¯æ¡†
   */
  private showAboutDialog(): void {
    promptAction.showDialog({
      title: 'å¯çˆ±è®¡ç®—å™¨',
      message: 'ç‰ˆæœ¬: v1.0.0\n\nä¸€ä¸ªå¯çˆ±é£Žæ ¼çš„HarmonyOSè®¡ç®—å™¨\n\nÂ© 2025',
      buttons: [
        { text: 'ç¡®å®š', color: ThemeColors.PRIMARY_ORANGE }
      ]
    }).catch((err: Error) => {
      console.error('Dialog error:', err);
    });
  }
}
