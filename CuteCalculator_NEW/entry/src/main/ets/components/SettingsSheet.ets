/*
 * SettingsSheet - è®¾ç½®åº•éƒ¨å¼¹çª—
 * Settings Bottom Sheet Component
 */

import { ThemeColors } from '../common/ThemeConfig';
import PreferencesUtils from '../utils/PreferencesUtils';
import { promptAction, router } from '@kit.ArkUI';

@CustomDialog
export struct SettingsSheet {
  @Link vibrateEnabled: boolean;
  @Link characterType: string;
  @State soundEnabled: boolean = true;  // éŸ³æ•ˆå¼€å…³
  controller: CustomDialogController;
  
  // æ‹–æ‹½ç›¸å…³
  @State dragOffsetY: number = 0;
  @State isDragging: boolean = false;
  @State slideOffsetY: number = 400; // åˆå§‹ä½ç½®åœ¨åº•éƒ¨å¤–,ç”¨äºæ»‘å…¥åŠ¨ç”»
  private startY: number = 0;
  private CLOSE_THRESHOLD: number = 100; // ä¸‹æ»‘100vpå…³é—­
  
  aboutToAppear() {
    // åŠ è½½éŸ³æ•ˆå¼€å…³çŠ¶æ€
    PreferencesUtils.getSound().then((enabled: boolean) => {
      this.soundEnabled = enabled;
    });
    
    // å»¶è¿Ÿæ‰§è¡Œå…¥åœºåŠ¨ç”»,ç¡®ä¿ç»„ä»¶å·²å®Œæˆæ¸²æŸ“
    setTimeout(() => {
      animateTo({
        duration: 300,
        curve: Curve.FastOutSlowIn
      }, () => {
        this.slideOffsetY = 0;
      });
    }, 50);
  }

  /**
   * å…³é—­å¼¹çª—æ—¶çš„æ»‘ä¸‹åŠ¨ç”»
   */
  private closeWithAnimation(): void {
    animateTo({
      duration: 250,
      curve: Curve.FastOutLinearIn
    }, () => {
      this.slideOffsetY = 400;
    });
    // å»¶è¿Ÿå…³é—­ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      this.controller.close();
    }, 250);
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨æ‹–æ‹½æ¡
      Row() {
        Divider()
          .width(40)
          .height(4)
          .backgroundColor('#E5E5EA')
          .borderRadius(2)
      }
      .width('100%')
      .height(20)
      .justifyContent(FlexAlign.Center)

      // æ ‡é¢˜
      Text('è®¾ç½®')
        .fontSize(20)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 16 })

      // è®¾ç½®å†…å®¹ - 2åˆ—ç½‘æ ¼å¸ƒå±€
      Column({ space: 16 }) {
        // ç¬¬ä¸€æ’ï¼šè§’è‰²é€‰æ‹© + éœ‡åŠ¨å¼€å…³
        Row({ space: 16 }) {
          this.buildCharacterCard()
          this.buildVibrateCard()
        }
        .width('100%')

        // ç¬¬äºŒæ’ï¼šéŸ³æ•ˆå¼€å…³ + é¢„ç•™ç©ºä½
        Row({ space: 16 }) {
          this.buildSoundCard()
          // é¢„ç•™ç©ºä½
          Column()
            .width('calc(50% - 8vp)')
            .aspectRatio(1)
            .visibility(Visibility.Hidden)
        }
        .width('100%')

        // ç¬¬ä¸‰æ’ï¼šä½¿ç”¨æ¡æ¬¾å’Œéšç§æ”¿ç­–åˆå¹¶
        this.buildPolicyCard()

        // é¢„ç•™ï¼šå¹¿å‘Šç§»é™¤ï¼ˆéšè—ï¼‰
        // this.buildAdRemovalCard()
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 120 })  // åº•éƒ¨120vpå¡«å……ï¼Œé®ç›–å¯¼èˆªæ¡
    }
    .width('100%')
    .backgroundColor(ThemeColors.BG_MAIN)
    .borderRadius({ topLeft: 24, topRight: 24 })
    .translate({ y: this.slideOffsetY + this.dragOffsetY })
    .animation({
      duration: this.isDragging ? 0 : 300,
      curve: Curve.EaseOut
    })
    .onTouch((event: TouchEvent) => {
      if (event.type === TouchType.Down) {
        this.startY = event.touches[0].y;
        this.isDragging = true;
      } else if (event.type === TouchType.Move) {
        const deltaY = event.touches[0].y - this.startY;
        // åªå…è®¸å‘ä¸‹æ‹–æ‹½
        if (deltaY > 0) {
          this.dragOffsetY = deltaY;
        }
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        this.isDragging = false;
        // åˆ¤æ–­æ˜¯å¦éœ€è¦å…³é—­
        if (this.dragOffsetY > this.CLOSE_THRESHOLD) {
          this.closeWithAnimation();
        }
        this.dragOffsetY = 0;
      }
    })
  }

  /**
   * è§’è‰²é€‰æ‹©å¡ç‰‡ï¼ˆæ–¹å½¢ï¼Œç‚¹å‡»è¿›å…¥è§’è‰²åˆ—è¡¨é¡µï¼‰
   */
  @Builder
  buildCharacterCard() {
    Column({ space: 8 }) {
      // å½“å‰è§’è‰²é¢„è§ˆå›¾ç‰‡ï¼ˆä½¿ç”¨çœŸå®çŒ«å’ªå›¾ç‰‡ï¼‰
      Image($r('app.media.whitecat_body'))
        .width(60)
        .height(60)
        .objectFit(ImageFit.Contain)

      Text('è§’è‰²é€‰æ‹©')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .fontWeight(FontWeight.Medium)

      Text('å¯çˆ±çŒ«å’ª')
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .width('calc(50% - 8vp)')
    .aspectRatio(1) // æ–¹å½¢å¡ç‰‡
    .justifyContent(FlexAlign.Center)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.1)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      // å…ˆå…³é—­å¼¹çª—ï¼Œå†è·³è½¬
      this.controller.close();
      // å»¶è¿Ÿè·³è½¬ï¼Œç¡®ä¿å¼¹çª—å…³é—­åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        router.pushUrl({ url: 'pages/CharacterSelectPage' })
          .catch((err: Error) => {
            promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥', duration: 2000 });
          });
      }, 100);
    })
  }

  /**
   * éœ‡åŠ¨å¼€å…³å¡ç‰‡ï¼ˆæ–¹å½¢ï¼Œæ— å›¾æ ‡ï¼‰
   */
  @Builder
  buildVibrateCard() {
    Column({ space: 8 }) {
      // å¼€å…³
      Toggle({ type: ToggleType.Switch, isOn: this.vibrateEnabled })
        .selectedColor(ThemeColors.PRIMARY_ORANGE)
        .width(52)
        .height(32)
        .onChange((isOn: boolean) => {
          this.vibrateEnabled = isOn;
          PreferencesUtils.setVibrateEnabled(isOn);
          promptAction.showToast({ message: isOn ? 'éœ‡åŠ¨å·²å¼€å¯' : 'éœ‡åŠ¨å·²å…³é—­', duration: 2000 });
        })

      Text('æŒ‰é”®éœ‡åŠ¨')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .fontWeight(FontWeight.Medium)

      Text(this.vibrateEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­')
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .width('calc(50% - 8vp)')
    .aspectRatio(1) // æ–¹å½¢å¡ç‰‡
    .justifyContent(FlexAlign.Center)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * éŸ³æ•ˆå¼€å…³å¡ç‰‡ï¼ˆæ–¹å½¢ï¼Œæ— å›¾æ ‡ï¼‰
   */
  @Builder
  buildSoundCard() {
    Column({ space: 8 }) {
      // å¼€å…³
      Toggle({ type: ToggleType.Switch, isOn: this.soundEnabled })
        .selectedColor(ThemeColors.PRIMARY_ORANGE)
        .width(52)
        .height(32)
        .onChange((isOn: boolean) => {
          this.soundEnabled = isOn;
          PreferencesUtils.setSound(isOn);
          promptAction.showToast({ message: isOn ? 'éŸ³æ•ˆå·²å¼€å¯' : 'éŸ³æ•ˆå·²å…³é—­', duration: 2000 });
        })

      Text('æŒ‰é”®éŸ³æ•ˆ')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .fontWeight(FontWeight.Medium)

      Text(this.soundEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­')
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .width('calc(50% - 8vp)')
    .aspectRatio(1) // æ–¹å½¢å¡ç‰‡
    .justifyContent(FlexAlign.Center)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * ä½¿ç”¨æ¡æ¬¾å’Œéšç§æ”¿ç­–åˆå¹¶å¡ç‰‡ï¼ˆæ— å›¾æ ‡ï¼Œçº¯æ–‡å­—ï¼‰
   */
  @Builder
  buildPolicyCard() {
    Row({ space: 16 }) {
      // ä½¿ç”¨æ¡æ¬¾
      Column({ space: 8 }) {
        Text('ä½¿ç”¨æ¡æ¬¾')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)
      }
      .width('calc(50% - 8vp)')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: 'rgba(255, 140, 66, 0.1)',
        offsetX: 0,
        offsetY: 2
      })
      .onClick(() => {
        this.showTermsDialog();
      })

      // éšç§æ”¿ç­–
      Column({ space: 8 }) {
        Text('éšç§æ”¿ç­–')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)
      }
      .width('calc(50% - 8vp)')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(16)
      .shadow({
        radius: 12,
        color: 'rgba(255, 140, 66, 0.1)',
        offsetX: 0,
        offsetY: 2
      })
      .onClick(() => {
        this.showPrivacyDialog();
      })
    }
    .width('100%')
  }

  /**
   * æ˜¾ç¤ºä½¿ç”¨æ¡æ¬¾å¯¹è¯æ¡†
   */
  private showTermsDialog(): void {
    promptAction.showDialog({
      title: 'ä½¿ç”¨æ¡æ¬¾',
      message: 'æ„Ÿè°¢æ‚¨ä½¿ç”¨å¯çˆ±è®¡ç®—å™¨ï¼\n\næœ¬åº”ç”¨ä¸ºå…è´¹è®¡ç®—å·¥å…·ï¼Œä»…ä¾›ä¸ªäººå­¦ä¹ å’Œæ—¥å¸¸ä½¿ç”¨ã€‚\n\næˆ‘ä»¬æ‰¿è¯ºä¸ä¼šæ”¶é›†æ‚¨çš„ä»»ä½•ä¸ªäººä¿¡æ¯ã€‚',
      buttons: [
        { text: 'æˆ‘çŸ¥é“äº†', color: ThemeColors.PRIMARY_ORANGE }
      ]
    }).catch((err: Error) => {
      console.error('Dialog error:', err);
    });
  }

  /**
   * æ˜¾ç¤ºéšç§æ”¿ç­–å¯¹è¯æ¡†
   */
  private showPrivacyDialog(): void {
    promptAction.showDialog({
      title: 'éšç§æ”¿ç­–',
      message: 'æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ä¿æŠ¤ï¼š\n\nâœ“ ä¸æ”¶é›†ä¸ªäººä¿¡æ¯\nâœ“ ä¸ä¸Šä¼ ä½¿ç”¨æ•°æ®\nâœ“ æ‰€æœ‰è®¡ç®—æœ¬åœ°å®Œæˆ\nâœ“ å†å²è®°å½•ä»…ä¿å­˜åœ¨æœ¬åœ°\n\næ‚¨çš„æ•°æ®å®‰å…¨ç”±HarmonyOSç³»ç»Ÿä¿æŠ¤ã€‚',
      buttons: [
        { text: 'æˆ‘çŸ¥é“äº†', color: ThemeColors.PRIMARY_ORANGE }
      ]
    }).catch((err: Error) => {
      console.error('Dialog error:', err);
    });
  }

  /**
   * å¹¿å‘Šç§»é™¤å¡ç‰‡ï¼ˆé¢„ç•™æ¥å£ï¼‰
   */
  @Builder
  buildAdRemovalCard() {
    Row() {
      Row({ space: 12 }) {
        Column() {
          Text('ğŸš«')
            .fontSize(32)
        }
        .width(60)
        .height(60)
        .backgroundColor('#FFF5E6')
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)

        Column({ space: 4 }) {
          Text('ç§»é™¤å¹¿å‘Š')
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
          Text('æ°¸ä¹…äº«å—æ— å¹¿å‘Šä½“éªŒ')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .alignItems(HorizontalAlign.Start)
      }

      Blank()

      Button('Â¥6')
        .width(60)
        .height(36)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .backgroundColor(ThemeColors.PRIMARY_ORANGE)
        .fontColor('#FFFFFF')
        .borderRadius(18)
        .onClick(() => {
          promptAction.showToast({ message: 'åŠŸèƒ½å¼€å‘ä¸­...', duration: 2000 });
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }
}
