# 字体替换问题解决方案 ✅

## 问题诊断

### 根本原因
❌ **错误做法**：在 `onCreate()` 生命周期中使用 `font.registerFont()`
```typescript
// ❌ 错误 - onCreate中注册字体
onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  font.registerFont({
    familyName: 'Pacifico',
    familySrc: $rawfile('fonts/Pacifico-Regular.ttf')
  });
}
```

**失败原因**：
1. UI上下文尚未初始化
2. `font.registerFont()` 需要UI上下文才能工作
3. `onCreate()` 阶段没有窗口实例

## 正确解决方案 ✅

### 核心要点
1. **必须在 `onWindowStageCreate()` 中注册字体**
2. **必须通过 `getUIContext()` 获取UI上下文**
3. **使用 `uiContext.font.registerFont()` 而非全局 `font.registerFont()`**

### 完整实现代码

```typescript
// EntryAbility.ets
import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';

export default class EntryAbility extends UIAbility {
  onWindowStageCreate(windowStage: window.WindowStage): void {
    windowStage.getMainWindow().then((mainWindow: window.Window) => {
      // ✅ 关键：获取UI上下文
      const uiContext = mainWindow.getUIContext();
      
      // ✅ 使用UI上下文注册字体
      try {
        uiContext.font.registerFont({
          familyName: 'Pacifico',
          familySrc: $rawfile('fonts/Pacifico-Regular.ttf')
        });
        hilog.info(DOMAIN, 'Font', 'Pacifico registered successfully via UIContext');
      } catch (err) {
        hilog.error(DOMAIN, 'Font', 'Failed to register: %{public}s', JSON.stringify(err));
      }
    });

    // loadContent必须在字体注册之后
    windowStage.loadContent('pages/MainPage', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load content: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Content loaded successfully');
    });
  }
}
```

### 组件中使用字体（带回退机制）

```typescript
// CuteButton.ets / ResultDisplay.ets
Text(this.config.value)
  .fontSize(40)
  .fontFamily('Pacifico, HarmonyOS Sans')  // ✅ 字体回退机制
  // Pacifico加载失败时自动使用HarmonyOS Sans
```

## 技术要点总结

| 关键点 | 错误做法 ❌ | 正确做法 ✅ |
|--------|-----------|-----------|
| **生命周期** | `onCreate()` | `onWindowStageCreate()` |
| **API调用** | `font.registerFont()` | `uiContext.font.registerFont()` |
| **上下文获取** | 无 | `mainWindow.getUIContext()` |
| **字体引用** | `.fontFamily('Pacifico')` | `.fontFamily('Pacifico, HarmonyOS Sans')` |
| **注册时机** | 应用启动时 | 窗口创建后 |

## 验证方法

### 1. 查看日志
```
// 成功日志
Pacifico registered successfully via UIContext

// 失败日志
Failed to register: [错误信息]
```

### 2. 运行时检查
- 构建应用并运行
- 查看数字和计算结果是否显示为手写字体
- 如果显示为系统字体，说明 Pacifico 未加载，使用了 HarmonyOS Sans 回退

### 3. 文件验证
```powershell
# 确认字体文件存在
Test-Path "entry/src/main/resources/rawfile/fonts/Pacifico-Regular.ttf"
# 输出: True

# 确认文件大小
Get-Item "entry/src/main/resources/rawfile/fonts/Pacifico-Regular.ttf" | Select-Object Length
# 输出: 315408 字节 (约315KB)
```

## 为什么这样修复有效

**HarmonyOS 字体注册机制**:
1. 字体注册需要绑定到特定的UI上下文
2. UI上下文在窗口创建后才可用 (`onWindowStageCreate`)
3. 每个窗口有独立的字体注册表
4. `onCreate()` 阶段没有窗口，因此无法注册字体

**UIContext的重要性**:
- `getUIContext()` 提供了UI相关的所有API访问入口
- 包括：字体注册、动画、媒体查询等
- 必须在窗口创建后才能获取

## 相关资源

- **HarmonyOS字体API**: `uiContext.font.registerFont()`
- **字体文件**: `entry/src/main/resources/rawfile/fonts/Pacifico-Regular.ttf`
- **授权**: SIL Open Font License (可商用)
- **应用组件**: CuteButton.ets, ResultDisplay.ets

---

**修复时间**: 2025年11月23日  
**解决方案来源**: DevEco Studio CodeGenie  
**状态**: ✅ 已验证有效
