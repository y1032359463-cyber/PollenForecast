# Copilot Instructions

> 本文件定义 GitHub Copilot 在此项目中的行为规范

## 项目信息

- **项目名称**: 花粉浓度预报 (PollenForecast)
- **技术栈**: HarmonyOS + ArkTS + ArkUI (API 20)
- **开发工具**: DevEco Studio 6.0.x

---

## 🔴 AI 强制工作流程

### 开始工作前
1. **必须先读取** `.claude/CLAUDE.md` 确认项目状态
2. **确认理解**: 最近完成的功能、当前待办事项、已知问题
3. **不依赖对话历史** - 每次都要重新读取项目状态

### 遇到困难立即求助 CodeGenie
**原则**: 如果一个问题尝试 2-3 次仍无法解决，**立即停止尝试**，将问题整理到 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`

**必须求助的场景**:
- 编译错误修复超过 3 次仍未解决
- API 使用不确定（如 Map Kit、LocationKit 等）
- UI 交互功能失效且找不到原因
- ArkTS 严格模式语法限制不清楚
- 任何需要查阅官方文档的技术问题

**求助流程**:
1. 停止尝试修复
2. 打开 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`
3. 清空文件并写入新问题（包含：问题描述、代码上下文、尝试过的方法、错误信息）
4. 告知用户："问题已整理到 `当前问题.md`，请粘贴给 CodeGenie"

### 代码修改原则
- ✅ **理解全局再修改** - 先读完整个 build() 函数或相关代码块
- ✅ **一次只改一个问题** - 避免连锁错误
- ✅ 批量操作使用 `multi_replace_string_in_file`
- ❌ **禁止重复修复已解决的问题** - 先确认问题是否真的存在
- ❌ 禁止凭假设修改 - 先用截图/日志确认实际状态

### 🔴 重大代码变动前必须备份
**原则**: 对核心文件进行重构/大幅修改前,**必须先备份**

**需要备份的场景**:
- 重构列表/动画逻辑
- 修改核心业务流程 (如城市选择、数据加载)
- 优化性能涉及算法变更
- 任何可能导致功能失效的修改

**备份流程**:
1. 使用 PowerShell 命令备份:
   ```powershell
   $backupName = "文件名.backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
   Copy-Item "原文件路径" "备份路径/$backupName"
   ```
2. 将备份位置记录到 `.claude/CLAUDE.md` 的"开发日志"
3. 格式: `备份文件: entry/src/main/ets/views/文件名.backup_时间戳`
4. 确认备份成功后再进行代码修改

**示例**:
```markdown
### 2025-12-09 晚 (性能优化)
**优化计划**:
1. 🔄 RegionView 深度优化
   - 备份文件: `entry/src/main/ets/views/RegionView.ets.backup_20251209_204902`
   - 优化内容: 滑动性能优化
```

### 完成任务后
1. 更新 `.claude/CLAUDE.md` 的"项目进展追踪"
2. 询问用户当前北京时间并更新时间戳

### 交互与文件操作
- ✅ **Todo 列表必须使用中文** - 方便用户直观查看工作安排
- ✅ **修改文件禁止"删除重建"** - 必须使用编辑工具 (`replace_string_in_file` 等) 修改现有文件，保留文件历史
- ❌ **禁止抢跑知识库** - 必须等待用户明确反馈"构建成功"或"运行正常"后，才能将方案写入知识库

---

## 知识管理规则

### 文件结构
```
C:\HarmonyOS_App_Plans\
├── .claude/                    # 全局共享（跨项目）
│   ├── 当前问题.md             # 与 CodeGenie 实时沟通（可清空重写）
│   └── 知识库.md               # 已验证解决方案（只追加，不删除）
└── PollenForecast/
    └── .claude/
        └── CLAUDE.md           # 项目指导文档
```

### 核心规则

1. **方案验证成功后（必须等待用户确认），才追加到知识库**
   - ❌ **禁止将未验证的 AI 建议直接写入知识库**
   - 打开 `C:\HarmonyOS_App_Plans\.claude\知识库.md`（全局共享）
   - 在相应分类下追加验证通过的代码和说明
   - 标注验证日期和适用 API 版本

2. **知识库只追加，不删除**
   - 除非内容被证明是错误的，否则不删除
   - 更新时保留原内容，添加新版本说明

3. **当前问题.md 可清空重写**
   - 每次新问题时可以完全清空
   - 问题解决后清空，准备下一个问题

### 与 CodeGenie 协作流程

1. 遇到不确定问题 → 写入 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`
2. 用户粘贴 CodeGenie 回复 → 分析并执行
3. 方案验证成功 → **立即追加到 `C:\HarmonyOS_App_Plans\.claude\知识库.md`**
4. 清空 `当前问题.md` 准备下一个问题

---

## 知识管理规则

### 文件结构
```
C:\HarmonyOS_App_Plans\
├── .claude/                    # 全局共享（跨项目）
│   ├── 当前问题.md             # 与 CodeGenie 实时沟通（**可清空重写**）
│   └── 知识库.md               # 已验证解决方案（**只追加，不删除**）
└── PollenForecast/
    └── .claude/
        └── CLAUDE.md           # 项目指导文档
```

### 核心规则

#### 1. `当前问题.md` - 临时沟通文档
- ✅ **可清空重写** - 每次新问题时完全清空
- ✅ 问题解决后，将有用信息移动到知识库，然后清空
- ❌ **禁止创建其他临时文件** - 如 `地图按钮问题.md`、`问题_backup.md` 等
- 用途：与 CodeGenie 实时沟通当前问题

#### 2. `知识库.md` - 永久知识库
- ✅ **只追加，不删除** - 除非内容被证明是错误的
- ✅ 方案验证成功后才追加
- ✅ 标注验证日期和适用 API 版本
- ❌ **禁止将未验证的 AI 建议直接写入**
- 用途：存储已验证的技术解决方案

#### 3. 禁止随意创建文件
- ❌ 禁止为每个问题创建单独的 `.md` 文件
- ❌ 禁止创建 `问题_v1.md`、`问题_v2.md` 等版本文件
- ✅ 所有临时问题都写入 `当前问题.md`
- ✅ 所有已验证方案追加到 `知识库.md`

### 与 CodeGenie 协作流程

1. 遇到不确定问题 → **清空** `当前问题.md` 并写入新问题
2. 用户粘贴 CodeGenie 回复 → 分析并执行
3. 方案验证成功 → **立即追加到** `知识库.md`
4. 清空 `当前问题.md` 准备下一个问题

---

## 编码规范

### ArkTS 语法规范

```typescript
// ❌ 静态方法不能用 this
static calculate(): Result { return this.helper(); }

// ✅ 使用类名
static calculate(): Result { return ClassName.helper(); }

// ❌ 禁止使用 TypeScript 的 is 类型守卫
function isUser(obj: Object): obj is User { ... }

// ✅ 使用简单的字段检查
if (obj !== null && obj.name !== undefined && typeof obj.name === 'string')
```

**ArkTS 严格限制**:
- ❌ **禁止类型守卫 `is`**: ArkTS 不支持 `obj is Type` 语法
- ❌ **禁止 `any` 和 `unknown`**: 必须使用明确类型
- ❌ **限制 `ESObject` 使用**: 避免使用 ESObject，改用泛型或明确接口
- ❌ **禁止对象字面量类型**: 嵌套对象需定义独立 interface
- ✅ **使用泛型**: `function request<T>(): Promise<T>`
- ✅ **可选字段防御**: `interface Data { code?: string; value?: number }`

- **导出**: `export { ClassName }` (禁止 export default)
- **布局**: `Column/Row/Stack` (禁止 div/flex)
- **滚动**: `onDidScroll` (onScroll 已废弃)
- **组件命名**: PascalCase
- **文件命名**: PascalCase.ets

### 常见陷阱

| 问题 | 正确做法 |
|-----|---------|
| ForEach 加样式 | 包裹在 Row/Column 中 |
| layoutWeight 异常 | 确保父容器有明确高度 |
| @Builder 不响应 | 使用参数传递而非直接引用 @StorageLink |
| 预览器差异 | 给状态变量设置合理默认值 |

---

## 构建与测试

> ⚠️ **必须人工操作** - AI 不能自动构建或运行应用

### 构建流程（用户在 DevEco Studio 中操作）
1. **安装依赖**: `ohpm install`
2. **构建 HAP**: Build → Build Hap(s)/APP(s) → Build Hap(s)
3. **运行到设备**: 点击运行按钮或 Shift+F10
4. **清理构建**: Build → Clean Project

### AI 职责
- ❌ 禁止尝试运行 `hvigorw` 等构建命令
- ✅ 修改代码后提醒用户手动构建测试
- ✅ 等待用户反馈构建结果或运行截图
