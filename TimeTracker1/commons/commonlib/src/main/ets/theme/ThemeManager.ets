/**
 * ThemeManager - ä¸»é¢˜ç®¡ç†å™¨
 * æ”¯æŒæµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿä¸‰ç§ä¸»é¢˜æ¨¡å¼
 * 
 * ä½¿ç”¨æ–¹å¼:
 * 1. åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–: ThemeManager.getInstance()
 * 2. åœ¨ç»„ä»¶ä¸­è·å–é¢œè‰²: ThemeManager.getInstance().colors.background
 * 3. åˆ‡æ¢ä¸»é¢˜: ThemeManager.getInstance().setThemeMode('dark')
 */

import preferences from '@ohos.data.preferences';
import type { common } from '@kit.AbilityKit';
import { ConfigurationConstant } from '@kit.AbilityKit';

// ä¸»é¢˜æ¨¡å¼ç±»å‹
export enum ThemeMode {
  LIGHT = 'light',      // æµ…è‰²
  DARK = 'dark',        // æ·±è‰²
  AUTO = 'auto'         // è·Ÿéšç³»ç»Ÿ
}

// ä¸»é¢˜é¢œè‰²é…ç½®æ¥å£
export interface ThemeColors {
  // åŸºç¡€èƒŒæ™¯
  background: string;           // é¡µé¢èƒŒæ™¯è‰²
  cardBackground: string;       // å¡ç‰‡èƒŒæ™¯è‰²
  surfaceBackground: string;    // è¡¨é¢èƒŒæ™¯ï¼ˆå¦‚é¡¶æ ï¼‰
  
  // æ–‡å­—é¢œè‰²
  textPrimary: string;          // ä¸»è¦æ–‡å­—
  textSecondary: string;        // æ¬¡è¦æ–‡å­—
  textHint: string;             // æç¤ºæ–‡å­—
  
  // ä¸»é¢˜è‰²
  primaryColor: string;         // ä¸»è‰²ï¼ˆè“è‰²ï¼‰
  primaryLight: string;         // æµ…ä¸»è‰²
  primaryDark: string;          // æ·±ä¸»è‰²
  
  // åŠŸèƒ½è‰²
  successColor: string;         // æˆåŠŸï¼ˆç»¿è‰²ï¼‰
  warningColor: string;         // è­¦å‘Šï¼ˆæ©™è‰²ï¼‰
  errorColor: string;           // é”™è¯¯ï¼ˆçº¢è‰²ï¼‰
  
  // åˆ†å‰²çº¿å’Œè¾¹æ¡†
  dividerColor: string;         // åˆ†å‰²çº¿
  borderColor: string;          // è¾¹æ¡†
  
  // é˜´å½±
  shadowColor: string;          // é˜´å½±é¢œè‰²
}

// æµ…è‰²ä¸»é¢˜é…ç½®
const LIGHT_THEME: ThemeColors = {
  background: '#F8F9FA',
  cardBackground: '#FFFFFF',
  surfaceBackground: '#FFFFFF',
  
  textPrimary: '#212121',
  textSecondary: '#616161',
  textHint: '#9E9E9E',
  
  primaryColor: '#2196F3',
  primaryLight: '#64B5F6',
  primaryDark: '#1976D2',
  
  successColor: '#4CAF50',
  warningColor: '#FF9800',
  errorColor: '#F44336',
  
  dividerColor: '#E0E0E0',
  borderColor: '#BDBDBD',
  
  shadowColor: 'rgba(0, 0, 0, 0.1)'
};

// æ·±è‰²ä¸»é¢˜é…ç½®ï¼ˆæ ¹æ®ä½ çš„æˆªå›¾è®¾è®¡ï¼‰
const DARK_THEME: ThemeColors = {
  background: '#000000',        // çº¯é»‘èƒŒæ™¯
  cardBackground: '#1C1C1E',    // æ·±ç°å¡ç‰‡
  surfaceBackground: '#1C1C1E', // æ·±ç°è¡¨é¢
  
  textPrimary: '#FFFFFF',       // ç™½è‰²ä¸»æ–‡å­—
  textSecondary: '#8E8E93',     // ç°è‰²æ¬¡æ–‡å­—
  textHint: '#636366',          // æ·±ç°æç¤º
  
  primaryColor: '#0A84FF',      // iOSé£æ ¼æ·±è‰²è“
  primaryLight: '#409EFF',
  primaryDark: '#0066CC',
  
  successColor: '#32D74B',      // iOSé£æ ¼æ·±è‰²ç»¿
  warningColor: '#FF9F0A',      // iOSé£æ ¼æ·±è‰²æ©™
  errorColor: '#FF453A',        // iOSé£æ ¼æ·±è‰²çº¢
  
  dividerColor: '#38383A',      // æ·±è‰²åˆ†å‰²çº¿
  borderColor: '#48484A',       // æ·±è‰²è¾¹æ¡†
  
  shadowColor: 'rgba(0, 0, 0, 0.3)'
};

/**
 * ä¸»é¢˜ç®¡ç†å™¨å•ä¾‹ç±»
 */
export class ThemeManager {
  private static instance: ThemeManager | null = null;
  private themeMode: ThemeMode = ThemeMode.AUTO;
  private _colors: ThemeColors = LIGHT_THEME;
  private preferencesKey: string = 'theme_mode';
  private context?: common.UIAbilityContext;

  private constructor() {
    // ä¸åœ¨æ„é€ å‡½æ•°ä¸­åŠ è½½,ç­‰å¾… context åˆå§‹åŒ–
  }

  /**
   * åˆå§‹åŒ– ThemeManager (åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨)
   */
  public init(context: common.UIAbilityContext): void {
    this.context = context;
    this.loadThemePreference();
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): ThemeManager {
    if (!ThemeManager.instance) {
      ThemeManager.instance = new ThemeManager();
    }
    return ThemeManager.instance;
  }

  /**
   * è·å–å½“å‰ä¸»é¢˜é¢œè‰²é…ç½®
   */
  public get colors(): ThemeColors {
    return this._colors;
  }

  /**
   * è·å–å½“å‰ä¸»é¢˜æ¨¡å¼
   */
  public getThemeMode(): ThemeMode {
    return this.themeMode;
  }

  /**
   * è·å–ä¸»é¢˜æ¨¡å¼çš„æ˜¾ç¤ºåç§°
   */
  public getThemeModeName(): string {
    switch (this.themeMode) {
      case ThemeMode.LIGHT:
        return 'æµ…è‰²';
      case ThemeMode.DARK:
        return 'æ·±è‰²';
      case ThemeMode.AUTO:
        return 'è·Ÿéšç³»ç»Ÿ';
      default:
        return 'è·Ÿéšç³»ç»Ÿ';
    }
  }

  /**
   * è®¾ç½®ä¸»é¢˜æ¨¡å¼
   * @param mode ä¸»é¢˜æ¨¡å¼
   */
  public setThemeMode(mode: ThemeMode): void {
    this.themeMode = mode;
    this.updateColors();
    this.saveThemePreference();
  }

  /**
   * åˆ·æ–°ç³»ç»Ÿä¸»é¢˜ (ç”¨äºç³»ç»Ÿä¸»é¢˜å˜åŒ–æ—¶)
   * åªåœ¨AUTOæ¨¡å¼ä¸‹ç”Ÿæ•ˆ
   */
  public refreshSystemTheme(): void {
    if (this.themeMode === ThemeMode.AUTO) {
      console.info('[ThemeManager] åˆ·æ–°ç³»ç»Ÿä¸»é¢˜');
      this.updateColors();
    }
  }

  /**
   * æ›´æ–°é¢œè‰²é…ç½®
   */
  private updateColors(): void {
    if (this.themeMode === ThemeMode.DARK) {
      this._colors = DARK_THEME;
    } else if (this.themeMode === ThemeMode.LIGHT) {
      this._colors = LIGHT_THEME;
    } else {
      // AUTOæ¨¡å¼ï¼šæ£€æµ‹ç³»ç»Ÿä¸»é¢˜
      const isDarkMode = this.isSystemDarkMode();
      this._colors = isDarkMode ? DARK_THEME : LIGHT_THEME;
    }
  }

  /**
   * æ£€æµ‹ç³»ç»Ÿæ˜¯å¦ä¸ºæ·±è‰²æ¨¡å¼
   */
  private isSystemDarkMode(): boolean {
    if (!this.context) {
      console.warn('[ThemeManager] Contextæœªåˆå§‹åŒ–,é»˜è®¤æµ…è‰²ä¸»é¢˜');
      return false;
    }
    try {
      const config = this.context.config;
      if (config && config.colorMode !== undefined) {
        // HarmonyOS NEXT å®é™…å€¼:
        // COLOR_MODE_DARK = 1 (æ·±è‰²)
        // COLOR_MODE_LIGHT = 0 (æµ…è‰²)
        // COLOR_MODE_NOT_SET = -1 (æœªè®¾ç½®)
        const isDark = config.colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;
        console.info('[ThemeManager] ğŸ¨ ç³»ç»Ÿä¸»é¢˜æ£€æµ‹: colorMode=' + config.colorMode + ', isDark=' + isDark);
        return isDark;
      } else {
        console.warn('[ThemeManager] config.colorModeæœªå®šä¹‰,é»˜è®¤æµ…è‰²ä¸»é¢˜');
      }
    } catch (error) {
      console.error('[ThemeManager] è·å–ç³»ç»Ÿä¸»é¢˜å¤±è´¥:', error);
    }
    return false;
  }

  /**
   * åŠ è½½ä¸»é¢˜åå¥½è®¾ç½®
   */
  private async loadThemePreference(): Promise<void> {
    if (!this.context) {
      console.warn('[ThemeManager] Context æœªåˆå§‹åŒ–,ä½¿ç”¨é»˜è®¤ä¸»é¢˜');
      this.themeMode = ThemeMode.AUTO;
      this.updateColors();
      return;
    }

    try {
      const prefs = await preferences.getPreferences(this.context, 'theme_settings');
      const savedMode = await prefs.get(this.preferencesKey, ThemeMode.AUTO) as string;
      this.themeMode = savedMode as ThemeMode;
      this.updateColors();
    } catch (error) {
      console.error('[ThemeManager] åŠ è½½ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
      this.themeMode = ThemeMode.AUTO;
      this.updateColors();
    }
  }

  /**
   * ä¿å­˜ä¸»é¢˜åå¥½è®¾ç½®
   */
  private async saveThemePreference(): Promise<void> {
    if (!this.context) {
      console.warn('[ThemeManager] Context æœªåˆå§‹åŒ–,æ— æ³•ä¿å­˜ä¸»é¢˜è®¾ç½®');
      return;
    }

    try {
      const prefs = await preferences.getPreferences(this.context, 'theme_settings');
      await prefs.put(this.preferencesKey, this.themeMode);
      await prefs.flush();
      console.info('[ThemeManager] ä¸»é¢˜è®¾ç½®å·²ä¿å­˜:', this.themeMode);
    } catch (error) {
      console.error('[ThemeManager] ä¿å­˜ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
    }
  }
}
