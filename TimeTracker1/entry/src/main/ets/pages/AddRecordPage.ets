/**
 * AddRecordPage.ets - æ·»åŠ /ç¼–è¾‘å·¥æ—¶è®°å½•é¡µé¢
 * 
 * åŠŸèƒ½ï¼š
 * - é€‰æ‹©å·¥ä½œç±»å‹ï¼ˆ9ç§ç±»å‹ï¼‰
 * - è¾“å…¥é¡¹ç›®åç§°
 * - è®¾ç½®æ—¶è–ª
 * - é€‰æ‹©å¼€å§‹/ç»“æŸæ—¶é—´
 * - é€‰æ‹©æ—¥æœŸ
 * - ä¿å­˜å·¥æ—¶è®°å½•
 */

import { router } from '@kit.ArkUI';
import type { WorkRecord, WorkType, WorkRecordFields } from '@ohos/commonlib';
import { storageUtils, EventBus, EventKey, ThemeManager, type ThemeColors } from '@ohos/commonlib';
import promptAction from '@ohos.promptAction';

// è¯†åˆ«å†å²è®°å½•æ¥å£
interface RecognitionHistoryItem {
  text: string;
  parsedFields: WorkRecordFields;
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParams {
  recordId?: string;
  date?: string;
  voiceParsedData?: WorkRecordFields;
  recognitionHistory?: RecognitionHistoryItem[];
}

// å¸¸é‡å®šä¹‰
const DEFAULT_HOURLY_RATE = 30;
const HOURS_IN_DAY = 24;
const MINUTES_IN_HOUR = 60;
const HOURS_IN_HALF_DAY = 12;
const PRECISION_MULTIPLIER = 100;
const TIME_PAD_LENGTH = 2;
const RANDOM_ID_LENGTH = 9;
const RADIX_36 = 36;
const TOAST_DURATION = 3000;
const FIRST_INDEX = 0;
const SECOND_INDEX = 1;
const THIRD_INDEX = 2;

// ç­æ¬¡ç±»å‹å®šä¹‰
const WORK_TYPES: WorkType[] = [
  { id: 'day', name: 'ç™½ç­', icon: 'BUG', color: '#2196F3' },
  { id: 'night', name: 'å¤œç­', icon: 'BUG', color: '#9C27B0' },
  { id: 'rest', name: 'ä¼‘æ¯', icon: 'BUG', color: '#4CAF50' },
  { id: 'morning', name: 'æ—©ç­', icon: 'BUG', color: '#FF9800' },
  { id: 'afternoon', name: 'ä¸­ç­', icon: 'BUG', color: '#00BCD4' },
  { id: 'evening', name: 'æ™šç­', icon: 'BUG', color: '#795548' }
];

@Entry
@Component
struct AddRecordPage {
  // ä¸»é¢˜ç®¡ç†
  @StorageProp('themeColors') themeColors: ThemeColors = ThemeManager.getInstance().colors
  private themeManager: ThemeManager = ThemeManager.getInstance()

  // è·¯ç”±å‚æ•°
  @State editRecordId: string = '' // å¦‚æœæœ‰å€¼åˆ™ä¸ºç¼–è¾‘æ¨¡å¼
  @State preSelectedDate: string = '' // é¢„é€‰æ—¥æœŸ

  // è¡¨å•çŠ¶æ€
  @State selectedTypeId: string = '' // é€‰ä¸­çš„ç­æ¬¡ç±»å‹
  @State projectName: string = '' // é¡¹ç›®åç§°
  @State hourlyRate: number = DEFAULT_HOURLY_RATE // æ—¶è–ª
  @State startTime: string = '' // å¼€å§‹æ—¶é—´ "HH:mm"
  @State endTime: string = '' // ç»“æŸæ—¶é—´ "HH:mm"
  @State selectedDate: Date = new Date() // é€‰ä¸­çš„æ—¥æœŸ
  @State duration: number = FIRST_INDEX // è®¡ç®—å‡ºçš„æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  @State allowance: number = FIRST_INDEX // è¡¥è´´
  @State deduction: number = FIRST_INDEX // æ‰£æ¬¾
  @State remarks: string = '' // å¤‡æ³¨

  // UIçŠ¶æ€
  @State showTimePicker: boolean = false
  @State showDatePicker: boolean = false
  @State timePickerType: 'start' | 'end' = 'start' // å½“å‰é€‰æ‹©çš„æ—¶é—´ç±»å‹
  @State recognitionHistory: RecognitionHistoryItem[] = [] // è¯†åˆ«å†å²è®°å½•
  @State showHistoryPanel: boolean = false // æ˜¯å¦æ˜¾ç¤ºå†å²è®°å½•é¢æ¿

  aboutToAppear(): void {
    // è·å–è·¯ç”±å‚æ•°ï¼ˆä½¿ç”¨ç±»å‹æ–­è¨€å¤„ç†ï¼‰
    const params = router.getParams() as RouterParams | undefined;
    this.editRecordId = params?.recordId || '';
    this.preSelectedDate = params?.date || '';

    // æ£€æŸ¥æ˜¯å¦æœ‰è¯­éŸ³è§£ææ•°æ®
    const voiceParsedData = params?.voiceParsedData;
    const recognitionHistory = params?.recognitionHistory;
    if (voiceParsedData) {
      this.handleVoiceParsedData(voiceParsedData);
      // ä¿å­˜è¯†åˆ«å†å²
      if (recognitionHistory) {
        this.recognitionHistory = recognitionHistory;
      }
      return;
    }

    // å¦‚æœæœ‰é¢„é€‰æ—¥æœŸï¼Œè®¾ç½®ä¸ºå½“å‰æ—¥æœŸ
    if (this.preSelectedDate) {
      this.selectedDate = new Date(this.preSelectedDate);
    }

    // åˆå§‹åŒ–é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´(å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼)
    if (!this.editRecordId) {
      const now = new Date();
      const hours = now.getHours().toString().padStart(TIME_PAD_LENGTH, '0');
      const minutes = now.getMinutes().toString().padStart(TIME_PAD_LENGTH, '0');
      this.startTime = `${hours}:${minutes}`;
      // ç»“æŸæ—¶é—´é»˜è®¤ä¸ºå¼€å§‹æ—¶é—´+1å°æ—¶
      const endHours = ((now.getHours() + SECOND_INDEX) % HOURS_IN_DAY).toString().padStart(TIME_PAD_LENGTH, '0');
      this.endTime = `${endHours}:${minutes}`;
      this.calculateDuration();
    }

    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½è®°å½•æ•°æ®
    if (this.editRecordId) {
      this.loadRecordData();
    }
  }

  /**
   * å¤„ç†è¯­éŸ³è§£ææ•°æ®
   * @param data è¯­éŸ³è§£æåçš„å­—æ®µæ•°æ®
   */
  handleVoiceParsedData(data: WorkRecordFields): void {
    // è®¾ç½®æ—¥æœŸ
    if (data.date) {
      this.selectedDate = new Date(data.date);
    }

    // è®¾ç½®ä»»åŠ¡å
    if (data.taskName) {
      this.projectName = data.taskName;
    }

    // è®¾ç½®å·¥æ—¶
    if (data.normalHours > 0 || data.overtimeHours > 0) {
      const totalHours = data.normalHours + data.overtimeHours;
      // å‡è®¾å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼Œç»“æŸæ—¶é—´ä¸ºå¼€å§‹æ—¶é—´+æ€»å·¥æ—¶
      const now = new Date();
      const startHours = now.getHours().toString().padStart(TIME_PAD_LENGTH, '0');
      const minutes = now.getMinutes().toString().padStart(TIME_PAD_LENGTH, '0');
      this.startTime = `${startHours}:${minutes}`;
      
      // è®¡ç®—ç»“æŸæ—¶é—´
      const endDate = new Date(now);
      endDate.setHours(now.getHours() + totalHours);
      const endHours = endDate.getHours().toString().padStart(TIME_PAD_LENGTH, '0');
      this.endTime = `${endHours}:${minutes}`;
      
      this.duration = totalHours;
    }

    // è®¾ç½®é¡¹ç›®ç±»å‹ï¼ˆé»˜è®¤ç™½ç­ï¼‰
    this.selectedTypeId = 'day';
  }

  /**
   * é‡æ–°è¯†åˆ«æŒ‡å®šçš„å†å²è®°å½•
   * @param item å†å²è®°å½•é¡¹
   */
  private reRecognizeHistoryItem(item: RecognitionHistoryItem): void {
    this.handleVoiceParsedData(item.parsedFields);
  }

  /**
   * åˆ‡æ¢å†å²è®°å½•é¢æ¿æ˜¾ç¤º
   */
  private toggleHistoryPanel(): void {
    this.showHistoryPanel = !this.showHistoryPanel;
  }

  // åŠ è½½è®°å½•æ•°æ®
  async loadRecordData(): Promise<void> {
    const records: WorkRecord[] = await storageUtils.getAllWorkRecords();
    const record = records.find(r => r.id === this.editRecordId);
    if (record) {
      this.selectedTypeId = record.projectType;
      this.projectName = record.projectName;
      this.hourlyRate = record.hourlyWage;
      this.startTime = record.startTime;
      this.endTime = record.endTime;
      // ä½¿ç”¨å­—ç¬¦ä¸²splité¿å…æ—¶åŒºé—®é¢˜
      const dateParts = record.date.split('-');
      this.selectedDate = new Date(parseInt(dateParts[FIRST_INDEX]), parseInt(dateParts[SECOND_INDEX]) - SECOND_INDEX, parseInt(dateParts[THIRD_INDEX]));
      this.duration = record.duration;
      this.allowance = record.allowance;
      this.deduction = record.deduction;
      this.remarks = record.remarks;
    }
  }

  // è®¡ç®—æ—¶é•¿
  calculateDuration(): void {
    if (!this.startTime || !this.endTime) {
      this.duration = FIRST_INDEX;
      return;
    }

    const startParts: string[] = this.startTime.split(':');
    const startHour: number = parseInt(startParts[FIRST_INDEX]);
    const startMin: number = parseInt(startParts[SECOND_INDEX]);
    const endParts: string[] = this.endTime.split(':');
    const endHour: number = parseInt(endParts[FIRST_INDEX]);
    const endMin: number = parseInt(endParts[SECOND_INDEX]);

    const startMinutes = startHour * MINUTES_IN_HOUR + startMin;
    const endMinutes = endHour * MINUTES_IN_HOUR + endMin;

    let durationMinutes = endMinutes - startMinutes;
    if (durationMinutes < FIRST_INDEX) {
      durationMinutes += HOURS_IN_DAY * MINUTES_IN_HOUR; // è·¨å¤©å¤„ç†
    }

    this.duration = Math.round(durationMinutes / MINUTES_IN_HOUR * PRECISION_MULTIPLIER) / PRECISION_MULTIPLIER; // ä¿ç•™2ä½å°æ•°
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(time: string): string {
    if (!time) {
      return 'é€‰æ‹©æ—¶é—´';
    }
    const timeParts: string[] = time.split(':');
    const hour: number = parseInt(timeParts[FIRST_INDEX]);
    const min: number = parseInt(timeParts[SECOND_INDEX]);
    const period = hour >= HOURS_IN_HALF_DAY ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
    const displayHour = hour > HOURS_IN_HALF_DAY ? hour - HOURS_IN_HALF_DAY : (hour === FIRST_INDEX ? HOURS_IN_HALF_DAY : hour);
    return `${displayHour}:${min.toString().padStart(TIME_PAD_LENGTH, '0')} ${period}`;
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(): string {
    const today = new Date();
    const isToday = this.selectedDate.toDateString() === today.toDateString();
    
    const year = this.selectedDate.getFullYear();
    const month = this.selectedDate.getMonth() + SECOND_INDEX;
    const day = this.selectedDate.getDate();

    if (isToday) {
      return `ä»Šå¤©, ${month}æœˆ${day}æ—¥, ${year}`;
    } else {
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }
  }

  // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
  formatDuration(): string {
    const hours = Math.floor(this.duration);
    const minutes = Math.round((this.duration - hours) * MINUTES_IN_HOUR);
    return `${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ`;
  }

  // ä¿å­˜è®°å½•
  async saveRecord(): Promise<void> {
    console.info('[TimeTracker] å¼€å§‹ä¿å­˜ï¼ŒselectedTypeId=' + this.selectedTypeId + ', projectName=' + this.projectName);
    
    // éªŒè¯å¿…å¡«é¡¹
    if (!this.projectName.trim()) {
      try {
        promptAction.showToast({ 
          message: 'è¯·è¾“å…¥é¡¹ç›®åç§°',
          duration: TOAST_DURATION,
          bottom: '50%'
        });
      } catch (err) {
        console.error('Failed to show toast:', (err as Error).message);
      }
      return;
    }
    if (!this.startTime || !this.endTime) {
      try {
        promptAction.showToast({ 
          message: 'è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´',
          duration: TOAST_DURATION,
          bottom: '50%'
        });
      } catch (err) {
        console.error('Failed to show toast:', (err as Error).message);
      }
      return;
    }
    if (this.duration <= FIRST_INDEX) {
      try {
        promptAction.showToast({ 
          message: 'å·¥ä½œæ—¶é•¿å¿…é¡»å¤§äº0',
          duration: TOAST_DURATION,
          bottom: '50%'
        });
      } catch (err) {
        console.error('Failed to show toast:', (err as Error).message);
      }
      return;
    }

    // æ ¼å¼åŒ–æ—¥æœŸä¸ºæœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
    const year = this.selectedDate.getFullYear();
    const month = (this.selectedDate.getMonth() + SECOND_INDEX).toString().padStart(TIME_PAD_LENGTH, '0');
    const day = this.selectedDate.getDate().toString().padStart(TIME_PAD_LENGTH, '0');
    const dateStr = `${year}-${month}-${day}`;
    
    console.info('[TimeTracker] ä¿å­˜æ—¥æœŸ=' + dateStr);
    
    const record: WorkRecord = {
      id: this.editRecordId || `${Date.now()}_${Math.random().toString(RADIX_36).substr(TIME_PAD_LENGTH, RANDOM_ID_LENGTH)}`,
      date: dateStr,
      startTime: this.startTime,
      endTime: this.endTime,
      duration: this.duration,
      projectType: this.selectedTypeId,
      projectName: this.projectName.trim(),
      hourlyWage: this.hourlyRate,
      allowance: this.allowance,
      deduction: this.deduction,
      remarks: this.remarks.trim(),
      createdAt: this.editRecordId ? '' : new Date().toISOString() // ç¼–è¾‘æ—¶ä¿æŒåŸåˆ›å»ºæ—¶é—´
    };

    console.info(`[TimeTracker] å‡†å¤‡ä¿å­˜è®°å½•: ${JSON.stringify(record)}`);

    if (this.editRecordId) {
      // æ›´æ–°è®°å½•ï¼šå…ˆåˆ é™¤æ—§è®°å½•ï¼Œå†æ·»åŠ æ–°è®°å½•
      await storageUtils.deleteWorkRecord(this.editRecordId);
      await storageUtils.saveWorkRecord(record);
      try {
        promptAction.showToast({ message: 'æ›´æ–°æˆåŠŸ' });
      } catch (err) {
        console.error('Failed to show toast:', (err as Error).message);
      }
    } else {
      await storageUtils.saveWorkRecord(record);
      console.info('[TimeTracker] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡è¿”å›å¹¶åˆ·æ–°é¦–é¡µ');
      try {
        promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
      } catch (err) {
        console.error('Failed to show toast:', (err as Error).message);
      }
    }

    // å‘é€å…¨å±€åˆ·æ–°äº‹ä»¶ï¼Œé€šçŸ¥é¦–é¡µæ›´æ–°æ•°æ®
    console.info('[TimeTracker] ğŸ”” å‘é€å…¨å±€åˆ·æ–°äº‹ä»¶');
    EventBus.instance.emit(EventKey.GLOBAL_REFRESH_EVENT);
    console.info('[TimeTracker] ğŸ”™ è¿”å›é¦–é¡µ');
    router.back();
  }

  // ç­æ¬¡é€‰æ‹©å™¨
  @Builder WorkTypeSelector() {
    Column() {
      Text('ç­æ¬¡é€‰æ‹©ï¼ˆå¯é€‰ï¼‰')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.themeColors.textSecondary)
        .margin({ bottom: 16 })

      // 3x3ç½‘æ ¼
      Grid() {
        ForEach(WORK_TYPES, (type: WorkType) => {
          GridItem() {
            Column() {
              // å›¾æ ‡
              Image($r(`app.media.${type.icon}`))
                .width(24)
                .height(24)
                .fillColor(type.color)
              
              // æ ‡ç­¾
              Text(type.name)
                .fontSize(12)
                .fontColor(this.themeColors.textPrimary)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 4 })
            }
            .width(60)
            .height(60)
            .backgroundColor(this.selectedTypeId === type.id ? this.themeColors.background : this.themeColors.cardBackground)
            .borderRadius(12)
            .border({
              width: this.selectedTypeId === type.id ? 2 : 1,
              color: this.selectedTypeId === type.id ? this.themeColors.primaryColor : this.themeColors.dividerColor
            })
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              this.selectedTypeId = type.id;
            })
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .width('100%')
      .height(132) // 60*2 + 12*1
      .backgroundColor(this.themeColors.background)
    }
    .alignItems(HorizontalAlign.Start)
  }

  // è·å–å›¾æ ‡å­—ç¬¦ï¼ˆç®€åŒ–ç‰ˆï¼‰


  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // å…³é—­æŒ‰é’®
        Button() {
          Image($r('app.media.CloseSmall'))
            .width(24)
            .height(24)
            .fillColor(this.themeColors.textSecondary)
        }
        .width(44)
        .height(44)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })

        // æ ‡é¢˜
        Text(this.editRecordId ? 'ç¼–è¾‘å·¥æ—¶è®°å½•' : 'æ·»åŠ å·¥æ—¶è®°å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.themeColors.textPrimary)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å³ä¾§å ä½ï¼ˆä¿æŒå¯¹ç§°ï¼‰
        Row()
          .width(44)
          .height(44)
      }
      .width('100%')
      .height(56)
      .padding({ left: 8, right: 8, top: 60 })
      .backgroundColor(this.themeColors.surfaceBackground)

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // æ—¶é•¿æ˜¾ç¤º
          Column() {
            Text(this.formatDuration())
              .fontSize(40)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.themeColors.textPrimary)
            
            Text('å·¥ä½œæ—¶é•¿')
              .fontSize(14)
              .fontColor(this.themeColors.textSecondary)
              .margin({ top: 8 })
          }
          .width('100%')
          .height(100)
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 16 })

          // æ—¶é—´é€‰æ‹©åŒºåŸŸ
          Column() {
            Text('æ—¶é—´é€‰æ‹©')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.themeColors.textSecondary)
              .margin({ bottom: 16 })

            // å¼€å§‹æ—¶é—´
            Row() {
              Image($r('sys.symbol.clock'))
                .width(20)
                .height(20)
                .fillColor(this.themeColors.primaryColor)
                .margin({ right: 12 })
              
              Text('å¼€å§‹æ—¶é—´')
                .fontSize(16)
                .fontColor(this.themeColors.textPrimary)
                .layoutWeight(1)
              
              Text(this.formatTime(this.startTime))
                .fontSize(16)
                .fontColor(this.themeColors.primaryColor)
            }
            .width('100%')
            .height(48)
            .padding({ left: 12, right: 12 })
            .onClick(() => {
              this.showStartTimePicker();
            })

            // ç»“æŸæ—¶é—´
            Row() {
              Image($r('sys.symbol.clock'))
                .width(20)
                .height(20)
                .fillColor(this.themeColors.primaryColor)
                .margin({ right: 12 })
              
              Text('ç»“æŸæ—¶é—´')
                .fontSize(16)
                .fontColor(this.themeColors.textPrimary)
                .layoutWeight(1)
              
              Text(this.formatTime(this.endTime))
                .fontSize(16)
                .fontColor(this.themeColors.primaryColor)
            }
            .width('100%')
            .height(48)
            .padding({ left: 12, right: 12 })
            .margin({ top: 8 })
            .onClick(() => {
              this.showEndTimePicker();
            })

            // æ—¶é•¿ç»“æœ
            Row() {
              Text(`æ—¶é•¿: ${this.formatDuration()}`)
                .fontSize(14)
                .fontColor(this.themeColors.primaryColor)
            }
            .width('100%')
            .padding(8)
            .backgroundColor(this.themeColors.background)
            .borderRadius(4)
            .margin({ top: 12 })
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding(16)
          .backgroundColor(this.themeColors.cardBackground)
          .borderRadius(12)
          .margin({ bottom: 16 })

          // æ—¥æœŸé€‰æ‹©
          Column() {
            Text('æ—¥æœŸ')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.themeColors.textSecondary)
              .margin({ bottom: 8 })

            Row() {
              Image($r('sys.symbol.calendar'))
                .width(20)
                .height(20)
                .fillColor(this.themeColors.primaryColor)
                .margin({ right: 12 })
              
              Text(this.formatDate())
                .fontSize(16)
                .fontColor(this.themeColors.textPrimary)
            }
            .width('100%')
            .height(48)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.themeColors.cardBackground)
            .borderRadius(8)
            .onClick(() => {
              this.showDatePicker = true;
            })
          }
          .width('100%')
          .margin({ bottom: 24 })

          // å·¥ä½œç±»å‹é€‰æ‹©å™¨
          this.WorkTypeSelector()

          // é¡¹ç›®åç§°è¾“å…¥
          Row() {
            Image($r('sys.symbol.briefcase'))
              .width(20)
              .height(20)
              .fillColor(this.themeColors.textSecondary)
              .margin({ right: 12 })
            
            TextInput({ placeholder: 'é¡¹ç›®åç§°', text: this.projectName })
              .fontSize(18)
              .fontColor(this.themeColors.textPrimary)
              .backgroundColor(Color.Transparent)
              .layoutWeight(1)
              .onChange((value: string) => {
                this.projectName = value;
              })
          }
          .width('100%')
          .height(48)
          .padding({ left: 12, right: 12 })
          .backgroundColor(this.themeColors.cardBackground)
          .borderRadius(8)
          .margin({ top: 16 })

          // æ—¶è–ªè¾“å…¥
          Row() {
            Text('Â¥')
              .fontSize(20)
              .fontColor(this.themeColors.textSecondary)
              .margin({ right: 12 })
            
            TextInput({ placeholder: 'æ—¶è–ª', text: this.hourlyRate.toString() })
              .fontSize(18)
              .fontColor(this.themeColors.textPrimary)
              .backgroundColor(Color.Transparent)
              .layoutWeight(1)
              .type(InputType.Number)
              .onChange((value: string) => {
                const parsed = parseInt(value);
                if (!isNaN(parsed)) {
                  this.hourlyRate = parsed;
                } else if (value === '') {
                  this.hourlyRate = 0;
                }
              })
            
            Text('/å°æ—¶')
              .fontSize(16)
              .fontColor(this.themeColors.textSecondary)
          }
          .width('100%')
          .height(48)
          .padding({ left: 12, right: 12 })
          .backgroundColor(this.themeColors.cardBackground)
          .borderRadius(8)
          .margin({ top: 8 })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring) // æ·»åŠ å¼¹ç°§å›å¼¹æ•ˆæœ

      // åº•éƒ¨ä¿å­˜æŒ‰é’®
      Button('ä¿å­˜å·¥ä½œè®°å½•')
        .width('calc(100% - 32vp)')
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(this.themeColors.primaryColor)
        .borderRadius(12)
        .margin({ left: 16, right: 16, top: 8, bottom: 40 })
        .onClick(() => {
          this.saveRecord()
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColors.background)
    .bindSheet($$this.showDatePicker, this.DatePickerBuilder(), {
      height: 400,
      backgroundColor: this.themeColors.cardBackground,
      onDisappear: () => {
        this.showDatePicker = false;
      }
    })
  }

  // æ˜¾ç¤ºå¼€å§‹æ—¶é—´é€‰æ‹©å™¨
  showStartTimePicker() {
    const timeParts = this.startTime.split(':');
    const hour = parseInt(timeParts[0]);
    const minute = parseInt(timeParts[1]);
    
    TimePickerDialog.show({
      selected: new Date(2024, 0, 1, hour, minute),
      useMilitaryTime: true,
      backgroundColor: this.themeColors.cardBackground,
      onAccept: (value: TimePickerResult) => {
        const h = value.hour !== undefined ? value.hour : 0;
        const m = value.minute !== undefined ? value.minute : 0;
        this.startTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        this.calculateDuration();
      }
    })
  }

  // æ˜¾ç¤ºç»“æŸæ—¶é—´é€‰æ‹©å™¨
  showEndTimePicker() {
    const timeParts = this.endTime.split(':');
    const hour = parseInt(timeParts[0]);
    const minute = parseInt(timeParts[1]);
    
    TimePickerDialog.show({
      selected: new Date(2024, 0, 1, hour, minute),
      useMilitaryTime: true,
      backgroundColor: this.themeColors.cardBackground,
      onAccept: (value: TimePickerResult) => {
        const h = value.hour !== undefined ? value.hour : 0;
        const m = value.minute !== undefined ? value.minute : 0;
        this.endTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        this.calculateDuration();
      }
    })
  }

  // æ—¶é—´é€‰æ‹©å™¨ (å·²å¼ƒç”¨ï¼Œæ”¹ç”¨TimePickerDialog)
  @Builder TimePickerBuilder() {
    Column() {
      Text(this.timePickerType === 'start' ? 'é€‰æ‹©å¼€å§‹æ—¶é—´' : 'é€‰æ‹©ç»“æŸæ—¶é—´')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 20 })

      TimePicker()
        .useMilitaryTime(true)
        .onChange((value: TimePickerResult) => {
          const hour = value.hour ?? 0;
          const minute = value.minute ?? 0;
          const time: string = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          if (this.timePickerType === 'start') {
            this.startTime = time;
          } else {
            this.endTime = time;
          }
          this.calculateDuration();
        })

      Button('ç¡®å®š')
        .width('calc(100% - 32vp)')
        .height(44)
        .margin({ top: 20 })
        .onClick(() => {
          this.showTimePicker = false;
        })
    }
    .width('100%')
    .padding(16)
  }

  // æ—¥æœŸé€‰æ‹©å™¨
  @Builder DatePickerBuilder() {
    Column() {
      Text('é€‰æ‹©æ—¥æœŸ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.themeColors.textPrimary)
        .margin({ top: 20, bottom: 20 })

      DatePicker({
        start: new Date('2020-01-01'),
        end: new Date('2030-12-31'),
        selected: this.selectedDate
      })
      .backgroundColor(this.themeColors.cardBackground)
      .onChange((value: DatePickerResult) => {
        this.selectedDate = new Date(value.year!, value.month!, value.day!);
      })

      Button('ç¡®å®š')
        .width('calc(100% - 32vp)')
        .height(44)
        .margin({ top: 20 })
        .backgroundColor(this.themeColors.primaryColor)
        .onClick(() => {
          this.showDatePicker = false;
        })
    }
    .width('100%')
    .backgroundColor(this.themeColors.cardBackground)
  }
}
