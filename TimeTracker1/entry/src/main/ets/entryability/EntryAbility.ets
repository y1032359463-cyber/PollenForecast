import { AbilityConstant, ConfigurationConstant, UIAbility, Want, common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { storageUtils, GlobalContext, ThemeManager, ThemeMode, EventBus } from '@ohos/commonlib';
import type { WorkRecord } from '@ohos/commonlib';

const DOMAIN = 0x0000;

export default class EntryAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    try {
      // è®¾ç½®å…¨å±€ä¸Šä¸‹æ–‡
      GlobalContext.setContext(this.context);
      
      // åˆå§‹åŒ– AppStorage ä¸­çš„ä¸Šä¸‹æ–‡ï¼ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰
      AppStorage.setOrCreate<Context>('appContext', this.context);
      AppStorage.setOrCreate<common.UIAbilityContext>('uiAbilityContext', this.context);
      
      // åˆå§‹åŒ– EventBus
      EventBus.init(this.context);
      
      // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
      ThemeManager.getInstance().init(this.context);
      
      // åˆå§‹åŒ–AppStorageä¸­çš„ä¸»é¢˜é¢œè‰²å’Œä¸»é¢˜æ¨¡å¼(ä¾›æ‰€æœ‰é¡µé¢ä½¿ç”¨)
      const initialColors = ThemeManager.getInstance().colors;
      const initialMode = ThemeManager.getInstance().getThemeMode();
      
      AppStorage.setOrCreate('themeColors', initialColors);
      AppStorage.setOrCreate('currentThemeMode', initialMode);
      
      hilog.info(DOMAIN, 'testTag', 'ğŸ¨ åˆå§‹åŒ–ä¸»é¢˜: mode=%{public}s, background=%{public}s', 
        initialMode, initialColors.background);
      
      // åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–å·¥å…·
      storageUtils.init().then(async () => {
        hilog.info(DOMAIN, 'testTag', 'StorageUtils initialized successfully');
        // æ·»åŠ æµ‹è¯•æ•°æ®ï¼ˆä»…é¦–æ¬¡å¯åŠ¨ï¼‰
        await this.initTestData();
      }).catch((err: Error) => {
        hilog.error(DOMAIN, 'testTag', 'Failed to initialize StorageUtils: %{public}s', err.message);
      });
      
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');
  }

  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }

  onWindowStageCreate(windowStage: window.WindowStage): void {
    // Main window is created, set main page for this ability
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    // å…ˆåŠ è½½å¯åŠ¨é¡µ
    windowStage.loadContent('pages/SplashPage', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      
      // è®¾ç½®æ²‰æµ¸å¼çŠ¶æ€æ 
      windowStage.getMainWindow().then((mainWindow: window.Window) => {
        // è·å–çŠ¶æ€æ é«˜åº¦
        const avoidArea: window.AvoidArea = mainWindow.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
        const statusBarHeight: number = avoidArea.topRect.height;
        AppStorage.setOrCreate('statusBarHeight', statusBarHeight);
        hilog.info(DOMAIN, 'testTag', 'StatusBar height: %{public}d', statusBarHeight);
        
        // è®¾ç½®å…¨å±å¸ƒå±€ï¼ˆå»¶ä¼¸åˆ°çŠ¶æ€æ ï¼‰
        mainWindow.setWindowLayoutFullScreen(true);
      });
      
      // 2ç§’åè·³è½¬åˆ°ä¸»é¡µ
      setTimeout(() => {
        windowStage.loadContent('pages/Index', (err) => {
          if (err.code) {
            hilog.error(DOMAIN, 'testTag', 'Failed to load Index page. Cause: %{public}s', JSON.stringify(err));
            return;
          }
          hilog.info(DOMAIN, 'testTag', 'Succeeded in loading Index page.');
        });
      }, 2000);
      
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the splash content.');
    });
  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ç³»ç»Ÿä¸»é¢˜ (ç”¨æˆ·å¯èƒ½åœ¨åå°åˆ‡æ¢äº†ç³»ç»Ÿä¸»é¢˜)
    const themeManager = ThemeManager.getInstance();
    if (themeManager.getThemeMode() === ThemeMode.AUTO) {
      hilog.info(DOMAIN, 'testTag', 'ğŸ¨ åº”ç”¨å‰å°,æ£€æŸ¥ç³»ç»Ÿä¸»é¢˜');
      themeManager.refreshSystemTheme();
      
      // æ›´æ–°AppStorage
      const colors = themeManager.colors;
      const newColors: import('@ohos/commonlib').ThemeColors = {
        background: colors.background,
        cardBackground: colors.cardBackground,
        surfaceBackground: colors.surfaceBackground,
        textPrimary: colors.textPrimary,
        textSecondary: colors.textSecondary,
        textHint: colors.textHint,
        primaryColor: colors.primaryColor,
        primaryLight: colors.primaryLight,
        primaryDark: colors.primaryDark,
        successColor: colors.successColor,
        warningColor: colors.warningColor,
        errorColor: colors.errorColor,
        dividerColor: colors.dividerColor,
        borderColor: colors.borderColor,
        shadowColor: colors.shadowColor
      };
      AppStorage.set('themeColors', newColors);
    }
  }

  onBackground(): void {
    // Ability has back to background
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onBackground');
  }

  /**
   * ç›‘å¬ç³»ç»Ÿé…ç½®å˜åŒ–(å¦‚ä¸»é¢˜åˆ‡æ¢)
   */
  onConfigurationUpdate(newConfig: import('@kit.AbilityKit').Configuration): void {
    hilog.info(DOMAIN, 'testTag', 'ğŸ¨ ç³»ç»Ÿé…ç½®å˜åŒ– colorMode: %{public}d', newConfig.colorMode ?? -1);
    
    // å¦‚æœç”¨æˆ·è®¾ç½®çš„æ˜¯"è·Ÿéšç³»ç»Ÿ",åˆ™æ›´æ–°ä¸»é¢˜
    const themeManager = ThemeManager.getInstance();
    const currentMode = themeManager.getThemeMode();
    
    hilog.info(DOMAIN, 'testTag', 'ğŸ¨ å½“å‰ä¸»é¢˜æ¨¡å¼: %{public}s', currentMode);
    
    if (currentMode === ThemeMode.AUTO) {
      hilog.info(DOMAIN, 'testTag', 'ğŸ¨ AUTOæ¨¡å¼,å¼€å§‹åˆ·æ–°ç³»ç»Ÿä¸»é¢˜');
      
      // ä½¿ç”¨ä¸“é—¨çš„åˆ·æ–°æ–¹æ³•,ä¸é‡æ–°åˆå§‹åŒ–context
      themeManager.refreshSystemTheme();
      
      // æ‰‹åŠ¨åˆ›å»ºæ–°çš„é¢œè‰²å¯¹è±¡,è§¦å‘AppStorageç›‘å¬
      const colors = themeManager.colors;
      const newColors: import('@ohos/commonlib').ThemeColors = {
        background: colors.background,
        cardBackground: colors.cardBackground,
        surfaceBackground: colors.surfaceBackground,
        textPrimary: colors.textPrimary,
        textSecondary: colors.textSecondary,
        textHint: colors.textHint,
        primaryColor: colors.primaryColor,
        primaryLight: colors.primaryLight,
        primaryDark: colors.primaryDark,
        successColor: colors.successColor,
        warningColor: colors.warningColor,
        errorColor: colors.errorColor,
        dividerColor: colors.dividerColor,
        borderColor: colors.borderColor,
        shadowColor: colors.shadowColor
      };
      
      AppStorage.set('themeColors', newColors);
      AppStorage.set('currentThemeMode', ThemeMode.AUTO);
      
      hilog.info(DOMAIN, 'testTag', 'ğŸ¨ ç³»ç»Ÿä¸»é¢˜å·²æ›´æ–°: background=%{public}s', newColors.background);
    } else {
      hilog.info(DOMAIN, 'testTag', 'ğŸ¨ éAUTOæ¨¡å¼,è·³è¿‡ç³»ç»Ÿä¸»é¢˜åˆ·æ–°');
    }
  }

  /**
   * åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼ˆä»…é¦–æ¬¡å¯åŠ¨æ—¶æ·»åŠ ï¼‰
   */
  private async initTestData(): Promise<void> {
    try {
      const records = await storageUtils.getAllWorkRecords();
      if (records.length > 0) {
        hilog.info(DOMAIN, 'testTag', 'Test data already exists, skip initialization');
        return;
      }

      // å½“å‰æ—¥æœŸ
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();

      // æ·»åŠ 6æ¡æµ‹è¯•è®°å½•ï¼ˆæœ¬æœˆä¸åŒæ—¥æœŸï¼‰
      const testRecords: WorkRecord[] = [
        {
          id: `test_${Date.now()}_1`,
          date: `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-15`,
          startTime: '09:00',
          endTime: '17:00',
          duration: 8,
          projectType: 'dev',
          projectName: 'TimeTrackerå¼€å‘',
          hourlyWage: 50,
          allowance: 20,
          deduction: 0,
          remarks: 'å®Œæˆé¦–é¡µæ—¥å†åŠŸèƒ½',
          createdAt: new Date().toISOString()
        },
        {
          id: `test_${Date.now()}_2`,
          date: `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-16`,
          startTime: '10:00',
          endTime: '18:00',
          duration: 8,
          projectType: 'design',
          projectName: 'UIè®¾è®¡ä¼˜åŒ–',
          hourlyWage: 60,
          allowance: 0,
          deduction: 0,
          remarks: 'Figmaè®¾è®¡å®¡æŸ¥',
          createdAt: new Date().toISOString()
        },
        {
          id: `test_${Date.now()}_3`,
          date: `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-17`,
          startTime: '14:00',
          endTime: '18:00',
          duration: 4,
          projectType: 'meeting',
          projectName: 'é¡¹ç›®è¯„å®¡',
          hourlyWage: 40,
          allowance: 15,
          deduction: 0,
          remarks: 'æŠ€æœ¯æ–¹æ¡ˆè®¨è®º',
          createdAt: new Date().toISOString()
        },
        {
          id: `test_${Date.now()}_4`,
          date: `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-18`,
          startTime: '09:00',
          endTime: '12:00',
          duration: 3,
          projectType: 'test',
          projectName: 'Bugä¿®å¤',
          hourlyWage: 45,
          allowance: 0,
          deduction: 5,
          remarks: 'ä¿®å¤æ—¥å†ç»„ä»¶é—®é¢˜',
          createdAt: new Date().toISOString()
        },
        {
          id: `test_${Date.now()}_5`,
          date: `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-19`,
          startTime: '09:00',
          endTime: '18:00',
          duration: 9,
          projectType: 'dev',
          projectName: 'ProfilePageå¼€å‘',
          hourlyWage: 50,
          allowance: 30,
          deduction: 0,
          remarks: 'å®Œæˆä¸ªäººä¸­å¿ƒé¡µé¢',
          createdAt: new Date().toISOString()
        },
        {
          id: `test_${Date.now()}_6`,
          date: `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`,
          startTime: '09:00',
          endTime: '13:00',
          duration: 4,
          projectType: 'doc',
          projectName: 'æŠ€æœ¯æ–‡æ¡£ç¼–å†™',
          hourlyWage: 35,
          allowance: 0,
          deduction: 0,
          remarks: 'ç¼–å†™APIæ–‡æ¡£',
          createdAt: new Date().toISOString()
        }
      ];

      for (const record of testRecords) {
        await storageUtils.saveWorkRecord(record);
      }

      hilog.info(DOMAIN, 'testTag', `Initialized ${testRecords.length} test records successfully`);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to initialize test data: %{public}s', JSON.stringify(err));
    }
  }
}