/*
 * MainPage - å¯çˆ±è®¡ç®—å™¨ä¸»é¡µé¢
 * Main Calculator Page
 */

import { ResultDisplay } from '../components/ResultDisplay';
import { CharacterDecor } from '../components/CharacterDecor';
import { CuteCalcKeyboard } from '../components/CuteCalcKeyboard';
import { SettingsSheet } from '../components/SettingsSheet';
import CalculateUtil from '../common/CalculateUtil';
import { CalcConstants, CharacterState } from '../common/Constant';
import { ThemeColors, DarkThemeColors } from '../common/ThemeConfig';
import { HapticUtils } from '../utils/HapticUtils';
import { SoundUtils } from '../utils/SoundUtils';
import { HistoryUtils } from '../utils/HistoryUtils';
import PreferencesUtils, { AllSettings } from '../utils/PreferencesUtils';
import { ThemeManager, ThemeConfig, ThemeType } from '../utils/ThemeManager';
import { common } from '@kit.AbilityKit';
import { window } from '@kit.ArkUI';
import { display } from '@kit.ArkUI';
import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';
import { Configuration, ConfigurationConstant } from '@kit.AbilityKit';

@Entry
@Component
struct MainPage {
  @State expressions: string[] = []; // è¡¨è¾¾å¼æ•°ç»„(åä¸ºæ ¼å¼)
  @State displayExpr: string = '0'; // æ˜¾ç¤ºçš„è¡¨è¾¾å¼
  @State result: string = '0'; // è®¡ç®—ç»“æœ
  @State characterState: CharacterState = CharacterState.NORMAL;
  @State vibrateEnabled: boolean = true; // æŒ¯åŠ¨å¼€å…³
  @State soundEnabled: boolean = true; // éŸ³æ•ˆå¼€å…³
  @State characterType: string = 'whitecat'; // è§’è‰²ç±»å‹ï¼ˆwhitecat/rabbitï¼‰
  @State buttonShape: string = 'rounded'; // æŒ‰é’®å½¢çŠ¶ï¼ˆcircle/roundedï¼‰
  @State keyboardTheme: string = 'default'; // é”®ç›˜ä¸»é¢˜ï¼ˆdefault/catpaw/star/heart/cloudï¼‰
  @State buttonBorder: string = 'flat'; // æŒ‰é”®è¾¹æ¡†ï¼ˆflat/3d/neon/pixelï¼‰
  @State buttonPressCounter: number = 0; // æŒ‰é”®è®¡æ•°å™¨ï¼Œç”¨äºè§¦å‘è§’è‰²åŠ¨ç”»
  // ä½¿ç”¨ @StorageLink åŒå‘ç»‘å®š AppStorage çš„æ·±æµ…è‰²æ¨¡å¼çŠ¶æ€
  @StorageLink('isDarkMode') @Watch('onDarkModeChange') isDarkMode: boolean = false;
  @State currentTheme: ThemeConfig = ThemeManager.getAllThemes()[0]; // å½“å‰ä¸»é¢˜é…ç½®
  // è®¾ç½®å¼¹çª—æ§åˆ¶å™¨
  settingsDialogController: CustomDialogController = new CustomDialogController({
    builder: SettingsSheet({
      vibrateEnabled: $vibrateEnabled,
      soundEnabled: $soundEnabled,
      characterType: $characterType,
      buttonShape: $buttonShape,
      keyboardTheme: $keyboardTheme,
      buttonBorder: $buttonBorder,
      currentTheme: this.currentTheme
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true,
    autoCancel: false, // ç¦ç”¨ç‚¹å‡»é®ç½©å…³é—­ï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸‹æ»‘æ‰‹åŠ¿
    maskColor: 'rgba(0, 0, 0, 0.5)'
    // ä¸ä½¿ç”¨openAnimation,ç”±SettingsSheetå†…éƒ¨çš„slideOffsetYæ§åˆ¶æ»‘å…¥æ•ˆæœ
  })
  // åä¸ºå¹¿å‘Šé…ç½®ï¼ˆç¬¦åˆå®˜æ–¹è§„èŒƒï¼‰
  @State adHeight: number = 0; // å¹¿å‘Šä½é«˜åº¦ (0=æ— å¹¿å‘Š, 73=å°æ¨ªå¹…57vp+è¾¹è·, 160=å¤§æ¨ªå¹…144vp+è¾¹è·)
  @State adLoaded: boolean = false; // å¹¿å‘ŠåŠ è½½çŠ¶æ€
  private adRefreshTimer: number = -1; // å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨
  // ç¨³å®šçš„ç‚¹å‡»å›è°ƒï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°å¯¼è‡´å­ç»„ä»¶é‡ç»˜
  private onBtnClick = (value: string): void => {
    this.handleButtonClick(value);
  }

  async aboutToAppear() {
    // åˆå§‹åŒ–Preferences
    const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
    await PreferencesUtils.init(context);
    this.vibrateEnabled = await PreferencesUtils.getVibrateEnabled();
    this.soundEnabled = await PreferencesUtils.getSoundEnabled();
    this.characterType = await PreferencesUtils.getCharacterType();
    // åŠ è½½æ–°é…ç½®
    this.buttonShape = await PreferencesUtils.getButtonShape();
    this.keyboardTheme = await PreferencesUtils.getKeyboardTheme();
    this.buttonBorder = await PreferencesUtils.getButtonBorder();

    // è·å–å½“å‰ä¸»é¢˜
    this.currentTheme = await ThemeManager.getCurrentTheme();

    // å…ˆæ£€æµ‹ç³»ç»Ÿæ·±è‰²æ¨¡å¼
    this.detectDarkMode();

    // åˆå§‹åŒ–éŸ³æ•ˆæ’­æ”¾å™¨
    await SoundUtils.init(context);

    // åˆå§‹åŒ–åä¸ºå¹¿å‘Š
    this.initHuaweiAd();
  }

  /**
   * æ£€æµ‹ç³»ç»Ÿæ·±è‰²æ¨¡å¼å¹¶åˆå§‹åŒ– AppStorage
   */
  private detectDarkMode(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      const colorMode = context.config.colorMode;
      const darkMode = colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;
      
      // åˆå§‹åŒ–æ—¶åŒæ­¥åˆ° AppStorageï¼ˆç¡®ä¿ä¸ EntryAbility ä¸€è‡´ï¼‰
      AppStorage.setOrCreate('isDarkMode', darkMode);

      // åŠ¨æ€æ›´æ–°çŠ¶æ€æ é¢œè‰²
      this.updateSystemBarColor();
    } catch (error) {
      AppStorage.setOrCreate('isDarkMode', false);
    }
  }

  /**
   * æ·±æµ…è‰²æ¨¡å¼å˜åŒ–æ—¶çš„å›è°ƒï¼ˆç”± @Watch è§¦å‘ï¼‰
   */
  onDarkModeChange(): void {
    // æ·±æµ…è‰²æ¨¡å¼å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€æ é¢œè‰²
    this.updateSystemBarColor();
  }

  /**
   * æ›´æ–°çŠ¶æ€æ é¢œè‰²ä»¥åŒ¹é…å½“å‰ä¸»é¢˜
   * æ ¹æ®ç³»ç»Ÿæ·±è‰²/æµ…è‰²æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
   */
  private updateSystemBarColor(): void {
    try {
      window.getLastWindow(this.getUIContext().getHostContext()).then((mainWindow: window.Window) => {
        // æ ¹æ®æ·±è‰²æ¨¡å¼é€‰æ‹©å¯¹åº”çš„é¢œè‰²
        const statusBarBg = this.isDarkMode ? '#2C2C2E' : '#FFD4A3';
        const statusBarContent = this.isDarkMode ? '#FFFFFF' : '#000000';
        
        const sysBarProps: window.SystemBarProperties = {
          statusBarColor: statusBarBg,
          navigationBarColor: statusBarBg,
          statusBarContentColor: statusBarContent,
          navigationBarContentColor: statusBarContent
        };
        mainWindow.setWindowSystemBarProperties(sysBarProps);
      });
    } catch (error) {
      // å¿½ç•¥é”™è¯¯
      console.error('Failed to update system bar color:', JSON.stringify(error));
    }
  }

  /**
   * åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºäº®è‰²
   * @param color é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
   * @returns æ˜¯å¦ä¸ºäº®è‰²
   */
  private isLightColor(color: string): boolean {
    // ç§»é™¤#å·
    color = color.replace('#', '');
    
    // å°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºRGB
    const r = parseInt(color.substring(0, 2), 16);
    const g = parseInt(color.substring(2, 4), 16);
    const b = parseInt(color.substring(4, 6), 16);
    
    // è®¡ç®—äº®åº¦ï¼ˆä½¿ç”¨ç›¸å¯¹äº®åº¦å…¬å¼ï¼‰
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    
    // äº®åº¦å¤§äº128è§†ä¸ºäº®è‰²
    return brightness > 128;
  }

  /**
   * è·å–å½“å‰ä¸»é¢˜èƒŒæ™¯è‰²
   * ä½¿ç”¨ç³»ç»Ÿèµ„æºå¼•ç”¨ï¼Œè‡ªåŠ¨é€‚é…äº®/æš—è‰²æ¨¡å¼
   */
  private getBackgroundColor(): ResourceColor {
    return $r('app.color.bg_main');
  }

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶å›è°ƒï¼ˆä»è®¾ç½®é¡µè¿”å›æ—¶ä¼šè§¦å‘ï¼‰
   * æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡è¯»å–å‡å°‘å¼‚æ­¥è°ƒç”¨æ¬¡æ•°
   */
  onPageShow() {
    // æ‰¹é‡è·å–æ‰€æœ‰é…ç½®ï¼ˆä¸€æ¬¡å¼‚æ­¥è°ƒç”¨ä»£æ›¿å¤šæ¬¡ï¼‰
    PreferencesUtils.getAllSettings().then((settings: AllSettings) => {
      // åªæ›´æ–°å˜åŒ–çš„çŠ¶æ€ï¼Œå‡å°‘é‡æ¸²æŸ“
      if (settings.characterType !== this.characterType) {
        this.characterType = settings.characterType;
      }
      if (settings.buttonShape !== this.buttonShape) {
        this.buttonShape = settings.buttonShape;
      }
      if (settings.keyboardTheme !== this.keyboardTheme) {
        this.keyboardTheme = settings.keyboardTheme;
      }
      if (settings.buttonBorder !== this.buttonBorder) {
        this.buttonBorder = settings.buttonBorder;
      }
    });
    
    // éé˜»å¡åŠ è½½ä¸»é¢˜ï¼Œä¼ é€’æ·±è‰²æ¨¡å¼çŠ¶æ€
    ThemeManager.getCurrentTheme(this.isDarkMode).then((newTheme: ThemeConfig) => {
      if (newTheme.type !== this.currentTheme.type || newTheme.bgMain !== this.currentTheme.bgMain) {
        this.currentTheme = newTheme;
        // ä¸»é¢˜å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€æ é¢œè‰²
        this.updateSystemBarColor();
      }
    });
    
    // é‡æ–°æ£€æµ‹æ·±è‰²æ¨¡å¼ï¼ˆç”¨æˆ·å¯èƒ½åœ¨åå°åˆ‡æ¢äº†ç³»ç»Ÿä¸»é¢˜ï¼‰
    this.detectDarkMode();
  }

  aboutToDisappear() {
    // æ¸…ç†å¹¿å‘Šåˆ·æ–°å®šæ—¶å™¨
    if (this.adRefreshTimer !== -1) {
      clearInterval(this.adRefreshTimer);
      this.adRefreshTimer = -1;
    }
  }

  /**
   * åˆå§‹åŒ–åä¸ºå¹¿å‘Š
   * TODO: éœ€åœ¨ oh-package.json5 ä¸­æ·»åŠ  "@kit.AdsKit": "^1.0.0"
   * TODO: éœ€åœ¨ module.json5 ä¸­æ·»åŠ  OAID æƒé™
   */
  private initHuaweiAd() {
    // TODO: æ¥å…¥åä¸ºå¹¿å‘ŠSDK
    // å‚è€ƒä»£ç :
    // import { advertising } from '@kit.AdsKit';
    // import { deviceAttributes } from '@kit.DeviceAttributesKit';
    //
    // try {
    //   // 1. è·å–è®¾å¤‡OAIDï¼ˆæå‡å¹¿å‘Šå¡«å……ç‡ï¼‰
    //   const oaid = await deviceAttributes.getOAID();
    //
    //   // 2. é…ç½®å¹¿å‘Šå‚æ•°ï¼ˆå¿…é¡»ç¬¦åˆåä¸ºè§„èŒƒï¼‰
    //   const adParams = {
    //     adType: 8,                    // æ¨ªå¹…å¹¿å‘Šç±»å‹
    //     adId: 'testw6vs28auh3',       // æµ‹è¯•IDï¼ˆä¸Šçº¿å‰æ›¿æ¢æ­£å¼IDï¼‰
    //     adHeight: 144,                // 57 æˆ– 144 (vp)
    //     oaid: oaid,                   // è®¾å¤‡OAID
    //     refreshTime: 60000            // åˆ·æ–°é—´éš” 30000~120000ms
    //   };
    //
    //   // 3. åŠ è½½å¹¿å‘Š
    //   advertising.showBannerAd(adParams, (error, data) => {
    //     if (!error) {
    //       this.adLoaded = true;
    //       // æ ¹æ®å®é™…å¹¿å‘Šé«˜åº¦è®¾ç½®å®¹å™¨é«˜åº¦
    //       // å°æ¨ªå¹…: 57vp + 16vpè¾¹è· = 73vp
    //       // å¤§æ¨ªå¹…: 144vp + 16vpè¾¹è· = 160vp
    //       this.adHeight = adParams.adHeight === 57 ? 73 : 160;
    //     }
    //   });
    // } catch (error) {
    //   console.error('åä¸ºå¹¿å‘Šåˆå§‹åŒ–å¤±è´¥:', error);
    // }

    // ä¸´æ—¶æµ‹è¯•: æ¨¡æ‹Ÿå¹¿å‘ŠåŠ è½½ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
    setTimeout(() => {
      this.adLoaded = true;
      this.adHeight = 73; // ä½¿ç”¨å°æ¨ªå¹…å°ºå¯¸ (57vp + 16vpè¾¹è·)
    }, 1000);
  }

  build() {
    Scroll() {
      Column() {
        // å›¾ç‰‡é¢„åŠ è½½å®¹å™¨ï¼ˆä¸å¯è§ï¼Œç”¨äºæå‰åŠ è½½æ‰€æœ‰è§’è‰²å›¾ç‰‡åˆ°ç¼“å­˜ï¼‰
        Stack() {
          // ç™½çŒ«è§’è‰²å›¾ç‰‡é¢„åŠ è½½
          Image($r('app.media.whitecat_body'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image($r('app.media.whitecat_lefthand'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image($r('app.media.whitecat_righthand'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)

          // å…”å­è§’è‰²å›¾ç‰‡é¢„åŠ è½½
          Image($r('app.media.rabbit_body'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image($r('app.media.rabbit_lefthand'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
          Image($r('app.media.rabbit_righthand'))
            .width(1)
            .height(1)
            .visibility(Visibility.None)
        }
        .width(0)
        .height(0)

        // çŠ¶æ€æ å®‰å…¨åŒºåŸŸå ä½
        Blank()
          .height(48) // çŠ¶æ€æ é«˜åº¦çº¦48vp

        // ç¬¬1æ’: å¡é€šäº’åŠ¨ - ä¼˜åŒ–é«˜åº¦ï¼Œé€‚é…å°çª—æ¨¡å¼
        Row() {
          // å¡é€šè§’è‰² (å·¦ä¾§)
          CharacterDecor({
            buttonPressCounter: $buttonPressCounter,
            characterType: $characterType
          })
            .layoutWeight(1)
            .height(this.isSmallWindow() ? 120 : 160) // å°çª—æ¨¡å¼ä¸‹å‡å°é«˜åº¦

          // å†å²è®°å½•æŒ‰é’®
          Button() {
            Text('å†å²')
              .fontSize(16)
              .fontColor('#FFFFFF')
          }
          .width(64)
          .height(40)
          .backgroundColor('#FF8C42')
          .borderRadius(20)
          .margin({ left: 8 })
          .onClick(() => {
            this.navigateToHistory();
          })

          // è®¾ç½®æŒ‰é’®
          Button() {
            Text('è®¾ç½®')
              .fontSize(16)
              .fontColor('#FFFFFF')
          }
          .width(64)
          .height(40)
          .backgroundColor('#FF8C42')
          .borderRadius(20)
          .margin({ left: 8 })
          .onClick(() => {
            this.navigateToSettings();
          })
        }
        .width('100%')
        .height(this.isSmallWindow() ? 140 : 180) // å°çª—æ¨¡å¼ä¸‹å‡å°é«˜åº¦
        .padding({
          left: 16,
          right: 16,
          top: 8,
          bottom: 8
        })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // ç¬¬2æ’: ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        ResultDisplay({
          expression: this.displayExpr,
          result: this.result
        })

        // ç¬¬3æ’: å¯çˆ±é”®ç›˜ - ä¼˜åŒ–é«˜åº¦ï¼Œé€‚é…å°çª—æ¨¡å¼
        CuteCalcKeyboard({
          onButtonClick: this.onBtnClick,
          buttonShape: this.buttonShape,
          keyboardTheme: this.keyboardTheme,
          buttonBorder: this.buttonBorder
        })
        // å°çª—æ¨¡å¼ä¸‹ä½¿ç”¨å›ºå®šé«˜åº¦ï¼Œé¿å…è¿‡é«˜
          .height(this.isSmallWindow() ? 300 : undefined)
          .layoutWeight(this.isSmallWindow() ? 0 : 1) // å°çª—æ¨¡å¼ä¸‹ç¦ç”¨è‡ªåŠ¨å¡«å……

        // å°çª—æ¨¡å¼ä¸‹éšè—å¹¿å‘Šç›¸å…³å†…å®¹ï¼ŒèŠ‚çœç©ºé—´
        if (!this.isSmallWindow()) {
          // ä¸å¹¿å‘Šä½ä¿æŒå›ºå®š20vpé—´éš”
          Blank()
            .height(20)

          // åº•éƒ¨å¹¿å‘Šä½ï¼ˆå›ºå®šé«˜åº¦ï¼Œç¬¦åˆåä¸ºè§„èŒƒï¼‰
          this.buildAdContainer()
        }
      }
      .width('100%')
      .backgroundColor(this.getBackgroundColor())
    }
    .width('100%')
    .height('100%')
    .height('100%') // ç¡®ä¿ä¸è¶…å‡ºçˆ¶å®¹å™¨é«˜åº¦ï¼Œä½¿ç”¨heightæ›¿ä»£maxHeight
    .scrollable(ScrollDirection.Vertical) // æ˜ç¡®å¯ç”¨å‚ç›´æ»šåŠ¨
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring) // è¾¹ç•Œå›å¼¹æ•ˆæœ
    .friction(0.9) // å¢åŠ æ‘©æ“¦åŠ›ï¼Œä½¿å›å¼¹æ›´æ˜æ˜¾
    .align(Alignment.TopStart)
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºå°çª—æ¨¡å¼
   */
  private isSmallWindow(): boolean {
    // è·å–å½“å‰çª—å£å®½åº¦ï¼Œå°äº400vpè§†ä¸ºå°çª—æ¨¡å¼
    try {
      const defaultDisplay: display.Display = display.getDefaultDisplaySync();
      const winWidth: number = defaultDisplay.width;
      return winWidth < 400;
    } catch (error) {
      // å¼‚å¸¸æƒ…å†µä¸‹é»˜è®¤è¿”å›false
      return false;
    }
  }

  /**
   * æ„å»ºåä¸ºå¹¿å‘Šå®¹å™¨
   * ç¬¦åˆå®˜æ–¹è§„èŒƒ: ä»…æ”¯æŒ 360vpÃ—57vp æˆ– 360vpÃ—144vp
   * å›ºå®šé«˜åº¦: 57vp (å°æ¨ªå¹…) æˆ– 144vp (å¤§æ¨ªå¹…) + 20vpåº•éƒ¨å®‰å…¨åŒº
   */
  @Builder
  buildAdContainer() {
    Column() {
      if (this.adLoaded && this.adHeight > 0) {
        // åä¸ºæ¨ªå¹…å¹¿å‘Šå®¹å™¨ï¼ˆå›ºå®šé«˜åº¦ï¼‰
        Column() {
          // TODO: æ›¿æ¢ä¸ºå®é™…çš„åä¸ºå¹¿å‘Šç»„ä»¶
          // ç¤ºä¾‹: HuaweiBannerAd({ adId: 'testw6vs28auh3', height: 57 })

          // ä¸´æ—¶å ä½ï¼ˆå¼€å‘é˜¶æ®µï¼‰
          Column() {
            Text('ğŸ¯ åä¸ºæ¨ªå¹…å¹¿å‘Šä½')
              .fontSize(14)
              .fontColor(Color.Transparent)
              .fontWeight(FontWeight.Medium)
            Text(this.adHeight === 73 ? '360vp Ã— 57vp' : '360vp Ã— 144vp')
              .fontSize(12)
              .fontColor(Color.Transparent)
              .margin({ top: 4 })
            Text('adId: testw6vs28auh3')
              .fontSize(10)
              .fontColor(Color.Transparent)
              .margin({ top: 2 })
          }
          .width('100%')
          .height(this.adHeight === 73 ? 57 : 144) // ä½¿ç”¨å›ºå®šé«˜åº¦ï¼ˆåä¸ºè§„èŒƒï¼‰
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255, 245, 230, 0.8)') // å¥¶æ²¹è‰²åŠé€æ˜
          .borderRadius({ topLeft: 16, topRight: 16 })
          .border({
            width: { top: 1 },
            color: 'rgba(255, 140, 66, 0.2)'
          })
          .shadow({
            radius: 8,
            color: 'rgba(255, 140, 66, 0.08)',
            offsetX: 0,
            offsetY: -2
          })
        }
        .width('100%')
      } else {
        // æ— å¹¿å‘Šæ—¶æ˜¾ç¤º20vpçš„åº•éƒ¨å®‰å…¨åŒº
        Blank()
          .height(0)
      }
    }
    .width('100%')
    .height(this.adLoaded ? (this.adHeight === 73 ? 77 : 164) : 20) // å¹¿å‘Šé«˜åº¦ + 20vpåº•éƒ¨å®‰å…¨åŒº
    .animation({
      duration: 200,
      curve: Curve.Sharp
    })
  }

  /**
   * å¤„ç†æŒ‰é’®ç‚¹å‡»
   */
  private handleButtonClick(value: string): void {
    // è§¦å‘è§’è‰²æ‰‹è‡‚åŠ¨ç”»ï¼ˆé€šè¿‡å¢åŠ è®¡æ•°å™¨ï¼‰
    this.buttonPressCounter++;

    // æŒ¯åŠ¨åé¦ˆ
    if (this.vibrateEnabled) {
      if (value === CalcConstants.EQUAL) {
        HapticUtils.equalVibrate();
      } else {
        HapticUtils.buttonVibrate();
      }
    }

    // éŸ³æ•ˆåé¦ˆ
    if (this.soundEnabled) {
      if (value === CalcConstants.EQUAL) {
        SoundUtils.playEqualSound();
      } else if (value === CalcConstants.CLEAR) {
        SoundUtils.playClearSound();
      } else {
        SoundUtils.playKeySound();
      }
    }

    // æ ¹æ®æŒ‰é’®ç±»å‹å¤„ç†
    if (value === CalcConstants.CLEAR) {
      this.handleClear();
    } else if (value === CalcConstants.DELETE || value === CalcConstants.DEL || value === 'del') {
      this.handleDelete();
    } else if (value === CalcConstants.EQUAL) {
      this.handleEqual();
    } else {
      this.handleInput(value);
    }
  }

  /**
   * å¤„ç†æ¸…ç©º
   */
  private handleClear(): void {
    this.expressions = [];
    this.displayExpr = ''; // ä¸Šæ–¹è¡¨è¾¾å¼æ¡†æ¸…ç©º
    this.result = '0'; // ä¸‹æ–¹ç»“æœæ¡†æ˜¾ç¤º0
    this.characterState = CharacterState.NORMAL;
  }

  /**
   * å¤„ç†åˆ é™¤(åä¸ºå®˜æ–¹æ–¹å¼)
   */
  private handleDelete(): void {
    const len = this.expressions.length;
    if (len === 0) {
      return;
    }

    const lastValue = this.expressions[len - 1];

    // å¦‚æœæœ€åä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œç›´æ¥åˆ é™¤æ•´ä¸ªå…ƒç´ 
    if (this.isOperator(lastValue)) {
      this.expressions.pop();
    } else {
      // å¦‚æœæœ€åä¸€ä¸ªæ˜¯æ•°å­—
      if (lastValue.length === 1) {
        // åªæœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ é™¤æ•´ä¸ªå…ƒç´ 
        this.expressions.pop();
      } else {
        // å¤šä¸ªå­—ç¬¦ï¼Œåˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
        this.expressions[len - 1] = lastValue.slice(0, -1);
      }
    }

    this.updateDisplay();

    if (this.expressions.length === 0) {
      this.displayExpr = ''; // ä¸Šæ–¹è¡¨è¾¾å¼æ¡†æ¸…ç©º
      this.result = '0'; // ä¸‹æ–¹ç»“æœæ¡†æ˜¾ç¤º0
      this.characterState = CharacterState.NORMAL;
    }
  }

  /**
   * å¤„ç†è¾“å…¥(åä¸ºå®˜æ–¹æ–¹å¼: è¡¨è¾¾å¼æ•°ç»„ç›´æ¥å­˜å‚¨)
   */
  private handleInput(value: string): void {
    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è®¡ç®—ç»“æœï¼ˆexpressionsä¸ºç©ºä½†displayExprä¸ä¸ºç©ºï¼‰ï¼Œæ¸…ç©ºé‡æ–°å¼€å§‹
    if (this.expressions.length === 0 && this.displayExpr !== '' && !this.isOperator(value)) {
      this.displayExpr = ''; // æ¸…ç©ºä¸Šæ–¹è¡¨è¾¾å¼æ¡†
      this.result = '0'; // é‡ç½®ä¸‹æ–¹ç»“æœæ¡†
      this.characterState = CharacterState.NORMAL;
    }

    const len = this.expressions.length;

    // åˆ¤æ–­æ˜¯æ•°å­—/å°æ•°ç‚¹ è¿˜æ˜¯ è¿ç®—ç¬¦
    if (this.isOperator(value)) {
      // è¿ç®—ç¬¦: å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯è¿ç®—ç¬¦ï¼Œæ›¿æ¢ï¼›å¦åˆ™æ·»åŠ 
      if (len > 0) {
        const lastValue = this.expressions[len - 1];
        if (this.isOperator(lastValue)) {
          // æ›¿æ¢è¿ç®—ç¬¦
          this.expressions[len - 1] = value;
        } else {
          // æ·»åŠ è¿ç®—ç¬¦
          this.expressions.push(value);
        }
      }
    } else {
      // æ•°å­—æˆ–å°æ•°ç‚¹: å¦‚æœæœ€åä¸€ä¸ªå…ƒç´ æ˜¯æ•°å­—ï¼Œè¿½åŠ ï¼›å¦åˆ™æ·»åŠ æ–°å…ƒç´ 
      if (len === 0) {
        // é¦–æ¬¡è¾“å…¥
        this.expressions.push(value);
      } else {
        const lastValue = this.expressions[len - 1];
        if (this.isOperator(lastValue)) {
          // ä¸Šä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œæ·»åŠ æ–°æ•°å­—
          this.expressions.push(value);
        } else {
          // ä¸Šä¸€ä¸ªæ˜¯æ•°å­—ï¼Œè¿½åŠ 
          if (value === '.' && lastValue.indexOf('.') !== -1) {
            // å·²æœ‰å°æ•°ç‚¹ï¼Œä¸å†æ·»åŠ 
            return;
          }
          // ç‰¹æ®Šå¤„ç†: å¦‚æœå½“å‰æ•°å­—æ˜¯"0"ï¼Œä¸”è¾“å…¥éå°æ•°ç‚¹çš„æ•°å­—ï¼Œæ›¿æ¢"0"
          if (lastValue === '0' && value !== '.') {
            this.expressions[len - 1] = value;
          } else {
            this.expressions[len - 1] = lastValue + value;
          }
        }
      }
    }

    // åªåœ¨é¦–æ¬¡è¾“å…¥æ•°å­—æ—¶æ›´æ–°çŠ¶æ€
    if (!this.isOperator(value) && this.characterState !== CharacterState.CALCULATING) {
      this.characterState = CharacterState.CALCULATING;
    }
    this.updateDisplay();
  }

  /**
   * æ›´æ–°æ˜¾ç¤º(ä¿®æ”¹é€»è¾‘: è¾“å…¥æ—¶åœ¨resultæ¡†æ˜¾ç¤º)
   */
  private updateDisplay(): void {
    const currentExpr = this.expressions.join('');
    // è¾“å…¥é˜¶æ®µï¼šexpressionä¿æŒç©ºç™½ï¼Œresultæ˜¾ç¤ºå½“å‰è¾“å…¥
    this.displayExpr = '';
    this.result = currentExpr.length === 0 ? '0' : currentExpr;
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºè¿ç®—ç¬¦
   */
  private isOperator(value: string): boolean {
    return CalcConstants.OPERATORS.indexOf(value) !== -1;
  }

  /**
   * å¯¼èˆªåˆ°å†å²è®°å½•é¡µé¢
   */
  private navigateToHistory(): void {
    router.pushUrl({ url: 'pages/HistoryPage' }, router.RouterMode.Single).catch((err: Error) => {
      promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥', duration: 2000 });
    });
  }

  /**
   * å¯¼èˆªåˆ°è®¾ç½®é¡µé¢ï¼ˆæ”¹ä¸ºæ‰“å¼€åº•éƒ¨å¼¹çª—ï¼‰
   */
  private navigateToSettings(): void {
    this.settingsDialogController.open();
  }

  /**
   * å¤„ç†ç­‰å·(ä½¿ç”¨åä¸ºCalculateUtil)
   */
  private handleEqual(): void {
    if (this.expressions.length === 0) {
      return;
    }

    // å…ˆä¿å­˜åŸå§‹è¡¨è¾¾å¼ç”¨äºæ˜¾ç¤º
    const originalExpr = this.expressions.join('');

    // å¦‚æœæœ€åä¸€ä¸ªæ˜¯è¿ç®—ç¬¦ï¼Œç§»é™¤å®ƒ
    const len = this.expressions.length;
    const lastValue = this.expressions[len - 1];
    if (this.isOperator(lastValue)) {
      this.expressions.pop();
    }

    if (this.expressions.length === 0) {
      return;
    }

    try {
      // ä½¿ç”¨åä¸ºçš„ CalculateUtil.parseExpression è®¡ç®—
      const calcResult = CalculateUtil.parseExpression(this.expressions);

      this.result = calcResult;

      if (this.result === 'Error' || this.result === 'NaN' || !this.result) {
        this.characterState = CharacterState.ERROR;
        this.result = 'Error';
        if (this.vibrateEnabled) {
          HapticUtils.errorVibrate();
        }
      } else {
        this.characterState = CharacterState.RESULT;

        // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆä½¿ç”¨ä¹‹å‰ä¿å­˜çš„åŸå§‹è¡¨è¾¾å¼ï¼‰
        const fullExpression = originalExpr + ' = ' + this.result;
        HistoryUtils.updateHistoryResult(fullExpression);

        // ä¿®æ”¹æ˜¾ç¤ºé€»è¾‘ï¼šè¡¨è¾¾å¼ç§»åˆ°ä¸Šæ–¹expressionæ¡†ï¼Œç»“æœæ˜¾ç¤ºåœ¨resultæ¡†
        this.displayExpr = originalExpr; // è¡¨è¾¾å¼æ˜¾ç¤ºåœ¨ä¸Šæ–¹
        // this.result å·²ç»æ˜¯è®¡ç®—ç»“æœï¼Œä¿æŒä¸å˜
        this.expressions = []; // æ¸…ç©ºå†…éƒ¨æ•°ç»„
      }
    } catch (error) {
      this.result = 'Error';
      this.characterState = CharacterState.ERROR;
      if (this.vibrateEnabled) {
        HapticUtils.errorVibrate();
      }
    }
  }
}
