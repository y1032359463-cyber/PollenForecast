/*
 * CharacterSelectPage - è§’è‰²é€‰æ‹©é¡µé¢
 * Character Selection Page
 * æ”¯æŒæ·±è‰²æ¨¡å¼
 */

import { ThemeColors } from '../common/ThemeConfig';
import PreferencesUtils from '../utils/PreferencesUtils';
import { promptAction, router } from '@kit.ArkUI';

interface CharacterInfo {
  id: string;
  name: string;
  normalImage: string;
  description: string;
}

@Entry
@Component
struct CharacterSelectPage {
  @State characterType: string = 'whitecat'; // é»˜è®¤ç™½çŒ«
  @State availableCharacters: CharacterInfo[] = [
    {
      id: 'whitecat',
      name: 'ç™½è‰²çŒ«å’ª',
      normalImage: 'whitecat_body',
      description: 'ç»å…¸æ¬¾ï¼ŒèŒèŒå“’'
    },
    {
      id: 'rabbit',
      name: 'çšæ´ç™½å…”',
      normalImage: 'rabbit_body',
      description: 'çº¯æ´ä¼˜é›…,æ¸©æŸ”å¯çˆ±'
    }
  ];

  async aboutToAppear() {
    this.characterType = await PreferencesUtils.getCharacterType();
  }

  build() {
    Column({ space: 0 }) {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.ic_back'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })

        Text('é€‰æ‹©è§’è‰²')
          .fontSize(18)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row()
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(92)
      .padding({ left: 16, right: 16, top: 36 }) // top: çŠ¶æ€æ é«˜åº¦ï¼Œæ€»é«˜åº¦92=56+36
      .backgroundColor($r('app.color.bg_main'))

      // è§’è‰²åˆ—è¡¨
      Scroll() {
        Column({ space: 20 }) {
          ForEach(this.availableCharacters, (character: CharacterInfo) => {
            this.buildCharacterCard(character);
          })

          this.buildComingSoonCard();
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .width('100%')
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .friction(0.9)
      .backgroundColor($r('app.color.bg_main'))
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.bg_main'))
  }

  @Builder
  buildCharacterCard(character: CharacterInfo) {
    Column({ space: 16 }) {
      Image($r(`app.media.${character.normalImage}`))
        .width(200)
        .height(200)
        .objectFit(ImageFit.Contain)
        .borderRadius(16)
        .backgroundColor('#FFF5E6')

      Column({ space: 8 }) {
        Text(character.name)
          .fontSize(18)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)

        Text(character.description)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }

      Button(this.characterType === character.id ? 'âœ“ å·²é€‰æ‹©' : 'é€‰æ‹©æ­¤è§’è‰²')
        .width(160)
        .height(44)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(this.characterType === character.id ? ThemeColors.PRIMARY_ORANGE : '#F5F5F5')
        .fontColor(this.characterType === character.id ? '#FFFFFF' : ThemeColors.TEXT_PRIMARY)
        .borderRadius(22)
        .enabled(this.characterType !== character.id)
        .onClick(() => {
          this.selectCharacter(character.id, character.name);
        })
    }
    .width('100%')
    .padding(24)
    .backgroundColor($r('app.color.bg_card'))
    .borderRadius(20)
    .border({
      width: this.characterType === character.id ? 3 : 0,
      color: ThemeColors.PRIMARY_ORANGE
    })
    .shadow({
      radius: 12,
      color: 'rgba(255, 140, 66, 0.15)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildComingSoonCard() {
    Column({ space: 16 }) {
      Text('ğŸ”’')
        .fontSize(80)
        .opacity(0.3)

      Column({ space: 8 }) {
        Text('æ›´å¤šè§’è‰²')
          .fontSize(18)
          .fontColor($r('app.color.text_secondary'))
          .fontWeight(FontWeight.Bold)

        Text('æ•¬è¯·æœŸå¾…...')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
    }
    .width('100%')
    .padding(48)
    .backgroundColor($r('app.color.bg_card'))
    .borderRadius(20)
    .opacity(0.6)
  }

  private selectCharacter(characterId: string, characterName: string): void {
    this.characterType = characterId;
    PreferencesUtils.setCharacterType(characterId);
    promptAction.showToast({
      message: `å·²é€‰æ‹© ${characterName}`,
      duration: 2000
    });

    setTimeout(() => {
      router.back();
    }, 500);
  }
}
