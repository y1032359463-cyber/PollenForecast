/*
 * èŠ±ç²‰æµ“åº¦é¢„æŠ¥ï¼ˆé¸¿è’™ç‰ˆï¼‰V1.0.2 æºä»£ç 
 * å‰30é¡µ
 * 
 * æ ¼å¼è¦æ±‚ï¼š
 * 1. é¡µçœ‰ï¼šèŠ±ç²‰æµ“åº¦é¢„æŠ¥ï¼ˆé¸¿è’™ç‰ˆï¼‰V1.0.2 æºä»£ç 
 * 2. æ¯é¡µâ‰¥50è¡Œ
 * 3. å­—ä½“ï¼šç­‰å®½å­—ä½“ï¼ˆå¦‚ Consolasã€Source Code Proï¼‰ï¼Œ10-11pt
 * 4. è¡Œè·ï¼šå•å€è¡Œè·
 * 
 * å¯¼å‡ºPDFæ­¥éª¤ï¼š
 * 1. å°†æœ¬æ–‡æ¡£å†…å®¹ç²˜è´´åˆ° Microsoft Word
 * 2. è®¾ç½®é¡µçœ‰ï¼šæ’å…¥ -> é¡µçœ‰ -> è¾“å…¥"èŠ±ç²‰æµ“åº¦é¢„æŠ¥ï¼ˆé¸¿è’™ç‰ˆï¼‰V1.0.2 æºä»£ç "
 * 3. è®¾ç½®å­—ä½“ï¼šå…¨é€‰ -> Consolas 10ptï¼Œå•å€è¡Œè·
 * 4. è°ƒæ•´é¡µè¾¹è·å’Œè¡Œè·ï¼Œç¡®ä¿æ¯é¡µâ‰¥50è¡Œ
 * 5. æ·»åŠ é¡µç ï¼ˆç¬¬1é¡µå¼€å§‹ï¼‰
 * 6. å¯¼å‡ºPDFï¼šæ–‡ä»¶ -> å¦å­˜ä¸º -> PDFæ ¼å¼
 */
// æ–‡ä»¶: entry/src/main/ets/entryability/EntryAbility.ets
import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window, display } from '@kit.ArkUI';
import { LocationService } from '../service/LocationService';
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit';
import { NotificationService } from '../utils/NotificationService';
const DOMAIN = 0x0000;
export default class EntryAbility extends UIAbility {
  private mainWindowInstance?: window.Window;
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    console.info('ğŸŸ¡ [EntryAbility] onCreate è°ƒç”¨');
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    AppStorage.setOrCreate('currentCity', 'å®šä½ä¸­...');
    AppStorage.setOrCreate('pollenValue', 0);
    AppStorage.setOrCreate('pollenLevel', 'åŠ è½½ä¸­...');
    AppStorage.setOrCreate('updateTime', 'è·å–ä¸­...');
    AppStorage.setOrCreate('latitude', 23.1291);
    AppStorage.setOrCreate('longitude', 113.2644);
    AppStorage.setOrCreate('pollenThemeColor', '#4CAF50');
    AppStorage.setOrCreate('currentColorMode', this.context.config.colorMode);
    AppStorage.setOrCreate('isAppInBackground', false);
    AppStorage.setOrCreate('notificationEnabled', false);
    AppStorage.setOrCreate('pollenAlertEnabled', true);
    AppStorage.setOrCreate('dailyReportEnabled', true);
    AppStorage.setOrCreate('dailyReportTime', '08:00');
    AppStorage.setOrCreate('pollenDataSource', 'AUTO');
    LocationService.getInstance().setContext(this.context);
    NotificationService.getInstance().setContext(this.context);
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');
  }
  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }
  onWindowStageCreate(windowStage: window.WindowStage): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');
    console.info('ğŸ”µ [EntryAbility] onWindowStageCreate è°ƒç”¨');
    console.info('ğŸ”µ [EntryAbility] å‡†å¤‡è¯·æ±‚å®šä½æƒé™');
    this.requestLocationPermissions();
    console.info('ğŸ”µ [EntryAbility] å‡†å¤‡è¯·æ±‚ä»£ç†æé†’æƒé™');
    this.requestReminderPermission();
    const mainWindow = windowStage.getMainWindowSync();
    this.mainWindowInstance = mainWindow;
    try {
      mainWindow.setWindowLayoutFullScreen(true);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'è®¾ç½®å…¨å±å¤±è´¥: %{public}s', JSON.stringify(err));
    }
    try {
      this.updateStatusBarForTheme(mainWindow);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'æ›´æ–°çŠ¶æ€æ å¤±è´¥: %{public}s', JSON.stringify(err));
    }
    try {
      const topArea = mainWindow.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
      const statusBarHeight = topArea.topRect.height;
      const bottomArea = mainWindow.getWindowAvoidArea(window.AvoidAreaType.TYPE_NAVIGATION_INDICATOR);
      const navBarHeight = bottomArea.bottomRect.height;
      let density = 3;
      try {
        density = display.getDefaultDisplaySync().densityPixels;
      } catch (displayErr) {
        hilog.error(DOMAIN, 'testTag', 'è·å–å±å¹•å¯†åº¦å¤±è´¥: %{public}s', JSON.stringify(displayErr));
      }
      const safeTop = statusBarHeight / density;
      const safeBottom = navBarHeight / density;
      AppStorage.setOrCreate('safeTop', safeTop);
      AppStorage.setOrCreate('safeBottom', safeBottom);
      hilog.info(DOMAIN, 'testTag', `SafeArea - top: ${safeTop}vp, bottom: ${safeBottom}vp`);
    } catch (err) {
      AppStorage.setOrCreate('safeTop', 44);
      AppStorage.setOrCreate('safeBottom', 28);
      hilog.error(DOMAIN, 'testTag', 'Failed to get avoidArea: %{public}s', JSON.stringify(err));
    }
    windowStage.loadContent('pages/Index', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the content.');
    });
  }
  private updateStatusBarForTheme(mainWindow: window.Window, colorMode?: number): void {
    try {
      const currentColorMode = colorMode ?? this.context.config.colorMode;
      let systemBarProperties: window.SystemBarProperties;
      if (currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK) {
        systemBarProperties = {
          statusBarColor: '#00000000',
          statusBarContentColor: '#FFFFFF',
          isStatusBarLightIcon: true
        };
        hilog.info(DOMAIN, 'testTag', 'çŠ¶æ€æ è®¾ç½®ï¼šæ·±è‰²æ¨¡å¼ï¼ˆé€æ˜èƒŒæ™¯+ç™½è‰²å›¾æ ‡ï¼‰');
      } else {
        systemBarProperties = {
          statusBarColor: '#00000000',
          statusBarContentColor: '#000000',
          isStatusBarLightIcon: false
        };
        hilog.info(DOMAIN, 'testTag', 'çŠ¶æ€æ è®¾ç½®ï¼šæµ…è‰²æ¨¡å¼ï¼ˆé€æ˜èƒŒæ™¯+æ·±è‰²å›¾æ ‡ï¼‰');
      }
      mainWindow.setWindowSystemBarProperties(systemBarProperties);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'è®¾ç½®çŠ¶æ€æ å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }
  onWindowStageDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }
  onForeground(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
    AppStorage.setOrCreate('isAppInBackground', false);
    console.info('ğŸŸ¢ [EntryAbility] åº”ç”¨å›åˆ°å‰å°ï¼Œå…è®¸ä¼ æ„Ÿå™¨æ¢å¤');
    this.checkAndSendDailyReport();
  }
  private async checkAndSendDailyReport(): Promise<void> {
    try {
      const notificationService = NotificationService.getInstance();
      await notificationService.checkAndSendDailyReport();
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', `æ£€æŸ¥æ¯æ—¥æ’­æŠ¥å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }
  onConfigurationUpdate(newConfig: import('@kit.AbilityKit').Configuration): void {
    hilog.info(DOMAIN, 'testTag', 'é…ç½®æ›´æ–° - ColorMode: %{public}d', newConfig.colorMode ?? 0);
    const newColorMode = newConfig.colorMode ?? ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET;
    AppStorage.setOrCreate('currentColorMode', newColorMode);
    if (this.mainWindowInstance) {
      this.updateStatusBarForTheme(this.mainWindowInstance, newColorMode);
    }
  }
  private async requestLocationPermissions(): Promise<void> {
    console.info('ğŸŸ¢ [EntryAbility] requestLocationPermissions å¼€å§‹æ‰§è¡Œ');
    const permissions: Array<Permissions> = [
      'ohos.permission.LOCATION',
      'ohos.permission.APPROXIMATELY_LOCATION'
    ];
    try {
      console.info('ğŸŸ¢ [EntryAbility] åˆ›å»ºæƒé™ç®¡ç†å™¨');
      const atManager = abilityAccessCtrl.createAtManager();
      console.info('ğŸŸ¢ [EntryAbility] è¯·æ±‚æƒé™: ' + JSON.stringify(permissions));
      const grantStatus = await atManager.requestPermissionsFromUser(this.context, permissions);
      console.info('ğŸŸ¢ [EntryAbility] æƒé™è¯·æ±‚ç»“æœ: ' + JSON.stringify(grantStatus));
      console.info('ğŸŸ¢ [EntryAbility] æƒé™ç»“æœæ•°ç»„: ' + JSON.stringify(grantStatus.authResults));
      if (grantStatus.authResults.every(result => result === 0)) {
        console.info('âœ… [EntryAbility] å®šä½æƒé™å·²æˆäºˆ');
        hilog.info(DOMAIN, 'testTag', 'âœ… å®šä½æƒé™å·²æˆäºˆ');
      } else {
        console.warn('âš ï¸ [EntryAbility] å®šä½æƒé™è¢«æ‹’ç»');
        hilog.warn(DOMAIN, 'testTag', 'âš ï¸ å®šä½æƒé™è¢«æ‹’ç»');
      }
    } catch (err) {
      console.error('âŒ [EntryAbility] è¯·æ±‚å®šä½æƒé™å¤±è´¥: ' + JSON.stringify(err));
      hilog.error(DOMAIN, 'testTag', 'âŒ è¯·æ±‚å®šä½æƒé™å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }
  private async requestReminderPermission(): Promise<void> {
    console.info('ğŸŸ¢ [EntryAbility] requestReminderPermission å¼€å§‹æ‰§è¡Œ');
    const permissions: Array<Permissions> = [
      'ohos.permission.PUBLISH_AGENT_REMINDER'
    ];
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      console.info('ğŸ”” [EntryAbility] è¯·æ±‚ä»£ç†æé†’æƒé™');
      const grantStatus = await atManager.requestPermissionsFromUser(this.context, permissions);
      console.info('ğŸ”” [EntryAbility] ä»£ç†æé†’æƒé™ç»“æœ: ' + JSON.stringify(grantStatus.authResults));
      if (grantStatus.authResults[0] === 0) {
        console.info('âœ… [EntryAbility] ä»£ç†æé†’æƒé™å·²æˆäºˆ');
        hilog.info(DOMAIN, 'testTag', 'âœ… ä»£ç†æé†’æƒé™å·²æˆäºˆ');
      } else {
        console.warn('âš ï¸ [EntryAbility] ä»£ç†æé†’æƒé™è¢«æ‹’ç»');
        hilog.warn(DOMAIN, 'testTag', 'âš ï¸ ä»£ç†æé†’æƒé™è¢«æ‹’ç»');
      }
    } catch (err) {
      console.error('âŒ [EntryAbility] è¯·æ±‚ä»£ç†æé†’æƒé™å¤±è´¥: ' + JSON.stringify(err));
      hilog.error(DOMAIN, 'testTag', 'âŒ è¯·æ±‚ä»£ç†æé†’æƒé™å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }
}
// æ–‡ä»¶: entry/src/main/ets/pages/Index.ets
import { PollenIndexView } from '../views/PollenIndexView'
import { RegionView } from '../views/RegionView'
import { MapView } from '../views/MapView'
import { SettingsView } from '../views/SettingsView'
import { VibrationUtils } from '../utils/VibrationUtils'
@Entry
@Component
struct Index {
  @State currentIndex: number = 0
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'
  private tabItems: TabItem[] = [
    { title: 'èŠ±ç²‰æŒ‡æ•°', icon: $r('app.media.icon_leaf') },
    { title: 'åŒºåŸŸ', icon: $r('app.media.icon_location') },
    { title: 'åœ°å›¾', icon: $r('app.media.icon_map') },
    { title: 'è®¾ç½®', icon: $r('app.media.icon_settings') }
  ]
  build() {
    Column() {
      Tabs({ barPosition: BarPosition.End, index: this.currentIndex }) {
        TabContent() {
          PollenIndexView()
        }
        .tabBar(this.TabBuilder(0, this.safeBottom))
        TabContent() {
          RegionView()
        }
        .tabBar(this.TabBuilder(1, this.safeBottom))
        TabContent() {
          MapView()
        }
        .tabBar(this.TabBuilder(2, this.safeBottom))
        TabContent() {
          SettingsView()
        }
        .tabBar(this.TabBuilder(3, this.safeBottom))
      }
      .barMode(BarMode.Fixed)
      .barHeight(56 + this.safeBottom)
      .barBackgroundColor($r('app.color.navbar_background'))
      .onChange((index: number) => {
        VibrationUtils.triggerLight()
        this.currentIndex = index
      })
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP])
  }
  @Builder
  TabBuilder(index: number, safeBottom: number) {
    Column() {
      Image(this.tabItems[index].icon)
        .width(24)
        .height(24)
        .fillColor(this.currentIndex === index ? this.pollenThemeColor : $r('app.color.text_secondary'))
      Text(this.tabItems[index].title)
        .fontSize(10)
        .fontColor(this.currentIndex === index ? this.pollenThemeColor : $r('app.color.text_secondary'))
        .margin({ top: 4 })
    }
    .width('100%')
    .height(56 + safeBottom)
    .padding({ bottom: safeBottom })
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Transparent)
  }
}
interface TabItem {
  title: string
  icon: Resource
}
// æ–‡ä»¶: entry/src/main/ets/views/PollenIndexView.ets
import { PollenService } from '../service/PollenService'
import { LocationService, LocationInfo } from '../service/LocationService'
import { WeatherService, WeatherResponse } from '../service/WeatherService'
import { SeasonHelper, OffSeasonContent } from '../utils/SeasonHelper'
import { vibrator } from '@kit.SensorServiceKit'
import {
  PollenForecastResponse,
  DailyInfo,
  PollenLevel,
  levelToText,
  levelToColor,
  formatDateShort,
  getMaxPollenFromDaily,
  getMaxPollenIndexFromDaily,
  getHealthRecommendationsFromDaily
} from '../model/PollenModels'
@Component
export struct PollenIndexView {
  @StorageLink('currentCity') @Watch('onCityChange') currentCity: string = 'å®šä½ä¸­...'
  @StorageLink('pollenValue') pollenValue: number = 0
  @StorageLink('pollenLevel') pollenLevel: string = 'åŠ è½½ä¸­...'
  @StorageLink('updateTime') updateTime: string = 'æ­£åœ¨è·å–æ•°æ®...'
  @State pollenLevelEnum: PollenLevel = PollenLevel.NONE
  @State isScrolled: boolean = false
  @State isAnimating: boolean = false
  @State isLoading: boolean = true
  @State errorMessage: string = ''
  @State isLocating: boolean = true
  @State healthTips: string[] = []
  @State isPollenSeason: boolean = SeasonHelper.isPollenSeason()
  @State offSeasonContent: OffSeasonContent | null = null
  @State isGuideExpanded: boolean = false
  @State showGuideSheet: boolean = false
  @State dataSwiperIndex: number = 0
  @State previewVisible: boolean = false
  @State previewData: PreviewData = { title: '', value: '', desc: '', extra: '' }
  @StorageLink('safeTop') safeTop: number = 44
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'
  private pollenService: PollenService = PollenService.getInstance()
  private locationService: LocationService = LocationService.getInstance()
  private weatherService: WeatherService = WeatherService.getInstance()
  @StorageLink('latitude') latitude: number = 23.1291
  @StorageLink('longitude') longitude: number = 113.2644
  @State weatherData: WeatherItem[] = [
    { icon: $r('app.media.icon_temperature'), value: '24Â°C', label: 'æ¸©åº¦' },
    { icon: $r('app.media.icon_temperature'), value: '23Â°C', label: 'ä½“æ„Ÿ' },
    { icon: $r('app.media.icon_wind'), value: '4.0m/s', label: 'é£åŠ›' },
    { icon: $r('app.media.icon_arrow_up'), value: '24Â°C', label: 'æœ€é«˜' },
    { icon: $r('app.media.icon_arrow_down'), value: '24Â°C', label: 'æœ€ä½' },
    { icon: $r('app.media.icon_pressure'), value: '1018', label: 'æ°”å‹(å¸•)' },
    { icon: $r('app.media.icon_humidity'), value: '43%', label: 'æ¹¿åº¦' },
    { icon: $r('app.media.icon_sunrise'), value: '06:54', label: 'æ—¥å‡º' },
    { icon: $r('app.media.icon_sunset'), value: '17:41', label: 'æ—¥è½' }
  ]
  @State trendData: TrendItem[] = []
  @State monthlyData: MonthDataItem[] = []
  private scroller: Scroller = new Scroller()
  aboutToAppear(): void {
    this.isPollenSeason = SeasonHelper.isPollenSeason()
    if (!this.isPollenSeason) {
      this.offSeasonContent = SeasonHelper.getOffSeasonContent()
    }
    this.initLocation()
  }
  async initLocation(): Promise<void> {
    this.isLocating = true
    const startTime = Date.now()
    try {
      const cachedLocation = this.locationService.getCachedLocation()
      if (cachedLocation) {
        this.latitude = cachedLocation.latitude
        this.longitude = cachedLocation.longitude
        this.currentCity = cachedLocation.city || 'å½“å‰ä½ç½®'
        this.isLocating = false
        console.info(`[PollenIndexView] âš¡ ä½¿ç”¨ç¼“å­˜ä½ç½® (${Date.now() - startTime}ms)`)
        this.loadPollenData()
        this.updateLocationInBackground()
        return
      }
      const hasPermission = await this.locationService.checkAndRequestPermission()
      if (hasPermission) {
        const location = await this.locationService.getQuickLocation()
        if (location !== null) {
          this.latitude = location.latitude
          this.longitude = location.longitude
          this.currentCity = location.city || 'å½“å‰ä½ç½®'
          console.info(`[PollenIndexView] âš¡ å¿«é€Ÿå®šä½æˆåŠŸ (${Date.now() - startTime}ms): ${this.currentCity}`)
        } else {
          const defaultLocation = this.locationService.getDefaultLocation()
          this.latitude = defaultLocation.latitude
          this.longitude = defaultLocation.longitude
          this.currentCity = defaultLocation.city
          console.warn(`[PollenIndexView] å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½® (${Date.now() - startTime}ms)`)
        }
        this.subscribeLocationUpdates()
      } else {
        const defaultLocation = this.locationService.getDefaultLocation()
        this.latitude = defaultLocation.latitude
        this.longitude = defaultLocation.longitude
        this.currentCity = defaultLocation.city
        console.warn('[PollenIndexView] æ— ä½ç½®æƒé™ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®')
      }
    } catch (error) {
      console.error('[PollenIndexView] å®šä½å¼‚å¸¸: ' + JSON.stringify(error))
      const defaultLocation = this.locationService.getDefaultLocation()
      this.latitude = defaultLocation.latitude
      this.longitude = defaultLocation.longitude
      this.currentCity = defaultLocation.city
    }
    this.isLocating = false
    this.loadPollenData()
  }
  private updateLocationInBackground(): void {
    this.locationService.checkAndRequestPermission().then((hasPermission) => {
      if (hasPermission) {
        this.subscribeLocationUpdates()
      }
    })
  }
  private subscribeLocationUpdates(): void {
    this.locationService.onLocationChange((location) => {
      if (location.city && location.city !== 'å½“å‰ä½ç½®' && location.city !== this.currentCity) {
        console.info(`[PollenIndexView] ğŸ“ åŸå¸‚åæ›´æ–°: ${location.city}`)
        this.currentCity = location.city
      }
    })
  }
  onCityChange(): void {
    console.info('[PollenIndexView] åŸå¸‚å˜åŒ–: ' + this.currentCity)
    if (this.currentCity !== 'å®šä½ä¸­...' && this.currentCity !== '') {
      this.loadPollenData()
    }
  }
  async loadPollenData(): Promise<void> {
    this.isLoading = true
    this.errorMessage = ''
    try {
      const weatherPromise = this.weatherService.getWeather(this.latitude, this.longitude)
      const pollenPromise = this.pollenService.getPollenForecast(this.latitude, this.longitude, 5)
      const weatherResponse: WeatherResponse | null = await weatherPromise
      if (weatherResponse !== null) {
        this.weatherData = [
          { icon: $r('app.media.icon_temperature'), value: `${weatherResponse.temperature}Â°C`, label: 'æ¸©åº¦' },
          { icon: $r('app.media.icon_temperature'), value: `${weatherResponse.feelsLike}Â°C`, label: 'ä½“æ„Ÿ' },
          { icon: $r('app.media.icon_wind'), value: `${weatherResponse.windSpeed}m/s`, label: 'é£åŠ›' },
          { icon: $r('app.media.icon_arrow_up'), value: weatherResponse.tempMax ? `${weatherResponse.tempMax}Â°C` : '--', label: 'æœ€é«˜' },
          { icon: $r('app.media.icon_arrow_down'), value: weatherResponse.tempMin ? `${weatherResponse.tempMin}Â°C` : '--', label: 'æœ€ä½' },
          { icon: $r('app.media.icon_pressure'), value: `${weatherResponse.pressure}`, label: 'æ°”å‹(å¸•)' },
          { icon: $r('app.media.icon_humidity'), value: `${weatherResponse.humidity}%`, label: 'æ¹¿åº¦' },
          { icon: $r('app.media.icon_sunrise'), value: weatherResponse.sunrise, label: 'æ—¥å‡º' },
          { icon: $r('app.media.icon_sunset'), value: weatherResponse.sunset, label: 'æ—¥è½' }
        ]
        console.info('[PollenIndexView] å¤©æ°”æ•°æ®å¿«é€Ÿåˆ·æ–°å®Œæˆ')
      }
      this.isLoading = false
      this.updateTime = 'åˆšåˆšæ›´æ–°'
      const pollenResponse: PollenForecastResponse | null = await pollenPromise
      console.info('[PollenIndexView] èŠ±ç²‰å“åº”: ' + JSON.stringify(pollenResponse))
      if (pollenResponse !== null) {
        const newTrend: TrendItem[] = []
        if (pollenResponse.dailyInfo && pollenResponse.dailyInfo.length > 0) {
          const todayInfo: DailyInfo = pollenResponse.dailyInfo[0]
          this.pollenValue = getMaxPollenIndexFromDaily(todayInfo)
          this.pollenLevelEnum = getMaxPollenFromDaily(todayInfo)
          this.healthTips = getHealthRecommendationsFromDaily(todayInfo)
          AppStorage.setOrCreate('pollenThemeColor', levelToColor(this.pollenLevelEnum))
          if (this.pollenValue > 0) {
            this.pollenLevel = levelToText(this.pollenLevelEnum)
            this.updateTime = 'åˆšåˆšæ›´æ–°'
          } else {
            this.pollenLevel = 'æä½'
            this.updateTime = 'éèŠ±ç²‰å­£'
          }
          for (let i = 0; i < pollenResponse.dailyInfo.length; i++) {
            const dayInfo: DailyInfo = pollenResponse.dailyInfo[i]
            const dateLabel = formatDateShort(dayInfo.date)
            const indexValue = getMaxPollenIndexFromDaily(dayInfo)
            console.info(`[DEBUG] ç¬¬${i+1}å¤©: date=${dateLabel}, indexValue=${indexValue}`)
            const item: TrendItem = {
              date: dateLabel,
              value: indexValue > 0 ? indexValue : 0
            }
            newTrend.push(item)
          }
          if (newTrend.length === 0) {
            console.info('[DEBUG] ç”Ÿæˆå ä½è¶‹åŠ¿æ•°æ®')
            for (let i = 0; i < 5; i++) {
              const today = new Date()
              today.setDate(today.getDate() + i)
              const dateLabel = `${today.getMonth() + 1}/${today.getDate()}`
              newTrend.push({ date: dateLabel, value: 0 })
            }
          }
          console.info(`[DEBUG] æœ€ç»ˆè¶‹åŠ¿æ•°æ®: ${JSON.stringify(newTrend)}`)
        } else {
          this.pollenValue = 0
          this.pollenLevel = 'æä½'
          console.info('[DEBUG] æ— æ¯æ—¥æ•°æ®ï¼Œç”Ÿæˆå ä½è¶‹åŠ¿æ•°æ®')
          for (let i = 0; i < 5; i++) {
            const today = new Date()
            today.setDate(today.getDate() + i)
            const dateLabel = `${today.getMonth() + 1}/${today.getDate()}`
            newTrend.push({ date: dateLabel, value: 0 })
          }
        }
        this.trendData = newTrend
        this.updateMonthlyData(newTrend)
        console.info(`[DEBUG] èŠ±ç²‰æ•°æ®é™é»˜æ›´æ–°å®Œæˆï¼Œè¶‹åŠ¿æ•°æ®é•¿åº¦: ${newTrend.length}`)
      } else {
        console.warn('[PollenIndexView] èŠ±ç²‰æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
        this.pollenValue = 0
        this.pollenLevel = 'æä½'
        this.trendData = [
          { date: 'æš‚æ— ', value: 0 },
          { date: 'æ•°æ®', value: 0 }
        ]
      }
    } catch (error) {
      console.error('[PollenIndexView] åŠ è½½æ•°æ®å¤±è´¥: ' + JSON.stringify(error))
      if (this.isLoading) {
        this.isLoading = false
        this.errorMessage = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
        this.updateTime = 'è·å–å¤±è´¥'
      }
      this.pollenValue = 0
      this.pollenLevel = 'æä½'
      const defaultTrend: TrendItem[] = [
        { date: 'æš‚æ— ', value: 0 },
        { date: 'æ•°æ®', value: 0 }
      ]
      this.trendData = defaultTrend
    }
  }
  formatUpdateTime(year: number, month: number, day: number): string {
    const now = new Date()
    const dataDate = new Date(year, month - 1, day)
    const diffMs = now.getTime() - dataDate.getTime()
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
    if (diffHours < 1) {
      return 'åˆšåˆšæ›´æ–°'
    } else if (diffHours < 24) {
      return `${diffHours} å°æ—¶å‰`
    } else {
      const diffDays = Math.floor(diffHours / 24)
      return `${diffDays} å¤©å‰`
    }
  }
  build() {
    Column() {
      this.TopNavBar()
      Refresh({ refreshing: $$this.isLoading, builder: this.customRefreshingContent }) {
        Scroll(this.scroller) {
          Column() {
            this.PollenMainCard()
            this.DataOverviewSwiper()
            this.HealthGuideSection()
            this.WeatherSection()
            Blank().height(56 + this.safeBottom + 16)
          }
          .width('100%')
          .padding({ 
            top: this.safeTop + 48,
            left: 16, 
            right: 16 
          })
        }
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onDidScroll(() => {
          const yOffset = this.scroller.currentOffset().yOffset
          this.isScrolled = yOffset > 20
        })
      }
      .onRefreshing(() => {
        this.loadPollenData()
      })
      .pullToRefresh(true)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      if (isVisible && currentRatio >= 1.0) {
        setTimeout(() => {
          animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
            this.isAnimating = true
          })
        }, 50)
      } else if (!isVisible || currentRatio < 0.5) {
        this.isAnimating = false
        if (this.isLoading) {
          this.isLoading = false
        }
      }
    })
  }
  @Builder
  customRefreshingContent() {
  }
  @Builder
  TopNavBar() {
    Column() {
      Row()
        .height(this.safeTop)
        .width('100%')
      Row() {
        Row() {
          Image($r('app.media.icon_location'))
            .width(18)
            .height(18)
            .fillColor($r('app.color.icon_primary'))
            .accessibilityText('å®šä½å›¾æ ‡')
          Text(this.currentCity)
            .fontSize(17)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
            .margin({ left: 6 })
            .accessibilityText(`å½“å‰åŸå¸‚ï¼š${this.currentCity}`)
          if (this.isLoading) {
            LoadingProgress()
              .width(16)
              .height(16)
              .color($r('app.color.icon_primary'))
              .margin({ left: 8 })
              .accessibilityText('æ•°æ®åŠ è½½ä¸­')
          }
        }
        .accessibilityText(`å½“å‰ä½ç½®ï¼š${this.currentCity}${this.isLoading ? 'ï¼Œæ­£åœ¨åŠ è½½æ•°æ®' : ''}`)
        .accessibilityGroup(true)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .position({ x: 0, y: 0 })
    .zIndex(999)
    .backgroundColor($r('app.color.navbar_background'))
    .backdropBlur(40)
    .border({
      width: { bottom: 0.5 },
      color: $r('app.color.navbar_border')
    })
    .shadow({
      radius: 10,
      color: 'rgba(0, 0, 0, 0.06)',
      offsetY: 2
    })
  }
  @Builder
  PollenMainCard() {
    Column() {
      Stack() {
        Circle()
          .width(180)
          .height(180)
          .fill(Color.Transparent)
          .stroke('#333333')
          .strokeWidth(12)
        Circle()
          .width(180)
          .height(180)
          .fill(Color.Transparent)
          .stroke(this.getLevelColor())
          .strokeWidth(12)
          .strokeDashArray([this.getProgressLength(), 565])
          .rotate({ angle: -90 })
        Column() {
          Row() {
            Text('â˜€ï¸')
              .fontSize(24)
            Text(this.pollenValue.toString())
              .fontSize(48)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Bold)
              .margin({ left: 4 })
          }
          Text('ç²’/kmÂ³')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })
          Text(this.pollenLevel)
            .fontSize(18)
            .fontColor(this.getLevelColor())
            .fontWeight(FontWeight.Medium)
            .margin({ top: 8 })
        }
        .accessibilityText(`å½“å‰èŠ±ç²‰æµ“åº¦${this.pollenValue}ç²’æ¯ç«‹æ–¹åƒç±³ï¼Œ${this.pollenLevel}çº§åˆ«`)
        .accessibilityGroup(true)
      }
      .width(200)
      .height(200)
      .margin({ top: 20 })
      Text(this.updateTime)
        .fontSize(13)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 16 })
        .accessibilityText(`æ•°æ®æ›´æ–°æ—¶é—´ï¼š${this.updateTime}`)
      if (this.pollenValue === 0 && this.updateTime === 'éèŠ±ç²‰å­£') {
        Text('å½“å‰ä¸ºéèŠ±ç²‰å­£ï¼ŒèŠ±ç²‰æ´»åŠ¨æä½ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8, bottom: 20 })
          .textAlign(TextAlign.Center)
          .width('80%')
      } else {
        Blank().height(20)
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 20, bottom: 20 })
    .margin({ top: 16 })
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 0,
      curve: Curve.EaseOut
    })
  }
  @Builder
  DataOverviewSwiper() {
    Stack() {
      Column() {
        Row({ space: 0 }) {
          ForEach(['5å¤©é¢„æŠ¥', 'æœ¬æœˆè¶‹åŠ¿', 'å…¨å¹´è¶‹åŠ¿'], (tab: string, index: number) => {
            Column() {
              Text(tab)
                .fontSize(14)
                .fontColor(this.dataSwiperIndex === index ? this.pollenThemeColor : $r('app.color.text_secondary'))
                .fontWeight(this.dataSwiperIndex === index ? FontWeight.Medium : FontWeight.Normal)
              Row()
                .width(this.dataSwiperIndex === index ? 24 : 0)
                .height(3)
                .backgroundColor('#4CAF50')
                .borderRadius(2)
                .margin({ top: 6 })
                .animation({ duration: 200, curve: Curve.EaseOut })
            }
            .layoutWeight(1)
            .accessibilityText(`${tab}${this.dataSwiperIndex === index ? 'ï¼Œå·²é€‰ä¸­' : ''}ï¼ŒåŒå‡»åˆ‡æ¢`)
            .onClick(() => {
              this.dataSwiperIndex = index
            })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 8 })
        .accessibilityText('æ•°æ®æŸ¥çœ‹é€‰é¡¹å¡ï¼Œå½“å‰æ˜¾ç¤º' + ['5å¤©é¢„æŠ¥', 'æœ¬æœˆè¶‹åŠ¿', 'å…¨å¹´è¶‹åŠ¿'][this.dataSwiperIndex])
        Swiper() {
          this.FiveDayForecastPage()
          this.MonthlyTrendPage()
          this.YearlyTrendPage()
        }
        .index(this.dataSwiperIndex)
        .indicator(false)
        .loop(false)
        .onChange((index: number) => {
          this.dataSwiperIndex = index
        })
        .height(240)
      }
      .width('100%')
      if (this.previewVisible) {
        Column() {
          Text(this.previewData.title)
            .fontSize(13)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
          Text(this.previewData.value)
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 4 })
          Text(this.previewData.desc)
            .fontSize(12)
            .fontColor('rgba(255,255,255,0.8)')
            .margin({ top: 4 })
          if (this.previewData.extra.length > 0) {
            Text(this.previewData.extra)
              .fontSize(11)
              .fontColor('rgba(255,255,255,0.7)')
              .margin({ top: 4 })
          }
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('rgba(0,0,0,0.85)')
        .borderRadius(12)
        .shadow({ radius: 20, color: 'rgba(0,0,0,0.3)', offsetY: 4 })
        .animation({ duration: 150, curve: Curve.EaseOut })
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .margin({ top: 16 })
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 80,
      curve: Curve.EaseOut
    })
  }
  @Builder
  FiveDayForecastPage() {
    Column() {
      if (this.trendData.length === 0 || this.trendData.every((item: TrendItem) => item.value === 0)) {
        Column() {
          Text('ğŸŒ¿')
            .fontSize(40)
          Text('éèŠ±ç²‰å­£')
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
            .margin({ top: 12 })
          Text('å½“å‰èŠ±ç²‰æ´»åŠ¨æä½ï¼Œ5å¤©å†…æ— æ˜æ˜¾èŠ±ç²‰é¢„æŠ¥')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 8 })
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .accessibilityText('å½“å‰ä¸ºéèŠ±ç²‰å­£ï¼ŒèŠ±ç²‰æ´»åŠ¨æä½ï¼Œ5å¤©å†…æ— æ˜æ˜¾èŠ±ç²‰é¢„æŠ¥')
      } else {
        Row() {
          ForEach(this.trendData, (item: TrendItem, index: number) => {
            Column() {
              Text(item.value.toString())
                .fontSize(11)
                .fontColor(item.value > 0 ? this.pollenThemeColor : '#808080')
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 4 })
              Column()
                .width(32)
                .height(Math.max(8, item.value * 1.5))
                .backgroundColor(item.value > 0 ? this.pollenThemeColor : '#E0E0E0')
                .borderRadius(6)
              Text(item.date)
                .fontSize(11)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 8 })
            }
            .justifyContent(FlexAlign.End)
            .height(160)
            .accessibilityText(`${item.date}ï¼ŒèŠ±ç²‰æµ“åº¦${item.value}ç²’æ¯ç«‹æ–¹åƒç±³ï¼Œé•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…`)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showDayPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      }
    }
    .width('100%')
    .height('100%')
  }
  @Builder
  MonthlyTrendPage() {
    Column() {
      Row() {
        Text(this.getCurrentMonthName())
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
        Blank()
        Text('é•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(11)
          .fontColor($r('app.color.text_secondary'))
          .opacity(0.6)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })
      Stack() {
        Polygon({ width: '100%', height: 120 })
          .points(this.buildGradientArea(this.monthlyData.map(item => {
            const trendItem: TrendItem = { date: item.label, value: item.value }
            return trendItem
          }), 120, 1.2))
          .fill('#42A5F5')
          .opacity(0.15)
        Polyline({ width: '100%', height: 120 })
          .points(this.buildCurvePath(this.monthlyData.map(item => {
            const trendItem: TrendItem = { date: item.label, value: item.value }
            return trendItem
          }), 120, 1.2))
          .stroke('#42A5F5')
          .strokeWidth(2.5)
          .strokeLineCap(LineCapStyle.Round)
          .strokeLineJoin(LineJoinStyle.Round)
        Row() {
          ForEach(this.getMonthlyData(), (item: MonthDataItem, index: number) => {
            Column() {
              Circle()
                .width(6)
                .height(6)
                .fill('#42A5F5')
                .position({ y: 120 - Math.max(4, item.value * 1.2) })
              Text(item.label)
                .fontSize(9)
                .fontColor($r('app.color.text_secondary'))
                .position({ y: 125 })
            }
            .width('10%')
            .height(135)
            .justifyContent(FlexAlign.End)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showMonthPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .height(135)
      }
      .width('100%')
      .height(135)
      .padding({ left: 8, right: 8 })
      Row() {
        Column() {
          Text('æœ¬æœˆå‡å€¼')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '32' : '0')
            .fontSize(16)
            .fontColor('#42A5F5')
            .fontWeight(FontWeight.Medium)
        }
        Column() {
          Text('æœ€é«˜å€¼')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '68' : '0')
            .fontSize(16)
            .fontColor(this.pollenThemeColor)
            .fontWeight(FontWeight.Medium)
        }
        Column() {
          Text('é€‚å®œå¤–å‡º')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '18å¤©' : '30å¤©')
            .fontSize(16)
            .fontColor('#4CAF50')
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
      .padding({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 8 })
  }
  @Builder
  YearlyTrendPage() {
    Column() {
      Row() {
        Text('2025å¹´èŠ±ç²‰è¶‹åŠ¿')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
        Blank()
        Row() {
          Circle().width(6).height(6).fill(this.pollenThemeColor)
          Text('é«˜å³°æœŸ')
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 4 })
          Circle().width(6).height(6).fill('#42A5F5').margin({ left: 8 })
          Text('è¿‡æ¸¡æœŸ')
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 4 })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })
      Stack() {
        Polygon({ width: '100%', height: 100 })
          .points(this.buildGradientArea(this.getYearlyData().map(item => {
            const trendItem: TrendItem = { date: item.month, value: item.value }
            return trendItem
          }), 100, 1.0))
          .fill(this.pollenThemeColor)
          .opacity(0.12)
        Polyline({ width: '100%', height: 100 })
          .points(this.buildCurvePath(this.getYearlyData().map(item => {
            const trendItem: TrendItem = { date: item.month, value: item.value }
            return trendItem
          }), 100, 1.0))
          .stroke(this.pollenThemeColor)
          .strokeWidth(2.5)
          .strokeLineCap(LineCapStyle.Round)
          .strokeLineJoin(LineJoinStyle.Round)
        Row() {
          ForEach(this.getYearlyData(), (item: YearDataItem, index: number) => {
            Column() {
              Circle()
                .width(item.isPeak ? 7 : 5)
                .height(item.isPeak ? 7 : 5)
                .fill(this.pollenThemeColor)
                .position({ y: 100 - Math.max(4, item.value * 1.0) })
              Text(item.month)
                .fontSize(9)
                .fontColor(item.isCurrent ? this.pollenThemeColor : $r('app.color.text_secondary'))
                .fontWeight(item.isCurrent ? FontWeight.Bold : FontWeight.Normal)
                .position({ y: 105 })
            }
            .width(`${100/12}%`)
            .height(115)
            .justifyContent(FlexAlign.End)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showYearPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .height(115)
      }
      .width('100%')
      .height(115)
      .padding({ left: 8, right: 8 })
      Row() {
        Text('ğŸ“…')
          .fontSize(14)
        Text('æ˜¥å­£èŠ±ç²‰å­£ 3-5æœˆ | ç§‹å­£èŠ±ç²‰å­£ 8-10æœˆ')
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .margin({ left: 6 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 12 })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 8 })
  }
  private getCurrentMonthName(): string {
    const month = new Date().getMonth() + 1
    return `${month}æœˆèŠ±ç²‰è¶‹åŠ¿`
  }
  private updateMonthlyData(trendData: TrendItem[]): void {
    const data: MonthDataItem[] = []
    const maxDays = Math.min(trendData.length, 10)
    for (let i = 0; i < maxDays; i++) {
      const item = trendData[i]
      data.push({ 
        label: item.date,
        value: item.value 
      })
    }
    if (data.length < 10) {
      const today = new Date()
      for (let i = data.length; i < 10; i++) {
        const futureDate = new Date(today.getTime() + i * 24 * 60 * 60 * 1000)
        const dateLabel = `${futureDate.getMonth() + 1}/${futureDate.getDate()}`
        data.push({ 
          label: dateLabel, 
          value: 0
        })
      }
    }
    this.monthlyData = data
  }
  private getMonthlyData(): MonthDataItem[] {
    return this.monthlyData
  }
  private getYearlyData(): YearDataItem[] {
    const currentMonth = new Date().getMonth() + 1
    const currentValue = this.pollenValue
    const isSouthern = this.latitude < 30
    const baseTemplate = isSouthern ? 
      [8, 60, 85, 70, 30, 15, 10, 40, 65, 50, 20, 10] :
      [5, 15, 70, 90, 75, 25, 12, 45, 70, 55, 18, 8]
    let scaleFactor = 1.0
    if (currentValue > 0 && baseTemplate[currentMonth - 1] > 0) {
      scaleFactor = currentValue / baseTemplate[currentMonth - 1]
    }
    return baseTemplate.map((baseValue, index) => {
      const month = index + 1
      const adjustedValue = Math.round(baseValue * scaleFactor)
      const isPeak = baseValue >= 60
      const yearItem: YearDataItem = {
        month: `${month}æœˆ`,
        value: adjustedValue,
        isPeak: isPeak,
        isCurrent: month === currentMonth
      }
      return yearItem
    })
  }
  private buildCurvePath(data: TrendItem[], height: number, scale: number): Array<[number, number]> {
    const points: Array<[number, number]> = []
    const width = 100
    const count = data.length
    if (count === 0) return [[0, height], [width, height]]
    for (let i = 0; i < count; i++) {
      const x = (width / (count - 1)) * i
      const y = height - Math.max(4, data[i].value * scale)
      points.push([x, y])
    }
    return points
  }
  private buildGradientArea(data: TrendItem[], height: number, scale: number): Array<[number, number]> {
    const points: Array<[number, number]> = []
    const width = 100
    const count = data.length
    if (count === 0) return [[0, height], [width, height], [width, height], [0, height]]
    points.push([0, height])
    for (let i = 0; i < count; i++) {
      const x = (width / (count - 1)) * i
      const y = height - Math.max(4, data[i].value * scale)
      points.push([x, y])
    }
    points.push([width, height])
    return points
  }
  private triggerVibration(): void {
    try {
      const effect: vibrator.VibrateEffect = {
        type: 'time',
        duration: 30
      }
      const attribute: vibrator.VibrateAttribute = {
        usage: 'touch'
      }
      vibrator.startVibration(effect, attribute)
    } catch (e) {
    }
  }
  private showDayPreview(item: TrendItem, index: number): void {
    const today = new Date()
    const targetDate = new Date(today.getTime() + index * 24 * 60 * 60 * 1000)
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']
    const weekDay = weekDays[targetDate.getDay()]
    const levelText = item.value === 0 ? 'æ— èŠ±ç²‰' : 
                      item.value < 30 ? 'ä½æµ“åº¦' : 
                      item.value < 60 ? 'ä¸­æµ“åº¦' : 'é«˜æµ“åº¦'
    const previewItem: PreviewData = {
      title: `${targetDate.getMonth() + 1}æœˆ${targetDate.getDate()}æ—¥ ${weekDay}`,
      value: `${item.value} ç²’/kmÂ³`,
      desc: levelText,
      extra: item.value === 0 ? 'é€‚åˆæˆ·å¤–æ´»åŠ¨' : item.value < 30 ? 'å¯æ­£å¸¸å¤–å‡º' : 'å»ºè®®åšå¥½é˜²æŠ¤'
    }
    this.previewData = previewItem
    this.previewVisible = true
  }
  private showMonthPreview(item: MonthDataItem, index: number): void {
    const startDay = index * 3 + 1
    const endDay = Math.min((index + 1) * 3, 30)
    const month = new Date().getMonth() + 1
    const previewItem: PreviewData = {
      title: `${month}æœˆ${startDay}-${endDay}æ—¥`,
      value: `${item.value} ç²’/kmÂ³`,
      desc: item.value === 0 ? 'éèŠ±ç²‰å­£' : `æ—¥å‡æµ“åº¦`,
      extra: item.value === 0 ? 'èŠ±ç²‰æ´»åŠ¨æä½' : item.value < 30 ? 'èŠ±ç²‰æµ“åº¦è¾ƒä½' : 'æ³¨æ„é˜²æŠ¤'
    }
    this.previewData = previewItem
    this.previewVisible = true
  }
  private showYearPreview(item: YearDataItem, index: number): void {
    const monthPollenTypes: string[] = [
      'æŸæ ‘ã€æ¦†æ ‘èŒåŠ¨',
      'æŸæ ‘ã€æ¨æ ‘åˆèŠ±',
      'æŸæ ‘ã€æ¨æ ‘ã€æŸ³æ ‘',
      'æ¨æ ‘ã€æŸ³æ ‘ã€æ¦†æ ‘',
      'æ¾æ ‘ã€æ³•æ¡ã€æ¨çµ®',
      'ç¦¾æœ¬ç§‘è‰ç±»',
      'ç¦¾æœ¬ç§‘è‰ç±»',
      'è’¿è‰ã€è±šè‰åˆèŠ±',
      'è’¿è‰ã€è±šè‰é«˜å³°',
      'è’¿è‰ã€è‘è‰',
      'èŠ±ç²‰å‡å°‘',
      'èŠ±ç²‰ä¼‘çœ æœŸ'
    ]
    const previewItem: PreviewData = {
      title: item.month,
      value: item.isPeak ? 'âš ï¸ é«˜å³°æœŸ' : (item.value > 20 ? 'ğŸ“Š è¿‡æ¸¡æœŸ' : 'âœ… ä½é£é™©'),
      desc: `é¢„è®¡æµ“åº¦: ${item.value}`,
      extra: `ä¸»è¦èŠ±ç²‰: ${monthPollenTypes[index]}`
    }
    this.previewData = previewItem
    this.previewVisible = true
  }
  @Builder
  WeatherSection() {
    Column() {
      Text('å¤©æ°”æƒ…å†µ')
        .fontSize(16)
        .fontColor($r('app.color.text_primary'))
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .padding({ left: 16, bottom: 12 })
      Grid() {
        ForEach(this.weatherData, (item: WeatherItem) => {
          GridItem() {
            Column() {
              Image(item.icon)
                .width(24)
                .height(24)
                .fillColor(this.pollenThemeColor)
              Text(item.value)
                .fontSize(16)
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Medium)
                .margin({ top: 6 })
              Text(item.label)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 4 })
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr')
      .width('100%')
      .height(240)
      .padding({ left: 8, right: 8 })
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 16, bottom: 16 })
    .margin({ top: 16 })
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 120,
      curve: Curve.EaseOut
    })
  }
  @Builder
  HealthGuideSection() {
    Column() {
      Row() {
        Image($r('app.media.icon_shield'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.icon_primary'))
        Text(this.isPollenSeason ? 'é˜²æŠ¤æŒ‡å—' : (this.offSeasonContent?.title ?? 'å­£èŠ‚æç¤º'))
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Medium)
          .margin({ left: 6 })
        Blank()
        Text(SeasonHelper.getSeasonDescription())
          .fontSize(11)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
        Image($r('app.media.icon_arrow_down'))
          .width(14)
          .height(14)
          .fillColor('#757575')
          .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
          .animation({ duration: 200, curve: Curve.EaseOut })
          .margin({ left: 8 })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.isGuideExpanded = !this.isGuideExpanded
      })
      Column() {
        if (this.isPollenSeason) {
          this.PollenSeasonGuide()
        } else {
          this.OffSeasonGuide()
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 16, bottom: 16 })
    .margin({ top: 16 })
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 40,
      curve: Curve.EaseOut
    })
    .bindSheet($$this.showGuideSheet, this.GuideDetailSheet(), {
      height: SheetSize.MEDIUM,
      dragBar: true,
      showClose: true,
      title: { title: this.isPollenSeason ? 'è¯¦ç»†é˜²æŠ¤æŒ‡å—' : 'å­£èŠ‚å¥åº·æç¤º' }
    })
  }
  @Builder
  PollenSeasonGuide() {
    Column({ space: 8 }) {
      if (this.healthTips.length === 0) {
        Text('å½“å‰ç©ºæ°”è´¨é‡è‰¯å¥½ï¼Œæ— ç‰¹åˆ«é˜²æŠ¤å»ºè®®')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .padding(16)
      } else {
        ForEach(this.healthTips.slice(0, 3), (tip: string) => {
          Row() {
            Text(tip)
              .fontSize(14)
              .fontColor('#2E7D32')
          }
          .width('100%')
          .backgroundColor('#E8F5E9')
          .padding(12)
          .borderRadius(8)
        })
        if (this.isGuideExpanded && this.healthTips.length > 3) {
          ForEach(this.healthTips.slice(3), (tip: string) => {
            Row() {
              Text(tip)
                .fontSize(14)
                .fontColor('#2E7D32')
            }
            .width('100%')
            .backgroundColor('#E8F5E9')
            .padding(12)
            .borderRadius(8)
          })
        }
        if (this.healthTips.length > 3) {
          Row() {
            Text(this.isGuideExpanded ? 'æ”¶èµ·' : `å±•å¼€å…¨éƒ¨ (${this.healthTips.length}æ¡)`)
              .fontSize(13)
              .fontColor('#4CAF50')
            Image($r('app.media.icon_arrow_down'))
              .width(12)
              .height(12)
              .fillColor('#4CAF50')
              .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
              .margin({ left: 4 })
          }
          .justifyContent(FlexAlign.Center)
          .padding({ top: 8 })
          .onClick(() => {
            this.isGuideExpanded = !this.isGuideExpanded
          })
        }
        if (this.isGuideExpanded) {
          Row() {
            Text('æŸ¥çœ‹è¯¦ç»†é˜²æŠ¤æŒ‡å—')
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_up'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .margin({ left: 4 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 12, bottom: 4 })
          .onClick(() => {
            this.showGuideSheet = true
          })
        }
      }
    }
    .padding({ top: 8 })
  }
  @Builder
  OffSeasonGuide() {
    Column({ space: 12 }) {
      if (this.offSeasonContent !== null) {
        Text(this.offSeasonContent.description)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .lineHeight(22)
        Column({ space: 8 }) {
          ForEach(this.offSeasonContent.tips.slice(0, this.isGuideExpanded ? this.offSeasonContent.tips.length : 3), (tip: string) => {
            Row() {
              Text(tip)
                .fontSize(14)
                .fontColor('#1565C0')
            }
            .width('100%')
            .backgroundColor('#E3F2FD')
            .padding(12)
            .borderRadius(8)
          })
        }
        if (this.offSeasonContent.tips.length > 3) {
          Row() {
            Text(this.isGuideExpanded ? 'æ”¶èµ·' : `å±•å¼€å…¨éƒ¨ (${this.offSeasonContent.tips.length}æ¡)`)
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_down'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
              .margin({ left: 4 })
          }
          .justifyContent(FlexAlign.Center)
          .padding({ top: 8 })
          .onClick(() => {
            this.isGuideExpanded = !this.isGuideExpanded
          })
        }
        if (this.isGuideExpanded && this.offSeasonContent.nextSeasonHint.length > 0) {
          Row() {
            Image($r('app.media.icon_calendar'))
              .width(14)
              .height(14)
              .fillColor('#FF9800')
            Text(this.offSeasonContent.nextSeasonHint)
              .fontSize(12)
              .fontColor('#FF9800')
              .margin({ left: 6 })
          }
          .width('100%')
          .backgroundColor('#FFF8E1')
          .padding(10)
          .borderRadius(8)
          .margin({ top: 4 })
          Row() {
            Text('æŸ¥çœ‹å­£èŠ‚å¥åº·æŒ‡å—')
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_up'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .margin({ left: 4 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 12, bottom: 4 })
          .onClick(() => {
            this.showGuideSheet = true
          })
        }
      }
    }
    .padding({ top: 8 })
  }
  @Builder
  GuideDetailSheet() {
    Scroll() {
      Column({ space: 16 }) {
        if (this.isPollenSeason) {
          this.DetailSection('ğŸ¯ æ ¸å¿ƒé˜²æŠ¤è¦ç‚¹', [
            'å¤–å‡ºå¿…æˆ´å£ç½©ï¼ˆN95æ•ˆæœæœ€ä½³ï¼‰',
            'ä½©æˆ´æŠ¤ç›®é•œæˆ–å¤ªé˜³é•œ',
            'èŠ±ç²‰é«˜å³°æœŸï¼ˆ10:00-16:00ï¼‰å‡å°‘å¤–å‡º',
            'å›å®¶åç«‹å³æ´—æ‰‹ã€æ´—è„¸ã€æ¸…æ´—é¼»è…”'
          ])
          this.DetailSection('ğŸ  å±…å®¶é˜²æŠ¤', [
            'å…³é—­é—¨çª—ï¼Œä½¿ç”¨ç©ºæ°”å‡€åŒ–å™¨',
            'å®šæœŸæ¸…æ´—åºŠå•ã€çª—å¸˜ç­‰ç»‡ç‰©',
            'ä½¿ç”¨å¸å°˜å™¨æ¸…æ´åœ°é¢ï¼ˆå¸¦HEPAæ»¤ç½‘ï¼‰',
            'é¿å…åœ¨å®¤å¤–æ™¾æ™’è¡£ç‰©'
          ])
          this.DetailSection('ğŸš— å‡ºè¡Œå»ºè®®', [
            'å¼€è½¦æ—¶å…³é—­è½¦çª—ï¼Œä½¿ç”¨å†…å¾ªç¯',
            'é€‰æ‹©æ¸…æ™¨æˆ–é›¨åå¤–å‡ºï¼ˆèŠ±ç²‰è¾ƒå°‘ï¼‰',
            'é¿å…å»å…¬å›­ã€éƒŠå¤–ç­‰èŠ±ç²‰å¯†é›†åŒº',
            'éšèº«æºå¸¦æŠ—è¿‡æ•è¯ç‰©ï¼ˆéµåŒ»å˜±ï¼‰'
          ])
          this.DetailSection('âš ï¸ æ³¨æ„äº‹é¡¹', [
            'å…³æ³¨æ¯æ—¥èŠ±ç²‰æµ“åº¦é¢„æŠ¥',
            'è®°å½•è¿‡æ•ç—‡çŠ¶ï¼Œäº†è§£è‡ªå·±çš„è¿‡æ•åŸ',
            'ç—‡çŠ¶ä¸¥é‡æ—¶åŠæ—¶å°±åŒ»',
            'ä¿æŒå……è¶³ç¡çœ ï¼Œå¢å¼ºå…ç–«åŠ›'
          ])
        } else {
          this.DetailSection('ğŸŒ¿ å½“å‰å­£èŠ‚ç‰¹ç‚¹', [
            SeasonHelper.getSeasonDescription(),
            this.offSeasonContent?.description ?? ''
          ])
          this.DetailSection('ğŸ’ª å¢å¼ºä½“è´¨å»ºè®®', [
            'é€‚å½“æˆ·å¤–è¿åŠ¨ï¼Œå‘¼å¸æ–°é²œç©ºæ°”',
            'å‡è¡¡é¥®é£Ÿï¼Œå¤šåƒè”¬æœ',
            'ä¿æŒè§„å¾‹ä½œæ¯ï¼Œå……è¶³ç¡çœ ',
            'é€‚åº¦é”»ç‚¼ï¼Œæé«˜å…ç–«åŠ›'
          ])
          this.DetailSection('ğŸ  å®¶å±…æ¸…æ´', [
            'è¶éèŠ±ç²‰å­£è¿›è¡Œå¤§æ‰«é™¤',
            'æ¸…æ´—ç©ºè°ƒæ»¤ç½‘å’Œå‡€åŒ–å™¨æ»¤èŠ¯',
            'æ¸…æ´çª—å¸˜ã€åœ°æ¯¯ç­‰æ˜“ç§¯å°˜ç‰©å“',
            'æ£€æŸ¥é—¨çª—å¯†å°æ€§'
          ])
          this.DetailSection('ğŸ“… ä¸‹å­£å‡†å¤‡', [
            this.offSeasonContent?.nextSeasonHint ?? 'å…³æ³¨èŠ±ç²‰å­£é¢„æŠ¥',
            'æå‰å‡†å¤‡é˜²æŠ¤ç”¨å“ï¼ˆå£ç½©ã€æŠ¤ç›®é•œï¼‰',
            'äº†è§£å½“åœ°ä¸»è¦è‡´æ•èŠ±ç²‰ç§ç±»',
            'å¦‚æœ‰éœ€è¦ï¼Œæå‰å’¨è¯¢åŒ»ç”Ÿ'
          ])
        }
      }
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
  @Builder
  DetailSection(title: string, items: string[]) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .width('100%')
      Column({ space: 6 }) {
        ForEach(items, (item: string) => {
          if (item.length > 0) {
            Row() {
              Text('â€¢')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ right: 8 })
              Text(item)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
        })
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .padding(16)
    .borderRadius(12)
  }
  getLevelColor(): string {
    if (this.pollenValue === 0) {
      return '#4A4A4A'
    }
    return levelToColor(this.pollenLevelEnum)
  }
  getProgressLength(): number {
    if (this.pollenValue === 0) {
      return 565
    }
    const progress = Math.min(this.pollenValue, 100) / 100
    return progress * 565
  }
}
interface WeatherItem {
  icon: Resource
  value: string
  label: string
}
interface TrendItem {
  date: string
  value: number
}
interface MonthDataItem {
  label: string
  value: number
}
interface YearDataItem {
  month: string
  value: number
  isPeak: boolean
  isCurrent: boolean
}
interface PreviewData {
  title: string
  value: string
  desc: string
  extra: string
}
