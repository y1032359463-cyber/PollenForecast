/**
 * 城市编码（adcode）工具类
 * 用于将经纬度或城市名转换为 adcode（6位数字编码）
 */

/**
 * 主要城市 adcode 映射表
 * 格式：城市名（去除省市后缀） -> adcode
 */
const CITY_ADCODE_MAP: Map<string, string> = new Map([
  // 直辖市
  ['北京', '110000'],
  ['上海', '310000'],
  ['天津', '120000'],
  ['重庆', '500000'],
  
  // 广东省
  ['广州', '440100'],
  ['深圳', '440300'],
  ['珠海', '440400'],
  ['汕头', '440500'],
  ['佛山', '440600'],
  ['韶关', '440200'],
  ['湛江', '440800'],
  ['肇庆', '441200'],
  ['江门', '440700'],
  ['茂名', '440900'],
  ['惠州', '441300'],
  ['梅州', '441400'],
  ['汕尾', '441500'],
  ['河源', '441600'],
  ['阳江', '441700'],
  ['清远', '441800'],
  ['东莞', '441900'],
  ['中山', '442000'],
  ['潮州', '445100'],
  ['揭阳', '445200'],
  ['云浮', '445300'],
  
  // 江苏省
  ['南京', '320100'],
  ['苏州', '320500'],
  ['无锡', '320200'],
  ['常州', '320400'],
  ['镇江', '321100'],
  ['南通', '320600'],
  ['泰州', '321200'],
  ['扬州', '321000'],
  ['盐城', '320900'],
  ['淮安', '320800'],
  ['宿迁', '321300'],
  ['连云港', '320700'],
  ['徐州', '320300'],
  
  // 浙江省
  ['杭州', '330100'],
  ['宁波', '330200'],
  ['温州', '330300'],
  ['嘉兴', '330400'],
  ['湖州', '330500'],
  ['绍兴', '330600'],
  ['金华', '330700'],
  ['衢州', '330800'],
  ['舟山', '330900'],
  ['台州', '331000'],
  ['丽水', '331100'],
  
  // 山东省
  ['济南', '370100'],
  ['青岛', '370200'],
  ['淄博', '370300'],
  ['枣庄', '370400'],
  ['东营', '370500'],
  ['烟台', '370600'],
  ['潍坊', '370700'],
  ['济宁', '370800'],
  ['泰安', '370900'],
  ['威海', '371000'],
  ['日照', '371100'],
  ['临沂', '371300'],
  ['德州', '371400'],
  ['聊城', '371500'],
  ['滨州', '371600'],
  ['菏泽', '371700'],
  
  // 四川省
  ['成都', '510100'],
  ['自贡', '510300'],
  ['攀枝花', '510400'],
  ['泸州', '510500'],
  ['德阳', '510600'],
  ['绵阳', '510700'],
  ['广元', '510800'],
  ['遂宁', '510900'],
  ['内江', '511000'],
  ['乐山', '511100'],
  ['南充', '511300'],
  ['眉山', '511400'],
  ['宜宾', '511500'],
  ['广安', '511600'],
  ['达州', '511700'],
  ['雅安', '511800'],
  ['巴中', '511900'],
  ['资阳', '512000'],
  
  // 湖北省
  ['武汉', '420100'],
  ['黄石', '420200'],
  ['十堰', '420300'],
  ['宜昌', '420500'],
  ['襄阳', '420600'],
  ['鄂州', '420700'],
  ['荆门', '420800'],
  ['孝感', '420900'],
  ['荆州', '421000'],
  ['黄冈', '421100'],
  ['咸宁', '421200'],
  ['随州', '421300'],
  
  // 河南省
  ['郑州', '410100'],
  ['开封', '410200'],
  ['洛阳', '410300'],
  ['平顶山', '410400'],
  ['安阳', '410500'],
  ['鹤壁', '410600'],
  ['新乡', '410700'],
  ['焦作', '410800'],
  ['濮阳', '410900'],
  ['许昌', '411000'],
  ['漯河', '411100'],
  ['三门峡', '411200'],
  ['南阳', '411300'],
  ['商丘', '411400'],
  ['信阳', '411500'],
  ['周口', '411600'],
  ['驻马店', '411700'],
  ['济源', '419001'],
  
  // 湖南省
  ['长沙', '430100'],
  ['株洲', '430200'],
  ['湘潭', '430300'],
  ['衡阳', '430400'],
  ['邵阳', '430500'],
  ['岳阳', '430600'],
  ['常德', '430700'],
  ['张家界', '430800'],
  ['益阳', '430900'],
  ['郴州', '431000'],
  ['永州', '431100'],
  ['怀化', '431200'],
  ['娄底', '431300'],
  ['湘西', '433100'],
  
  // 其他重点城市
  ['西安', '610100'],
  ['沈阳', '210100'],
  ['大连', '210200'],
  ['长春', '220100'],
  ['哈尔滨', '230100'],
  ['石家庄', '130100'],
  ['太原', '140100'],
  ['合肥', '340100'],
  ['南昌', '360100'],
  ['福州', '350100'],
  ['厦门', '350200'],
  ['南宁', '450100'],
  ['海口', '460100'],
  ['昆明', '530100'],
  ['贵阳', '520100'],
  ['兰州', '620100'],
  ['银川', '640100'],
  ['西宁', '630100'],
  ['乌鲁木齐', '650100'],
  ['拉萨', '540100'],
])

/**
 * 根据城市名获取 adcode
 * @param cityName 城市名称（如"广州市"、"北京"）
 * @returns adcode（6位数字），如果未找到则返回 null
 */
export function getAdcodeByCityName(cityName: string): string | null {
  if (!cityName || cityName.length === 0) {
    return null
  }
  
  // 去除城市名中的"市"、"省"、"自治区"等后缀
  const cleanName = cityName
    .replace(/[市省自治区特别行政区]/g, '')
    .replace(/壮族|回族|维吾尔|藏族|蒙古/g, '')
    .trim()
  
  // 直接匹配
  if (CITY_ADCODE_MAP.has(cleanName)) {
    return CITY_ADCODE_MAP.get(cleanName) || null
  }
  
  // 模糊匹配（包含关系）
  for (const [key, value] of CITY_ADCODE_MAP.entries()) {
    if (cleanName.includes(key) || key.includes(cleanName)) {
      return value
    }
  }
  
  console.warn(`[AdcodeUtils] 未找到城市 ${cityName} 的 adcode`)
  return null
}

/**
 * 根据经纬度获取 adcode（通过和风天气逆地理编码）
 * @param latitude 纬度
 * @param longitude 经度
 * @returns adcode（6位数字），如果失败则返回 null
 */
export async function getAdcodeByLocation(
  latitude: number,
  longitude: number
): Promise<string | null> {
  try {
    // 调用和风天气代理服务器的逆地理编码接口
    // 注意：需要服务器端实现此接口，返回城市信息和 adcode
    // 临时方案：先通过城市名匹配
    
    // TODO: 实现服务器端逆地理编码接口
    // const httpRequest = http.createHttp()
    // const url = `http://106.12.143.105:3000/geocoding/reverse?location=${longitude},${latitude}`
    // const response = await httpRequest.request(url, { method: http.RequestMethod.GET })
    // ...
    
    // 临时返回 null，等待服务器端接口实现
    console.warn('[AdcodeUtils] 经纬度转 adcode 功能待实现，请使用城市名匹配')
    return null
  } catch (error) {
    console.error(`[AdcodeUtils] 获取 adcode 失败: ${JSON.stringify(error)}`)
    return null
  }
}

/**
 * 验证 adcode 格式是否正确
 * @param adcode 城市编码
 * @returns 是否为有效的 adcode（6位数字）
 */
export function isValidAdcode(adcode: string): boolean {
  if (!adcode || adcode.length !== 6) {
    return false
  }
  return /^\d{6}$/.test(adcode)
}
