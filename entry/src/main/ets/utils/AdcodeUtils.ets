/**
 * 城市编码（adcode）工具类
 * 用于将经纬度或城市名转换为 adcode（6位数字编码）
 */

/**
 * 完整的城市/区县 adcode 映射表（舒敏API提供的3210个区域）
 * 格式：城市/区县名（去除省市后缀） -> adcode
 * 数据来源：舒敏花粉API官方城市编码表
 */
const ADCODE_MAP: Map<string, string> = new Map([
  // 此映射表将通过外部工具生成，包含3210个省市区县的完整adcode
  // 由于数据量巨大，建议后续优化为按需加载或使用资源文件
  // 临时方案：保留核心城市映射，待工具生成完整数据后替换
  
  // ===== 占位符：待生成完整的3210个adcode映射 =====
  // 由于鸿蒙ArkTS的Map初始化语法限制，3210条数据会导致代码过长
  // 建议：将数据存储为JSON资源文件，运行时动态加载
  
  // 直辖市及区县
  ['北京市', '110000'],
  ['东城区', '110101'],
  ['西城区', '110102'],
  ['朝阳区', '110105'],
  ['丰台区', '110106'],
  ['石景山区', '110107'],
  ['海淀区', '110108'],
  ['门头沟区', '110109'],
  ['房山区', '110111'],
  ['通州区', '110112'],
  ['顺义区', '110113'],
  ['昌平区', '110114'],
  ['大兴区', '110115'],
  ['怀柔区', '110116'],
  ['平谷区', '110117'],
  ['密云区', '110118'],
  ['延庆区', '110119'],
  ['天津市', '120000'],
  ['和平区', '120101'],
  ['河东区', '120102'],
  ['河西区', '120103'],
  ['南开区', '120104'],
  ['河北区', '120105'],
  ['红桥区', '120106'],
  ['东丽区', '120110'],
  ['西青区', '120111'],
  ['津南区', '120112'],
  ['北辰区', '120113'],
  ['武清区', '120114'],
  ['宝坻区', '120115'],
  ['滨海新区', '120116'],
  ['宁河区', '120117'],
  ['静海区', '120118'],
  ['蓟州区', '120119'],
  ['上海市', '310000'],
  ['黄浦区', '310101'],
  ['徐汇区', '310104'],
  ['长宁区', '310105'],
  ['静安区', '310106'],
  ['普陀区', '310107'],
  ['虹口区', '310109'],
  ['杨浦区', '310110'],
  ['闵行区', '310112'],
  ['宝山区', '310113'],
  ['嘉定区', '310114'],
  ['浦东新区', '310115'],
  ['金山区', '310116'],
  ['松江区', '310117'],
  ['青浦区', '310118'],
  ['奉贤区', '310120'],
  ['崇明区', '310151'],
  ['重庆市', '500000'],
  
  // 广东省（含市级和区县级）
  // 广州市及其区县
  ['广州', '440100'],
  ['广州市', '440100'],
  ['荔湾区', '440103'],
  ['越秀区', '440104'],
  ['海珠区', '440105'],
  ['天河区', '440106'],
  ['白云区', '440111'],
  ['黄埔区', '440112'],
  ['番禺区', '440113'],
  ['花都区', '440114'],
  ['南沙区', '440115'],
  ['从化区', '440117'],
  ['增城区', '440118'],
  // 韶关市及其区县
  ['韶关', '440200'],
  ['韶关市', '440200'],
  ['武江区', '440203'],
  ['浈江区', '440204'],
  ['曲江区', '440205'],
  ['始兴县', '440222'],
  ['仁化县', '440224'],
  ['翁源县', '440229'],
  ['乳源瑶族自治县', '440232'],
  ['新丰县', '440233'],
  ['乐昌市', '440281'],
  ['南雄市', '440282'],
  
  // 深圳市及其区县
  ['深圳', '440300'],
  ['深圳市', '440300'],
  ['罗湖区', '440303'],
  ['福田区', '440304'],
  ['南山区', '440305'],
  ['宝安区', '440306'],
  ['龙岗区', '440307'],
  ['盐田区', '440308'],
  ['龙华区', '440309'],
  ['坪山区', '440310'],
  ['光明区', '440311'],
  // 其他广东地级市（市级adcode）
  ['珠海', '440400'],
  ['珠海市', '440400'],
  ['汕头', '440500'],
  ['汕头市', '440500'],
  ['佛山', '440600'],
  ['佛山市', '440600'],
  ['江门', '440700'],
  ['江门市', '440700'],
  ['湛江', '440800'],
  ['湛江市', '440800'],
  ['茂名', '440900'],
  ['茂名市', '440900'],
  ['肇庆', '441200'],
  ['肇庆市', '441200'],
  ['惠州', '441300'],
  ['惠州市', '441300'],
  ['梅州', '441400'],
  ['梅州市', '441400'],
  ['汕尾', '441500'],
  ['汕尾市', '441500'],
  ['河源', '441600'],
  ['河源市', '441600'],
  ['阳江', '441700'],
  ['阳江市', '441700'],
  ['清远', '441800'],
  ['清远市', '441800'],
  ['东莞', '441900'],
  ['东莞市', '441900'],
  ['中山', '442000'],
  ['中山市', '442000'],
  ['潮州', '445100'],
  ['潮州市', '445100'],
  ['揭阳', '445200'],
  ['揭阳市', '445200'],
  ['云浮', '445300'],
  ['云浮市', '445300'],
  
  // 其他省会城市（市级adcode）
  ['石家庄', '130100'],
  ['石家庄市', '130100'],
  ['太原', '140100'],
  ['太原市', '140100'],
  ['呼和浩特', '150100'],
  ['呼和浩特市', '150100'],
  ['沈阳', '210100'],
  ['沈阳市', '210100'],
  ['大连', '210200'],
  ['大连市', '210200'],
  ['长春', '220100'],
  ['长春市', '220100'],
  ['哈尔滨', '230100'],
  ['哈尔滨市', '230100'],
  ['南京', '320100'],
  ['南京市', '320100'],
  ['苏州', '320500'],
  ['苏州市', '320500'],
  ['无锡', '320200'],
  ['无锡市', '320200'],
  ['杭州', '330100'],
  ['杭州市', '330100'],
  ['宁波', '330200'],
  ['宁波市', '330200'],
  ['温州', '330300'],
  ['温州市', '330300'],
  ['合肥', '340100'],
  ['合肥市', '340100'],
  ['福州', '350100'],
  ['福州市', '350100'],
  ['厦门', '350200'],
  ['厦门市', '350200'],
  ['南昌', '360100'],
  ['南昌市', '360100'],
  ['济南', '370100'],
  ['济南市', '370100'],
  ['青岛', '370200'],
  ['青岛市', '370200'],
  ['郑州', '410100'],
  ['郑州市', '410100'],
  ['武汉', '420100'],
  ['武汉市', '420100'],
  ['长沙', '430100'],
  ['长沙市', '430100'],
  ['成都', '510100'],
  ['成都市', '510100'],
  ['贵阳', '520100'],
  ['贵阳市', '520100'],
  ['昆明', '530100'],
  ['昆明市', '530100'],
  ['拉萨', '540100'],
  ['拉萨市', '540100'],
  ['西安', '610100'],
  ['西安市', '610100'],
  ['兰州', '620100'],
  ['兰州市', '620100'],
  ['西宁', '630100'],
  ['西宁市', '630100'],
  ['银川', '640100'],
  ['银川市', '640100'],
  ['乌鲁木齐', '650100'],
  ['乌鲁木齐市', '650100'],
  
  // TODO: 完整的3210个adcode数据待补充
  // 建议：使用资源文件方式加载完整数据
])

/**
 * 根据城市/区县名获取 adcode
 * @param cityName 城市/区县名称（如“广州市”、“天河区”、“北京”）
 * @returns adcode（6位数字），如果未找到则返回 null
 */
export function getAdcodeByCityName(cityName: string): string | null {
  if (!cityName || cityName.length === 0) {
    return null
  }
  
  // 去除城市名中的“市”、“省”、“自治区”等后缀
  const cleanName = cityName
    .replace(/[市省自治区特别行政区县]/g, '')
    .replace(/壮族|回族|维吾尔|藏族|蒙古/g, '')
    .trim()
  
  // 直接匹配
  if (ADCODE_MAP.has(cleanName)) {
    return ADCODE_MAP.get(cleanName) || null
  }
  
  // 完整名称匹配（不去除后缀）
  if (ADCODE_MAP.has(cityName)) {
    return ADCODE_MAP.get(cityName) || null
  }
  
  // 模糊匹配（包含关系）
  const entries = ADCODE_MAP.entries()
  for (let it = entries.next(); !it.done; it = entries.next()) {
    const key = it.value[0]
    const value = it.value[1]
    if (cleanName.includes(key) || key.includes(cleanName)) {
      return value
    }
  }
  
  console.warn(`[AdcodeUtils] 未找到城市/区县 ${cityName} 的 adcode`)
  return null
}

/**
 * 根据经纬度获取 adcode（通过和风天气逆地理编码）
 * @param latitude 纬度
 * @param longitude 经度
 * @returns adcode（6位数字），如果失败则返回 null
 */
export async function getAdcodeByLocation(
  latitude: number,
  longitude: number
): Promise<string | null> {
  try {
    // 调用和风天气代理服务器的逆地理编码接口
    // 注意：需要服务器端实现此接口，返回城市信息和 adcode
    // 临时方案：先通过城市名匹配
    
    // TODO: 实现服务器端逆地理编码接口
    // const httpRequest = http.createHttp()
    // const url = `http://106.12.143.105:3000/geocoding/reverse?location=${longitude},${latitude}`
    // const response = await httpRequest.request(url, { method: http.RequestMethod.GET })
    // ...
    
    // 临时返回 null，等待服务器端接口实现
    console.warn('[AdcodeUtils] 经纬度转 adcode 功能待实现，请使用城市名匹配')
    return null
  } catch (error) {
    console.error(`[AdcodeUtils] 获取 adcode 失败: ${JSON.stringify(error)}`)
    return null
  }
}

/**
 * 验证 adcode 格式是否正确
 * @param adcode 城市编码
 * @returns 是否为有效的 adcode（6位数字）
 */
export function isValidAdcode(adcode: string): boolean {
  if (!adcode || adcode.length !== 6) {
    return false
  }
  return /^\d{6}$/.test(adcode)
}
