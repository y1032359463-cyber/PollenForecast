/**
 * ä¸­å›½è¡Œæ”¿åŒºåˆ’æ•°æ®åŠ è½½å™¨
 * ç”¨äºåŠ è½½å’Œè§£æ china_area_full.json æ•°æ®
 */

import { CityItem, DistrictItem, LocationCoordinate } from './CityUtils'
import resourceManager from '@ohos.resourceManager'
import util from '@ohos.util'  // âœ… å¯¼å…¥TextDecoder

// åŸå§‹æ•°æ®æ¥å£ï¼ˆä¸JSONç»“æ„å¯¹åº”ï¼‰
interface RawAreaData {
  citycode: string | string[]
  adcode: string
  name: string
  center: string  // æ ¼å¼ï¼šâ€œç»åº¦,çº¬åº¦â€
  level: string   // "province" | "city" | "district"
  districts: RawAreaData[]
}

/**
 * è§£æä¸­å¿ƒç‚¹åæ ‡
 * @param center æ ¼å¼ï¼š"113.264499,23.130061"
 * @returns {lat, lng}
 */
function parseCenter(center: string): LocationCoordinate {
  const parts = center.split(',')
  const lng = parseFloat(parts[0])
  const lat = parseFloat(parts[1])
  const result: LocationCoordinate = { lat: lat, lng: lng }
  return result
}

/**
 * åŠ è½½å¹¶è§£æJSONæ•°æ®
 * @param context åº”ç”¨ä¸Šä¸‹æ–‡
 */
export async function loadChinaAreaData(context: Context): Promise<CityItem[]> {
  try {
    // è·å–èµ„æºç®¡ç†å™¨
    const resMgr = context.resourceManager
    
    // è¯»å–rawfileä¸­çš„JSONæ–‡ä»¶
    const rawFile = await resMgr.getRawFileContent('china_area_full.json')
    
    // ğŸ”§ ä½¿ç”¨TextDecoderæ­£ç¡®è§£ç UTF-8
    const uint8Array = new Uint8Array(rawFile.buffer)
    const decoder = new util.TextDecoder('utf-8')
    const jsonString = decoder.decodeWithStream(uint8Array)
    
    // è§£æJSON
    const provinceData: RawAreaData[] = JSON.parse(jsonString)
    
    // è½¬æ¢ä¸ºCityItemæ•°ç»„
    const cities: CityItem[] = []
    
    for (const province of provinceData) {
      // ğŸ“¦ ç‰¹æ®Šå¤„ç†ï¼šç›´è¾–å¸‚ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ã€å¤©æ´¥ã€é‡åº†ï¼‰
      // ç›´è¾–å¸‚çš„ province æœ¬èº«å°±æ˜¯åŸå¸‚ï¼ŒåŒºå¿åœ¨ province.districts[0].districts ä¸­
      const isDirectCity = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†'].some(name => province.name.includes(name))
      
      if (isDirectCity && province.districts.length > 0) {
        // ç›´è¾–å¸‚ï¼šç›´æ¥ä½¿ç”¨ province ä½œä¸º cityï¼ŒåŒºå¿ä»ç¬¬ä¸€ä¸ª districts ä¸­è·å–
        const cityDistricts = province.districts[0]?.districts || []
        const location = parseCenter(province.center)
        
        const districts: DistrictItem[] = []
        for (const district of cityDistricts) {
          if (district.level === 'district') {
            const districtLocation = parseCenter(district.center)
            districts.push({
              name: district.name,
              cityName: province.name,
              isFavorite: false,
              isTop: false,
              adcode: district.adcode,
              location: districtLocation
            })
          }
        }
        
        cities.push({
          name: province.name,
          province: province.name,
          distance: 0,
          isFavorite: false,
          isTop: false,
          hasDistricts: districts.length > 0,
          districts: districts.length > 0 ? districts : undefined,
          adcode: province.adcode,
          location: location
        })
        continue
      }
      
      // æ™®é€šçœä»½ï¼šéå†çœä»½ä¸‹çš„åŸå¸‚
      for (const city of province.districts) {
        if (city.level !== 'city') continue
        
        // è§£æåŸå¸‚åæ ‡
        const location = parseCenter(city.center)
        
        // è§£æåŒºå¿åˆ—è¡¨
        const districts: DistrictItem[] = []
        const hasDistricts = city.districts && city.districts.length > 0
        
        if (hasDistricts) {
          for (const district of city.districts) {
            if (district.level === 'district') {
              const districtLocation = parseCenter(district.center)
              const districtItem: DistrictItem = {
                name: district.name,
                cityName: city.name,
                isFavorite: false,
                isTop: false,
                adcode: district.adcode,
                location: districtLocation
              }
              districts.push(districtItem)
            }
          }
        }
        
        // åˆ›å»ºCityItem
        const cityItem: CityItem = {
          name: city.name,
          province: province.name,
          distance: 0,  // é»˜è®¤å€¼ï¼Œåç»­é€šè¿‡å®šä½æ›´æ–°
          isFavorite: false,
          isTop: false,
          hasDistricts: hasDistricts,
          districts: hasDistricts ? districts : undefined,
          adcode: city.adcode,
          location: location
        }
        cities.push(cityItem)
      }
    }
    
    console.info(`[ChinaAreaDataLoader] åŠ è½½å®Œæˆï¼Œå…± ${cities.length} ä¸ªåŸå¸‚`)
    return cities
    
  } catch (error) {
    console.error(`[ChinaAreaDataLoader] åŠ è½½å¤±è´¥: ${JSON.stringify(error)}`)
    return []
  }
}

/**
 * æ ¹æ®åŸå¸‚åè·å–åŸå¸‚æ•°æ®ï¼ˆåŒ…å«åŒºå¿ï¼‰
 * æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼š"å¹¿å·" å’Œ "å¹¿å·å¸‚" éƒ½èƒ½åŒ¹é…
 */
export function getCityWithDistricts(cities: CityItem[], cityName: string): CityItem | null {
  // 1. ç²¾ç¡®åŒ¹é…
  for (const city of cities) {
    if (city.name === cityName) {
      return city
    }
  }
  
  // 2. æ¨¡ç³ŠåŒ¹é…ï¼ˆå»æ‰"å¸‚"åç¼€ï¼‰
  const normalizedSearchName = cityName.replace(/å¸‚$/, '')
  for (const city of cities) {
    const normalizedCityName = city.name.replace(/å¸‚$/, '')
    if (normalizedCityName === normalizedSearchName) {
      return city
    }
  }
  
  return null
}

/**
 * æ ¹æ®adcodeè·å–åŸå¸‚æ•°æ®
 */
export function getCityByAdcode(cities: CityItem[], adcode: string): CityItem | null {
  for (const city of cities) {
    if (city.adcode === adcode) {
      return city
    }
  }
  return null
}

/**
 * æœç´¢åŒºå¿
 */
export function searchDistricts(city: CityItem, keyword: string): DistrictItem[] {
  if (!city.districts || !keyword) {
    return city.districts || []
  }
  
  const lowerKeyword = keyword.toLowerCase().trim()
  const results: DistrictItem[] = []
  
  for (const district of city.districts) {
    if (district.name.includes(keyword) || district.adcode.includes(lowerKeyword)) {
      results.push(district)
    }
  }
  
  return results
}
