/**
 * ä»£ç†æé†’æœåŠ¡
 * ä½¿ç”¨ reminderAgentManager å®ç°åå°å®šæ—¶æé†’ï¼ˆåº”ç”¨å…³é—­åä»èƒ½è§¦å‘ï¼‰
 * 
 * æ­£ç¡®å¯¼å…¥æ–¹å¼ï¼šä» @kit.BackgroundTasksKit å¯¼å…¥
 * å‚è€ƒæ–‡æ¡£ï¼šhttps://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-reminderagentmanager
 * 
 * æƒé™è¦æ±‚ï¼šohos.permission.PUBLISH_AGENT_REMINDER
 */

import { reminderAgentManager } from '@kit.BackgroundTasksKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { hilog } from '@kit.PerformanceAnalysisKit';

const DOMAIN = 0x0001;
const TAG = 'ReminderService';

// æé†’IDå­˜å‚¨key
const REMINDER_ID_KEY = 'dailyReminderAgentId';

export class ReminderService {
  private static instance: ReminderService;
  private reminderId: number = -1;

  private constructor() {
    // ä» AppStorage æ¢å¤æé†’ID
    const savedId = AppStorage.get<number>(REMINDER_ID_KEY);
    if (savedId !== undefined && savedId !== -1) {
      this.reminderId = savedId;
      hilog.info(DOMAIN, TAG, `æ¢å¤å·²ä¿å­˜çš„æé†’ID: ${this.reminderId}`);
    }
  }

  static getInstance(): ReminderService {
    if (!ReminderService.instance) {
      ReminderService.instance = new ReminderService();
    }
    return ReminderService.instance;
  }

  /**
   * å–æ¶ˆæ‰€æœ‰æé†’ï¼ˆæ¸…ç†æ—§æ•°æ®ï¼‰
   */
  async cancelAllReminders(): Promise<void> {
    try {
      // ä½¿ç”¨ cancelAllReminders API ç›´æ¥å–æ¶ˆæ‰€æœ‰æé†’
      await reminderAgentManager.cancelAllReminders();
      
      this.reminderId = -1;
      AppStorage.delete(REMINDER_ID_KEY);
      hilog.info(DOMAIN, TAG, `âœ… å·²æ¸…ç†æ‰€æœ‰æ—§æé†’`);
    } catch (err) {
      const error = err as BusinessError;
      hilog.error(DOMAIN, TAG, `æ¸…ç†æ—§æé†’å¤±è´¥: ${error.code} - ${error.message}`);
    }
  }

  /**
   * è®¾ç½®æ¯æ—¥å®šæ—¶æé†’
   * @param timeStr æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ ¼å¼ "HH:mm"
   * @returns æ˜¯å¦è®¾ç½®æˆåŠŸ
   */
  async scheduleDailyReminder(timeStr: string): Promise<boolean> {
    try {
      hilog.info(DOMAIN, TAG, `è®¾ç½®æ¯æ—¥æé†’: ${timeStr}`);

      // è§£ææ—¶é—´
      const timeParts: string[] = timeStr.split(':');
      const hour = parseInt(timeParts[0]);
      const minute = parseInt(timeParts[1]);

      if (isNaN(hour) || isNaN(minute)) {
        hilog.error(DOMAIN, TAG, `æ— æ•ˆçš„æ—¶é—´æ ¼å¼: ${timeStr}`);
        return false;
      }

      // âš ï¸ å…ˆæ¸…ç†æ‰€æœ‰æ—§æé†’ï¼ˆè§£å†³æ•°é‡è¶…é™é—®é¢˜ï¼‰
      await this.cancelAllReminders();

      // åˆ›å»ºé—¹é’Ÿæé†’è¯·æ±‚ï¼ˆæ¯å¤©é‡å¤ï¼‰
      const reminderRequest: reminderAgentManager.ReminderRequestAlarm = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_ALARM,
        hour: hour,
        minute: minute,
        daysOfWeek: [1, 2, 3, 4, 5, 6, 7], // æ¯å¤©
        title: 'ğŸŒ¼ èŠ±ç²‰æµ“åº¦æ’­æŠ¥',
        content: 'ä»Šæ—¥èŠ±ç²‰æµ“åº¦ä¿¡æ¯å·²æ›´æ–°ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…',
        snoozeContent: 'ç¨åæé†’',
        ringDuration: 10  // å“é“ƒ10ç§’
      };

      // å‘å¸ƒæé†’
      this.reminderId = await reminderAgentManager.publishReminder(reminderRequest);
      
      // ä¿å­˜æé†’ID
      AppStorage.setOrCreate(REMINDER_ID_KEY, this.reminderId);
      
      hilog.info(DOMAIN, TAG, `âœ… æ¯æ—¥æé†’è®¾ç½®æˆåŠŸï¼ŒID: ${this.reminderId}`);
      return true;

    } catch (err) {
      const error = err as BusinessError;
      hilog.error(DOMAIN, TAG, `è®¾ç½®æé†’å¤±è´¥: ${error.code} - ${error.message}`);
      return false;
    }
  }

  /**
   * å–æ¶ˆæé†’
   */
  async cancelReminder(): Promise<void> {
    try {
      if (this.reminderId !== -1) {
        await reminderAgentManager.cancelReminder(this.reminderId);
        hilog.info(DOMAIN, TAG, `å·²å–æ¶ˆæé†’ï¼ŒID: ${this.reminderId}`);
        
        this.reminderId = -1;
        AppStorage.delete(REMINDER_ID_KEY);
      }
    } catch (err) {
      const error = err as BusinessError;
      hilog.error(DOMAIN, TAG, `å–æ¶ˆæé†’å¤±è´¥: ${error.code} - ${error.message}`);
    }
  }

  /**
   * è·å–æ‰€æœ‰æœ‰æ•ˆæé†’
   */
  async getValidReminders(): Promise<reminderAgentManager.ReminderRequest[]> {
    try {
      const reminders = await reminderAgentManager.getValidReminders();
      hilog.info(DOMAIN, TAG, `å½“å‰æœ‰æ•ˆæé†’æ•°é‡: ${reminders.length}`);
      return reminders;
    } catch (err) {
      const error = err as BusinessError;
      hilog.error(DOMAIN, TAG, `è·å–æé†’å¤±è´¥: ${error.code} - ${error.message}`);
      return [];
    }
  }
}

