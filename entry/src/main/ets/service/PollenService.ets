/**
 * èŠ±ç²‰ API æœåŠ¡
 * æ”¯æŒå¤šæœåŠ¡å™¨æ•…éšœè½¬ç§»ï¼Œæé«˜ç¨³å®šæ€§
 * æ”¯æŒç”¨æˆ·é€‰æ‹©æ•°æ®æºï¼ˆGoogle/CMA/QWeatherï¼‰
 */

import { http } from '@kit.NetworkKit'
import { PollenForecastResponse } from '../model/PollenModels'
import { PollenDataSourceType } from '../model/PollenDataSource'
import { MinshuDataSourceAdapter } from './MinshuDataSourceAdapter'
import { QweatherDataSourceAdapter } from './QweatherDataSourceAdapter'

/**
 * æœåŠ¡å™¨é…ç½®
 */
interface ServerConfig {
  name: string           // æœåŠ¡å™¨åç§°
  url: string            // API åœ°å€
  timeout: number        // è¶…æ—¶æ—¶é—´(ms)
  priority: number       // ä¼˜å…ˆçº§ (æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
}

/**
 * æœåŠ¡å™¨çŠ¶æ€
 */
interface ServerStatus {
  lastSuccess: number    // ä¸Šæ¬¡æˆåŠŸæ—¶é—´æˆ³
  failCount: number      // è¿ç»­å¤±è´¥æ¬¡æ•°
  isHealthy: boolean     // æ˜¯å¦å¥åº·
}

/**
 * æœåŠ¡å™¨åˆ—è¡¨é…ç½®
 * å¯ä»¥æ·»åŠ å¤šä¸ªæœåŠ¡å™¨ï¼Œå®ç°æ•…éšœè½¬ç§»
 */
const POLLEN_SERVERS: ServerConfig[] = [
  {
    name: 'AWS Lambda ä¸œäº¬',
    url: 'https://g7d8o7pf5b.execute-api.ap-northeast-1.amazonaws.com/default/pollen-api',
    timeout: 20000,
    priority: 1
  },
  {
    name: 'AWS Lambda æ–°åŠ å¡',
    url: 'https://8de0lncs7f.execute-api.ap-southeast-1.amazonaws.com/default/pollen-api-singapore',
    timeout: 20000,
    priority: 2
  },
  {
    name: 'é˜¿é‡Œäº‘æ–°åŠ å¡',
    url: 'http://47.84.1.164:5000/pollen-api',
    timeout: 15000,
    priority: 3
  },
]

// æœåŠ¡å™¨å¥åº·çŠ¶æ€ç¼“å­˜
const serverStatusMap: Map<string, ServerStatus> = new Map()

// å¥åº·æ£€æŸ¥é—´éš” (5åˆ†é’Ÿ)
const HEALTH_CHECK_INTERVAL = 5 * 60 * 1000

// æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆè¶…è¿‡åæ ‡è®°ä¸ºä¸å¥åº·ï¼‰
const MAX_FAIL_COUNT = 3

/**
 * èŠ±ç²‰æœåŠ¡ç±» - æ”¯æŒå¤šæœåŠ¡å™¨æ•…éšœè½¬ç§»
 */
export class PollenService {
  private static instance: PollenService | null = null

  private constructor() {
    // åˆå§‹åŒ–æœåŠ¡å™¨çŠ¶æ€
    this.initServerStatus()
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): PollenService {
    if (PollenService.instance === null) {
      PollenService.instance = new PollenService()
    }
    return PollenService.instance
  }

  /**
   * åˆå§‹åŒ–æœåŠ¡å™¨çŠ¶æ€
   */
  private initServerStatus(): void {
    for (const server of POLLEN_SERVERS) {
      if (!serverStatusMap.has(server.url)) {
        serverStatusMap.set(server.url, {
          lastSuccess: 0,
          failCount: 0,
          isHealthy: true
        })
      }
    }
  }

  /**
   * è·å–æ’åºåçš„æœåŠ¡å™¨åˆ—è¡¨
   * ä¼˜å…ˆçº§: å¥åº· > æœ€è¿‘æˆåŠŸ > é…ç½®ä¼˜å…ˆçº§
   */
  private getSortedServers(): ServerConfig[] {
    const now = Date.now()

    return POLLEN_SERVERS.slice().sort((a, b) => {
      const statusA = serverStatusMap.get(a.url)
      const statusB = serverStatusMap.get(b.url)

      if (!statusA || !statusB) return a.priority - b.priority

      // å¥åº·çš„ä¼˜å…ˆ
      if (statusA.isHealthy !== statusB.isHealthy) {
        return statusA.isHealthy ? -1 : 1
      }

      // æœ€è¿‘æˆåŠŸçš„ä¼˜å…ˆ
      if (statusA.lastSuccess !== statusB.lastSuccess) {
        return statusB.lastSuccess - statusA.lastSuccess
      }

      // æŒ‰é…ç½®ä¼˜å…ˆçº§
      return a.priority - b.priority
    })
  }

  /**
   * æ›´æ–°æœåŠ¡å™¨çŠ¶æ€ - æˆåŠŸ
   */
  private markServerSuccess(serverUrl: string): void {
    const status = serverStatusMap.get(serverUrl)
    if (status) {
      status.lastSuccess = Date.now()
      status.failCount = 0
      status.isHealthy = true
      console.info(`[PollenService] æœåŠ¡å™¨æˆåŠŸ: ${serverUrl}`)
    }
  }

  /**
   * æ›´æ–°æœåŠ¡å™¨çŠ¶æ€ - å¤±è´¥
   */
  private markServerFail(serverUrl: string): void {
    const status = serverStatusMap.get(serverUrl)
    if (status) {
      status.failCount++
      if (status.failCount >= MAX_FAIL_COUNT) {
        status.isHealthy = false
        console.warn(`[PollenService] æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¥åº·: ${serverUrl}, è¿ç»­å¤±è´¥ ${status.failCount} æ¬¡`)
      }
    }
  }

  /**
   * æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åº”è¯¥é‡è¯•ï¼ˆä¸å¥åº·çš„æœåŠ¡å™¨è¶…è¿‡ä¸€å®šæ—¶é—´åé‡è¯•ï¼‰
   */
  private shouldRetryServer(serverUrl: string): boolean {
    const status = serverStatusMap.get(serverUrl)
    if (!status) return true

    if (status.isHealthy) return true

    // ä¸å¥åº·çš„æœåŠ¡å™¨ï¼Œè¶…è¿‡ HEALTH_CHECK_INTERVAL åé‡è¯•
    const timeSinceLastSuccess = Date.now() - status.lastSuccess
    return timeSinceLastSuccess > HEALTH_CHECK_INTERVAL
  }

  /**
   * å‘å•ä¸ªæœåŠ¡å™¨å‘é€è¯·æ±‚
   */
  private async requestFromServer(
    server: ServerConfig,
    latitude: number,
    longitude: number,
    days: number
  ): Promise<PollenForecastResponse | null> {
    const url = `${server.url}?lat=${latitude}&lng=${longitude}&days=${days}`
    console.info(`[PollenService] ğŸš€ å‡†å¤‡å‘æœåŠ¡å™¨ [${server.name}] å‘èµ·è¯·æ±‚: ${url}`)

    const httpRequest = http.createHttp()
    const startTime = Date.now()

    try {
      console.info(`[PollenService] [${server.name}] æ­£åœ¨æ‰§è¡Œå¼‚æ­¥è¯·æ±‚...`)
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        connectTimeout: server.timeout,
        readTimeout: server.timeout
      })

      const duration = Date.now() - startTime
      console.info(`[PollenService] [${server.name}] è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${duration}ms, å“åº”ç : ${response.responseCode}`)

      if (response.responseCode === 200) {
        const resultStr = typeof response.result === 'string' ? response.result : JSON.stringify(response.result)
        console.info(`[PollenService] [${server.name}] åŸå§‹å“åº”é¢„è§ˆ: ${resultStr.substring(0, 300)}${resultStr.length > 300 ? '...' : ''}`)
        
        try {
          const result: PollenForecastResponse = JSON.parse(resultStr)
          console.info(`[PollenService] [${server.name}] æ•°æ®è§£ææˆåŠŸ: ${result.regionCode || 'æœªçŸ¥åŒºåŸŸ'}`)
          httpRequest.destroy()
          this.markServerSuccess(server.url)
          return result
        } catch (e) {
          console.error(`[PollenService] [${server.name}] JSON è§£æå¤±è´¥: ${e.message}, å“åº”é•¿åº¦: ${resultStr.length}`)
          httpRequest.destroy()
          this.markServerFail(server.url)
          return null
        }
      } else {
        console.error(`[PollenService] [${server.name}] æœåŠ¡å™¨è¿”å›é”™è¯¯ç : ${response.responseCode}`)
        httpRequest.destroy()
        this.markServerFail(server.url)
        return null
      }
    } catch (error) {
      const duration = Date.now() - startTime
      console.error(`[PollenService] [${server.name}] âŒ è¯·æ±‚å‘ç”Ÿå¼‚å¸¸ (è€—æ—¶ ${duration}ms): ${JSON.stringify(error)}`)
      httpRequest.destroy()
      this.markServerFail(server.url)
      return null
    }
  }

  /**
   * è·å–èŠ±ç²‰é¢„æŠ¥æ•°æ® - æ”¯æŒç”¨æˆ·é€‰æ‹©æ•°æ®æº
   * @param latitude çº¬åº¦
   * @param longitude ç»åº¦
   * @param days é¢„æŠ¥å¤©æ•° (1-5)
   */
  async getPollenForecast(
    latitude: number,
    longitude: number,
    days: number = 5
  ): Promise<PollenForecastResponse | null> {
    // è·å–ç”¨æˆ·é€‰æ‹©çš„æ•°æ®æºï¼ˆé»˜è®¤ AUTOï¼‰
    const selectedDataSource: string = AppStorage.get('pollenDataSource') as string || 'AUTO'
    const dataSourceType = selectedDataSource as PollenDataSourceType

    console.info(`[PollenService] ç”¨æˆ·é€‰æ‹©çš„æ•°æ®æº: ${dataSourceType}`)

    // æ ¹æ®ç”¨æˆ·é€‰æ‹©è°ƒç”¨å¯¹åº”çš„æ•°æ®æº
    switch (dataSourceType) {
      case PollenDataSourceType.AUTO:
        // è‡ªåŠ¨é€‰æ‹©ï¼šå›½å†…åŸå¸‚ä¼˜å…ˆä½¿ç”¨æ•èˆ’ï¼Œå¤±è´¥åé™çº§åˆ° Google
        const currentCity: string | undefined = AppStorage.get('currentCity') as string | undefined
        if (currentCity && this.isChineseCity(currentCity)) {
          console.info('[PollenService] AUTO æ¨¡å¼ï¼šæ£€æµ‹åˆ°å›½å†…åŸå¸‚ï¼Œå°è¯•æ•èˆ’æ•°æ®æº')
          const minshuResult = await this.getPollenForecastFromMinshu(latitude, longitude, days, currentCity)
          if (minshuResult) {
            return minshuResult
          }
          // æ•èˆ’å¤±è´¥ï¼Œé™çº§åˆ° Google
          console.warn('[PollenService] AUTO æ¨¡å¼ï¼šæ•èˆ’æ•°æ®æºå¤±è´¥ï¼Œé™çº§åˆ° Google Pollen API')
          return await this.getPollenForecastFromGoogle(latitude, longitude, days)
        } else {
          console.info('[PollenService] AUTO æ¨¡å¼ï¼šä½¿ç”¨ Google Pollen API')
          return await this.getPollenForecastFromGoogle(latitude, longitude, days)
        }
      
      case PollenDataSourceType.GOOGLE:
        // ä½¿ç”¨ç°æœ‰çš„å¤šæœåŠ¡å™¨æ•…éšœè½¬ç§»é€»è¾‘ï¼ˆGoogle Pollen APIï¼‰
        return await this.getPollenForecastFromGoogle(latitude, longitude, days)
      
      case PollenDataSourceType.MINSHU:
        // æ•èˆ’åŸå¸‚è¿‡æ•é¢„æŠ¥ï¼ˆå›½å†…æƒå¨ï¼‰
        const cityName: string | undefined = AppStorage.get('currentCity') as string | undefined
        if (!cityName) {
          console.warn('[PollenService] æ•èˆ’æ•°æ®æºéœ€è¦åŸå¸‚åç§°')
          return null
        }
        return await this.getPollenForecastFromMinshu(latitude, longitude, days, cityName)
      
      case PollenDataSourceType.CMA:
        // ä¸­å›½æ°”è±¡å±€ï¼ˆå¾…å®ç°ï¼‰
        console.warn('[PollenService] ä¸­å›½æ°”è±¡å±€æ•°æ®æºæš‚æœªå®ç°')
        return null
      
      case PollenDataSourceType.QWEATHER:
        // å’Œé£å¤©æ°”ï¼ˆå·²å®ç°ï¼‰
        return await this.getPollenForecastFromQweather(latitude, longitude, days)
      
      default:
        console.error(`[PollenService] æœªçŸ¥çš„æ•°æ®æºç±»å‹: ${dataSourceType}`)
        // é™çº§åˆ° Google
        return await this.getPollenForecastFromGoogle(latitude, longitude, days)
    }
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºå›½å†…åŸå¸‚ï¼ˆç®€å•åˆ¤æ–­ï¼Œé€šè¿‡åŸå¸‚åæ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼‰
   */
  private isChineseCity(cityName: string): boolean {
    return /[\u4e00-\u9fa5]/.test(cityName)
  }

  /**
   * ä»æ•èˆ’ API è·å–æ•°æ®
   * @param latitude çº¬åº¦
   * @param longitude ç»åº¦
   * @param days é¢„æŠ¥å¤©æ•°
   * @param cityName åŸå¸‚åç§°ï¼ˆç”¨äºè·å– adcodeï¼‰
   */
  private async getPollenForecastFromMinshu(
    latitude: number,
    longitude: number,
    days: number,
    cityName: string
  ): Promise<PollenForecastResponse | null> {
    try {
      const adapter = new MinshuDataSourceAdapter()
      if (!adapter.isAvailable()) {
        console.warn('[PollenService] æ•èˆ’æ•°æ®æºä¸å¯ç”¨')
        return null
      }
      
      console.info(`[PollenService] å¼€å§‹è¯·æ±‚æ•èˆ’ APIï¼ŒåŸå¸‚: ${cityName}`)
      const result = await adapter.fetchPollenDataWithCity(latitude, longitude, days, cityName)
      
      if (result) {
        console.info(`[PollenService] æ•èˆ’ API è·å–æˆåŠŸ: ${result.regionCode}`)
      } else {
        console.warn('[PollenService] æ•èˆ’ API è·å–å¤±è´¥')
      }
      
      return result
    } catch (error) {
      console.error(`[PollenService] æ•èˆ’ API è¯·æ±‚å¼‚å¸¸: ${JSON.stringify(error)}`)
      return null
    }
  }

  /**
   * ä»å’Œé£å¤©æ°” API è·å–æ•°æ®
   * @param latitude çº¬åº¦
   * @param longitude ç»åº¦
   * @param days é¢„æŠ¥å¤©æ•°
   */
  private async getPollenForecastFromQweather(
    latitude: number,
    longitude: number,
    days: number
  ): Promise<PollenForecastResponse | null> {
    try {
      const adapter = new QweatherDataSourceAdapter()
      if (!adapter.isAvailable()) {
        console.warn('[PollenService] å’Œé£å¤©æ°”æ•°æ®æºä¸å¯ç”¨')
        return null
      }
      
      console.info('[PollenService] å¼€å§‹è¯·æ±‚å’Œé£å¤©æ°” API')
      const result = await adapter.fetchPollenData(latitude, longitude, days)
      
      if (result) {
        console.info(`[PollenService] å’Œé£å¤©æ°” API è·å–æˆåŠŸ: ${result.regionCode}`)
      } else {
        console.warn('[PollenService] å’Œé£å¤©æ°” API è·å–å¤±è´¥')
      }
      
      return result
    } catch (error) {
      console.error(`[PollenService] å’Œé£å¤©æ°” API è¯·æ±‚å¼‚å¸¸: ${JSON.stringify(error)}`)
      return null
    }
  }

  /**
   * ä» Google Pollen API è·å–æ•°æ®ï¼ˆå¤šæœåŠ¡å™¨æ•…éšœè½¬ç§»ï¼‰
   * @param latitude çº¬åº¦
   * @param longitude ç»åº¦
   * @param days é¢„æŠ¥å¤©æ•°
   */
  private async getPollenForecastFromGoogle(
    latitude: number,
    longitude: number,
    days: number
  ): Promise<PollenForecastResponse | null> {
    const servers = this.getSortedServers()

    console.info(`[PollenService] å¼€å§‹è¯·æ±‚ Google Pollen APIï¼Œå¯ç”¨æœåŠ¡å™¨: ${servers.length}`)

    for (const server of servers) {
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥å°è¯•è¿™ä¸ªæœåŠ¡å™¨
      if (!this.shouldRetryServer(server.url)) {
        console.info(`[PollenService] è·³è¿‡ä¸å¥åº·æœåŠ¡å™¨: ${server.name}`)
        continue
      }

      const result = await this.requestFromServer(server, latitude, longitude, days)
      if (result !== null) {
        return result
      }

      console.warn(`[PollenService] [${server.name}] å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡å™¨...`)
    }

    console.error('[PollenService] æ‰€æœ‰ Google Pollen API æœåŠ¡å™¨å‡è¯·æ±‚å¤±è´¥')
    return null
  }

  /**
   * è·å–æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
   */
  getServerStatus(): string {
    const statusList: string[] = []
    for (const server of POLLEN_SERVERS) {
      const status = serverStatusMap.get(server.url)
      if (status) {
        statusList.push(
          `${server.name}: ${status.isHealthy ? 'âœ…å¥åº·' : 'âŒä¸å¥åº·'} (å¤±è´¥${status.failCount}æ¬¡)`
        )
      }
    }
    return statusList.join(', ')
  }

  /**
   * é‡ç½®æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ï¼ˆæ‰‹åŠ¨æ¢å¤ï¼‰
   */
  resetServerStatus(): void {
    for (const server of POLLEN_SERVERS) {
      serverStatusMap.set(server.url, {
        lastSuccess: 0,
        failCount: 0,
        isHealthy: true
      })
    }
    console.info('[PollenService] æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€å·²é‡ç½®')
  }
}
