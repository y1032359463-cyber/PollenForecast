/**
 * å’Œé£å¤©æ°”ï¼ˆQweatherï¼‰èŠ±ç²‰æ•°æ®æºé€‚é…å™¨
 * å°†å’Œé£å¤©æ°” Indices API æ•°æ®æ ¼å¼è½¬æ¢ä¸ºåº”ç”¨å†…éƒ¨æ•°æ®æ ¼å¼
 */

import { http } from '@kit.NetworkKit'
import { IPollenDataSourceAdapter } from './PollenDataSourceAdapter'
import { PollenForecastResponse, DailyInfo, PollenTypeInfo, IndexInfo, DateInfo } from '../model/PollenModels'

/**
 * å’Œé£å¤©æ°”ä»£ç†æœåŠ¡å™¨åœ°å€
 */
const QWEATHER_PROXY_BASE = 'http://106.12.143.105:3000'

/**
 * å’Œé£å¤©æ°” Indices API å“åº”æ ¼å¼ï¼ˆåŸå§‹ï¼‰
 */
interface QweatherApiResponse {
  code: string           // API çŠ¶æ€ç ï¼š"200" è¡¨ç¤ºæˆåŠŸ
  updateTime: string     // æ•°æ®æ›´æ–°æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
  fxLink: string         // å’Œé£å¤©æ°”æ•°æ®é¡µé¢é“¾æ¥
  daily: QweatherDailyIndex[]  // æ¯æ—¥æŒ‡æ•°æ•°æ®æ•°ç»„
}

interface QweatherDailyIndex {
  date: string           // æ—¥æœŸï¼Œæ ¼å¼ "2026-01-16"
  type: string           // æŒ‡æ•°ç±»å‹æ ‡è¯†ï¼š"1" = èŠ±ç²‰è¿‡æ•æŒ‡æ•°
  name: string           // æŒ‡æ•°åç§°ï¼š"èŠ±ç²‰è¿‡æ•æŒ‡æ•°"
  level: string          // ç­‰çº§æ ‡è¯†ï¼š"1"/"2"/"3"/"4"/"5"
  category: string       // ç±»åˆ«æ–‡å­—æè¿°ï¼š"æä¸æ˜“å‘"/"ä¸æ˜“å‘"/"è¾ƒæ˜“å‘"/"æ˜“å‘"/"ææ˜“å‘"
  text: string           // è¯¦ç»†è¯´æ˜æ–‡å­—ï¼ŒåŒ…å«å¥åº·å»ºè®®ç­‰ä¿¡æ¯
}

/**
 * å’Œé£å¤©æ°”æ•°æ®æºé€‚é…å™¨å®ç°
 */
export class QweatherDataSourceAdapter implements IPollenDataSourceAdapter {
  name: string = 'å’Œé£å¤©æ°”'
  
  /**
   * æ£€æŸ¥æ•°æ®æºæ˜¯å¦å¯ç”¨
   * @returns true è¡¨ç¤ºå¯ç”¨ï¼Œfalse è¡¨ç¤ºä¸å¯ç”¨
   */
  isAvailable(): boolean {
    return true  // æœåŠ¡å™¨ä»£ç†å·²éƒ¨ç½²ï¼Œé»˜è®¤å¯ç”¨
  }

  /**
   * å°†å’Œé£çš„ categoryï¼ˆä¸­æ–‡ï¼‰è½¬æ¢ä¸º Google API çš„ categoryï¼ˆè‹±æ–‡ï¼‰
   * @param category å’Œé£å¤©æ°”çš„ä¸­æ–‡ç±»åˆ«ï¼šæä¸æ˜“å‘/ä¸æ˜“å‘/è¾ƒæ˜“å‘/æ˜“å‘/ææ˜“å‘
   * @returns Google API çš„è‹±æ–‡ç±»åˆ«ï¼šNone/Low/Moderate/High/Very High
   */
  protected convertCategoryToEnglish(category: string): string {
    const categoryMap: Map<string, string> = new Map([
      ['æä¸æ˜“å‘', 'None'],
      ['ä¸æ˜“å‘', 'Low'],
      ['è¾ƒæ˜“å‘', 'Moderate'],
      ['æ˜“å‘', 'High'],
      ['ææ˜“å‘', 'Very High']
    ])
    return categoryMap.get(category) || 'None'
  }

  /**
   * å°†å’Œé£çš„ level è½¬æ¢ä¸ºæ•°å€¼ï¼ˆ0-100ï¼‰
   * ç”¨äºç»Ÿä¸€ä¸åŒæ•°æ®æºçš„æŒ‡æ•°å€¼èŒƒå›´
   * @param level å’Œé£å¤©æ°”çš„ç­‰çº§æ ‡è¯†ï¼š"1"/"2"/"3"/"4"/"5"
   * @returns æ ‡å‡†åŒ–çš„æŒ‡æ•°å€¼ï¼š0/25/50/75/100
   */
  protected convertLevelToValue(level: string): number {
    const levelMap: Map<string, number> = new Map([
      ['1', 0],      // æä¸æ˜“å‘
      ['2', 25],     // ä¸æ˜“å‘
      ['3', 50],     // è¾ƒæ˜“å‘
      ['4', 75],     // æ˜“å‘
      ['5', 100]     // ææ˜“å‘
    ])
    return levelMap.get(level) || 0
  }

  /**
   * è½¬æ¢å’Œé£çš„æ—¥æŒ‡æ•°ä¸ºåº”ç”¨å†…éƒ¨æ ¼å¼
   * å°† QweatherDailyIndex è½¬æ¢ä¸º DailyInfoï¼ŒåŒ…æ‹¬æ—¥æœŸè§£æã€æŒ‡æ•°è½¬æ¢å’Œå¥åº·å»ºè®®æå–
   * @param qweatherDaily å’Œé£å¤©æ°”çš„æ—¥æŒ‡æ•°æ•°æ®
   * @returns åº”ç”¨å†…éƒ¨çš„æ¯æ—¥ä¿¡æ¯æ ¼å¼ï¼ˆDailyInfoï¼‰
   */
  protected convertDailyInfo(qweatherDaily: QweatherDailyIndex): DailyInfo {
    // è§£ææ—¥æœŸ
    const dateParts = qweatherDaily.date.split('-')
    const dateInfo: DateInfo = {
      year: parseInt(dateParts[0]),
      month: parseInt(dateParts[1]),
      day: parseInt(dateParts[2])
    }

    // è½¬æ¢èŠ±ç²‰æŒ‡æ•°ä¿¡æ¯
    const indexInfo: IndexInfo = {
      code: 'POLLEN_TOTAL',
      displayName: 'ç»¼åˆèŠ±ç²‰',
      value: this.convertLevelToValue(qweatherDaily.level),
      category: this.convertCategoryToEnglish(qweatherDaily.category),
      indexDescription: qweatherDaily.text,
      categoryOriginal: qweatherDaily.category  // ä¿ç•™åŸå§‹ä¸­æ–‡æ–‡æœ¬ï¼ˆå¦‚"ææ˜“å‘"ã€"æ˜“å‘"ç­‰ï¼‰
    }

    // æ„é€ èŠ±ç²‰ç±»å‹ä¿¡æ¯ï¼ˆå’Œé£åªæä¾›ç»¼åˆæŒ‡æ•°ï¼Œä¸ç»†åˆ†æ ‘/è‰/æ‚è‰ï¼‰
    const pollenTypeInfo: PollenTypeInfo = {
      code: 'TOTAL',
      displayName: 'ç»¼åˆèŠ±ç²‰',
      inSeason: this.convertLevelToValue(qweatherDaily.level) > 0,
      indexInfo: indexInfo,
      healthRecommendations: this.extractRecommendations(qweatherDaily.text)
    }

    const result: DailyInfo = {
      date: dateInfo,
      pollenTypeInfo: [pollenTypeInfo],
      plantInfo: []  // å’Œé£ä¸æä¾›å…·ä½“æ¤ç‰©ä¿¡æ¯
    }
    return result
  }

  /**
   * ä»æ–‡å­—è¯´æ˜ä¸­æå–å¥åº·å»ºè®®
   * æ ¹æ®å’Œé£å¤©æ°”çš„æ–‡å­—æè¿°ç”Ÿæˆå¯¹åº”çš„å¥åº·å»ºè®®åˆ—è¡¨
   * @param text å’Œé£å¤©æ°”çš„è¯¦ç»†è¯´æ˜æ–‡å­—
   * @returns å¥åº·å»ºè®®å­—ç¬¦ä¸²æ•°ç»„
   */
  protected extractRecommendations(text: string): string[] {
    const recommendations: string[] = []
    
    if (text.includes('æä¸æ˜“å‘') || text.includes('ä¸æ˜“å‘')) {
      recommendations.push('ä»Šæ—¥èŠ±ç²‰æµ“åº¦è¾ƒä½ï¼Œå¯æ”¾å¿ƒå¤–å‡º')
    } else if (text.includes('è¾ƒæ˜“å‘')) {
      recommendations.push('å»ºè®®æ˜“æ•äººç¾¤å‡å°‘å¤–å‡ºæ—¶é—´')
      recommendations.push('å¤–å‡ºæ—¶å¯ä½©æˆ´å£ç½©')
    } else if (text.includes('æ˜“å‘') || text.includes('ææ˜“å‘')) {
      recommendations.push('èŠ±ç²‰æµ“åº¦è¾ƒé«˜ï¼Œæ˜“æ•äººç¾¤åº”é¿å…å¤–å‡º')
      recommendations.push('å…³é—­é—¨çª—ï¼Œå‡å°‘å®¤å†…èŠ±ç²‰')
      recommendations.push('å¿…è¦æ—¶è¯·éµåŒ»å˜±æœç”¨æŠ—è¿‡æ•è¯ç‰©')
    }
    
    return recommendations
  }

  /**
   * è·å–èŠ±ç²‰é¢„æŠ¥æ•°æ®ï¼ˆå®ç°æ¥å£æ–¹æ³•ï¼‰
   * é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨å’Œé£å¤©æ°” Indices APIï¼Œè·å–æŒ‡å®šä½ç½®çš„èŠ±ç²‰è¿‡æ•æŒ‡æ•°
   * @param lat çº¬åº¦
   * @param lng ç»åº¦
   * @param days é¢„æŠ¥å¤©æ•°ï¼ˆå’Œé£æ”¯æŒæœªæ¥7å¤©ï¼‰
   * @returns è½¬æ¢åçš„èŠ±ç²‰é¢„æŠ¥æ•°æ®ï¼Œå¤±è´¥è¿”å› null
   */
  async fetchPollenData(
    lat: number,
    lng: number,
    days: number
  ): Promise<PollenForecastResponse | null> {
    try {
      // æ„é€ è¯·æ±‚ URLï¼ˆç»çº¬åº¦æ ¼å¼ï¼šlng,latï¼‰
      const location = `${lng},${lat}`
      // type=10 è¡¨ç¤ºèŠ±ç²‰è¿‡æ•æŒ‡æ•°
      const url = `${QWEATHER_PROXY_BASE}/weather/indices?location=${location}&type=10&days=${days}`
      
      console.info(`[QweatherAdapter] ğŸš€ å‡†å¤‡è¯·æ±‚å’Œé£æ•°æ®: ${url}`)

      // å‘èµ· HTTP è¯·æ±‚
      const request = http.createHttp()
      const startTime = Date.now()

      const response = await request.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: 10000,
        readTimeout: 10000
      })

      const duration = Date.now() - startTime
      console.info(`[QweatherAdapter] è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${duration}ms, å“åº”ç : ${response.responseCode}`)

      // æ£€æŸ¥ HTTP çŠ¶æ€ç 
      if (response.responseCode !== 200) {
        console.error(`[QweatherAdapter] HTTP é”™è¯¯: ${response.responseCode}`)
        request.destroy()
        return null
      }

      // è§£æå“åº”æ•°æ®
      const resultStr = typeof response.result === 'string' ? response.result : JSON.stringify(response.result)
      console.info(`[QweatherAdapter] åŸå§‹å“åº”é¢„è§ˆ: ${resultStr.substring(0, 300)}`)

      const apiResponse = JSON.parse(resultStr) as QweatherApiResponse
      request.destroy()

      // æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€ç 
      if (apiResponse.code !== '200') {
        console.error('[QweatherAdapter] API é”™è¯¯:', apiResponse.code)
        return null
      }

      // è½¬æ¢æ•°æ®æ ¼å¼
      const dailyInfoArray: DailyInfo[] = []
      for (let i = 0; i < apiResponse.daily.length; i++) {
        dailyInfoArray.push(this.convertDailyInfo(apiResponse.daily[i]))
      }

      const result: PollenForecastResponse = {
        dailyInfo: dailyInfoArray,
        regionCode: `${lat},${lng}`
      }

      console.info('[QweatherAdapter] æˆåŠŸè·å–å’Œé£èŠ±ç²‰æ•°æ®:', dailyInfoArray.length, 'å¤©')
      return result

    } catch (error) {
      console.error('[QweatherAdapter] è¯·æ±‚å¤±è´¥:', JSON.stringify(error))
      return null
    }
  }
}
