import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window, display } from '@kit.ArkUI';
import { LocationService } from '../service/LocationService';
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit';
import { NotificationService } from '../utils/NotificationService';

const DOMAIN = 0x0000;

export default class EntryAbility extends UIAbility {
  private mainWindowInstance?: window.Window;

  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    console.info('ğŸŸ¡ [EntryAbility] onCreate è°ƒç”¨');
    
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }

    // åˆå§‹åŒ–å…±äº«æ•°æ®
    AppStorage.setOrCreate('currentCity', 'å®šä½ä¸­...');
    AppStorage.setOrCreate('pollenValue', 0);
    AppStorage.setOrCreate('pollenLevel', 'åŠ è½½ä¸­...');
    AppStorage.setOrCreate('updateTime', 'è·å–ä¸­...');
    AppStorage.setOrCreate('latitude', 23.1291);
    AppStorage.setOrCreate('longitude', 113.2644);
    
    // åˆå§‹åŒ–èŠ±ç²‰ä¸»é¢˜è‰²ï¼ˆé»˜è®¤ç»¿è‰² - æä½ç­‰çº§ï¼‰
    AppStorage.setOrCreate('pollenThemeColor', '#4CAF50');

    // åˆå§‹åŒ–ä¸»é¢˜çŠ¶æ€ï¼ˆè®© MapView èƒ½å“åº”ä¸»é¢˜åˆ‡æ¢ï¼‰
    AppStorage.setOrCreate('currentColorMode', this.context.config.colorMode);

    // åˆå§‹åŒ–åº”ç”¨å‰åå°çŠ¶æ€
    AppStorage.setOrCreate('isAppInBackground', false);

    // åˆå§‹åŒ–é€šçŸ¥è®¾ç½®ï¼ˆé»˜è®¤å…³é—­ï¼‰
    AppStorage.setOrCreate('notificationEnabled', false);
    AppStorage.setOrCreate('pollenAlertEnabled', true);
    AppStorage.setOrCreate('dailyReportEnabled', true);
    AppStorage.setOrCreate('dailyReportTime', '08:00');

    // åˆå§‹åŒ–æ•°æ®æºé€‰æ‹©ï¼ˆé»˜è®¤è‡ªåŠ¨é€‰æ‹©ï¼‰
    AppStorage.setOrCreate('pollenDataSource', 'AUTO');

    // è®¾ç½® LocationService çš„ context
    LocationService.getInstance().setContext(this.context);

    // è®¾ç½® NotificationService çš„ contextï¼ˆç”¨äº WorkSchedulerï¼‰
    NotificationService.getInstance().setContext(this.context);

    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');
  }

  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');
  }

  onWindowStageCreate(windowStage: window.WindowStage): void {
    // Main window is created, set main page for this ability
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');
    console.info('ğŸ”µ [EntryAbility] onWindowStageCreate è°ƒç”¨');

    // åœ¨çª—å£åˆ›å»ºé˜¶æ®µè¯·æ±‚æƒé™ï¼ˆä¿®æ­£ç”Ÿå‘½å‘¨æœŸï¼‰
    console.info('ğŸ”µ [EntryAbility] å‡†å¤‡è¯·æ±‚å®šä½æƒé™');
    this.requestLocationPermissions();
    
    // è¯·æ±‚ä»£ç†æé†’æƒé™ï¼ˆç”¨äºå®šæ—¶é€šçŸ¥ï¼‰
    console.info('ğŸ”µ [EntryAbility] å‡†å¤‡è¯·æ±‚ä»£ç†æé†’æƒé™');
    this.requestReminderPermission();

    // è·å–ä¸»çª—å£å¹¶è®¾ç½®æ²‰æµ¸å¼çŠ¶æ€æ 
    const mainWindow = windowStage.getMainWindowSync();
    this.mainWindowInstance = mainWindow;

    // 1. è®¾ç½®å…¨å±å¸ƒå±€ï¼ˆå†…å®¹å»¶ä¼¸åˆ°çŠ¶æ€æ ä¸‹æ–¹ï¼‰
    try {
      mainWindow.setWindowLayoutFullScreen(true);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'è®¾ç½®å…¨å±å¤±è´¥: %{public}s', JSON.stringify(err));
    }

    // 2. æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®çŠ¶æ€æ 
    try {
      this.updateStatusBarForTheme(mainWindow);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'æ›´æ–°çŠ¶æ€æ å¤±è´¥: %{public}s', JSON.stringify(err));
    }

    // 3. åŠ¨æ€è·å–å®‰å…¨åŒºåŸŸé«˜åº¦å¹¶å­˜å‚¨åˆ° AppStorage
    try {
      // è·å–çŠ¶æ€æ é«˜åº¦ï¼ˆTYPE_SYSTEMï¼‰
      const topArea = mainWindow.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);
      const statusBarHeight = topArea.topRect.height;
      
      // è·å–å¯¼èˆªæ é«˜åº¦ï¼ˆTYPE_NAVIGATION_INDICATORï¼‰
      const bottomArea = mainWindow.getWindowAvoidArea(window.AvoidAreaType.TYPE_NAVIGATION_INDICATOR);
      const navBarHeight = bottomArea.bottomRect.height;
      
      let density = 3; // é»˜è®¤å±å¹•å¯†åº¦
      try {
        density = display.getDefaultDisplaySync().densityPixels;
      } catch (displayErr) {
        hilog.error(DOMAIN, 'testTag', 'è·å–å±å¹•å¯†åº¦å¤±è´¥: %{public}s', JSON.stringify(displayErr));
      }
      
      const safeTop = statusBarHeight / density;
      const safeBottom = navBarHeight / density;

      AppStorage.setOrCreate('safeTop', safeTop);
      AppStorage.setOrCreate('safeBottom', safeBottom);
      hilog.info(DOMAIN, 'testTag', `SafeArea - top: ${safeTop}vp, bottom: ${safeBottom}vp`);
    } catch (err) {
      // è·å–å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
      AppStorage.setOrCreate('safeTop', 44);
      AppStorage.setOrCreate('safeBottom', 28);
      hilog.error(DOMAIN, 'testTag', 'Failed to get avoidArea: %{public}s', JSON.stringify(err));
    }

    windowStage.loadContent('pages/Index', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the content.');
    });
  }

  /**
   * æ ¹æ®ä¸»é¢˜æ›´æ–°çŠ¶æ€æ æ ·å¼
   */
  private updateStatusBarForTheme(mainWindow: window.Window, colorMode?: number): void {
    try {
      // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ colorModeï¼Œå¦åˆ™ä» context è¯»å–
      const currentColorMode = colorMode ?? this.context.config.colorMode;
      
      let systemBarProperties: window.SystemBarProperties;
      
      // åˆ¤æ–­å½“å‰æ˜¯æ·±è‰²è¿˜æ˜¯æµ…è‰²æ¨¡å¼
      if (currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK) {
        // æ·±è‰²æ¨¡å¼ï¼šå®Œå…¨é€æ˜çŠ¶æ€æ  + ç™½è‰²å›¾æ ‡
        systemBarProperties = {
          statusBarColor: '#00000000',        // å®Œå…¨é€æ˜
          statusBarContentColor: '#FFFFFF',   // ç™½è‰²æ–‡å­—/å›¾æ ‡
          isStatusBarLightIcon: true          // äº®è‰²å›¾æ ‡
        };
        hilog.info(DOMAIN, 'testTag', 'çŠ¶æ€æ è®¾ç½®ï¼šæ·±è‰²æ¨¡å¼ï¼ˆé€æ˜èƒŒæ™¯+ç™½è‰²å›¾æ ‡ï¼‰');
      } else {
        // æµ…è‰²æ¨¡å¼ï¼šå®Œå…¨é€æ˜çŠ¶æ€æ  + æ·±è‰²å›¾æ ‡ï¼ˆé€‚é…æµ…è‰²å¯¼èˆªæ ï¼‰
        systemBarProperties = {
          statusBarColor: '#00000000',        // å®Œå…¨é€æ˜
          statusBarContentColor: '#000000',   // çº¯é»‘æ–‡å­—/å›¾æ ‡
          isStatusBarLightIcon: false         // æ·±è‰²å›¾æ ‡
        };
        hilog.info(DOMAIN, 'testTag', 'çŠ¶æ€æ è®¾ç½®ï¼šæµ…è‰²æ¨¡å¼ï¼ˆé€æ˜èƒŒæ™¯+æ·±è‰²å›¾æ ‡ï¼‰');
      }
      
      mainWindow.setWindowSystemBarProperties(systemBarProperties);
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', 'è®¾ç½®çŠ¶æ€æ å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability has come to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
    
    // é€šçŸ¥æ‰€æœ‰ç»„ä»¶åº”ç”¨å·²å›åˆ°å‰å°
    AppStorage.setOrCreate('isAppInBackground', false);
    console.info('ğŸŸ¢ [EntryAbility] åº”ç”¨å›åˆ°å‰å°ï¼Œå…è®¸ä¼ æ„Ÿå™¨æ¢å¤');

    // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€æ¯æ—¥æ’­æŠ¥ï¼ˆåº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ï¼‰
    this.checkAndSendDailyReport();
  }

  /**
   * æ£€æŸ¥å¹¶å‘é€æ¯æ—¥æ’­æŠ¥ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
   * è°ƒç”¨ NotificationService çš„ç»Ÿä¸€æ–¹æ³•
   */
  private async checkAndSendDailyReport(): Promise<void> {
    try {
      const notificationService = NotificationService.getInstance();
      await notificationService.checkAndSendDailyReport();
    } catch (err) {
      hilog.error(DOMAIN, 'testTag', `æ£€æŸ¥æ¯æ—¥æ’­æŠ¥å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }

  /**
   * é…ç½®å˜åŒ–å›è°ƒï¼ˆåŒ…æ‹¬ä¸»é¢˜åˆ‡æ¢ï¼‰
   */
  onConfigurationUpdate(newConfig: import('@kit.AbilityKit').Configuration): void {
    hilog.info(DOMAIN, 'testTag', 'é…ç½®æ›´æ–° - ColorMode: %{public}d', newConfig.colorMode ?? 0);
    
    // æ›´æ–° AppStorage ä¸­çš„ä¸»é¢˜çŠ¶æ€ï¼ˆè®© MapView å“åº”ï¼‰
    const newColorMode = newConfig.colorMode ?? ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET;
    AppStorage.setOrCreate('currentColorMode', newColorMode);
    
    // ä¸»é¢˜å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€æ ï¼ˆä¼ é€’æ–°çš„ colorModeï¼‰
    if (this.mainWindowInstance) {
      this.updateStatusBarForTheme(this.mainWindowInstance, newColorMode);
    }
  }

  /**
   * è¯·æ±‚å®šä½æƒé™ï¼ˆåŠ¨æ€æƒé™è¯·æ±‚ï¼‰
   */
  private async requestLocationPermissions(): Promise<void> {
    console.info('ğŸŸ¢ [EntryAbility] requestLocationPermissions å¼€å§‹æ‰§è¡Œ');
    
    const permissions: Array<Permissions> = [
      'ohos.permission.LOCATION',
      'ohos.permission.APPROXIMATELY_LOCATION'
    ];

    try {
      console.info('ğŸŸ¢ [EntryAbility] åˆ›å»ºæƒé™ç®¡ç†å™¨');
      const atManager = abilityAccessCtrl.createAtManager();
      
      console.info('ğŸŸ¢ [EntryAbility] è¯·æ±‚æƒé™: ' + JSON.stringify(permissions));
      const grantStatus = await atManager.requestPermissionsFromUser(this.context, permissions);
      
      console.info('ğŸŸ¢ [EntryAbility] æƒé™è¯·æ±‚ç»“æœ: ' + JSON.stringify(grantStatus));
      console.info('ğŸŸ¢ [EntryAbility] æƒé™ç»“æœæ•°ç»„: ' + JSON.stringify(grantStatus.authResults));
      
      // æ£€æŸ¥æƒé™æ˜¯å¦è¢«æˆäºˆ
      if (grantStatus.authResults.every(result => result === 0)) {
        console.info('âœ… [EntryAbility] å®šä½æƒé™å·²æˆäºˆ');
        hilog.info(DOMAIN, 'testTag', 'âœ… å®šä½æƒé™å·²æˆäºˆ');
      } else {
        console.warn('âš ï¸ [EntryAbility] å®šä½æƒé™è¢«æ‹’ç»');
        hilog.warn(DOMAIN, 'testTag', 'âš ï¸ å®šä½æƒé™è¢«æ‹’ç»');
      }
    } catch (err) {
      console.error('âŒ [EntryAbility] è¯·æ±‚å®šä½æƒé™å¤±è´¥: ' + JSON.stringify(err));
      hilog.error(DOMAIN, 'testTag', 'âŒ è¯·æ±‚å®šä½æƒé™å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }

  /**
   * è¯·æ±‚ä»£ç†æé†’æƒé™ï¼ˆç”¨äºå®šæ—¶é€šçŸ¥ï¼‰
   * æƒé™ï¼šohos.permission.PUBLISH_AGENT_REMINDER
   */
  private async requestReminderPermission(): Promise<void> {
    console.info('ğŸŸ¢ [EntryAbility] requestReminderPermission å¼€å§‹æ‰§è¡Œ');
    
    const permissions: Array<Permissions> = [
      'ohos.permission.PUBLISH_AGENT_REMINDER'
    ];

    try {
      const atManager = abilityAccessCtrl.createAtManager();
      
      console.info('ğŸ”” [EntryAbility] è¯·æ±‚ä»£ç†æé†’æƒé™');
      const grantStatus = await atManager.requestPermissionsFromUser(this.context, permissions);
      
      console.info('ğŸ”” [EntryAbility] ä»£ç†æé†’æƒé™ç»“æœ: ' + JSON.stringify(grantStatus.authResults));
      
      // æ£€æŸ¥æƒé™æ˜¯å¦è¢«æˆäºˆ
      if (grantStatus.authResults[0] === 0) {
        console.info('âœ… [EntryAbility] ä»£ç†æé†’æƒé™å·²æˆäºˆ');
        hilog.info(DOMAIN, 'testTag', 'âœ… ä»£ç†æé†’æƒé™å·²æˆäºˆ');
      } else {
        console.warn('âš ï¸ [EntryAbility] ä»£ç†æé†’æƒé™è¢«æ‹’ç»');
        hilog.warn(DOMAIN, 'testTag', 'âš ï¸ ä»£ç†æé†’æƒé™è¢«æ‹’ç»');
      }
    } catch (err) {
      console.error('âŒ [EntryAbility] è¯·æ±‚ä»£ç†æé†’æƒé™å¤±è´¥: ' + JSON.stringify(err));
      hilog.error(DOMAIN, 'testTag', 'âŒ è¯·æ±‚ä»£ç†æé†’æƒé™å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }
}