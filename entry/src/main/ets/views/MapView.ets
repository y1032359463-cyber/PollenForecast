/**
 * åœ°å›¾é¡µé¢ - Tab3
 * ä½¿ç”¨åä¸º Map Kit æ˜¾ç¤ºåœ°å›¾å’ŒèŠ±ç²‰ä¿¡æ¯
 * æ”¯æŒ API 17+ å…¼å®¹å¤„ç†
 */

import { MapComponent, map, mapCommon } from '@kit.MapKit';
import { LocationService } from '../service/LocationService';
import { promptAction, window } from '@kit.ArkUI';  // window ç”¨äºè·å– vp å•ä½å±å¹•å°ºå¯¸
import { vibrator } from '@kit.SensorServiceKit';
import { ConfigurationConstant, common } from '@kit.AbilityKit';
import { motion } from '@kit.MultimodalAwarenessKit';  // æ™ºæ„Ÿæ¡å§¿ç›‘å¬ï¼ˆAPI 20+ï¼‰
import { display } from '@kit.ArkUI';  // è·å–å±å¹•å°ºå¯¸ï¼ˆç”¨äºåƒç´ å¯†åº¦ï¼‰
import { ApiVersionUtils } from '../utils/ApiVersionUtils';  // API ç‰ˆæœ¬æ£€æµ‹å·¥å…·

// åŸå¸‚åæ ‡æ•°æ®ï¼ˆä¸ RegionView ä¿æŒä¸€è‡´ï¼‰
interface CityCoordinate {
  lat: number
  lng: number
}

// èŠ±ç²‰æ ‡è®°æ•°æ®
interface PollenMarkerData {
  cityName: string
  latitude: number
  longitude: number
  pollenValue: number
  pollenLevel: string
  marker?: map.Marker
}

// åŸå¸‚ç»çº¬åº¦æ˜ å°„è¡¨
const CITY_COORDINATES: Record<string, CityCoordinate> = {
  'åŒ—äº¬å¸‚': { lat: 39.9042, lng: 116.4074 },
  'ä¸Šæµ·å¸‚': { lat: 31.2304, lng: 121.4737 },
  'å¹¿å·å¸‚': { lat: 23.1291, lng: 113.2644 },
  'æ·±åœ³å¸‚': { lat: 22.5431, lng: 114.0579 },
  'æ­å·å¸‚': { lat: 30.2741, lng: 120.1551 },
  'æˆéƒ½å¸‚': { lat: 30.5728, lng: 104.0668 },
  'æ­¦æ±‰å¸‚': { lat: 30.5928, lng: 114.3055 },
  'é‡åº†å¸‚': { lat: 29.4316, lng: 106.9123 },
  'æµ·å—çœ, æµ·å£å¸‚': { lat: 20.0444, lng: 110.1989 },
  'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº, å—å®å¸‚': { lat: 22.8170, lng: 108.3665 },
  'è´µå·çœ, è´µé˜³å¸‚': { lat: 26.6470, lng: 106.6302 },
  'äº‘å—çœ, æ˜†æ˜å¸‚': { lat: 25.0406, lng: 102.7129 },
  'æ¹–å—çœ, é•¿æ²™å¸‚': { lat: 28.2278, lng: 112.9388 },
  'æ±Ÿè¥¿çœ, å—æ˜Œå¸‚': { lat: 28.6829, lng: 115.8579 },
  'ç¦å»ºçœ, ç¦å·å¸‚': { lat: 26.0745, lng: 119.2965 },
  'å››å·çœ, å—å……å¸‚': { lat: 30.8376, lng: 106.1107 },
  'å®‰å¾½çœ, åˆè‚¥å¸‚': { lat: 31.8206, lng: 117.2272 },
  'æµ™æ±Ÿçœ, æ­å·å¸‚': { lat: 30.2741, lng: 120.1551 },
  'é™•è¥¿çœ, è¥¿å®‰å¸‚': { lat: 34.3416, lng: 108.9398 },
  'æ±Ÿè‹çœ, æ— é”¡å¸‚': { lat: 31.4912, lng: 120.3119 },
  'æ²³å—çœ, éƒ‘å·å¸‚': { lat: 34.7472, lng: 113.6249 }
}

// çƒ­é—¨åŸå¸‚åˆ—è¡¨ï¼ˆåœ°å›¾ä¸Šæ˜¾ç¤ºæ ‡è®°çš„åŸå¸‚ï¼‰
const HOT_CITIES: string[] = ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'å¹¿å·å¸‚', 'æ·±åœ³å¸‚', 'æ­å·å¸‚', 'æˆéƒ½å¸‚', 'æ­¦æ±‰å¸‚', 'é‡åº†å¸‚']

@Component
export struct MapView {
  // ä½¿ç”¨ AppStorage å…±äº«æ•°æ®
  @StorageLink('currentCity') currentLocation: string = 'å®šä½ä¸­...'
  @StorageLink('pollenLevel') pollenLevel: string = 'åŠ è½½ä¸­...'
  @StorageLink('pollenValue') pollenValue: number = 0
  @StorageLink('updateTime') updateTime: string = 'è·å–ä¸­...'
  @StorageLink('latitude') @Watch('onLocationChanged') latitude: number = 23.1291
  @StorageLink('longitude') @Watch('onLocationChanged') longitude: number = 113.2644
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'  // èŠ±ç²‰ä¸»é¢˜è‰²
  @State isAnimating: boolean = false
  @State isLocating: boolean = false  // å®šä½æŒ‰é’®åŠ è½½çŠ¶æ€
  @State holdingHand: 'LEFT' | 'RIGHT' | null = null  // æ™ºæ„Ÿæ¡å§¿çŠ¶æ€
  @State buttonX: number = 0  // æŒ‰é’®Xåæ ‡ï¼ˆaboutToAppearä¸­åˆå§‹åŒ–ï¼‰
  @State buttonY: number = 0  // æŒ‰é’®Yåæ ‡ï¼ˆaboutToAppearä¸­åˆå§‹åŒ–ï¼‰
  private initialButtonY: number = 0  // å­˜å‚¨åˆå§‹Yåæ ‡ï¼ˆé¿å…Tab baré®æŒ¡ï¼‰
  @StorageLink('safeTop') safeTop: number = 44
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('currentColorMode') @Watch('onThemeChanged') currentColorMode: ConfigurationConstant.ColorMode = ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET
  // åœ°å›¾ç›¸å…³
  private mapOptions?: mapCommon.MapOptions
  private mapController: map.MapComponentController | null = null
  private mapEventManager?: map.MapEventManager // äº‹ä»¶ç®¡ç†å™¨ï¼ˆAPI 20æ–°å¢ï¼‰
  private locationService: LocationService = LocationService.getInstance()
  @State mapReady: boolean = false
  private currentMarker: map.Marker | null = null // å½“å‰ä½ç½®æ ‡è®°
  private cityMarkers: Map<string, map.Marker> = new Map() // åŸå¸‚æ ‡è®°é›†åˆ
  private isUpdating: boolean = false // é˜²æ­¢é‡å¤æ›´æ–°
  private gripDebounceTimer: number | null = null // æ¡å§¿æ£€æµ‹é˜²æŠ–å®šæ—¶å™¨
  private hasShownGripToast: boolean = false // æ˜¯å¦å·²æ˜¾ç¤ºTipsï¼ˆé¦–æ¬¡æç¤ºï¼‰
  private isGripListening: boolean = false // æ¡å§¿ç›‘å¬æ˜¯å¦æ´»è·ƒ
  @StorageLink('vibrationEnabled') vibrationEnabled: boolean = false // éœ‡åŠ¨åé¦ˆå¼€å…³
  @StorageLink('gripDetectionEnabled') @Watch('onGripDetectionChange') gripDetectionEnabled: boolean = false // æ™ºæ„Ÿæ¡å§¿å¼€å…³
  @StorageLink('isAppInBackground') @Watch('onAppBackgroundChange') isAppInBackground: boolean = false // åº”ç”¨å‰åå°çŠ¶æ€

  aboutToAppear(): void {
    // åˆå§‹åŒ–åœ°å›¾é…ç½®ï¼ˆæ·»åŠ  padding é¿å¼€é¡¶éƒ¨å¡ç‰‡ï¼‰
    this.mapOptions = {
      position: {
        target: {
          latitude: this.latitude,
          longitude: this.longitude
        },
        zoom: 11  // åŸå¸‚çº§åˆ«ç¼©æ”¾ï¼ˆè°ƒæ•´ä¸º11ï¼Œæ›´é€‚åˆåŸå¸‚èŒƒå›´ï¼‰
      },
      // é¢„ç•™é¡¶éƒ¨ä¿¡æ¯å¡ç‰‡åŒºåŸŸï¼ˆçŠ¶æ€æ 44 + å¡ç‰‡é«˜åº¦çº¦140 + é—´è·24ï¼‰
      padding: {
        top: 208,
        bottom: 0,
        left: 0,
        right: 0
      },
      // åœ°å›¾æ ·å¼
      mapType: mapCommon.MapType.STANDARD,
      // è‡ªå®šä¹‰æ ·å¼è·¯å¾„ï¼ˆæ·±è‰²æ¨¡å¼é€‚é…ï¼‰
      // stylePath: this.currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK
      //   ? 'common/map_dark.json'
      //   : 'common/map_light.json',
      // é™åˆ¶ç¼©æ”¾çº§åˆ«ï¼ˆåŸå¸‚èŒƒå›´ï¼‰
      minZoom: 9,   // æœ€å°ç¼©æ”¾ï¼šå¯ä»¥çœ‹åˆ°å‘¨è¾¹åŸå¸‚
      maxZoom: 14   // æœ€å¤§ç¼©æ”¾ï¼šè¡—é“çº§åˆ«ï¼Œä¸ä¼šå¤ªç»†èŠ‚
    }
    // ç¡®ä¿æŒ‰é’®åˆå§‹åŒ–æ—¶å°±å¯è§
    this.isAnimating = true

    // åˆå§‹åŒ–æŒ‰é’®ä½ç½®ï¼ˆé»˜è®¤å³ä¾§ 60% é«˜åº¦ï¼‰
    const screenWidthPX = display.getDefaultDisplaySync().width
    const screenHeightPX = display.getDefaultDisplaySync().height
    const screenWidthVP = px2vp(screenWidthPX)
    const screenHeightVP = px2vp(screenHeightPX)
    
    this.buttonX = screenWidthVP - 64  // å³ä¾§ï¼šå±å¹•å®½åº¦ - æŒ‰é’®48 - è¾¹è·16
    this.initialButtonY = screenHeightVP * 0.6  // é»˜è®¤ 60% é«˜åº¦
    this.buttonY = this.initialButtonY
    
    console.info(`[MapView] æŒ‰é’®åˆå§‹åŒ–ä½ç½®(vp): (${this.buttonX}, ${this.buttonY})`)

    // å¯ç”¨æ™ºæ„Ÿæ¡å§¿ç›‘å¬
    this.setupGripDetection()

    console.info('[MapView] aboutToAppear: åˆå§‹åŒ–å®Œæˆ')
  }

  aboutToDisappear(): void {
    // æ¸…ç†é˜²æŠ–å®šæ—¶å™¨
    if (this.gripDebounceTimer !== null) {
      clearTimeout(this.gripDebounceTimer)
      this.gripDebounceTimer = null
    }

    // æ³¨é”€æ™ºæ„Ÿæ¡å§¿ç›‘å¬
    this.stopGripDetection()
  }

  // ========== æ™ºæ„Ÿæ¡å§¿æ£€æµ‹ ==========
  // åº”ç”¨å‰åå°çŠ¶æ€å˜åŒ–å›è°ƒ
  onAppBackgroundChange() {
    if (this.isAppInBackground) {
      console.info('[MapView] åº”ç”¨è¿›å…¥åå°ï¼Œåœæ­¢æ¡å§¿ç›‘å¬')
      this.stopGripDetection()
    } else {
      console.info('[MapView] åº”ç”¨å›åˆ°å‰å°ï¼Œæ£€æŸ¥æ˜¯å¦æ¢å¤æ¡å§¿ç›‘å¬')
      // åªæœ‰åœ¨åŠŸèƒ½å¼€å¯ä¸”é¡µé¢å¯è§æ—¶æ‰æ¢å¤
      if (this.gripDetectionEnabled && this.isAnimating) {
        this.setupGripDetection()
      }
    }
  }

  // å¼€å…³å˜åŒ–å›è°ƒ
  onGripDetectionChange() {
    if (this.gripDetectionEnabled) {
      console.info('[MapView] æ™ºæ„Ÿæ¡å§¿å·²å¼€å¯ï¼Œå¯åŠ¨ç›‘å¬')
      this.setupGripDetection()
    } else {
      console.info('[MapView] æ™ºæ„Ÿæ¡å§¿å·²å…³é—­ï¼Œåœæ­¢ç›‘å¬å¹¶æ¢å¤é»˜è®¤ä½ç½®')
      this.stopGripDetection()
      // æ¢å¤åˆ°å³ä¾§åˆå§‹ä½ç½®
      animateTo({ duration: 150 }, () => {
        const screenWidthVP = px2vp(display.getDefaultDisplaySync().width)
        this.holdingHand = null
        this.buttonX = screenWidthVP - 64
        this.buttonY = this.initialButtonY
      })
    }
  }

  private setupGripDetection() {
    // API ç‰ˆæœ¬æ£€æµ‹ï¼šæ™ºæ„Ÿæ¡å§¿ä»… API 20+ æ”¯æŒ
    if (!ApiVersionUtils.supportsGripDetection()) {
      console.info('[MapView] API ç‰ˆæœ¬ä¸æ”¯æŒæ™ºæ„Ÿæ¡å§¿ï¼Œè·³è¿‡')
      return
    }

    // æ£€æŸ¥å¼€å…³çŠ¶æ€
    if (!this.gripDetectionEnabled) {
      console.info('[MapView] æ™ºæ„Ÿæ¡å§¿å·²å…³é—­ï¼Œä¸å¯åŠ¨ç›‘å¬')
      return
    }

    // æ£€æŸ¥åº”ç”¨æ˜¯å¦åœ¨åå°
    if (this.isAppInBackground) {
      console.info('[MapView] åº”ç”¨åœ¨åå°ï¼Œä¸å¯åŠ¨æ¡å§¿ç›‘å¬')
      return
    }

    // é˜²æ­¢é‡å¤å¯åŠ¨
    if (this.isGripListening) {
      console.info('[MapView] æ¡å§¿ç›‘å¬å·²åœ¨è¿è¡Œï¼Œè·³è¿‡é‡å¤å¯åŠ¨')
      return
    }

    try {
      motion.on('holdingHandChanged', (status: motion.HoldingHandStatus) => {
        // é˜²æŠ–ï¼š1ç§’å†…åªå“åº”ä¸€æ¬¡
        if (this.gripDebounceTimer !== null) {
          clearTimeout(this.gripDebounceTimer)
        }

        this.gripDebounceTimer = setTimeout(() => {
          // è·å–å±å¹•å°ºå¯¸ï¼ˆpxï¼‰å¹¶è½¬æ¢ä¸º vp
          const screenWidthPX = display.getDefaultDisplaySync().width
          const screenHeightPX = display.getDefaultDisplaySync().height
          const screenWidthVP = px2vp(screenWidthPX)
          const screenHeightVP = px2vp(screenHeightPX)
          
          // HoldingHandStatus: 0=NONE(æ— æ¡æŒ), 1=LEFT_HAND, 2/3=RIGHT_HAND
          if (status === 0) {
            // æ¾å¼€æ‰‹ â†’ æ¢å¤åˆå§‹ä½ç½®
            console.info(`[MapView] æ¡å§¿é‡Šæ”¾ï¼Œæ¢å¤åˆå§‹ä½ç½® (status=0)`)
            animateTo({ duration: 150 }, () => {
              this.holdingHand = null
              this.buttonX = screenWidthVP - 64
              this.buttonY = this.initialButtonY
              console.info(`[MapView] æŒ‰é’®ä½ç½®æ¢å¤(vp): (${this.buttonX}, ${this.buttonY})`)
            })
          } else {
            // æ£€æµ‹åˆ°æ¡å§¿ â†’ ç§»åŠ¨åˆ°60%é«˜åº¦
            const handType = status === 1 ? 'LEFT' : 'RIGHT'
            console.info(`[MapView] æ¡æ‰‹æ£€æµ‹: ${handType} (status=${status})`)
            
            this.holdingHand = handType
            
            animateTo({ duration: 150 }, () => {
              this.buttonX = handType === 'LEFT' ? 16 : (screenWidthVP - 64)
              this.buttonY = screenHeightVP * 0.6
              console.info(`[MapView] æŒ‰é’®ä½ç½®æ›´æ–°(vp): (${this.buttonX}, ${this.buttonY})ï¼Œæ¡å§¿=${handType}`)
            })
          }

          // éœ‡åŠ¨åé¦ˆï¼ˆä»…æ¡å§¿æ£€æµ‹æ—¶ï¼Œé‡Šæ”¾æ—¶ä¸éœ‡åŠ¨ï¼‰
          if (status !== 0 && this.vibrationEnabled) {
            try {
              vibrator.startVibration({ type: 'time', duration: 15 }, { usage: 'touch' })
            } catch (err) {
              const error = err as Error
              console.error(`[MapView] éœ‡åŠ¨åé¦ˆå¤±è´¥: ${error.message}`)
            }
          }

          // Toastæç¤ºï¼ˆä»…é¦–æ¬¡æ¡å§¿æ£€æµ‹æ—¶ï¼‰
          if (status !== 0 && !this.hasShownGripToast) {
            const handType = status === 1 ? 'LEFT' : 'RIGHT'
            promptAction.showToast({
              message: `å·²æ£€æµ‹åˆ°${handType === 'LEFT' ? 'å·¦' : 'å³'}æ‰‹æ¡æŒï¼ŒæŒ‰é’®è‡ªåŠ¨è°ƒæ•´ä½ç½®`,
              duration: 2000
            })
            this.hasShownGripToast = true
          }

          this.gripDebounceTimer = null
        }, 300) // 300msé˜²æŠ–ï¼ˆä¼˜åŒ–å“åº”é€Ÿåº¦ï¼‰
      })
      this.isGripListening = true
      console.info('[MapView] æ™ºæ„Ÿæ¡å§¿ç›‘å¬å·²å¯åŠ¨')
    } catch (error) {
      console.error(`[MapView] æ™ºæ„Ÿæ¡å§¿åˆå§‹åŒ–å¤±è´¥: ${error}`)
    }
  }

  // åœæ­¢æ¡å§¿æ£€æµ‹ï¼ˆé¡µé¢ä¸å¯è§æ—¶è°ƒç”¨ï¼‰
  private stopGripDetection() {
    if (!this.isGripListening) {
      return
    }

    try {
      motion.off('holdingHandChanged')
      this.isGripListening = false
      console.info('[MapView] æ™ºæ„Ÿæ¡å§¿ç›‘å¬å·²åœæ­¢ï¼ˆé¡µé¢ä¸å¯è§ï¼‰')
    } catch (error) {
      console.error(`[MapView] åœæ­¢ç›‘å¬å¤±è´¥: ${error}`)
    }
  }

  // ç›‘å¬ç»çº¬åº¦å˜åŒ–ï¼ˆä½œä¸ºåŒé‡ä¿éšœï¼Œä½†åœ¨è·¨Tabåœºæ™¯å¯èƒ½ä¸è§¦å‘ï¼‰
  onLocationChanged(): void {
    console.info('[MapView] @Watch è§¦å‘')
    if (this.mapReady && this.mapController && !this.isUpdating) {
      this.isUpdating = true
      console.info(`[MapView] ä½ç½®å˜åŒ–: (${this.latitude}, ${this.longitude})`)
      // ä½¿ç”¨setTimeoutæ›¿ä»£requestAnimationFrame
      setTimeout(() => {
        this.moveCameraToLocation(this.latitude, this.longitude)
        this.isUpdating = false
      }, 0)
    }
  }

  // ç›‘å¬ä¸»é¢˜å˜åŒ–ï¼ˆä½¿ç”¨è‡ªå®šä¹‰æ ·å¼æ–‡ä»¶å®ç°æ·±è‰²æ¨¡å¼ï¼‰
  onThemeChanged(): void {
    console.info(`[MapView] ä¸»é¢˜å˜åŒ–: ${this.currentColorMode}`)
    if (this.mapReady && this.mapController) {
      try {
        // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼æ–‡ä»¶åˆ‡æ¢ä¸»é¢˜ï¼ˆéœ€è¦å…ˆåˆ›å»ºæ ·å¼æ–‡ä»¶ï¼‰
        // const stylePath = this.currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK
        //   ? 'common/map_dark.json'
        //   : 'common/map_light.json'
        // this.mapController.setMapStylePath(stylePath)
        // console.info(`[MapView] åœ°å›¾æ ·å¼å·²åˆ‡æ¢ä¸º: ${stylePath}`)
        
        // TODO: åˆ›å»ºè‡ªå®šä¹‰æ ·å¼æ–‡ä»¶åå¯ç”¨ä¸Šè¿°ä»£ç 
        console.info('[MapView] åœ°å›¾æ·±è‰²æ¨¡å¼æš‚æœªå¯ç”¨ï¼ˆéœ€è¦è‡ªå®šä¹‰æ ·å¼æ–‡ä»¶ï¼‰')
      } catch (err) {
        console.error(`[MapView] åˆ‡æ¢åœ°å›¾æ ·å¼å¤±è´¥: ${JSON.stringify(err)}`)
      }
    }
  }

  // åœ°å›¾åˆå§‹åŒ–å›è°ƒ
  callback = (err: Error, controller: map.MapComponentController) => {
    if (!err) {
      this.mapController = controller
      this.mapReady = true
      console.info('[MapView] åœ°å›¾åˆå§‹åŒ–æˆåŠŸ')

      // API ç‰ˆæœ¬æ£€æµ‹
      const apiVersion = ApiVersionUtils.getApiVersion()
      console.info(`[MapView] å½“å‰ API ç‰ˆæœ¬: ${apiVersion}ï¼Œ${ApiVersionUtils.getVersionDescription()}`)

      // ========== äº‹ä»¶ç›‘å¬å…¼å®¹å¤„ç† ==========
      if (ApiVersionUtils.supportsMapEventManager()) {
        // API 20+: ä½¿ç”¨ MapEventManager
        try {
          this.mapEventManager = controller.getEventManager()
          
          // æ·»åŠ ç›¸æœºç©ºé—²ç›‘å¬ï¼ˆç¼©æ”¾çº§åˆ«å˜åŒ–æ—¶è§¦å‘ï¼‰
          this.mapEventManager.on('cameraIdle', async () => {
            await this.onCameraChanged()
          })
          
          // æ·»åŠ æ ‡è®°ç‚¹å‡»ç›‘å¬ï¼ˆå…¨å±€åªç»‘å®šä¸€æ¬¡ï¼‰
          this.mapEventManager.on('markerClick', (clickedMarker: map.Marker) => {
            this.handleMarkerClick(clickedMarker)
          })
          
          // æ·»åŠ å®šä½æŒ‰é’®ç‚¹å‡»ç›‘å¬ï¼ˆä½¿ç”¨è‡ªå®šä¹‰æŒ‰é’®ï¼Œæ­¤äº‹ä»¶ä¸å†ä½¿ç”¨ï¼‰
          this.mapEventManager.on('myLocationClick', async () => {
            console.info('[MapView] ç³»ç»Ÿå®šä½æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆå·²ç¦ç”¨ï¼Œä½¿ç”¨è‡ªå®šä¹‰æŒ‰é’®ï¼‰')
          })
          
          console.info('[MapView] âœ… MapEventManager åˆå§‹åŒ–æˆåŠŸï¼ˆAPI 20+ï¼‰')
        } catch (e) {
          console.warn('[MapView] MapEventManager åˆå§‹åŒ–å¤±è´¥:', JSON.stringify(e))
        }
      } else {
        // API 17-19: äº‹ä»¶ç›‘å¬å¾…çœŸæœºéªŒè¯
        // TODO: API 17 çœŸæœºéªŒè¯åå®ç° controller.on() äº‹ä»¶ç›‘å¬
        console.warn('[MapView] API 17-19 è®¾å¤‡ï¼Œäº‹ä»¶ç›‘å¬åŠŸèƒ½å—é™ï¼ˆå¾…çœŸæœºéªŒè¯ï¼‰')
        console.warn('[MapView] åœ°å›¾æ ‡è®°ç‚¹å‡»å’Œç›¸æœºç§»åŠ¨äº‹ä»¶å¯èƒ½ä¸å¯ç”¨')
      }

      // ========== ç¦ç”¨ç³»ç»Ÿå®šä½æ§ä»¶ï¼ˆä½¿ç”¨è‡ªå®šä¹‰æŒ‰é’®ï¼‰==========
      setTimeout(() => {
        if (!this.mapController) {
          return
        }
        try {
          // å…³é—­ç³»ç»Ÿå®šä½åŠŸèƒ½
          this.mapController.setMyLocationEnabled(false)
          
          // éšè—ç³»ç»Ÿå®šä½æŒ‰é’®
          this.mapController.setMyLocationControlsEnabled(false)
          
          // éšè—ç¼©æ”¾æŒ‰é’®
          this.mapController.setZoomControlsEnabled(false)
          
          console.info('[MapView] ç³»ç»Ÿå®šä½æ§ä»¶å·²ç¦ç”¨ï¼Œä½¿ç”¨è‡ªå®šä¹‰æŒ‰é’®')
        } catch (e) {
          console.warn('[MapView] ç¦ç”¨ç³»ç»Ÿæ§ä»¶å¤±è´¥:', JSON.stringify(e))
        }
      }, 200)

      // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
      this.addCurrentLocationMarker()
      
      // æ·»åŠ çƒ­é—¨åŸå¸‚æ ‡è®°
      this.addHotCityMarkers()
    } else {
      console.error('[MapView] åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', JSON.stringify(err))
    }
  }

  // ç§»åŠ¨ç›¸æœºåˆ°æŒ‡å®šä½ç½®ï¼ˆAPI 20 æ­£ç¡®å®ç°ï¼‰
  async moveCameraToLocation(latitude: number, longitude: number, zoom?: number): Promise<void> {
    if (!this.mapController) {
      console.warn('[MapView] åœ°å›¾æ§åˆ¶å™¨æœªåˆå§‹åŒ–')
      return
    }

    try {
      console.info(`[MapView] å¼€å§‹ç§»åŠ¨ç›¸æœºåˆ°: (${latitude}, ${longitude})`)

      // 1. åˆ›å»º CameraPosition å¯¹è±¡
      const cameraPosition: mapCommon.CameraPosition = {
        target: { latitude: latitude, longitude: longitude },
        zoom: zoom ?? 12,
        tilt: 0,
        bearing: 0
      }

      // 2. é€šè¿‡ newCameraPosition() å·¥å‚æ–¹æ³•ç”Ÿæˆ CameraUpdate
      const cameraUpdate = map.newCameraPosition(cameraPosition)

      // 3. ä½¿ç”¨ animateCamera å®ç°åŠ¨ç”»ç§»åŠ¨ï¼ˆ1000ms åŠ¨ç”»æ—¶é•¿ï¼‰
      await this.mapController.animateCamera(cameraUpdate, 1000)
      
      console.info('[MapView] âœ… ç›¸æœºç§»åŠ¨æˆåŠŸ')

      // æ›´æ–°ä½ç½®æ ‡è®°
      await this.updateLocationMarker()
    } catch (err) {
      const error = err as Error
      console.error('[MapView] âŒ ç§»åŠ¨ç›¸æœºå¤±è´¥ - é”™è¯¯ä¿¡æ¯:', error.message || 'æœªçŸ¥é”™è¯¯')
      
      // é™çº§æ–¹æ¡ˆï¼šä»…æ›´æ–°æ ‡è®°ç‚¹
      await this.updateLocationMarker()
    }
  }

  // ç›¸æœºå˜åŒ–å¤„ç†ï¼ˆæ§åˆ¶Markerå¯è§æ€§ï¼‰
  async onCameraChanged(): Promise<void> {
    if (!this.mapController) {
      return
    }

    try {
      const cameraPosition = await this.mapController.getCameraPosition()
      const zoomLevel = cameraPosition.zoom
      
      // ç¼©æ”¾çº§åˆ« > 14 æ—¶éšè—å½“å‰ä½ç½®Markerï¼ˆé¿å…ä¸è“è‰²å®šä½ç‚¹é‡å ï¼‰
      // ç¼©æ”¾çº§åˆ« <= 14 æ—¶æ˜¾ç¤ºå½“å‰ä½ç½®Markerï¼ˆåŸå¸‚çº§åˆ«ï¼Œéœ€è¦çº¢è‰²æ ‡è®°ç‚¹ï¼‰
      if (this.currentMarker) {
        this.currentMarker.setVisible(zoomLevel <= 14)
        console.info(`[MapView] ç¼©æ”¾çº§åˆ« ${zoomLevel.toFixed(1)}, Markerå¯è§æ€§: ${zoomLevel <= 14}`)
      }
    } catch (e) {
      console.warn('[MapView] è·å–ç›¸æœºä½ç½®å¤±è´¥:', JSON.stringify(e))
    }
  }

  // æ›´æ–°ä½ç½®æ ‡è®°(åˆ é™¤æ—§æ ‡è®°å¹¶æ·»åŠ æ–°æ ‡è®°)
  async updateLocationMarker(): Promise<void> {
    if (!this.mapController) {
      return
    }

    try {
      // åˆ é™¤æ—§æ ‡è®°
      if (this.currentMarker) {
        try {
          await this.currentMarker.remove()
        } catch (e) {
          console.warn('[MapView] åˆ é™¤æ—§æ ‡è®°å¤±è´¥:', JSON.stringify(e))
        }
      }

      // æ·»åŠ æ–°æ ‡è®°
      const markerOptions: mapCommon.MarkerOptions = {
        position: {
          latitude: this.latitude,
          longitude: this.longitude
        },
        title: this.currentLocation
      }
      this.currentMarker = await this.mapController.addMarker(markerOptions)
      console.info('[MapView] ä½ç½®æ ‡è®°å·²æ›´æ–°')
    } catch (err) {
      console.error('[MapView] æ›´æ–°æ ‡è®°å¤±è´¥:', JSON.stringify(err))
    }
  }

  // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°(åˆå§‹åŒ–æ—¶è°ƒç”¨)
  async addCurrentLocationMarker(): Promise<void> {
    await this.updateLocationMarker()
  }

  // æ·»åŠ çƒ­é—¨åŸå¸‚æ ‡è®°
  async addHotCityMarkers(): Promise<void> {
    if (!this.mapController) {
      console.warn('[MapView] åœ°å›¾æ§åˆ¶å™¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ·»åŠ åŸå¸‚æ ‡è®°')
      return
    }

    console.info('[MapView] å¼€å§‹æ·»åŠ çƒ­é—¨åŸå¸‚æ ‡è®°')

    for (const cityName of HOT_CITIES) {
      const coord = CITY_COORDINATES[cityName]
      if (!coord) {
        console.warn(`[MapView] æœªæ‰¾åˆ°åŸå¸‚åæ ‡: ${cityName}`)
        continue
      }

      // è·³è¿‡å½“å‰åŸå¸‚ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
      if (cityName === this.currentLocation) {
        continue
      }

      try {
        const markerOptions: mapCommon.MarkerOptions = {
          position: {
            latitude: coord.lat,
            longitude: coord.lng
          },
          title: cityName,
          snippet: 'ç‚¹å‡»æŸ¥çœ‹èŠ±ç²‰ä¿¡æ¯',
          clickable: true,
          alpha: 0.9
        }

        const marker = await this.mapController.addMarker(markerOptions)
        this.cityMarkers.set(cityName, marker)
        
        console.info(`[MapView] æ·»åŠ åŸå¸‚æ ‡è®°æˆåŠŸ: ${cityName}`)
      } catch (err) {
        console.error(`[MapView] æ·»åŠ åŸå¸‚æ ‡è®°å¤±è´¥: ${cityName}`, JSON.stringify(err))
      }
    }

    console.info(`[MapView] çƒ­é—¨åŸå¸‚æ ‡è®°æ·»åŠ å®Œæˆï¼Œå…± ${this.cityMarkers.size} ä¸ª`)
  }

  // å¤„ç†æ ‡è®°ç‚¹å‡»äº‹ä»¶
  async handleMarkerClick(marker: map.Marker): Promise<void> {
    try {
      const title = marker.getTitle()
      console.info(`[MapView] æ ‡è®°è¢«ç‚¹å‡»: ${title}`)

      // å¦‚æœæ˜¯å½“å‰ä½ç½®æ ‡è®°ï¼Œä¸å¤„ç†
      if (title === this.currentLocation) {
        return
      }

      // è§¦å‘éœ‡åŠ¨åé¦ˆ
      if (this.vibrationEnabled) {
        try {
          vibrator.startVibration({
            type: 'time',
            duration: 30
          }, {
            id: 0,
            usage: 'touch'
          })
        } catch (e) {
          // å¿½ç•¥éœ‡åŠ¨é”™è¯¯
        }
      }

      // è·å–åŸå¸‚åæ ‡
      const coord = CITY_COORDINATES[title]
      if (!coord) {
        console.warn(`[MapView] æœªæ‰¾åˆ°åŸå¸‚åæ ‡: ${title}`)
        return
      }

      // æ›´æ–°å…¨å±€ä½ç½®æ•°æ®ï¼ˆè§¦å‘å…¶ä»–é¡µé¢æ•°æ®åˆ·æ–°ï¼‰
      AppStorage.setOrCreate('latitude', coord.lat)
      AppStorage.setOrCreate('longitude', coord.lng)
      AppStorage.setOrCreate('currentCity', title)

      // ç§»åŠ¨ç›¸æœºåˆ°è¯¥åŸå¸‚
      await this.moveCameraToLocation(coord.lat, coord.lng, 11)

      // æ˜¾ç¤ºæç¤º
      promptAction.showToast({
        message: `å·²åˆ‡æ¢åˆ° ${title}`,
        duration: 2000
      })

      console.info(`[MapView] æˆåŠŸåˆ‡æ¢åˆ°åŸå¸‚: ${title}`)
    } catch (err) {
      console.error('[MapView] å¤„ç†æ ‡è®°ç‚¹å‡»å¤±è´¥:', JSON.stringify(err))
    }
  }

  // æ ¹æ®èŠ±ç²‰ç­‰çº§è·å–é¢œè‰²
  getPollenLevelColor(level: string): string {
    switch (level) {
      case 'æä½': return '#4CAF50'  // ç»¿è‰²
      case 'ä½': return '#8BC34A'    // æµ…ç»¿
      case 'ä¸­ç­‰': return '#FF9800'  // æ©™è‰²
      case 'é«˜': return '#F44336'    // çº¢è‰²
      case 'æé«˜': return '#9C27B0'  // ç´«è‰²
      default: return '#9E9E9E'      // ç°è‰²
    }
  }

  // å®šä½åˆ°å½“å‰ä½ç½®(é‡æ–°è·å–GPSå®šä½)
  async locateToCurrentPosition(): Promise<void> {
    try {
      const location = await this.locationService.getCurrentLocation()
      if (location) {
        // æ›´æ–°å…¨å±€åæ ‡(ä¼šè§¦å‘ onLocationChanged)
        AppStorage.setOrCreate('latitude', location.latitude)
        AppStorage.setOrCreate('longitude', location.longitude)

        console.info('[MapView] GPSå®šä½æˆåŠŸ:', location.latitude, location.longitude)
        // æ³¨æ„: åŸå¸‚åç”± PollenIndexView çš„ loadPollenData è‡ªåŠ¨æ›´æ–°
      }
    } catch (err) {
      console.error('[MapView] GPSå®šä½å¤±è´¥:', JSON.stringify(err))
    }
  }

  build() {
    Stack() {
      // åä¸ºåœ°å›¾ç»„ä»¶(å…¨å±æ˜¾ç¤º)
      if (this.mapOptions) {
        MapComponent({
          mapOptions: this.mapOptions,
          mapCallback: this.callback
        })
          .width('100%')
          .height('100%')
          .hitTestBehavior(HitTestMode.Transparent) // å…è®¸äº‹ä»¶ç©¿é€åˆ°ä¸Šå±‚æŒ‰é’®
      }

      // é¡¶éƒ¨æ¯›ç»ç’ƒä¿¡æ¯å¡ç‰‡
      this.TopInfoCard()

      // è‡ªå®šä¹‰å®šä½æŒ‰é’®ï¼ˆæ™ºæ„Ÿæ¡å§¿é€‚é…ï¼‰
      this.customLocationButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .clip(false)  // å…è®¸å­ç»„ä»¶è¶…å‡º Stack èŒƒå›´ï¼ˆé˜²æ­¢æŒ‰é’®è¢«è£å‰ªï¼‰
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean) => {
      if (isVisible) {
        console.info('[MapView] é¡µé¢å¯è§ - å¼€å§‹åŒæ­¥æ•°æ®')

        // é‡æ–°å¯åŠ¨æ¡å§¿æ£€æµ‹ï¼ˆä»…åœ¨åº”ç”¨å‰å°æ—¶ï¼‰
        if (!this.isAppInBackground) {
          this.setupGripDetection()
        } else {
          console.info('[MapView] åº”ç”¨åœ¨åå°ï¼Œè·³è¿‡å¯åŠ¨æ¡å§¿ç›‘å¬')
        }

        // å¼ºåˆ¶ä» AppStorage è¯»å–æœ€æ–°æ•°æ®
        const newLat = AppStorage.get<number>('latitude')
        const newLng = AppStorage.get<number>('longitude')

        console.info(`[MapView] AppStorageè¯»å–: (${newLat}, ${newLng})`)
        console.info(`[MapView] å½“å‰ç»„ä»¶å€¼: (${this.latitude}, ${this.longitude})`)

        // æ‰‹åŠ¨åŒæ­¥ @StorageLink
        if (newLat !== undefined && newLat !== this.latitude) {
          this.latitude = newLat
          console.info('[MapView] åŒæ­¥latitude:', newLat)
        }
        if (newLng !== undefined && newLng !== this.longitude) {
          this.longitude = newLng
          console.info('[MapView] åŒæ­¥longitude:', newLng)
        }

        // é‡ç½®é˜²æŠ–æ ‡å¿—ï¼Œç¡®ä¿åœ°å›¾å¯ä»¥è·³è½¬
        this.isUpdating = false

        // å¦‚æœåœ°å›¾å·²åˆå§‹åŒ–ä¸”æ•°æ®æœ‰å˜åŒ–ï¼Œè§¦å‘åœ°å›¾è·³è½¬
        if (this.mapReady && this.mapController && newLat !== undefined && newLng !== undefined) {
          console.info('[MapView] è§¦å‘åœ°å›¾è·³è½¬')
          // æ·»åŠ å»¶è¿Ÿç¡®ä¿åœ°å›¾å®Œå…¨æ¸²æŸ“
          setTimeout(() => {
            this.moveCameraToLocation(newLat, newLng)
          }, 300)
        }

        // é¡µé¢å¯è§æ—¶è§¦å‘åŠ¨ç”»
        setTimeout(() => {
          this.getUIContext().animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
            this.isAnimating = true
          })
        }, 50)
      } else {
        // é¡µé¢ä¸å¯è§æ—¶åœæ­¢ç›‘å¬
        console.info('[MapView] é¡µé¢ä¸å¯è§ - åœæ­¢æ¡å§¿ç›‘å¬')
        
        // åœæ­¢æ¡å§¿æ£€æµ‹ï¼ˆèŠ‚çœç”µé‡ï¼‰
        this.stopGripDetection()
        this.isAnimating = false
      }
    })
  }

  // ========== é¡¶éƒ¨æ¯›ç»ç’ƒä¿¡æ¯å¡ç‰‡ ==========
  @Builder
  TopInfoCard() {
    Column({ space: 8 }) {
      // ä½ç½®ä¿¡æ¯
      Row({ space: 8 }) {
        Image($r('app.media.icon_location'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.text_primary'))
        Text(this.currentLocation)
          .fontSize(15)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(500)
      }
      .width('100%')

      // èŠ±ç²‰ç­‰çº§
      Row({ space: 8 }) {
        SymbolGlyph($r('sys.symbol.leaf'))
          .fontSize(16)
          .fontColor([$r('app.color.text_primary')])
        Text(`èŠ±ç²‰ç­‰çº§: ${this.pollenLevel}`)
          .fontSize(14)
          .fontColor($r('app.color.text_primary'))
        Text(`(${this.pollenValue} ç²’/kmÂ³)`)
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')

      // æ›´æ–°æ—¶é—´
      Row({ space: 8 }) {
        SymbolGlyph($r('sys.symbol.calendar'))
          .fontSize(16)
          .fontColor([$r('app.color.text_primary')])
        Text(`æ›´æ–°: ${this.updateTime}`)
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')
    }
    .width('calc(100% - 32vp)')
    .padding({
      top: 12,
      bottom: 12,
      left: 20,
      right: 20
    })
    .backdropBlur(20)
    .backgroundColor($r('app.color.card_background'))
    .opacity(0.95)
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: $r('app.color.divider_color'),
      offsetY: 4
    })
    .position({ x: 16, y: this.safeTop + 12 })
    .zIndex(10)
    // å…¥åœºåŠ¨ç”»ï¼šä»ä¸Šå¾€ä¸‹æ»‘å…¥
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ y: this.isAnimating ? 0 : -20 })
    .animation({
      duration: 300,
      curve: Curve.EaseOut,
      delay: 0
    })
  }

  // ========== å®šä½æŒ‰é’®ç‚¹å‡»å¤„ç†ï¼ˆä¼˜åŒ–ï¼šå¿«é€Ÿå“åº”ï¼‰==========
  private async handleCustomLocationClick() {
    if (this.isLocating) {
      return  // é˜²æ­¢é‡å¤ç‚¹å‡»
    }

    // éœ‡åŠ¨åé¦ˆ
    if (this.vibrationEnabled) {
      try {
        vibrator.startVibration({ type: 'time', duration: 15 }, { usage: 'touch' })
      } catch (err) {
        const error = err as Error
        console.error(`[MapView] éœ‡åŠ¨åé¦ˆå¤±è´¥: ${error.message}`)
      }
    }

    this.isLocating = true
    const startTime = Date.now()
    
    try {
      // 1. ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ä½ç½®ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰
      const cachedLocation = this.locationService.getCachedLocation()
      if (cachedLocation) {
        // ç«‹å³æ›´æ–° UI
        AppStorage.setOrCreate('latitude', cachedLocation.latitude)
        AppStorage.setOrCreate('longitude', cachedLocation.longitude)
        if (cachedLocation.city && cachedLocation.city !== 'å½“å‰ä½ç½®') {
          AppStorage.setOrCreate('currentCity', cachedLocation.city)
        }
        // ç§»åŠ¨åœ°å›¾
        this.moveCameraToLocation(cachedLocation.latitude, cachedLocation.longitude)
        
        console.info(`[MapView] âš¡ ä½¿ç”¨ç¼“å­˜ä½ç½® (${Date.now() - startTime}ms)`)
        
        // åå°è·å–æ›´ç²¾ç¡®ä½ç½®
        this.updateLocationInBackground()
        
        promptAction.showToast({
          message: 'å®šä½æˆåŠŸ',
          duration: 1000
        })
        this.isLocating = false
        return
      }

      // 2. å¿«é€Ÿå®šä½ï¼ˆåŸºç«™ä¼˜å…ˆï¼Œ2ç§’å†…è¿”å›ï¼‰
      const location = await this.locationService.getQuickLocation()
      if (location) {
        // æ›´æ–° AppStorageï¼ˆè§¦å‘åŒæ­¥æ›´æ–°ï¼‰
        AppStorage.setOrCreate('latitude', location.latitude)
        AppStorage.setOrCreate('longitude', location.longitude)
        if (location.city && location.city !== 'å½“å‰ä½ç½®') {
          AppStorage.setOrCreate('currentCity', location.city)
        }
        // ç§»åŠ¨åœ°å›¾
        this.moveCameraToLocation(location.latitude, location.longitude)

        console.info(`[MapView] âš¡ å¿«é€Ÿå®šä½æˆåŠŸ (${Date.now() - startTime}ms)`)
        promptAction.showToast({
          message: 'å®šä½æˆåŠŸ',
          duration: 1000
        })
      } else {
        promptAction.showToast({
          message: 'å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®',
          duration: 2000
        })
      }
    } catch (error) {
      console.error(`[MapView] å®šä½å¤±è´¥: ${error}`)
      promptAction.showToast({
        message: 'å®šä½å¼‚å¸¸',
        duration: 2000
      })
    } finally {
      this.isLocating = false
    }
  }

  // åå°æ›´æ–°æ›´ç²¾ç¡®ä½ç½®
  private updateLocationInBackground(): void {
    setTimeout(async () => {
      try {
        const location = await this.locationService.getCurrentLocation()
        if (location) {
          AppStorage.setOrCreate('latitude', location.latitude)
          AppStorage.setOrCreate('longitude', location.longitude)
          if (location.city && location.city !== 'å½“å‰ä½ç½®') {
            AppStorage.setOrCreate('currentCity', location.city)
          }
          console.info('[MapView] ğŸ”„ åå°ä½ç½®å·²æ›´æ–°')
        }
      } catch (e) {
        console.warn('[MapView] åå°æ›´æ–°ä½ç½®å¤±è´¥')
      }
    }, 100)
  }

  // ========== è‡ªå®šä¹‰å®šä½æµ®åŠ¨æŒ‰é’® ==========
  @Builder
  customLocationButton() {
    Button({ type: ButtonType.Circle }) {
      if (this.isLocating) {
        // åŠ è½½çŠ¶æ€ï¼šæ˜¾ç¤ºæ—‹è½¬å›¾æ ‡
        LoadingProgress()
          .width(20)
          .height(20)
          .color(this.pollenThemeColor)
      } else {
        // æ­£å¸¸çŠ¶æ€ï¼šæ˜¾ç¤ºå®šä½å›¾æ ‡
        Image($r('app.media.icon_location'))
          .width(24)
          .height(24)
          .fillColor(this.pollenThemeColor)
      }
    }
    .width(48)
    .height(48)
    .backgroundColor($r('app.color.card_background'))
    .shadow({
      radius: 12,
      color: $r('app.color.divider_color'),
      offsetY: 4
    })
    .enabled(!this.isLocating)
    .onClick(() => this.handleCustomLocationClick())
    .onTouch((event: TouchEvent) => {
      // æŒ‰ä¸‹ç¼©æ”¾æ•ˆæœ
      if (event.type === TouchType.Down) {
        animateTo({ duration: 100, curve: Curve.Sharp }, () => {
          this.buttonX = this.buttonX - 2  // è½»å¾®ç¼©å°ï¼ˆé€šè¿‡ä½ç½®æ¨¡æ‹Ÿï¼‰
        })
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        animateTo({ duration: 100, curve: Curve.Sharp }, () => {
          this.buttonX = this.holdingHand === 'LEFT' ? 16 : 
            (px2vp(display.getDefaultDisplaySync().width) - 64)
        })
      }
    })
    .position({
      x: this.buttonX,
      y: this.buttonY
    })
    .zIndex(100)
  }
}
