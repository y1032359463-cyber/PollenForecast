/**
 * åŒºåŸŸé¡µé¢ - Tab2
 * åŸå¸‚åˆ—è¡¨ï¼Œæ”¯æŒæœç´¢å’Œæ”¶è—
 * æ»‘åŠ¨æ“ä½œï¼šæ”¶è—/å–æ¶ˆæ”¶è—/ç½®é¡¶
 */

import { LocationService, LocationInfo } from '../service/LocationService'
import { vibrator } from '@kit.SensorServiceKit'
import { promptAction } from '@kit.ArkUI'
import {
  extractProvince,
  getCityPinyin,
  getPinyinInitial,
  groupCitiesByProvince,
  groupCitiesByAlphabet,
  searchCities,
  sortCities,
  loadPinyinMap,
  CityGroup,
  CityItem,
  DistrictItem
} from '../utils/CityUtils'
import { PollenService } from '../service/PollenService'
import { PollenLevel, getMaxPollenFromDaily } from '../model/PollenModels'
import { loadChinaAreaData, getCityWithDistricts } from '../utils/ChinaAreaDataLoader'  // æ–°å¢ï¼šåŒºå¿æ•°æ®åŠ è½½å™¨
import { PollenDataSourceType } from '../model/PollenDataSource' // âœ… æ–°å¢ï¼šå¯¼å…¥æšä¸¾ç”¨äºç²¾å‡†åˆ¤æ–­

// åŸå¸‚åæ ‡æ¥å£
interface CityCoordinate {
  lat: number
  lng: number
}

// èŠ±ç²‰ç¼“å­˜æ•°æ®æ¥å£
interface PollenCacheData {
  level: number
  index: number
}

// åŸå¸‚ç»çº¬åº¦æ˜ å°„è¡¨
const cityCoordinates: Record<string, CityCoordinate> = {
  'å½“å‰ä½ç½®': {lat: 39.9042, lng: 116.4074},  // é»˜è®¤åŒ—äº¬åæ ‡
  'åŒ—äº¬å¸‚': {lat: 39.9042, lng: 116.4074},
  'ä¸Šæµ·å¸‚': {lat: 31.2304, lng: 121.4737},
  'å¹¿å·å¸‚': {lat: 23.1291, lng: 113.2644},
  'æ·±åœ³å¸‚': {lat: 22.5431, lng: 114.0579},
  'æ­å·å¸‚': {lat: 30.2741, lng: 120.1551},
  'æˆéƒ½å¸‚': {lat: 30.5728, lng: 104.0668},
  'æ­¦æ±‰å¸‚': {lat: 30.5928, lng: 114.3055},
  'é‡åº†å¸‚': {lat: 29.4316, lng: 106.9123},
  'æµ·å—çœ, æµ·å£å¸‚': {lat: 20.0444, lng: 110.1989},
  'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº, å—å®å¸‚': {lat: 22.8170, lng: 108.3665},
  'è´µå·çœ, è´µé˜³å¸‚': {lat: 26.6470, lng: 106.6302},
  'è´µå·çœ, å…­ç›˜æ°´': {lat: 26.5918, lng: 104.8305},
  'äº‘å—çœ, æ˜†æ˜å¸‚': {lat: 25.0406, lng: 102.7129},
  'æ¹–å—çœ, é•¿æ²™å¸‚': {lat: 28.2278, lng: 112.9388},
  'æ±Ÿè¥¿çœ, å—æ˜Œå¸‚': {lat: 28.6829, lng: 115.8579},
  'ç¦å»ºçœ, ç¦å·å¸‚': {lat: 26.0745, lng: 119.2965},
  'æ¹–åŒ—çœ, æ­¦æ±‰å¸‚': {lat: 30.5928, lng: 114.3055},
  'å››å·çœ, å—å……å¸‚': {lat: 30.8376, lng: 106.1107},
  'å®‰å¾½çœ, åˆè‚¥å¸‚': {lat: 31.8206, lng: 117.2272},
  'æµ™æ±Ÿçœ, æ­å·å¸‚': {lat: 30.2741, lng: 120.1551},
  'é™•è¥¿çœ, è¥¿å®‰å¸‚': {lat: 34.3416, lng: 108.9398},
  'æ±Ÿè‹çœ, æ— é”¡å¸‚': {lat: 31.4912, lng: 120.3119},
  'æ²³å—çœ, éƒ‘å·å¸‚': {lat: 34.7472, lng: 113.6249}
}

@Component
export struct RegionView {
  @State searchText: string = ''
  @StorageLink('currentCity') currentCity: string = 'å®šä½ä¸­...'
  @StorageLink('currentAdcode') currentAdcode: string = ''
  @State actualLocationCity: string = ''  // GPSå®šä½çš„çœŸå®åŸå¸‚å
  @State isAnimating: boolean = false
  @State firstLoad: boolean = true  // é¦–æ¬¡åŠ è½½æ ‡å¿—ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  @State swipeOffsets: Map<string, number> = new Map()  // æ‰‹åŠ¨æ»‘åŠ¨çŠ¶æ€ç®¡ç†
  @State isRefreshingLocation: boolean = false  // GPSå®šä½ä¸­
  private lastUpdateTime: number = 0  // èŠ‚æµï¼šä¸Šæ¬¡æ›´æ–°æ—¶é—´
  private pendingOffset: Map<string, number> = new Map()  // èŠ‚æµï¼šå¾…æ›´æ–°çš„åç§»å€¼
  private swipeStartTime: number = 0  // æ‰‹åŠ¿å¼€å§‹æ—¶é—´
  private isSwipeGesture: boolean = false  // æ˜¯å¦ä¸ºæ‰‹åŠ¿æ»‘åŠ¨ï¼ˆåŒºåˆ†ç‚¹å‡»å’Œæ»‘åŠ¨ï¼‰
  private cachedLocation: LocationInfo | null = null  // ç¼“å­˜çš„GPSä½ç½®ï¼Œç”¨äºå¿«é€Ÿå“åº”
  @StorageLink('safeTop') safeTop: number = 44
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('vibrationEnabled') vibrationEnabled: boolean = false  // éœ‡åŠ¨åé¦ˆå¼€å…³
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'  // èŠ±ç²‰ä¸»é¢˜è‰²
  @StorageLink('pollenThemeTextColor') pollenThemeTextColor: string = '#2E7D32' // èŠ±ç²‰ä¸»é¢˜æ–‡å­—è‰²
  @StorageLink('pollenDataSource') dataSourceType: string = 'AUTO' // å½“å‰æ•°æ®æºç±»å‹
  
  // å…è´¹ç‰ˆæ”¶è—ä¸Šé™ï¼Œåç»­å¯ä¸ä¼šå‘˜ä½“ç³»æ‰“é€š
  private readonly MAX_FREE_FAVORITES: number = 4

  // å½“å‰å¤„äºæ»‘åŠ¨å±•å¼€çŠ¶æ€çš„ keyï¼ˆåŸå¸‚æˆ–åŒºå¿ï¼‰
  private currentSwipeKey: string = ''
  
  private locationService: LocationService = LocationService.getInstance()

  // æ»šåŠ¨æ§åˆ¶å™¨
  private scroller: Scroller = new Scroller()

  // å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®çš„å®šæ—¶å™¨
  private pollenUpdateTimer: number | null = null

  // æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´
  private lastPollenUpdateTime: number = 0

  // æ”¶è—çš„åŸå¸‚åˆ—è¡¨ï¼ˆç”¨äºâ€œæˆ‘çš„æ”¶è—â€Tabï¼‰
  @State favoriteCities: string[] = []

  // çƒ­é—¨/æ”¶è— Tab å½“å‰ç´¢å¼•ï¼š0=çƒ­é—¨åŸå¸‚ï¼Œ1=æˆ‘çš„æ”¶è—
  @State hotTabIndex: number = 0

  // çƒ­é—¨åŸå¸‚åˆ—è¡¨
  @State hotCities: string[] = ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'å¹¿å·å¸‚', 'æ·±åœ³å¸‚', 'æ­å·å¸‚', 'æˆéƒ½å¸‚', 'æ­¦æ±‰å¸‚', 'é‡åº†å¸‚']

  // åŸå¸‚åˆ—è¡¨æ•°æ®ï¼ˆåˆå§‹åŒ–æ—¶æ·»åŠ æ‹¼éŸ³å’Œçœä»½ä¿¡æ¯ï¼‰
  @State cityList: CityItem[] = [
    { name: 'åŒ—äº¬å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'åŒ—äº¬', pinyin: 'beijing', pinyinInitial: 'B' },
    { name: 'ä¸Šæµ·å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'ä¸Šæµ·', pinyin: 'shanghai', pinyinInitial: 'S' },
    { name: 'å¹¿å·å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'å¹¿ä¸œ', pinyin: 'guangzhou', pinyinInitial: 'G' },
    { name: 'æ·±åœ³å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'å¹¿ä¸œ', pinyin: 'shenzhen', pinyinInitial: 'S' },
    { name: 'æ­å·å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'æµ™æ±Ÿ', pinyin: 'hangzhou', pinyinInitial: 'H' },
    { name: 'æˆéƒ½å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'å››å·', pinyin: 'chengdu', pinyinInitial: 'C' },
    { name: 'æ­¦æ±‰å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'æ¹–åŒ—', pinyin: 'wuhan', pinyinInitial: 'W' },
    { name: 'é‡åº†å¸‚', distance: 0, isFavorite: false, isTop: false, province: 'é‡åº†', pinyin: 'chongqing', pinyinInitial: 'C' },
    { name: 'æµ·å—çœ, æµ·å£å¸‚', distance: 16, isFavorite: false, isTop: false, province: 'æµ·å—', pinyin: 'haikou', pinyinInitial: 'H' },
    { name: 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº, å—å®å¸‚', distance: 363, isFavorite: false, isTop: false, province: 'å¹¿è¥¿', pinyin: 'nanning', pinyinInitial: 'N' },
    { name: 'è´µå·çœ, è´µé˜³å¸‚', distance: 820, isFavorite: false, isTop: false, province: 'è´µå·', pinyin: 'guiyang', pinyinInitial: 'G' },
    { name: 'è´µå·çœ, å…­ç›˜æ°´', distance: 911, isFavorite: false, isTop: false, province: 'è´µå·', pinyin: 'liupanshui', pinyinInitial: 'L' },
    { name: 'äº‘å—çœ, æ˜†æ˜å¸‚', distance: 926, isFavorite: false, isTop: false, province: 'äº‘å—', pinyin: 'kunming', pinyinInitial: 'K' },
    { name: 'æ¹–å—çœ, é•¿æ²™å¸‚', distance: 953, isFavorite: false, isTop: false, province: 'æ¹–å—', pinyin: 'changsha', pinyinInitial: 'C' },
    { name: 'æ±Ÿè¥¿çœ, å—æ˜Œå¸‚', distance: 1121, isFavorite: false, isTop: false, province: 'æ±Ÿè¥¿', pinyin: 'nanchang', pinyinInitial: 'N' },
    { name: 'ç¦å»ºçœ, ç¦å·å¸‚', distance: 1151, isFavorite: false, isTop: false, province: 'ç¦å»º', pinyin: 'fuzhou', pinyinInitial: 'F' },
    { name: 'æ¹–åŒ—çœ, æ­¦æ±‰å¸‚', distance: 1244, isFavorite: false, isTop: false, province: 'æ¹–åŒ—', pinyin: 'wuhan', pinyinInitial: 'W' },
    { name: 'å››å·çœ, å—å……å¸‚', distance: 1267, isFavorite: false, isTop: false, province: 'å››å·', pinyin: 'nanchong', pinyinInitial: 'N' },
    { name: 'å®‰å¾½çœ, åˆè‚¥å¸‚', distance: 1487, isFavorite: false, isTop: false, province: 'å®‰å¾½', pinyin: 'hefei', pinyinInitial: 'H' },
    { name: 'æµ™æ±Ÿçœ, æ­å·å¸‚', distance: 1519, isFavorite: false, isTop: false, province: 'æµ™æ±Ÿ', pinyin: 'hangzhou', pinyinInitial: 'H' },
    { name: 'é™•è¥¿çœ, è¥¿å®‰å¸‚', distance: 1593, isFavorite: false, isTop: false, province: 'é™•è¥¿', pinyin: 'xian', pinyinInitial: 'X' },
    { name: 'æ±Ÿè‹çœ, æ— é”¡å¸‚', distance: 1627, isFavorite: false, isTop: false, province: 'æ±Ÿè‹', pinyin: 'wuxi', pinyinInitial: 'W' },
    { name: 'æ²³å—çœ, éƒ‘å·å¸‚', distance: 1669, isFavorite: false, isTop: false, province: 'æ²³å—', pinyin: 'zhengzhou', pinyinInitial: 'Z' }
  ]

  // åˆ†ç»„æ˜¾ç¤ºæ¨¡å¼ï¼š'province' | 'alphabet' | 'none'
  @State displayMode: 'province' | 'alphabet' | 'none' = 'province'

  // èŠ±ç²‰æ•°æ®ç¼“å­˜
  @State pollenDataCache: Map<string, PollenCacheData> = new Map()

  // åˆ†ç»„å±•å¼€çŠ¶æ€ï¼ˆæ”¹ç”¨æ•°ç»„ï¼Œè§£å†³Setä¸è§¦å‘å“åº”å¼æ›´æ–°é—®é¢˜ï¼‰
  @State expandedGroups: string[] = []

  // ====== åŒºå¿é€‰æ‹©ç›¸å…³çŠ¶æ€ ======
  @State allCitiesData: CityItem[] = []  // å®Œæ•´åŸå¸‚æ•°æ®ï¼ˆåŒ…å«åŒºå¿ä¿¡æ¯ï¼‰
  @State showDistrictDialog: boolean = false  // æ˜¯å¦æ˜¾ç¤ºåŒºå¿é€‰æ‹©å¼¹çª—
  @State selectedCityForDistrict: CityItem | null = null  // å½“å‰é€‰ä¸­è¦æŸ¥çœ‹åŒºå¿çš„åŸå¸‚

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ’­æ”¾åŠ¨ç”»(ä»…é¦–æ¬¡åŠ è½½ä¸”å‰10é¡¹)
  shouldAnimate(index: number): boolean {
    return this.firstLoad && index < 10
  }

  // Haversine è·ç¦»è®¡ç®—å‡½æ•°ï¼ˆè¿”å›å…¬é‡Œæ•°ï¼‰
  calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {
    const R = 6371 // åœ°çƒåŠå¾„(km)
    const dLat = this.deg2rad(lat2 - lat1)
    const dLng = this.deg2rad(lng2 - lng1)

    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2)

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
    return Math.round(R * c) // å››èˆäº”å…¥åˆ°æ•´æ•°å…¬é‡Œ
  }

  // è§’åº¦è½¬å¼§åº¦
  deg2rad(deg: number): number {
    return deg * (Math.PI / 180)
  }

  // è·å–åŸå¸‚èŠ±ç²‰æµ“åº¦ç­‰çº§ï¼ˆæ¨¡æ‹Ÿæ–¹æ³•ï¼Œå®é™…éœ€è¦ä»ç¼“å­˜æˆ–APIè·å–ï¼‰
  getPollenLevelForCity(cityName: string): number {
    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¼“å­˜çš„èŠ±ç²‰æ•°æ®
    const cacheData = this.pollenDataCache.get(cityName)
    if (cacheData) {
      return cacheData.level
    }
    return -1 // æ— æ•°æ®
  }

  // æ ¹æ®èŠ±ç²‰ç­‰çº§è·å–é¢œè‰² (ç¡®ä¿å¯¹æ¯”åº¦ â‰¥ 3:1)
  getPollenColor(level: number): ResourceColor {
    switch (level) {
      case 0:
        return '#4CAF50' // æ— /æä½ - ç»¿è‰²
      case 1:
        return '#8BC34A' // å¾ˆä½ - æµ…ç»¿
      case 2:
        return '#AFB42B' // ä½ - æ©„æ¦„ç»¿ (æ¯”åŸæ¥çš„ #CDDC39 æ›´æ·±ï¼Œç¡®ä¿å¯è§åº¦)
      case 3:
        return '#FBC02D' // ä¸­ - æ·±é»„
      case 4:
        return '#F57C00' // é«˜ - æ·±æ©™
      case 5:
        return '#D32F2F' // å¾ˆé«˜ - æ·±çº¢
      default:
        return '#757575' // æ— æ•°æ® - ç°è‰²
    }
  }


  // è¿‡æ»¤åŸå¸‚åˆ—è¡¨
  getFilteredCities(): CityItem[] {
    let targetList = this.cityList
    const isGoogle = this.dataSourceType === PollenDataSourceType.GOOGLE
    
    console.info(`[RegionView] ğŸ” è¿‡æ»¤é€»è¾‘è§¦å‘: dataSourceType=${this.dataSourceType}, isGoogle=${isGoogle}, searchText="${this.searchText}"`)

    if (this.searchText && this.searchText.trim() !== '') {
      if (isGoogle) {
        // Google æ¨¡å¼ï¼šä¸¥æ ¼é™åˆ¶åœ¨åŸºç¡€ 20 ä¸ªåŸå¸‚ä¸­æœç´¢
        targetList = searchCities(this.cityList, this.searchText)
        console.info(`[RegionView] Google æœç´¢æ¨¡å¼ï¼ŒåŒ¹é…æ•°é‡: ${targetList.length}`)
      } else {
        // å›½å†…æºï¼šæ”¯æŒå…¨å›½ 3200+ åŒºåŸŸæœç´¢
        if (this.allCitiesData && this.allCitiesData.length > 0) {
          targetList = searchCities(this.allCitiesData, this.searchText)
          if (targetList.length > 50) {
            targetList = targetList.slice(0, 50)
          }
          console.info(`[RegionView] å›½å†…æºæœç´¢æ¨¡å¼ï¼ŒåŒ¹é…æ•°é‡: ${targetList.length}`)
        } else {
          targetList = searchCities(this.cityList, this.searchText)
        }
      }
    } else {
      // æ— æœç´¢æ—¶
      if (isGoogle) {
        // Google æ¨¡å¼ï¼šåªæ˜¾ç¤ºåŸºç¡€åˆ—è¡¨ (çº¦20ä¸ªåŸå¸‚)
        targetList = this.cityList
        console.info(`[RegionView] Google æ¨¡å¼ - æ˜¾ç¤ºåŸºç¡€åŸå¸‚åˆ—è¡¨ (${targetList.length}ä¸ª)`)
      } else {
        // å›½å†…æº/AUTO æ¨¡å¼ï¼šæ˜¾ç¤ºå…¨å›½ 3200+ åŒºåŸŸåˆ—è¡¨ï¼ˆæŒ‰çœä»½åˆ†ç»„ï¼‰
        if (this.allCitiesData && this.allCitiesData.length > 0) {
          targetList = this.allCitiesData
          console.info(`[RegionView] å›½å†…æºæ¨¡å¼ - æ˜¾ç¤ºå…¨é‡åŸå¸‚åˆ—è¡¨ (${targetList.length}ä¸ª)`)
        } else {
          targetList = this.cityList
        }
      }
    }

    return sortCities(targetList)
  }

  // è·å–åˆ†ç»„åçš„åŸå¸‚åˆ—è¡¨
  getGroupedCities(): CityGroup[] {
    const filteredCities = this.getFilteredCities()
    console.info(`[RegionView] getGroupedCities - displayMode: ${this.displayMode}, filteredCities æ•°é‡: ${filteredCities.length}`)

    if (this.displayMode === 'province') {
      const groups = groupCitiesByProvince(filteredCities)
      console.info(`[RegionView] groupCitiesByProvince è¿”å› ${groups.length} ä¸ªçœä»½åˆ†ç»„`)
      
      // åº”ç”¨å±•å¼€çŠ¶æ€
      const result: CityGroup[] = []
      for (let i = 0; i < groups.length; i++) {
        const group = groups[i]
        const updatedGroup: CityGroup = {
          key: group.key,
          title: group.title,
          cities: group.cities,
          isExpanded: this.expandedGroups.includes(group.key)
        }
        console.info(`[RegionView] åˆ†ç»„ ${group.title} (${group.key}): isExpanded=${updatedGroup.isExpanded}, cities=${group.cities.length}`)
        result.push(updatedGroup)
      }
      return result
    } else if (this.displayMode === 'alphabet') {
      return groupCitiesByAlphabet(filteredCities)
    } else {
      // ä¸åˆ†ç»„ï¼Œè¿”å›å•ä¸ªåˆ†ç»„
      const allGroup: CityGroup = {
        key: 'all',
        title: 'å…¨éƒ¨',
        cities: filteredCities
      }
      return [allGroup]
    }
  }

  // è·å–å­—æ¯ç´¢å¼•åˆ—è¡¨ï¼ˆç”¨äºå³ä¾§å¯¼èˆªï¼‰
  getAlphabetIndex(): string[] {
    if (this.displayMode !== 'alphabet') {
      return []
    }

    const groups = groupCitiesByAlphabet(this.getFilteredCities())
    const result: string[] = []
    for (let i = 0; i < groups.length; i++) {
      result.push(groups[i].key)
    }
    return result
  }

  // åˆ‡æ¢åˆ†ç»„å±•å¼€çŠ¶æ€
  toggleGroup(groupKey: string): void {
    console.info(`[RegionView] toggleGroup è¢«è°ƒç”¨ï¼ŒgroupKey: ${groupKey}`)
    console.info(`[RegionView] å±•å¼€å‰ expandedGroups:`, this.expandedGroups)

    // ä½¿ç”¨ä¸å¯å˜æ•°ç»„æ›´æ–°æ–¹å¼ï¼Œç¡®ä¿è§¦å‘å“åº”å¼æ›´æ–°ï¼ˆé¿å…ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ï¼‰
    let newExpandedGroups: string[]
    if (this.expandedGroups.includes(groupKey)) {
      // åˆ é™¤ï¼šè¿‡æ»¤å‡ºå½“å‰ keyï¼Œåˆ›å»ºæ–°æ•°ç»„è§¦å‘å“åº”å¼æ›´æ–°
      newExpandedGroups = this.expandedGroups.filter(k => k !== groupKey)
      console.info(`[RegionView] åˆ é™¤ ${groupKey}ï¼Œç°åœ¨æŠ˜å `)
    } else {
      // æ·»åŠ ï¼šä½¿ç”¨ concat åˆ›å»ºæ–°æ•°ç»„ï¼Œè§¦å‘å“åº”å¼æ›´æ–°
      newExpandedGroups = this.expandedGroups.concat([groupKey])
      console.info(`[RegionView] æ·»åŠ  ${groupKey}ï¼Œç°åœ¨å±•å¼€`)
    }
    this.expandedGroups = newExpandedGroups

    console.info(`[RegionView] å±•å¼€å expandedGroups:`, this.expandedGroups)

    // âœ¨ åŠ¨ç”»æ•ˆæœï¼ˆå¯é€‰ï¼Œç”¨äºå¹³æ»‘è¿‡æ¸¡ï¼‰
    // æ³¨æ„ï¼šçŠ¶æ€å·²æ›´æ–°ï¼ŒåŠ¨ç”»åªæ˜¯è§†è§‰æ•ˆæœ
    animateTo({
      duration: 200,  // åŠ¨ç”»æ—¶é•¿ 200msï¼ˆç¼©çŸ­ä»¥æé«˜å“åº”é€Ÿåº¦ï¼‰
      curve: Curve.EaseInOut
    }, () => {
      // ç©ºå›è°ƒï¼ŒçŠ¶æ€å·²åœ¨ä¸Šé¢æ›´æ–°
    })
  }

  // æ›´æ–°æ‰€æœ‰åŸå¸‚è·ç¦»ï¼ˆåŸºäº GPS å®é™…ä½ç½®ï¼‰
  updateAllDistances(): void {
    // å¦‚æœæ²¡æœ‰GPSä½ç½®ï¼Œä¸è®¡ç®—è·ç¦»
    if (!this.actualLocationCity) {
      console.warn(`[RegionView] GPSä½ç½®æœªè·å–ï¼Œæ— æ³•è®¡ç®—è·ç¦»`)
      return
    }

    const gpsCoords = cityCoordinates[this.actualLocationCity]
    if (!gpsCoords) {
      console.warn(`[RegionView] æ‰¾ä¸åˆ°GPSåŸå¸‚åæ ‡: ${this.actualLocationCity}`)
      return
    }

    // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘å“åº”å¼æ›´æ–°
    const updatedCityList: CityItem[] = []
    for (let i = 0; i < this.cityList.length; i++) {
      const city = this.cityList[i]
      const cityCoords = cityCoordinates[city.name]
      const distance = cityCoords
        ? this.calculateDistance(
            gpsCoords.lat, gpsCoords.lng,
            cityCoords.lat, cityCoords.lng
          )
        : 0

      const newCity: CityItem = {
        name: city.name,
        distance: distance,
        isFavorite: city.isFavorite,
        isTop: city.isTop,
        province: city.province || extractProvince(city.name),
        pinyin: city.pinyin || getCityPinyin(city.name),
        pinyinInitial: city.pinyinInitial || getPinyinInitial(city.name),
        pollenLevel: city.pollenLevel,
        pollenIndex: city.pollenIndex
      }
      updatedCityList.push(newCity)
    }
    this.cityList = updatedCityList

    console.info(`[RegionView] å·²æ›´æ–°æ‰€æœ‰åŸå¸‚è·ç¦»ï¼ŒGPSä½ç½®: ${this.actualLocationCity}`)
  }

  // åŠ è½½åŸå¸‚èŠ±ç²‰æ•°æ®ï¼ˆæ‰¹é‡è·å–ï¼‰
  async loadPollenDataForCities(): Promise<void> {
    const pollenService = PollenService.getInstance()

    // æ‰¹é‡è·å–èŠ±ç²‰æ•°æ®ï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰
    const batchSize = 5
    for (let i = 0; i < this.cityList.length; i += batchSize) {
      const batch: CityItem[] = []
      const endIndex = Math.min(i + batchSize, this.cityList.length)
      for (let j = i; j < endIndex; j++) {
        batch.push(this.cityList[j])
      }

      const promises: Promise<void>[] = []
      for (let k = 0; k < batch.length; k++) {
        const city = batch[k]
        promises.push((async () => {
        try {
          const coords = cityCoordinates[city.name]
          if (!coords) return

          const response = await pollenService.getPollenForecast(coords.lat, coords.lng, 1)
          if (response && response.dailyInfo && response.dailyInfo.length > 0) {
            const todayInfo = response.dailyInfo[0]
            const maxLevel = getMaxPollenFromDaily(todayInfo)

            // è·å–èŠ±ç²‰æŒ‡æ•°å€¼
            let pollenIndexValue = 0
            if (todayInfo.pollenTypeInfo) {
              for (let m = 0; m < todayInfo.pollenTypeInfo.length; m++) {
                if (todayInfo.pollenTypeInfo[m].indexInfo) {
                  pollenIndexValue = todayInfo.pollenTypeInfo[m].indexInfo?.value || 0
                  break
                }
              }
            }

            // æ›´æ–°ç¼“å­˜
            const cacheData: PollenCacheData = {
              level: maxLevel,
              index: pollenIndexValue
            }
            this.pollenDataCache.set(city.name, cacheData)

            // æ›´æ–°åŸå¸‚åˆ—è¡¨ - åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘UIæ›´æ–°
            const updatedCityList: CityItem[] = []
            for (let n = 0; n < this.cityList.length; n++) {
              const oldCity = this.cityList[n]
              if (oldCity.name === city.name) {
                // æ›´æ–°å½“å‰åŸå¸‚çš„æ•°æ®
                const updatedCity: CityItem = {
                  name: oldCity.name,
                  distance: oldCity.distance,
                  isFavorite: oldCity.isFavorite,
                  isTop: oldCity.isTop,
                  province: oldCity.province,
                  pinyin: oldCity.pinyin,
                  pinyinInitial: oldCity.pinyinInitial,
                  pollenLevel: maxLevel,
                  pollenIndex: pollenIndexValue
                }
                updatedCityList.push(updatedCity)
              } else {
                updatedCityList.push(oldCity)
              }
            }
            this.cityList = updatedCityList
          }
        } catch (error) {
          console.warn(`[RegionView] è·å– ${city.name} èŠ±ç²‰æ•°æ®å¤±è´¥: ${JSON.stringify(error)}`)
        }
        })())
      }

      await Promise.all(promises)

      // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
      await new Promise<void>(resolve => setTimeout(resolve, 100))
    }

    console.info(`[RegionView] å·²å®Œæˆ ${this.cityList.length} ä¸ªåŸå¸‚çš„èŠ±ç²‰æ•°æ®åŠ è½½`)
  }

  // åˆ‡æ¢åŸå¸‚/åŒºå¿æ”¶è—çŠ¶æ€
  toggleFavorite(displayName: string): void {
    if (!displayName || displayName.trim() === '') {
      return
    }

    // 1. æŸ¥æ‰¾æ˜¯å¦å‘½ä¸­åŸå¸‚åˆ—è¡¨ï¼ˆæ”¯æŒåç§°åŒ…å«å…³ç³»ï¼Œä¾‹å¦‚â€œæµ·å—çœ, æµ·å£å¸‚â€ä¸â€œæµ·å£å¸‚â€ï¼‰
    let foundIndex = -1
    for (let j = 0; j < this.cityList.length; j++) {
      const name = this.cityList[j].name
      if (name === displayName || name.indexOf(displayName) >= 0 || displayName.indexOf(name) >= 0) {
        foundIndex = j
        break
      }
    }

    // 2. å½“å‰æ”¶è—çŠ¶æ€
    let currentlyFavorite = false
    if (foundIndex >= 0) {
      currentlyFavorite = this.cityList[foundIndex].isFavorite
    } else {
      currentlyFavorite = this.favoriteCities.includes(displayName)
    }
    const nextFavorite = !currentlyFavorite

    // 2.5 å…è´¹ç‰ˆæ”¶è—æ•°é‡é™åˆ¶ï¼šæ–°å¢ä¸”å·²è¾¾ä¸Šé™æ—¶æç¤ºå¹¶è¿”å›
    if (nextFavorite && !currentlyFavorite) {
      if (this.favoriteCities.length >= this.MAX_FREE_FAVORITES) {
        this.getUIContext().getPromptAction().showToast({
          message: `æŠ±æ­‰ï¼Œå½“å‰æœ€å¤šä»…æ”¯æŒæ”¶è— ${this.MAX_FREE_FAVORITES} é¡¹`,
          duration: 2000
        })
        return
      }
    }

    // 3. æ›´æ–°åŸå¸‚åˆ—è¡¨ï¼ˆå¦‚æœå‘½ä¸­åŸå¸‚ï¼‰
    if (foundIndex >= 0) {
      // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘ UI åˆ·æ–°
      const newList: CityItem[] = []
      for (let i = 0; i < this.cityList.length; i++) {
        newList.push(this.cityList[i])
      }
      const city = newList[foundIndex]
      const updatedCity: CityItem = {
        name: city.name,
        distance: city.distance,
        isFavorite: nextFavorite,
        isTop: nextFavorite ? city.isTop : false, // å–æ¶ˆæ”¶è—æ—¶åŒæ—¶å–æ¶ˆç½®é¡¶
        province: city.province,
        pinyin: city.pinyin,
        pinyinInitial: city.pinyinInitial,
        pollenLevel: city.pollenLevel,
        pollenIndex: city.pollenIndex
      }
      newList[foundIndex] = updatedCity
      this.cityList = newList
    }

    // 4. æ›´æ–°æ”¶è—åç§°åˆ—è¡¨ï¼ˆç”¨äºâ€œæˆ‘çš„æ”¶è—â€Tab å’ŒæŒä¹…åŒ–ï¼‰
    const indexInFavorites = this.favoriteCities.indexOf(displayName)
    const newFavorites: string[] = []
    for (let i = 0; i < this.favoriteCities.length; i++) {
      newFavorites.push(this.favoriteCities[i])
    }

    if (nextFavorite) {
      if (indexInFavorites < 0) {
        newFavorites.push(displayName)
      }
    } else {
      if (indexInFavorites >= 0) {
        newFavorites.splice(indexInFavorites, 1)
      }
    }
    this.favoriteCities = newFavorites

    // æŒä¹…åŒ–åˆ°å…¨å±€å­˜å‚¨ï¼Œä¾¿äºä¸‹æ¬¡å¯åŠ¨æ¢å¤
    AppStorage.setOrCreate<string[]>('favoriteCities', newFavorites)

    // è½»å¾®éœ‡åŠ¨åé¦ˆ
    if (this.vibrationEnabled) {
      try {
        vibrator.startVibration({
          type: 'time',
          duration: 30
        }, {
          id: 0,
          usage: 'touch'
        })
      } catch (err) {
        console.warn('[RegionView] æ”¶è—éœ‡åŠ¨åé¦ˆå¤±è´¥')
      }
    }

    // è§†è§‰æç¤ºï¼šæ”¶è—/å–æ¶ˆæ”¶è—æç¤ºè¯­
    this.getUIContext().getPromptAction().showToast({
      message: nextFavorite ? `å·²åŠ å…¥æ”¶è—ï¼š${displayName}` : `å·²å–æ¶ˆæ”¶è—ï¼š${displayName}`,
      duration: 1200
    })
  }

  // ç½®é¡¶åŸå¸‚
  moveToTop(cityName: string): void {
    // æŸ¥æ‰¾ç´¢å¼•
    let foundIndex = -1
    for (let j = 0; j < this.cityList.length; j++) {
      if (this.cityList[j].name === cityName) {
        foundIndex = j
        break
      }
    }
    if (foundIndex >= 0) {
      // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘ UI åˆ·æ–°
      const newList: CityItem[] = []
      for (let i = 0; i < this.cityList.length; i++) {
        newList.push(this.cityList[i])
      }
      const city = newList[foundIndex]
      const updatedCity: CityItem = {
        name: city.name,
        distance: city.distance,
        isFavorite: true, // ç½®é¡¶çš„åŒæ—¶è‡ªåŠ¨æ”¶è—
        isTop: true,
        province: city.province,
        pinyin: city.pinyin,
        pinyinInitial: city.pinyinInitial,
        pollenLevel: city.pollenLevel,
        pollenIndex: city.pollenIndex
      }
      newList[foundIndex] = updatedCity
      this.cityList = newList
    }
  }

  // è·å–æ’åºåçš„åŸå¸‚åˆ—è¡¨ï¼ˆä½¿ç”¨å·¥å…·ç±»æ’åºï¼‰
  getSortedCities(): CityItem[] {
    return sortCities(this.cityList)
  }

  // é‡æ–°å®šä½åˆ°å½“å‰ä½ç½®ï¼ˆä¼˜åŒ–ï¼šç¼“å­˜å¿«é€Ÿå“åº” + åå°é™é»˜æ›´æ–°ï¼‰
  async refreshCurrentLocation(): Promise<void> {
    if (this.isRefreshingLocation) return

    console.info('[RegionView] å¿«é€Ÿåˆ·æ–°...')
    this.isRefreshingLocation = true

    try {
      // 1. å¿«é€Ÿå“åº”ï¼šä½¿ç”¨ç¼“å­˜ä½ç½®ç«‹å³æ›´æ–°è·ç¦»
      if (this.cachedLocation && this.cachedLocation.city) {
        console.info('[RegionView] ä½¿ç”¨ç¼“å­˜ä½ç½®å¿«é€Ÿå“åº”')
        this.updateAllDistances()  // åŸºäºç¼“å­˜è®¡ç®—è·ç¦»
      }

      // 2. ç«‹å³ç»“æŸåˆ·æ–°åŠ¨ç”»ï¼ˆç”¨æˆ·ä½“æ„Ÿå¿«ï¼‰
      this.isRefreshingLocation = false

      // 3. åå°é™é»˜æ›´æ–°GPSä½ç½®ï¼ˆä¸é˜»å¡ç”¨æˆ·æ“ä½œï¼‰
      this.silentRefreshGPS()
    } catch (error) {
      console.error(`[RegionView] åˆ·æ–°å¼‚å¸¸: ${JSON.stringify(error)}`)
      this.isRefreshingLocation = false
    }
  }

  // é™é»˜åˆ·æ–°GPSä½ç½®ï¼ˆåå°è¿è¡Œï¼Œä¸é˜»å¡ç•ŒUIï¼‰
  private silentRefreshGPS(): void {
    const timeoutId = setTimeout(() => {
      console.warn('[RegionView] åå°GPSå®šä½è¶…æ—¶')
    }, 5000)

    this.locationService.checkAndRequestPermission()
      .then((hasPermission: boolean) => {
        if (!hasPermission) {
          console.warn('[RegionView] æ— ä½ç½®æƒé™')
          clearTimeout(timeoutId)
          return Promise.reject('æ— æƒé™')
        }
        return this.locationService.getCurrentLocation()
      })
      .then((location: LocationInfo | null) => {
        clearTimeout(timeoutId)

        if (location !== null && location.city) {
          // æ›´æ–°ç¼“å­˜
          this.cachedLocation = location

          // ä¿å­˜GPSå®šä½çš„çœŸå®åŸå¸‚å
          this.actualLocationCity = location.city

          // æ›´æ–°GPSåŸå¸‚åæ ‡
          cityCoordinates[location.city] = {
            lat: location.latitude,
            lng: location.longitude
          }

          // é™é»˜æ›´æ–°è·ç¦»
          this.updateAllDistances()

          console.info(`[RegionView] åå°GPSåˆ·æ–°æˆåŠŸ: ${location.city}`)
        } else {
          console.warn('[RegionView] åå°GPSå®šä½å¤±è´¥')
        }
      })
      .catch((error: Error) => {
        clearTimeout(timeoutId)
        console.error(`[RegionView] åå°GPSå¼‚å¸¸: ${JSON.stringify(error)}`)
      })
  }

  // æ»‘åŠ¨æ“ä½œæŒ‰é’®æ„å»ºå™¨
  @Builder
  SwipeActionBuilder(city: CityItem) {
    Row() {
      // æ”¶è—/å–æ¶ˆæ”¶è—æŒ‰é’®
      Button(city.isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—')
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor(city.isFavorite ? '#666666' : '#FF6B35')
        .height('100%')
        .width(80)
        .onClick(() => {
          this.toggleFavorite(city.name)
        })

      // ç½®é¡¶æŒ‰é’®ï¼ˆä»…å¯¹å·²æ”¶è—çš„æ˜¾ç¤ºï¼‰
      if (city.isFavorite && !city.isTop) {
        Button('ç½®é¡¶')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#4CAF50')
          .height('100%')
          .width(60)
          .onClick(() => {
            this.moveToTop(city.name)
          })
      }
    }
    .height('100%')
  }

  // ç”Ÿå‘½å‘¨æœŸï¼šç»„ä»¶å³å°†å‡ºç°
  async aboutToAppear(): Promise<void> {
    // åŠ è½½æ‹¼éŸ³æ˜ å°„è¡¨ï¼ˆæ”¯æŒæ™ºèƒ½æœç´¢ï¼‰
    console.info('[RegionView] åŠ è½½æ‹¼éŸ³æ˜ å°„è¡¨...')
    await loadPinyinMap(getContext(this))
    console.info('[RegionView] æ‹¼éŸ³æ˜ å°„è¡¨åŠ è½½å®Œæˆ')
    
    // ã€æµ‹è¯•ä»£ç ã€‘åŠ è½½åŒºå¿æ•°æ®
    console.info('[RegionView-Test] å¼€å§‹åŠ è½½åŒºå¿æ•°æ®...')
    try {
      const startTime = Date.now()
      // ä¼ å…¥contextå‚æ•°
      const allCitiesWithDistricts = await loadChinaAreaData(getContext(this))
      const loadTime = Date.now() - startTime
      
      // âœ… ä¿å­˜åˆ°çŠ¶æ€å˜é‡
      this.allCitiesData = allCitiesWithDistricts
      
      console.info(`[RegionView-Test] âœ… åŠ è½½æˆåŠŸï¼`)
      console.info(`[RegionView-Test] æ€»åŸå¸‚æ•°ï¼š${allCitiesWithDistricts.length}`)
      console.info(`[RegionView-Test] åŠ è½½è€—æ—¶ï¼š${loadTime}ms`)
      
      // æµ‹è¯•æŸ¥æ‰¾å¹¿å·å¸‚
      const guangzhou = getCityWithDistricts(allCitiesWithDistricts, 'å¹¿å·å¸‚')
      if (guangzhou) {
        console.info(`[RegionView-Test] å¹¿å·å¸‚æ•°æ®ï¼š`)
        console.info(`  - åç§°: ${guangzhou.name}`)
        console.info(`  - çœä»½: ${guangzhou.province}`)
        console.info(`  - adcode: ${guangzhou.adcode}`)
        console.info(`  - åæ ‡: (${guangzhou.location?.lat}, ${guangzhou.location?.lng})`)
        console.info(`  - æœ‰åŒºå¿: ${guangzhou.hasDistricts}`)
        console.info(`  - åŒºå¿æ•°é‡: ${guangzhou.districts?.length || 0}`)
        
        if (guangzhou.districts && guangzhou.districts.length > 0) {
          console.info(`  - å‰3ä¸ªåŒºå¿ï¼š`)
          for (let i = 0; i < Math.min(3, guangzhou.districts.length); i++) {
            const district = guangzhou.districts[i]
            console.info(`    ${i+1}. ${district.name} - adcode: ${district.adcode}, åæ ‡: (${district.location.lat}, ${district.location.lng})`)
          }
        }
      } else {
        console.warn('[RegionView-Test] âš ï¸ æœªæ‰¾åˆ°å¹¿å·å¸‚æ•°æ®')
      }
      
    } catch (error) {
      console.error(`[RegionView-Test] âŒ åŠ è½½å¤±è´¥: ${JSON.stringify(error)}`)
    }
    console.info('[RegionView-Test] æµ‹è¯•å®Œæ¯•\n')
    // ã€æµ‹è¯•ä»£ç ç»“æŸã€‘

    // 1. ä» AppStorage è¯»å–å½“å‰åŸå¸‚ (ç”±äºä½¿ç”¨äº† @StorageLinkï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æ—¥å¿—)
    console.info(`[RegionView] å½“å‰åŸå¸‚: ${this.currentCity}, adcode: ${this.currentAdcode}`)

    // 1.5 ä» AppStorage è¯»å–æ”¶è—åˆ—è¡¨
    const storedFavorites = AppStorage.Get<string[]>('favoriteCities')
    if (storedFavorites && Array.isArray(storedFavorites)) {
      this.favoriteCities = storedFavorites
    }

    // 2. åˆå§‹åŒ–åŸå¸‚æ•°æ®ï¼ˆè¡¥å……æ‹¼éŸ³å’Œçœä»½ä¿¡æ¯ï¼‰
    const updatedCityList: CityItem[] = []
    for (let i = 0; i < this.cityList.length; i++) {
      const city = this.cityList[i]
      const isFav = this.favoriteCities.includes(city.name)
      const updatedCity: CityItem = {
        name: city.name,
        distance: city.distance,
        isFavorite: isFav,
        isTop: isFav ? city.isTop : false,
        province: city.province || extractProvince(city.name),
        pinyin: city.pinyin || getCityPinyin(city.name),
        pinyinInitial: city.pinyinInitial || getPinyinInitial(city.name),
        pollenLevel: city.pollenLevel,
        pollenIndex: city.pollenIndex
      }
      updatedCityList.push(updatedCity)
    }
    this.cityList = updatedCityList

    // 3. é»˜è®¤æ‰€æœ‰çœä»½åˆ†ç»„ä¸ºæŠ˜å çŠ¶æ€ï¼ˆç‚¹å‡»çœä»½åæ‰å±•å¼€ï¼‰
    // ä¸éœ€è¦è‡ªåŠ¨å±•å¼€ï¼Œç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡» toggleGroup() å±•å¼€

    // 4. æ— è®ºæ˜¯å¦æœ‰å­˜å‚¨åŸå¸‚ï¼Œéƒ½å°è¯•è·å– GPS ä½ç½®ï¼ˆæ˜¾ç¤º"å½“å‰ä½ç½®"æŒ‰é’®ï¼‰
    try {
      const hasPermission = await this.locationService.checkAndRequestPermission()
      if (hasPermission) {
        const location: LocationInfo | null = await this.locationService.getCurrentLocation()
        if (location !== null && location.city) {
          // ä¿å­˜GPSå®šä½çš„çœŸå®åŸå¸‚å
          this.actualLocationCity = location.city
          // ç¼“å­˜GPSä½ç½®ï¼Œä¾›åç»­å¿«é€Ÿåˆ·æ–°ä½¿ç”¨
          this.cachedLocation = location
          // å°† GPS ä½ç½®æ·»åŠ åˆ°åæ ‡è¡¨
          cityCoordinates[location.city] = {
            lat: location.latitude,
            lng: location.longitude
          }
          console.info(`[RegionView] GPSå®šä½æˆåŠŸ: ${location.city} (${location.latitude}, ${location.longitude})`)

          // GPSå®šä½æˆåŠŸåï¼Œç«‹å³è®¡ç®—è·ç¦»
          this.updateAllDistances()
        }
      }
    } catch (error) {
      console.warn(`[RegionView] GPSå®šä½å¤±è´¥: ${JSON.stringify(error)}`)
    }

    // 5. åå°åŠ è½½èŠ±ç²‰æ•°æ®ï¼ˆä¸é˜»å¡UIï¼‰
    this.loadPollenDataForCities().catch((err: Error) => {
      console.warn(`[RegionView] èŠ±ç²‰æ•°æ®åŠ è½½å¤±è´¥: ${JSON.stringify(err)}`)
    })

    // 6. å¯åŠ¨å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®
    this.startPollenDataUpdate()

    // 7. å»¶è¿Ÿè§¦å‘åŠ¨ç”»ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
    setTimeout(() => {
      this.isAnimating = true
    }, 50)
  }

  // ====== åŒºå¿é€‰æ‹©å¼¹çª— ======
  @Builder
  DistrictDialog() {
    Column() {
      // é¡¶éƒ¨å®‰å…¨è·ç¦»
      Blank().height(this.safeTop)

      // åŒºå¿åˆ—è¡¨ï¼ˆåŒ…å«å¸‚çº§é€‰é¡¹ï¼‰
      // ç»Ÿä¸€æ˜¾ç¤ºï¼Œæ— è®ºæœ‰æ— åŒºå¿
      if (!this.selectedCityForDistrict) {
        // æ²¡æœ‰é€‰ä¸­åŸå¸‚æ•°æ®ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰
        Column() {
          Text('æ•°æ®åŠ è½½å¤±è´¥')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 20, bottom: 20 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // åŒºå¿åˆ—è¡¨ï¼ˆåŒ…å«å¸‚çº§é€‰é¡¹ï¼‰
        List({ space: 0 }) {
          // é¦–é¡¹ï¼šæ•´ä¸ªå¸‚çº§é€‰é¡¹ï¼ˆæ”¯æŒæ‰‹åŠ¿ï¼‰
          ListItem() {
            Stack({ alignContent: Alignment.End }) {
              // èƒŒæ™¯å±‚ï¼šæ“ä½œæŒ‰é’®
              Row() {
                Button({ type: ButtonType.Normal }) {
                  Text(this.favoriteCities.includes(this.selectedCityForDistrict.name) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—')
                    .fontSize(14)
                    .fontColor(Color.White)
                }
                .width(80)
                .height('100%')
                .backgroundColor(this.favoriteCities.includes(this.selectedCityForDistrict.name) ? '#666666' : '#FF6B35')
                .onClick(() => {
                  const cityName = this.selectedCityForDistrict?.name || ''
                  this.toggleFavorite(cityName)
                  animateTo({ duration: 200 }, () => {
                    this.swipeOffsets.set(cityName, 0)
                  })
                })
              }
              .height('100%')
              
              // ä¸»å†…å®¹å±‚
              Row() {
                // å¸‚çº§å›¾æ ‡
                Image($r('app.media.icon_location'))
                  .width(18)
                  .height(18)
                  .fillColor(this.pollenThemeTextColor as ResourceColor)
                  .margin({ right: 12 })
                
                // å¸‚çº§åç§°
                Column() {
                  Row() {
                    if (this.favoriteCities.includes(this.selectedCityForDistrict.name)) {
                      Text('â˜… ')
                        .fontSize(14)
                        .fontColor(this.pollenThemeTextColor as ResourceColor)
                    }
                    Text(`æ•´ä¸ª${this.selectedCityForDistrict.name}`)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor($r('app.color.text_primary'))
                  }
                  
                  Text('æŸ¥çœ‹å¸‚çº§æ•´ä½“æ•°æ®')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)

                Blank()

                // ç®­å¤´å›¾æ ‡
                Image($r('app.media.icon_chevron_right'))
                  .width(16)
                  .height(16)
                  .fillColor(this.pollenThemeTextColor as ResourceColor)
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 16, bottom: 16 })
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(8)
              .translate({ x: this.swipeOffsets.get(this.selectedCityForDistrict.name) ?? 0 })
              .gesture(
                // ã€ä¼˜åŒ–3ã€‘æ‰‹åŠ¿æ–¹å‘é™åˆ¶ï¼ˆHorizontalï¼Œé¿å…ä¸å¼¹çª—çºµå‘æ‹–æ‹½å†²çªï¼‰
                PanGesture({ direction: PanDirection.Horizontal })
                  .onActionStart((event: GestureEvent) => {
                    this.swipeStartTime = Date.now()
                    this.isSwipeGesture = false

                    const cityName = this.selectedCityForDistrict?.name || ''
                    if (this.currentSwipeKey && this.currentSwipeKey !== cityName) {
                      // æ”¶èµ·ä¹‹å‰å±•å¼€çš„è¡Œ
                      animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                        this.swipeOffsets.set(this.currentSwipeKey, 0)
                      })
                    }
                    this.currentSwipeKey = cityName
                  })
                  .onActionUpdate((event: GestureEvent) => {
                    if (Math.abs(event.offsetX) > 10) {
                      this.isSwipeGesture = true
                    }
                    const cityName = this.selectedCityForDistrict?.name || ''
                    const currentOffset = this.swipeOffsets.get(cityName) ?? 0
                    const maxSwipe = -80
                    const newOffset = Math.max(maxSwipe, Math.min(0, currentOffset + event.offsetX))
                    const now = Date.now()
                    this.pendingOffset.set(cityName, newOffset)
                    if (now - this.lastUpdateTime >= 16) {
                      this.lastUpdateTime = now
                      this.swipeOffsets.set(cityName, newOffset)
                    }
                  })
                  .onActionEnd((event: GestureEvent) => {
                    const cityName = this.selectedCityForDistrict?.name || ''
                    const finalOffset = this.pendingOffset.get(cityName) ?? this.swipeOffsets.get(cityName) ?? 0
                    if (this.pendingOffset.has(cityName)) {
                      this.swipeOffsets.set(cityName, finalOffset)
                      this.pendingOffset.delete(cityName)
                    }
                    const velocity = event.velocityX
                    const threshold = -40
                    if (velocity < -800 || finalOffset < threshold) {
                      animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                        this.swipeOffsets.set(cityName, -80)
                      })
                    } else {
                      animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                        this.swipeOffsets.set(cityName, 0)
                      })
                    }
                  })
              )
              .onClick(() => {
                if (this.isSwipeGesture) {
                  this.isSwipeGesture = false
                  return
                }
                const cityName = this.selectedCityForDistrict?.name || ''
                const currentOffset = this.swipeOffsets.get(cityName) ?? 0
                if (currentOffset < -10) {
                  animateTo({ duration: 200 }, () => {
                    this.swipeOffsets.set(cityName, 0)
                  })
                } else {
                  this.selectCityOrDistrict(cityName, null)
                }
              })
            }
            .width('100%')
            .height(56)
            .margin({ left: 12, right: 12, top: 8, bottom: 4 })
          }
          .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
          
          // åˆ†å‰²çº¿å’ŒåŒºå¿åˆ—è¡¨ï¼ˆåªåœ¨æœ‰åŒºå¿æ—¶æ˜¾ç¤ºï¼‰
          if (this.selectedCityForDistrict.districts && this.selectedCityForDistrict.districts.length > 0) {
            // åˆ†å‰²çº¿
            ListItem() {
              Row() {
                Text('æˆ–é€‰æ‹©å…·ä½“åŒºå¿')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding({ left: 20, top: 12, bottom: 8 })
            }
            
            // åŒºå¿åˆ—è¡¨ï¼ˆæ”¯æŒæ‰‹åŠ¿ï¼‰
            ForEach(this.selectedCityForDistrict.districts, (district: DistrictItem, index: number) => {
            ListItem() {
              Stack({ alignContent: Alignment.End }) {
                // èƒŒæ™¯å±‚ï¼šæ“ä½œæŒ‰é’®
                Row() {
                  Button({ type: ButtonType.Normal }) {
                    Text(this.favoriteCities.includes(`${this.selectedCityForDistrict?.name || ''} - ${district.name}`) ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—')
                      .fontSize(14)
                      .fontColor(Color.White)
                  }
                  .width(80)
                  .height('100%')
                  .backgroundColor(this.favoriteCities.includes(`${this.selectedCityForDistrict?.name || ''} - ${district.name}`) ? '#666666' : '#FF6B35')
                  .onClick(() => {
                    const cityName = this.selectedCityForDistrict?.name || ''
                    const districtFullName = `${cityName} - ${district.name}`
                    this.toggleFavorite(districtFullName)
                    animateTo({ duration: 200 }, () => {
                      this.swipeOffsets.set(district.name, 0)
                    })
                  })
                }
                .height('100%')
                
                // ä¸»å†…å®¹å±‚
                Row() {
                  // åŒºå¿åç§°
                  Column() {
                    Row() {
                      if (this.favoriteCities.includes(`${this.selectedCityForDistrict?.name || ''} - ${district.name}`)) {
                        Text('â˜…')
                          .fontSize(14)
                          .fontColor(this.pollenThemeTextColor as ResourceColor)
                          .margin({ right: 4 })
                      }
                      Text(district.name)
                        .fontSize(16)
                        .fontColor($r('app.color.text_primary'))
                    }
                  }
                  .alignItems(HorizontalAlign.Start)

                  Blank()

                  // ç®­å¤´å›¾æ ‡
                  Image($r('app.media.icon_chevron_right'))
                    .width(16)
                    .height(16)
                    .fillColor(this.pollenThemeColor)
                }
                .width('100%')
                .padding({ left: 20, right: 20, top: 16, bottom: 16 })
                .backgroundColor($r('app.color.page_background'))
                .translate({ x: this.swipeOffsets.get(district.name) ?? 0 })
                .gesture(
                  // ã€ä¼˜åŒ–3ã€‘æ‰‹åŠ¿æ–¹å‘é™åˆ¶ï¼ˆHorizontalï¼Œé¿å…ä¸å¼¹çª—çºµå‘æ‹–æ‹½å†²çªï¼‰
                  PanGesture({ direction: PanDirection.Horizontal })
                    .onActionStart((event: GestureEvent) => {
                      this.swipeStartTime = Date.now()
                      this.isSwipeGesture = false

                      const key = district.name
                      if (this.currentSwipeKey && this.currentSwipeKey !== key) {
                        animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                          this.swipeOffsets.set(this.currentSwipeKey, 0)
                        })
                      }
                      this.currentSwipeKey = key
                    })
                    .onActionUpdate((event: GestureEvent) => {
                      if (Math.abs(event.offsetX) > 10) {
                        this.isSwipeGesture = true
                      }
                      const currentOffset = this.swipeOffsets.get(district.name) ?? 0
                      const maxSwipe = -80
                      const newOffset = Math.max(maxSwipe, Math.min(0, currentOffset + event.offsetX))
                      const now = Date.now()
                      this.pendingOffset.set(district.name, newOffset)
                      if (now - this.lastUpdateTime >= 16) {
                        this.lastUpdateTime = now
                        this.swipeOffsets.set(district.name, newOffset)
                      }
                    })
                    .onActionEnd((event: GestureEvent) => {
                      const finalOffset = this.pendingOffset.get(district.name) ?? this.swipeOffsets.get(district.name) ?? 0
                      if (this.pendingOffset.has(district.name)) {
                        this.swipeOffsets.set(district.name, finalOffset)
                        this.pendingOffset.delete(district.name)
                      }
                      const velocity = event.velocityX
                      const threshold = -40
                      if (velocity < -800 || finalOffset < threshold) {
                        animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                          this.swipeOffsets.set(district.name, -80)
                        })
                      } else {
                        animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                          this.swipeOffsets.set(district.name, 0)
                        })
                      }
                    })
                )
                .onClick(() => {
                  if (this.isSwipeGesture) {
                    this.isSwipeGesture = false
                    return
                  }
                  const currentOffset = this.swipeOffsets.get(district.name) ?? 0
                  if (currentOffset < -10) {
                    animateTo({ duration: 200 }, () => {
                      this.swipeOffsets.set(district.name, 0)
                    })
                  } else {
                    const cityName = this.selectedCityForDistrict?.name || ''
                    this.selectCityOrDistrict(cityName, district.name)
                  }
                })
              }
              .width('100%')
              .height(56)
            }
            .transition(TransitionEffect.OPACITY.animation({ duration: 200, delay: (index + 1) * 30 }))
          }, (district: DistrictItem) => district.name)
          }  // ç»“æŸ if (this.selectedCityForDistrict.districts && ...)
        }
        .width('100%')
        .divider({
          strokeWidth: 0.5,
          color: '#E0E0E0',
          startMargin: 20,
          endMargin: 20
        })
      }
    }
    .width('100%')
    .padding({ top: 8 })
  }

  @Builder
  CityItemComponent(city: CityItem) {
    // ç»Ÿä¸€ä¸ºç›®å½•æ ·å¼ï¼Œæ‰€æœ‰åŸå¸‚ç‚¹å‡»åéƒ½å¼¹å‡ºä¸‰çº§èœå•
    Row() {
      // ç›®å½•å›¾æ ‡
      Image($r('app.media.icon_chevron_right'))
        .width(12)
        .height(12)
        .fillColor(this.pollenThemeTextColor as ResourceColor)

      // åŸå¸‚åç§° + æ”¶è—çŠ¶æ€
      Column() {
        Row() {
          if (city.isFavorite) {
            Text('â˜…')
              .fontSize(14)
              .fontColor(this.pollenThemeTextColor as ResourceColor)
              .margin({ right: 4 })
          }
          Text(city.name)
            .fontSize(15)
            .fontColor($r('app.color.text_primary'))
        }
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })

      Blank()

      // èŠ±ç²‰ç­‰çº§æŒ‡ç¤º
      Column() {
        // ä»…ç”¨é¢œè‰²å°åœ†ç‚¹è¡¨ç¤ºèŠ±ç²‰çŠ¶æ€ï¼Œå…·ä½“æ•°å€¼ä»¥é¦–é¡µä¸ºå‡†
        if (city.pollenLevel !== undefined && city.pollenLevel >= 0) {
          Circle()
            .width(8)
            .height(8)
            .fill(this.getPollenColor(city.pollenLevel))
            .margin({ top: 4 })
        }
      }
      .alignItems(HorizontalAlign.End)
      
      // å³ç®­å¤´æç¤º
      Image($r('app.media.icon_chevron_right'))
        .width(16)
        .height(16)
        .fillColor($r('app.color.text_secondary'))
        .margin({ left: 8 })
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.page_background'))
    .onClick(() => {
      // ç»Ÿä¸€æ‰“å¼€ä¸‰çº§èœå•ï¼ˆåŸå¸‚é€‰æ‹©å¼¹çª—ï¼‰
      console.info(`[RegionView] ç‚¹å‡»åŸå¸‚: ${city.name}ï¼Œæ‰“å¼€é€‰æ‹©å¼¹çª—`)
      // æå–çº¯åŸå¸‚åï¼šå»é™¤çœä»½å‰ç¼€ï¼ˆä¾‹å¦‚ï¼š"å®‰å¾½çœ, åˆè‚¥å¸‚" â†’ "åˆè‚¥å¸‚"ï¼‰
      const pureCityName = city.name.includes(',') ? city.name.split(',')[1].trim() : city.name
      console.info(`[RegionView] æå–çº¯åŸå¸‚å: ${pureCityName}`)
      this.selectCity(pureCityName)
    })
    // å…¥åœºåŠ¨ç”»
    .scale({
      x: this.shouldAnimate(0) ? (this.isAnimating ? 1 : 0.95) : 1,
      y: this.shouldAnimate(0) ? (this.isAnimating ? 1 : 0.95) : 1
    })
    .animation({
      duration: 240,
      delay: this.firstLoad ? 0 : 0,
      curve: Curve.EaseOut,
      iterations: 1,
      playMode: PlayMode.Normal
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å®‰å…¨è·ç¦»
      Blank().height(this.safeTop)

      // æ ‡é¢˜æ 
      Row() {
        Text('åŒºåŸŸ')
          .fontSize(28)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })

      // æœç´¢æ¡†
      Row() {
        Image($r('app.media.icon_search'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.text_secondary'))
          .margin({ right: 8 })

        TextInput({ placeholder: 'æœç´¢ä½ æ„Ÿå…´è¶£çš„åŸå¸‚', text: this.searchText })
          .placeholderColor($r('app.color.text_secondary'))
          .fontColor($r('app.color.text_primary'))
          .backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchText = value
          })
      }
      .width('100%')
      .height(44)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(10)
      .padding({ left: 12, right: 12 })
      .margin({ left: 16, right: 16, bottom: 20 })

      // å½“å‰ä½ç½®åŒºåŸŸï¼ˆä»…å½“GPSå®šä½æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰
      if (this.actualLocationCity) {
        Column() {
          Text('å½“å‰ä½ç½®')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, bottom: 8 })

          Row() {
            Image($r('app.media.icon_location'))
              .width(16)
              .height(16)
              .fillColor($r('app.color.icon_primary'))

            Text(this.actualLocationCity)
              .fontSize(16)
              .fontColor($r('app.color.text_primary'))
              .margin({ left: 8 })

            Blank()
          }
          .width('100%')
          .height(50)
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(10)
          .padding({ left: 16, right: 16 })
          .margin({ left: 16, right: 16 })
          .onClick(() => {
            // actualLocationCity å·²ç»æ˜¯çº¯åŸå¸‚åï¼Œç›´æ¥ä½¿ç”¨
            this.selectCity(this.actualLocationCity)
          })
        }
        .margin({ bottom: 20 })
      }

      // çƒ­é—¨åŸå¸‚ / æˆ‘çš„æ”¶è—
      Column() {
        // é¡¶éƒ¨æ ‡ç­¾æ 
        Row() {
          Text('çƒ­é—¨åŸå¸‚')
            .fontSize(13)
            .fontColor(this.hotTabIndex === 0 ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
            .fontWeight(this.hotTabIndex === 0 ? FontWeight.Medium : FontWeight.Normal)
            .onClick(() => {
              this.hotTabIndex = 0
            })

          Text('æˆ‘çš„æ”¶è—')
            .fontSize(13)
            .fontColor(this.hotTabIndex === 1 ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
            .fontWeight(this.hotTabIndex === 1 ? FontWeight.Medium : FontWeight.Normal)
            .margin({ left: 24 })
            .onClick(() => {
              this.hotTabIndex = 1
            })

          Blank()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })

        // å†…å®¹åŒºåŸŸï¼šå·¦å³æ»‘åŠ¨åˆ‡æ¢
        Swiper() {
          // Tab 0: çƒ­é—¨åŸå¸‚
          // çƒ­é—¨åŸå¸‚ç½‘æ ¼å¸ƒå±€ - ä½¿ç”¨ Flex å®ç°æ¢è¡Œ
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.hotCities, (city: string, index: number) => {
              Text(city)
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(16)
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .margin({ right: 12, bottom: 12 })
                .onClick(() => {
                  // çƒ­é—¨åŸå¸‚åˆ—è¡¨ä¸­å·²ç»æ˜¯çº¯åŸå¸‚åï¼Œç›´æ¥ä½¿ç”¨
                  this.selectCity(city)
                })
                // å…¥åœºåŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
                .opacity(this.isAnimating ? 1 : 0)
                .translate({ y: this.isAnimating ? 0 : 30 })
                .animation({
                  duration: 280,
                  delay: this.firstLoad ? (index * 30) : 0,
                  curve: Curve.EaseOut
                })
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          // Tab 1: æˆ‘çš„æ”¶è—
          Flex({ wrap: FlexWrap.Wrap }) {
            if (!this.favoriteCities || this.favoriteCities.length === 0) {
              Text('è¿˜æ²¡æœ‰æ”¶è—åŸå¸‚ï¼Œè¯•è¯•åœ¨åˆ—è¡¨ä¸­å‘å·¦æ»‘åŠ¨æ·»åŠ æ”¶è—~')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .margin({ left: 16, right: 16, top: 8, bottom: 8 })
            } else {
              ForEach(this.favoriteCities, (favName: string, index: number) => {
                Row() {
                  Text('â˜…')
                    .fontSize(14)
                    .fontColor(this.pollenThemeColor as ResourceColor)
                    .margin({ right: 4 })
                  Text(favName)
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                }
                .backgroundColor($r('app.color.card_background'))
                .borderRadius(16)
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .margin({ right: 12, bottom: 12 })
                .onClick(() => {
                  // ç‚¹å‡»æ”¶è—é¡¹æ—¶ï¼Œé»˜è®¤ä»¥åŸå¸‚éƒ¨åˆ†è¿›è¡Œé€‰æ‹©
                  const parts = favName.split(' - ')
                  const cityPart = parts[0]
                  this.selectCity(cityPart)
                })
              })
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16 })
        }
        .index(this.hotTabIndex)
        .onChange((index: number) => {
          this.hotTabIndex = index
        })
        .width('100%')
        .height(128)
      }
      .margin({ bottom: 20 })

      // å…¨éƒ¨åœ°åŒºï¼ˆä¸‹æ‹‰åˆ·æ–°ï¼‰
      Refresh({ refreshing: $$this.isRefreshingLocation }) {
        Column() {
            // æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢æŒ‰é’®
            Row() {
              Button(this.displayMode === 'province' ? 'çœä»½' : (this.displayMode === 'alphabet' ? 'å­—æ¯' : 'åˆ—è¡¨'))
                .fontSize(12)
                .type(ButtonType.Capsule)
                .width(60)
                .height(28)
                .onClick(() => {
                  if (this.displayMode === 'province') {
                    this.displayMode = 'alphabet'
                  } else if (this.displayMode === 'alphabet') {
                    this.displayMode = 'none'
                  } else {
                    this.displayMode = 'province'
                  }
                })

              Blank()
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 8 })

            // åŸå¸‚åˆ—è¡¨ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
            List({ scroller: this.scroller }) {
              ForEach(this.getGroupedCities(), (group: CityGroup) => {
                // åˆ†ç»„æ ‡é¢˜
                if (this.displayMode === 'province') {
                  ListItem() {
                    Row() {
                      Text(group.title)
                        .fontSize(14)
                        .fontColor($r('app.color.text_primary'))
                        .fontWeight(FontWeight.Medium)

                      Blank()

                      Text(group.isExpanded ? 'â–¼' : 'â–¶')
                        .fontSize(10)
                        .fontColor($r('app.color.text_secondary'))
                    }
                    .width('100%')
                    .height(40)
                    .padding({ left: 16, right: 16 })
                    .backgroundColor($r('app.color.card_background'))
                  }
                  .onClick(() => {
                    console.info(`[RegionView] ç‚¹å‡»äº†çœä»½æ ‡é¢˜: ${group.title}, groupKey: ${group.key}`)
                    this.toggleGroup(group.key)
                  })
                } else if (this.displayMode === 'alphabet') {
                  ListItem() {
                    Row() {
                      Text(group.title)
                        .fontSize(14)
                        .fontColor($r('app.color.text_primary'))
                        .fontWeight(FontWeight.Medium)

                      Blank()
                    }
                    .width('100%')
                    .height(40)
                    .padding({ left: 16, right: 16 })
                    .backgroundColor($r('app.color.card_background'))
                  }
                }

                // åŸå¸‚åˆ—è¡¨ï¼ˆä»…åœ¨å±•å¼€æ—¶æ˜¾ç¤ºï¼‰
                if (this.displayMode !== 'province' || group.isExpanded) {
                  ForEach(group.cities, (city: CityItem) => {
                    ListItem() {
                      this.CityItemComponent(city)
                    }
                  }, (city: CityItem) => city.name)
                }
              }, (group: CityGroup) => group.key + '_' + (this.expandedGroups.includes(group.key) ? '1' : '0'))
            }
            .width('100%')
            .layoutWeight(1)
            .onDidScroll(() => {
              // æ»šåŠ¨æ—¶ç¦ç”¨åŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
              if (this.firstLoad) {
                this.firstLoad = false
              }
            })
            .divider({
              strokeWidth: 0.5,
              color: $r('app.color.divider_color'),
              startMargin: 40,
              endMargin: 16
            })
        }
        .width('100%')
        .layoutWeight(1)
      }
      .layoutWeight(1)
      .clip(true)  // è£å‰ªå†…å®¹ï¼Œé˜²æ­¢ç©¿é€åˆ°çŠ¶æ€æ 

      // ========== å¹¿å‘Šä½é¢„ç•™ï¼ˆå·²éšè—ï¼‰==========
      // TODO: åç»­å¯åœ¨æ­¤ä½ç½®æ·»åŠ å¹¿å‘Šç»„ä»¶
      // å»ºè®®ç±»å‹: Bannerå¹¿å‘Šã€æ¨å¹¿å¡ç‰‡ã€å¥åº·å°è´´å£«
      // å‚è€ƒé«˜åº¦: 60-80px
      // Blank().height(56)  // TabBar å ä½
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      if (isVisible && currentRatio >= 1.0) {
        // é¡µé¢å®Œå…¨å¯è§æ—¶è§¦å‘åŠ¨ç”»
        setTimeout(() => {
          animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
            this.isAnimating = true
          })
        }, 50)
      } else if (!isVisible || currentRatio < 0.5) {
        // é¡µé¢ä¸å¯è§æˆ–å¯è§æ¯”ä¾äº50%æ—¶é‡ç½®
        this.isAnimating = false
        // å¼ºåˆ¶åœæ­¢GPSåˆ·æ–°åŠ¨ç”»ï¼ˆé¿å…åå°èµ„æºå ç”¨ï¼‰
        if (this.isRefreshingLocation) {
          this.isRefreshingLocation = false
        }
        // é¡µé¢ä¸å¯è§æ—¶åœæ­¢èŠ±ç²‰æ•°æ®å®šæ—¶æ›´æ–°
        this.stopPollenDataUpdate();
      }
    })
    // ====== åŒºå¿é€‰æ‹©å¼¹çª— ======
    .bindSheet($$this.showDistrictDialog, this.DistrictDialog(), {
      // ã€ä¼˜åŒ–2ã€‘å¼¹çª—é«˜åº¦è‡ªé€‚åº”ï¼ˆæœ‰åŒºå¿70%ï¼Œæ— åŒºå¿30%ï¼‰
      height: (this.selectedCityForDistrict?.districts?.length || 0) > 0 ? '70%' : '30%',
      showClose: true,
      title: {
        title: `è¯·é€‰æ‹©${this.selectedCityForDistrict?.name || ''}çš„åŒºå¿`,
        subtitle: `å…± ${this.selectedCityForDistrict?.districts?.length || 0} ä¸ªåŒºå¿`
      },
      // ã€ä¼˜åŒ–4ã€‘å¼¹çª—åŠ¨ç”»ä¼˜åŒ–ï¼ˆ200msç§’å¼€ï¼‰
      enableOutsideInteractive: false,
      backgroundColor: $r('app.color.card_background'),  // ğŸŒ— æ”¯æŒæ·±è‰²æ¨¡å¼
      onDisappear: () => {
        this.showDistrictDialog = false
        this.selectedCityForDistrict = null
      }
    })
  }

  // é€‰æ‹©åŸå¸‚å¤„ç†å‡½æ•°ï¼ˆæ”¯æŒåŒºå¿é€‰æ‹©ï¼‰
  selectCity(cityName: string): void {
    console.info(`[RegionView] é€‰æ‹©åŸå¸‚: ${cityName}`)
    
    // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯ Google æ•°æ®æºï¼Œç›´æ¥é€‰ä¸­åŸå¸‚ï¼Œä¸å¼¹å‡ºåŒºå¿èœå•
    if (this.dataSourceType === PollenDataSourceType.GOOGLE) {
      console.info(`[RegionView] Google æ¨¡å¼ï¼šè·³è¿‡åŒºå¿é€‰æ‹©ï¼Œç›´æ¥é€‰ä¸­åŸå¸‚ ${cityName}`)
      this.selectCityOrDistrict(cityName, null)
      return
    }

    console.info(`[RegionView] allCitiesData é•¿åº¦: ${this.allCitiesData.length}`)
    
    // ğŸ” è°ƒè¯•ï¼šæ‰“å°å‰10ä¸ªåŸå¸‚åï¼Œæ£€æŸ¥æ ¼å¼
    if (this.allCitiesData.length > 0) {
      const names = this.allCitiesData.slice(0, 10).map(c => c.name).join(', ')
      console.info(`[RegionView] æ•°æ®ä¸­çš„åŸå¸‚åï¼ˆå‰10ä¸ªï¼‰: ${names}`)
      
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å®Œå…¨åŒ¹é…
      const exactMatch = this.allCitiesData.find(city => city.name === cityName)
      console.info(`[RegionView] å®Œå…¨åŒ¹é… "${cityName}": ${exactMatch ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`)
    } else {
      console.error(`[RegionView] âŒ allCitiesData ä¸ºç©ºï¼æ•°æ®æœªåŠ è½½`)
    }

    // ç»Ÿä¸€ä¸‰çº§èœå•æ–¹æ¡ˆï¼šæ‰€æœ‰åŸå¸‚éƒ½å¼¹å‡ºä¸‰çº§èœå•
    const cityData = getCityWithDistricts(this.allCitiesData, cityName)
    console.info(`[RegionView] getCityWithDistricts è¿”å›: ${cityData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}`)
    
    if (cityData) {
      // æœ‰æ•°æ®å°±å¼¹çª—ï¼ˆæ— è®ºæ˜¯å¦æœ‰åŒºå¿ï¼‰
      const districtCount = cityData.districts?.length || 0
      console.info(`[RegionView] åŸå¸‚ ${cityName} æ•°æ®åŠ è½½æˆåŠŸï¼ŒåŒºå¿æ•°é‡: ${districtCount}ï¼Œå¼¹å‡ºä¸‰çº§èœå•`)
      this.selectedCityForDistrict = cityData
      this.showDistrictDialog = true

      // ã€ä¼˜åŒ–1ã€‘æ— åŒºå¿åŸå¸‚è‡ªåŠ¨é€‰ä¸­ï¼ˆ200mså»¶è¿Ÿ+éœ‡åŠ¨åé¦ˆï¼‰
      if (!cityData.districts || cityData.districts.length === 0) {
        console.info(`[RegionView] æ— åŒºå¿åŸå¸‚ï¼Œ200msåè‡ªåŠ¨é€‰ä¸­`)
        setTimeout(() => {
          this.selectCityOrDistrict(cityData.name, null)
          this.showDistrictDialog = false
          // éœ‡åŠ¨åé¦ˆ
          if (this.vibrationEnabled) {
            try {
              vibrator.startVibration({
                type: 'time',
                duration: 30
              }, {
                id: 0,
                usage: 'touch'
              })
            } catch (err) {
              console.warn('[RegionView] éœ‡åŠ¨åé¦ˆå¤±è´¥')
            }
          }
        }, 200)
      }
    } else {
      // âŒ æ•°æ®ç¼ºå¤±ï¼šä¸åº”è¯¥ç›´æ¥å®šä½ï¼Œåº”è¯¥æç¤ºé”™è¯¯
      console.error(`[RegionView] åŸå¸‚ ${cityName} æ•°æ®ç¼ºå¤±ï¼Œæ— æ³•å¼¹å‡ºä¸‰çº§èœå•`)
      
      // å¼¹å‡ºé”™è¯¯æç¤º
      this.getUIContext().getPromptAction().showToast({
        message: `${cityName} æ•°æ®æš‚æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•`,
        duration: 2000
      })
      
      // ä¸æ‰§è¡Œä»»ä½•å®šä½æ“ä½œï¼äºŒçº§èœå•çš„å”¯ä¸€åŠŸèƒ½å°±æ˜¯ï¼šç‚¹å‡»å±•å¼€ä¸‰çº§èœå•
      // å¦‚æœæ•°æ®ç¼ºå¤±ï¼Œå°±æ— æ³•å±•å¼€ï¼Œä¸åº”è¯¥æœ‰å…¶ä»–è¡Œä¸º
    }
  }

  // é€‰æ‹©åŸå¸‚æˆ–åŒºå¿ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
  selectCityOrDistrict(cityName: string, districtName: string | null): void {
    const displayName = districtName ? `${cityName} - ${districtName}` : cityName
    console.info(`[RegionView] æœ€ç»ˆé€‰æ‹©: ${displayName}`)

    // 1. éœ‡åŠ¨åé¦ˆï¼ˆ30ms çŸ­éœ‡ï¼‰
    if (this.vibrationEnabled) {
      try {
        vibrator.startVibration({
          type: 'time',
          duration: 30
        }, {
          id: 0,
          usage: 'touch'
        })
      } catch (err) {
        console.warn('[RegionView] éœ‡åŠ¨åé¦ˆå¤±è´¥')
      }
    }

    // 2. Toast æç¤º
    this.getUIContext().getPromptAction().showToast({
      message: `å·²é€‰æ‹© ${displayName}`,
      duration: 1500
    })

    // 3. è·å–åæ ‡å’Œ adcode
    let coords: CityCoordinate | undefined = undefined
    let currentAdcode: string | undefined = undefined
    
    if (districtName) {
      // ä»åŒºå¿æ•°æ®ä¸­è·å–åæ ‡
      const cityData = getCityWithDistricts(this.allCitiesData, cityName)
      if (cityData && cityData.districts) {
        const district = cityData.districts.find(d => d.name === districtName)
        if (district) {
          if (district.location) {
            coords = { lat: district.location.lat, lng: district.location.lng }
            console.info(`[RegionView] åŒºå¿åæ ‡: ${coords.lat}, ${coords.lng}`)
          }
          currentAdcode = district.adcode
          console.info(`[RegionView] åŒºå¿ adcode: ${currentAdcode}`)
        }
      }
    } else {
      // ä»åŸå¸‚åæ ‡æ˜ å°„è¡¨è·å–
      coords = cityCoordinates[cityName]
      // å¦‚æœæ˜ å°„è¡¨æ²¡æœ‰ï¼Œå°è¯•ä»å®Œæ•´æ•°æ®è·å–
      const cityData = getCityWithDistricts(this.allCitiesData, cityName)
      if (cityData) {
        if (!coords && cityData.location) {
          coords = { lat: cityData.location.lat, lng: cityData.location.lng }
          console.info(`[RegionView] ä»å®Œæ•´æ•°æ®è·å–åŸå¸‚åæ ‡: ${coords.lat}, ${coords.lng}`)
        }
        currentAdcode = cityData.adcode
        console.info(`[RegionView] åŸå¸‚ adcode: ${currentAdcode}`)
      }
    }

    // 4. æ›´æ–°å…¨å±€å­˜å‚¨
    this.currentCity = displayName
    
    if (currentAdcode) {
      this.currentAdcode = currentAdcode
      console.info(`[RegionView] å·²æ›´æ–°æŒä¹…åŒ– adcode: ${currentAdcode}`)
    } else {
      this.currentAdcode = ''
    }

    if (coords) {
      AppStorage.setOrCreate<number>('latitude', coords.lat)
      AppStorage.setOrCreate<number>('longitude', coords.lng)
      console.info(`[RegionView] æœ€ç»ˆåæ ‡: ${coords.lat}, ${coords.lng}`)
    } else {
      console.warn(`[RegionView] æœªæ‰¾åˆ° ${displayName} çš„åæ ‡ï¼Œä½¿ç”¨é»˜è®¤å€¼`)
      AppStorage.setOrCreate<number>('latitude', 23.1291)
      AppStorage.setOrCreate<number>('longitude', 113.2644)
    }

    // 5. å…³é—­å¼¹çª—
    this.showDistrictDialog = false
    this.selectedCityForDistrict = null

    // 6. ã€æš‚ä¸å®ç°ã€‘è·³è½¬åˆ°é¦–é¡µï¼ˆTab 0ï¼‰å¹¶åˆ·æ–°æ•°æ®
    // TODO: åç»­å¦‚éœ€æ¢å¤æ­¤åŠŸèƒ½ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç 
    // AppStorage.setOrCreate<number>('selectedTabIndex', 0)
    console.info(`[RegionView] å·²é€‰æ‹©: ${displayName}ï¼Œåæ ‡å·²ä¿å­˜ï¼ˆæš‚ä¸è·³è½¬é¦–é¡µï¼‰`)
  }

  // å¯åŠ¨å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®
  startPollenDataUpdate(): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.pollenUpdateTimer !== null) {
      clearInterval(this.pollenUpdateTimer);
      this.pollenUpdateTimer = null;
    }

    // æ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡èŠ±ç²‰æ•°æ®
    const updateInterval = 30 * 60 * 1000; // 30åˆ†é’Ÿ

    this.pollenUpdateTimer = setInterval(() => {
      console.info('[RegionView] å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®');
      this.loadPollenDataForCities().catch((err: Error) => {
        console.warn(`[RegionView] å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®å¤±è´¥: ${JSON.stringify(err)}`);
      });
      this.lastPollenUpdateTime = Date.now();
    }, updateInterval);

    console.info('[RegionView] èŠ±ç²‰æ•°æ®å®šæ—¶æ›´æ–°å·²å¯åŠ¨ï¼Œæ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡');
  }

  // åœæ­¢å®šæ—¶æ›´æ–°èŠ±ç²‰æ•°æ®
  stopPollenDataUpdate(): void {
    if (this.pollenUpdateTimer !== null) {
      clearInterval(this.pollenUpdateTimer);
      this.pollenUpdateTimer = null;
      console.info('[RegionView] èŠ±ç²‰æ•°æ®å®šæ—¶æ›´æ–°å·²åœæ­¢');
    }
  }


}
