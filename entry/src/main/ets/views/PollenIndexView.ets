/**
 * èŠ±ç²‰æŒ‡æ•°é¡µé¢ - Tab1 é¦–é¡µ
 * æ˜¾ç¤ºèŠ±ç²‰æµ“åº¦ç¯å½¢å›¾ã€7å¤©è¶‹åŠ¿ã€å¤©æ°”ä¿¡æ¯
 */

import { PollenService } from '../service/PollenService'
import { LocationService, LocationInfo } from '../service/LocationService'
import { WeatherService, WeatherResponse } from '../service/WeatherService'
import { SeasonHelper, OffSeasonContent } from '../utils/SeasonHelper'
import { vibrator } from '@kit.SensorServiceKit'
import { ConfigurationConstant } from '@kit.AbilityKit'
import {
  PollenForecastResponse,
  DailyInfo,
  PollenLevel,
  levelToText,
  levelToColor,
  formatDateShort,
  getMaxPollenFromDaily,
  getMaxPollenIndexFromDaily,
  getHealthRecommendationsFromDaily
} from '../model/PollenModels'

@Component
export struct PollenIndexView {
  // ä½¿ç”¨ StorageLink å…±äº«æ•°æ®ç»™å…¶ä»–é¡µé¢
  @StorageLink('currentCity') @Watch('onCityChange') currentCity: string = 'å®šä½ä¸­...'
  @StorageLink('pollenValue') pollenValue: number = 0
  @StorageLink('pollenLevel') pollenLevel: string = 'åŠ è½½ä¸­...'
  @StorageLink('updateTime') updateTime: string = 'æ­£åœ¨è·å–æ•°æ®...'
  @State pollenLevelEnum: PollenLevel = PollenLevel.NONE
  @State isScrolled: boolean = false
  @State isAnimating: boolean = false
  @State isLoading: boolean = true
  @State errorMessage: string = ''
  @State isLocating: boolean = true
  @State healthTips: string[] = []
  @State isPollenSeason: boolean = SeasonHelper.isPollenSeason()
  @State offSeasonContent: OffSeasonContent | null = null
  @State isGuideExpanded: boolean = false  // é˜²æŠ¤æŒ‡å—å±•å¼€çŠ¶æ€
  @State showGuideSheet: boolean = false   // åŠå±å¼¹çª—æ˜¾ç¤ºçŠ¶æ€
  @State dataSwiperIndex: number = 0       // æ•°æ®Swiperå½“å‰é¡µç´¢å¼•
  // é•¿æŒ‰é¢„è§ˆçŠ¶æ€
  @State previewVisible: boolean = false
  @State previewData: PreviewData = { title: '', value: '', desc: '', extra: '' }
  @StorageLink('safeTop') safeTop: number = 44
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'  // èŠ±ç²‰ä¸»é¢˜è‰²
  @StorageLink('currentColorMode') currentColorMode: ConfigurationConstant.ColorMode = ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET

  // æœåŠ¡
  private pollenService: PollenService = PollenService.getInstance()
  private locationService: LocationService = LocationService.getInstance()
  private weatherService: WeatherService = WeatherService.getInstance()

  // å½“å‰ä½ç½®ï¼ˆé»˜è®¤å¹¿å·ï¼‰
  @StorageLink('latitude') latitude: number = 23.1291
  @StorageLink('longitude') longitude: number = 113.2644

  // å¤©æ°”æ•°æ®
  @State weatherData: WeatherItem[] = [
    { icon: $r('app.media.icon_temperature'), value: '24Â°C', label: 'æ¸©åº¦' },
    { icon: $r('app.media.icon_temperature'), value: '23Â°C', label: 'ä½“æ„Ÿ' },
    { icon: $r('app.media.icon_wind'), value: '4.0m/s', label: 'é£åŠ›' },
    { icon: $r('app.media.icon_arrow_up'), value: '24Â°C', label: 'æœ€é«˜' },
    { icon: $r('app.media.icon_arrow_down'), value: '24Â°C', label: 'æœ€ä½' },
    { icon: $r('app.media.icon_pressure'), value: '1018', label: 'æ°”å‹(å¸•)' },
    { icon: $r('app.media.icon_humidity'), value: '43%', label: 'æ¹¿åº¦' },
    { icon: $r('app.media.icon_sunrise'), value: '06:54', label: 'æ—¥å‡º' },
    { icon: $r('app.media.icon_sunset'), value: '17:41', label: 'æ—¥è½' }
  ]

  // 7å¤©è¶‹åŠ¿æ•°æ®
  @State trendData: TrendItem[] = []
  
  // æœ¬æœˆè¶‹åŠ¿æ•°æ®ï¼ˆä» API æ•°æ®æå–ï¼‰
  @State monthlyData: MonthDataItem[] = []

  private scroller: Scroller = new Scroller()

  aboutToAppear(): void {
    // åˆå§‹åŒ–å­£èŠ‚çŠ¶æ€
    this.isPollenSeason = SeasonHelper.isPollenSeason()
    if (!this.isPollenSeason) {
      this.offSeasonContent = SeasonHelper.getOffSeasonContent()
    }
    this.initLocation()
  }

  // åˆå§‹åŒ–ä½ç½®ï¼ˆä¼˜åŒ–ï¼šå¿«é€Ÿå“åº”ï¼‰
  async initLocation(): Promise<void> {
    this.isLocating = true
    const startTime = Date.now()

    try {
      // 1. ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ä½ç½®ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰
      const cachedLocation = this.locationService.getCachedLocation()
      if (cachedLocation) {
        this.latitude = cachedLocation.latitude
        this.longitude = cachedLocation.longitude
        this.currentCity = cachedLocation.city || 'å½“å‰ä½ç½®'
        this.isLocating = false
        console.info(`[PollenIndexView] âš¡ ä½¿ç”¨ç¼“å­˜ä½ç½® (${Date.now() - startTime}ms)`)
        // å…ˆåŠ è½½æ•°æ®ï¼Œåå°æ›´æ–°ä½ç½®
        this.loadPollenData()
        this.updateLocationInBackground()
        return
      }

      // 2. æ£€æŸ¥å¹¶è¯·æ±‚æƒé™
      const hasPermission = await this.locationService.checkAndRequestPermission()

      if (hasPermission) {
        // 3. å¿«é€Ÿå®šä½ï¼ˆä¼˜å…ˆåŸºç«™ï¼Œ2ç§’å†…è¿”å›ï¼‰
        const location = await this.locationService.getQuickLocation()

        if (location !== null) {
          this.latitude = location.latitude
          this.longitude = location.longitude
          this.currentCity = location.city || 'å½“å‰ä½ç½®'
          console.info(`[PollenIndexView] âš¡ å¿«é€Ÿå®šä½æˆåŠŸ (${Date.now() - startTime}ms): ${this.currentCity}`)
        } else {
          // ä½¿ç”¨é»˜è®¤ä½ç½®
          const defaultLocation = this.locationService.getDefaultLocation()
          this.latitude = defaultLocation.latitude
          this.longitude = defaultLocation.longitude
          this.currentCity = defaultLocation.city
          console.warn(`[PollenIndexView] å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½® (${Date.now() - startTime}ms)`)
        }
        
        // è®¢é˜…ä½ç½®æ›´æ–°ï¼ˆåŸå¸‚åå¼‚æ­¥å›è°ƒï¼‰
        this.subscribeLocationUpdates()
      } else {
        // æ— æƒé™ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
        const defaultLocation = this.locationService.getDefaultLocation()
        this.latitude = defaultLocation.latitude
        this.longitude = defaultLocation.longitude
        this.currentCity = defaultLocation.city
        console.warn('[PollenIndexView] æ— ä½ç½®æƒé™ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®')
      }
    } catch (error) {
      console.error('[PollenIndexView] å®šä½å¼‚å¸¸: ' + JSON.stringify(error))
      // ä½¿ç”¨é»˜è®¤ä½ç½®
      const defaultLocation = this.locationService.getDefaultLocation()
      this.latitude = defaultLocation.latitude
      this.longitude = defaultLocation.longitude
      this.currentCity = defaultLocation.city
    }

    this.isLocating = false
    
    // åŠ è½½èŠ±ç²‰æ•°æ®
    this.loadPollenData()
  }

  // åå°æ›´æ–°ä½ç½®
  private updateLocationInBackground(): void {
    this.locationService.checkAndRequestPermission().then((hasPermission) => {
      if (hasPermission) {
        this.subscribeLocationUpdates()
      }
    })
  }

  // è®¢é˜…ä½ç½®æ›´æ–°
  private subscribeLocationUpdates(): void {
    this.locationService.onLocationChange((location) => {
      // åªæ›´æ–°åŸå¸‚åï¼ˆåæ ‡å˜åŒ–å°æ—¶ä¸é‡æ–°åŠ è½½æ•°æ®ï¼‰
      if (location.city && location.city !== 'å½“å‰ä½ç½®' && location.city !== this.currentCity) {
        console.info(`[PollenIndexView] ğŸ“ åŸå¸‚åæ›´æ–°: ${location.city}`)
        this.currentCity = location.city
      }
    })
  }

  // åŸå¸‚å˜åŒ–æ—¶é‡æ–°åŠ è½½æ•°æ®
  onCityChange(): void {
    console.info('[PollenIndexView] åŸå¸‚å˜åŒ–: ' + this.currentCity)
    if (this.currentCity !== 'å®šä½ä¸­...' && this.currentCity !== '') {
      this.loadPollenData()
    }
  }

  // åŠ è½½èŠ±ç²‰æ•°æ®ï¼ˆä¼˜åŒ–ï¼šå¤©æ°”å…ˆè¿”å›ï¼ŒèŠ±ç²‰é™é»˜åˆ·æ–°ï¼‰
  async loadPollenData(): Promise<void> {
    this.isLoading = true
    this.errorMessage = ''

    try {
      // ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿåˆ·æ–°å¤©æ°”æ•°æ®ï¼ˆçº¦300msï¼‰
      const weatherPromise = this.weatherService.getWeather(this.latitude, this.longitude)
      
      // ç¬¬äºŒæ­¥ï¼šèŠ±ç²‰æ•°æ®åå°é™é»˜è¯·æ±‚ï¼ˆä¸é˜»å¡UIï¼‰
      const pollenPromise = this.pollenService.getPollenForecast(this.latitude, this.longitude, 5)
      
      // å…ˆç­‰å¤©æ°”æ•°æ®è¿”å›ï¼Œå¿«é€Ÿç»“æŸåˆ·æ–°åŠ¨ç”»
      const weatherResponse: WeatherResponse | null = await weatherPromise
      
      // å¤©æ°”æ•°æ®åˆ°è¾¾åç«‹å³æ›´æ–°UIå¹¶ç»“æŸåˆ·æ–°
      if (weatherResponse !== null) {
        this.weatherData = [
          { icon: $r('app.media.icon_temperature'), value: `${weatherResponse.temperature}Â°C`, label: 'æ¸©åº¦' },
          { icon: $r('app.media.icon_temperature'), value: `${weatherResponse.feelsLike}Â°C`, label: 'ä½“æ„Ÿ' },
          { icon: $r('app.media.icon_wind'), value: `${weatherResponse.windSpeed}m/s`, label: 'é£åŠ›' },
          { icon: $r('app.media.icon_arrow_up'), value: weatherResponse.tempMax ? `${weatherResponse.tempMax}Â°C` : '--', label: 'æœ€é«˜' },
          { icon: $r('app.media.icon_arrow_down'), value: weatherResponse.tempMin ? `${weatherResponse.tempMin}Â°C` : '--', label: 'æœ€ä½' },
          { icon: $r('app.media.icon_pressure'), value: `${weatherResponse.pressure}`, label: 'æ°”å‹(å¸•)' },
          { icon: $r('app.media.icon_humidity'), value: `${weatherResponse.humidity}%`, label: 'æ¹¿åº¦' },
          { icon: $r('app.media.icon_sunrise'), value: weatherResponse.sunrise, label: 'æ—¥å‡º' },
          { icon: $r('app.media.icon_sunset'), value: weatherResponse.sunset, label: 'æ—¥è½' }
        ]
        console.info('[PollenIndexView] å¤©æ°”æ•°æ®å¿«é€Ÿåˆ·æ–°å®Œæˆ')
      }
      
      // ğŸ”´ å…³é”®ï¼šå¤©æ°”åˆ·æ–°åç«‹å³ç»“æŸåˆ·æ–°åŠ¨ç”»ï¼Œæå‡ç”¨æˆ·ä½“æ„Ÿ
      this.isLoading = false
      this.updateTime = 'åˆšåˆšæ›´æ–°'
      
      // ç¬¬ä¸‰æ­¥ï¼šé™é»˜ç­‰å¾…èŠ±ç²‰æ•°æ®ï¼ˆåå°æ›´æ–°ï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œï¼‰
      const pollenResponse: PollenForecastResponse | null = await pollenPromise
      console.info('[PollenIndexView] èŠ±ç²‰å“åº”: ' + JSON.stringify(pollenResponse))

      // å¤„ç†èŠ±ç²‰æ•°æ®
      if (pollenResponse !== null) {
        // åˆå§‹åŒ–è¶‹åŠ¿æ•°æ®
        const newTrend: TrendItem[] = []
        
        // å¤„ç†èŠ±ç²‰æ•°æ®
        if (pollenResponse.dailyInfo && pollenResponse.dailyInfo.length > 0) {
          // è§£æä»Šæ—¥æ•°æ®
          const todayInfo: DailyInfo = pollenResponse.dailyInfo[0]
          this.pollenValue = getMaxPollenIndexFromDaily(todayInfo)
          this.pollenLevelEnum = getMaxPollenFromDaily(todayInfo)
          this.healthTips = getHealthRecommendationsFromDaily(todayInfo)
          
          // æ›´æ–°å…¨å±€ä¸»é¢˜è‰²
          AppStorage.setOrCreate('pollenThemeColor', levelToColor(this.pollenLevelEnum))
          
          // åˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
          if (this.pollenValue > 0) {
            this.pollenLevel = levelToText(this.pollenLevelEnum)
            this.updateTime = 'åˆšåˆšæ›´æ–°'
          } else {
            // å†¬å­£æˆ–æ— èŠ±ç²‰å­£èŠ‚ - æ•°æ®æ­£å¸¸ä½†æ— èŠ±ç²‰æ´»åŠ¨
            this.pollenLevel = 'æä½'
            this.updateTime = 'éèŠ±ç²‰å­£'
          }
          
          // è§£æè¶‹åŠ¿æ•°æ®
          for (let i = 0; i < pollenResponse.dailyInfo.length; i++) {
            const dayInfo: DailyInfo = pollenResponse.dailyInfo[i]
            const dateLabel = formatDateShort(dayInfo.date)
            const indexValue = getMaxPollenIndexFromDaily(dayInfo)
            
            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.info(`[DEBUG] ç¬¬${i+1}å¤©: date=${dateLabel}, indexValue=${indexValue}`)
            
            const item: TrendItem = {
              date: dateLabel,
              value: indexValue > 0 ? indexValue : 0
            }
            newTrend.push(item)
          }
          
          // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„è¶‹åŠ¿æ•°æ®ï¼Œç”Ÿæˆå ä½æ•°æ®
          if (newTrend.length === 0) {
            console.info('[DEBUG] ç”Ÿæˆå ä½è¶‹åŠ¿æ•°æ®')
            for (let i = 0; i < 5; i++) {
              const today = new Date()
              today.setDate(today.getDate() + i)
              const dateLabel = `${today.getMonth() + 1}/${today.getDate()}`
              newTrend.push({ date: dateLabel, value: 0 })
            }
          }
          
          console.info(`[DEBUG] æœ€ç»ˆè¶‹åŠ¿æ•°æ®: ${JSON.stringify(newTrend)}`)
        } else {
          // æ— æ¯æ—¥æ•°æ®ï¼Œä½†å“åº”æœ‰æ•ˆ
          this.pollenValue = 0
          this.pollenLevel = 'æä½'
          // updateTime å·²åœ¨å¤©æ°”åˆ·æ–°æ—¶è®¾ç½®ï¼Œæ­¤å¤„ä¸è¦†ç›–
          
          // ç”Ÿæˆå ä½è¶‹åŠ¿æ•°æ®
          console.info('[DEBUG] æ— æ¯æ—¥æ•°æ®ï¼Œç”Ÿæˆå ä½è¶‹åŠ¿æ•°æ®')
          for (let i = 0; i < 5; i++) {
            const today = new Date()
            today.setDate(today.getDate() + i)
            const dateLabel = `${today.getMonth() + 1}/${today.getDate()}`
            newTrend.push({ date: dateLabel, value: 0 })
          }
        }
        
        this.trendData = newTrend
        
        // æ›´æ–°æœ¬æœˆè¶‹åŠ¿æ•°æ®ï¼ˆä» trendData æå–ï¼‰
        this.updateMonthlyData(newTrend)
        
        console.info(`[DEBUG] èŠ±ç²‰æ•°æ®é™é»˜æ›´æ–°å®Œæˆï¼Œè¶‹åŠ¿æ•°æ®é•¿åº¦: ${newTrend.length}`)
        
        // ğŸ”´ å¤©æ°”æ•°æ®å·²åœ¨å‰é¢å¤„ç†ï¼Œè¿™é‡Œä¸å†é‡å¤å¤„ç†
        // ğŸ”´ isLoading å·²åœ¨å¤©æ°”åˆ·æ–°åè®¾ä¸º falseï¼Œè¿™é‡Œä¸å†è®¾ç½®
      } else {
        // èŠ±ç²‰å“åº”ä¸ºnullï¼Œé™é»˜å¤±è´¥ä¸å½±å“ç”¨æˆ·
        console.warn('[PollenIndexView] èŠ±ç²‰æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®')
        this.pollenValue = 0
        this.pollenLevel = 'æä½'
        this.trendData = [
          { date: 'æš‚æ— ', value: 0 },
          { date: 'æ•°æ®', value: 0 }
        ]
        // ä¸è®¾ç½® isLoadingï¼Œå› ä¸ºå¤©æ°”å·²åˆ·æ–°æˆåŠŸ
      }
    } catch (error) {
      console.error('[PollenIndexView] åŠ è½½æ•°æ®å¤±è´¥: ' + JSON.stringify(error))
      // åªæœ‰åˆ·æ–°åŠ¨ç”»è¿˜åœ¨æ—¶æ‰ç»“æŸ
      if (this.isLoading) {
        this.isLoading = false
        this.errorMessage = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
        this.updateTime = 'è·å–å¤±è´¥'
      }
      // ä½¿ç”¨é»˜è®¤æ•°æ®
      this.pollenValue = 0
      this.pollenLevel = 'æä½'
      const defaultTrend: TrendItem[] = [
        { date: 'æš‚æ— ', value: 0 },
        { date: 'æ•°æ®', value: 0 }
      ]
      this.trendData = defaultTrend
    }
  }

  // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
  formatUpdateTime(year: number, month: number, day: number): string {
    const now = new Date()
    const dataDate = new Date(year, month - 1, day)
    const diffMs = now.getTime() - dataDate.getTime()
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60))

    if (diffHours < 1) {
      return 'åˆšåˆšæ›´æ–°'
    } else if (diffHours < 24) {
      return `${diffHours} å°æ—¶å‰`
    } else {
      const diffDays = Math.floor(diffHours / 24)
      return `${diffDays} å¤©å‰`
    }
  }

  build() {
    Column() {  // æ”¹ç”¨ Column ä½œä¸ºæ ¹å®¹å™¨ï¼Œé¿å…å¯¼èˆªæ é®æŒ¡åˆ·æ–°æŒ‡ç¤ºå™¨
      // å›ºå®šé¡¶éƒ¨å¯¼èˆªæ ï¼ˆå§‹ç»ˆä½äºé¡¶éƒ¨ï¼‰
      this.TopNavBar()

      // ä¸‹æ‹‰åˆ·æ–°åŒ…è£¹å™¨ï¼ˆè‡ªå®šä¹‰ç©ºç™½åˆ·æ–°æŒ‡ç¤ºå™¨ï¼Œä½¿ç”¨å¯¼èˆªæ çš„ LoadingProgressï¼‰
      Refresh({ refreshing: $$this.isLoading, builder: this.customRefreshingContent }) {
        // å¯æ»šåŠ¨å†…å®¹
        Scroll(this.scroller) {
          Column() {
            // ä¸»å¡ç‰‡ - èŠ±ç²‰æµ“åº¦ç¯å½¢å›¾
            this.PollenMainCard()

            // æ•°æ®æ€»è§ˆ Swiperï¼ˆ5å¤©é¢„æŠ¥ + æœ¬æœˆè¶‹åŠ¿ + å…¨å¹´è¶‹åŠ¿ï¼‰
            this.DataOverviewSwiper()

            // é˜²æŠ¤æŒ‡å—
            this.HealthGuideSection()

            // å¤©æ°”æƒ…å†µ
            this.WeatherSection()

            // åº•éƒ¨é—´è·ï¼ˆTabBaré«˜åº¦ + å®‰å…¨è·ç¦» + é¢å¤–é—´è·ï¼‰
            Blank().height(56 + this.safeBottom + 16)
          }
          .width('100%')
          .padding({ 
            top: this.safeTop + 48,  // çŠ¶æ€æ é«˜åº¦ + å¯¼èˆªæ é«˜åº¦
            left: 16, 
            right: 16 
          })
        }
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onDidScroll(() => {
          const yOffset = this.scroller.currentOffset().yOffset
          this.isScrolled = yOffset > 20
        })
      }
      .onRefreshing(() => {
        this.loadPollenData()
      })
      .pullToRefresh(true)
      .layoutWeight(1)  // å…³é”®ï¼šå æ®å‰©ä½™ç©ºé—´
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      if (isVisible && currentRatio >= 1.0) {
        // é¡µé¢å®Œå…¨å¯è§æ—¶è§¦å‘åŠ¨ç”»
        setTimeout(() => {
          animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
            this.isAnimating = true
          })
        }, 50)
      } else if (!isVisible || currentRatio < 0.5) {
        // é¡µé¢ä¸å¯è§æˆ–å¯è§æ¯”ä¾äº50%æ—¶é‡ç½®
        this.isAnimating = false
        // å¼ºåˆ¶åœæ­¢åŠ è½½åŠ¨ç”»ï¼ˆé¿å…åå°èµ„æºå ç”¨ï¼‰
        if (this.isLoading) {
          this.isLoading = false
        }
      }
    })
  }

  // ========== è‡ªå®šä¹‰ç©ºç™½åˆ·æ–°æŒ‡ç¤ºå™¨ï¼ˆéšè—é»˜è®¤å›¾æ ‡ï¼‰ ==========
  @Builder
  customRefreshingContent() {
    // ç©ºå†…å®¹ï¼Œä¸æ˜¾ç¤ºä»»ä½•åˆ·æ–°å›¾æ ‡
  }

  // ========== é¡¶éƒ¨å¯¼èˆªæ  ==========
  @Builder
  TopNavBar() {
    Column() {
      // çŠ¶æ€æ å ä½
      Row()
        .height(this.safeTop)
        .width('100%')

      // å¯¼èˆªæ å†…å®¹
      Row() {
        // å·¦ä¾§ï¼šä½ç½®å›¾æ ‡å’ŒåŸå¸‚å
        Row() {
          Image($r('app.media.icon_location'))
            .width(18)
            .height(18)
            .fillColor($r('app.color.icon_primary'))
            .accessibilityText('å®šä½å›¾æ ‡')
          Text(this.currentCity)
            .fontSize(17)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
            .margin({ left: 6 })
            .accessibilityText(`å½“å‰åŸå¸‚ï¼š${this.currentCity}`)
          
          // åŠ è½½æŒ‡ç¤ºå™¨ï¼ˆæ•°æ®åŠ è½½ä¸­æ—¶æ˜¾ç¤ºï¼‰
          if (this.isLoading) {
            LoadingProgress()
              .width(16)
              .height(16)
              .color($r('app.color.icon_primary'))
              .margin({ left: 8 })
              .accessibilityText('æ•°æ®åŠ è½½ä¸­')
          }
        }
        .accessibilityText(`å½“å‰ä½ç½®ï¼š${this.currentCity}${this.isLoading ? 'ï¼Œæ­£åœ¨åŠ è½½æ•°æ®' : ''}`)
        .accessibilityGroup(true)
        
        // ä¸­é—´ç©ºç™½åŒºåŸŸ
        Blank()
        
        // å³ä¾§ï¼šæ•°æ®æ¥æºæ„Ÿè°¢ä¿¡æ¯
        Text('æ„Ÿè°¢åŒ—äº¬æ•èˆ’ç§‘æŠ€æœ‰é™è´£ä»»å…¬å¸å¯¹æ•°æ®çš„æ”¯æŒ')
          .fontSize(10)
          .fontColor(this.getDataSourceTextColor())
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .opacity(0.8)
          .width('45%')  // è®¾ç½®å›ºå®šå®½åº¦ï¼Œé¿å…æŒ¤å‹åŸå¸‚å
          .textAlign(TextAlign.End)  // å³å¯¹é½
          .accessibilityText('æ•°æ®æ¥æºï¼šæ„Ÿè°¢åŒ—äº¬æ•èˆ’ç§‘æŠ€æœ‰é™è´£ä»»å…¬å¸å¯¹æ•°æ®çš„æ”¯æŒ')
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .position({ x: 0, y: 0 })
    .zIndex(999)  // ç¡®ä¿å¯¼èˆªæ å§‹ç»ˆåœ¨æœ€ä¸Šå±‚ï¼Œé¿å…æ»šåŠ¨å†…å®¹é®æŒ¡
    // æµ…è‰²åŠé€æ˜èƒŒæ™¯ + æ¯›ç»ç’ƒæ•ˆæœï¼ˆé€‚é…æ·±è‰²çŠ¶æ€æ å›¾æ ‡ï¼‰
    .backgroundColor($r('app.color.navbar_background'))
    .backdropBlur(40)
    .border({
      width: { bottom: 0.5 },
      color: $r('app.color.navbar_border')
    })
    .shadow({
      radius: 10,
      color: 'rgba(0, 0, 0, 0.06)',
      offsetY: 2
    })
  }

  // ========== ä¸»èŠ±ç²‰å¡ç‰‡ ==========
  @Builder
  PollenMainCard() {
    Column() {
      // ç¯å½¢è¿›åº¦æ¡åŒºåŸŸ
      Stack() {
        // èƒŒæ™¯åœ†ç¯
        Circle()
          .width(180)
          .height(180)
          .fill(Color.Transparent)
          .stroke('#333333')
          .strokeWidth(12)

        // è¿›åº¦åœ†ç¯ï¼ˆæ ¹æ®èŠ±ç²‰ç­‰çº§æ˜¾ç¤ºé¢œè‰²ï¼‰
        Circle()
          .width(180)
          .height(180)
          .fill(Color.Transparent)
          .stroke(this.getLevelColor())
          .strokeWidth(12)
          .strokeDashArray([this.getProgressLength(), 565])
          .rotate({ angle: -90 })

        // ä¸­å¿ƒå†…å®¹
        Column() {
          Row() {
            Text('â˜€ï¸')
              .fontSize(24)
            Text(this.pollenValue.toString())
              .fontSize(48)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Bold)
              .margin({ left: 4 })
          }

          Text('ç²’/kmÂ³')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })

          Text(this.pollenLevel)
            .fontSize(18)
            .fontColor(this.getLevelColor())
            .fontWeight(FontWeight.Medium)
            .margin({ top: 8 })
        }
        .accessibilityText(`å½“å‰èŠ±ç²‰æµ“åº¦${this.pollenValue}ç²’æ¯ç«‹æ–¹åƒç±³ï¼Œ${this.pollenLevel}çº§åˆ«`)
        .accessibilityGroup(true)
      }
      .width(200)
      .height(200)
      .margin({ top: 20 })

      // æ›´æ–°æ—¶é—´
      Text(this.updateTime)
        .fontSize(13)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 16 })
        .accessibilityText(`æ•°æ®æ›´æ–°æ—¶é—´ï¼š${this.updateTime}`)

      // éèŠ±ç²‰å­£æç¤º
      if (this.pollenValue === 0 && this.updateTime === 'éèŠ±ç²‰å­£') {
        Text('å½“å‰ä¸ºéèŠ±ç²‰å­£ï¼ŒèŠ±ç²‰æ´»åŠ¨æä½ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 8, bottom: 20 })
          .textAlign(TextAlign.Center)
          .width('80%')
      } else {
        Blank().height(20)
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 20, bottom: 20 })
    .margin({ top: 16 })
    // å¡ç‰‡å…¥åœºåŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 0,
      curve: Curve.EaseOut
    })
  }

  // ========== æ•°æ®æ€»è§ˆ Swiperï¼ˆ5å¤©é¢„æŠ¥ + æœ¬æœˆè¶‹åŠ¿ + å…¨å¹´è¶‹åŠ¿ï¼‰ ==========
  @Builder
  DataOverviewSwiper() {
    Stack() {
      Column() {
        // é¡¶éƒ¨ Tab æŒ‡ç¤ºå™¨
        Row({ space: 0 }) {
          ForEach(['5å¤©é¢„æŠ¥', 'æœ¬æœˆè¶‹åŠ¿', 'å…¨å¹´è¶‹åŠ¿'], (tab: string, index: number) => {
            Column() {
              Text(tab)
                .fontSize(14)
                .fontColor(this.dataSwiperIndex === index ? this.pollenThemeColor : $r('app.color.text_secondary'))
                .fontWeight(this.dataSwiperIndex === index ? FontWeight.Medium : FontWeight.Normal)
              
              // ä¸‹åˆ’çº¿æŒ‡ç¤ºå™¨
              Row()
                .width(this.dataSwiperIndex === index ? 24 : 0)
                .height(3)
                .backgroundColor('#4CAF50')
                .borderRadius(2)
                .margin({ top: 6 })
                .animation({ duration: 200, curve: Curve.EaseOut })
            }
            .layoutWeight(1)
            .accessibilityText(`${tab}${this.dataSwiperIndex === index ? 'ï¼Œå·²é€‰ä¸­' : ''}ï¼ŒåŒå‡»åˆ‡æ¢`)
            .onClick(() => {
              this.dataSwiperIndex = index
            })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 8 })
        .accessibilityText('æ•°æ®æŸ¥çœ‹é€‰é¡¹å¡ï¼Œå½“å‰æ˜¾ç¤º' + ['5å¤©é¢„æŠ¥', 'æœ¬æœˆè¶‹åŠ¿', 'å…¨å¹´è¶‹åŠ¿'][this.dataSwiperIndex])

        // Swiper å†…å®¹åŒº
        Swiper() {
          // ç¬¬1é¡µï¼š5å¤©é¢„æŠ¥
          this.FiveDayForecastPage()
          
          // ç¬¬2é¡µï¼šæœ¬æœˆè¶‹åŠ¿
          this.MonthlyTrendPage()
          
          // ç¬¬3é¡µï¼šå…¨å¹´è¶‹åŠ¿
          this.YearlyTrendPage()
        }
        .index(this.dataSwiperIndex)
        .indicator(false)
        .loop(false)
        .onChange((index: number) => {
          this.dataSwiperIndex = index
        })
        .height(240)
      }
      .width('100%')

      // é•¿æŒ‰é¢„è§ˆæµ®çª—
      if (this.previewVisible) {
        Column() {
          Text(this.previewData.title)
            .fontSize(13)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
          Text(this.previewData.value)
            .fontSize(22)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 4 })
          Text(this.previewData.desc)
            .fontSize(12)
            .fontColor('rgba(255,255,255,0.8)')
            .margin({ top: 4 })
          if (this.previewData.extra.length > 0) {
            Text(this.previewData.extra)
              .fontSize(11)
              .fontColor('rgba(255,255,255,0.7)')
              .margin({ top: 4 })
          }
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('rgba(0,0,0,0.85)')
        .borderRadius(12)
        .shadow({ radius: 20, color: 'rgba(0,0,0,0.3)', offsetY: 4 })
        .animation({ duration: 150, curve: Curve.EaseOut })
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .margin({ top: 16 })
    // å¡ç‰‡å…¥åœºåŠ¨ç”»
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 80,
      curve: Curve.EaseOut
    })
  }

  // ç¬¬1é¡µï¼š5å¤©é¢„æŠ¥ï¼ˆå¤ç”¨åŸ TrendSection é€»è¾‘ï¼‰
  @Builder
  FiveDayForecastPage() {
    Column() {
      if (this.trendData.length === 0 || this.trendData.every((item: TrendItem) => item.value === 0)) {
        // éèŠ±ç²‰å­£æç¤º
        Column() {
          Text('ğŸŒ¿')
            .fontSize(40)
          Text('éèŠ±ç²‰å­£')
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
            .margin({ top: 12 })
          Text('å½“å‰èŠ±ç²‰æ´»åŠ¨æä½ï¼Œ5å¤©å†…æ— æ˜æ˜¾èŠ±ç²‰é¢„æŠ¥')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 8 })
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .accessibilityText('å½“å‰ä¸ºéèŠ±ç²‰å­£ï¼ŒèŠ±ç²‰æ´»åŠ¨æä½ï¼Œ5å¤©å†…æ— æ˜æ˜¾èŠ±ç²‰é¢„æŠ¥')
      } else {
        // æŸ±çŠ¶å›¾
        Row() {
          ForEach(this.trendData, (item: TrendItem, index: number) => {
            Column() {
              Text(item.value.toString())
                .fontSize(11)
                .fontColor(item.value > 0 ? this.pollenThemeColor : '#808080')
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 4 })
              
              Column()
                .width(32)
                .height(Math.max(8, item.value * 1.5))
                .backgroundColor(item.value > 0 ? this.pollenThemeColor : '#E0E0E0')
                .borderRadius(6)

              Text(item.date)
                .fontSize(11)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 8 })
            }
            .justifyContent(FlexAlign.End)
            .height(160)
            .accessibilityText(`${item.date}ï¼ŒèŠ±ç²‰æµ“åº¦${item.value}ç²’æ¯ç«‹æ–¹åƒç±³ï¼Œé•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…`)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showDayPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      }
    }
    .width('100%')
    .height('100%')
  }

  // ç¬¬2é¡µï¼šæœ¬æœˆè¶‹åŠ¿ï¼ˆ30å¤©æŠ˜çº¿å›¾æ¦‚å¿µï¼‰
  @Builder
  MonthlyTrendPage() {
    Column() {
      // æœˆä»½æ ‡é¢˜
      Row() {
        Text(this.getCurrentMonthName())
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
        
        Blank()
        
        Text('é•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(11)
          .fontColor($r('app.color.text_secondary'))
          .opacity(0.6)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })

      // æœ¬æœˆè¶‹åŠ¿æ›²çº¿å›¾
      Stack() {
        // æ¸å˜èƒŒæ™¯åŒºåŸŸ
        Polygon({ width: '100%', height: 120 })
          .points(this.buildGradientArea(this.monthlyData.map(item => {
            const trendItem: TrendItem = { date: item.label, value: item.value }
            return trendItem
          }), 120, 1.2))
          .fill('#42A5F5')
          .opacity(0.15)
        
        // æ›²çº¿
        Polyline({ width: '100%', height: 120 })
          .points(this.buildCurvePath(this.monthlyData.map(item => {
            const trendItem: TrendItem = { date: item.label, value: item.value }
            return trendItem
          }), 120, 1.2))
          .stroke('#42A5F5')
          .strokeWidth(2.5)
          .strokeLineCap(LineCapStyle.Round)
          .strokeLineJoin(LineJoinStyle.Round)
        
        // æ•°æ®ç‚¹å’Œæ ‡ç­¾
        Row() {
          ForEach(this.getMonthlyData(), (item: MonthDataItem, index: number) => {
            Column() {
              // æ•°æ®ç‚¹
              Circle()
                .width(6)
                .height(6)
                .fill('#42A5F5')
                .position({ y: 120 - Math.max(4, item.value * 1.2) })
              
              // æ—¥æœŸæ ‡ç­¾
              Text(item.label)
                .fontSize(9)
                .fontColor($r('app.color.text_secondary'))
                .position({ y: 125 })
            }
            .width('10%')
            .height(135)
            .justifyContent(FlexAlign.End)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showMonthPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .height(135)
      }
      .width('100%')
      .height(135)
      .padding({ left: 8, right: 8 })

      // æœ¬æœˆç»Ÿè®¡
      Row() {
        Column() {
          Text('æœ¬æœˆå‡å€¼')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '32' : '0')
            .fontSize(16)
            .fontColor('#42A5F5')
            .fontWeight(FontWeight.Medium)
        }
        
        Column() {
          Text('æœ€é«˜å€¼')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '68' : '0')
            .fontSize(16)
            .fontColor(this.pollenThemeColor)
            .fontWeight(FontWeight.Medium)
        }
        
        Column() {
          Text('é€‚å®œå¤–å‡º')
            .fontSize(11)
            .fontColor($r('app.color.text_secondary'))
          Text(this.isPollenSeason ? '18å¤©' : '30å¤©')
            .fontSize(16)
            .fontColor('#4CAF50')
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
      .padding({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 8 })
  }

  // ç¬¬3é¡µï¼šå…¨å¹´è¶‹åŠ¿ï¼ˆé™æ€æ•°æ®ï¼Œæ°¸è¿œå¯ç”¨ï¼‰
  @Builder
  YearlyTrendPage() {
    Column() {
      // å¹´ä»½æ ‡é¢˜
      Row() {
        Text('2025å¹´èŠ±ç²‰è¶‹åŠ¿')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
        
        Blank()
        
        Row() {
          Circle().width(6).height(6).fill(this.pollenThemeColor)
          Text('é«˜å³°æœŸ')
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 4 })
          
          Circle().width(6).height(6).fill('#42A5F5').margin({ left: 8 })
          Text('è¿‡æ¸¡æœŸ')
            .fontSize(10)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 4 })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 8 })

      // å…¨å¹´è¶‹åŠ¿æ›²çº¿å›¾
      Stack() {
        // æ¸å˜èƒŒæ™¯åŒºåŸŸ
        Polygon({ width: '100%', height: 100 })
          .points(this.buildGradientArea(this.getYearlyData().map(item => {
            const trendItem: TrendItem = { date: item.month, value: item.value }
            return trendItem
          }), 100, 1.0))
          .fill(this.pollenThemeColor)
          .opacity(0.12)
        
        // æ›²çº¿
        Polyline({ width: '100%', height: 100 })
          .points(this.buildCurvePath(this.getYearlyData().map(item => {
            const trendItem: TrendItem = { date: item.month, value: item.value }
            return trendItem
          }), 100, 1.0))
          .stroke(this.pollenThemeColor)
          .strokeWidth(2.5)
          .strokeLineCap(LineCapStyle.Round)
          .strokeLineJoin(LineJoinStyle.Round)
        
        // æ•°æ®ç‚¹å’Œæ ‡ç­¾
        Row() {
          ForEach(this.getYearlyData(), (item: YearDataItem, index: number) => {
            Column() {
              // æ•°æ®ç‚¹ï¼ˆé«˜å³°æœŸåŠ å¤§ï¼‰
              Circle()
                .width(item.isPeak ? 7 : 5)
                .height(item.isPeak ? 7 : 5)
                .fill(this.pollenThemeColor)
                .position({ y: 100 - Math.max(4, item.value * 1.0) })
              
              // æœˆä»½æ ‡ç­¾
              Text(item.month)
                .fontSize(9)
                .fontColor(item.isCurrent ? this.pollenThemeColor : $r('app.color.text_secondary'))
                .fontWeight(item.isCurrent ? FontWeight.Bold : FontWeight.Normal)
                .position({ y: 105 })
            }
            .width(`${100/12}%`)
            .height(115)
            .justifyContent(FlexAlign.End)
            .gesture(
              LongPressGesture({ repeat: false, duration: 220 })
                .onAction(() => {
                  this.triggerVibration()
                  this.showYearPreview(item, index)
                })
                .onActionEnd(() => {
                  this.previewVisible = false
                })
            )
          })
        }
        .width('100%')
        .height(115)
      }
      .width('100%')
      .height(115)
      .padding({ left: 8, right: 8 })

      // èŠ±ç²‰å­£æç¤º
      Row() {
        Text('ğŸ“…')
          .fontSize(14)
        Text('æ˜¥å­£èŠ±ç²‰å­£ 3-5æœˆ | ç§‹å­£èŠ±ç²‰å­£ 8-10æœˆ')
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .margin({ left: 6 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 12 })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 8 })
  }

  // è·å–å½“å‰æœˆä»½åç§°
  private getCurrentMonthName(): string {
    const month = new Date().getMonth() + 1
    return `${month}æœˆèŠ±ç²‰è¶‹åŠ¿`
  }

  // è·å–æœ¬æœˆæ•°æ®ï¼ˆæ¨¡æ‹Ÿ30å¤©ï¼Œæ¯3å¤©ä¸€ç»„ï¼‰
  // æ›´æ–°æœ¬æœˆè¶‹åŠ¿æ•°æ®ï¼ˆä» trendData æå–ï¼‰
  private updateMonthlyData(trendData: TrendItem[]): void {
    const data: MonthDataItem[] = []
    
    // ä½¿ç”¨ API è¿”å›çš„çœŸå®æ•°æ®ï¼ˆæœ€å¤š10å¤©ï¼‰
    const maxDays = Math.min(trendData.length, 10)
    for (let i = 0; i < maxDays; i++) {
      const item = trendData[i]
      data.push({ 
        label: item.date,  // ä½¿ç”¨çœŸå®æ—¥æœŸæ ‡ç­¾ï¼ˆå¦‚ "12/15"ï¼‰
        value: item.value 
      })
    }
    
    // å¦‚æœæ•°æ®ä¸è¶³10å¤©ï¼Œå¡«å……å ä½æ•°æ®
    if (data.length < 10) {
      const today = new Date()
      for (let i = data.length; i < 10; i++) {
        const futureDate = new Date(today.getTime() + i * 24 * 60 * 60 * 1000)
        const dateLabel = `${futureDate.getMonth() + 1}/${futureDate.getDate()}`
        data.push({ 
          label: dateLabel, 
          value: 0  // æœªæ¥æ•°æ®æ˜¾ç¤ºä¸º0
        })
      }
    }
    
    this.monthlyData = data
  }

  private getMonthlyData(): MonthDataItem[] {
    // ç›´æ¥è¿”å›ä» API æå–çš„æ•°æ®
    return this.monthlyData
  }

  // è·å–å…¨å¹´æ•°æ®ï¼ˆæ ¹æ®çº¬åº¦å’Œå½“å‰æ•°æ®åŠ¨æ€ç”Ÿæˆï¼‰
  private getYearlyData(): YearDataItem[] {
    const currentMonth = new Date().getMonth() + 1
    const currentValue = this.pollenValue  // å½“å‰èŠ±ç²‰æµ“åº¦
    
    // æ ¹æ®çº¬åº¦åˆ¤æ–­æ°”å€™ç±»å‹
    // å—æ–¹ï¼ˆçº¬åº¦<30Â°ï¼‰ï¼š2-4æœˆé«˜å³° | åŒ—æ–¹ï¼ˆçº¬åº¦â‰¥30Â°ï¼‰ï¼š3-5æœˆé«˜å³°
    const isSouthern = this.latitude < 30
    
    // åŸºç¡€æ¨¡æ¿ï¼ˆç›¸å¯¹å€¼ï¼Œ0-100ï¼‰
    const baseTemplate = isSouthern ? 
      // å—æ–¹ï¼šæ—©æ˜¥é«˜å³°
      [8, 60, 85, 70, 30, 15, 10, 40, 65, 50, 20, 10] :
      // åŒ—æ–¹ï¼šæ˜¥å­£é«˜å³°
      [5, 15, 70, 90, 75, 25, 12, 45, 70, 55, 18, 8]
    
    // æ ¹æ®å½“å‰æœˆä»½å’Œå®é™…æµ“åº¦è°ƒæ•´ç¼©æ”¾ç³»æ•°
    let scaleFactor = 1.0
    if (currentValue > 0 && baseTemplate[currentMonth - 1] > 0) {
      scaleFactor = currentValue / baseTemplate[currentMonth - 1]
    }
    
    // ç”ŸæˆåŠ¨æ€æ•°æ®
    return baseTemplate.map((baseValue, index) => {
      const month = index + 1
      const adjustedValue = Math.round(baseValue * scaleFactor)
      const isPeak = baseValue >= 60  // åŸºç¡€å€¼â‰¥60è§†ä¸ºé«˜å³°æœŸ
      
      const yearItem: YearDataItem = {
        month: `${month}æœˆ`,
        value: adjustedValue,
        isPeak: isPeak,
        isCurrent: month === currentMonth
      }
      return yearItem
    })
  }

  // ========== æ›²çº¿å›¾è¾…åŠ©å‡½æ•° ==========
  
  // æ„å»ºæ›²çº¿è·¯å¾„ç‚¹ï¼ˆç”¨äº Polylineï¼‰
  private buildCurvePath(data: TrendItem[], height: number, scale: number): Array<[number, number]> {
    const points: Array<[number, number]> = []
    const width = 100  // ç™¾åˆ†æ¯”å®½åº¦
    const count = data.length
    
    if (count === 0) return [[0, height], [width, height]]
    
    for (let i = 0; i < count; i++) {
      const x = (width / (count - 1)) * i
      const y = height - Math.max(4, data[i].value * scale)
      points.push([x, y])
    }
    
    return points
  }
  
  // æ„å»ºæ¸å˜åŒºåŸŸï¼ˆç”¨äº Polygonï¼‰
  private buildGradientArea(data: TrendItem[], height: number, scale: number): Array<[number, number]> {
    const points: Array<[number, number]> = []
    const width = 100
    const count = data.length
    
    if (count === 0) return [[0, height], [width, height], [width, height], [0, height]]
    
    // å·¦ä¸‹è§’èµ·ç‚¹
    points.push([0, height])
    
    // æ›²çº¿é¡¶éƒ¨è·¯å¾„
    for (let i = 0; i < count; i++) {
      const x = (width / (count - 1)) * i
      const y = height - Math.max(4, data[i].value * scale)
      points.push([x, y])
    }
    
    // å³ä¸‹è§’ç»ˆç‚¹
    points.push([width, height])
    
    return points
  }

  // ========== é•¿æŒ‰é¢„è§ˆæ–¹æ³• ==========

  // è§¦å‘çŸ­éœ‡åŠ¨åé¦ˆ
  private triggerVibration(): void {
    try {
      const effect: vibrator.VibrateEffect = {
        type: 'time',
        duration: 30  // 30ms çŸ­éœ‡åŠ¨
      }
      const attribute: vibrator.VibrateAttribute = {
        usage: 'touch'
      }
      vibrator.startVibration(effect, attribute)
    } catch (e) {
      // å¿½ç•¥éœ‡åŠ¨å¤±è´¥
    }
  }
  
  // 5å¤©é¢„æŠ¥ - é•¿æŒ‰æ˜¾ç¤ºæŸå¤©è¯¦æƒ…
  private showDayPreview(item: TrendItem, index: number): void {
    const today = new Date()
    const targetDate = new Date(today.getTime() + index * 24 * 60 * 60 * 1000)
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']
    const weekDay = weekDays[targetDate.getDay()]
    
    const levelText = item.value === 0 ? 'æ— èŠ±ç²‰' : 
                      item.value < 30 ? 'ä½æµ“åº¦' : 
                      item.value < 60 ? 'ä¸­æµ“åº¦' : 'é«˜æµ“åº¦'
    
    const previewItem: PreviewData = {
      title: `${targetDate.getMonth() + 1}æœˆ${targetDate.getDate()}æ—¥ ${weekDay}`,
      value: `${item.value} ç²’/kmÂ³`,
      desc: levelText,
      extra: item.value === 0 ? 'é€‚åˆæˆ·å¤–æ´»åŠ¨' : item.value < 30 ? 'å¯æ­£å¸¸å¤–å‡º' : 'å»ºè®®åšå¥½é˜²æŠ¤'
    }
    this.previewData = previewItem
    this.previewVisible = true
  }

  // æœ¬æœˆè¶‹åŠ¿ - é•¿æŒ‰æ˜¾ç¤ºæŸæ—¶æ®µè¯¦æƒ…
  private showMonthPreview(item: MonthDataItem, index: number): void {
    const startDay = index * 3 + 1
    const endDay = Math.min((index + 1) * 3, 30)
    const month = new Date().getMonth() + 1
    
    const previewItem: PreviewData = {
      title: `${month}æœˆ${startDay}-${endDay}æ—¥`,
      value: `${item.value} ç²’/kmÂ³`,
      desc: item.value === 0 ? 'éèŠ±ç²‰å­£' : `æ—¥å‡æµ“åº¦`,
      extra: item.value === 0 ? 'èŠ±ç²‰æ´»åŠ¨æä½' : item.value < 30 ? 'èŠ±ç²‰æµ“åº¦è¾ƒä½' : 'æ³¨æ„é˜²æŠ¤'
    }
    this.previewData = previewItem
    this.previewVisible = true
  }

  // å…¨å¹´è¶‹åŠ¿ - é•¿æŒ‰æ˜¾ç¤ºæŸæœˆè¯¦æƒ…
  private showYearPreview(item: YearDataItem, index: number): void {
    const monthPollenTypes: string[] = [
      'æŸæ ‘ã€æ¦†æ ‘èŒåŠ¨',      // 1æœˆ
      'æŸæ ‘ã€æ¨æ ‘åˆèŠ±',      // 2æœˆ
      'æŸæ ‘ã€æ¨æ ‘ã€æŸ³æ ‘',    // 3æœˆ - æ˜¥å­£é«˜å³°
      'æ¨æ ‘ã€æŸ³æ ‘ã€æ¦†æ ‘',    // 4æœˆ - æ˜¥å­£é«˜å³°
      'æ¾æ ‘ã€æ³•æ¡ã€æ¨çµ®',    // 5æœˆ - æ˜¥å­£é«˜å³°
      'ç¦¾æœ¬ç§‘è‰ç±»',          // 6æœˆ
      'ç¦¾æœ¬ç§‘è‰ç±»',          // 7æœˆ
      'è’¿è‰ã€è±šè‰åˆèŠ±',      // 8æœˆ - ç§‹å­£é«˜å³°
      'è’¿è‰ã€è±šè‰é«˜å³°',      // 9æœˆ - ç§‹å­£é«˜å³°
      'è’¿è‰ã€è‘è‰',          // 10æœˆ - ç§‹å­£é«˜å³°
      'èŠ±ç²‰å‡å°‘',            // 11æœˆ
      'èŠ±ç²‰ä¼‘çœ æœŸ'           // 12æœˆ
    ]
    
    const previewItem: PreviewData = {
      title: item.month,
      value: item.isPeak ? 'âš ï¸ é«˜å³°æœŸ' : (item.value > 20 ? 'ğŸ“Š è¿‡æ¸¡æœŸ' : 'âœ… ä½é£é™©'),
      desc: `é¢„è®¡æµ“åº¦: ${item.value}`,
      extra: `ä¸»è¦èŠ±ç²‰: ${monthPollenTypes[index]}`
    }
    this.previewData = previewItem
    this.previewVisible = true
  }

  // ========== å¤©æ°”æƒ…å†µ ==========
  @Builder
  WeatherSection() {
    Column() {
      Text('å¤©æ°”æƒ…å†µ')
        .fontSize(16)
        .fontColor($r('app.color.text_primary'))
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .padding({ left: 16, bottom: 12 })

      // 3x3 ç½‘æ ¼
      Grid() {
        ForEach(this.weatherData, (item: WeatherItem) => {
          GridItem() {
            Column() {
              Image(item.icon)
                .width(24)
                .height(24)
                .fillColor(this.pollenThemeColor)
              Text(item.value)
                .fontSize(16)
                .fontColor($r('app.color.text_primary'))
                .fontWeight(FontWeight.Medium)
                .margin({ top: 6 })
              Text(item.label)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 4 })
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr')
      .width('100%')
      .height(240)
      .padding({ left: 8, right: 8 })
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 16, bottom: 16 })
    .margin({ top: 16 })
    // å¡ç‰‡å…¥åœºåŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 120,
      curve: Curve.EaseOut
    })
  }

  // ========== é˜²æŠ¤æŒ‡å—ï¼ˆä¸‰å±‚æ¸è¿›å¼ï¼‰ ==========
  @Builder
  HealthGuideSection() {
    Column() {
      // æ ‡é¢˜æ ï¼ˆå¯ç‚¹å‡»å±•å¼€/æŠ˜å ï¼‰
      Row() {
        Image($r('app.media.icon_shield'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.icon_primary'))
        Text(this.isPollenSeason ? 'é˜²æŠ¤æŒ‡å—' : (this.offSeasonContent?.title ?? 'å­£èŠ‚æç¤º'))
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Medium)
          .margin({ left: 6 })
        
        Blank()
        
        // å­£èŠ‚æ ‡ç­¾
        Text(SeasonHelper.getSeasonDescription())
          .fontSize(11)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
        
        // å±•å¼€/æŠ˜å å›¾æ ‡
        Image($r('app.media.icon_arrow_down'))
          .width(14)
          .height(14)
          .fillColor('#757575')
          .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
          .animation({ duration: 200, curve: Curve.EaseOut })
          .margin({ left: 8 })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.isGuideExpanded = !this.isGuideExpanded
      })

      // é˜²æŠ¤æŒ‡å—å†…å®¹
      Column() {
        if (this.isPollenSeason) {
          this.PollenSeasonGuide()
        } else {
          this.OffSeasonGuide()
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .padding({ top: 16, bottom: 16 })
    .margin({ top: 16 })
    .opacity(this.isAnimating ? 1 : 0)
    .translate({ x: this.isAnimating ? 0 : 60 })
    .animation({
      duration: 280,
      delay: 40,
      curve: Curve.EaseOut
    })
    // åŠå±å¼¹çª—
    .bindSheet($$this.showGuideSheet, this.GuideDetailSheet(), {
      height: SheetSize.MEDIUM,
      dragBar: true,
      showClose: true,
      title: { title: this.isPollenSeason ? 'è¯¦ç»†é˜²æŠ¤æŒ‡å—' : 'å­£èŠ‚å¥åº·æç¤º' }
    })
  }

  // èŠ±ç²‰å­£é˜²æŠ¤æŒ‡å—ï¼ˆä¸‰å±‚æ¸è¿›ï¼‰
  @Builder
  PollenSeasonGuide() {
    Column({ space: 8 }) {
      if (this.healthTips.length === 0) {
        // æ— æ•°æ®æ—¶çš„æç¤º
        Text('å½“å‰ç©ºæ°”è´¨é‡è‰¯å¥½ï¼Œæ— ç‰¹åˆ«é˜²æŠ¤å»ºè®®')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .padding(16)
      } else {
        // ç¬¬ä¸€å±‚ï¼šç²¾ç®€æŠ˜å ï¼ˆæ˜¾ç¤ºå‰3æ¡æ ¸å¿ƒä¿¡æ¯ï¼‰
        ForEach(this.healthTips.slice(0, 3), (tip: string) => {
          Row() {
            Text(tip)
              .fontSize(14)
              .fontColor('#2E7D32')
          }
          .width('100%')
          .backgroundColor('#E8F5E9')
          .padding(12)
          .borderRadius(8)
        })

        // ç¬¬äºŒå±‚ï¼šå±•å¼€æ˜¾ç¤ºå‰©ä½™å»ºè®®
        if (this.isGuideExpanded && this.healthTips.length > 3) {
          ForEach(this.healthTips.slice(3), (tip: string) => {
            Row() {
              Text(tip)
                .fontSize(14)
                .fontColor('#2E7D32')
            }
            .width('100%')
            .backgroundColor('#E8F5E9')
            .padding(12)
            .borderRadius(8)
          })
        }

        // å±•å¼€/æ”¶èµ·æŒ‰é’® æˆ– æŸ¥çœ‹æ›´å¤šæŒ‰é’®
        if (this.healthTips.length > 3) {
          Row() {
            Text(this.isGuideExpanded ? 'æ”¶èµ·' : `å±•å¼€å…¨éƒ¨ (${this.healthTips.length}æ¡)`)
              .fontSize(13)
              .fontColor('#4CAF50')
            Image($r('app.media.icon_arrow_down'))
              .width(12)
              .height(12)
              .fillColor('#4CAF50')
              .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
              .margin({ left: 4 })
          }
          .justifyContent(FlexAlign.Center)
          .padding({ top: 8 })
          .onClick(() => {
            this.isGuideExpanded = !this.isGuideExpanded
          })
        }

        // ç¬¬ä¸‰å±‚ï¼šæŸ¥çœ‹æ›´å¤šè¯¦æƒ…æŒ‰é’®
        if (this.isGuideExpanded) {
          Row() {
            Text('æŸ¥çœ‹è¯¦ç»†é˜²æŠ¤æŒ‡å—')
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_up'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .margin({ left: 4 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 12, bottom: 4 })
          .onClick(() => {
            this.showGuideSheet = true
          })
        }
      }
    }
    .padding({ top: 8 })
  }

  // éèŠ±ç²‰å­£æç¤ºå†…å®¹ï¼ˆä¸‰å±‚æ¸è¿›ï¼‰
  @Builder
  OffSeasonGuide() {
    Column({ space: 12 }) {
      if (this.offSeasonContent !== null) {
        // ç¬¬ä¸€å±‚ï¼šç²¾ç®€æè¿°
        Text(this.offSeasonContent.description)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .lineHeight(22)

        // ç²¾ç®€æç¤ºï¼ˆæ˜¾ç¤ºå‰3æ¡ï¼‰
        Column({ space: 8 }) {
          ForEach(this.offSeasonContent.tips.slice(0, this.isGuideExpanded ? this.offSeasonContent.tips.length : 3), (tip: string) => {
            Row() {
              Text(tip)
                .fontSize(14)
                .fontColor('#1565C0')
            }
            .width('100%')
            .backgroundColor('#E3F2FD')
            .padding(12)
            .borderRadius(8)
          })
        }

        // å±•å¼€/æ”¶èµ·æŒ‰é’®
        if (this.offSeasonContent.tips.length > 3) {
          Row() {
            Text(this.isGuideExpanded ? 'æ”¶èµ·' : `å±•å¼€å…¨éƒ¨ (${this.offSeasonContent.tips.length}æ¡)`)
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_down'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .rotate({ angle: this.isGuideExpanded ? 180 : 0 })
              .margin({ left: 4 })
          }
          .justifyContent(FlexAlign.Center)
          .padding({ top: 8 })
          .onClick(() => {
            this.isGuideExpanded = !this.isGuideExpanded
          })
        }

        // ä¸‹å­£é¢„å‘Šï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
        if (this.isGuideExpanded && this.offSeasonContent.nextSeasonHint.length > 0) {
          Row() {
            Image($r('app.media.icon_calendar'))
              .width(14)
              .height(14)
              .fillColor('#FF9800')
            Text(this.offSeasonContent.nextSeasonHint)
              .fontSize(12)
              .fontColor('#FF9800')
              .margin({ left: 6 })
          }
          .width('100%')
          .backgroundColor('#FFF8E1')
          .padding(10)
          .borderRadius(8)
          .margin({ top: 4 })

          // ç¬¬ä¸‰å±‚ï¼šæŸ¥çœ‹æ›´å¤š
          Row() {
            Text('æŸ¥çœ‹å­£èŠ‚å¥åº·æŒ‡å—')
              .fontSize(13)
              .fontColor('#1976D2')
            Image($r('app.media.icon_arrow_up'))
              .width(12)
              .height(12)
              .fillColor('#1976D2')
              .margin({ left: 4 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 12, bottom: 4 })
          .onClick(() => {
            this.showGuideSheet = true
          })
        }
      }
    }
    .padding({ top: 8 })
  }

  // ç¬¬ä¸‰å±‚ï¼šåŠå±è¯¦ç»†æŒ‡å—å¼¹çª—
  @Builder
  GuideDetailSheet() {
    Scroll() {
      Column({ space: 16 }) {
        if (this.isPollenSeason) {
          // èŠ±ç²‰å­£è¯¦ç»†æŒ‡å—
          this.DetailSection('ğŸ¯ æ ¸å¿ƒé˜²æŠ¤è¦ç‚¹', [
            'å¤–å‡ºå¿…æˆ´å£ç½©ï¼ˆN95æ•ˆæœæœ€ä½³ï¼‰',
            'ä½©æˆ´æŠ¤ç›®é•œæˆ–å¤ªé˜³é•œ',
            'èŠ±ç²‰é«˜å³°æœŸï¼ˆ10:00-16:00ï¼‰å‡å°‘å¤–å‡º',
            'å›å®¶åç«‹å³æ´—æ‰‹ã€æ´—è„¸ã€æ¸…æ´—é¼»è…”'
          ])

          this.DetailSection('ğŸ  å±…å®¶é˜²æŠ¤', [
            'å…³é—­é—¨çª—ï¼Œä½¿ç”¨ç©ºæ°”å‡€åŒ–å™¨',
            'å®šæœŸæ¸…æ´—åºŠå•ã€çª—å¸˜ç­‰ç»‡ç‰©',
            'ä½¿ç”¨å¸å°˜å™¨æ¸…æ´åœ°é¢ï¼ˆå¸¦HEPAæ»¤ç½‘ï¼‰',
            'é¿å…åœ¨å®¤å¤–æ™¾æ™’è¡£ç‰©'
          ])

          this.DetailSection('ğŸš— å‡ºè¡Œå»ºè®®', [
            'å¼€è½¦æ—¶å…³é—­è½¦çª—ï¼Œä½¿ç”¨å†…å¾ªç¯',
            'é€‰æ‹©æ¸…æ™¨æˆ–é›¨åå¤–å‡ºï¼ˆèŠ±ç²‰è¾ƒå°‘ï¼‰',
            'é¿å…å»å…¬å›­ã€éƒŠå¤–ç­‰èŠ±ç²‰å¯†é›†åŒº',
            'éšèº«æºå¸¦æŠ—è¿‡æ•è¯ç‰©ï¼ˆéµåŒ»å˜±ï¼‰'
          ])

          this.DetailSection('âš ï¸ æ³¨æ„äº‹é¡¹', [
            'å…³æ³¨æ¯æ—¥èŠ±ç²‰æµ“åº¦é¢„æŠ¥',
            'è®°å½•è¿‡æ•ç—‡çŠ¶ï¼Œäº†è§£è‡ªå·±çš„è¿‡æ•åŸ',
            'ç—‡çŠ¶ä¸¥é‡æ—¶åŠæ—¶å°±åŒ»',
            'ä¿æŒå……è¶³ç¡çœ ï¼Œå¢å¼ºå…ç–«åŠ›'
          ])
        } else {
          // éèŠ±ç²‰å­£è¯¦ç»†æŒ‡å—
          this.DetailSection('ğŸŒ¿ å½“å‰å­£èŠ‚ç‰¹ç‚¹', [
            SeasonHelper.getSeasonDescription(),
            this.offSeasonContent?.description ?? ''
          ])

          this.DetailSection('ğŸ’ª å¢å¼ºä½“è´¨å»ºè®®', [
            'é€‚å½“æˆ·å¤–è¿åŠ¨ï¼Œå‘¼å¸æ–°é²œç©ºæ°”',
            'å‡è¡¡é¥®é£Ÿï¼Œå¤šåƒè”¬æœ',
            'ä¿æŒè§„å¾‹ä½œæ¯ï¼Œå……è¶³ç¡çœ ',
            'é€‚åº¦é”»ç‚¼ï¼Œæé«˜å…ç–«åŠ›'
          ])

          this.DetailSection('ğŸ  å®¶å±…æ¸…æ´', [
            'è¶éèŠ±ç²‰å­£è¿›è¡Œå¤§æ‰«é™¤',
            'æ¸…æ´—ç©ºè°ƒæ»¤ç½‘å’Œå‡€åŒ–å™¨æ»¤èŠ¯',
            'æ¸…æ´çª—å¸˜ã€åœ°æ¯¯ç­‰æ˜“ç§¯å°˜ç‰©å“',
            'æ£€æŸ¥é—¨çª—å¯†å°æ€§'
          ])

          this.DetailSection('ğŸ“… ä¸‹å­£å‡†å¤‡', [
            this.offSeasonContent?.nextSeasonHint ?? 'å…³æ³¨èŠ±ç²‰å­£é¢„æŠ¥',
            'æå‰å‡†å¤‡é˜²æŠ¤ç”¨å“ï¼ˆå£ç½©ã€æŠ¤ç›®é•œï¼‰',
            'äº†è§£å½“åœ°ä¸»è¦è‡´æ•èŠ±ç²‰ç§ç±»',
            'å¦‚æœ‰éœ€è¦ï¼Œæå‰å’¨è¯¢åŒ»ç”Ÿ'
          ])
        }
      }
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }

  // è¯¦æƒ…åˆ†åŒºæ„å»ºå™¨
  @Builder
  DetailSection(title: string, items: string[]) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .width('100%')

      Column({ space: 6 }) {
        ForEach(items, (item: string) => {
          if (item.length > 0) {
            Row() {
              Text('â€¢')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ right: 8 })
              Text(item)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .layoutWeight(1)
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
          }
        })
      }
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .padding(16)
    .borderRadius(12)
  }

  // è·å–æ•°æ®æ¥æºæ–‡æœ¬é¢œè‰²ï¼ˆç¡®ä¿å¯¹æ¯”åº¦ â‰¥ 4.1:1ï¼Œç¬¦åˆåä¸ºæ— éšœç¢è¦æ±‚ï¼‰
  private getDataSourceTextColor(): string {
    // æ ¹æ®ä¸»é¢˜åŠ¨æ€é€‰æ‹©é¢œè‰²
    if (this.currentColorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK) {
      return '#CCCCCC'  // æ·±è‰²æ¨¡å¼ï¼šå¯¹æ¯”åº¦çº¦ 4.2:1 (vs #1A1A1A)
    } else {
      return '#555555'  // æµ…è‰²æ¨¡å¼ï¼šå¯¹æ¯”åº¦çº¦ 4.2:1 (vs #F1F3F5)
    }
  }

  // ========== å·¥å…·æ–¹æ³• ==========
  getLevelColor(): string {
    // å½“èŠ±ç²‰å€¼ä¸º0æ—¶ï¼Œæ˜¾ç¤ºæ·¡ç°è‰²
    if (this.pollenValue === 0) {
      return '#4A4A4A'
    }
    // ä½¿ç”¨æœåŠ¡å±‚çš„é¢œè‰²å‡½æ•°
    return levelToColor(this.pollenLevelEnum)
  }

  getProgressLength(): number {
    // ç¯å½¢è¿›åº¦ï¼Œæœ€å¤§å€¼100å¯¹åº”å®Œæ•´åœ†å‘¨565
    // å½“èŠ±ç²‰å€¼ä¸º0æ—¶ï¼Œæ˜¾ç¤ºå®Œæ•´çš„æ·¡è‰²ç¯
    if (this.pollenValue === 0) {
      return 565
    }
    const progress = Math.min(this.pollenValue, 100) / 100
    return progress * 565
  }
}

// å¤©æ°”é¡¹æ•°æ®æ¥å£
interface WeatherItem {
  icon: Resource
  value: string
  label: string
}

// è¶‹åŠ¿æ•°æ®æ¥å£
interface TrendItem {
  date: string
  value: number
}

// æœ¬æœˆæ•°æ®é¡¹æ¥å£
interface MonthDataItem {
  label: string
  value: number
}

// å…¨å¹´æ•°æ®é¡¹æ¥å£
interface YearDataItem {
  month: string
  value: number
  isPeak: boolean
  isCurrent: boolean
}

// é•¿æŒ‰é¢„è§ˆæ•°æ®æ¥å£
interface PreviewData {
  title: string
  value: string
  desc: string
  extra: string
}
