/**
 * æé†’æœåŠ¡
 * è´Ÿè´£æ¯æ—¥æ¨é€é€šçŸ¥
 */

import { notificationManager } from '@kit.NotificationKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';

/**
 * æé†’æœåŠ¡ç±»
 */
export class ReminderService {
  private static instance: ReminderService;
  private context: common.UIAbilityContext | null = null;

  private constructor() {}

  static getInstance(): ReminderService {
    if (!ReminderService.instance) {
      ReminderService.instance = new ReminderService();
    }
    return ReminderService.instance;
  }

  /**
   * åˆå§‹åŒ–æœåŠ¡
   */
  init(context: common.UIAbilityContext) {
    this.context = context;
  }

  /**
   * è¯·æ±‚é€šçŸ¥æƒé™
   */
  async requestNotificationPermission(): Promise<boolean> {
    if (!this.context) {
      console.error('ReminderService: Context not initialized');
      return false;
    }

    try {
      await notificationManager.requestEnableNotification(this.context);
      console.info('ReminderService: Notification permission granted');
      return true;
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ReminderService: Permission denied, code: ${err.code}, message: ${err.message}`);
      return false;
    }
  }

  /**
   * å‘é€æ¯æ—¥æ‰“å¡æé†’
   */
  async sendDailyReminder(message: string = 'ä»Šå¤©è¿˜æœ‰ä»»åŠ¡æœªå®Œæˆå“¦!') {
    try {
      const notificationRequest: notificationManager.NotificationRequest = {
        id: 1,
        content: {
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'æ‰“å¡æé†’',
            text: message
          }
        }
      };

      await notificationManager.publish(notificationRequest);
      console.info('ReminderService: Daily reminder sent');
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ReminderService: Failed to send reminder, code: ${err.code}`);
    }
  }

  /**
   * å‘é€æˆå°±è§£é”é€šçŸ¥
   */
  async sendAchievementNotification(achievementName: string, description: string) {
    try {
      const notificationRequest: notificationManager.NotificationRequest = {
        id: 2,
        content: {
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'ğŸ† æˆå°±è§£é”!',
            text: `æ­å–œè§£é” "${achievementName}" - ${description}`
          }
        }
      };

      await notificationManager.publish(notificationRequest);
      console.info('ReminderService: Achievement notification sent');
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ReminderService: Failed to send achievement notification, code: ${err.code}`);
    }
  }

  /**
   * å‘é€è¿ç»­æ‰“å¡é¼“åŠ±
   */
  async sendStreakNotification(days: number) {
    try {
      const notificationRequest: notificationManager.NotificationRequest = {
        id: 3,
        content: {
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'ğŸ”¥ è¿ç»­æ‰“å¡',
            text: `å¤ªæ£’äº†!ä½ å·²è¿ç»­æ‰“å¡${days}å¤©,ç»§ç»­ä¿æŒ!`
          }
        }
      };

      await notificationManager.publish(notificationRequest);
      console.info('ReminderService: Streak notification sent');
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ReminderService: Failed to send streak notification, code: ${err.code}`);
    }
  }

  /**
   * å–æ¶ˆæ‰€æœ‰é€šçŸ¥
   */
  async cancelAllNotifications() {
    try {
      await notificationManager.cancelAll();
      console.info('ReminderService: All notifications cancelled');
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ReminderService: Failed to cancel notifications, code: ${err.code}`);
    }
  }
}
