/**
 * æ•°æ®å¯¼å‡ºé¡µé¢
 */

import { DataExportService, ExportFormat } from '../common/utils/DataExportService';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct DataExportPage {
  @State exportFormat: ExportFormat = ExportFormat.CSV;
  @State isExporting: boolean = false;
  @State lastExportPath: string = '';
  private exportService = DataExportService.getInstance();

  /**
   * æ‰§è¡Œå¯¼å‡º
   */
  async performExport() {
    this.isExporting = true;

    try {
      const filePath = await this.exportService.exportAllData(this.exportFormat);
      this.lastExportPath = filePath;

      promptAction.showToast({
        message: 'å¯¼å‡ºæˆåŠŸ!',
        duration: 2000
      });
    } catch (error) {
      promptAction.showToast({
        message: 'å¯¼å‡ºå¤±è´¥,è¯·é‡è¯•',
        duration: 2000
      });
      console.error(`Export error: ${error}`);
    } finally {
      this.isExporting = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Text('â†')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .onClick(() => {
            this.getUIContext().getRouter().back();
          })

        Text('æ•°æ®å¯¼å‡º')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 12 })
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.Start)

      // æ ¼å¼é€‰æ‹©
      Column() {
        Text('å¯¼å‡ºæ ¼å¼')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 12 })

        Row() {
          Button('CSVæ ¼å¼')
            .width('48%')
            .backgroundColor(this.exportFormat === ExportFormat.CSV ? '#FF6B35' : '#E0E0E0')
            .fontColor(this.exportFormat === ExportFormat.CSV ? Color.White : '#666666')
            .onClick(() => {
              this.exportFormat = ExportFormat.CSV;
            })

          Button('JSONæ ¼å¼')
            .width('48%')
            .backgroundColor(this.exportFormat === ExportFormat.JSON ? '#FF6B35' : '#E0E0E0')
            .fontColor(this.exportFormat === ExportFormat.JSON ? Color.White : '#666666')
            .onClick(() => {
              this.exportFormat = ExportFormat.JSON;
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('90%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 16 })

      // æ ¼å¼è¯´æ˜
      Column() {
        Text('æ ¼å¼è¯´æ˜')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        if (this.exportFormat === ExportFormat.CSV) {
          Text('CSVæ ¼å¼é€‚åˆç”¨Excelæ‰“å¼€æŸ¥çœ‹\nåŒ…å«: æ—¥æœŸã€ä»»åŠ¡IDã€ç›®æ ‡å€¼ã€å®Œæˆå€¼ã€çŠ¶æ€')
            .fontSize(12)
            .fontColor('#666666')
            .lineHeight(20)
        } else {
          Text('JSONæ ¼å¼é€‚åˆç¨‹åºè¯»å–\nåŒ…å«å®Œæ•´çš„ä»»åŠ¡æ•°æ®ç»“æ„')
            .fontSize(12)
            .fontColor('#666666')
            .lineHeight(20)
        }
      }
      .width('90%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 16 })

      // å¯¼å‡ºæŒ‰é’®
      Button(this.isExporting ? 'å¯¼å‡ºä¸­...' : 'å¼€å§‹å¯¼å‡º')
        .width('90%')
        .height(48)
        .fontSize(16)
        .backgroundColor('#4CAF50')
        .margin({ top: 24 })
        .enabled(!this.isExporting)
        .onClick(() => {
          this.performExport();
        })

      // å¯¼å‡ºè·¯å¾„æ˜¾ç¤º
      if (this.lastExportPath) {
        Column() {
          Text('æœ€è¿‘å¯¼å‡º')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })

          Text(this.lastExportPath)
            .fontSize(12)
            .fontColor('#666666')
            .maxLines(3)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('90%')
        .padding(16)
        .backgroundColor('#E8F5E9')
        .borderRadius(12)
        .margin({ top: 16 })
      }

      // è¯´æ˜æ–‡å­—
      Column() {
        Text('ğŸ“ æ³¨æ„äº‹é¡¹')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text('â€¢ æ•°æ®ä¿å­˜åœ¨åº”ç”¨ç§æœ‰ç›®å½•\nâ€¢ å¸è½½åº”ç”¨ä¼šæ¸…ç©ºå¯¼å‡ºæ–‡ä»¶\nâ€¢ å»ºè®®å®šæœŸå¤‡ä»½åˆ°äº‘ç›˜\nâ€¢ å¯¼å‡ºåŒ…å«æ‰€æœ‰å†å²æ‰“å¡è®°å½•')
          .fontSize(12)
          .fontColor('#666666')
          .lineHeight(20)
      }
      .width('90%')
      .padding(16)
      .backgroundColor('#FFF3E0')
      .borderRadius(12)
      .margin({ top: 16 })

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
