/**
 * æ•°æ®ç»Ÿè®¡é¡µé¢
 * å±•ç¤ºå‘¨/æœˆç»Ÿè®¡å›¾è¡¨å’Œå…³é”®æŒ‡æ ‡
 */

import { LineChart, BarChart } from '../view/statistics/ChartComponent';
import { CalendarHeatmap } from '../view/statistics/CalendarHeatmap';
import { StatisticsService, ChartDataPoint } from '../common/utils/StatisticsService';
import { CommonConstants as Const } from '../common/constants/CommonConstants';

@Entry
@Component
struct StatisticsPage {
  @State weeklyData: ChartDataPoint[] = [];
  @State monthlyData: ChartDataPoint[] = [];
  @State streakDays: number = 0;
  @State totalCompleted: number = 0;
  @State weekCompletionRate: number = 0;
  @State monthCompletionRate: number = 0;
  @State isLoading: boolean = true;

  async aboutToAppear() {
    await this.loadStatisticsData();
  }

  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  async loadStatisticsData() {
    try {
      this.isLoading = true;

      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
      const results = await Promise.all([
        StatisticsService.getWeeklyCompletionData(),
        StatisticsService.getMonthlyCompletionData(),
        StatisticsService.getStreakDays(),
        StatisticsService.getTotalCompletedTasks(),
        StatisticsService.getCurrentWeekCompletionRate(),
        StatisticsService.getCurrentMonthCompletionRate()
      ]);

      this.weeklyData = results[0];
      this.monthlyData = results[1];
      this.streakDays = results[2];
      this.totalCompleted = results[3];
      this.weekCompletionRate = results[4];
      this.monthCompletionRate = results[5];
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', JSON.stringify(error));
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * å…³é”®æŒ‡æ ‡å¡ç‰‡
   */
  @Builder
  MetricCard(title: string, value: string, subtitle: string, color: string) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor('#999999')
        .margin({ bottom: 8 })

      Text(value)
        .fontSize(32)
        .fontWeight(600)
        .fontColor(color)
        .margin({ bottom: 4 })

      Text(subtitle)
        .fontSize(12)
        .fontColor('#666666')
    }
    .width('48%')
    .padding(16)
    .backgroundColor($r('app.color.start_window_background'))
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.ic_right_grey'))
          .width(24)
          .height(24)
          .rotate({ angle: 180 })
          .onClick(() => {
            this.getUIContext().getRouter().back();
          })

        Text('æ•°æ®ç»Ÿè®¡')
          .fontSize(20)
          .fontWeight(600)
          .margin({ left: 12 })

        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color('#52C41A')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column({ space: 16 }) {
            // å…³é”®æŒ‡æ ‡åŒºåŸŸ
            Row({ space: 12 }) {
              this.MetricCard(
                'è¿ç»­æ‰“å¡',
                this.streakDays.toString(),
                'å¤©',
                '#FF6B6B'
              )

              this.MetricCard(
                'ç´¯è®¡å®Œæˆ',
                this.totalCompleted.toString(),
                'ä¸ªä»»åŠ¡',
                '#52C41A'
              )
            }
            .width('100%')

            Row({ space: 12 }) {
              this.MetricCard(
                'æœ¬å‘¨å®Œæˆç‡',
                this.weekCompletionRate + '%',
                'è¾ƒä¸Šå‘¨æŒå¹³',
                '#1890FF'
              )

              this.MetricCard(
                'æœ¬æœˆå®Œæˆç‡',
                this.monthCompletionRate + '%',
                'ç»§ç»­ä¿æŒ',
                '#722ED1'
              )
            }
            .width('100%')

            // å‘¨å®Œæˆåº¦æŠ˜çº¿å›¾
            if (this.weeklyData.length > 0) {
              LineChart({
                chartData: this.weeklyData,
                chartTitle: 'æœ¬å‘¨å®Œæˆåº¦è¶‹åŠ¿',
                primaryColor: '#52C41A'
              })
                .margin({ top: 8 })
            } else {
              // ç©ºçŠ¶æ€æç¤º
              Column() {
                Text('ğŸ“Š')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                Text('æš‚æ— æ•°æ®')
                  .fontSize(16)
                  .fontColor('#999999')
                  .margin({ bottom: 8 })
                Text('å®Œæˆå‡ ä¸ªä»»åŠ¡åå†æ¥æŸ¥çœ‹å§!')
                  .fontSize(14)
                  .fontColor('#CCCCCC')
              }
              .width('100%')
              .height(200)
              .backgroundColor($r('app.color.start_window_background'))
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .margin({ top: 8 })
            }

            // æœˆæ±‡æ€»æŸ±çŠ¶å›¾
            if (this.monthlyData.length > 0) {
              BarChart({
                chartData: this.monthlyData,
                chartTitle: 'è¿‘30å¤©å®Œæˆç»Ÿè®¡',
                primaryColor: '#1890FF'
              })
                .margin({ bottom: 16 })
            } else {
              // ç©ºçŠ¶æ€æç¤º
              Column() {
                Text('ğŸ“ˆ')
                  .fontSize(48)
                  .margin({ bottom: 16 })
                Text('æš‚æ— æ•°æ®')
                  .fontSize(16)
                  .fontColor('#999999')
                  .margin({ bottom: 8 })
                Text('åšæŒæ‰“å¡,ç§¯ç´¯æ•°æ®!')
                  .fontSize(14)
                  .fontColor('#CCCCCC')
              }
              .width('100%')
              .height(200)
              .backgroundColor($r('app.color.start_window_background'))
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .margin({ bottom: 16 })
            }

            // æ—¥å†çƒ­åŠ›å›¾
            CalendarHeatmap()
              .margin({ bottom: 16 })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.primaryBgColor'))
  }
}
