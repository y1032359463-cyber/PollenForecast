/**
 * æˆ‘çš„ Tab ç»„ä»¶
 * ä¸ªäººä¸­å¿ƒï¼Œå¤§è‰²å—è®¾è®¡
 */
import { Colors } from '../constants/Colors';
import { User, Achievement, AchievementType } from '../models/User';

@Component
export struct ProfileTab {
  @State user: User | null = null;
  
  aboutToAppear() {
    this.loadUserInfo();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯
      this.UserInfoCard()
      
      // åŠŸèƒ½åŒºï¼ˆå¤§è‰²å—ï¼‰
      this.FunctionBlocks()
      
      // è®¾ç½®å…¥å£
      this.SettingsEntry()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }
  
  /**
   * ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
   */
  @Builder
  UserInfoCard() {
    Row() {
      // å¤´åƒ
      Column() {
        Text('ğŸ‘¤')
          .fontSize(50)
      }
      .width(80)
      .height(80)
      .backgroundColor(Colors.AVATAR_BG)
      .borderRadius(40)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 16 })
      
      // ç”¨æˆ·ä¿¡æ¯
      Column() {
        Text(this.user?.nickname || 'æ¸¸å®¢')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Text(`å·²ä½¿ç”¨ ${this.user?.stats.recordCount || 0} æ¬¡`)
          .fontSize(14)
          .fontColor(Colors.TEXT_SECONDARY)
          .margin({ top: 8 })
        
        // æˆå°±å¾½ç« 
        Row() {
          if (this.user && this.user.achievements.length > 0) {
            ForEach(this.user.achievements.slice(0, 3), (achievement: Achievement) => {
              Text(this.getAchievementIcon(achievement))
                .fontSize(16)
                .margin({ right: 8 })
            }, (achievement: Achievement) => achievement.type)
          }
        }
        .margin({ top: 8 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('90%')
    .padding(20)
    .margin({ left: '5%', top: 20 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * åŠŸèƒ½åŒºï¼ˆå¤§è‰²å—ï¼‰
   */
  @Builder
  FunctionBlocks() {
    Column({ space: 12 }) {
      // ç¬¬ä¸€è¡Œï¼šæˆ‘çš„æ”¶è— + æˆ‘çš„ä¸ŠæŠ¥
      Row({ space: 12 }) {
        this.FunctionBlock('â­', 'æˆ‘çš„æ”¶è—', this.user?.stats.favoriteToilets.toString() || '0', '#FFB74D')
        this.FunctionBlock('ğŸ“', 'æˆ‘çš„ä¸ŠæŠ¥', this.user?.stats.contributedToilets.toString() || '0', '#4FC3F7')
      }
      .width('100%')
      
      // ç¬¬äºŒè¡Œï¼šä½¿ç”¨è®°å½• + æˆå°±å¢™
      Row({ space: 12 }) {
        this.FunctionBlock('ğŸ“', 'ä½¿ç”¨è®°å½•', this.user?.stats.recordCount.toString() || '0', '#81C784')
        this.FunctionBlock('ğŸ†', 'æˆå°±å¢™', this.user?.achievements.length.toString() || '0', '#BA68C8')
      }
      .width('100%')
    }
    .width('90%')
    .margin({ left: '5%', top: 20 })
  }
  
  /**
   * åŠŸèƒ½è‰²å—
   */
  @Builder
  FunctionBlock(icon: string, title: string, count: string, color: string) {
    Column() {
      Text(icon)
        .fontSize(40)
        .margin({ bottom: 12 })
      
      Text(title)
        .fontSize(15)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
      
      Text(count)
        .fontSize(24)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Bold)
        .margin({ top: 8 })
    }
    .width('50%')
    .height(140)
    .layoutWeight(1)
    .backgroundColor(color)
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
    .shadow({
      radius: 8,
      color: '#20000000',
      offsetY: 2
    })
    .onClick(() => {
      console.info('ç‚¹å‡»åŠŸèƒ½å—', title);
    })
  }
  
  /**
   * è®¾ç½®å…¥å£
   */
  @Builder
  SettingsEntry() {
    Column({ space: 0 }) {
      this.SettingItem('ğŸ””', 'æ¶ˆæ¯é€šçŸ¥', true)
      Divider().color(Colors.DIVIDER)
      
      this.SettingItem('ğŸ¨', 'ä¸»é¢˜è®¾ç½®', false)
      Divider().color(Colors.DIVIDER)
      
      this.SettingItem('ğŸ”’', 'éšç§è®¾ç½®', false)
      Divider().color(Colors.DIVIDER)
      
      this.SettingItem('â„¹ï¸', 'å…³äºæˆ‘ä»¬', false)
      Divider().color(Colors.DIVIDER)
      
      this.SettingItem('ğŸ“±', 'åˆ†äº«åº”ç”¨', false)
    }
    .width('90%')
    .margin({ left: '5%', top: 20, bottom: 20 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * è®¾ç½®é¡¹
   */
  @Builder
  SettingItem(icon: string, title: string, showArrow: boolean) {
    Row() {
      Text(icon)
        .fontSize(22)
        .margin({ right: 12 })
      
      Text(title)
        .fontSize(15)
        .fontColor(Colors.TEXT_PRIMARY)
        .layoutWeight(1)
      
      if (showArrow) {
        Text('â€º')
          .fontSize(20)
          .fontColor(Colors.TEXT_HINT)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .onClick(() => {
      console.info('ç‚¹å‡»è®¾ç½®é¡¹', title);
    })
  }
  
  /**
   * åŠ è½½ç”¨æˆ·ä¿¡æ¯
   */
  private loadUserInfo() {
    // TODO: ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    setTimeout(() => {
      this.user = {
        id: 'user_001',
        nickname: 'å•æ‰€æ¢ç´¢å®¶',
        avatar: '',
        achievements: [
          {
            type: AchievementType.EXPLORER,
            level: 2,
            progress: 15,
            target: 20
          },
          {
            type: AchievementType.REVIEWER,
            level: 1,
            progress: 8,
            target: 10
          }
        ],
        stats: {
          checkedToilets: 15,
          favoriteToilets: 8,
          contributedToilets: 3,
          reviewCount: 23,
          usefulReviewCount: 18,
          recordCount: 42,
          recordDays: 30,
          totalDistance: 5000
        },
        settings: {
          theme: 'light',
          mapLayer: 'simple',
          locationPrecision: 'precise',
          autoLocation: true,
          enableNotification: true,
          enableSound: true,
          enableVibration: false,
          privacyMode: false,
          shareLocation: true,
          language: 'zh-CN'
        },
        createdAt: Date.now() - 30 * 24 * 60 * 60 * 1000,
        lastLoginAt: Date.now()
      };
    }, 300);
  }
  
  /**
   * è·å–æˆå°±å›¾æ ‡
   */
  private getAchievementIcon(achievement: Achievement): string {
    switch (achievement.type) {
      case 'explorer': return 'ğŸ—ºï¸';
      case 'reviewer': return 'â­';
      case 'contributor': return 'ğŸ“';
      case 'frequent': return 'ğŸ”¥';
      case 'night_owl': return 'ğŸ¦‰';
      default: return 'ğŸ†';
    }
  }
}
