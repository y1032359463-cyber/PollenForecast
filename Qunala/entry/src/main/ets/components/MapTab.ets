/**
 * åœ°å›¾ Tab ç»„ä»¶
 * æ˜¾ç¤ºé™„è¿‘å•æ‰€ä½ç½®ï¼Œæ”¯æŒå®šä½å’Œæœç´¢
 */
import { Colors } from '../constants/Colors';
import { MapConfig } from '../constants/Config';

@Component
export struct MapTab {
  @State userLocation: LocationInfo | null = null;
  @State nearbyToilets: ToiletMarker[] = [];
  @State isLoading: boolean = false;
  @State searchRadius: number = MapConfig.SEARCH_RADIUS_DEFAULT;
  
  // åœ°å›¾é…ç½®
  private mapController: MapController = new MapController();
  
  aboutToAppear() {
    // è¯·æ±‚å®šä½æƒé™å¹¶è·å–ç”¨æˆ·ä½ç½®
    this.requestLocation();
  }
  
  build() {
    Stack() {
      // åœ°å›¾å®¹å™¨
      Column() {
        // TODO: é›†æˆåä¸ºåœ°å›¾ç»„ä»¶
        // Map({ controller: this.mapController })
        this.MapPlaceholder()
      }
      .width('100%')
      .height('100%')
      
      // é¡¶éƒ¨æœç´¢æ 
      this.SearchBar()
      
      // å®šä½æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰
      this.LocationButton()
      
      // é™„è¿‘å•æ‰€åˆ—è¡¨ï¼ˆåº•éƒ¨æŠ½å±‰ï¼‰
      this.NearbyDrawer()
      
      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading) {
        LoadingProgress()
          .color(Colors.PRIMARY)
          .width(50)
          .height(50)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.MAP_BG)
  }
  
  /**
   * åœ°å›¾å ä½ç¬¦ï¼ˆå¾…é›†æˆåä¸ºåœ°å›¾ï¼‰
   */
  @Builder
  MapPlaceholder() {
    Column() {
      Text('ğŸ—ºï¸')
        .fontSize(60)
        .margin({ bottom: 20 })
      
      Text('åä¸ºåœ°å›¾ç»„ä»¶')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.TEXT_PRIMARY)
      
      Text('éœ€è¦é…ç½® Map Kit API Key')
        .fontSize(14)
        .fontColor(Colors.TEXT_SECONDARY)
        .margin({ top: 8 })
      
      Button('ç”³è¯· API Key')
        .fontSize(14)
        .fontColor(Colors.BG_PRIMARY)
        .backgroundColor(Colors.PRIMARY)
        .borderRadius(20)
        .padding({ left: 24, right: 24, top: 10, bottom: 10 })
        .margin({ top: 20 })
        .onClick(() => {
          console.info('æ‰“å¼€ç”³è¯·é¡µé¢');
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .backgroundColor(Colors.MAP_BG)
  }
  
  /**
   * é¡¶éƒ¨æœç´¢æ 
   */
  @Builder
  SearchBar() {
    Row() {
      // æœç´¢å›¾æ ‡
      Text('ğŸ”')
        .fontSize(20)
        .margin({ right: 10 })
      
      // æœç´¢è¾“å…¥æ¡†
      TextInput({ placeholder: 'æœç´¢é™„è¿‘çš„å•æ‰€' })
        .layoutWeight(1)
        .fontSize(15)
        .backgroundColor(Colors.BG_PRIMARY)
        .borderRadius(20)
        .padding({ left: 15, right: 15 })
        .placeholderColor(Colors.TEXT_HINT)
      
      // ç­›é€‰æŒ‰é’®
      Button('ç­›é€‰')
        .fontSize(14)
        .fontColor(Colors.PRIMARY)
        .backgroundColor(Colors.BG_PRIMARY)
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .margin({ left: 10 })
        .onClick(() => {
          console.info('æ‰“å¼€ç­›é€‰é¢æ¿');
        })
    }
    .width('90%')
    .height(50)
    .padding({ left: 15, right: 15 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(25)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
    .margin({ top: 50 })
    .position({ x: '5%', y: 0 })
  }
  
  /**
   * å®šä½æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰
   */
  @Builder
  LocationButton() {
    Button() {
      Column() {
        Text('ğŸ“')
          .fontSize(24)
      }
    }
    .width(56)
    .height(56)
    .backgroundColor(Colors.BG_PRIMARY)
    .borderRadius(28)
    .shadow({
      radius: 8,
      color: '#20000000',
      offsetY: 2
    })
    .position({ x: '85%', y: '75%' })
    .onClick(() => {
      this.requestLocation();
    })
  }
  
  /**
   * é™„è¿‘å•æ‰€åˆ—è¡¨ï¼ˆåº•éƒ¨æŠ½å±‰ï¼‰
   */
  @Builder
  NearbyDrawer() {
    Column() {
      // æ‹–åŠ¨æ¡
      Divider()
        .width(40)
        .height(4)
        .color(Colors.TEXT_HINT)
        .borderRadius(2)
        .margin({ top: 10, bottom: 10 })
      
      // æ ‡é¢˜
      Row() {
        Text('é™„è¿‘å•æ‰€')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Text(` (${this.nearbyToilets.length})`)
          .fontSize(14)
          .fontColor(Colors.TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 10 })
      
      // å•æ‰€åˆ—è¡¨ï¼ˆå ä½ï¼‰
      if (this.nearbyToilets.length === 0) {
        Column() {
          Text('ğŸš½')
            .fontSize(40)
            .margin({ bottom: 10 })
          
          Text('æš‚æ— é™„è¿‘å•æ‰€æ•°æ®')
            .fontSize(14)
            .fontColor(Colors.TEXT_SECONDARY)
        }
        .width('100%')
        .padding({ top: 40, bottom: 40 })
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .backgroundColor(Colors.BG_PRIMARY)
    .borderRadius({ topLeft: 20, topRight: 20 })
    .shadow({
      radius: 15,
      color: '#30000000',
      offsetY: -3
    })
    .position({ x: 0, y: '80%' })
    .alignItems(HorizontalAlign.Center)
  }
  
  /**
   * è¯·æ±‚å®šä½æƒé™å¹¶è·å–ä½ç½®
   */
  private requestLocation() {
    this.isLoading = true;
    
    // TODO: å®ç°å®šä½é€»è¾‘
    setTimeout(() => {
      // æ¨¡æ‹Ÿå®šä½æˆåŠŸ
      this.userLocation = {
        latitude: 39.9042,
        longitude: 116.4074,
        address: 'åŒ—äº¬å¸‚ä¸œåŸåŒº'
      };
      this.isLoading = false;
      console.info('å®šä½æˆåŠŸ', JSON.stringify(this.userLocation));
    }, 1000);
  }
}

/**
 * åœ°å›¾æ§åˆ¶å™¨ï¼ˆå ä½ï¼‰
 */
class MapController {
  // TODO: å®ç°åœ°å›¾æ§åˆ¶æ–¹æ³•
}

/**
 * ä½ç½®ä¿¡æ¯
 */
interface LocationInfo {
  latitude: number;
  longitude: number;
  address: string;
}

/**
 * å•æ‰€æ ‡è®°
 */
interface ToiletMarker {
  id: string;
  latitude: number;
  longitude: number;
  name: string;
  distance: number;
}
