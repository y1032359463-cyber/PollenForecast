/**
 * è®°å½• Tab ç»„ä»¶
 * æ˜¾ç¤ºå¦‚å•è®°å½•ç»Ÿè®¡å’Œæ—¥å†è§†å›¾
 */
import { Colors } from '../constants/Colors';
import { ToiletRecord, RecordType, ComfortLevel } from '../models/ToiletRecord';

@Component
export struct RecordTab {
  @State recordList: ToiletRecord[] = [];
  @State weekStats: WeekStats = this.getEmptyWeekStats();
  @State selectedDate: Date = new Date();
  @State isLoading: boolean = false;
  
  aboutToAppear() {
    this.loadRecords();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
      this.StatsCard()
      
      // æœ¬å‘¨æ•°æ®
      this.WeekDataCard()
      
      // æ—¥å†è§†å›¾
      this.CalendarView()
      
      // è®°å½•åˆ—è¡¨
      this.RecordList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }
  
  /**
   * é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  StatsCard() {
    Column() {
      Text('æœ¬å‘¨è®°å½•')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.TEXT_PRIMARY)
        .margin({ bottom: 20 })
      
      Row() {
        // æ€»æ¬¡æ•°
        this.StatItem('ğŸ“', 'æ€»æ¬¡æ•°', this.weekStats.totalCount.toString())
        
        Divider()
          .vertical(true)
          .height(40)
          .color(Colors.DIVIDER)
          .margin({ left: 15, right: 15 })
        
        // å¹³å‡æ—¶é•¿
        this.StatItem('â±ï¸', 'å¹³å‡æ—¶é•¿', this.weekStats.avgDuration + 'åˆ†é’Ÿ')
        
        Divider()
          .vertical(true)
          .height(40)
          .color(Colors.DIVIDER)
          .margin({ left: 15, right: 15 })
        
        // èˆ’é€‚åº¦
        this.StatItem('â­', 'èˆ’é€‚åº¦', this.weekStats.avgComfort.toFixed(1))
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(20)
    .margin({ left: '5%', top: 16 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * ç»Ÿè®¡é¡¹
   */
  @Builder
  StatItem(icon: string, label: string, value: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .margin({ bottom: 8 })
      
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.PRIMARY)
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(12)
        .fontColor(Colors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
  }
  
  /**
   * æœ¬å‘¨æ•°æ®å¡ç‰‡
   */
  @Builder
  WeekDataCard() {
    Column() {
      Row() {
        Text('æœ¬å‘¨è¶‹åŠ¿')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Blank()
        
        Text('æŸ¥çœ‹è¯¦æƒ… â€º')
          .fontSize(14)
          .fontColor(Colors.PRIMARY)
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // ç®€å•çš„æŸ±çŠ¶å›¾ï¼ˆå ä½ï¼‰
      Row() {
        ForEach(['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'], (day: string, index: number) => {
          Column() {
            // æŸ±å­
            Column()
              .width(30)
              .height(this.weekStats.dailyCounts[index] * 20)
              .backgroundColor(Colors.PRIMARY)
              .borderRadius(4)
              .margin({ bottom: 8 })
            
            // æ ‡ç­¾
            Text(day.substring(1))
              .fontSize(12)
              .fontColor(Colors.TEXT_SECONDARY)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
        }, (day: string) => day)
      }
      .width('100%')
      .height(150)
      .justifyContent(FlexAlign.SpaceAround)
      .alignItems(VerticalAlign.Bottom)
    }
    .width('90%')
    .padding(20)
    .margin({ left: '5%', top: 16 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * æ—¥å†è§†å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰
   */
  @Builder
  CalendarView() {
    Column() {
      Text('ğŸ“… é€‰æ‹©æ—¥æœŸ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.TEXT_PRIMARY)
      
      Text('æ—¥å†ç»„ä»¶å¼€å‘ä¸­...')
        .fontSize(14)
        .fontColor(Colors.TEXT_SECONDARY)
        .margin({ top: 10 })
    }
    .width('90%')
    .padding(20)
    .margin({ left: '5%', top: 16 })
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * è®°å½•åˆ—è¡¨
   */
  @Builder
  RecordList() {
    Column() {
      Row() {
        Text('å†å²è®°å½•')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Blank()
        
        Button('+ æ·»åŠ ')
          .fontSize(14)
          .fontColor(Colors.BG_PRIMARY)
          .backgroundColor(Colors.PRIMARY)
          .borderRadius(16)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .onClick(() => {
            console.info('æ·»åŠ è®°å½•');
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 10 })
      
      if (this.recordList.length === 0) {
        this.EmptyRecordView()
      } else {
        List({ space: 10 }) {
          ForEach(this.recordList, (record: ToiletRecord) => {
            ListItem() {
              this.RecordCard(record)
            }
          }, (record: ToiletRecord) => record.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .layoutWeight(1)
    .margin({ top: 16 })
  }
  
  /**
   * è®°å½•å¡ç‰‡
   */
  @Builder
  RecordCard(record: ToiletRecord) {
    Row() {
      // å·¦ä¾§æ—¶é—´
      Column() {
        Text(this.formatTime(record.recordTime))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Text(this.formatDate(record.recordTime))
          .fontSize(12)
          .fontColor(Colors.TEXT_SECONDARY)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ right: 16 })
      
      // å³ä¾§ä¿¡æ¯
      Column() {
        Row() {
          Text(record.toiletName || 'æœªçŸ¥å•æ‰€')
            .fontSize(15)
            .fontColor(Colors.TEXT_PRIMARY)
            .layoutWeight(1)
          
          Text(this.getComfortEmoji(record.comfortLevel))
            .fontSize(18)
        }
        .width('100%')
        .margin({ bottom: 6 })
        
        if (record.duration) {
          Text(`æ—¶é•¿: ${record.duration}åˆ†é’Ÿ`)
            .fontSize(13)
            .fontColor(Colors.TEXT_SECONDARY)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(12)
  }
  
  /**
   * ç©ºè®°å½•è§†å›¾
   */
  @Builder
  EmptyRecordView() {
    Column() {
      Text('ğŸ“')
        .fontSize(50)
        .margin({ bottom: 16 })
      
      Text('è¿˜æ²¡æœ‰è®°å½•')
        .fontSize(16)
        .fontColor(Colors.TEXT_SECONDARY)
      
      Text('å¼€å§‹è®°å½•ä½ çš„å¦‚å•ä¹ æƒ¯å§')
        .fontSize(14)
        .fontColor(Colors.TEXT_HINT)
        .margin({ top: 8 })
    }
    .width('100%')
    .padding({ top: 60, bottom: 60 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
  
  /**
   * åŠ è½½è®°å½•
   */
  private loadRecords() {
    this.isLoading = true;
    
    // TODO: ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    setTimeout(() => {
      this.recordList = [];
      this.weekStats = {
        totalCount: 0,
        avgDuration: 0,
        avgComfort: 0,
        dailyCounts: [0, 0, 0, 0, 0, 0, 0]
      };
      this.isLoading = false;
    }, 500);
  }
  
  /**
   * è·å–èˆ’é€‚åº¦è¡¨æƒ…
   */
  private getComfortEmoji(level?: ComfortLevel): string {
    if (!level) return 'ğŸ˜';
    switch (level) {
      case ComfortLevel.VERY_UNCOMFORTABLE: return 'ğŸ˜£';
      case ComfortLevel.UNCOMFORTABLE: return 'ğŸ˜•';
      case ComfortLevel.NORMAL: return 'ğŸ˜';
      case ComfortLevel.COMFORTABLE: return 'ğŸ˜Š';
      case ComfortLevel.VERY_COMFORTABLE: return 'ğŸ˜„';
      default: return 'ğŸ˜';
    }
  }
  
  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }
  
  /**
   * æ ¼å¼åŒ–æ—¥æœŸ
   */
  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}/${date.getDate()}`;
  }
  
  /**
   * è·å–ç©ºç»Ÿè®¡æ•°æ®
   */
  private getEmptyWeekStats(): WeekStats {
    return {
      totalCount: 0,
      avgDuration: 0,
      avgComfort: 0,
      dailyCounts: [0, 0, 0, 0, 0, 0, 0]
    };
  }
}

/**
 * æœ¬å‘¨ç»Ÿè®¡æ•°æ®
 */
interface WeekStats {
  totalCount: number;
  avgDuration: number;
  avgComfort: number;
  dailyCounts: number[];
}
