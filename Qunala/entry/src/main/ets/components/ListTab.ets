/**
 * åˆ—è¡¨ Tab ç»„ä»¶
 * æ˜¾ç¤ºé™„è¿‘å•æ‰€åˆ—è¡¨ï¼Œæ”¯æŒæ’åºå’Œç­›é€‰
 */
import { Colors } from '../constants/Colors';
import { Toilet, ToiletType } from '../models/Toilet';

@Component
export struct ListTab {
  @State toiletList: Toilet[] = [];
  @State isLoading: boolean = false;
  @State sortType: SortType = SortType.DISTANCE;
  @State filterType: ToiletType | null = null;
  
  aboutToAppear() {
    this.loadToiletList();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨ç­›é€‰æ 
      this.FilterBar()
      
      // å•æ‰€åˆ—è¡¨
      if (this.isLoading) {
        this.LoadingView()
      } else if (this.toiletList.length === 0) {
        this.EmptyView()
      } else {
        this.ToiletListView()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }
  
  /**
   * é¡¶éƒ¨ç­›é€‰æ 
   */
  @Builder
  FilterBar() {
    Row() {
      // æ’åºæŒ‰é’®
      Button(`æ’åº: ${this.getSortLabel()}`)
        .fontSize(14)
        .fontColor(Colors.TEXT_PRIMARY)
        .backgroundColor(Colors.BG_CARD)
        .borderRadius(20)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .onClick(() => {
          this.toggleSort();
        })
      
      Blank()
      
      // ç­›é€‰æŒ‰é’®
      Button('ç­›é€‰')
        .fontSize(14)
        .fontColor(Colors.PRIMARY)
        .backgroundColor(Colors.BG_CARD)
        .borderRadius(20)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .onClick(() => {
          console.info('æ‰“å¼€ç­›é€‰');
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 10 })
  }
  
  /**
   * å•æ‰€åˆ—è¡¨è§†å›¾
   */
  @Builder
  ToiletListView() {
    List({ space: 12 }) {
      ForEach(this.toiletList, (toilet: Toilet) => {
        ListItem() {
          this.ToiletCard(toilet)
        }
      }, (toilet: Toilet) => toilet.id)
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 6 })
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }
  
  /**
   * å•æ‰€å¡ç‰‡ï¼ˆé»„è‰²å¤§å¡ç‰‡è®¾è®¡ï¼‰
   */
  @Builder
  ToiletCard(toilet: Toilet) {
    Column() {
      // é¡¶éƒ¨ï¼šåç§°å’Œè·ç¦»
      Row() {
        Text(toilet.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.TEXT_PRIMARY)
          .layoutWeight(1)
        
        Text('500m')
          .fontSize(14)
          .fontColor(Colors.PRIMARY)
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // åœ°å€
      Row() {
        Text('ğŸ“')
          .fontSize(14)
          .margin({ right: 4 })
        
        Text(toilet.address)
          .fontSize(14)
          .fontColor(Colors.TEXT_SECONDARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // è®¾æ–½æ ‡ç­¾
      Row() {
        this.FacilityTag('â™¿ æ— éšœç¢', toilet.hasDisabledAccess)
        this.FacilityTag('ğŸš» å…è´¹', toilet.type === ToiletType.PUBLIC)
        this.FacilityTag('â­ ' + toilet.rating.toFixed(1), true)
      }
      .width('100%')
      
      // åº•éƒ¨æŒ‰é’®
      Row() {
        Button('å¯¼èˆª')
          .fontSize(14)
          .fontColor(Colors.BG_PRIMARY)
          .backgroundColor(Colors.PRIMARY)
          .borderRadius(18)
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            console.info('å¯¼èˆªåˆ°', toilet.name);
          })
        
        Button('è¯¦æƒ…')
          .fontSize(14)
          .fontColor(Colors.PRIMARY)
          .backgroundColor(Colors.BG_PRIMARY)
          .borderRadius(18)
          .border({ width: 1, color: Colors.PRIMARY })
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .layoutWeight(1)
          .margin({ left: 10 })
          .onClick(() => {
            console.info('æŸ¥çœ‹è¯¦æƒ…', toilet.name);
          })
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: '#10000000',
      offsetY: 2
    })
  }
  
  /**
   * è®¾æ–½æ ‡ç­¾
   */
  @Builder
  FacilityTag(label: string, show: boolean) {
    if (show) {
      Text(label)
        .fontSize(12)
        .fontColor(Colors.TEXT_SECONDARY)
        .backgroundColor(Colors.BG_PRIMARY)
        .borderRadius(10)
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .margin({ right: 8 })
    }
  }
  
  /**
   * ç©ºè§†å›¾
   */
  @Builder
  EmptyView() {
    Column() {
      Text('ğŸš½')
        .fontSize(60)
        .margin({ bottom: 20 })
      
      Text('é™„è¿‘æš‚æ— å•æ‰€æ•°æ®')
        .fontSize(16)
        .fontColor(Colors.TEXT_SECONDARY)
      
      Text('è¯•è¯•æ‰©å¤§æœç´¢èŒƒå›´')
        .fontSize(14)
        .fontColor(Colors.TEXT_HINT)
        .margin({ top: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
  
  /**
   * åŠ è½½è§†å›¾
   */
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .color(Colors.PRIMARY)
        .width(50)
        .height(50)
      
      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor(Colors.TEXT_SECONDARY)
        .margin({ top: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
  
  /**
   * åŠ è½½å•æ‰€åˆ—è¡¨
   */
  private loadToiletList() {
    this.isLoading = true;
    
    // TODO: ä»æ•°æ®æºåŠ è½½
    setTimeout(() => {
      // æ¨¡æ‹Ÿæ•°æ®ï¼ˆä½¿ç”¨å®Œæ•´çš„ Toilet å¯¹è±¡ï¼‰
      this.toiletList = [];
      this.isLoading = false;
    }, 800);
  }
  
  /**
   * åˆ‡æ¢æ’åºæ–¹å¼
   */
  private toggleSort() {
    this.sortType = this.sortType === SortType.DISTANCE 
      ? SortType.RATING 
      : SortType.DISTANCE;
  }
  
  /**
   * è·å–æ’åºæ ‡ç­¾
   */
  private getSortLabel(): string {
    return this.sortType === SortType.DISTANCE ? 'è·ç¦»' : 'è¯„åˆ†';
  }
}

/**
 * æ’åºç±»å‹
 */
enum SortType {
  DISTANCE,
  RATING
}
