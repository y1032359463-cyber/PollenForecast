# Copilot Instructions

> 本文件定义 GitHub Copilot 在此项目中的行为规范

## 项目信息

- **项目名称**: 花粉浓度预报 (PollenForecast)
- **技术栈**: HarmonyOS + ArkTS + ArkUI (API 20)
- **开发工具**: DevEco Studio 6.0.x

### 🌐 服务器架构（双服务器）
> **⚠️ 禁止混淆部署目标！**

- **百度云服务器** (`106.12.143.105`)
  - 用途：**和风天气 API 数据**
  - 部署脚本：`server/quick-upload.ps1` + `server/deploy.sh`
  - WeatherService.ets 调用此服务器
  
- **阿里云新加坡** (`47.84.1.164:5000`)
  - 用途：**Google Pollen API 数据**
  - API Gateway URL: `http://47.84.1.164:5000/pollen-api`
  - Admin: `http://47.84.1.164:5000/admin`
  - Health: `http://47.84.1.164:5000/health`
  - PollenService.ets 调用此 API
  - 备注: 2025-12-15 从 AWS Lambda 迁移（AWS 新加坡节点不可用）

**❌ 严禁操作**：
- 禁止用百度云脚本部署 AWS Lambda 代码
- 禁止用 AWS 方式更新和风天气代码

---

## 🔴 AI 强制工作流程

### 开始工作前
1. **📊 文档健康度检测**（必须执行）：
   - 读取 `.claude/CLAUDE.md` 前，先检测文档行数和大小
   - 如果超过阈值（> 500行 或 > 40KB），**立即告知用户并询问是否整理**
   - 参考规则：`C:\HarmonyOS_App_Plans\.claude\文档健康度检测规则.md`
   - 检测命令：`(Get-Content "文件路径" | Measure-Object -Line).Lines`
2. **必须先读取** `.claude/CLAUDE.md` 确认项目状态
3. **确认理解**: 最近完成的功能、当前待办事项、已知问题
4. **不依赖对话历史** - 每次都要重新读取项目状态

### 遇到困难立即求助 CodeGenie
**原则**: 如果一个问题尝试 **3 次**仍无法解决，**立即停止尝试**，将问题整理到 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`

**必须求助的场景**:
- 编译错误修复超过 3 次仍未解决
- 同一个问题（同类错误、同一功能）反复修改 3 次仍未解决
- API 使用不确定（如 Map Kit、LocationKit 等）
- UI 交互功能失效且找不到原因
- ArkTS 严格模式语法限制不清楚
- 任何需要查阅官方文档的技术问题

**求助流程**:
1. 停止尝试修复
2. 打开 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`
3. **写入新问题前**：检查文件是否有未收录到知识库的有用内容
   - 如有已验证方案 → 先追加到 `知识库.md`
   - 如内容已过时/无用 → 直接清空
4. 清空文件并写入新问题（包含：问题描述、代码上下文、尝试过的方法、错误信息）
5. 告知用户："问题已整理到 `当前问题.md`，请粘贴给 CodeGenie"

### 技术方案试错上限与切换
**原则**: 同一方案失败 **3 次** → 必须换方案或求助

**流程**: 
1. 向用户说明："3 次失败，建议切换技术方案"
2. 提供替代方案（CustomDialog 替代 bindSheet / Flex 替代 Grid）
3. 等待用户决策 → 记录到 `.claude/CLAUDE.md`

### 代码修改原则
- ✅ **理解全局再修改** - 先读完整个 build() 函数或相关代码块
- ✅ **一次只改一个问题** - 避免连锁错误
- ✅ 批量操作使用 `multi_replace_string_in_file`
- ❌ **禁止重复修复已解决的问题** - 先确认问题是否真的存在
- ❌ 禁止凭假设修改 - 先用截图/日志确认实际状态

### 日志与错误分析原则
**原则**: 日志可能误导，优先验证实际表现

**核心规则**:
- ✅ 先确认问题真实存在 → 对比正常代码 → 优先用户反馈
- ❌ 禁止盲目修复日志错误（示例：正常功能也报 "radius is not correct type"）

### 🔴 重大代码变动前必须备份
**原则**: 对核心文件进行重构/大幅修改前,**必须先备份**

**需要备份的场景**:
- 重构列表/动画逻辑
- 修改核心业务流程 (如城市选择、数据加载)
- 优化性能涉及算法变更
- 任何可能导致功能失效的修改

**备份流程**:
1. 使用 PowerShell 命令备份:
   ```powershell
   $backupName = "文件名.backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
   Copy-Item "原文件路径" "备份路径/$backupName"
### 🔴 重大代码变动前必须备份
**场景**: 重构列表/动画逻辑、修改核心业务、性能优化

**备份流程**:
```powershell
$backupName = "文件名.backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
Copy-Item "原文件路径" "备份路径/$backupName"
```
记录到 `.claude/CLAUDE.md` 开发日志: `备份文件: 路径/文件名.backup_时间戳`

**恢复流程**: 从 CLAUDE.md 定位备份 → `Copy-Item "备份路径" "原路径" -Force` → 记录回退原因 → 提醒重新构建- 必须使用编辑工具修改现有文件

### ❌ 禁止抢跑知识库
**原则**: 等待用户明确反馈后才写入知识库

**✅ 触发词**: "构建成功" / "运行正常" / "没问题" / "登记吧"
**❌ 禁止**: AI 自认为没问题 / 编译通过但未测试 / 仅日志输出

**流程**: 修改代码 → 提醒测试 → 等待反馈 → 确认成功 → 追加知识库（标注日期/版本）

---

## 知识管理规则

### 文件结构
```
C:\HarmonyOS_App_Plans\
├── .claude/                    # 全局共享（跨项目）
│   ├── 当前问题.md             # 与 CodeGenie 实时沟通（可清空重写）
│   └── 知识库.md               # 已验证解决方案（只追加，不删除）
└── PollenForecast/
    └── .claude/
        └── CLAUDE.md           # 项目指导文档
```

### 核心规则

1. **方案验证成功后（必须等待用户确认），才追加到知识库**
   - ❌ **禁止将未验证的 AI 建议直接写入知识库**
   - 打开 `C:\HarmonyOS_App_Plans\.claude\知识库.md`（全局共享）
   - 在相应分类下追加验证通过的代码和说明
   - 标注验证日期和适用 API 版本

2. **知识库只追加，不删除**
   - 除非内容被证明是错误的，否则不删除
   - 更新时保留原内容，添加新版本说明

3. **当前问题.md 可清空重写**
   - 每次新问题时可以完全清空
   - 问题解决后清空，准备下一个问题

### 与 CodeGenie 协作流程

1. 遇到不确定问题 → 写入 `C:\HarmonyOS_App_Plans\.claude\当前问题.md`
2. 用户粘贴 CodeGenie 回复 → 分析并执行
3. 方案验证成功 → **立即追加到 `C:\HarmonyOS_App_Plans\.claude\知识库.md`**
4. 清空 `当前问题.md` 准备下一个问题

---

## 知识管理规则

### 文件结构
---

## 知识管理规则

### 文件结构
```
C:\HarmonyOS_App_Plans\
├── .claude/
│   ├── 当前问题.md    # 临时沟通（可清空）
│   └── 知识库.md      # 永久方案（只追加）
└── PollenForecast/
    └── .claude/CLAUDE.md  # 项目日志
```

### 核心规则
1. **当前问题.md**: 每次新问题完全清空 → 禁止创建其他临时文件
2. **知识库.md**: 方案验证成功后追加（标注日期/版本） → 除非错误否则不删除
3. **与 CodeGenie 协作**: 问题写入 → 粘贴回复 → 验证成功 → 追加知识库 → 清空临时文件|

---

## 构建与测试

> ⚠️ **必须人工操作** - AI 不能自动构建或运行应用

### 构建流程（用户在 DevEco Studio 中操作）
1. **安装依赖**: `ohpm install`
2. **构建 HAP**: Build → Build Hap(s)/APP(s) → Build Hap(s)
3. **运行到设备**: 点击运行按钮或 Shift+F10
4. **清理构建**: Build → Clean Project

### AI 职责
- ❌ 禁止尝试运行 `hvigorw` 等构建命令
- ✅ 修改代码后提醒用户手动构建测试
- ✅ 等待用户反馈构建结果或运行截图

codegenie回答：

