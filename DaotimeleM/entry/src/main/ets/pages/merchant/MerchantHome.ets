import router from '@ohos.router';

interface BusinessCard {
  id: string;
  type: string;
  icon: string;
  activeCount: number;
  countdown: string;
}

interface BusinessType {
  type: string;
  icon: string;
  name: string;
  checked: boolean;
}

@Entry
@Component
struct MerchantHome {
  @State businessList: BusinessCard[] = [];
  @State todayIncome: number = 0;
  
  // ä¸šåŠ¡ç±»å‹é…ç½®
  private businessTypes: BusinessType[] = [
    { type: 'pool', icon: 'ğŸ±', name: 'æ¡Œçƒ', checked: false },
    { type: 'stall', icon: 'ğŸª', name: 'åœ°æ‘Š', checked: false },
    { type: 'chess', icon: 'ğŸ´', name: 'æ£‹ç‰Œ', checked: false },
    { type: 'general', icon: 'ğŸ“¦', name: 'é€šç”¨', checked: false }
  ];

  aboutToAppear() {
    // TODO: ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²æ·»åŠ çš„ä¸šåŠ¡
    this.loadBusinessData();
  }

  loadBusinessData() {
    // æ¨¡æ‹Ÿæ•°æ®
    this.businessList = [
      { id: '1', type: 'pool', icon: 'ğŸ±', activeCount: 2, countdown: '58:35' },
      { id: '2', type: 'chess', icon: 'ğŸ´', activeCount: 0, countdown: '' }
    ];
    this.todayIncome = 358;
  }

  onBusinessTypeClick(type: string, icon: string, name: string) {
    // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
    const exists = this.businessList.find(b => b.type === type);
    if (exists) {
      // å·²å­˜åœ¨ï¼Œè·³è½¬åˆ°ä¸šåŠ¡ç®¡ç†é¡µ
      router.pushUrl({
        url: 'pages/merchant/BusinessManage',
        params: { businessType: type, businessName: name }
      });
    } else {
      // æ·»åŠ æ–°ä¸šåŠ¡
      if (this.businessList.length < 4) {
        this.businessList.push({
          id: Date.now().toString(),
          type: type,
          icon: icon,
          activeCount: 0,
          countdown: ''
        });
      }
    }
  }

  build() {
    Row() {
      // å·¦ä¾§å›ºå®šä¸šåŠ¡ç±»å‹æ 
      Column() {
        ForEach(this.businessTypes, (item: BusinessType) => {
          Column() {
            Text(item.icon)
              .fontSize(32)
              .margin({ bottom: 4 })
            Text(item.name)
              .fontSize(12)
              .fontColor('#666')
            
            // å·²æ·»åŠ æ ‡è®°
            if (this.businessList.some(b => b.type === item.type)) {
              Text('âœ“')
                .fontSize(16)
                .fontColor('#4CAF50')
                .margin({ top: 2 })
            }
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor(this.businessList.some(b => b.type === item.type) ? '#E8F5E9' : '#FFF')
          .border({ width: { bottom: 1 }, color: '#E0E0E0' })
          .onClick(() => {
            this.onBusinessTypeClick(item.type, item.icon, item.name);
          })
        })
      }
      .width(80)
      .height('100%')
      .backgroundColor('#FAFAFA')

      // å³ä¾§ä¸»å†…å®¹åŒº
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('æˆ‘çš„ä¸šåŠ¡')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
          
          Button({ type: ButtonType.Circle }) {
            Text('â†')
              .fontSize(20)
          }
          .width(40)
          .height(40)
          .backgroundColor('#E0E0E0')
          .onClick(() => {
            router.back();
          })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        .backgroundColor('#FFF')
        .border({ width: { bottom: 1 }, color: '#E0E0E0' })

        // ä»Šæ—¥æ”¶å…¥
        Row() {
          Text(`ä»Šæ—¥æ”¶å…¥: Â¥${this.todayIncome}`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#4CAF50')
        }
        .width('100%')
        .height(48)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#F9FFF9')
        .border({ width: { bottom: 1 }, color: '#E0E0E0' })

        // ä¸šåŠ¡å¡ç‰‡åŒºåŸŸ
        if (this.businessList.length === 0) {
          Column() {
            Text('è¿˜æ²¡æœ‰ä¸šåŠ¡')
              .fontSize(18)
              .fontColor('#999')
              .margin({ bottom: 8 })
            Text('ç‚¹å‡»æˆ–æ‹–æ‹½å·¦ä¾§å›¾æ ‡')
              .fontSize(14)
              .fontColor('#BBB')
            Text('æ·»åŠ ä¸šåŠ¡ï¼ˆæœ€å¤š4ä¸ªï¼‰')
              .fontSize(14)
              .fontColor('#BBB')
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          Grid() {
            ForEach(this.businessList, (item: BusinessCard) => {
              GridItem() {
                Column() {
                  Text(item.icon)
                    .fontSize(48)
                    .margin({ bottom: 8 })
                  
                  if (item.activeCount > 0) {
                    Text(`â± ${item.countdown}`)
                      .fontSize(18)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#FF6B9D')
                      .margin({ top: 8 })
                    Text(`ä½¿ç”¨ä¸­: ${item.activeCount}`)
                      .fontSize(12)
                      .fontColor('#666')
                      .margin({ top: 4 })
                  } else {
                    Text('æ— ä½¿ç”¨ä¸­')
                      .fontSize(14)
                      .fontColor('#999')
                      .margin({ top: 8 })
                  }
                }
                .width('100%')
                .height(160)
                .backgroundColor('#FFF')
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
                .shadow({ radius: 4, color: '#1000', offsetY: 2 })
                .onClick(() => {
                  const typeName = this.businessTypes.find(t => t.type === item.type)?.name || '';
                  router.pushUrl({
                    url: 'pages/merchant/BusinessManage',
                    params: { businessType: item.type, businessName: typeName }
                  });
                })
              }
            })
          }
          .columnsTemplate('1fr 1fr')
          .rowsGap(16)
          .columnsGap(16)
          .padding(16)
          .layoutWeight(1)
        }
      }
      .layoutWeight(1)
      .height('100%')
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }
}
