import router from '@ohos.router';

interface Resource {
  id: string;
  name: string;
  status: 'idle' | 'active';
  startTime?: number;
  countdown?: string;
  estimatedFee?: number;
}

@Entry
@Component
struct BusinessManage {
  @State businessType: string = '';
  @State businessName: string = '';
  @State resources: Resource[] = [];
  @State showTimePicker: boolean = false;
  @State selectedResourceId: string = '';

  aboutToAppear() {
    // è·å–ä¼ é€’çš„å‚æ•°
    const params = router.getParams() as Record<string, string>;
    this.businessType = params.businessType || '';
    this.businessName = params.businessName || '';
    
    // TODO: ä»æœ¬åœ°åŠ è½½èµ„æºåˆ—è¡¨
    this.loadResources();
  }

  loadResources() {
    // æ¨¡æ‹Ÿæ•°æ®
    this.resources = [
      { id: '1', name: '1å·å°', status: 'active', startTime: Date.now() - 3515000, countdown: '00:58:35', estimatedFee: 35.50 },
      { id: '2', name: '2å·å°', status: 'idle' },
      { id: '3', name: '3å·å°', status: 'active', startTime: Date.now() - 4520000, countdown: '01:15:20', estimatedFee: 45.00 },
      { id: '4', name: '4å·å°', status: 'idle' },
      { id: '5', name: '5å·å°', status: 'idle' }
    ];
  }

  onResourceClick(resource: Resource) {
    if (resource.status === 'idle') {
      // ç©ºé—²èµ„æºï¼Œå¼¹å‡ºæ—¶é—´é€‰æ‹©
      this.selectedResourceId = resource.id;
      this.showTimePicker = true;
    } else {
      // ä½¿ç”¨ä¸­çš„èµ„æºï¼Œè·³è½¬åˆ°æ”¶æ¬¾ç é¡µé¢
      router.pushUrl({
        url: 'pages/merchant/QRCodePage',
        params: { 
          resourceId: resource.id,
          resourceName: resource.name,
          businessType: this.businessType
        }
      });
    }
  }

  startCountdown(hours: number) {
    // TODO: å¯åŠ¨å€’è®¡æ—¶é€»è¾‘
    const resource = this.resources.find(r => r.id === this.selectedResourceId);
    if (resource) {
      resource.status = 'active';
      resource.startTime = Date.now();
      resource.countdown = `${hours.toString().padStart(2, '0')}:00:00`;
    }
    this.showTimePicker = false;
  }

  @Builder
  TimePickerDialog() {
    Column() {
      Text('é€‰æ‹©æ—¶é•¿')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 24 })

      // å¿«æ·æ—¶é—´æŒ‰é’®
      Row() {
        Button('1å°æ—¶')
          .width(80)
          .onClick(() => this.startCountdown(1))
        
        Button('2å°æ—¶')
          .width(80)
          .margin({ left: 12, right: 12 })
          .onClick(() => this.startCountdown(2))
        
        Button('3å°æ—¶')
          .width(80)
          .onClick(() => this.startCountdown(3))
      }
      .margin({ bottom: 16 })

      Button('è‡ªå®šä¹‰')
        .width(260)
        .backgroundColor('#E0E0E0')
        .fontColor('#333')
        .onClick(() => {
          // TODO: æ‰“å¼€è‡ªå®šä¹‰æ—¶é—´è¾“å…¥
        })

      Button('å–æ¶ˆ')
        .width(260)
        .backgroundColor('#FFF')
        .fontColor('#666')
        .margin({ top: 16 })
        .onClick(() => {
          this.showTimePicker = false;
        })
    }
    .width(300)
    .padding(24)
    .backgroundColor('#FFF')
    .borderRadius(12)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(20)
        }
        .width(40)
        .height(40)
        .backgroundColor('#E0E0E0')
        .onClick(() => {
          router.back();
        })

        Text(`${this.businessName}ç®¡ç†`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 12 })

        Blank()

        Button('[+æ–°å¢]')
          .fontSize(14)
          .backgroundColor('#4CAF50')
          .onClick(() => {
            // TODO: æ·»åŠ æ–°èµ„æº
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFF')
      .border({ width: { bottom: 1 }, color: '#E0E0E0' })

      Scroll() {
        Column() {
          // ä½¿ç”¨ä¸­çš„èµ„æº
          if (this.resources.filter(r => r.status === 'active').length > 0) {
            Column() {
              Text(`ä½¿ç”¨ä¸­ (${this.resources.filter(r => r.status === 'active').length})`)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 12 })

              ForEach(this.resources.filter(r => r.status === 'active'), (resource: Resource) => {
                Column() {
                  Row() {
                    Text(`ğŸ± ${resource.name}`)
                      .fontSize(18)
                      .fontWeight(FontWeight.Medium)
                    
                    Blank()
                    
                    Text(`â± ${resource.countdown}`)
                      .fontSize(16)
                      .fontColor('#FF6B9D')
                      .fontWeight(FontWeight.Bold)
                  }
                  .width('100%')
                  .margin({ bottom: 8 })

                  Row() {
                    Text(`å‚è€ƒ: Â¥${resource.estimatedFee?.toFixed(2)}`)
                      .fontSize(14)
                      .fontColor('#4CAF50')
                    
                    Blank()
                    
                    Button('æŸ¥çœ‹æ”¶æ¬¾ç ')
                      .fontSize(14)
                      .height(32)
                      .backgroundColor('#FF6B9D')
                  }
                  .width('100%')
                }
                .width('100%')
                .padding(16)
                .backgroundColor('#FFF')
                .borderRadius(8)
                .margin({ bottom: 12 })
                .shadow({ radius: 2, color: '#1000', offsetY: 1 })
                .onClick(() => {
                  this.onResourceClick(resource);
                })
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 16 })
          }

          // ç©ºé—²èµ„æº
          if (this.resources.filter(r => r.status === 'idle').length > 0) {
            Column() {
              Text(`ç©ºé—² (${this.resources.filter(r => r.status === 'idle').length})`)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 12 })

              Grid() {
                ForEach(this.resources.filter(r => r.status === 'idle'), (resource: Resource) => {
                  GridItem() {
                    Column() {
                      Text(resource.name)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)
                    }
                    .width('100%')
                    .height(80)
                    .backgroundColor('#E8F5E9')
                    .borderRadius(8)
                    .justifyContent(FlexAlign.Center)
                    .onClick(() => {
                      this.onResourceClick(resource);
                    })
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr')
              .rowsGap(12)
              .columnsGap(12)
              .width('100%')

              Text('(ç‚¹å‡»ç©ºé—²å°å¼€å§‹è®¡æ—¶)')
                .fontSize(12)
                .fontColor('#999')
                .margin({ top: 12 })
            }
            .width('100%')
            .padding(16)
          }
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')

      // æ—¶é—´é€‰æ‹©å¼¹çª—
      if (this.showTimePicker) {
        Column() {
          this.TimePickerDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showTimePicker = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}
