/**
 * åŒºåŸŸé¡µé¢ - Tab2
 * åŸå¸‚åˆ—è¡¨ï¼Œæ”¯æŒæœç´¢å’Œæ”¶è—
 * æ»‘åŠ¨æ“ä½œï¼šæ”¶è—/å–æ¶ˆæ”¶è—/ç½®é¡¶
 */

import { LocationService, LocationInfo } from '../service/LocationService'
import { vibrator } from '@kit.SensorServiceKit'
import { promptAction } from '@kit.ArkUI'

// åŸå¸‚åæ ‡æ¥å£
interface CityCoordinate {
  lat: number
  lng: number
}

// åŸå¸‚ç»çº¬åº¦æ˜ å°„è¡¨
const cityCoordinates: Record<string, CityCoordinate> = {
  'å½“å‰ä½ç½®': {lat: 39.9042, lng: 116.4074},  // é»˜è®¤åŒ—äº¬åæ ‡
  'åŒ—äº¬å¸‚': {lat: 39.9042, lng: 116.4074},
  'ä¸Šæµ·å¸‚': {lat: 31.2304, lng: 121.4737},
  'å¹¿å·å¸‚': {lat: 23.1291, lng: 113.2644},
  'æ·±åœ³å¸‚': {lat: 22.5431, lng: 114.0579},
  'æ­å·å¸‚': {lat: 30.2741, lng: 120.1551},
  'æˆéƒ½å¸‚': {lat: 30.5728, lng: 104.0668},
  'æ­¦æ±‰å¸‚': {lat: 30.5928, lng: 114.3055},
  'é‡åº†å¸‚': {lat: 29.4316, lng: 106.9123},
  'æµ·å—çœ, æµ·å£å¸‚': {lat: 20.0444, lng: 110.1989},
  'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº, å—å®å¸‚': {lat: 22.8170, lng: 108.3665},
  'è´µå·çœ, è´µé˜³å¸‚': {lat: 26.6470, lng: 106.6302},
  'è´µå·çœ, å…­ç›˜æ°´': {lat: 26.5918, lng: 104.8305},
  'äº‘å—çœ, æ˜†æ˜å¸‚': {lat: 25.0406, lng: 102.7129},
  'æ¹–å—çœ, é•¿æ²™å¸‚': {lat: 28.2278, lng: 112.9388},
  'æ±Ÿè¥¿çœ, å—æ˜Œå¸‚': {lat: 28.6829, lng: 115.8579},
  'ç¦å»ºçœ, ç¦å·å¸‚': {lat: 26.0745, lng: 119.2965},
  'æ¹–åŒ—çœ, æ­¦æ±‰å¸‚': {lat: 30.5928, lng: 114.3055},
  'å››å·çœ, å—å……å¸‚': {lat: 30.8376, lng: 106.1107},
  'å®‰å¾½çœ, åˆè‚¥å¸‚': {lat: 31.8206, lng: 117.2272},
  'æµ™æ±Ÿçœ, æ­å·å¸‚': {lat: 30.2741, lng: 120.1551},
  'é™•è¥¿çœ, è¥¿å®‰å¸‚': {lat: 34.3416, lng: 108.9398},
  'æ±Ÿè‹çœ, æ— é”¡å¸‚': {lat: 31.4912, lng: 120.3119},
  'æ²³å—çœ, éƒ‘å·å¸‚': {lat: 34.7472, lng: 113.6249}
}

@Component
export struct RegionView {
  @State searchText: string = ''
  @State currentCity: string = 'å½“å‰ä½ç½®'
  @State actualLocationCity: string = ''  // GPSå®šä½çš„çœŸå®åŸå¸‚å
  @State isAnimating: boolean = false
  @State firstLoad: boolean = true  // é¦–æ¬¡åŠ è½½æ ‡å¿—ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  @State swipeOffsets: Map<string, number> = new Map()  // æ‰‹åŠ¨æ»‘åŠ¨çŠ¶æ€ç®¡ç†
  @State isRefreshingLocation: boolean = false  // GPSå®šä½ä¸­
  private lastUpdateTime: number = 0  // èŠ‚æµï¼šä¸Šæ¬¡æ›´æ–°æ—¶é—´
  private pendingOffset: Map<string, number> = new Map()  // èŠ‚æµï¼šå¾…æ›´æ–°çš„åç§»å€¼
  private cachedLocation: LocationInfo | null = null  // ç¼“å­˜çš„GPSä½ç½®ï¼Œç”¨äºå¿«é€Ÿå“åº”
  @StorageLink('safeTop') safeTop: number = 44
  @StorageLink('safeBottom') safeBottom: number = 28
  @StorageLink('vibrationEnabled') vibrationEnabled: boolean = false  // éœ‡åŠ¨åé¦ˆå¼€å…³
  @StorageLink('pollenThemeColor') pollenThemeColor: string = '#4CAF50'  // èŠ±ç²‰ä¸»é¢˜è‰²
  
  private locationService: LocationService = LocationService.getInstance()
  
  // æ”¶è—çš„åŸå¸‚åˆ—è¡¨
  @State favoriteCities: string[] = []
  
  // çƒ­é—¨åŸå¸‚åˆ—è¡¨
  @State hotCities: string[] = ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'å¹¿å·å¸‚', 'æ·±åœ³å¸‚', 'æ­å·å¸‚', 'æˆéƒ½å¸‚', 'æ­¦æ±‰å¸‚', 'é‡åº†å¸‚']
  
  // åŸå¸‚åˆ—è¡¨æ•°æ®
  @State cityList: CityItem[] = [
    { name: 'åŒ—äº¬å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'ä¸Šæµ·å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'å¹¿å·å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'æ·±åœ³å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'æ­å·å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'æˆéƒ½å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'æ­¦æ±‰å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'é‡åº†å¸‚', distance: 0, isFavorite: false, isTop: false },
    { name: 'æµ·å—çœ, æµ·å£å¸‚', distance: 16, isFavorite: false, isTop: false },
    { name: 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº, å—å®å¸‚', distance: 363, isFavorite: false, isTop: false },
    { name: 'è´µå·çœ, è´µé˜³å¸‚', distance: 820, isFavorite: false, isTop: false },
    { name: 'è´µå·çœ, å…­ç›˜æ°´', distance: 911, isFavorite: false, isTop: false },
    { name: 'äº‘å—çœ, æ˜†æ˜å¸‚', distance: 926, isFavorite: false, isTop: false },
    { name: 'æ¹–å—çœ, é•¿æ²™å¸‚', distance: 953, isFavorite: false, isTop: false },
    { name: 'æ±Ÿè¥¿çœ, å—æ˜Œå¸‚', distance: 1121, isFavorite: false, isTop: false },
    { name: 'ç¦å»ºçœ, ç¦å·å¸‚', distance: 1151, isFavorite: false, isTop: false },
    { name: 'æ¹–åŒ—çœ, æ­¦æ±‰å¸‚', distance: 1244, isFavorite: false, isTop: false },
    { name: 'å››å·çœ, å—å……å¸‚', distance: 1267, isFavorite: false, isTop: false },
    { name: 'å®‰å¾½çœ, åˆè‚¥å¸‚', distance: 1487, isFavorite: false, isTop: false },
    { name: 'æµ™æ±Ÿçœ, æ­å·å¸‚', distance: 1519, isFavorite: false, isTop: false },
    { name: 'é™•è¥¿çœ, è¥¿å®‰å¸‚', distance: 1593, isFavorite: false, isTop: false },
    { name: 'æ±Ÿè‹çœ, æ— é”¡å¸‚', distance: 1627, isFavorite: false, isTop: false },
    { name: 'æ²³å—çœ, éƒ‘å·å¸‚', distance: 1669, isFavorite: false, isTop: false }
  ]

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ’­æ”¾åŠ¨ç”»(ä»…é¦–æ¬¡åŠ è½½ä¸”å‰10é¡¹)
  shouldAnimate(index: number): boolean {
    return this.firstLoad && index < 10
  }

  // Haversine è·ç¦»è®¡ç®—å‡½æ•°ï¼ˆè¿”å›å…¬é‡Œæ•°ï¼‰
  calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {
    const R = 6371 // åœ°çƒåŠå¾„(km)
    const dLat = this.deg2rad(lat2 - lat1)
    const dLng = this.deg2rad(lng2 - lng1)
    
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2)
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
    return Math.round(R * c) // å››èˆäº”å…¥åˆ°æ•´æ•°å…¬é‡Œ
  }

  // è§’åº¦è½¬å¼§åº¦
  deg2rad(deg: number): number {
    return deg * (Math.PI / 180)
  }

  // æ›´æ–°æ‰€æœ‰åŸå¸‚è·ç¦»ï¼ˆåŸºäº GPS å®é™…ä½ç½®ï¼‰
  updateAllDistances(): void {
    // å¦‚æœæ²¡æœ‰GPSä½ç½®ï¼Œä¸è®¡ç®—è·ç¦»
    if (!this.actualLocationCity) {
      console.warn(`[RegionView] GPSä½ç½®æœªè·å–ï¼Œæ— æ³•è®¡ç®—è·ç¦»`)
      return
    }

    const gpsCoords = cityCoordinates[this.actualLocationCity]
    if (!gpsCoords) {
      console.warn(`[RegionView] æ‰¾ä¸åˆ°GPSåŸå¸‚åæ ‡: ${this.actualLocationCity}`)
      return
    }

    // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘å“åº”å¼æ›´æ–°
    this.cityList = this.cityList.map(city => {
      const cityCoords = cityCoordinates[city.name]
      const distance = cityCoords 
        ? this.calculateDistance(
            gpsCoords.lat, gpsCoords.lng,
            cityCoords.lat, cityCoords.lng
          )
        : 0
      
      const newCity: CityItem = {
        name: city.name,
        distance: distance,
        isFavorite: city.isFavorite,
        isTop: city.isTop
      }
      return newCity
    })

    console.info(`[RegionView] å·²æ›´æ–°æ‰€æœ‰åŸå¸‚è·ç¦»ï¼ŒGPSä½ç½®: ${this.actualLocationCity}`)
  }

  // åˆ‡æ¢åŸå¸‚æ”¶è—çŠ¶æ€
  toggleFavorite(cityName: string): void {
    const index = this.cityList.findIndex(city => city.name === cityName)
    if (index >= 0) {
      // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘ UI åˆ·æ–°
      const newList = [...this.cityList]
      const updatedCity: CityItem = {
        name: newList[index].name,
        distance: newList[index].distance,
        isFavorite: !newList[index].isFavorite,
        isTop: newList[index].isFavorite ? false : newList[index].isTop // å–æ¶ˆæ”¶è—æ—¶åŒæ—¶å–æ¶ˆç½®é¡¶
      }
      newList[index] = updatedCity
      this.cityList = newList
    }
  }

  // ç½®é¡¶åŸå¸‚
  moveToTop(cityName: string): void {
    const index = this.cityList.findIndex(city => city.name === cityName)
    if (index >= 0) {
      // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘ UI åˆ·æ–°
      const newList = [...this.cityList]
      const updatedCity: CityItem = {
        name: newList[index].name,
        distance: newList[index].distance,
        isFavorite: true, // ç½®é¡¶çš„åŒæ—¶è‡ªåŠ¨æ”¶è—
        isTop: true
      }
      newList[index] = updatedCity
      this.cityList = newList
    }
  }

  // è·å–æ’åºåçš„åŸå¸‚åˆ—è¡¨ï¼ˆç½®é¡¶ > æ”¶è— > æ™®é€šï¼‰
  getSortedCities(): CityItem[] {
    return [...this.cityList].sort((a, b) => {
      // ç½®é¡¶ä¼˜å…ˆ
      if (a.isTop && !b.isTop) return -1
      if (!a.isTop && b.isTop) return 1
      // æ”¶è—æ¬¡ä¹‹
      if (a.isFavorite && !b.isFavorite) return -1
      if (!a.isFavorite && b.isFavorite) return 1
      // å…¶ä½™æŒ‰è·ç¦»æ’åº
      return a.distance - b.distance
    })
  }

  // é‡æ–°å®šä½åˆ°å½“å‰ä½ç½®ï¼ˆä¼˜åŒ–ï¼šç¼“å­˜å¿«é€Ÿå“åº” + åå°é™é»˜æ›´æ–°ï¼‰
  async refreshCurrentLocation(): Promise<void> {
    if (this.isRefreshingLocation) return
    
    console.info('[RegionView] å¿«é€Ÿåˆ·æ–°...')
    this.isRefreshingLocation = true
    
    try {
      // 1. å¿«é€Ÿå“åº”ï¼šä½¿ç”¨ç¼“å­˜ä½ç½®ç«‹å³æ›´æ–°è·ç¦»
      if (this.cachedLocation && this.cachedLocation.city) {
        console.info('[RegionView] ä½¿ç”¨ç¼“å­˜ä½ç½®å¿«é€Ÿå“åº”')
        this.updateAllDistances()  // åŸºäºç¼“å­˜è®¡ç®—è·ç¦»
      }
      
      // 2. ç«‹å³ç»“æŸåˆ·æ–°åŠ¨ç”»ï¼ˆç”¨æˆ·ä½“æ„Ÿå¿«ï¼‰
      this.isRefreshingLocation = false
      
      // 3. åå°é™é»˜æ›´æ–°GPSä½ç½®ï¼ˆä¸é˜»å¡ç”¨æˆ·æ“ä½œï¼‰
      this.silentRefreshGPS()
    } catch (error) {
      console.error(`[RegionView] åˆ·æ–°å¼‚å¸¸: ${JSON.stringify(error)}`)
      this.isRefreshingLocation = false
    }
  }

  // é™é»˜åˆ·æ–°GPSä½ç½®ï¼ˆåå°è¿è¡Œï¼Œä¸é˜»å¡ç•ŒUIï¼‰
  private silentRefreshGPS(): void {
    const timeoutId = setTimeout(() => {
      console.warn('[RegionView] åå°GPSå®šä½è¶…æ—¶')
    }, 5000)

    this.locationService.checkAndRequestPermission()
      .then((hasPermission: boolean) => {
        if (!hasPermission) {
          console.warn('[RegionView] æ— ä½ç½®æƒé™')
          clearTimeout(timeoutId)
          return Promise.reject('æ— æƒé™')
        }
        return this.locationService.getCurrentLocation()
      })
      .then((location: LocationInfo | null) => {
        clearTimeout(timeoutId)
        
        if (location !== null && location.city) {
          // æ›´æ–°ç¼“å­˜
          this.cachedLocation = location
          
          // ä¿å­˜GPSå®šä½çš„çœŸå®åŸå¸‚å
          this.actualLocationCity = location.city
          
          // æ›´æ–°GPSåŸå¸‚åæ ‡
          cityCoordinates[location.city] = {
            lat: location.latitude,
            lng: location.longitude
          }
          
          // é™é»˜æ›´æ–°è·ç¦»
          this.updateAllDistances()
          
          console.info(`[RegionView] åå°GPSåˆ·æ–°æˆåŠŸ: ${location.city}`)
        } else {
          console.warn('[RegionView] åå°GPSå®šä½å¤±è´¥')
        }
      })
      .catch((error: Error) => {
        clearTimeout(timeoutId)
        console.error(`[RegionView] åå°GPSå¼‚å¸¸: ${JSON.stringify(error)}`)
      })
  }

  // æ»‘åŠ¨æ“ä½œæŒ‰é’®æ„å»ºå™¨
  @Builder
  SwipeActionBuilder(city: CityItem) {
    Row() {
      // æ”¶è—/å–æ¶ˆæ”¶è—æŒ‰é’®
      Button(city.isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—')
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor(city.isFavorite ? '#666666' : '#FF6B35')
        .height('100%')
        .width(80)
        .onClick(() => {
          this.toggleFavorite(city.name)
        })

      // ç½®é¡¶æŒ‰é’®ï¼ˆä»…å¯¹å·²æ”¶è—çš„æ˜¾ç¤ºï¼‰
      if (city.isFavorite && !city.isTop) {
        Button('ç½®é¡¶')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#4CAF50')
          .height('100%')
          .width(60)
          .onClick(() => {
            this.moveToTop(city.name)
          })
      }
    }
    .height('100%')
  }

  // ç”Ÿå‘½å‘¨æœŸï¼šç»„ä»¶å³å°†å‡ºç°
  async aboutToAppear(): Promise<void> {
    // 1. ä» AppStorage è¯»å–å½“å‰åŸå¸‚
    const storedCity = AppStorage.get<string>('currentCity')
    if (storedCity) {
      this.currentCity = storedCity
      console.info(`[RegionView] ä½¿ç”¨å·²å­˜å‚¨åŸå¸‚: ${storedCity}`)
    }

    // 2. æ— è®ºæ˜¯å¦æœ‰å­˜å‚¨åŸå¸‚ï¼Œéƒ½å°è¯•è·å– GPS ä½ç½®ï¼ˆæ˜¾ç¤º"å½“å‰ä½ç½®"æŒ‰é’®ï¼‰
    try {
      const hasPermission = await this.locationService.checkAndRequestPermission()
      if (hasPermission) {
        const location: LocationInfo | null = await this.locationService.getCurrentLocation()
        if (location !== null && location.city) {
          // ä¿å­˜GPSå®šä½çš„çœŸå®åŸå¸‚å
          this.actualLocationCity = location.city
          // ç¼“å­˜GPSä½ç½®ï¼Œä¾›åç»­å¿«é€Ÿåˆ·æ–°ä½¿ç”¨
          this.cachedLocation = location
          // å°† GPS ä½ç½®æ·»åŠ åˆ°åæ ‡è¡¨
          cityCoordinates[location.city] = {
            lat: location.latitude,
            lng: location.longitude
          }
          console.info(`[RegionView] GPSå®šä½æˆåŠŸ: ${location.city} (${location.latitude}, ${location.longitude})`)
          
          // GPSå®šä½æˆåŠŸåï¼Œç«‹å³è®¡ç®—è·ç¦»
          this.updateAllDistances()
        }
      }
    } catch (error) {
      console.warn(`[RegionView] GPSå®šä½å¤±è´¥: ${JSON.stringify(error)}`)
    }

    // 4. å»¶è¿Ÿè§¦å‘åŠ¨ç”»ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
    setTimeout(() => {
      this.isAnimating = true
    }, 50)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å®‰å…¨è·ç¦»
      Blank().height(this.safeTop)

      // æ ‡é¢˜æ 
      Row() {
        Text('åŒºåŸŸ')
          .fontSize(28)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })

      // æœç´¢æ¡†
      Row() {
        Image($r('app.media.icon_search'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.text_secondary'))
          .margin({ right: 8 })
        
        TextInput({ placeholder: 'æœç´¢ä½ æ„Ÿå…´è¶£çš„åŸå¸‚', text: this.searchText })
          .placeholderColor($r('app.color.text_secondary'))
          .fontColor($r('app.color.text_primary'))
          .backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchText = value
          })
      }
      .width('100%')
      .height(44)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(10)
      .padding({ left: 12, right: 12 })
      .margin({ left: 16, right: 16, bottom: 20 })

      // å½“å‰ä½ç½®åŒºåŸŸï¼ˆä»…å½“GPSå®šä½æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰
      if (this.actualLocationCity) {
        Column() {
          Text('å½“å‰ä½ç½®')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, bottom: 8 })

          Row() {
            Image($r('app.media.icon_location'))
              .width(16)
              .height(16)
              .fillColor($r('app.color.icon_primary'))
            
            Text(this.actualLocationCity)
              .fontSize(16)
              .fontColor($r('app.color.text_primary'))
              .margin({ left: 8 })

            Blank()
          }
          .width('100%')
          .height(50)
          .backgroundColor($r('app.color.card_background'))
          .borderRadius(10)
          .padding({ left: 16, right: 16 })
          .margin({ left: 16, right: 16 })
          .onClick(() => {
            this.selectCity(this.actualLocationCity)
          })
        }
        .margin({ bottom: 20 })
      }

      // çƒ­é—¨åŸå¸‚
      Column() {
        Text('çƒ­é—¨åŸå¸‚')
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
          .width('100%')
          .padding({ left: 16, bottom: 8 })

        // çƒ­é—¨åŸå¸‚ç½‘æ ¼å¸ƒå±€ - ä½¿ç”¨ Flex å®ç°æ¢è¡Œ
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.hotCities, (city: string, index: number) => {
            Text(city)
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .backgroundColor($r('app.color.card_background'))
              .borderRadius(16)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .margin({ right: 12, bottom: 12 })
              .onClick(() => {
                this.selectCity(city)
              })
              // å…¥åœºåŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
              .opacity(this.isAnimating ? 1 : 0)
              .translate({ y: this.isAnimating ? 0 : 30 })
              .animation({
                duration: 280,
                delay: this.firstLoad ? (index * 30) : 0,
                curve: Curve.EaseOut
              })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }
      .margin({ bottom: 20 })

      // å…¨éƒ¨åœ°åŒºï¼ˆä¸‹æ‹‰åˆ·æ–°ï¼‰
      Refresh({ refreshing: $$this.isRefreshingLocation }) {
        Column() {
          // å…¨éƒ¨åœ°åŒºæ ‡é¢˜
          Text('å…¨éƒ¨åœ°åŒº')
            .fontSize(13)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, bottom: 8 })

          // åŸå¸‚åˆ—è¡¨
          List() {
        ForEach(this.getFilteredCities(), (city: CityItem, index: number) => {
          ListItem() {
            // P0ä¼˜åŒ–: æ‰‹åŠ¨å®ç°æ»‘åŠ¨ï¼Œæ›¿ä»£ swipeAction
            Stack({ alignContent: Alignment.End }) {
              // èƒŒæ™¯å±‚ï¼šæ“ä½œæŒ‰é’®
              Row() {
                Button({ type: ButtonType.Normal }) {
                  Text(city.isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—')
                    .fontSize(14)
                    .fontColor(Color.White)
                }
                .width(80)
                .height('100%')
                .backgroundColor(city.isFavorite ? '#757575' : '#FF6B35')
                .onClick(() => {
                  this.toggleFavorite(city.name)
                  // æ“ä½œåå›å¼¹
                  animateTo({ duration: 200 }, () => {
                    this.swipeOffsets.set(city.name, 0)
                  })
                })

                if (city.isFavorite && !city.isTop) {
                  Button({ type: ButtonType.Normal }) {
                    Text('ç½®é¡¶').fontSize(14).fontColor(Color.White)
                  }
                  .width(60)
                  .height('100%')
                  .backgroundColor('#4CAF50')
                  .onClick(() => {
                    this.moveToTop(city.name)
                    animateTo({ duration: 200 }, () => {
                      this.swipeOffsets.set(city.name, 0)
                    })
                  })
                }
              }
              .height('100%')

              // ä¸»å†…å®¹å±‚
              Row() {
                // çŠ¶æ€å›¾æ ‡ï¼šç½®é¡¶ > æ”¶è— > æ™®é€š
                if (city.isTop) {
                  Image($r('app.media.icon_pin'))
                    .width(14)
                    .height(14)
                    .fillColor(this.pollenThemeColor)
                } else if (city.isFavorite) {
                  Image($r('app.media.icon_star'))
                    .width(14)
                    .height(14)
                    .fillColor('#FFD700')
                } else {
                  Image($r('app.media.icon_chevron_right'))
                    .width(12)
                    .height(12)
                    .fillColor(this.pollenThemeColor)
                }

                // åŸå¸‚åç§°
                Text(city.name)
                  .fontSize(15)
                  .fontColor(city.isTop ? '#FFD700' : (city.isFavorite ? '#FF6B35' : $r('app.color.text_primary')))
                  .margin({ left: 12 })

                Blank()

                // è·ç¦»
                Text(`${city.distance}å…¬é‡Œ`)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .height(50)
              .padding({ left: 16, right: 16 })
              .backgroundColor($r('app.color.page_background'))
              .translate({ x: this.swipeOffsets.get(city.name) ?? 0 })
              .gesture(
                PanGesture({ direction: PanDirection.Left | PanDirection.Right })
                  .onActionUpdate((event: GestureEvent) => {
                    const currentOffset = this.swipeOffsets.get(city.name) ?? 0
                    const maxSwipe = city.isFavorite && !city.isTop ? -140 : -80
                    const newOffset = Math.max(maxSwipe, Math.min(0, currentOffset + event.offsetX))
                    
                    // èŠ‚æµä¼˜åŒ–ï¼šé™åˆ¶æ›´æ–°é¢‘ç‡ä¸º 60fps (çº¦ 16ms)
                    const now = Date.now()
                    this.pendingOffset.set(city.name, newOffset)
                    
                    if (now - this.lastUpdateTime >= 16) {
                      this.lastUpdateTime = now
                      this.swipeOffsets.set(city.name, newOffset)
                    }
                  })
                  .onActionEnd((event: GestureEvent) => {
                    // ä½¿ç”¨å¾…æ›´æ–°çš„æœ€ç»ˆå€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const finalOffset = this.pendingOffset.get(city.name) ?? this.swipeOffsets.get(city.name) ?? 0
                    if (this.pendingOffset.has(city.name)) {
                      this.swipeOffsets.set(city.name, finalOffset)
                      this.pendingOffset.delete(city.name)
                    }
                    
                    const velocity = event.velocityX
                    const currentOffset = finalOffset
                    const threshold = city.isFavorite && !city.isTop ? -70 : -40
                    
                    // åˆ¤æ–­æ˜¯å¦å±•å¼€
                    if (velocity < -800 || currentOffset < threshold) {
                      animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                        this.swipeOffsets.set(city.name, city.isFavorite && !city.isTop ? -140 : -80)
                      })
                    } else {
                      animateTo({ duration: 200, curve: Curve.Sharp }, () => {
                        this.swipeOffsets.set(city.name, 0)
                      })
                    }
                  })
              )
              .onClick(() => {
                // å¦‚æœå·²å±•å¼€ï¼Œå…ˆæ”¶èµ·
                const currentOffset = this.swipeOffsets.get(city.name) ?? 0
                if (currentOffset < -10) {
                  animateTo({ duration: 200 }, () => {
                    this.swipeOffsets.set(city.name, 0)
                  })
                } else {
                  this.selectCity(city.name)
                }
              })
            }
            .width('100%')
            .height(50)
            // P1ä¼˜åŒ–: ä½¿ç”¨ scale æ›¿ä»£ opacity+translate å¤åˆåŠ¨ç”»
            .scale({ 
              x: this.shouldAnimate(index) ? (this.isAnimating ? 1 : 0.95) : 1,
              y: this.shouldAnimate(index) ? (this.isAnimating ? 1 : 0.95) : 1
            })
            .animation({
              duration: 240,  // ç¼©çŸ­æ—¶é•¿
              delay: this.firstLoad ? Math.min(index * 20, 100) : 0,  // å‡å°‘å»¶è¿Ÿ
              curve: Curve.EaseOut,
              iterations: 1,
              playMode: PlayMode.Normal
            })
          }
        }, (city: CityItem) => `${city.name}_${city.isFavorite}_${city.isTop}`)  // åŒ…å«çŠ¶æ€çš„å”¯ä¸€æ ‡è¯†
      }
      .width('100%')
      .layoutWeight(1)
      .cachedCount(15)  // æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜åˆ—è¡¨é¡¹
      .onScrollIndex((start: number, end: number) => {
        // æ»šåŠ¨æ—¶ç¦ç”¨åŠ¨ç”»ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
        if (this.firstLoad) {
          this.firstLoad = false
        }
      })
      .divider({
        strokeWidth: 0.5,
        color: $r('app.color.divider_color'),
        startMargin: 40,
        endMargin: 16
      })
        }
        .width('100%')
      }
      .onRefreshing(() => {
        this.refreshCurrentLocation()
      })
      .layoutWeight(1)
      .clip(true)  // è£å‰ªå†…å®¹ï¼Œé˜²æ­¢ç©¿é€åˆ°çŠ¶æ€æ 

      // ========== å¹¿å‘Šä½é¢„ç•™ï¼ˆå·²éšè—ï¼‰==========
      // TODO: åç»­å¯åœ¨æ­¤ä½ç½®æ·»åŠ å¹¿å‘Šç»„ä»¶
      // å»ºè®®ç±»å‹: Bannerå¹¿å‘Šã€æ¨å¹¿å¡ç‰‡ã€å¥åº·å°è´´å£«
      // å‚è€ƒé«˜åº¦: 60-80px
      // Blank().height(56)  // TabBar å ä½
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      if (isVisible && currentRatio >= 1.0) {
        // é¡µé¢å®Œå…¨å¯è§æ—¶è§¦å‘åŠ¨ç”»
        setTimeout(() => {
          animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
            this.isAnimating = true
          })
        }, 50)
      } else if (!isVisible || currentRatio < 0.5) {
        // é¡µé¢ä¸å¯è§æˆ–å¯è§æ¯”ä¾äº50%æ—¶é‡ç½®
        this.isAnimating = false
        // å¼ºåˆ¶åœæ­¢GPSåˆ·æ–°åŠ¨ç”»ï¼ˆé¿å…åå°èµ„æºå ç”¨ï¼‰
        if (this.isRefreshingLocation) {
          this.isRefreshingLocation = false
        }
      }
    })
  }

  // é€‰æ‹©åŸå¸‚å¤„ç†å‡½æ•°
  selectCity(cityName: string): void {
    console.info(`[RegionView] é€‰æ‹©åŸå¸‚: ${cityName}`)
    
    // 1. éœ‡åŠ¨åé¦ˆï¼ˆ30ms çŸ­éœ‡ï¼‰
    if (this.vibrationEnabled) {
      try {
        vibrator.startVibration({
          type: 'time',
          duration: 30
        }, {
          id: 0,
          usage: 'touch'
        })
      } catch (err) {
        console.warn('[RegionView] éœ‡åŠ¨åé¦ˆå¤±è´¥')
      }
    }
    
    // 2. Toast æç¤º
    this.getUIContext().getPromptAction().showToast({
      message: `å·²åˆ‡æ¢åˆ° ${cityName}`,
      duration: 1500
    })
    
    // 3. æ›´æ–°å…¨å±€å­˜å‚¨çš„åŸå¸‚ä¿¡æ¯
    AppStorage.setOrCreate('currentCity', cityName)
    this.currentCity = cityName
    
    // è·å–åŸå¸‚åæ ‡ï¼ˆä½¿ç”¨å…¨å±€å¸¸é‡ï¼‰
    const coords = cityCoordinates[cityName]
    if (coords) {
      AppStorage.setOrCreate('latitude', coords.lat)
      AppStorage.setOrCreate('longitude', coords.lng)
      console.info(`[RegionView] åŸå¸‚åæ ‡: ${coords.lat}, ${coords.lng}`)
    } else {
      console.warn(`[RegionView] æœªæ‰¾åˆ°åŸå¸‚ ${cityName} çš„åæ ‡ï¼Œä½¿ç”¨é»˜è®¤å€¼`)
      AppStorage.setOrCreate('latitude', 23.1291)
      AppStorage.setOrCreate('longitude', 113.2644)
    }

    // 4. è·³è½¬åˆ°é¦–é¡µï¼ˆTab 0ï¼‰å¹¶åˆ·æ–°æ•°æ®
    AppStorage.setOrCreate('selectedTabIndex', 0)
    console.info(`[RegionView] å·²åˆ‡æ¢åˆ°åŸå¸‚: ${cityName}ï¼Œè·³è½¬é¦–é¡µ`)
  }

  // è¿‡æ»¤åŸå¸‚åˆ—è¡¨
  getFilteredCities(): CityItem[] {
    // å…ˆè·å–è¦å¤„ç†çš„åˆ—è¡¨
    let targetList = this.cityList
    
    // å¦‚æœæœ‰æœç´¢æ–‡æœ¬,å…ˆè¿‡æ»¤
    if (this.searchText) {
      const searchLower = this.searchText.toLowerCase()
      targetList = this.cityList.filter(city => 
        city.name.toLowerCase().includes(searchLower)
      )
    }
    
    // æ’åºï¼šç½®é¡¶ > æ”¶è— > æ™®é€šï¼ˆæŒ‰è·ç¦»ï¼‰
    // ğŸ”´ ä¿®å¤ï¼šä½¿ç”¨ slice() åˆ›å»ºå‰¯æœ¬å†æ’åºï¼Œé¿å…ä¿®æ”¹åŸæ•°ç»„
    return [...targetList].sort((a, b) => {
      if (a.isTop && !b.isTop) return -1
      if (!a.isTop && b.isTop) return 1
      if (a.isFavorite && !b.isFavorite) return -1
      if (!a.isFavorite && b.isFavorite) return 1
      return a.distance - b.distance
    })
  }
}

// åŸå¸‚æ•°æ®æ¥å£
interface CityItem {
  name: string
  distance: number
  isFavorite: boolean
  isTop: boolean
}
